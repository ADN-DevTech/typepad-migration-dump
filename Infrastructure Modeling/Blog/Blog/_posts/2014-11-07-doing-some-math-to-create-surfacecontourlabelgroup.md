---
layout: "post"
title: "Doing some math to create SurfaceContourLabelGroup"
date: "2014-11-07 12:18:19"
author: "Augusto Goncalves"
categories:
  - ".NET"
  - "Augusto Goncalves"
  - "AutoCAD Civil 3D 2015"
original_url: "https://adndevblog.typepad.com/infrastructure/2014/11/doing-some-math-to-create-surfacecontourlabelgroup.html "
typepad_basename: "doing-some-math-to-create-surfacecontourlabelgroup"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/infrastructure/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>Iâ€™m always amazed how AutoCAD Geometry namespace can be used to perform some vector based math very easy. On this post, the goal is get all contours lines from a Tin Surface and create label group object on each of them. </p>  <p>The main point is the <strong>SurfaceContourLabelGroup.Create</strong> method requires a list of points. Why? Because you can pass a sequence of points where Civil 3D will draw a line (or polyline) and every time it crosses (intersect) a contour, will add a label.</p>  <p>Just like in the UI, we can add this SurfaceContourLabelGroup object for each contour line but, just like in the UI, we need a small line that cross the contour line. Here is where the math enters: get a point at the middle of a contour line, get the first derivative vector (that points on the direction of the contour line), rotate by +90 and by -90 degrees, finally convert to a unit vector (to make it small enough) and add on both direction to the original point on the contour line. And with that we have the 2 points we need. </p>  <pre style="font-size: 12px; font-family: consolas; background: white; color: black">[<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;testAddLabelContour&quot;</span>)]<br /><span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> CmdAddLabelAtContour()<br />{<br />&#160; <span style="color: #2b91af">Editor</span> ed = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument.Editor;<br /> <br />&#160; <span style="color: green">// select a tin surface</span><br />&#160; <span style="color: #2b91af">PromptEntityOptions</span> peo = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">PromptEntityOptions</span>(<br />&#160;&#160;&#160; <span style="color: #a31515">&quot;\nSelect a tin surface: &quot;</span>);<br />&#160; peo.SetRejectMessage(<span style="color: #a31515">&quot;\nOnly surface&quot;</span>);<br />&#160; peo.AddAllowedClass(<span style="color: blue">typeof</span>(<span style="color: #2b91af">TinSurface</span>), <span style="color: blue">true</span>);<br />&#160; <span style="color: #2b91af">PromptEntityResult</span> per = ed.GetEntity(peo);<br />&#160; <span style="color: blue">if</span> (per.Status != <span style="color: #2b91af">PromptStatus</span>.OK) <span style="color: blue">return</span>;<br /> <br />&#160; AddLabelAtContours(per.ObjectId);<br />}<br /> <br /><span style="color: blue">private</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> AddLabelAtContours(ObjectId surfaceId)<br />{<br />&#160; <span style="color: #2b91af">Database</span> db = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument.Database;<br />&#160; <span style="color: #2b91af">CivilDocument</span> civilDoc = <span style="color: #2b91af">CivilApplication</span>.ActiveDocument;<br />&#160; <span style="color: blue">using</span> (<span style="color: #2b91af">Transaction</span> trans = db.TransactionManager.StartTransaction())<br />&#160; {<br />&#160;&#160;&#160; <span style="color: #2b91af">TinSurface</span> surface = trans.GetObject(surfaceId,<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">OpenMode</span>.ForRead) <span style="color: blue">as</span>&#160;<span style="color: #2b91af">TinSurface</span>;<br /> <br />&#160;&#160;&#160; <span style="color: green">// finally call our custom method to add labels</span><br />&#160;&#160;&#160; <span style="color: green">// on each polyline extracted from the surface</span><br />&#160;&#160;&#160; AddContoursLabels(surfaceId,<br />&#160;&#160;&#160;&#160;&#160; surface.ExtractMajorContours(<span style="color: #2b91af">SurfaceExtractionSettingsType</span>.Plan));<br />&#160;&#160;&#160; AddContoursLabels(surfaceId,<br />&#160;&#160;&#160;&#160;&#160; surface.ExtractMinorContours(<span style="color: #2b91af">SurfaceExtractionSettingsType</span>.Plan));<br /> <br />&#160;&#160;&#160; trans.Commit();<br />&#160; }<br />}<br /> <br /><span style="color: blue">private</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> AddContoursLabels(ObjectId surfaceId,<br />&#160; <span style="color: #2b91af">ObjectIdCollection</span> contourIds)<br />{<br />&#160; <span style="color: blue">for</span> (<span style="color: blue">int</span> i = 0; i &lt; contourIds.Count; i++)<br />&#160; {<br />&#160;&#160;&#160; ObjectId contourId = contourIds[i];<br />&#160;&#160;&#160; <span style="color: green">// Contours are lightweight Polyline objects:</span><br />&#160;&#160;&#160; <span style="color: #2b91af">Polyline</span> contour = contourId.GetObject(<span style="color: #2b91af">OpenMode</span>.ForWrite) <span style="color: blue">as</span>&#160;<span style="color: #2b91af">Polyline</span>;<br />&#160;&#160;&#160; <span style="color: green">// get a point at the middle of the pline</span><br />&#160;&#160;&#160; Point3d pointOnContour = contour.GetPointAtParameter(0.5);<br />&#160;&#160;&#160; <span style="color: green">// get the first derivative on this point</span><br />&#160;&#160;&#160; Vector3d firstDerivative = contour.GetFirstDerivative(pointOnContour);<br />&#160;&#160;&#160; <span style="color: green">// now do some math to get one point on each side, not far</span><br />&#160;&#160;&#160; <span style="color: green">// than 0.5 units...</span><br />&#160;&#160;&#160; Point3d leftPoint = pointOnContour<br />&#160;&#160;&#160;&#160;&#160; .Add(firstDerivative.RotateBy(<span style="color: #2b91af">Math</span>.PI / 2, Vector3d.ZAxis) <span style="color: green">// rotate 90o</span><br />&#160;&#160;&#160;&#160;&#160; .DivideBy(firstDerivative.Length) <span style="color: green">// make unit vector</span><br />&#160;&#160;&#160;&#160;&#160; .MultiplyBy(0.5)); <span style="color: green">// size 0.5</span><br />&#160;&#160;&#160; Point3d rightPoint = pointOnContour<br />&#160;&#160;&#160;&#160;&#160; .Add(firstDerivative.RotateBy(-<span style="color: #2b91af">Math</span>.PI / 2, Vector3d.ZAxis) <span style="color: green">// rotate -90o</span><br />&#160;&#160;&#160;&#160;&#160; .DivideBy(firstDerivative.Length) <span style="color: green">// make unit vector</span><br />&#160;&#160;&#160;&#160;&#160; .MultiplyBy(0.5)); <span style="color: green">// size 0.5</span><br /> <br />&#160;&#160;&#160; <span style="color: green">// create a list of points</span><br />&#160;&#160;&#160; <span style="color: #2b91af">Point2dCollection</span> points = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">Point2dCollection</span>();<br />&#160;&#160;&#160; points.Add(leftPoint.Convert2d(<span style="color: blue">new</span>&#160;<span style="color: #2b91af">Plane</span>()));<br />&#160;&#160;&#160; points.Add(rightPoint.Convert2d(<span style="color: blue">new</span>&#160;<span style="color: #2b91af">Plane</span>()));<br /> <br />&#160;&#160;&#160; <span style="color: green">// and create the label group</span><br />&#160;&#160;&#160; <span style="color: #2b91af">SurfaceContourLabelGroup</span>.Create(surfaceId, points);<br /> <br />&#160;&#160;&#160; <span style="color: green">// and erase the pline (don't need anymore...)</span><br />&#160;&#160;&#160; contour.Erase();<br />&#160; }<br />}</pre>

<p>As a result, a label is added at the middle (parameter 0.5) of each contour line (major and minor).</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c7027520970b-pi"><img title="contours_labels" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="contours_labels" src="/assets/image_ddbd93.jpg" width="379" height="354" /></a></p>
