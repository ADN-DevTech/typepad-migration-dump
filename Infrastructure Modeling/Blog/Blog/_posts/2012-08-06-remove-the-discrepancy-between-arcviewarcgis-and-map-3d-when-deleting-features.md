---
layout: "post"
title: "Remove the Discrepancy Between ArcView/ArcGIS and Map 3D When Deleting Features"
date: "2012-08-06 01:37:28"
author: "Daniel Du"
categories:
  - "AutoCAD Map 3D 2011"
  - "AutoCAD Map 3D 2012"
  - "AutoCAD Map 3D 2013"
  - "Daniel Du"
original_url: "https://adndevblog.typepad.com/infrastructure/2012/08/remove-the-discrepancy-between-arcviewarcgis-and-map-3d-when-deleting-features.html "
typepad_basename: "remove-the-discrepancy-between-arcviewarcgis-and-map-3d-when-deleting-features"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/infrastructure/daniel-du.html">Daniel Du</a></p>  <p>In last post, I introduced how to d<a href="http://adndevblog.typepad.com/infrastructure/2012/08/deleting-selected-features-in-map-3d-using-apis.html">elete selected features in Map 3D using APIs</a>, some users argue that there is a discrepancy for SHP files when examining the file in ArcGIS, the deleted features in Map 3D still appear in ArcGIS when FDO connection in Map 3D is still open. </p>  <p>To better understand this problem, let’s examine the modification date of files firstly. Following screen-shot is the shp files before deleting in Map 3D:</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017743f24d9f970d-pi"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_6198e3.jpg" width="490" height="194" /></a></p>  <p>And following is another screen-shot when the features are deleted in Map 3D using the custom command we introduced in <a href="http://adndevblog.typepad.com/infrastructure/2012/08/deleting-selected-features-in-map-3d-using-apis.html" target="_blank">last post</a>.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017743f24dd2970d-pi"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_7d25dc.jpg" width="495" height="211" /></a></p>  <p>You may notice that only the *.dbf file is modified, while *.shp does not. </p>  <p>Is this a bug of Map 3D? First, here are some background regarding SHP files and the FDO SHP provider:</p>  <p>· A&#160; DBF record holds the attributes + a Delete flag. When a geometry is deleted <b>this flag is set.</b> The geometry is still in the SHP file but marked for deletion in DBF. If you are interested in the DBF specification, please refer to this <a href="http://www.dbf2002.com/dbf-file-format.html" target="_blank">doc</a>.</p>  <p>· The weird aspect of this flag is that while it is part of the ESRI SHP specification <b>it is ignored</b> by applications like ArcGIS or TatukGis Viewer. </p>  <p>In the past development team made a significant deal of effort to address this issue. They ended up by <b>compressing</b> (i.e. effectively deleting the records) the SHP files (.dbx, .shx, .shp) when the last connection is closed. This is because, obviously, it is non-performant to compress the files for every single deleted feature (these files can be extremely large). o it is as designed, shp file is only compressed when the connection is closed. </p>  <p>But for some reason, customer may want to sync the changes between Map 3D and ArcGIS more frequently, is there any a way to compress the shp explicitly? Unfortunately, there is no such APIs in Map 3D, but since it will be compressed when the connection is closed, how about to close the connection programmatically? Yes, that is the solution. </p>  <p>If you examine the <strong>BuidMap</strong> sample in <a href="http://usa.autodesk.com/adsk/servlet/index?siteID=123112&amp;id=868220" target="_blank">Map 3D ObjectARX SDK</a>, you will understand that the process of creating a connection to FDO datasource and adding layer to map is actually a process of create feature source and layer definition using resource service. So we of cause can disconnect by deleting these resources.</p>  <p>Here is the code snippet: </p>  <div style="font-family: ; background: white; color: ">   <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">[</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#2b91af">CommandMethod</font></span><span style="line-height: 11pt"><font color="#000000">(</font></span><span style="line-height: 11pt; color: "><font color="#a31515">&quot;CloseConnection&quot;</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">)]</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#0000ff"><font style="font-size: 8pt">public</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt"><font color="#000000"> </font></span><span style="line-height: 11pt; color: "><font color="#0000ff">void</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> CloseConnectionForLayer()</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">RemoveLayer(</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#a31515">&quot;Layer1&quot;</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">);</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#0000ff"><font style="font-size: 8pt">public</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt"><font color="#000000"> </font></span><span style="line-height: 11pt; color: "><font color="#0000ff">void</font></span><span style="line-height: 11pt"><font color="#000000"> RemoveLayer(</font></span><span style="line-height: 11pt; color: "><font color="#0000ff">string</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> layerName)</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#2b91af"><font style="font-size: 8pt">Document</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt"><font color="#000000"> doc = </font></span><span style="line-height: 11pt; color: "><font color="#2b91af">Application</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">.DocumentManager.MdiActiveDocument;</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#2b91af"><font style="font-size: 8pt">Editor</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> ed = doc.Editor;</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#2b91af"><font style="font-size: 8pt">Database</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> db = doc.Database;</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#2b91af"><font style="font-size: 8pt">AcMapMap</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt"><font color="#000000"> map = </font></span><span style="line-height: 11pt; color: "><font color="#2b91af">AcMapMap</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">.GetCurrentMap();</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span style="line-height: 11pt; color: "><font face="Courier New"><font style="font-size: 8pt" color="#008000">// remove the layer</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#0000ff"><font style="font-size: 8pt">var</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> layers = map.GetLayers();</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#0000ff"><font style="font-size: 8pt">if</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> (!layers.Contains(layerName))</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160; ed.WriteMessage(</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#a31515">&quot;\nLayer does not exist: &quot;</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> + layerName);</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#0000ff">return</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">;</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#2b91af"><font style="font-size: 8pt">MgLayerBase</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> layer = layers.GetItem(layerName);</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">layers.Remove(layer);</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span style="line-height: 11pt; color: "><font face="Courier New"><font style="font-size: 8pt" color="#008000">// remove the layer resource</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#2b91af"><font style="font-size: 8pt">MgResourceIdentifier</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> identifier = layer.LayerDefinition;</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#2b91af"><font style="font-size: 8pt">MgResourceService</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> resourceService</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160; = </font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#2b91af">AcMapServiceFactory</font></span><span style="line-height: 11pt"><font color="#000000">.GetService(</font></span><span style="line-height: 11pt; color: "><font color="#2b91af">MgServiceType</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">.ResourceService)</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#0000ff">as</font></span><span style="line-height: 11pt"><font color="#000000"> </font></span><span style="line-height: 11pt; color: "><font color="#2b91af">MgResourceService</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">;</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#0000ff"><font style="font-size: 8pt">if</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> (resourceService.ResourceExists(identifier))</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; resourceService.DeleteResource(identifier);</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span style="line-height: 11pt; color: "><font face="Courier New"><font style="font-size: 8pt" color="#008000">// remove the feature source</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">identifier = </font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#0000ff">new</font></span><span style="line-height: 11pt"><font color="#000000"> </font></span><span style="line-height: 11pt; color: "><font color="#2b91af">MgResourceIdentifier</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">(layer.FeatureSourceId);</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt; color: "><font color="#0000ff"><font style="font-size: 8pt">if</font></font></span><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> (resourceService.ResourceExists(identifier))</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; resourceService.DeleteResource(identifier);</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></span></p> </div>  <p>&#160;</p>  <p>By this way, the SHP layer is removed from map and FDO connection is closed, let’s examine the modification data again, the SHP files (.dbx, .shx, .shp) are modified. The result will be synced with ArcGIS now. </p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017743f24e09970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_c45cf9.jpg" width="466" height="206" /></a></p>  <p>If you need to keep working the SHP file in Map 3D, you need to re-create the connection using the way introduced in BuildMap Sample. As you can imagine, this workaround may cause performance issue if you do that very frequently, so please apply it only when necessary. </p>  <p>Hope this helps.</p>
