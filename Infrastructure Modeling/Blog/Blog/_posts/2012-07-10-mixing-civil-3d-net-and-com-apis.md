---
layout: "post"
title: "Mixing Civil 3D .NET and COM APIs"
date: "2012-07-10 12:42:45"
author: "Augusto Goncalves"
categories:
  - "Augusto Goncalves"
  - "AutoCAD Civil 3D 2011"
original_url: "https://adndevblog.typepad.com/infrastructure/2012/07/mixing-civil-3d-net-and-com-apis.html "
typepad_basename: "mixing-civil-3d-net-and-com-apis"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/infrastructure/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>On each new version, Civil 3D includes more and more .NET coverage, but a few features still missing or maybe not available on older versions. This article how go from COM to .NET and back.</p>  <p>Every time any Aecc-object is used, the code will require COM objects to be loaded. A common practice is to add reference to those objects (either from COM registered objects prior 2012 or from <a href="http://adndevblog.typepad.com/infrastructure/2012/04/com-references-on-civil-3d-2013.html">Interop namespaces</a> on 2013), but that makes the plug-in version dependent. One alternative is to use Late-binding, where no COM reference is added, so the code is binary version independent, but the bad side is that we have no ‘auto-complete’ feature while writing code. If the project have references, declare objects <strong><em>As Aecc-something</em></strong>,<strong><em> </em></strong>like on the sample below, otherwise declare them <strong><em>As Object</em></strong> (late binding).</p>  <p>Several Civil 3D .NET objects have an AcadObject property, which will return the equivalent COM object type. One small consideration is to use <strong><em>TryCast</em></strong> (VB.NET) or the <em><strong>as</strong></em> operation (C#), instead of making the direct cast, which can avoid some casting problems when you are not sure about the conversion. </p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'the .NET Corridor object</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">Dim</font></font></span><font style="font-size: 8pt"><font color="#000000"> oCorridor </font><span><font color="#0000ff">As</font></span><font color="#000000"> Autodesk.Civil.Roadway.DatabaseServices.</font></font><span><font style="font-size: 8pt" color="#2b91af">Corridor</font></span></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'...</font></font></span></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'initialize the .NET corridor object somehow...</font></font></span></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'...</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'now let's cast to COM</font></font></span></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'first create the COM Corridor object</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">Dim</font></font></span><font style="font-size: 8pt"><font color="#000000"> oAeccCorridor </font><span><font color="#0000ff">As</font></span><font color="#000000"> Autodesk.AECC.Interop.Roadway.AeccCorridor</font></font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'second try cast, which will return Nothing case it is impossible</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">oAeccCorridor = </font></font><font style="font-size: 8pt"><span><font color="#0000ff">TryCast</font></span><font color="#000000">(oCorridor.AcadObject, AeccCorridor)</font></font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'cast succeeded?</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">If</font></font></span><font style="font-size: 8pt"><font color="#000000"> (oAeccCorridor </font><span><font color="#0000ff">Is</font></span><font color="#000000"> </font><span><font color="#0000ff">Nothing</font></span><font color="#000000">) </font></font><span><font style="font-size: 8pt" color="#0000ff">Then</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'yes! it is valid!</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'do something here</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">End</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font></font><span><font style="font-size: 8pt" color="#0000ff">If</font></span></font></p> </div>  <p>Now, how do we cast from COM to .NET? The AcadObject property is read-only and there is no property available to cast to the .NET equivalent of the same object. One solution is to open the object using the ObjectId from the COM object. The following code shows the typical, basic coding for accessing an object for read, in this case a Corridor object.</p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'the COM Corridor object</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">Dim</font></font></span><font style="font-size: 8pt"><font color="#000000"> oAeccCorridor </font><span><font color="#0000ff">As</font></span><font color="#000000"> Autodesk.AECC.Interop.Roadway.AeccCorridor</font></font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'...</font></font></span></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'initialize the COM corridor object somehow...</font></font></span></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'...</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'get the .NET Database object</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">Dim</font></font></span><font style="font-size: 8pt"><font color="#000000"> db </font><span><font color="#0000ff">As</font></span><font color="#000000"> </font><span><font color="#2b91af">Database</font></span><font color="#000000"> = Autodesk.AutoCAD.ApplicationServices. _</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; ApplicationDocumentManager.MdiActiveDocument.Database</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">'start a transation with &quot;using&quot; keyword</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">Using</font></font></span><font style="font-size: 8pt"><font color="#000000"> trans </font><span><font color="#0000ff">As</font></span><font color="#000000"> </font><span><font color="#2b91af">Transaction</font></span><font color="#000000"> = db.TransactionManager.StartTransaction</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'create the .NET corridor object</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">Dim</font></span><font color="#000000"> oCorridor </font><span><font color="#0000ff">As</font></span><font color="#000000"> Autodesk.Civil.Roadway.DatabaseServices.</font></font><span><font style="font-size: 8pt" color="#2b91af">Corridor</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'open it using the transaction, for READ or for WRITE</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'like from COM to .NET, try cast before use it</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">Dim</font></span><font color="#000000"> corridorId </font><span><font color="#0000ff">As</font></span><font color="#000000"> </font><span><font color="#2b91af">ObjectId</font></span><font color="#000000"> = </font><span><font color="#0000ff">New</font></span><font color="#000000"> </font><span><font color="#2b91af">ObjectId</font></span><font color="#000000">(</font><span><font color="#0000ff">New</font></span><font color="#000000"> </font><span><font color="#2b91af">IntPtr</font></span><font color="#000000">( _</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; oAeccCorridor.ObjectID))</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; oCorridor = </font></font><font style="font-size: 8pt"><span><font color="#0000ff">TryCast</font></span><font color="#000000">(trans.GetObject(corridorId, _</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#2b91af">OpenMode</font></span><font color="#000000">.ForRead), </font><span><font color="#2b91af">Corridor</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'cast succeeded?</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">If</font></span><font color="#000000"> </font><span><font color="#0000ff">Not</font></span><font color="#000000"> (oCorridor </font><span><font color="#0000ff">Is</font></span><font color="#000000"> </font><span><font color="#0000ff">Nothing</font></span><font color="#000000">) </font></font><span><font style="font-size: 8pt" color="#0000ff">Then</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'yes! it is valid!</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">'do something here</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">End</font></span><font color="#000000"> </font></font><span><font style="font-size: 8pt" color="#0000ff">If</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">End</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span><font color="#0000ff">Using</font></span><font color="#000000"> </font></font><span><font style="font-size: 8pt" color="#008000">'this will Dispose the transaction object</font></span></font></p> </div>  <p>This code was demonstrated with Corridor and AeccCorridor objects, but the same will work for any other object with AcadObject or ObjectId.</p>
