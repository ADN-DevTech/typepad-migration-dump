---
layout: "post"
title: "Failed to add FS to collection at ResourceService.SetResource in Map 3D 2013"
date: "2012-10-15 03:38:50"
author: "Daniel Du"
categories:
  - "AutoCAD Map 3D 2013"
original_url: "https://adndevblog.typepad.com/infrastructure/2012/10/failed-to-add-fs-to-collection-at-resourceservicesetresource-in-map-3d-2013.html "
typepad_basename: "failed-to-add-fs-to-collection-at-resourceservicesetresource-in-map-3d-2013"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/infrastructure/daniel-du.html">Daniel Du</a></p>  <p>If you are migrating your application to Map 3D 2013 and run into this problem, this post may be helpful for you. Let’s say you have a custom command to add resource with Resource Service,for example, you are connecting to a feature source, like the implementation in the “BuildMap” sample of SDK. If you happen to run your custom command in session context:</p>  <p>&lt;CommandMethod(&quot;MyCommand&quot;, <font style="background-color: #ffff00">CommandFlags.Session</font>&gt; _    <br />or </p>  <p>[CommandMethod(&quot;MyCommand&quot;,<font style="background-color: #ffff00"> CommandFlags.Session</font>)]</p>  <p>or trying to add FDO connection from a pallet set.</p>  <p>You may get the error message at ResourceService.SetResource(): </p>  <p align="center">“Failed to add FS to collection“</p>  <p>The solution is to add DocumentLock before setting resource. Here is a pseudo code snippet:</p>  <div style="font-family: ; background: white; color: ">   <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; [</font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#2b91af">CommandMethod</font></span><span style="line-height: 11pt"><font color="#000000">(</font></span><span style="line-height: 11pt; color: "><font color="#a31515">&quot;MyCommand&quot;</font></span><span style="line-height: 11pt"><font color="#000000">, </font></span><span style="line-height: 11pt; color: "><font color="#2b91af">CommandFlags</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">.Session)]</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#0000ff">public</font></span><span style="line-height: 11pt"><font color="#000000"> </font></span><span style="line-height: 11pt; color: "><font color="#0000ff">void</font></span><span style="line-height: 11pt"><font color="#000000"> MyCommand() </font></span></font><span style="line-height: 11pt; color: "><font style="font-size: 8pt" color="#008000">// This method can have any name</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; {</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#2b91af">Document</font></span><span style="line-height: 11pt"><font color="#000000"> doc = </font></span><span style="line-height: 11pt; color: "><font color="#2b91af">Application</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000">.DocumentManager.MdiActiveDocument;</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font></span><span style="line-height: 11pt; color: "><font style="font-size: 8pt" color="#008000">// You must lock the document in Map 3D 2013</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font></span><font style="font-size: 8pt"><span style="line-height: 11pt; color: "><font color="#0000ff">using</font></span><span style="line-height: 11pt"><font color="#000000"> (</font></span><span style="line-height: 11pt; color: "><font color="#2b91af">DocumentLock</font></span></font><span style="line-height: 11pt"><font style="font-size: 8pt" color="#000000"> docLock = doc.LockDocument())</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; {</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font></span><span style="line-height: 11pt; color: "><font style="font-size: 8pt" color="#008000">// ...</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ResourceService.SetResource(...);</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><span style="line-height: 11pt"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font></span><span style="line-height: 11pt; color: "><font style="font-size: 8pt" color="#008000">//...</font></span></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; }</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><span style="line-height: 11pt"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; }</font></font></span></p> </div>  <p>And here is the explanation:<em> </em></p>  <p><em>In Map 3D 2012, the Resource Manager was not an AcDbObject – so you did not need to have a DB Lock to access it.&#160; Thus, it was OK to run the custom command in Session context.</em></p>  <p><i></i></p>  <p><i>In Map 3D 2013, the Resource Manager is moved into the Database, so you are now required to have a Document Lock to access it.&#160; Therefore, the custom command can no longer be run in Session context. </i></p>  <p>Hope this helps.</p>
