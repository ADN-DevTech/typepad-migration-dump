---
layout: "post"
title: "Adding voice commands and spatial mapping to our Unity model in HoloLens"
date: "2016-07-19 14:26:29"
author: "Kean Walmsley"
categories:
  - "Augmented Reality"
  - "HoloLens"
  - "Robotics"
  - "Unity3D"
original_url: "https://www.keanw.com/2016/07/adding-voice-commands-and-spatial-mapping-to-our-unity-model-in-hololens.html "
typepad_basename: "adding-voice-commands-and-spatial-mapping-to-our-unity-model-in-hololens"
typepad_status: "Publish"
---

<p>In the last post we added a <a href="http://through-the-interface.typepad.com/through_the_interface/2016/07/adding-gaze-and-gestures-to-control-our-unity-model-in-hololens.html" target="_blank">gaze cursor and some command support for our ABB industrial robot inside HoloLens</a>. The next step I took was to add spatial mapping, allowing the user to select the base of the robot and move it around within the spatially mapped environs.</p> <p>The <a href="https://developer.microsoft.com/en-us/windows/holographic/holograms_101" target="_blank">Holograms 101</a> tutorial provided very straightforward instructions on how to implement <a href="https://developer.microsoft.com/en-us/windows/holographic/holograms_101#chapter_6_-_spatial_mapping" target="_blank">spatial mapping</a>. I once again had to export the “wireframe” material asset from the provided project to get it across into my own, but that was a minor detail.</p> <p>Unfortunately when testing the capability – just as with voice commands – it didn’t work. In an attempt to track down the issue, I went and launched the app from the debugger, at which point I spotted this information in the debug output:</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px">Capability 'spatialPerception' is required, please enable it in Package.appxmanifest in order to enable spatial mapping functionality.</p> <p style="margin: 0px">(Filename: C:\buildslave\unity\build\PlatformDependent/MetroPlayer/MetroCapabilities.cpp Line: 126)</p> <p style="margin: 0px">　</p> <p style="margin: 0px">Capability 'microphone' is required, please enable it in Package.appxmanifest in order to enable speech recognition functionality.</p> <p style="margin: 0px">(Filename: C:\buildslave\unity\build\PlatformDependent/MetroPlayer/MetroCapabilities.cpp Line: 126)</p> <p style="margin: 0px">　</p></div> <p>So it was that I realised that – just like with the <a href="http://through-the-interface.typepad.com/through_the_interface/2016/07/displaying-your-unity-model-in-3d-using-hololens.html" target="_blank">original issue that stopped our robot hologram from appearing in 3D</a> – there were a couple of project settings I needed to enable to allow both voice and spatial mapping to work properly. You can find them in Unity under File –&gt; Build Settings… –&gt; Player Settings… –&gt; Capabilities. The settings are called “Microphone” and “SpatialPerception”.</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d206eebc970c-pi" target="_blank"><img title="Changing Unity project settings" style="float: none; margin: 30px auto; display: block" alt="Changing Unity project settings" src="/assets/image_273216.jpg" width="500" height="348"></a></p> <p>Rebuilding the project magically enabled both the voice commands and spatial mapping features I’d added by following Holograms 101.</p> <p>Here’s the <em>SpeechManager.cs</em> file, modified from the one in the tutorial:</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Linq;</p> <p style="margin: 0px"><span style="color: blue">using</span> UnityEngine;</p> <p style="margin: 0px"><span style="color: blue">using</span> UnityEngine.Windows.Speech;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">SpeechManager</span> : MonoBehaviour</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; KeywordRecognizer keywordRecognizer = <span style="color: blue">null</span>;</p> <p style="margin: 0px">&nbsp; <span style="color: #2b91af">Dictionary</span>&lt;<span style="color: blue">string</span>, System.<span style="color: #2b91af">Action</span>&gt; keywords = <span style="color: blue">new</span> <span style="color: #2b91af">Dictionary</span>&lt;<span style="color: blue">string</span>, System.<span style="color: #2b91af">Action</span>&gt;();</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: green">// Use this for initialization</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> Start()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywords.Add(<span style="color: #a31515">"Halt"</span>, () =&gt; <span style="color: blue">this</span>.BroadcastMessage(<span style="color: #a31515">"OnStop"</span>));</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywords.Add(<span style="color: #a31515">"Move"</span>, () =&gt; <span style="color: blue">this</span>.BroadcastMessage(<span style="color: #a31515">"OnStart"</span>));</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywords.Add(<span style="color: #a31515">"Quick"</span>, () =&gt; <span style="color: blue">this</span>.BroadcastMessage(<span style="color: #a31515">"OnQuick"</span>));</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywords.Add(<span style="color: #a31515">"Slow"</span>, () =&gt; <span style="color: blue">this</span>.BroadcastMessage(<span style="color: #a31515">"OnSlow"</span>));</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywords.Add(<span style="color: #a31515">"Stop"</span>, () =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> focusObject = GazeGestureManager.Instance.FocusedObject;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (focusObject != <span style="color: blue">null</span>)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Call the OnStop method on just the focused object.</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; focusObject.SendMessage(<span style="color: #a31515">"OnStop"</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; });</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywords.Add(<span style="color: #a31515">"Spin"</span>, () =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> focusObject = GazeGestureManager.Instance.FocusedObject;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (focusObject != <span style="color: blue">null</span>)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Call the OnStop method on just the focused object.</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; focusObject.SendMessage(<span style="color: #a31515">"OnStart"</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; });</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Tell the KeywordRecognizer about our keywords.</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywordRecognizer = <span style="color: blue">new</span> KeywordRecognizer(keywords.Keys.ToArray());</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Register a callback for the KeywordRecognizer and start recognizing!</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywordRecognizer.OnPhraseRecognized += KeywordRecognizer_OnPhraseRecognized;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; keywordRecognizer.Start();</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> KeywordRecognizer_OnPhraseRecognized(PhraseRecognizedEventArgs args)</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; System.<span style="color: #2b91af">Action</span> keywordAction;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (keywords.TryGetValue(args.text, <span style="color: blue">out</span> keywordAction))</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keywordAction.Invoke();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Here’s the correspondingly updated PartCommands.cs file (<em>Rotate.cs</em> can stay as it was before):</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> UnityEngine;</p> <p style="margin: 0px"><span style="color: blue">using</span> System;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PartCommands</span> : MonoBehaviour</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; <span style="color: green">// Called by GazeGestureManager when the user performs a Select gesture</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> OnSelect()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; CallOnParent(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (r.isStopped)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r.speed = -r.speed;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r.isStopped = !r.isStopped;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; );</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> OnStart()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; CallOnParent(r =&gt; r.isStopped = <span style="color: blue">false</span>);</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> OnStop()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; CallOnParent(r =&gt; r.isStopped = <span style="color: blue">true</span>);</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> OnQuick()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; CallOnParent(r =&gt; r.isFast = <span style="color: blue">true</span>);</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> OnSlow()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; CallOnParent(r =&gt; r.isFast = <span style="color: blue">false</span>);</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> CallOnParent(<span style="color: #2b91af">Action</span>&lt;Rotate&gt; f)</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> rot = <span style="color: blue">this</span>.gameObject.GetComponentInParent&lt;Rotate&gt;();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (rot)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f(rot);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Now to see it in action… here’s a video showing both voice control and spatial mapping in our robot project:</p> <p align="center">&nbsp;</p> <p align="center"><iframe height="281" src="https://www.youtube-nocookie.com/embed/z3lGKZavBcQ?rel=0&amp;showinfo=0" frameborder="0" width="500" allowfullscreen></iframe></p> <p align="center"></p>
