---
layout: "post"
title: "Jigging an AutoCAD hatch using .NET (redux)"
date: "2014-04-30 14:19:00"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Database"
  - "Graphics system"
  - "Jigs"
original_url: "https://www.keanw.com/2014/04/jigging-an-autocad-hatch-using-net-redux.html "
typepad_basename: "jigging-an-autocad-hatch-using-net-redux"
typepad_status: "Publish"
---

<p>Many thanks to Holger Rasch who worked out how to fix the code in <a href="http://through-the-interface.typepad.com/through_the_interface/2011/04/jigging-an-autocad-hatch-using-net.html" target="_blank">this previous post</a>. It really doesn’t matter that 3 years have passed, Holger – I have no doubt people will greatly appreciate the fact the code can now run without causing the annoying display issues it produced previously.</p>  <p>Holger made a few adjustments to the implementation to make sure the persistent hatch loop gets added and removed in the right places. Here’s the updated C# code:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Geometry;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Colors;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> HatchJig</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#0160; <span style="color: blue">class</span> <span style="color: #2b91af">JigUtils</span></p>    <p style="margin: 0px">&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Custom ArcTangent method, as the Math.Atan</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// doesn&#39;t handle specific cases</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">double</span> Atan(<span style="color: blue">double</span> y, <span style="color: blue">double</span> x)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (x &gt; 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">Math</span>.Atan(y / x);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (x &lt; 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">Math</span>.Atan(y / x) - <span style="color: #2b91af">Math</span>.PI;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span>&#0160; <span style="color: green">// x == 0</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (y &gt; 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">Math</span>.PI;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (y &lt; 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> -<span style="color: #2b91af">Math</span>.PI;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: green">// if (y == 0) theta is undefined</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> 0.0;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Computes Angle between current direction</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// (vector from last vertex to current vertex)</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// and the last pline segment</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">double</span> ComputeAngle(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">Point3d</span> startPoint, <span style="color: #2b91af">Point3d</span> endPoint,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">Vector3d</span> xdir, <span style="color: #2b91af">Matrix3d</span> ucs</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; )</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> v =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (endPoint.X - startPoint.X) / 2,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (endPoint.Y - startPoint.Y) / 2,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (endPoint.Z - startPoint.Z) / 2</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">double</span> cos = v.DotProduct(xdir);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">double</span> sin =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; v.DotProduct(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">Vector3d</span>.ZAxis.TransformBy(ucs).CrossProduct(xdir)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> Atan(sin, cos);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">HatchJig</span> : <span style="color: #2b91af">DrawJig</span></p>    <p style="margin: 0px">&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #2b91af">Point3d</span> _tempPoint;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">bool</span> _isArcSeg = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">bool</span> _isUndoing = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #2b91af">Matrix3d</span> _ucs;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #2b91af">Plane</span> _plane;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #2b91af">Polyline</span> _pline = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #2b91af">Hatch</span> _hat = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> HatchJig(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">Matrix3d</span> ucs, <span style="color: #2b91af">Plane</span> plane, <span style="color: #2b91af">Polyline</span> pl, <span style="color: #2b91af">Hatch</span> hat</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; )</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _ucs = ucs;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _plane = plane;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _pline = pl;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _hat = hat;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; AddDummyVertex();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: blue">bool</span> WorldDraw(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; Autodesk.AutoCAD.GraphicsInterface.<span style="color: #2b91af">WorldDraw</span> wd</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; )</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Update the dummy vertex to be our 3D point</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// projected onto our plane</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_isArcSeg)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> lastVertex =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.GetPoint3dAt(_pline.NumberOfVertices - 2);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">Vector3d</span> refDir;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices &lt; 3)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; refDir = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(1.0, 1.0, 0.0);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Check bulge to see if last segment was an arc or a line</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.GetBulgeAt(_pline.NumberOfVertices - 3) != 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> arcSegment =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.GetArcSegmentAt(_pline.NumberOfVertices - 3);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> tangent = arcSegment.GetTangent(lastVertex);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Reference direction is the invert of the arc tangent</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// at last vertex</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; refDir = tangent.Direction.MultiplyBy(-1.0);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> pt =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.GetPoint3dAt(_pline.NumberOfVertices - 3);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; refDir =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; lastVertex.X - pt.X,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; lastVertex.Y - pt.Y,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; lastVertex.Z - pt.Z</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">double</span> angle =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">JigUtils</span>.ComputeAngle(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; lastVertex, _tempPoint, refDir, _ucs</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Bulge is defined as tan of one fourth of included angle</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Need to double the angle since it represents the included</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// angle of the arc</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// So formula is: bulge = Tan(angle * 2 * 0.25)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">double</span> bulge = <span style="color: #2b91af">Math</span>.Tan(angle * 0.5);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.SetBulgeAt(_pline.NumberOfVertices - 2, bulge);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Line mode. Need to remove last bulge if there was one</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices &gt; 1)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.SetBulgeAt(_pline.NumberOfVertices - 2, 0);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _pline.SetPointAt(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.NumberOfVertices - 1, _tempPoint.Convert2d(_plane)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Only when we have enough vertices</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices &gt;2)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.Closed = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AppendTheLoop();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (!wd.RegenAbort)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; wd.Geometry.Draw(_pline);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices &gt; 2)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _hat.EvaluateHatch(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (!wd.RegenAbort)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; wd.Geometry.Draw(_hat);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Take it out, we will create a new one later</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _hat.RemoveLoopAt(0);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">SamplerStatus</span> Sampler(<span style="color: #2b91af">JigPrompts</span> prompts)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> jigOpts = <span style="color: blue">new</span> <span style="color: #2b91af">JigPromptPointOptions</span>();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; jigOpts.UserInputControls =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (<span style="color: #2b91af">UserInputControls</span>.NullResponseAccepted |</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">UserInputControls</span>.NoNegativeResponseAccepted |</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">UserInputControls</span>.GovernedByOrthoMode);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _isUndoing = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices == 1)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// For the first vertex, just ask for the point</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; jigOpts.Message = <span style="color: #a31515">&quot;\nSpecify start point: &quot;</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (_pline.NumberOfVertices &gt; 1)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">string</span> msgAndKwds =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (_isArcSeg ?</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&quot;\nSpecify endpoint of arc or [Line/Undo]: &quot;</span> :</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&quot;\nSpecify next point or [Arc/Undo]: &quot;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">string</span> kwds = (_isArcSeg ? <span style="color: #a31515">&quot;Line Undo&quot;</span> : <span style="color: #a31515">&quot;Arc Undo&quot;</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; jigOpts.SetMessageAndKeywords(msgAndKwds, kwds);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">SamplerStatus</span>.Cancel; <span style="color: green">// Should never happen</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Get the point itself</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> res = prompts.AcquirePoint(jigOpts);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (res.Status == <span style="color: #2b91af">PromptStatus</span>.Keyword)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (res.StringResult.ToUpper() == <span style="color: #a31515">&quot;ARC&quot;</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _isArcSeg = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (res.StringResult.ToUpper() == <span style="color: #a31515">&quot;LINE&quot;</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _isArcSeg = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (res.StringResult.ToUpper() == <span style="color: #a31515">&quot;UNDO&quot;</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _isUndoing = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">SamplerStatus</span>.OK;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (res.Status == <span style="color: #2b91af">PromptStatus</span>.OK)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Check if it has changed or not (reduces flicker)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_tempPoint == res.Value)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">SamplerStatus</span>.NoChange;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _tempPoint = res.Value;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">SamplerStatus</span>.OK;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: #2b91af">SamplerStatus</span>.Cancel;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">bool</span> IsUndoing</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">get</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> _isUndoing;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">void</span> AddDummyVertex()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Create a new dummy vertex... can have any initial value</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _pline.AddVertexAt(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.NumberOfVertices, <span style="color: blue">new</span> <span style="color: #2b91af">Point2d</span>(0, 0), 0, 0, 0</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">bool</span> RemoveLastVertex()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// If there&#39;s a single vertex, don&#39;t attempt to remove the</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// vertex: would cause a degenerate geometry error</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Returning false will tell the calling function to</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// abort the transaction</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices == 1)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Let&#39;s remove our dummy vertex&#0160;&#0160; </span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices &gt; 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _pline.RemoveVertexAt(_pline.NumberOfVertices - 1);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// And then check the type of the last segment</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_pline.NumberOfVertices &gt;= 2)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">double</span> blg = _pline.GetBulgeAt(_pline.NumberOfVertices - 2);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _isArcSeg = (blg != 0);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// We have to sync the hatch with the polyline</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AppendTheLoop();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">private</span> <span style="color: blue">void</span> AppendTheLoop()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> ids = <span style="color: blue">new</span> <span style="color: #2b91af">ObjectIdCollection</span>();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; ids.Add(_pline.ObjectId);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _hat.Associative = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _hat.AppendLoop(<span style="color: #2b91af">HatchLoopTypes</span>.Default, ids);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;HATJIG&quot;</span>)]</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> RunHatchJig()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> db = doc.Database;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> ed = doc.Editor;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Create a transaction, as we&#39;re jigging</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// db-resident objects</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">using</span> (<span style="color: blue">var</span> tr = db.TransactionManager.StartTransaction())</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> btr =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (<span style="color: #2b91af">BlockTableRecord</span>)tr.GetObject(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.CurrentSpaceId, <span style="color: #2b91af">OpenMode</span>.ForWrite</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> normal =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">Vector3d</span>.ZAxis.TransformBy(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.CurrentUserCoordinateSystem</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// We will pass a plane to our jig, to help</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// with UCS transformations</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> plane = <span style="color: blue">new</span> <span style="color: #2b91af">Plane</span>(<span style="color: #2b91af">Point3d</span>.Origin, normal);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// We also pass a db-resident polyline</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> pl = <span style="color: blue">new</span> <span style="color: #2b91af">Polyline</span>();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pl.Normal = normal;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; btr.AppendEntity(pl);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(pl, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// And a db-resident hatch</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> hat = <span style="color: blue">new</span> <span style="color: #2b91af">Hatch</span>();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Use a non-solid hatch pattern, to aid jigging</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; hat.SetHatchPattern(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">HatchPatternType</span>.PreDefined,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&quot;ANGLE&quot;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// But let&#39;s make it transparent, for fun</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Alpha value is Truncate(255 * (100-n)/100)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; hat.ColorIndex = 1;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; hat.Transparency = <span style="color: blue">new</span> <span style="color: #2b91af">Transparency</span>(127);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Add the hatch to the modelspace &amp; transaction</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> hatId = btr.AppendEntity(hat);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(hat, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// And finally pass everything to the jig</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> jig =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">new</span> <span style="color: #2b91af">HatchJig</span>(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.CurrentUserCoordinateSystem, plane, pl, hat</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">while</span> (<span style="color: blue">true</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> res = ed.Drag(jig);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">switch</span> (res.Status)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// New point was added, keep going</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">case</span> <span style="color: #2b91af">PromptStatus</span>.OK:</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; jig.AddDummyVertex();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Keyword was entered</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">case</span> <span style="color: #2b91af">PromptStatus</span>.Keyword:</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (jig.IsUndoing)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; jig.RemoveLastVertex();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// The jig completed successfully</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">case</span> <span style="color: #2b91af">PromptStatus</span>.None:</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// You can remove this next line if you want</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// the vertex being jigged to be included</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (jig.RemoveLastVertex())</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.Commit();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// User cancelled the command</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">default</span>:</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// No need to erase the polyline &amp; hatch, as</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// the transaction will simply be aborted</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p> </div>  <p>Here’s the code in action, with none of the former visual artifacts:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201a3fcf95b7c970b-pi"><img alt="Jigging a hatch" height="366" src="/assets/image_716785.jpg" style="display: inline" title="Jigging a hatch" width="470" /></a></p>  <p>Thanks again, Holger! :-)</p>  <p><strong><em>Update:</em></strong></p>  <p>After a comment from Robbo, I went ahead and made the generated hatch associative to its boundary by adding a single line of code (“hat.Associative = true;”) once the hatch has been made db-resident. You can, of course, comment out this line to revert to the previous behaviour.</p>  <p><strong><em>Update 2:</em></strong></p>  <p>Well that’s strange. It turns out Holger’s code was already setting boundary associativity… not sure how I missed that. Anyway, I have addressed an issue pointed out in the comments (thanks, aks!) where if you hit the spacebar immediately after starting the jig, an exception gets thrown. This has now been fixed in the above code.</p>
