---
layout: "post"
title: "Attaching an &ldquo;upright&rdquo; raster image at a user-specified location in an AutoCAD drawing using .NET"
date: "2010-08-23 11:13:56"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Drawing structure"
  - "Selection"
  - "User interface"
original_url: "https://www.keanw.com/2010/08/attaching-an-upright-raster-image-at-a-user-specified-location-in-an-autocad-drawing-using-net.html "
typepad_basename: "attaching-an-upright-raster-image-at-a-user-specified-location-in-an-autocad-drawing-using-net"
typepad_status: "Publish"
---

<p>As promised, the code in this post extends that from <a href="http://through-the-interface.typepad.com/through_the_interface/2010/08/attaching-a-qr-code-raster-image-using-autocad-net.html" target="_blank">the last post</a> to add some user selection to the process of defining and placing a <a href="http://en.wikipedia.org/wiki/QR_Code" target="_blank">QR Code</a> in an AutoCAD drawing.</p>  <p>This version of the code also makes sure the raster is positioned in an “upright” orientation, irrespective of the order in which the corners are selected. Many images need to be positioned in such a way (although QR Codes are presumably more tolerant due to the positioning squares in three of the corners), so I expect this technique will be of interest to various people who need to place images at user-specified locations. QR Codes are also square, so we’re choosing the smallest of the axes to define size (we could very easily also take the largest). This approach will become even more interesting when we migrate it to a jig, so we actually see a square area during the selection process.</p>  <p>One final change: I’ve used code from <a href="http://through-the-interface.typepad.com/through_the_interface/2007/04/adding_xdata_to.html" target="_blank">this previous post</a> to add the message string as XData to the raster image. This will allow us to provide some kind of interface for updating the string, in the future (should we need to). Although we could probably also divine this from the image's URL, as an alternative approach.</p>  <p>Here’s the updated C# code, with modified or new lines in <font color="#ff0000">red</font> (here’s <a href="http://through-the-interface.typepad.com/files/qrcodes-select.cs" target="_blank">the source file</a> for download):</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 1</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 2</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 3</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 4</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 5</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; <font color="#ff0000">6</font></span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 7</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 8</span>&#160;<span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> QRCodeApplication</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 9</span>&#160;<span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 10</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Commands</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 11</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 12</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;QR&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 13</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> QRCode()</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 14</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 15</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Base record name and URL constants</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 16</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 17</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> recBase = </span><span style="line-height: 140%; color: #a31515">&quot;ADNP_QR&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 18</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> rootUrl =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 19</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;http://chart.apis.google.com/chart?cht=qr&amp;chs=500x500&amp;chl=&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 20</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 21</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 22</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 23</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 24</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 25</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 26</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptResult</span><span style="line-height: 140%"> pr =</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 27</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.GetString(</span><span style="line-height: 140%; color: #a31515">&quot;\nEnter email address to encode: &quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 28</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 29</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 30</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 31</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Encode the colon and the @ symbol for the URL</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 32</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 33</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> message =</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 34</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;mailto%3A&quot;</span><span style="line-height: 140%"> + pr.StringResult.Replace(</span><span style="line-height: 140%; color: #a31515">&quot;@&quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">&quot;%40&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 35</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 36</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Transaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 37</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.TransactionManager.StartTransaction();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 38</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 39</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 40</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> dictId =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 41</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%">.GetImageDictionary(db);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 42</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 43</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (dictId.IsNull)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 44</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 45</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Image dictionary doesn't exist, create new</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 46</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 47</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dictId =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 48</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%">.CreateImageDictionary(db);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 49</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 50</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 51</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Open the image dictionary</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 52</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 53</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBDictionary</span><span style="line-height: 140%"> dict =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 54</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">DBDictionary</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 55</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dictId,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 56</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 57</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 58</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 59</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get a unique record name for our raster image</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 60</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// definition</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 61</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 62</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i = 0;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 63</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> recName = recBase + i.ToString();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 64</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 65</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> (dict.Contains(recName))</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 66</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 67</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; i++;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 68</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; recName = recBase + i.ToString();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 69</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 70</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 71</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%"> rid = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 72</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 73</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set its source image</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 74</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 75</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; rid.SourceFileName = rootUrl + message;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 76</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 77</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Load it</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 78</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 79</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; rid.Load();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 80</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict.UpgradeOpen();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 81</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 82</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> defId = dict.SetAt(recName, rid);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 83</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 84</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Let the transaction know</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 85</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 86</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(rid, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 87</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 88</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptPointResult</span><span style="line-height: 140%"> ppr =</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 89</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.GetPoint(</span><span style="line-height: 140%; color: #a31515">&quot;\nFirst corner of QR Code: &quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 90</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 91</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 92</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 93</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> start = ppr.Value;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 94</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 95</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ppr =</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 96</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.GetCorner(</span><span style="line-height: 140%; color: #a31515">&quot;\nSecond corner of QR Code: &quot;</span><span style="line-height: 140%">, start);</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 97</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 98</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 99</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 100</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get offset between the two corners</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 101</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 102</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%"> diff = ppr.Value - start;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 103</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 104</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the smallest of the X and Y</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 105</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (could also be the largest - this is a choice)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 106</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 107</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%"> size =</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 108</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Min(</span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Abs(diff.X), </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Abs(diff.Y));</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 109</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 110</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If we're at zero size, don't update</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 111</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 112</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (size &lt; </span><span style="line-height: 140%; color: #2b91af">Tolerance</span><span style="line-height: 140%">.Global.EqualPoint)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 113</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 114</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 115</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Determing the image's orientation...</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 116</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 117</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// The original will depend on the order of the corners</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 118</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// It will be offset to the left and/or down depending</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 119</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// on the values of the vector between the two points</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 120</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 121</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> orig;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 122</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 123</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// The axes stay the same, as we will always keep the</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 124</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// image oriented the same way relative to the UCS</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 125</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 126</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%"> xAxis = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%">(size, 0, 0);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 127</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%"> yAxis = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%">(0, size, 0);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 128</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 129</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (diff.X &gt; 0 &amp;&amp; diff.Y &gt; 0) </span><span style="line-height: 140%; color: green">// Dragging top-right</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 130</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; orig = start;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 131</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (diff.X &lt; 0 &amp;&amp; diff.Y &gt; 0) </span><span style="line-height: 140%; color: green">// Top-left</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 132</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; orig = start + </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%">(-size, 0, 0);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 133</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (diff.X &gt; 0 &amp;&amp; diff.Y &lt; 0) </span><span style="line-height: 140%; color: green">// Bottom-right</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 134</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; orig = start + </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%">(0, -size, 0);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 135</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: green">// if (diff.X &lt; 0 &amp;&amp; diff.Y &lt; 0) // Bottom-left</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 136</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; orig = start - </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%">(size, size, 0);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 137</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 138</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create the raster image that references the</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 139</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// definition</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 140</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 141</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImage</span><span style="line-height: 140%"> ri = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">RasterImage</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 142</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.ImageDefId = defId;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 143</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.ShowImage = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 144</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 145</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set the image's orientation in WCS</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 146</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 147</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Matrix3d</span><span style="line-height: 140%"> ucs = ed.CurrentUserCoordinateSystem;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 148</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 149</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.Orientation =</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 150</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">CoordinateSystem3d</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 151</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; orig.TransformBy(ucs),</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 152</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; xAxis.TransformBy(ucs),</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 153</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yAxis.TransformBy(ucs)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 154</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 155</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 156</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">BlockTable</span><span style="line-height: 140%"> bt =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 157</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">BlockTable</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 158</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.BlockTableId,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 159</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 160</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 161</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 162</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%"> btr =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 163</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 164</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bt[</span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%">.ModelSpace],</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 165</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForWrite</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 166</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 167</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 168</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; btr.AppendEntity(ri);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 169</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(ri, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 170</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 171</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create a reactor between the RasterImage and the</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 172</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// RasterImageDef to avoid the &quot;unreferenced&quot; </span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 173</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// warning in the XRef palette</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 174</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 175</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImage</span><span style="line-height: 140%">.EnableReactors(</span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 176</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.AssociateRasterDef(rid);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 177</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 178</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Let's add our message string as XData,</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 179</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// in case we need it later</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 180</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 181</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; AddRegAppTableRecord(</span><span style="line-height: 140%; color: #a31515">&quot;ADNP_QR&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 182</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%"> rb =</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 183</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 184</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%">(1001, </span><span style="line-height: 140%; color: #a31515">&quot;ADNP_QR&quot;</span><span style="line-height: 140%">),</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 185</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%">(1000, message)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 186</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 187</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.XData = rb;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 188</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; rb.Dispose();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 189</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 190</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 191</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 192</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 193</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 194</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> AddRegAppTableRecord(</span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> regAppName)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 195</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 196</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 197</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 198</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 199</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 200</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 201</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Transaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 202</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.TransactionManager.StartTransaction();</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 203</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 204</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 205</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RegAppTable</span><span style="line-height: 140%"> rat =</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 206</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">RegAppTable</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 207</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.RegAppTableId,</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 208</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead,</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 209</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 210</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 211</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!rat.Has(regAppName))</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 212</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 213</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rat.UpgradeOpen();</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 214</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RegAppTableRecord</span><span style="line-height: 140%"> ratr =</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 215</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">RegAppTableRecord</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 216</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ratr.Name = regAppName;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 217</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rat.Add(ratr);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 218</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(ratr, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 219</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 220</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 221</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 222</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 223</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 224</span>&#160;<span style="line-height: 140%">}</span></p> </div> <!--EndFragment-->  <p>Let’s take a look at the individual changes:</p>  <ul>   <li>Line 6      <ul>       <li>Add the System namespace for the various Math functions we’re now using </li>     </ul>   </li>    <li>Lines 24-34      <ul>       <li>Query the user for the email address to encode </li>     </ul>   </li>    <li>Lines 88-136      <ul>       <li>Query for the location of the image, manipulate the position of the image so that it's &quot;upright&quot; </li>     </ul>   </li>    <li>Lines 145-154      <ul>       <li>Transform the orientation relative to the current UCS </li>     </ul>   </li>    <li>Lines 178-188 &amp; 194-222      <ul>       <li>Add the message string as XData, so we can come back and get it/update it in the future </li>     </ul>   </li> </ul>  <p>We can see that as we run the QR command we can enter an email address to encode (we’ll extend this UI to cover other types of relevant information, at some point) as well as the location of the QR Code. Irrespective of the order of corner selection, the raster is always square and upright:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f3428e6e970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Selecting the location of various QR Codes in AutoCAD" border="0" alt="Selecting the location of various QR Codes in AutoCAD" src="/assets/image_913190.jpg" width="475" height="315" /></a></p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201348666d620970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="After the positioning of our last QR Code" border="0" alt="After the positioning of our last QR Code" src="/assets/image_998611.jpg" width="474" height="315" /></a></p>
