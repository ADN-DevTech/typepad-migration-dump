---
layout: "post"
title: "Creating a 3D viewer for our Apollonian service using WinRT &ndash; Part 1"
date: "2012-05-25 11:14:56"
author: "Kean Walmsley"
categories:
  - "ASP.NET"
  - "Async"
  - "Azure"
  - "JSON"
  - "REST"
  - "SaaS"
  - "WinRT"
original_url: "https://www.keanw.com/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-winrt-part-1.html "
typepad_basename: "creating-a-3d-viewer-for-our-apollonian-service-using-winrt-part-1"
typepad_status: "Publish"
---

<p>After tackling the implementation of a basic 3D viewer for <a href="http://apollonian.cloudapp.net/" target="_blank">our Apollonian web-service</a> using a variety of technology stacks – <a href="http://through-the-interface.typepad.com/through_the_interface/2012/04/calling-a-cloud-based-web-service-from-autocad-using-net.html" target="_blank">AutoCAD</a>, <a href="http://through-the-interface.typepad.com/through_the_interface/2012/04/calling-a-web-service-from-a-unity3d-scene.html" target="_blank">Unity3D</a>, <a href="http://through-the-interface.typepad.com/through_the_interface/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-android-part-3.html" target="_blank">Android</a>, <a href="http://through-the-interface.typepad.com/through_the_interface/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-ios-part-2.html" target="_blank">iOS</a> &amp; <a href="http://through-the-interface.typepad.com/through_the_interface/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-html5-part-3.html" target="_blank">HTML5/WebGL</a> – I felt as though I really needed to give it a try with WinRT, the new runtime powering Windows 8.</p>  <p>All of the previous stacks had some “object” layer I could use above the base graphics engine – <a href="http://www.rozengain.com/blog/2011/08/23/announcing-rajawali-an-opengl-es-2-0-based-3d-framework-for-android/" target="_blank">Rajawali</a> provided it for Android/OpenGL ES, <a href="http://isgl3d.com/" target="_blank">iSGL3D</a> for iOS and <a href="http://mrdoob.github.com/three.js" target="_blank">Three.js</a> for HTML5/WebGL – but for WinRT all bets were off. The general guidance for developing Metro-style 3D applications (typically that means games) is to use DirectX 11 (i.e. Direct3D) from C++.</p>  <p>I found two managed wrappers to allow me to use DirectX from C#: it seems <a href="http://slimdx.org" target="_blank">SlimDX</a> is the established player, and <a href="http://code.google.com/p/sharpdx" target="_blank">SharpDX</a> the new kid on the block (although as it is apparently auto-generated using DirectX headers it has broad coverage, already). I went with SharpDX, as it was the only one that worked – at the time of writing – with WinRT to allow creation of Metro-style apps. Both SlimDX and SharpDX have pretty sparse documentation and samples, unfortunately, but you take what you can get. And neither is intended to provide an object framework that I’d been spoiled with on other platforms: perhaps they’re out there or in development (there seems to be some excitement around <a href="http://anxframework.codeplex.com/" target="_blank">ANX.Framework</a>, which is apparently an open source replacement for Microsoft’s popular XNA, but it seems a ways off being useable).</p>  <p>So I had to roll up my sleeves and wade into low-level graphics implementation – something I’d explicitly avoided when working with OpenGL ES.</p>  <p>The first thing to take care of was building the polygons representing a sphere: something I managed to find in <a href="http://code.msdn.microsoft.com/windowsapps/DirectX-Marble-Maze-Game-e4806345/sourcecode?fileId=43833&amp;pathId=1266729374" target="_blank">this C++ DirectX sample</a>. I combined that with much of the code in <a href="http://code.google.com/p/sharpdx/source/browse/Samples/Win8" target="_blank">the MiniCube and MiniCubeXaml SharpDX samples</a> to create a Metro-style 3D viewer for our Apollonian models.</p>  <p>That’s the quick version of the story: the longer version is a bit more detailed, as I had to learn all about <a href="http://www.rastertek.com/dx11tut04.html" target="_blank">buffers and shaders</a>. The Direct3D pipeline is such that you need to create a vertex shader, which takes data in the form of buffers that get loaded onto the GPU and outputs data to be passed on to the pixel shader, which then calculates the color of a specific vertex based on the data it receives and lighting, etc. Nasty, low-level stuff (for me, at least). I had to spend some time understanding the basics of <a href="http://en.wikipedia.org/wiki/High_Level_Shader_Language" target="_blank">HLSL</a>, the C-like language you use to write these shaders before they get compiled into code the GPU can execute.</p>  <p>And it took me some time to find out that the Direct3D feature level supported by my graphics card – probably influenced by the Parallels virtualization layer between Windows 8 and my Mac hardware – influenced the way I had to compile the shaders: the app now targets a minimum of Level 9.3, which presumably means that compiling for a higher version would give better performance on different hardware.</p>  <p>Anyway, by this point I had a simple, shaded, rotating sphere. Then I had to learn about – and implement – <a href="http://www.rastertek.com/dx11tut37.html" target="_blank">instancing</a>, as one sphere wasn’t enough and we clearly didn’t want to have to generate a mesh for each of our spheres. This took me some time to get right – my app would work well until I tried to access some of the instance-specific data in my vertex shader, at which point I’d just get no graphics at all. Eventually I understood that there was a different version of the InputElement() constructor that took arguments allowing definition of instance-specific data – we needed this to define the position, radius and colour of each sphere.</p>  <p align="left">While I was hitting this particular wall, I was excited to find out about <a href="http://blogs.msdn.com/b/vcblog/archive/2011/11/08/10235150.aspx" target="_blank">the new Graphics Debugger in Visual Studio 11</a>. This is enabled automatically for C++ projects, but when working with managed code – via SlimDX or SharpDX – it takes more work to get working. I found a few <a href="http://social.msdn.microsoft.com/Forums/en-US/vsdebug/thread/6d33578a-8a2c-444b-86cf-83841773c21b" target="_blank">forum</a> <a href="http://stackoverflow.com/questions/10050992/how-do-i-get-the-graphics-debugger-working-in-visual-studio-11" target="_blank">posts</a> explaining an approach involving creating a separate EXE and then a C++ project that launches it rather than the debugger. Neither of which helped me diagnose the issue – or even led to the Graphics Debugger displaying any useful data, as it didn’t let me capture a frame, for some reason – but it was an interesting process.</p>  <p>Once I finally had instancing working, it was then a simple matter of plugging together some code to access our web-service and extract the sphere information from our JSON results.</p>  <p>Here’s the resulting application in action:</p> <object id="scPlayer" width="470" height="302" type="application/x-shockwave-flash" data="http://through-the-interface.typepad.com/presentations/jingswfplayer.swf">   <param name="movie" value="http://through-the-interface.typepad.com/presentations/jingswfplayer.swf" />   <param name="quality" value="high" />   <param name="bgcolor" value="#FFFFFF" />   <param name="flashVars" value="thumb=http://through-the-interface.typepad.com/presentations/ApollonianFirstFrame5.jpg&amp;containerwidth=470&amp;containerheight=302&amp;content=http://through-the-interface.typepad.com/presentations/Apollonian%20Viewer%20for%20Windows%208.swf&amp;blurover=false" />   <param name="allowFullScreen" value="true" />   <param name="scale" value="showall" />   <param name="allowScriptAccess" value="always" />   <param name="base" value="http://through-the-interface.typepad.com/presentations/" />   Unable to display content. Adobe Flash is required. </object>  <p><a href="http://through-the-interface.typepad.com/files/ApollonianViewerWinRT.zip" target="_blank">Here’s the VS11 project</a>. The main two source files are SimpleSphere.fx – the HLSL source for the vertex and pixel shaders…</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="margin: 0px"><span style="color: blue; line-height: 140%">float4x4</span><span style="line-height: 140%"> worldViewProj;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">struct</span><span style="line-height: 140%"> VS_IN</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float4</span><span style="line-height: 140%"> pos : POSITION;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> norm : NORMAL;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> instancePos : TEXCOORD0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float4</span><span style="line-height: 140%"> col : TEXCOORD1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> rad : TEXCOORD2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">};</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">struct</span><span style="line-height: 140%"> PS_IN</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float4</span><span style="line-height: 140%"> pos : SV_POSITION;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> norm : NORMAL;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> worldPos : POSITION0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float4</span><span style="line-height: 140%"> col : COLOR0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> rad : TEXCOORD0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">};</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">PS_IN VS( VS_IN input )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; PS_IN output = (PS_IN)0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float4</span><span style="line-height: 140%"> temp = input.pos;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; temp.w = 1.0f;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// Update the position of the vertices based on the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// data for this particular instance</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; temp.xyz *= input.rad;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; temp.x += input.instancePos.x;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; temp.y += input.instancePos.y;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; temp.z += input.instancePos.z;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; output.worldPos = temp.xyz / temp.w;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; temp = mul(temp, worldViewProj);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; output.pos = temp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; output.norm = input.norm;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; output.col = input.col;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; output.rad = input.rad;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> output;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">float4</span><span style="line-height: 140%"> PS( PS_IN input ) : SV_Target</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> LightDirection = </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%">(0, 0, 1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> AmbientColor = </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%">(0.43, 0.31, 0.24);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> LightColor = 1 - AmbientColor;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> SpotRadius = 50;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// Basic ambient (Ka) and diffuse (Kd) lighting from above</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> N = normalize(input.norm);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> NdotL = dot(N, LightDirection);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> Ka = saturate(NdotL + 1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> Kd = saturate(NdotL);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// Spotlight</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> Vec = input.worldPos;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> Dist2D = sqrt(dot(Vec.xy, Vec.xy));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Kd = Kd * saturate(SpotRadius / Dist2D);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// Diffuse reflection of light off ball</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> Dist3D = sqrt(dot(Vec, Vec));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> V = normalize(Vec);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Kd +=</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; saturate(dot(-V, N)) *</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; saturate(dot(V, LightDirection)) *</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; saturate(input.rad / Dist3D);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// Final composite</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">float3</span><span style="line-height: 140%"> Color =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; input.col.xyz * ((AmbientColor * Ka) + (LightColor * Kd));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">float4</span><span style="line-height: 140%">( Color * 0.7f, 1 );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>… and ApollonianRenderer.cs, the C# source for our main graphics implementation:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Diagnostics;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Collections.Generic;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Net.Http;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Threading.Tasks;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Windows.Data.Json;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> CommonDX;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> SharpDX;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> SharpDX.Direct3D;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> SharpDX.Direct3D11;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> SharpDX.DXGI;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> SharpDX.IO;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%"> = SharpDX.Direct3D11.</span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Device</span><span style="line-height: 140%"> = SharpDX.Direct3D11.</span><span style="color: #2b91af; line-height: 140%">Device</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> ApollonianViewer</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// We allow the UI to register an event to be called</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: green; line-height: 140%">// once a level has been loaded completely</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">delegate</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">RenderInitCompletedEventHandler</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> sender, </span><span style="color: #2b91af; line-height: 140%">EventArgs</span><span style="line-height: 140%"> e</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ApollonianRenderer</span><span style="line-height: 140%"> : </span><span style="color: #2b91af; line-height: 140%">Component</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Device</span><span style="line-height: 140%"> _device;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Our core geometry data</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">BasicVertex</span><span style="line-height: 140%">[] _vertices;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">[] _indices;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _vertCount;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _idxCount;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Our members to map this data for the GPU</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">InputLayout</span><span style="line-height: 140%"> _layout;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%">[] _vertBufs;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">[] _vertStrides;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">[] _vertOffsets;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%"> _idxBuf;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%"> _constBuf;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _instCount;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Stopwatch</span><span style="line-height: 140%"> _clock;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">VertexShader</span><span style="line-height: 140%"> _vertShader;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PixelShader</span><span style="line-height: 140%"> _pxlShader;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// The current level we're rendering</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _level;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Some structs for our vertex and sphere information</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">struct</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BasicVertex</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%"> pos;&#160; </span><span style="color: green; line-height: 140%">// position</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%"> norm; </span><span style="color: green; line-height: 140%">// surface normal vector</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; };</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">struct</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SphereDefinition</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%"> instancePos;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector4</span><span style="line-height: 140%"> col;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> rad;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Initializes a new instance of SphereRenderer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> ApollonianRenderer(</span><span style="color: #2b91af; line-height: 140%">DeviceManager</span><span style="line-height: 140%"> devices, </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> level)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Scale = 1.0f;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _level = level;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _instCount = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// We need only create the geometry for a sphere once</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; CreateSphereGeometry(</span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> _vertices, </span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> _indices);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _vertCount = _vertices.Length;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _idxCount = _indices.Length;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> Scale { </span><span style="color: blue; line-height: 140%">get</span><span style="line-height: 140%">; </span><span style="color: blue; line-height: 140%">set</span><span style="line-height: 140%">; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// When the level is changed, we actually need to query</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// the web-service and process the returned data</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> Level</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">get</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> _level;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">set</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_level != </span><span style="color: blue; line-height: 140%">value</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _level = </span><span style="color: blue; line-height: 140%">value</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CreateInstancesForLevel(_device, _level);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Our event for the UI to be told when we're done loading</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">event</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">RenderInitCompletedEventHandler</span><span style="line-height: 140%"> OnInitCompleted;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create the geometry representing a sphere</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> CreateSphereGeometry( </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BasicVertex</span><span style="line-height: 140%">[] vertices,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">[]indices</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Determine the granularity of our polygons</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> numSegs = 32;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> numSlices = numSegs / 2; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Collect the vertices for our triangles</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> numVerts = (numSlices + 1) * (numSegs + 1); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; vertices = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BasicVertex</span><span style="line-height: 140%">[numVerts];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> slice=0; slice &lt;= numSlices; slice++) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> v = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)slice / (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)numSlices; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> inclination = v * (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">Math</span><span style="line-height: 140%">.PI; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> y = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">Math</span><span style="line-height: 140%">.Cos(inclination); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> r = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">Math</span><span style="line-height: 140%">.Sin(inclination); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> segment=0; segment &lt;= numSegs; segment++) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> u = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)segment / (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)numSegs; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> azimuth = u * (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">Math</span><span style="line-height: 140%">.PI * 2.0f; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> index = slice * (numSegs + 1) + segment; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; vertices[index].pos =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; r * (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">Math</span><span style="line-height: 140%">.Sin(azimuth),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; y,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; r * (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">Math</span><span style="line-height: 140%">.Cos(azimuth)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; vertices[index].norm = vertices[index].pos;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; } </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create the indices linking these vertices</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> numIndices = numSlices * (numSegs-2) * 6; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; indices = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">[numIndices];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">uint</span><span style="line-height: 140%"> idx = 0; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> slice=0;slice&lt;numSlices;slice++) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">ushort</span><span style="line-height: 140%"> sliceBase0 = (</span><span style="color: blue; line-height: 140%">ushort</span><span style="line-height: 140%">)((slice&#160; )*(numSegs+1)); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">ushort</span><span style="line-height: 140%"> sliceBase1 = (</span><span style="color: blue; line-height: 140%">ushort</span><span style="line-height: 140%">)((slice+1)*(numSegs+1)); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%"> segment=0;segment&lt;numSegs;segment++) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%">(slice&gt;0) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; indices[idx++] = (</span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">)(sliceBase0 + segment); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; indices[idx++] = (</span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">)(sliceBase0 + segment + 1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; indices[idx++] = (</span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">)(sliceBase1 + segment + 1); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%">(slice&lt;numSlices-1) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; indices[idx++] = (</span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">)(sliceBase0 + segment); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; indices[idx++] = (</span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">)(sliceBase1 + segment + 1); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; indices[idx++] = (</span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">)(sliceBase1 + segment); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">virtual</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Initialize(</span><span style="color: #2b91af; line-height: 140%">DeviceManager</span><span style="line-height: 140%"> devices)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Remove previous buffer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; SafeDispose(</span><span style="color: blue; line-height: 140%">ref</span><span style="line-height: 140%"> _constBuf);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; CreatePipeline(devices);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; CreateInstancesForLevel(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; devices.DeviceDirect3D, _level</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _clock = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Stopwatch</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _clock.Start();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create the Direct3D pipeline for our rendering</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> CreatePipeline(</span><span style="color: #2b91af; line-height: 140%">DeviceManager</span><span style="line-height: 140%"> devices)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Setup local variables</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _device = devices.DeviceDirect3D;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> path =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Windows.ApplicationModel.</span><span style="color: #2b91af; line-height: 140%">Package</span><span style="line-height: 140%">.Current.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; InstalledLocation.Path;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Loads vertex shader bytecode</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> vertexShaderByteCode =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">NativeFile</span><span style="line-height: 140%">.ReadAllBytes(path + </span><span style="color: maroon; line-height: 140%">&quot;\\SimpleSphere_VS.fxo&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _vertShader =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">VertexShader</span><span style="line-height: 140%">(_device, vertexShaderByteCode);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Loads pixel shader bytecode</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _pxlShader =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PixelShader</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _device,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">NativeFile</span><span style="line-height: 140%">.ReadAllBytes(path + </span><span style="color: maroon; line-height: 140%">&quot;\\SimpleSphere_PS.fxo&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Layout from VertexShader input signature</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _layout =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">InputLayout</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _device,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; vertexShaderByteCode,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%">[]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Per-vertex data</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">InputElement</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: maroon; line-height: 140%">&quot;POSITION&quot;</span><span style="line-height: 140%">, 0, </span><span style="color: #2b91af; line-height: 140%">Format</span><span style="line-height: 140%">.R32G32B32_Float, 0, 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">InputElement</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: maroon; line-height: 140%">&quot;NORMAL&quot;</span><span style="line-height: 140%">, 0, </span><span style="color: #2b91af; line-height: 140%">Format</span><span style="line-height: 140%">.R32G32B32_Float, 12, 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Per-instance data</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Instance position</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">InputElement</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: maroon; line-height: 140%">&quot;TEXCOORD&quot;</span><span style="line-height: 140%">, 0, </span><span style="color: #2b91af; line-height: 140%">Format</span><span style="line-height: 140%">.R32G32B32_Float, 0, 1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">InputClassification</span><span style="line-height: 140%">.PerInstanceData, 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Instance colour</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">InputElement</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: maroon; line-height: 140%">&quot;TEXCOORD&quot;</span><span style="line-height: 140%">, 1, </span><span style="color: #2b91af; line-height: 140%">Format</span><span style="line-height: 140%">.R32G32B32A32_Float, 12, 1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">InputClassification</span><span style="line-height: 140%">.PerInstanceData, 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Instance radius</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">InputElement</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: maroon; line-height: 140%">&quot;TEXCOORD&quot;</span><span style="line-height: 140%">, 2, </span><span style="color: #2b91af; line-height: 140%">Format</span><span style="line-height: 140%">.R32_Float, 28, 1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">InputClassification</span><span style="line-height: 140%">.PerInstanceData, 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Access the Apollonian web-service and create the instance</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// information from the results</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">async</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> CreateInstancesForLevel(</span><span style="color: #2b91af; line-height: 140%">Device</span><span style="line-height: 140%"> dev, </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> lev)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Set up our various arrays and populate them</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">SphereDefinition</span><span style="line-height: 140%">[] instances = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; instances = </span><span style="color: blue; line-height: 140%">await</span><span style="line-height: 140%"> SpheresForLevel(lev);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _instCount = instances.Length;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create our buffers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _idxBuf =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ToDispose(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%">.Create(dev, </span><span style="color: #2b91af; line-height: 140%">BindFlags</span><span style="line-height: 140%">.IndexBuffer, _indices)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vertBufs =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%">[]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ToDispose(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%">.Create(dev, </span><span style="color: #2b91af; line-height: 140%">BindFlags</span><span style="line-height: 140%">.VertexBuffer, _vertices)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ToDispose(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%">.Create(dev, </span><span style="color: #2b91af; line-height: 140%">BindFlags</span><span style="line-height: 140%">.VertexBuffer, instances)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vertStrides =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">[]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Utilities</span><span style="line-height: 140%">.SizeOf&lt;</span><span style="color: #2b91af; line-height: 140%">BasicVertex</span><span style="line-height: 140%">&gt;(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Utilities</span><span style="line-height: 140%">.SizeOf&lt;</span><span style="color: #2b91af; line-height: 140%">SphereDefinition</span><span style="line-height: 140%">&gt;()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vertOffsets = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">[] { 0, 0 };</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create Constant Buffer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _constBuf =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ToDispose(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Buffer</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dev,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Utilities</span><span style="line-height: 140%">.SizeOf&lt;</span><span style="color: #2b91af; line-height: 140%">Matrix</span><span style="line-height: 140%">&gt;(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ResourceUsage</span><span style="line-height: 140%">.Default,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">BindFlags</span><span style="line-height: 140%">.ConstantBuffer,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">CpuAccessFlags</span><span style="line-height: 140%">.None,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ResourceOptionFlags</span><span style="line-height: 140%">.None,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> { }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (OnInitCompleted != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; OnInitCompleted(</span><span style="color: blue; line-height: 140%">this</span><span style="line-height: 140%">, </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EventArgs</span><span style="line-height: 140%">());</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Generate the sphere instance information for a</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// particular level</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">async</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Task</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">SphereDefinition</span><span style="line-height: 140%">[]&gt; SpheresForLevel(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> level</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%"> responseText = </span><span style="color: blue; line-height: 140%">await</span><span style="line-height: 140%"> GetJsonStream(level);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> SpheresFromJson(responseText);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Access our web-service asynchronously and return the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// results</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">async</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Task</span><span style="line-height: 140%">&lt;</span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%">&gt; GetJsonStream(</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> level)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">HttpClient</span><span style="line-height: 140%"> client = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">HttpClient</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%"> url =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: maroon; line-height: 140%">&quot;http://apollonian.cloudapp.net/api/spheres/1/&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; level.ToString();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; client.MaxResponseContentBufferSize = 1500000;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">HttpResponseMessage</span><span style="line-height: 140%"> response = </span><span style="color: blue; line-height: 140%">await</span><span style="line-height: 140%"> client.GetAsync(url);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">await</span><span style="line-height: 140%"> response.Content.ReadAsStringAsync();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Extract the sphere definitions from the JSON data</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SphereDefinition</span><span style="line-height: 140%">[] SpheresFromJson(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%"> responseText</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create our list to return and the list of colors</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> spheres = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">SphereDefinition</span><span style="line-height: 140%">&gt;();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> colors =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector4</span><span style="line-height: 140%">[]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Black.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Red.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Yellow.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Green.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Cyan.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Blue.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Magenta.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.DarkGray.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Gray.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.LightGray.ToVector4(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.White.ToVector4()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Our data contains an array at its root</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">JsonArray</span><span style="line-height: 140%"> root = </span><span style="color: #2b91af; line-height: 140%">JsonArray</span><span style="line-height: 140%">.Parse(responseText);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">JsonValue</span><span style="line-height: 140%"> val </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> root)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Each value in the array is actually an object</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">JsonObject</span><span style="line-height: 140%"> obj = val.GetObject();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Extract the properties we need from each object</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">SphereDefinition</span><span style="line-height: 140%"> def;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; def.instancePos.X = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)obj.GetNamedNumber(</span><span style="color: maroon; line-height: 140%">&quot;X&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; def.instancePos.Y = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)obj.GetNamedNumber(</span><span style="color: maroon; line-height: 140%">&quot;Y&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; def.instancePos.Z = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)obj.GetNamedNumber(</span><span style="color: maroon; line-height: 140%">&quot;Z&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; def.rad = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)obj.GetNamedNumber(</span><span style="color: maroon; line-height: 140%">&quot;R&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> level = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)obj.GetNamedNumber(</span><span style="color: maroon; line-height: 140%">&quot;L&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; def.col = colors[level &lt;= 10 ? level : 10];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Only add spheres near the edge of the outer one</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (def.instancePos.Length() + def.rad &gt; 0.99)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; spheres.Add(def);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> spheres.ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// This is called in a loop</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">virtual</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Render(</span><span style="color: #2b91af; line-height: 140%">TargetBase</span><span style="line-height: 140%"> render)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_clock == </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">) </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> ctxt = render.DeviceManager.ContextDirect3D;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> dev = render.DeviceManager.DeviceDirect3D;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> width = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)render.RenderTargetSize.Width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> height = (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)render.RenderTargetSize.Height;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Prepare matrices</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> view =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Matrix</span><span style="line-height: 140%">.LookAtLH(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%">(0, 0, -5),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%">(0, 0, 0),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%">.UnitY</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> proj =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Matrix</span><span style="line-height: 140%">.PerspectiveFovLH(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">Math</span><span style="line-height: 140%">.PI / 4.0f,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; width / (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)height,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.1f,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 100.0f</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> viewProj = </span><span style="color: #2b91af; line-height: 140%">Matrix</span><span style="line-height: 140%">.Multiply(view, proj);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> time =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%">)(_clock.ElapsedMilliseconds / 1000.0);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Set targets (this is mandatory in the loop)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctxt.OutputMerger.SetTargets(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; render.DepthStencilView,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; render.RenderTargetView</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Clear the views</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctxt.ClearDepthStencilView(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; render.DepthStencilView,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">DepthStencilClearFlags</span><span style="line-height: 140%">.Depth,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1.0f,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctxt.ClearRenderTargetView(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; render.RenderTargetView,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Colors</span><span style="line-height: 140%">.Black</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// If we have instances, let's display them</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_instCount &gt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Setup the pipeline</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.InputAssembler.InputLayout = _layout;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.InputAssembler.PrimitiveTopology =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">PrimitiveTopology</span><span style="line-height: 140%">.TriangleList;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.InputAssembler.SetVertexBuffers(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vertBufs,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vertStrides,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vertOffsets</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.InputAssembler.SetIndexBuffer(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _idxBuf,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Format</span><span style="line-height: 140%">.R16_UInt,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.VertexShader.SetConstantBuffer(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _constBuf</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.VertexShader.Set(_vertShader);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.PixelShader.Set(_pxlShader);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Calculate WorldViewProj</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> worldViewProj =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Matrix</span><span style="line-height: 140%">.Scaling(Scale) *</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Matrix</span><span style="line-height: 140%">.RotationY(-time) *</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; viewProj;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; worldViewProj.Transpose();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Update constant buffer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.UpdateSubresource(</span><span style="color: blue; line-height: 140%">ref</span><span style="line-height: 140%"> worldViewProj, _constBuf);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Draw the spheres</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxt.DrawIndexedInstanced(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _idxCount,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _instCount,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>I didn’t especially enjoy having to get down and dirty with Direct3D to write this app – I’d much rather make use of a higher-level framework, where one’s available – but I’m reasonably happy with the results. In the next post, we’ll add some touch-based UI enhancements, although I suspect that given the low-level nature of the current implementation I probably won’t end up with the same level of touch UI as was able easy to write for Android or even iOS. We’ll see,</p>  <p>By the way: in <a href="http://through-the-interface.typepad.com/through_the_interface/2012/03/the-new-developer-experience-in-visual-studio-11.html" target="_blank">a previous post</a> I’d mentioned the monochrome UI in VS11. It turns out that Microsoft is responding to Beta feedback <a href="http://blogs.msdn.com/b/visualstudio/archive/2012/05/08/visual-studio-11-user-interface-updates-coming-in-rc.aspx" target="_blank">to “increase the energy” (sigh) of the UI</a>. A good move, I think.</p>
