---
layout: "post"
title: "Creating demand-loading entries automatically for your AutoCAD application using C#, F# or VB.NET"
date: "2010-03-08 13:29:07"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Commands"
  - "F#"
  - "Installation"
  - "Runtime"
original_url: "https://www.keanw.com/2010/03/creating-demand-loading-entries-automatically-for-your-autocad-application-using-c-f-or-vbnet.html "
typepad_basename: "creating-demand-loading-entries-automatically-for-your-autocad-application-using-c-f-or-vbnet"
typepad_status: "Publish"
---

<p>This week I’m going to posting a few topics related to F#, as it feels as though I’ve been neglecting it, of late. And as this technology is going to hit the mainstream very soon – when Visual Studio 2010 ships – it seems all the more important to keep one’s F# skills honed.</p>  <p>We’re going to start the week with an F# equivalent to the code shown in <a href="http://through-the-interface.typepad.com/through_the_interface/2009/05/creating-demand-loading-entries-automatically-for-your-autocad-application-using-net.html">this previous post</a>, where we go through and reflect on the commands exposed by an assembly in order to create corresponding <a href="http://through-the-interface.typepad.com/through_the_interface/2006/09/automatic_loadi.html">demand-loading Registry keys</a> automatically.</p>  <p>We’ve shipped VB.NET and C# versions of this code as part of our <a href="http://labs.autodesk.com/utilities/ADN_plugins">Plugins of the Month</a>, but I wanted to make sure the latest versions were posted here, all in one place:</p>  <ul>   <li><span class="asset asset-generic at-xid-6a00d83452464869e20120a913c4a6970b"><a href="http://through-the-interface.typepad.com/files/demand-loading.cs">Code to create demand-loading entries from your C# applications</a></span> </li>    <li><span class="asset asset-generic at-xid-6a00d83452464869e201310f7a4acf970c"><a href="http://through-the-interface.typepad.com/files/demand_loading.vb">Code to create demand-loading entries from your VB.NET applications</a></span> </li>    <li><span class="asset asset-generic at-xid-6a00d83452464869e20120a913c569970b"><a href="http://through-the-interface.typepad.com/files/demand-loading.fs">Code to create demand-loading entries from your F# applications</a></span> </li> </ul>  <p>I’ve made a few general changes to the previous approach:</p>  <ul>   <li>More use of “using” to make sure that Registry keys get closed properly</li>    <ul>     <li>Not that this caused any particular issues of which I’m aware, but it’s certainly cleaner</li>   </ul>    <li>Use of CreateSubKey() to open the Applications key for write, or to create it if it doesn’t exist</li>    <ul>     <li>This can apparently be a problem on some vertical versions of AutoCAD such as AutoCAD Electrical</li>   </ul> </ul>  <p>Let’s take a look at the F# code, in particular:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">module</span><span style="line-height: 140%"> DemandLoading.RegistryUpdate</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Reflection</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Resources</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Microsoft.Win32</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Get the information from a custom attribute, if of the right type</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> commandInfo (rm : ResourceManager) (attb : obj) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cma = attb :?&gt; CommandMethodAttribute</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> cma &lt;&gt; </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// Harvest the information about each command</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">match</span><span style="line-height: 140%"> cma.LocalizedNameId </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; | </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> (cma.GlobalName, cma.GlobalName, cma.GroupName)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; | _ </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (cma.GlobalName,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; rm.GetString(cma.LocalizedNameId),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; cma.GroupName)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">with</span><span style="line-height: 140%"> _ </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (cma.GlobalName, cma.GlobalName, cma.GroupName)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; (</span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> commandsFromMethod rm (meth : MethodInfo) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; Array.map (commandInfo rm)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; (meth.GetCustomAttributes (typeof&lt;CommandMethodAttribute&gt;, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> commandsFromType assem (t : System.Type) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> rm = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> ResourceManager(t.FullName, assem)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; rm.IgnoreCase &lt;- </span><span style="line-height: 140%; color: blue">true</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; Array.map (commandsFromMethod rm) (t.GetMethods()) |&gt; Array.concat</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> commandsFromModule assem (m : Module) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; Array.map (commandsFromType assem) (m.GetTypes()) |&gt; Array.concat</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> commandsFromAssembly assem =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; Array.map (commandsFromModule assem) (assem.GetModules(</span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; |&gt; Array.concat</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> createDemandLoadingEntries name path currentUser cmds =</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Choose the Registry hive according to the inputs</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> hive =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> currentUser </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; Registry.CurrentUser</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; Registry.LocalMachine</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Check whether any valid commands exist (the command-names are</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// the first two entries in the tuple contained in the command</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// information array)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> hasCmds =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; Array.exists (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> (a,b,c) </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> a &lt;&gt; </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> &amp;&amp; b &lt;&gt; </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">) cmds</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// And the same for groups, which is the third entry</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> hasGrps = Array.exists (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> (a,b,c) </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> c &lt;&gt; </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">) cmds</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Define whether to load the module on startup (if no commands)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// or on command invocation (if any are defined)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> flags = </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> hasCmds </span><span style="line-height: 140%; color: blue">then</span><span style="line-height: 140%"> 12 </span><span style="line-height: 140%; color: blue">else</span><span style="line-height: 140%"> 2</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Open the main AutoCAD (or vertical) and &quot;Applications&quot; keys</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> ack =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; hive.OpenSubKey</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; (HostApplicationServices.Current.RegistryProductRootKey,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> appk = ack.CreateSubKey(</span><span style="line-height: 140%; color: maroon">&quot;Applications&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Already registered? Just return</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> not</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; (Array.exists (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> x </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> x = name) (appk.GetSubKeyNames())) </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// Create the our application&#39;s root key and its values</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> rk = appk.CreateSubKey(name)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; rk.SetValue(</span><span style="line-height: 140%; color: maroon">&quot;DESCRIPTION&quot;</span><span style="line-height: 140%">, name, RegistryValueKind.String)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; rk.SetValue(</span><span style="line-height: 140%; color: maroon">&quot;LOADCTRLS&quot;</span><span style="line-height: 140%">, flags, RegistryValueKind.DWord)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; rk.SetValue(</span><span style="line-height: 140%; color: maroon">&quot;LOADER&quot;</span><span style="line-height: 140%">, path, RegistryValueKind.String)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; rk.SetValue(</span><span style="line-height: 140%; color: maroon">&quot;MANAGED&quot;</span><span style="line-height: 140%">, 1, RegistryValueKind.DWord)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// Create a subkey if there are any commands...</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> hasCmds </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> ck = rk.CreateSubKey(</span><span style="line-height: 140%; color: maroon">&quot;Commands&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> createCommand (key : RegistryKey) info =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">match</span><span style="line-height: 140%"> info </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | (</span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, _, _) </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> () </span><span style="line-height: 140%; color: green">// Ignore any null global commands</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | (_, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, _) </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> () </span><span style="line-height: 140%; color: green">// Ignore any null local commands</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | (glob, loc, _) </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; key.SetValue(glob,loc,RegistryValueKind.String)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; Array.iter (createCommand ck) cmds |&gt; ignore</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// And the command groups, if there are any</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> hasGrps </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> gk = rk.CreateSubKey(</span><span style="line-height: 140%; color: maroon">&quot;Groups&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> createGroup (key : RegistryKey) info =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">match</span><span style="line-height: 140%"> info </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | (_, _, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">) </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> ()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | (_, _, group) </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; key.SetValue(group, group,RegistryValueKind.String)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; Array.iter (createGroup gk) cmds</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> removeDemandLoadingEntries name currentUser =</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Choose the Registry hive according to the input</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> hive =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> currentUser </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; Registry.CurrentUser</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; Registry.LocalMachine</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Open the main AutoCAD (or vertical) and &quot;Applications&quot; keys</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> ack =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; hive.OpenSubKey</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; (HostApplicationServices.Current.RegistryProductRootKey)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> appk = ack.OpenSubKey(</span><span style="line-height: 140%; color: maroon">&quot;Applications&quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Delete the key with the same name as this assembly</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; appk.DeleteSubKeyTree(name)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> RegisterForDemandLoading() =</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Get the current assembly</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> assem = Assembly.GetExecutingAssembly()</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// Get the command information and create Registry</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: green">// entries from it</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; commandsFromAssembly assem</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; |&gt; createDemandLoadingEntries</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (assem.GetName().Name) assem.Location </span><span style="line-height: 140%; color: blue">true</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> UnregisterForDemandLoading() =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; removeDemandLoadingEntries</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; (Assembly.GetExecutingAssembly().GetName().Name) </span><span style="line-height: 140%; color: blue">true</span></p> </div>   <p>I’ve tried to structure the F# code somewhat differently to the prior, more imperative versions of the code: it has more emphasis on the application of functions and the flow of data between them. It also makes use of higher order functions such as Array.map and Array.iter to apply functions to the contents of data structures (in this case arrays), and uses pattern-matching where sequences of if-then-else statements would have proven cumbersome.</p>  <p>Later in the week we’ll see this added to <a href="http://through-the-interface.typepad.com/through_the_interface/2010/03/using-a-jig-from-f-to-create-spirographs-patterns-in-autocad.html">the Spirograph application</a>, to create its demand-loading information automatically on startup, but first we’re going to need to see how to implement the IExtensionApplication interface from an F# application…</p>
