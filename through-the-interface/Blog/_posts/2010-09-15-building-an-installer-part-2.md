---
layout: "post"
title: "Building an Installer &ndash; Part 2"
date: "2010-09-15 15:20:45"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Installation"
  - "Runtime"
  - "Visual Studio"
original_url: "https://www.keanw.com/2010/09/building-an-installer-part-2.html "
typepad_basename: "building-an-installer-part-2"
typepad_status: "Publish"
---

<p>In <a href="http://through-the-interface.typepad.com/through_the_interface/2010/09/building-an-installer-part-1.html" target="_blank">the last post</a> we created a basic installer to deploy our product files and source into a user-specified location. In this post we’ll look at the Registry-related activities that need to happen from our installer.</p>  <p>One of the files we added to the install project was <a href="http://through-the-interface.typepad.com/through_the_interface/2010/02/creating-demand-loading-entries-for-net-modules-outside-of-autocad.html" target="_blank">the RegDL executable</a>. We’re going to add some custom actions which use this executable to create/remove our demand-loading Registry entries on install/uninstall.</p>  <p>The advantage of this approach is that we don’t need to duplicate information in an installation script that’s already stored in our .NET assemblies: RegDL queries an assembly programmatically for its command metadata and uses that to create accurate demand-loading information in the Registry. I should say that I haven’t fully tested this executable on different Operating Systems, so please bear that in mind. That said, the source code is available on the linked post, in case someone finds an issue and wants to debug it.</p>  <p>Let’s head across to the Custom Actions view:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f440658c970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Add our custom actions" border="0" alt="Add our custom actions" src="/assets/image_166502.jpg" width="301" height="368" /></a> </p>  <p>From here we can add an action in the appropriate place – in this case under “Install”:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134875fa973970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Adding a custom action" border="0" alt="Adding a custom action" src="/assets/image_592241.jpg" width="230" height="134" /></a> At which point we browse through the “target machine” path to our RegDL executable: <a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134875fa9cc970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Browse to our RegDL executable" border="0" alt="Browse to our RegDL executable" src="/assets/image_144807.jpg" width="281" height="199" /></a>Which takes a few clicks:<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134875faa85970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="One more folder to go" border="0" alt="One more folder to go" src="/assets/image_619999.jpg" width="281" height="200" /></a>Until we can finally select it:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f4406649970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Now we can select it" border="0" alt="Now we can select it" src="/assets/image_867224.jpg" width="281" height="200" /></a>This creates a custom action with default options, which we can edit via the properties window. We need to set the InstallerClass property to False and pass this argument to the tool: “[TARGETDIR]ADNPlugin-BatchPublish.dll”:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f44088a9970b-pi"><img style="border-bottom: 0px; border-left: 0px; margin: 20px auto; display: block; float: none; border-top: 0px; border-right: 0px" title="Add our custom install action" border="0" alt="Add our custom install action" src="/assets/image_128682.jpg" width="227" height="199" /></a></p>  <p>We can then do the same for uninstall (and rollback, just to be safe). In this case we want to add the “/unregister” option to the Arguments string:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f44088f4970b-pi"><img style="border-bottom: 0px; border-left: 0px; margin: 20px auto; display: block; float: none; border-top: 0px; border-right: 0px" title="Add our custom uninstall action" border="0" alt="Add our custom uninstall action" src="/assets/image_710604.jpg" width="227" height="199" /></a>In theory it should also be possible to create separate Custom Actions for “Just Me” (with a Condition property of ALLUSERS=“”) or “For Everyone” (with a Condition property of ALLUSERS=“1”). I did start to do so, but had some trouble with RegDL being called in “all users” mode: it seems to have trouble accessing the CurrentUser section of the Registry when called under these circumstances, and as AutoCAD only installs the “CurVer” property per-user, it would take some additional work to extend RegDL to work properly under these circumstances.</p>  <p>Rather than make this update now, we’re going to support only “Just Me” installation for this tool (and we’ll see how to remove the “For Everyone” radio button from the installer UI in the next post).</p>  <p>So we can see our three custom actions (the “uninstall” one also repeated for “rollback”, although that may well be redundant):</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f44089a3970b-pi"><img style="border-bottom: 0px; border-left: 0px; margin: 20px auto; display: block; float: none; border-top: 0px; border-right: 0px" title="Our custom actions" border="0" alt="Our custom actions" src="/assets/image_328735.jpg" width="369" height="326" /></a></p>  <p>If we look at the contents of the Registry using <em>regedit.exe</em>, we should see our Registry entries have been created under the most recently run AutoCAD version on your system:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134875fad3a970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Our demand-loading Registry keys" border="0" alt="Our demand-loading Registry keys" src="/assets/image_559918.jpg" width="424" height="269" /></a>It’s important to note that the RegDL tool currently only installs to the most recently run AutoCAD version: if you need something more flexible than this, then more work will be needed to extend the tool.</p>  <p>That takes care of our AutoCAD-related registration (i.e. creation of the Registry entries needed to enable demand-loading for our application).</p>  <p>The next Registry-related task we need to take care of is to register one of the 3rd party modules we use (<em>ComUtilities.dll</em>, a component of the <a href="http://code.google.com/p/csexwb2/" target="_blank">CsWbEx2</a> utility) for COM. If we select it in the Solution Explorer we can edit its properties in the properties window:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f440670c970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="ComUtilities-dll installation properties" border="0" alt="ComUtilities-dll installation properties" src="/assets/image_937050.jpg" width="230" height="212" /></a>Changing the Register property to vsdrfCOM will allow it to be registered for COM. Be warned that if you’re installing/uninstalling this on your development machine (always a bad idea, but that’s also what I’m doing, for what it’s worth :-), then you will probably see regular build errors after uninstall, as the <em>ComUtilities.dll</em> file gets unregistered for COM. And if you reopen the Visual Studio solution when this file is not registered, you may well see it disappear from the install project.</p>  <p>(<strong>A quick tip:</strong> I have a shortcut to <em>regsvr32.exe</em> on my desktop, and whenever I need to register a COM DLL manually I simply drag it from Explorer (yes, standard Windows Explorer) onto the desktop shortcut, which registers the DLL for COM. Easy! :-)]</p>  <p>I did try setting SharedLegacyFile to True, hoping that the additional reference counting would cause the DLL not to be unregistered on uninstall, but that didn’t end up making a difference.</p>  <p>So now the application should actually be functional: without loading the application manually into AutoCAD, we have the Registry entries in place allowing the application to be loaded automatically when the BP command is entered, and the COM DLL needed to show our custom browser is also registered and available.</p>  <p>The final Registry-related change we’re going to make is a launch condition to only install the application on AutoCAD 2011 or higher. Let’s take a look at our project’s Launch Conditions:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f4406747970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Viewing our launch conditions" border="0" alt="Viewing our launch conditions" src="/assets/image_637352.jpg" width="279" height="309" /></a>The default conditions contain one for the appropriate version of the .NET Framework to be installed:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f44067bd970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Initial state of our launch conditions" border="0" alt="Initial state of our launch conditions" src="/assets/image_216969.jpg" width="360" height="286" /></a>To check for the right AutoCAD version, we’re going to check HKEY_CURRENT_USER\Software\Autodesk\AutoCAD\CurVer (CurVer being a property under the AutoCAD root key). To do that we’re going to add a Registry search by right-clicking the Search Target Machine node:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f440682a970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Adding a Registry search" border="0" alt="Adding a Registry search" src="/assets/image_505039.jpg" width="360" height="139" /></a>We’re going to put the contents of the CurVer property (“R17.1”, “R18.0”, “R18.1”, etc.) from SOFTWARE\Autodesk\AutoCAD under the vsdrrHKCU root into a custom variable called ACADVER:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134875fb004970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Our Registry search properties" border="0" alt="Our Registry search properties" src="/assets/image_934645.jpg" width="169" height="188" /></a>We can then go and add our actual launch condition:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f44068a1970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Adding a launch condition" border="0" alt="Adding a launch condition" src="/assets/image_174287.jpg" width="360" height="140" /></a>We link this back to our ACADVER property by setting our Condition property to ACADVER&gt;=“R18.1” with an appropriate message for when the launch condition is not met:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134875fb0e3970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Our launch condition properties" border="0" alt="Our launch condition properties" src="/assets/image_341680.jpg" width="300" height="172" /></a>This will cause the following message to be displayed when the installer is run on a system on which AutoCAD 2011 or higher has not been run most recently (this is planning for the future: you may not want such an open-ended condition, in practice, but I’m trusting the relatively limited functionality of this plugin to continue to work in future releases).</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134875fb153970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Launch condition failure" border="0" alt="Launch condition failure" src="/assets/image_307323.jpg" width="232" height="89" /></a> </p>  <p>That’s it for this second part in the series, focusing on “all things Registry”. In the next (and hopefully final :-) part, we’ll take a look at adjusting the installer’s user interface, both from a cosmetic and a functional perspective.</p>
