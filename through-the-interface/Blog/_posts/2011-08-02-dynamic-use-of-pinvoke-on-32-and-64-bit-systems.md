---
layout: "post"
title: "Dynamic use of P/Invoke on 32- and 64-bit systems"
date: "2011-08-02 18:46:07"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Runtime"
original_url: "https://www.keanw.com/2011/08/dynamic-use-of-pinvoke-on-32-and-64-bit-systems.html "
typepad_basename: "dynamic-use-of-pinvoke-on-32-and-64-bit-systems"
typepad_status: "Publish"
---

<p>I’m now back from a nice, long weekend celebrating the Swiss National Day (August 1st) and our 10th wedding anniversary (which isn’t until November, but who wants to hold a party then? ;-).</p>  <p>So, getting back into the saddle, here’s a question that came in recently by email:</p>  <blockquote>   <p><em>I'm using P/Invoke to call a function which is different on x86 and x64. How to code such entry point addresses dynamically, so one does not have to compile two separate versions, one for x86, and one for x64?</em></p> </blockquote>  <p>While the answer can be found <a href="http://through-the-interface.typepad.com/through_the_interface/2009/11/updated-version-of-screenshot-now-available.html" target="_blank">a previous post</a>, it seemed worth calling it out in a post of its own.</p>  <p>The process is quite simple. We’ll start – using the example from the above post – by adding DllImport (or Declare in VB) to define our P/Invokable functions for 32- and 64-bit versions of our code (which can be determined using one of the approaches in <a href="http://through-the-interface.typepad.com/through_the_interface/2006/07/calling_objecta.html" target="_blank">these</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2008/08/using-the-pinvo.html" target="_blank">posts</a>):</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">[</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;acad.exe&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CallingConvention = </span><span style="line-height: 140%; color: #2b91af">CallingConvention</span><span style="line-height: 140%">.Cdecl,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; EntryPoint = </span><span style="line-height: 140%; color: #a31515">&quot;?acedGetCurrentColors@@YAHPAUAcColorSettings@@@Z&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> acedGetCurrentColors32(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">out</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">AcColorSettings</span><span style="line-height: 140%"> colorSettings</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">[</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;acad.exe&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CallingConvention = </span><span style="line-height: 140%; color: #2b91af">CallingConvention</span><span style="line-height: 140%">.Cdecl,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; EntryPoint = </span><span style="line-height: 140%; color: #a31515">&quot;?acedGetCurrentColors@@YAHPEAUAcColorSettings@@@Z&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> acedGetCurrentColors64(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">out</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">AcColorSettings</span><span style="line-height: 140%"> colorSettings</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p> </div>  <p>We now have our distinctly-named functions for each platform, which will only be resolved when called (or at least they don’t cause a dependency error on platforms on which they don’t exist). Now we need to find a way of calling the correct version on each platform.</p>  <p>To make this easy, we can wrap the decision and the call into a single function to be called on both platforms:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> acedGetCurrentColors(</span><span style="line-height: 140%; color: blue">out</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">AcColorSettings</span><span style="line-height: 140%"> colorSettings)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%">.Size &gt; 4)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> acedGetCurrentColors64(</span><span style="line-height: 140%; color: blue">out</span><span style="line-height: 140%"> colorSettings);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> acedGetCurrentColors32(</span><span style="line-height: 140%; color: blue">out</span><span style="line-height: 140%"> colorSettings);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>The interesting part of this is the test to see whether we’re on a &gt; 32-bit platform: a pointer (or reference to a memory location) on 32-bit Windows is stored in 4 bytes (4 x 8 = 32 bits) while on 64-bit Windows it’s stored in 8 bytes. This is a much better technique than hard-coding test for the platform via (for instance) environment variables, and it reminds me of the kind of “feature detection” you need to do during web development to support different browsers: best practice is to test for the existence of browser features exposed via Javascript, rather than testing for the specific browser/version you’re in.</p>  <p>One minor caveat: the above code is not entirely future-proof. 128-bit Operating Systems will also cause the 64-bit function version to be called, but I’m guessing we’re a ways off having to worry about that. :-)</p>  <p>Then all that’s left is to call the acedGetCurrentColors() function from your code, as needed.</p>
