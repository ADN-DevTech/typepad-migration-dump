---
layout: "post"
title: "Preventing AutoCAD objects from being purged using .NET &ndash; Part 1"
date: "2015-08-10 12:34:16"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Blocks"
  - "Drawing structure"
  - "Purge"
  - "Runtime"
original_url: "https://www.keanw.com/2015/08/preventing-autocad-objects-from-being-purged-using-net-part-1.html "
typepad_basename: "preventing-autocad-objects-from-being-purged-using-net-part-1"
typepad_status: "Publish"
---

<p>This is one of those topics that has been at the back of my mind for a number of years. Here’s a question I received via <a href="http://through-the-interface.typepad.com/through_the_interface/2007/08/purging-regis-1.html?cid=6a00d83452464869e2011571f37c36970b#comment-1292068947" target="_blank">a blog comment</a> back in 2009:</p>  <blockquote>   <p>I was wondering if there's an easy way to modify the objects to purge. For example, if a particular text style was included in the drawing that I did not want to be purged. Can this easily be done?</p> </blockquote>  <p>Here’s <a href="http://through-the-interface.typepad.com/through_the_interface/2007/08/purging-regis-1.html?cid=6a00d83452464869e2011571f37c36970b#comment-1292068950" target="_blank">how I responded</a>, at the time:</p>  <blockquote>   <p>There are a couple of ways:</p>    <p>You can maintain your own list of objects &quot;to keep&quot; and remove any items that are on this list from idsToPurge before you erase them.</p>    <p>Or you can create an object that's owned at some level by the Database (an Xrecord placed inside the Named Objects Dictionary should do it) that contains &quot;hard&quot; references to the objects you wish to keep (which means using DxfCode.HardPointerId - or one of the indeces just following it - when creating your TypedValues). This has the advantage of also stopping the standard PURGE command from removing those objects.</p> </blockquote>  <p>The question and my first suggestion, above, relates to the code shown in <a href="http://through-the-interface.typepad.com/through_the_interface/2007/08/purging-regis-1.html" target="_blank">the blog post this comment related to</a>. It’s the second suggestion that we’re going to explore over the next couple of posts…</p>  <p>I probably wouldn’t have gone back and looked at this, but the topic reared its head again in relation to <a href="http://through-the-interface.typepad.com/through_the_interface/2015/08/checking-for-built-in-autocad-objects-using-net.html" target="_blank">this recent post</a> (and its comments). The idea related to providing a way to identify “core” (which could mean system) objects, so that your application doesn’t inadvertently delete them.</p>  <p>I’d considered storing a list in memory – and then exposing an extension method to check whether an id was on the list – but had then realised that making this persistent, and using Database.Purge() to perform the check, would keep this much simpler and more unified with AutoCAD. In this post we’re going to create an API to simplify this – via extension methods on the ObjectId and Transaction classes – and in tomorrow’s we’ll implement some commands to exercise it.</p>  <p>Here’s the C# code that allows you to manage “locking objects” in an AutoCAD drawing. These locks will prevent objects from being purged – by maintaining Xrecords containing hard-pointer references to them, stored in a custom dictionary in the drawing – and will let applications know via the ObjectId.IsErasable() extension method (until we have extension properties in C#, <a href="https://github.com/dotnet/roslyn/issues/2136" target="_blank">perhaps in C# 7</a>) whether the object in question can safely be erased.</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> LockingObjects</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">class</span> <span style="color: #2b91af">ObjectLocking</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// The name for our object lock dictionary</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">const</span> <span style="color: blue">string</span> dictName = <span style="color: #a31515">&quot;TtifObjectLocks&quot;</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Internal objects to avoid repeated allocation</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">RXClass</span> _cdict = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">RXClass</span> _ctab = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Check whether this object can be erased safely.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;id&quot;&gt;</span><span style="color: green">The ID of the object to check.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">A Boolean indicating whether other objects rely on it.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> IsErasable(<span style="color: blue">this</span> <span style="color: #2b91af">ObjectId</span> id)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> idc = <span style="color: blue">new</span> <span style="color: #2b91af">ObjectIdCollection</span>(<span style="color: blue">new</span> <span style="color: #2b91af">ObjectId</span>[] { id });</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; id.Database.Purge(idc);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> idc.Count &gt; 0;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// The various collections in the drawing</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">enum</span> <span style="color: #2b91af">Contents</span></p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; NOD = 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; Blocks = 2,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DimStyles = 4,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; Layers = 8,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; Linetypes = 16,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; RegApps = 32,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; TextStyles = 64,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; Ucs = 128,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; Viewports = 256,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; Views = 512</p>    <p style="margin: 0px">&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Retrieve all the non-graphical objects in the specified drawing.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;db&quot;&gt;</span><span style="color: green">The drawing Database.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">An ObjectIdCollection of the objects in the drawing.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: #2b91af">ObjectIdCollection</span> GetAllObjectsToLock(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">Database</span> db)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> c =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Contents</span>.Blocks | <span style="color: #2b91af">Contents</span>.DimStyles | <span style="color: #2b91af">Contents</span>.Layers |</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Contents</span>.Linetypes | <span style="color: #2b91af">Contents</span>.NOD | <span style="color: #2b91af">Contents</span>.RegApps |</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Contents</span>.TextStyles | <span style="color: #2b91af">Contents</span>.Ucs | <span style="color: #2b91af">Contents</span>.Viewports |</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Contents</span>.Views;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> tr.GetObjectsToLock(db, c);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Retrieve the desired objects from the specified drawing.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;db&quot;&gt;</span><span style="color: green">The drawing Database.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;c&quot;&gt;</span><span style="color: green">The collections to retrieve.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">An ObjectIdCollection of the objects in the drawing.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: #2b91af">ObjectIdCollection</span> GetObjectsToLock(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">Database</span> db, <span style="color: #2b91af">Contents</span> c)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ids = <span style="color: blue">new</span> <span style="color: #2b91af">ObjectIdCollection</span>();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.NOD) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.NamedObjectsDictionaryId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.Blocks) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.BlockTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.DimStyles) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.DimStyleTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.Layers) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.LayerTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.Linetypes) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.LinetypeTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.RegApps) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.RegAppTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.TextStyles) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.TextStyleTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.Ucs) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.UcsTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.Viewports) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.ViewportTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((c &amp; <span style="color: #2b91af">Contents</span>.Views) &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetCollectionContents(db.ViewTableId, ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> ids;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Lock the specified objects using the provided key for the object name.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;ids&quot;&gt;</span><span style="color: green">The objects to lock.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;key&quot;&gt;</span><span style="color: green">The name for the lock object.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> LockObjects(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">ObjectIdCollection</span> ids, <span style="color: blue">string</span> key</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (ids.Count == 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Use the first ObjectId to determine the Database to use</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> db = ids[0].Database;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> dict = tr.GetLockDictionary(db, <span style="color: #2b91af">OpenMode</span>.ForRead);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dict != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> rb = HardPointersForIds(ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Xrecord</span> xr;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dict.Contains(key))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Update the existing lock object</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; xr = tr.GetObject((<span style="color: #2b91af">ObjectId</span>)dict[key], <span style="color: #2b91af">OpenMode</span>.ForWrite) <span style="color: blue">as</span> <span style="color: #2b91af">Xrecord</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; xr.Data = rb;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Create a new lock object</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; xr = <span style="color: blue">new</span> <span style="color: #2b91af">Xrecord</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; xr.XlateReferences = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; xr.Data = rb;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict.UpgradeOpen();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict.SetAt(key, xr);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(xr, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Remove the specified object lock for this drawing.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;db&quot;&gt;</span><span style="color: green">The drawing Database.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;key&quot;&gt;</span><span style="color: green">The name of the lock object to remove.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> RemoveObjectLock(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">Database</span> db, <span style="color: blue">string</span> key</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> dict = tr.GetLockDictionary(db, <span style="color: #2b91af">OpenMode</span>.ForRead);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dict != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dict.Contains(key))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> entry =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetObject((<span style="color: #2b91af">ObjectId</span>)dict[key], <span style="color: #2b91af">OpenMode</span>.ForWrite);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; entry.Erase();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Get the object locks for the specified drawing.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;db&quot;&gt;</span><span style="color: green">The drawing Database.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">An array of names of the lock objects in the drawing.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">string</span>[] GetObjectLocks(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">Database</span> db</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> dict = tr.GetLockDictionary(db, <span style="color: #2b91af">OpenMode</span>.ForRead);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dict == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> names = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">string</span>&gt;(dict.Count);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> entry <span style="color: blue">in</span> dict)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; names.Add(entry.Key);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> names.ToArray();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Returns whether the specified object lock exists in a drawing.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;db&quot;&gt;</span><span style="color: green">The drawing Database.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;key&quot;&gt;</span><span style="color: green">The name of the lock object to check for.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">A Boolean indicating the existence of the lock object.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> HasObjectLock(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">Database</span> db, <span style="color: blue">string</span> key</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> dict = tr.GetLockDictionary(db, <span style="color: #2b91af">OpenMode</span>.ForRead);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dict == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> dict.Contains(key);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Private helpers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Recursively extract the ObjectIds from a collection</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// (could be a symbol table or a dictionary - or just a single object)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">void</span> GetCollectionContents(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">ObjectId</span> id, <span style="color: #2b91af">ObjectIdCollection</span> ids</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Add the object's ID (whether a single object or a collection)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ids.Add(id);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Only get the RXClasses the first time we check</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_cdict == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cdict = <span style="color: #2b91af">RXObject</span>.GetClass(<span style="color: blue">typeof</span>(<span style="color: #2b91af">DBDictionary</span>));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_ctab == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ctab = <span style="color: #2b91af">RXObject</span>.GetClass(<span style="color: blue">typeof</span>(<span style="color: #2b91af">SymbolTable</span>));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Check whether we have a collection</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">bool</span> isdict = id.ObjectClass.IsDerivedFrom(_cdict);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">bool</span> istab = id.ObjectClass.IsDerivedFrom(_ctab);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (isdict || istab)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// If so, open it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> obj = tr.GetObject(id, <span style="color: #2b91af">OpenMode</span>.ForRead);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (isdict)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> dict = obj <span style="color: blue">as</span> <span style="color: #2b91af">DBDictionary</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (dict != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Recurse on each of the dictionary's entries</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> entry <span style="color: blue">in</span> dict)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetCollectionContents(tr, entry.Value, ids);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Also get entities from blocks?</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Not needed for the purge prevention scenario</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> tab = obj <span style="color: blue">as</span> <span style="color: #2b91af">SymbolTable</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (tab != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Recurse on each of the symbol table records</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> rec <span style="color: blue">in</span> tab)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetCollectionContents(tr, rec, ids);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Get the lock dictionary from the NOD (will create one if none exists)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">DBDictionary</span> GetLockDictionary(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">Database</span> db, <span style="color: #2b91af">OpenMode</span> mode</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">DBDictionary</span> dict = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> nod =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetObject(db.NamedObjectsDictionaryId, <span style="color: #2b91af">OpenMode</span>.ForRead)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">as</span> <span style="color: #2b91af">DBDictionary</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// If we find our dictionary in the NOD, open and return it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (nod.Contains(dictName))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict = tr.GetObject((<span style="color: #2b91af">ObjectId</span>)nod[dictName], mode) <span style="color: blue">as</span> <span style="color: #2b91af">DBDictionary</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Otherwise create it, add it to the NOD, and make sure it's open</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// according to the specified mode</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict = <span style="color: blue">new</span> <span style="color: #2b91af">DBDictionary</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict.TreatElementsAsHard = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; nod.UpgradeOpen();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; nod.SetAt(dictName, dict);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(dict, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; nod.DowngradeOpen();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">switch</span> (mode)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> <span style="color: #2b91af">OpenMode</span>.ForRead:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict.DowngradeOpen();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> <span style="color: #2b91af">OpenMode</span>.ForNotify:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dict.DowngradeToNotify(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">default</span>:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> dict;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Return a resbuf of hard pointers, one for each ObjectId provided</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">ResultBuffer</span> HardPointersForIds(<span style="color: #2b91af">ObjectIdCollection</span> ids)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> rb = <span style="color: blue">new</span> <span style="color: #2b91af">ResultBuffer</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> gc = (<span style="color: blue">int</span>)<span style="color: #2b91af">DxfCode</span>.HardPointerId;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">ObjectId</span> id <span style="color: blue">in</span> ids)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; rb.Add(<span style="color: blue">new</span> <span style="color: #2b91af">TypedValue</span>(gc, id));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> rb;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p> </div>  <p>A few comments on some choices made, here:</p>  <ul>   <li>We extend the Transaction object with the bulk of the implementation – as most developers will be using the Transaction system with .NET – but it could also hang off the Database object and (for instance) use OpenCloseTransactions internally for the drawing access. </li>    <li>Some code has been included to simplify extraction of ObjectIds from the drawing: we recursively extract these from two different types of collection – DBDictionary and SymbolTable – objects. We don’t currently extract ObjectIds for entities – as these are not typically purged – but we could certainly do so. </li>    <li>Applications will need to use ObjectId.IsErasable() – or the underlying Database.Purge(), if checking lots of objects at once – if they want to test erasability. Applications that don’t will still be able to erase objects but run a greater risk of drawing corruption (just as they do today, admittedly). </li> </ul>  <p>Incidentally, I’ve added comments that can be understood by Visual Studio’s IntelliSense to make our API more discoverable:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb08609650970d-pi" target="_blank"><img title="Our extension methods on the Transaction object" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Our extension methods on the Transaction object" src="/assets/image_48071.jpg" width="500" height="137" /></a></p>  <p>That’s it for this post. In the next post we’ll implement some commands that take advantage of these new methods (as well as ObjectId.IsErasable(), of course).</p>
