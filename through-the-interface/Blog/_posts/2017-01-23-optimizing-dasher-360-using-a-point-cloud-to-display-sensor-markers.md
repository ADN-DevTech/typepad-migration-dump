---
layout: "post"
title: "Optimizing Dasher 360: using a point cloud to display sensor markers"
date: "2017-01-23 18:33:51"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk"
  - "Graphics system"
  - "IoT"
  - "JavaScript"
original_url: "https://www.keanw.com/2017/01/optimizing-dasher-360-using-a-point-cloud-to-display-sensor-markers.html "
typepad_basename: "optimizing-dasher-360-using-a-point-cloud-to-display-sensor-markers"
typepad_status: "Publish"
---

<p>At the <a href="http://through-the-interface.typepad.com/through_the_interface/2016/12/hololens-and-forge-at-the-munich-accelerator.html" target="_blank">Forge Accelerator in Munich</a>, back in December, while I spent most of my time answering what questions I could about Forge I also showed up with a question of my own.</p> <p>In the original prototype of Dasher 360 we used code from a very helpful sample that showed how to add SVG markers to the DOM inside the Forge viewer. The <a href="https://github.com/Autodesk-Forge/library-javascript-viewer-extensions/tree/master/src/Viewing.Extension.Markup3D" target="_blank">original sample</a> showed this in the context of adding markup to a model: on our side we wanted it to mark the location of sensors in the model. While this was great for small numbers of sensors, it didn’t really scale: not only did it get slow – each sensor needed its own set of DOM elements – but managing occlusion from existing model geometry proved to be really challenging.</p> <p>So while Philippe Leefsma and I were sharing a taxi to the Accelerator’s location in Munich, we talked about this problem. Philippe’s suggestion was to make use of the capability in THREE.js to <a href="https://threejs.org/examples/#webgl_buffergeometry_points" target="_blank">display point clouds</a>. His big question was whether the version of THREE.js being used by the Forge viewer was recent enough for us to make use of this feature or not. My take was that should the viewer be using an older version of THREE.js, there’d be a strong case to be made for the viewer adopting a newer version: this was important to us, and I’m sure would be beneficial to other uses of the Forge viewer, too.</p> <p>As it turned out – thanks to research performed by my colleague Simon Breslav – the version of THREE.js being used in the Forge viewer was recent enough to include the point cloud feature. Admittedly it’s an earlier version – in more recent versions of THREE.js it was renamed from PointCloud to ParticleSystem and then Points – but it works very well. What’s great is that Simon could use some of his shader-fu to create a custom GLSL shader to make the points look pretty much identical to the way they were in the previous implementation.</p> <p>While I won’t share the code just yet (you’ll be able to view the page source once it’s been integrated into <a href="http://dasher360.com" target="_blank">Dasher 360</a>), here’s the basic approach:</p> <ol> <li>Define your vertex and fragment shaders in string variables (they should be implemented using GLSL).  <li>Create a THREE.ShaderMaterial with the two shaders as optio  <li>If you’re occluding with other geometry, set depthTest and depthWrite to true.  <li>Create a THREE.Geometry object and push your points to its vertices property.  <li>Create a THREE.PointCloud (later this will need migration to THREE.Points) with the geometry and material.  <li>Add this to the Forge viewer using viewer.impl.addOverlay() (you may need to call viewer.impl.invalidate() afterwards).</li></ol> <p>Here’s a quick screenshot of sensors being seen through the window of the 210 King Street East building. Navigation is now much, much smooth than with our previous attempt at implementing occlusion.</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb09703be5970d-pi" target="_blank"><img title="Sensors being occluded by the building" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 30px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Sensors being occluded by the building" src="/assets/image_756848.jpg" width="372" height="281"></a></p> <p>Having a single point cloud object does pose some challenges for various per-sensor features such as displaying tooltips and enabling “on click” selection, however. We had to jump through quite a few hoops to make it all work. In the next post I’ll share some details on how we did so.</p>
