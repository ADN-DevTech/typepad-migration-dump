---
layout: "post"
title: "Creating a 3D viewer for our Apollonian service using iOS &ndash; Part 1"
date: "2012-05-07 17:56:14"
author: "Kean Walmsley"
categories:
  - "iOS"
  - "JSON"
  - "Mac"
  - "Mobile"
  - "REST"
  - "SaaS"
original_url: "https://www.keanw.com/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-ios-part-1.html "
typepad_basename: "creating-a-3d-viewer-for-our-apollonian-service-using-ios-part-1"
typepad_status: "Publish"
---

<p>Last week, it was <a href="http://through-the-interface.typepad.com/through_the_interface/2012/04/creating-a-3d-viewer-for-our-apollonian-service-using-android-part-1.html" target="_blank">all</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-android-part-2.html" target="_blank">about</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-android-part-3.html" target="_blank">Android</a>. This week, I’ve started taking the plunge into the world of iOS. I’ve been using a Mac for some time – mainly to wean myself away from being so Windows-centric, but also with a view to working more with AutoCAD for Mac from a development perspective – but this was the first time I’d actually forced myself to write anything for either OS X or iOS.</p>  <p>It all came as a bit of a shock, initially, even though I was generally aware of the strangeness of <a href="http://en.wikipedia.org/wiki/Objective-C" target="_blank">Objective-C</a> with respect to its message-passing syntax. So while I enjoy <a href="http://through-the-interface.typepad.com/through_the_interface/python/" target="_blank">learning</a> <a href="http://through-the-interface.typepad.com/through_the_interface/ruby/" target="_blank">different</a> <a href="http://through-the-interface.typepad.com/through_the_interface/f/" target="_blank">programming</a> <a href="http://through-the-interface.typepad.com/through_the_interface/java/" target="_blank">languages</a>, I found I really struggled with Objective-C. But anyway – obviously lots of people have managed to get their heads around it (and many of this blog’s readers will have done so, I’m sure), so at least there is a fair amount of help available out there on the web.</p>  <p>Someone has already commented on the fact that you can use C# to build apps for iOS and Android directly – such as with a toolkit like <a href="http://xamarin.com/" target="_blank">Xamarin</a> or an engine like <a href="http://through-the-interface.typepad.com/through_the_interface/2012/04/calling-a-web-service-from-a-unity3d-scene.html" target="_blank">Unity3D</a> – but the point of this series of posts is as much about driving my own learning as it is about presenting my readers with easy options (sorry for being selfish, but that’s just how it is). And I think there’s value in seeing the “native” approach across a variety of platforms – while knowing that options exist allowing you to maintain a largely platform-independent codebase to target them.</p>  <p>And so on to my deep-ish dive into iOS…</p>  <p>My first challenge was identifying a decent (and free) 3D engine for our viewer – all of which seem to be based on OpenGL ES, much the same as for Android. I started by looking at <a href="http://brenwill.com/cocos3d/" target="_blank">Cocos3D</a> (which is based on the apparently very popular <a href="http://www.cocos2d-iphone.org/" target="_blank">Cocos2D</a>), but ended up discarding it as it didn’t appear to have a sphere primitive available (which was a bit of a deal-breaker for me, given the problem space ;-).</p>  <p>I moved on to look at <a href="http://isgl3d.com/" target="_blank">iSGL3D</a>, which certainly appeared to provide what I was looking for from a 3D engine. I spent some time looking at <a href="http://isgl3d.com/resources/tutorials" target="_blank">its online tutorials</a>, which were reasonably comprehensive, before trying the “tests” provided with the framework and <a href="http://isgl3d.com/tutorials/1/tutorial_0_getting_started" target="_blank">building my first basic app</a> with the Xcode 4 template. I went through a little unnecessary thrashing, as I pulled down the latest file versions directly <a href="https://github.com/isgl3d/isgl3d" target="_blank">from GitHub</a> before realising I really needed to install <a href="http://isgl3d.com/download" target="_blank">the latest stable build</a> (version 1.2.3 at the time of writing).</p>  <p>But, that aside, the process was reasonably straightforward. I modified the contents of the “Hello World” files created by the Xcode template (renaming them, too, of course), to be as follows…</p>  <p>It’s worth noting that – in an effort to make the code a more familiar and consistent with the other code I post here – I’ve thrown away the book on Objective-C coding conventions (much as I did for Java, last week). That’s partly for the benefit of this blog’s readers, but also for my own sanity. ;-)</p>  <p>Firstly, the <em>ApollonianViewer.h</em> header file:</p>  <p class="p1"><span class="s1">#import </span>&quot;isgl3d.h&quot;</p>  <p class="p2"></p>  <p class="p3"><span class="s2">@interface</span> ApollonianViewer : Isgl3dBasic3DView</p>  <p class="p3">{</p>  <p class="p6"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>@private</p>  <p class="p2"></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>NSMutableArray * _materials;<span class="Apple-tab-span"> </span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>Isgl3dNode * _container;</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>Isgl3dSphere * _sphereMesh;</p>  <p class="p3">}</p>  <p class="p3">-(<span class="s2">void</span>)createSphere</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>:(<span class="s2">double</span>)radius</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>x:(<span class="s2">double</span>)x y:(<span class="s2">double</span>)y z:(<span class="s2">double</span>)z</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>level:(<span class="s2">int</span>)level;</p>  <p class="p6">@end</p>  <p>And now the main <em>ApollonianViewer.m</em> implementation file:</p>  <p class="p1"><span class="s1">#import </span>&quot;ApollonianViewer.h&quot;</p>  <p class="p2"></p>  <p class="p3"><span class="s2">@implementation</span> ApollonianViewer</p>  <p class="p2"></p>  <p class="p4">// Our data member for the received data</p>  <p class="p2"></p>  <p class="p3"><span class="s3">NSMutableData</span> * _receivedData = <span class="s2">NULL</span>;</p>  <p class="p2"></p>  <p class="p4">// A response has been received from our web-service call</p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">void</span>)connection:(<span class="s3">NSURLConnection</span> *)connection</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>didReceiveResponse:(<span class="s3">NSURLResponse</span> *)response</p>  <p class="p3">{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Initialise our member variable receiving data</p>  <p class="p2"></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160; </span></span><span class="s2">if</span><span class="s4"> (</span>_receivedData<span class="s4"> == </span><span class="s2">NULL</span><span class="s4">)</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s5">_receivedData</span> = [[<span class="s3">NSMutableData</span> <span class="s6">alloc</span>] <span class="s6">init</span>];</p>  <p class="p6"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>else</p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[</span>_receivedData<span class="s4"> </span><span class="s6">setLength</span><span class="s4">:</span><span class="s7">0</span><span class="s4">];</span></p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p4">// Data has been received from our web-service call</p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">void</span>)connection:(<span class="s3">NSURLConnection</span> *)connection</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>didReceiveData:(<span class="s3">NSData</span> *)data</p>  <p class="p3">{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Append the received data to our member</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160; </span>[</span>_receivedData<span class="s4"> </span><span class="s6">appendData</span><span class="s4">:data];</span></p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p4">// The web-service connection failed</p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">void</span>)connection:(<span class="s3">NSURLConnection</span> *)connection</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>didFailWithError:(<span class="s3">NSError</span> *)error</p>  <p class="p3">{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Report an error in the log</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p1"><span class="s4"><span class="Apple-converted-space">&#160; </span></span><span class="s6">NSLog</span><span class="s4">(</span>@&quot;Connection failed: %@&quot;<span class="s4">, [error </span><span class="s6">description</span><span class="s4">]);</span></p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p4">// The call to our web-service has completed</p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">void</span>)connectionDidFinishLoading</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>:(<span class="s3">NSURLConnection</span> *)connection</p>  <p class="p3">{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Release the connection</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>[connection <span class="s6">release</span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Get the response string from our data member then</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// release it</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span><span class="s3">NSString</span> *responseString =</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[[<span class="s3">NSString</span> <span class="s6">alloc</span>]</p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span><span class="s6">initWithData</span><span class="s4">:</span>_receivedData</p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>encoding<span class="s4">:</span>NSUTF8StringEncoding</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>];</p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160; </span>[</span>_receivedData<span class="s4"> </span><span class="s6">release</span><span class="s4">];</span></p>  <p class="p2"></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Extract JSON data from our response string</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span><span class="s3">NSData</span> *jsonData =</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[responseString</p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>dataUsingEncoding<span class="s4">:</span>NSUTF8StringEncoding<span class="s4">];</span></p>  <p class="p2"></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Extract an array from our JSON data</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span><span class="s3">NSError</span> *e = <span class="s2">nil</span>;</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span><span class="s3">NSArray</span> *jsonArray =</p>  <p class="p8"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[</span>NSJSONSerialization</p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>JSONObjectWithData<span class="s4">: jsonData</span></p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>options<span class="s4">: </span>NSJSONReadingMutableContainers</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s6">error</span>: &amp;e</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span><span class="s2">if</span> (!jsonArray)</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>{</p>  <p class="p1"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span><span class="s6">NSLog</span><span class="s4">(</span>@&quot;Error parsing JSON: %@&quot;<span class="s4">, e);</span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>}</p>  <p class="p6"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>else</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Loop through our JSON array, extracting spheres</p>  <p class="p2"></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s2">for</span> (<span class="s3">NSDictionary</span> *item <span class="s2">in</span> jsonArray)</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>// We'll need this data for each sphere</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s2">double</span> x, y, z, radius;</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s2">int</span> level;</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>// We use a single NSNumber to extract the data</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s3">NSNumber</span> *num;</p>  <p class="p2"></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>num = [item <span class="s6">objectForKey</span>:<span class="s8">@&quot;X&quot;</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>x = [num <span class="s6">doubleValue</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>num = [item <span class="s6">objectForKey</span>:<span class="s8">@&quot;Y&quot;</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>y = [num <span class="s6">doubleValue</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>num = [item <span class="s6">objectForKey</span>:<span class="s8">@&quot;Z&quot;</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>z = [num <span class="s6">doubleValue</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>num = [item <span class="s6">objectForKey</span>:<span class="s8">@&quot;R&quot;</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>radius = [num <span class="s6">doubleValue</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>num = [item <span class="s6">objectForKey</span>:<span class="s8">@&quot;L&quot;</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>level = [num <span class="s6">intValue</span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>// Only create spheres for those at the edge of the</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>// outer sphere</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s2">double</span> length = <span class="s6">sqrt</span>(x*x + y*y + z*z);</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s2">if</span> (length + radius &gt; <span class="s7">0.99f</span>)</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>[<span class="s2">self</span> <span class="s9">createSphere</span>:radius <span class="s9">x</span>:x <span class="s9">y</span>:y <span class="s9">z</span>:z <span class="s9">level</span>:level];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>}</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Trigger the rotation updates</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[<span class="s2">self</span> <span class="s9">schedule</span>:<span class="s2">@selector</span>(tick:)];</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>}</p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">id</span>) init</p>  <p class="p3">{ <span class="Apple-converted-space">&#160;</span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span><span class="s2">if</span> ((<span class="s2">self</span> = [<span class="s2">super</span> <span class="s9">init</span>]))</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Set up our web-service call</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s3">NSURL</span> *url =</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>[<span class="s3">NSURL</span></p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>URLWithString<span class="s4">:</span></p>  <p class="p1"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>@&quot;http://apollonian.cloudapp.net/api/spheres/1/7&quot;</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p8"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>NSMutableURLRequest<span class="s4"> *request =</span></p>  <p class="p8"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>[</span>NSMutableURLRequest</p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>requestWithURL<span class="s4">:url</span></p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>cachePolicy<span class="s4">:</span>NSURLRequestUseProtocolCachePolicy</p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>timeoutInterval<span class="s4">:</span><span class="s7">60.0</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[request <span class="s6">setHTTPMethod</span>:<span class="s8">@&quot;GET&quot;</span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s3">NSURLConnection</span> *connection =</p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>[[</span><span class="s3">NSURLConnection</span><span class="s4"> </span>alloc<span class="s4">]</span>initWithRequest<span class="s4">:request </span>delegate<span class="s4">:</span><span class="s2">self</span><span class="s4">];</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s2">if</span> (connection)</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>{</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s5">_receivedData</span> = [[<span class="s3">NSMutableData</span> <span class="s6">data</span>] <span class="s6">retain</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>} <span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Move the default camera to the desired position</p>  <p class="p2"></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[<span class="s2">self</span>.<span class="s5">camera</span> <span class="s9">setPosition</span>:<span class="s1">iv3</span>(<span class="s7">0</span>, <span class="s7">0</span>, -<span class="s7">5</span>)];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Create a container for our spheres</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>_container<span class="s4"> = [</span><span class="s2">self</span><span class="s4">.</span>scene<span class="s4"> </span><span class="s9">createNode</span><span class="s4">];</span></p>  <p class="p2"></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// We'll maintain an array of materials for our</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// levels. Define the colors for those levels</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s3">NSArray</span> * colors =</p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>[</span><span class="s3">NSArray</span><span class="s4"> </span>arrayWithObjects<span class="s4">:</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* white */</span> <span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;FFFFFF&quot;</span>,</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* red */</span> <span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;FF0000&quot;</span>,</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* yellow */</span><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;FFFF00&quot;</span>,</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* green */</span> <span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;00FF00&quot;</span>,</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* cyan */</span><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;00FFFF&quot;</span>,</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* blue */</span><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;0000FF&quot;</span>,</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* magenta */</span> <span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s8">@&quot;FF00FF&quot;</span>,</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>/* dark gray */<span class="s4"> <span class="Apple-converted-space">&#160; </span></span><span class="s8">@&quot;A9A9A9&quot;</span><span class="s4">,</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* gray */</span><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;808080&quot;</span>,</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>/* light gray */<span class="s4"><span class="Apple-converted-space">&#160; </span></span><span class="s8">@&quot;D3D3D3&quot;</span><span class="s4">,</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s10">/* white */</span> <span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s8">@&quot;FFFFFF&quot;</span>,</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s2">nil</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>];</p>  <p class="p2"></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Create and populate the array of materials</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s5">_materials</span> = [[<span class="s3">NSMutableArray</span> <span class="s6">alloc</span>] <span class="s6">init</span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s2">for</span> (<span class="s2">int</span> i=<span class="s7">0</span>; i &lt; <span class="s7">12</span>; i++)</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>// Anything we don't have a color for will be white</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s3">NSString</span> *col =</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>(i &lt;= <span class="s7">10</span>) ? [colors <span class="s6">objectAtIndex</span>:i] : <span class="s8">@&quot;FFFFFF&quot;</span>;</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>// For simplicity, make the colors the same for</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>// ambient, diffuse and specular lighting</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>Isgl3dColorMaterial<span class="s4"> * mat =</span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>[[</span>Isgl3dColorMaterial<span class="s4"> </span><span class="s6">alloc</span><span class="s4">]</span></p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>initWithHexColors<span class="s4">:col</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s9">diffuse</span>:col</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s9">specular</span>:col</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span class="s9">shininess</span>:<span class="s7">0.7</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>[<span class="s5">_materials</span> <span class="s6">addObject</span>:mat];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>}</p>  <p class="p2"></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Create a single sphere mesh</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>_sphereMesh<span class="s4"> =</span></p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>[[</span><span class="s5">Isgl3dSphere</span><span class="s4"> </span><span class="s6">alloc</span><span class="s4">] </span>initWithGeometry<span class="s4">:</span><span class="s7">1</span><span class="s4"> </span>longs<span class="s4">:</span><span class="s7">9</span><span class="s4"> </span>lats<span class="s4">:</span><span class="s7">9</span><span class="s4">];</span></p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Create a directional white light and add it to the scene</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span><span class="s5">Isgl3dLight</span> * light =</p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>[</span>Isgl3dLight</p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>lightWithHexColor<span class="s4">:</span><span class="s8">@&quot;A0A0A0&quot;</span></p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>diffuseColor<span class="s4">:</span><span class="s8">@&quot;E9E9E9&quot;</span></p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>specularColor<span class="s4">:</span><span class="s8">@&quot;C0C0C0&quot;</span></p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span>attenuation<span class="s4">:</span><span class="s7">0</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span>light.</span><span class="s5">lightType</span><span class="s4"> = </span>DirectionalLight<span class="s4">;</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>light.<span class="s5">position</span> = <span class="s1">iv3</span>(<span class="s7">4</span>, <span class="s7">0</span>, <span class="s7">8</span>);</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[light <span class="s9">setDirection</span>:<span class="s7">1</span> <span class="s9">y</span>:<span class="s7">2</span> <span class="s9">z</span>:-<span class="s7">5</span>];</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[<span class="s2">self</span>.<span class="s5">scene</span> <span class="s9">addChild</span>:light];</p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span></span>// Set the scene ambient color</p>  <p class="p2"></p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[</span><span class="s2">self</span><span class="s4"> </span>setSceneAmbient<span class="s4">:</span><span class="s8">@&quot;000000&quot;</span><span class="s4">];</span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>}</p>  <p class="p6"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>return<span class="s4"> </span>self<span class="s4">;</span></p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p4">// Create a single sphere at the desired position with</p>  <p class="p4">// the desired radius and level</p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">void</span>)createSphere</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>:(<span class="s2">double</span>)radius</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>x:(<span class="s2">double</span>)x y:(<span class="s2">double</span>)y z:(<span class="s2">double</span>)z</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>level:(<span class="s2">int</span>)level</p>  <p class="p3">{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Create the sphere based on our single mesh</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>Isgl3dMeshNode<span class="s4"> * sphere =</span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160; </span>[</span>_container</p>  <p class="p9"><span class="s4"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span></span>createNodeWithMesh<span class="s4">:</span><span class="s5">_sphereMesh</span></p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160;&#160;&#160; </span><span class="s9">andMaterial</span>:[<span class="s5">_materials</span> <span class="s6">objectAtIndex</span>:level]</p>  <p class="p3"><span class="Apple-converted-space">&#160;&#160;&#160; </span>];</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Position and scale it</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>sphere.<span class="s5">position</span> = <span class="s1">iv3</span>(x, y, z);</p>  <p class="p3"><span class="Apple-converted-space">&#160; </span>[sphere <span class="s9">setScale</span>:radius];</p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">void</span>) dealloc</p>  <p class="p3">{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Make sure we release our materials and sphere mesh</p>  <p class="p2"><span class="Apple-converted-space">&#160; </span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160; </span>[</span>_materials<span class="s4"> </span><span class="s6">release</span><span class="s4">];</span></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160; </span>[</span>_sphereMesh<span class="s4"> </span><span class="s6">release</span><span class="s4">];</span></p>  <p class="p2"><span class="Apple-converted-space">&#160;&#160;&#160; </span></p>  <p class="p7"><span class="s4"><span class="Apple-converted-space">&#160; </span>[</span><span class="s2">super</span><span class="s4"> </span>dealloc<span class="s4">];</span></p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p2"></p>  <p class="p3">- (<span class="s2">void</span>) tick:(<span class="s2">float</span>)dt</p>  <p class="p3">{</p>  <p class="p4"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>// Rotate around the y axis</p>  <p class="p2"></p>  <p class="p5"><span class="s4"><span class="Apple-converted-space">&#160; </span></span>_container<span class="s4">.</span>rotationY<span class="s4"> += </span><span class="s7">2</span><span class="s4">;</span></p>  <p class="p3">}</p>  <p class="p2"></p>  <p class="p6">@end</p>  <p>The app currently does a fair amount less that its Android counterpart – I haven’t implemented any kind of UI, including progress bars, touch gestures, etc. – but there were actually some things that just worked more smoothly: rather than worrying about threading issues, the call to the web-service seemed to execute asynchronously by default, and the code adding spheres worked well, once I’d determined I needed to control the lifetime of my supporting objects rather than allowing them to be garbage-collected at the whim of the iOS runtime. It’s not clear to me how much of this is down to the iSGL3D runtime vs. Objective-C/iOS, but I was pleasantly surprised, either way.</p>  <p>I expect I’ll hit more significant challenges, further down the line, but my initial impression is that the above code is actually impressively functional for the amount there is: it was pretty simple to access a REST web-service and decode the JSON results, for instance, and the iSGL3D coding was also relatively straightforward.</p>  <p>And while looking at the syntax still gives me a headache, at least my nose has stopped bleeding. ;-)</p>  <p>Here’s a screenshot of the app working on the iPad 5.1 Simulator:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20163054fd524970d-pi" target="_blank"><img style="background-image: none; border-right-width: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="First pass Apollonian Viewer on iOS" border="0" alt="First pass Apollonian Viewer on iOS" src="/assets/image_429519.jpg" width="465" height="370" /></a>I’d really like to see this working on the iPad itself, as before I start tweaking the lighting, etc. to get better results, I’d like to see what, if anything, is due to the lack of GPU-accelerated graphics in the simulator (assuming that’s the case). It seems that to do so I’ll need to sign up for the <a href="https://developer.apple.com/programs/ios/" target="_blank">iOS Developer Progrram at $99 per year</a>, which I find a little annoying but to some degree understandable.</p>  <p>In fairness, the Android simulator can’t even run OpenGL ES 2.0 code, at the time of writing, so being forced to pay to test on a physical device would probably have raised the barrier of entry high enough to put me off working with Android completely. At least there is some option for getting started for free on iOS.</p>  <p>Aside from testing on a physical device, I also want to implement some kind of rudimentary UI – much as I did for Android – so I’ll be working on that before I end up posting the full project.</p>
