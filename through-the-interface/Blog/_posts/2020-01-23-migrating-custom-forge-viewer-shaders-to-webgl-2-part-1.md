---
layout: "post"
title: "Migrating custom Forge viewer shaders to WebGL 2 &ndash; Part 1"
date: "2020-01-23 19:55:51"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk Research"
  - "IoT"
original_url: "https://www.keanw.com/2020/01/migrating-custom-forge-viewer-shaders-to-webgl-2-part-1.html "
typepad_basename: "migrating-custom-forge-viewer-shaders-to-webgl-2-part-1"
typepad_status: "Publish"
---

<p>An interesting thing happened when I tried <a href="http://dasher360.com" target="_blank">Dasher 360</a> with the latest production version of the Forge viewer: no sensor dots appeared. As Dasher without sensors is a glorified 3D viewer, this was a bit of a problem.</p><p>Digging into things a little, I worked out that our custom WebGL shader wasn’t working properly in this latest version.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a4b5da71200c-pi" target="_blank"><img width="500" height="217" title="Something's broken" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Something's broken" src="/assets/image_743018.jpg" border="0"></a></p><p>At this point I reached out to my friend <a href="https://www.keanw.com/2020/01/additively-manufacturing-music-using-the-printesizer.html" target="_blank">Elias Cohenca in Tel Aviv</a> for a quick sanity check: he confirmed that this latest version of the Forge viewer is now defaulting to WebGL 2.0. This was confirmed in the <a href="https://dev.forge.autodesk.com/en/docs/viewer/v7/change_history/changelog_v7/#id2" target="_blank">Forge viewer change-log</a>, where there was this innocent-looking line-item:</p><blockquote><p><em>This version will attempt to initialize using a WebGL2 and will fallback into WebGL1.</em></p></blockquote><p>As far as I can tell this means that WebGL 2 will be used if your device supports it, not based on whether your application has been migrated to support WebGL 2 (although for all I know there may also be a setting somewhere to force the use of WebGL 1).</p><p>Anyway, after realising this was at the root of my problem, Elias pointed out a way to understand what was wrong with this shader. If you declare a <font face="Consolas">DEBUG_SHADERS</font> a <font face="Consolas" size="2">DEBUG_SHADERS</font> variable in your host application, setting it to true – I did in mine by simply having <font face="Consolas">var DEBUG_SHADERS = true;</font><font face="Calibri"> inside a <font face="Consolas">&lt;script&gt;</font> element on the main page – then the Forge viewer will dump some extra output to the developer console when it fails to compile your shader. Happy days!</font></p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a4b5da7b200c-pi" target="_blank"><img width="500" height="472" title="Shader debugging information" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Shader debugging information" src="/assets/image_710965.jpg" border="0"></a></p><p>Debugging shaders can be tricky at the best of times: the errors being given by any compilation process can be obscure, but GLSL seems to take this to a whole new level. During various points of the debugging process we went from being told there was an assignment issue to a type mismatch, until I eventually twigged that we had a variable called ‘texture’, which is a reserved word in GLSL 3.0. Aha!</p><p>Fixing this meant that the shader now displays sensor dots inside v7.10 of the Forge viewer, but unfortunately there are still some quirks around the access and use of display attributes for each item in our point cloud (which is what we use to display our sensor locations). This means that a) they’re not all in quite the right place and b) they don’t have the right behaviour when you hover over them.</p><p>For instance, the inner colour never changes on hover…</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a503a6f7200b-pi" target="_blank"><img width="500" height="312" title="No inner colors on hover" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="No inner colors on hover" src="/assets/image_529618.jpg" border="0"></a></p><p>… unless you hit the sensor or equipment dot that is first in their respective lists – with index of 0 – which causes the whole of the list to have their inner colour change.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a4b5d71e200c-pi" target="_blank"><img width="500" height="312" title="Unless you hit the one with zero index and then ka-ching" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Unless you hit the one with zero index and then ka-ching" src="/assets/image_791255.jpg" border="0"></a></p><p>Reading between the lines on this behaviour, it’s probably because I need to migrate the vertex attributes to use Vertex Array Objects. We’ll see.</p><p>All of this will take some more digging into, and no doubt a call or two with Elias, who I’m going to have to fill with beer the next time I see him. On a closing note, <a href="https://www.instructables.com/id/Printesizer-a-3D-Printer-Synthesizer/" target="_blank">Elias’s 3D printer project</a> has been <a href="https://hackaday.com/2020/01/19/play-that-funky-3d-printer/" target="_blank">featured on Hackaday</a>, so I may have to pick his brain quickly before he retires as a Maker celebrity creating 3D printed music full-time.</p><p>Assuming we manage to make some progress, in the coming days I should be able to share some more specifics about what else you might need to change to have your own custom shaders work properly in the Forge viewer v7.10 and above. (Oh, and if you’re asking yourself “do I have custom shaders?” then you almost certainly don’t. You’d remember.)</p>
