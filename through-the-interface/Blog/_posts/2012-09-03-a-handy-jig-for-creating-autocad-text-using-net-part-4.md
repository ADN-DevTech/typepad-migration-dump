---
layout: "post"
title: "A handy jig for creating AutoCAD text using .NET &ndash; Part 4"
date: "2012-09-03 09:28:18"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Jigs"
  - "Runtime"
  - "User interface"
original_url: "https://www.keanw.com/2012/09/a-handy-jig-for-creating-autocad-text-using-net-part-4.html "
typepad_basename: "a-handy-jig-for-creating-autocad-text-using-net-part-4"
typepad_status: "Publish"
---

<p>After the <a href="http://through-the-interface.typepad.com/through_the_interface/2012/08/a-handy-jig-for-creating-autocad-text-using-net-part-1.html" target="_blank">first</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2012/08/a-handy-jig-for-creating-autocad-text-using-net-part-2.html" target="_blank">three</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2012/08/a-handy-jig-for-creating-autocad-text-using-net-part-3.html" target="_blank">parts</a> of this series covered the basic jig that makes use of the standard keywords mechanism to adjust text’s style and rotation as it’s being placed, it eventually made sense to implement the remaining requirement initially provided for the jig: this post looks at different approaches for having the jig respond to single keystrokes rather than full keyword inputs.</p>  <p>Dave Osborne very helpfully got me started on this by providing an initial implementation that makes use of an IMessageFilter – something he’d apparently gleaned from <a href="http://through-the-interface.typepad.com/through_the_interface/2007/02/allowing_users_.html" target="_blank">this previous post</a>. Thanks, Dave! :-)</p>  <p>All the approaches I’ll outline in this post make use of this core technique, but do so in slightly different ways. Basically we want our jig to now respond to the Tab key to rotate our text by 90 degrees – it would be simple enough to extend the technique to cover different properties, too, but that’s left as an exercise for the reader.</p>  <p>The trick is that we have three separate classes between which we will need to communicate, primarily to adjust the angle: our Commands class, our Jig class and our IMessageFilter class.</p>  <p>The first thing you might try when getting them to share information between such classes is to have a static member of the Commands class that gets accessed by the other two. This is dangerous, mainly because shared data is tricky to manage. If you have a second document, for instance, which also has the same command running, you may well hit a problem if they both access and adjust the same “angle” value. They won’t be able to do so at exactly the same time – as AutoCAD isn’t multi-threaded – but the results are likely to be unpredictable. See <a href="http://through-the-interface.typepad.com/through_the_interface/2006/10/perdocument_dat.html" target="_blank">this previous post</a> for more on this topic.</p>  <p>You could also keep the data in the Commands class, but this time expose it in a different way to the other classes. For instance, you might choose to have a public property exposed and then pass a reference to the Commands class when creating the Jig and the IMessageFilter, so that their implementations might access the data.</p>  <p>Or you might decouple the implementations even further and define delegates for the rotate action and a method to access the angle property’s current value. You could then pass lambda functions in from the Commands class, and the bodies of these lambdas could very validly access a local variable in the Commands class, so you wouldn’t even need object-level state exposed.</p>  <p>In any of these three approaches you end up with an IMessageFilter object that modifies the angle directly, rather than passing through the jig. They work well enough when the Jig is processing messages – such as when you hit Tab as you’re dragging the mouse – but work less well when the mouse is stationary. It’s only when the mouse moves that you’ll see the effects of hitting the Tab key catch up with the object’s on-screen rotation.</p>  <p>Which has led me to my preferred implementation: simply using the IMessageFilter as a “keyboard accelerator” class that sends the assigned keyword through to the Jig for processing. This has the benefit of consistency – you can keep the keyword implementation intact, and the user can also use that rather than the Tab key – and also of responsiveness – there are no discrepancies between the object state and the on-screen representation.</p>  <p>Here’s the C# implementation, with the new lines in <font color="#ff0000">red</font>, although I’ve made a few other largely cosmetic but unhighlighted changes such as adding a namespace (and <a href="http://through-the-interface.typepad.com/files/quick-text-with-tab-shortcut.cs" target="_blank">here’s the source file</a> for you to download).</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 1</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 2</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 3</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 4</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 5</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.GraphicsInterface;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 6</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160;&#160; 7</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Runtime.InteropServices;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160;&#160; 8</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> WinForms = System.Windows.Forms;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 9</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 10</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 11</span>&#160;<span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> QuickText</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 12</span>&#160;<span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 13</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Commands</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 14</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 15</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;QT&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 16</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> QuickText()</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 17</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 18</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 19</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 20</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 21</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 22</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 23</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptStringOptions</span><span style="line-height: 140%"> pso =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 24</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptStringOptions</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;\nEnter text string&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 25</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pso.AllowSpaces = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 26</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptResult</span><span style="line-height: 140%"> pr = ed.GetString(pso);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 27</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 28</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 29</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 30</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 31</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Transaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 32</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.TransactionManager.StartTransaction();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 33</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 34</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 35</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%"> btr =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 36</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 37</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.CurrentSpaceId, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForWrite</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 38</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 39</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 40</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create the text object, set its normal and contents</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 41</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 42</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBText</span><span style="line-height: 140%"> txt = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">DBText</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 43</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.Normal =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 44</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.CurrentUserCoordinateSystem.</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 45</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CoordinateSystem3d.Zaxis;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 46</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.TextString = pr.StringResult;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 47</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 48</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We'll add the text to the database before jigging</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 49</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// it - this allows alignment adjustments to be</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 50</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// reflected</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 51</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 52</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; btr.AppendEntity(txt);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 53</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(txt, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 54</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 55</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create our jig</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 56</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 57</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">TextPlacementJig</span><span style="line-height: 140%"> pj =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 58</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TextPlacementJig</span><span style="line-height: 140%">(tr, db, txt);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 59</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 60</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Loop as we run our jig, as we may have keywords</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 61</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 62</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%"> stat = </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.Keyword;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 63</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> (stat == </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.Keyword)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 64</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 65</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> filt = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TxtRotMsgFilter</span><span style="line-height: 140%">(doc);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 66</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 67</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; WinForms.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.AddMessageFilter(filt);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 68</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptResult</span><span style="line-height: 140%"> res = ed.Drag(pj);</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 69</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; WinForms.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.RemoveMessageFilter(filt);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 70</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 71</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; stat = res.Status;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 72</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 73</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; stat != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK &amp;&amp;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 74</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; stat != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.Keyword</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 75</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 76</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 77</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 78</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 79</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 80</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 81</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 82</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 83</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TextPlacementJig</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #2b91af">EntityJig</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 84</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 85</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Declare some internal state</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 86</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 87</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> _db;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 88</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Transaction</span><span style="line-height: 140%"> _tr;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 89</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> _position;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 90</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%"> _angle, _txtSize;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 91</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> _toggleBold, _toggleItalic;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 92</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TextHorizontalMode</span><span style="line-height: 140%"> _align;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 93</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 94</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Constructor</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 95</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 96</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> TextPlacementJig(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 97</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Transaction</span><span style="line-height: 140%"> tr, </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db, </span><span style="line-height: 140%; color: #2b91af">Entity</span><span style="line-height: 140%"> ent</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 98</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ) : </span><span style="line-height: 140%; color: blue">base</span><span style="line-height: 140%">(ent)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 99</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 100</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _db = db;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 101</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _tr = tr;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 102</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _angle = 0;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 103</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _txtSize = 1;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 104</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 105</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 106</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">protected</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">SamplerStatus</span><span style="line-height: 140%"> Sampler(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 107</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">JigPrompts</span><span style="line-height: 140%"> jp</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 108</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 109</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 110</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We acquire a point but with keywords</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 111</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 112</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">JigPromptPointOptions</span><span style="line-height: 140%"> po =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 113</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">JigPromptPointOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 114</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nPosition of text&quot;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 115</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 116</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 117</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; po.UserInputControls =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 118</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">UserInputControls</span><span style="line-height: 140%">.Accept3dCoordinates |</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 119</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">UserInputControls</span><span style="line-height: 140%">.NullResponseAccepted |</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 120</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">UserInputControls</span><span style="line-height: 140%">.NoNegativeResponseAccepted |</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 121</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">UserInputControls</span><span style="line-height: 140%">.GovernedByOrthoMode);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 122</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 123</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; po.SetMessageAndKeywords(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 124</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nSpecify position of text or &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 125</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;[Bold/Italic/LArger/Smaller/&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 126</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ROtate90/LEft/Middle/RIght]: &quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 127</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Bold Italic LArger Smaller &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 128</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ROtate90 LEft Middle RIght&quot;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 129</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 130</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 131</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptPointResult</span><span style="line-height: 140%"> ppr = jp.AcquirePoint(po);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 132</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 133</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status == </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.Keyword)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 134</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 135</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">switch</span><span style="line-height: 140%"> (ppr.StringResult)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 136</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 137</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;Bold&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 138</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 139</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _toggleBold = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 140</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 141</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 142</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;Italic&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 143</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 144</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _toggleItalic = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 145</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 146</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 147</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;LArger&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 148</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 149</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Multiple the text size by two</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 150</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 151</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _txtSize *= 2;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 152</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 153</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 154</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;Smaller&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 155</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 156</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Divide the text size by two</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 157</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 158</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _txtSize /= 2;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 159</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 160</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 161</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;ROtate90&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 162</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 163</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// To rotate clockwise we subtract 90 degrees &amp;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 164</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// then normalise the angle between 0 and 360</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 165</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 166</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _angle -= </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.PI / 2;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 167</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> (_angle &lt; </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.PI * 2)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 168</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 169</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _angle += </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.PI * 2;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 170</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 171</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 172</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 173</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;LEft&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 174</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 175</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _align = </span><span style="line-height: 140%; color: #2b91af">TextHorizontalMode</span><span style="line-height: 140%">.TextLeft;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 176</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 177</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 178</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;RIght&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 179</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 180</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _align = </span><span style="line-height: 140%; color: #2b91af">TextHorizontalMode</span><span style="line-height: 140%">.TextRight;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 181</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 182</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 183</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;Middle&quot;</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 184</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 185</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _align = </span><span style="line-height: 140%; color: #2b91af">TextHorizontalMode</span><span style="line-height: 140%">.TextMid;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 186</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 187</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 188</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 189</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 190</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">SamplerStatus</span><span style="line-height: 140%">.OK;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 191</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 192</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status == </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 193</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 194</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Check if it has changed or not (reduces flicker)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 195</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 196</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 197</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _position.DistanceTo(ppr.Value) &lt;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 198</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Tolerance</span><span style="line-height: 140%">.Global.EqualPoint</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 199</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 200</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">SamplerStatus</span><span style="line-height: 140%">.NoChange;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 201</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 202</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _position = ppr.Value;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 203</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">SamplerStatus</span><span style="line-height: 140%">.OK;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 204</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 205</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 206</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">SamplerStatus</span><span style="line-height: 140%">.Cancel;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 207</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 208</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 209</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">protected</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> Update()</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 210</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 211</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set properties on our text object</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 212</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 213</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBText</span><span style="line-height: 140%"> txt = (</span><span style="line-height: 140%; color: #2b91af">DBText</span><span style="line-height: 140%">)Entity;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 214</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 215</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.Position = _position;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 216</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.Height = _txtSize;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 217</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.Rotation = _angle;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 218</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.HorizontalMode = _align;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 219</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_align != </span><span style="line-height: 140%; color: #2b91af">TextHorizontalMode</span><span style="line-height: 140%">.TextLeft)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 220</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 221</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.AlignmentPoint = _position;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 222</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.AdjustAlignment(_db);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 223</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 224</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 225</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set the bold and/or italic properties on the style</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 226</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 227</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_toggleBold || _toggleItalic)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 228</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 229</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">TextStyleTable</span><span style="line-height: 140%"> tab =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 230</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">TextStyleTable</span><span style="line-height: 140%">)_tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 231</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _db.TextStyleTableId, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 232</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 233</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 234</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">TextStyleTableRecord</span><span style="line-height: 140%"> style =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 235</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">TextStyleTableRecord</span><span style="line-height: 140%">)_tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 236</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.TextStyleId, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 237</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 238</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 239</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// A bit convoluted, but this check will tell us</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 240</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// whether the new style is bold/italic</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 241</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 242</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> bold = !(style.Font.Bold == _toggleBold);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 243</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> italic = !(style.Font.Italic == _toggleItalic);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 244</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _toggleBold = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 245</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _toggleItalic = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 246</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 247</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the new style name based on the old name and</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 248</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// a suffix (&quot;_BOLD&quot;, &quot;_ITALIC&quot; or &quot;_BOLDITALIC&quot;)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 249</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 250</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> oldName = style.Name.Split(</span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%">[] { </span><span style="line-height: 140%; color: #a31515">'_'</span><span style="line-height: 140%"> });</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 251</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> newName =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 252</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; oldName[0] +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 253</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (bold || italic ? </span><span style="line-height: 140%; color: #a31515">&quot;_&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 254</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (bold ? </span><span style="line-height: 140%; color: #a31515">&quot;BOLD&quot;</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #a31515">&quot;&quot;</span><span style="line-height: 140%">) +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 255</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (italic ? </span><span style="line-height: 140%; color: #a31515">&quot;ITALIC&quot;</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #a31515">&quot;&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 256</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; : </span><span style="line-height: 140%; color: #a31515">&quot;&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 257</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 258</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We only create a duplicate style if one doesn't</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 259</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// already exist</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 260</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 261</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tab.Has(newName))</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 262</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 263</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.TextStyleId = tab[newName];</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 264</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 265</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 266</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 267</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We have to create a new style - clone it</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 268</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 269</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">TextStyleTableRecord</span><span style="line-height: 140%"> newStyle =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 270</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">TextStyleTableRecord</span><span style="line-height: 140%">)style.Clone();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 271</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 272</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set a new name to avoid duplicate keys</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 273</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 274</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; newStyle.Name = newName;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 275</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 276</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create a new font based on the old one, but with</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 277</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// our values for bold &amp; italic</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 278</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 279</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">FontDescriptor</span><span style="line-height: 140%"> oldFont = style.Font;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 280</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">FontDescriptor</span><span style="line-height: 140%"> newFont =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 281</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">FontDescriptor</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 282</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; oldFont.TypeFace, bold, italic,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 283</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; oldFont.CharacterSet, oldFont.PitchAndFamily</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 284</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 285</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 286</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set it on the style</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 287</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 288</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; newStyle.Font = newFont;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 289</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 290</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Add the new style to the text style table and</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 291</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// the transaction</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 292</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 293</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tab.UpgradeOpen();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 294</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> styleId = tab.Add(newStyle);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 295</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _tr.AddNewlyCreatedDBObject(newStyle, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 296</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 297</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And finally set the new style on our text object</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 298</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 299</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; txt.TextStyleId = styleId;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 300</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 301</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 302</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 303</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 304</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 305</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 306</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 307</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 308</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TxtRotMsgFilter</span><span style="line-height: 140%"> : WinForms.</span><span style="line-height: 140%; color: #2b91af">IMessageFilter</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 309</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 310</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 311</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;user32.dll&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 312</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; CharSet = </span><span style="line-height: 140%; color: #2b91af">CharSet</span><span style="line-height: 140%">.Auto,</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 313</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ExactSpelling = </span><span style="line-height: 140%; color: blue">true</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 314</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; )]</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 315</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%"> GetKeyState(</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> keyCode);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 316</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 317</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> WM_KEYDOWN = 256;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 318</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> VK_CONTROL = 17;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 319</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 320</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> _doc = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 321</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 322</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> TxtRotMsgFilter(</span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 323</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 324</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _doc = doc;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 325</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 326</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160; 327</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> PreFilterMessage(</span><span style="line-height: 140%; color: blue">ref</span><span style="line-height: 140%"> WinForms.</span><span style="line-height: 140%; color: #2b91af">Message</span><span style="line-height: 140%"> m)</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 328</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 329</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 330</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; m.Msg == WM_KEYDOWN &amp;&amp;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 331</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; m.WParam == (</span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%">)WinForms.</span><span style="line-height: 140%; color: #2b91af">Keys</span><span style="line-height: 140%">.Tab &amp;&amp;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 332</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetKeyState(VK_CONTROL) &gt;= 0</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 333</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 334</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 335</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _doc.SendStringToExecute(</span><span style="line-height: 140%; color: #a31515">&quot;_RO &quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 336</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 337</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 338</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 339</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: red">&#160; 340</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 341</span>&#160;<span style="line-height: 140%">}</span></p> </div>  <p>Something to note from this implementation… to avoid responding to Control-Tab – which should switch between open drawings, of course – the code detects whether the Control key has been pressed at the same time as Tab. It only sends the _RO keyword to the command-line in the cases where the Control key is not pressed. It seems Alt-Tab is intercepted before it gets to AutoCAD – which makes sense, as it’s used to switch between applications – so that’s not something we need to check for.</p>  <p>To test it all works well, it’s interesting to have two new drawings open – with the application loaded – and launch the QT command in each, entering a different text string. You can then Control-Tab between the drawings, using the Tab key to rotate them independently.</p>  <p><strong><em>Update:</em></strong></p>  <p>Thanks to Heinz Dober for reminding me that at additional assembly reference to “System.Windows.Forms” will be needed in your project for the IMessageFilter-related code to compile.</p>
