---
layout: "post"
title: "Implementing a demo mode inside the Forge viewer &ndash; Part 2"
date: "2017-03-16 20:23:35"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Async"
  - "Autodesk Research"
  - "HTML"
  - "JavaScript"
  - "User interface"
original_url: "https://www.keanw.com/2017/03/implementing-a-demo-mode-inside-the-forge-viewer-part-2.html "
typepad_basename: "implementing-a-demo-mode-inside-the-forge-viewer-part-2"
typepad_status: "Publish"
---

<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c8e11980970b-pi" target="_blank"><img title="Dasher 360 in kiosk mode" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 30px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Dasher 360 in kiosk mode" src="/assets/image_244551.jpg" width="500" height="312"></a>  <p>Now that we’ve seen <a href="http://through-the-interface.typepad.com/through_the_interface/2017/03/implementing-a-demo-mode-inside-the-forge-viewer-part-1.html" target="_blank">how to move a fake cursor across the screen</a>, let’s talk about how best to use this technique to implement a demo mode for your Forge viewer-based application.</p> <p>Something I mentioned last time was that – for our purposes – this code needs to be fairly adaptable, whether for different views, models or screen configurations. It also needs to be easy for us to modify or extend.</p> <p>Inside <a href="http://dasher360.com" target="_blank">Dasher 360</a> we’ve implemented a number of different extensions. Many of these have their own UI, typically launched by a button. One of the first things I did for this project was to make each extension able to report the location of its launch button: this way we can query the information and use it to move the cursor to that location in order to simulate the launch action (we load and run the extension from our code, of course).</p> <p>Here’s a snippet of TypeScript code that shows how this works, more or less (there are dependent functions that I haven’t included):</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px">clickOnExtensionButton(ext: ShowableExtension, show = <span style="color: blue">true</span>): Promise&lt;any&gt; {</p> <p style="margin: 0px">&nbsp; <span style="color: blue">return</span> <span style="color: blue">new</span> Promise((resolve, reject) =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> loc = ext.buttonLocation;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.moveCursor(loc.x, loc.y).then(() =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext.hoverOverButton(<span style="color: blue">true</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext.showTooltip(<span style="color: blue">true</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(() =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext.showTooltip(<span style="color: blue">false</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }, <span style="color: blue">this</span>._pauseToHighlight * 2);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.pause(<span style="color: blue">this</span>._pauseToHighlight)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (show) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext.show();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <span style="color: blue">else</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext.hide();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext.setButtonActive(show);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.pause(<span style="color: blue">this</span>._pauseToHighlight)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext.hoverOverButton(<span style="color: blue">false</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; resolve();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; });</p> <p style="margin: 0px">&nbsp; });</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Each extension can also register “interesting locations”, where the cursor should also visit during the demo. These locations aren’t just the points on the screen to which the cursor should travel, but the actions that need to be performed both when the cursor hovers over the location and when it “clicks” on it.</p> <p>I won’t go into the specifics of how this was implemented, but here’s the overall flow of the demo. This below TypeScript code should give a good idea of the sequence of operations and how composable/editable the demo becomes.</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px">performDemo(): Promise&lt;any&gt; {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">return</span> <span style="color: blue">new</span> Promise&lt;any&gt;((resolve, reject) =&gt; {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> nodes = <span style="color: blue">this</span>._dataModel.sensorNodes;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> info = nodes.map(node =&gt; <span style="color: blue">this</span>._dataModel.getSensorInfo(node));</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> connected = info.filter(inf =&gt; inf.isInDB);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> ids = connected.map&lt;[string, number, THREE.Vector3]&gt;(inf =&gt; [inf.id, inf.nodeid, inf.location]);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> random = <span style="color: blue">this</span>.nRandomElements(ids, 5);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Start by clicking on the sensor list and sensor dots extension buttons,</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// along with the "interesting locations" for the sensor list (in our case</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// this means the "hide unconnected" button)</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> fewer: [string, number, THREE.Vector3][];</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; Promise.resolve().then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.resetDemo() <span style="color: green">// Reset some things to make the next iteration cleaner</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionLocations(<span style="color: blue">this</span>._bcrumbsExt, 1) <span style="color: green">// Click on the first breadcrumb location</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._senListExt)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._senDotExt)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionLocations(<span style="color: blue">this</span>._senListExt)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fewer = random.filter(id =&gt; <span style="color: blue">this</span>.isPointBehindUIPanel(<span style="color: blue">this</span>.getSensorLocation(id[1], id[2]))) <span style="color: green">// Filter any points that will be behind UI elements</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.hoverOverSensorsClickOnLast(fewer) <span style="color: green">// Hover over a random sampling of connected sensors</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._senListExt, <span style="color: blue">false</span>) <span style="color: green">// Close the sensor list</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._dashExt) <span style="color: green">// Launch the dashboard</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnLocations(<span style="color: blue">this</span>.nRandomElements(<span style="color: blue">this</span>._dashExt.kioskSensorLocations, 2)) <span style="color: green">// Click on a couple of random dashboard sensors</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._plotExt, <span style="color: blue">false</span>) <span style="color: green">// Close the plots</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnDashboardTab(<span style="color: #a31515">'navigation'</span>) <span style="color: green">// Click on the navigation dashboard tab</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnLocations(<span style="color: blue">this</span>.nRandomElements(<span style="color: blue">this</span>._dashExt.kioskNavLocations, 2)) <span style="color: green">// Click on a couple of random navigation bookmarks</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._dashExt, <span style="color: blue">false</span>) <span style="color: green">// Close the dashboard</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionLocations(<span style="color: blue">this</span>._bcrumbsExt) <span style="color: green">// Click on breadcrumbs</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._senDotExt, <span style="color: blue">false</span>) <span style="color: green">// Turn off sensors</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._textExt) <span style="color: green">// Launch the texture hiding extension</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._surfShadExt) <span style="color: green">// Launch the surface shading</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.pause(<span style="color: blue">this</span>._pauseToHighlight * 4) <span style="color: green">// Pause before resetting</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._surfShadExt, <span style="color: blue">false</span>) <span style="color: green">// Turn off surface shading</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.clickOnExtensionButton(<span style="color: blue">this</span>._textExt, <span style="color: blue">false</span>) <span style="color: green">// Turn off texture hiding</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; ).then(() =&gt;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resolve()</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; );</p> <p style="margin: 0px">&nbsp; });</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Here’s a video of the demo in action. Remember: this is a recording of the browser but the only manual UI event was when I clicked on the button to launch “Kiosk mode”. The rest is the browser scripting (and simulating) various operations.</p> <p>&nbsp;</p> <p align="center"><iframe height="281" src="https://www.youtube-nocookie.com/embed/FcFJLvldOm4?rel=0&amp;showinfo=0?ecver=1" frameborder="0" width="500" allowfullscreen></iframe></p> <p align="center">&nbsp;</p> <p>What’s nice is that a number of the operations have random elements. This means the demo can repeat but will have different results each time (irrespective of whether new sensor data has been received).</p> <p>In the next post we’ll take a look at the approach taken to make the loop repeat endlessly, stopping only when the mouse is moved.</p></p>
