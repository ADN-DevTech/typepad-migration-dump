---
layout: "post"
title: "Preventing an AutoCAD block from being exploded using .NET"
date: "2008-08-18 22:14:35"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Blocks"
  - "Notification / Events"
original_url: "https://www.keanw.com/2008/08/preventing-an-a.html "
typepad_basename: "preventing-an-a"
typepad_status: "Publish"
---

<p>In response to <a href="http://through-the-interface.typepad.com/through_the_interface/2008/08/anchoring-autoc.html">these recent</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2008/08/rolling-back-th.html">posts</a>, I received a comment from Nick:</p>  <blockquote>   <p><em>By any chance would it be possible to provide an example to prevent a user from using the EXPLODE command for a given block name?</em></p> </blockquote>  <p>I delved into the ADN knowledgebase and came across <a href="http://adn.autodesk.com/adn/servlet/devnote?siteID=4814862&amp;id=5411957&amp;linkID=4900509">this helpful ObjectARX DevNote</a>, which I used to create a .NET module to address the above question.</p>  <p>Here's the C# code, which should contain enough comments to make it self-explanatory:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="font-size: 8pt; margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <br />    <p style="font-size: 8pt; margin: 0px"><span style="color: blue">namespace</span> ExplosionPrevention</p>    <p style="font-size: 8pt; margin: 0px">{</p>    <p style="font-size: 8pt; margin: 0px">&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Commands</span></p>    <p style="font-size: 8pt; margin: 0px">&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">Document</span> _doc;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">Database</span> _db;</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">ObjectIdCollection</span> _blkDefs =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">ObjectIdCollection</span>();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">ObjectIdCollection</span> _blkRefs =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">ObjectIdCollection</span>();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">ObjectIdCollection</span> _blkConts =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">ObjectIdCollection</span>();</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">bool</span> _handlers = <span style="color: blue">false</span>;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">bool</span> _exploding = <span style="color: blue">false</span>;</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;STOPEX&quot;</span>)]</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> StopBlockFromExploding()</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; _doc =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; _db = _doc.Database;</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!_handlers)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; AddEventHandlers();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _handlers = <span style="color: blue">true</span>;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Get the name of the block to protect</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PromptStringOptions</span> pso =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">PromptStringOptions</span>(</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;\nEnter block name: &quot;</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; pso.AllowSpaces = <span style="color: blue">false</span>;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PromptResult</span> pr =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _doc.Editor.GetString(pso);</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (pr.Status != <span style="color: #2b91af">PromptStatus</span>.OK)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Transaction</span> tr =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _db.TransactionManager.StartTransaction();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (tr)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Make sure the block definition exists</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">BlockTable</span> bt =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">BlockTable</span>)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetObject(</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _db.BlockTableId,</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">OpenMode</span>.ForRead</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (bt.Has(pr.StringResult))</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Collect information about the block...</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// 1. the block definition</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">ObjectId</span> blkId =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bt[pr.StringResult];</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _blkDefs.Add(blkId);</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">BlockTableRecord</span> btr =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">BlockTableRecord</span>)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetObject(</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; blkId,</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">OpenMode</span>.ForRead</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// 2. the block's contents</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">ObjectId</span> id <span style="color: blue">in</span> btr)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _blkConts.Add(id);</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// 3. the block's references</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">ObjectIdCollection</span> blkRefs =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; btr.GetBlockReferenceIds(<span style="color: blue">true</span>, <span style="color: blue">true</span>);</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">ObjectId</span> id <span style="color: blue">in</span> blkRefs)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _blkRefs.Add(id);</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; }</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> AddEventHandlers()</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// When a block reference is added, we need to</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// check whether it's for a block we care about</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// and add it to the list, if so</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; _db.ObjectAppended +=</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">delegate</span>(<span style="color: blue">object</span> sender, <span style="color: #2b91af">ObjectEventArgs</span> e)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">BlockReference</span> br =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.DBObject <span style="color: blue">as</span> <span style="color: #2b91af">BlockReference</span>;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (br != <span style="color: blue">null</span>)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_blkDefs.Contains(br.BlockTableRecord))</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _blkRefs.Add(br.ObjectId);</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Conversely we need to remove block references</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// that as they're erased</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; _db.ObjectErased +=</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">delegate</span>(<span style="color: blue">object</span> sender, <span style="color: #2b91af">ObjectErasedEventArgs</span> e)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// This is called during as part of the cloning </span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// process, so let's check that's not happening</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!_exploding)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">BlockReference</span> br =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.DBObject <span style="color: blue">as</span> <span style="color: #2b91af">BlockReference</span>;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (br != <span style="color: blue">null</span>)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// If we're erasing, remove this block</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// reference from the list, otherwise if</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// we're unerasing we will want to add it</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// back in</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (e.Erased)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_blkRefs.Contains(br.ObjectId))</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _blkRefs.Remove(br.ObjectId);</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_blkDefs.Contains(br.BlockTableRecord))</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _blkRefs.Add(br.ObjectId);</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// This is where we fool AutoCAD into thinking the</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// block contents have already been cloned</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; _db.BeginDeepClone +=</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">delegate</span>(<span style="color: blue">object</span> sender, <span style="color: #2b91af">IdMappingEventArgs</span> e)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Only for the explode context</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (e.IdMapping.DeepCloneContext !=</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">DeepCloneType</span>.Explode)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We add IDs to the map to stop the</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// block contents from being cloned</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">ObjectId</span> id <span style="color: blue">in</span> _blkConts)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.IdMapping.Add(</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">IdPair</span>(id, id, <span style="color: blue">true</span>, <span style="color: blue">true</span>, <span style="color: blue">true</span>)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// And this is where we remove the mapping entries</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; _db.BeginDeepCloneTranslation +=</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">delegate</span>(<span style="color: blue">object</span> sender, <span style="color: #2b91af">IdMappingEventArgs</span> e)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Only for the explode context</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (e.IdMapping.DeepCloneContext !=</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">DeepCloneType</span>.Explode)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Set the flag for our CommandEnded handler</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _exploding = <span style="color: blue">true</span>;</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Remove the entries we added on BeginDeepClone</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">ObjectId</span> id <span style="color: blue">in</span> _blkConts)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.IdMapping.Delete(id);</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// As the command ends we unerase the block references</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160; _doc.CommandEnded +=</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">delegate</span>(<span style="color: blue">object</span> sender, <span style="color: #2b91af">CommandEventArgs</span> e)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (e.GlobalCommandName == <span style="color: #a31515">&quot;EXPLODE&quot;</span> &amp;&amp; _exploding)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// By this point the block contents should not have</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// been cloned, but the blocks have been erased</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Transaction</span> tr =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _db.TransactionManager.StartTransaction();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (tr)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// So we need to unerase each of the erased</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// block references</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">ObjectId</span> id <span style="color: blue">in</span> _blkRefs)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">DBObject</span> obj =</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetObject(</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; id,</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">OpenMode</span>.ForRead,</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">true</span></p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Only unerase it if it's needed</span></p>    <br />    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (obj.IsErased)</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.UpgradeOpen();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.Erase(<span style="color: blue">false</span>);</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _exploding = <span style="color: blue">false</span>;</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <p style="font-size: 8pt; margin: 0px">&#160;&#160;&#160; }</p>    <p style="font-size: 8pt; margin: 0px">&#160; }</p>    <p style="font-size: 8pt; margin: 0px">}</p> </div>  <p>The STOPEX command takes a block name and then gathers (and stores) information about a block: its ObjectId, the IDs of its contents and its various block references. I've added some logic to handle creation of new block references (e.g. via INSERT), and erasure of ones that are no longer needed. I haven't put anything in to deal with redefinition of blocks (if the contents of blocks change then explosion may not be prevented properly), but this is left as an exercise for the reader.</p>  <p>Let's define and insert a series of three blocks: LINES, ARCS and CIRCLES (no prizes for guessing which is which :-):</p>  <p><a href="http://through-the-interface.typepad.com/through_the_interface/WindowsLiveWriter/Inserted%20blocks.png"><img style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-top-width: 0px" border="0" alt="Inserted blocks" src="/assets/Inserted%20blocks_thumb.png" width="472" height="232" /></a> </p>  <p>Now we run the STOPEX command on the LINES and CIRCLES blocks:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="font-size: 8pt; margin: 0px">Command: <span style="color: #ff0000">STOPEX</span></p>    <p style="font-size: 8pt; margin: 0px">Enter block name: <span style="color: #ff0000">circles</span></p>    <p style="font-size: 8pt; margin: 0px">Command: <span style="color: #ff0000">STOPEX</span></p>    <p style="font-size: 8pt; margin: 0px">Enter block name: <span style="color: #ff0000">lines</span></p>    <p style="font-size: 8pt; margin: 0px">Command: <span style="color: #ff0000">EXPLODE</span></p>    <p style="font-size: 8pt; margin: 0px">Select objects: <span style="color: #ff0000">all</span></p>    <p style="font-size: 8pt; margin: 0px">9 found</p>    <p style="font-size: 8pt; margin: 0px">Select objects:</p>    <p style="font-size: 8pt; margin: 0px">Command: Specify opposite corner:</p> </div>  <p>Selecting the &quot;exploded&quot; blocks, we see that only the ARCS blocks have actually been exploded:</p>  <p><a href="http://through-the-interface.typepad.com/through_the_interface/WindowsLiveWriter/Exploded%20blocks.png"><img style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-top-width: 0px" border="0" alt="Exploded blocks" src="/assets/Exploded%20blocks_thumb.png" width="472" height="228" /></a></p>  <p><strong><em></em></strong></p>  <p><strong><em>Update:</em></strong></p>  <p>There’s a simpler – although user-controllable – way to achieve this shown in <a href="http://through-the-interface.typepad.com/through_the_interface/2015/06/preventing-an-autocad-block-from-being-exploded-using-net-redux.html" target="_blank">this more recent post</a>.</p>
