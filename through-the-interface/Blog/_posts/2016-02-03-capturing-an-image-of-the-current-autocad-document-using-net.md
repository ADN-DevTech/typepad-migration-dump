---
layout: "post"
title: "Capturing an image of the current AutoCAD document using .NET"
date: "2016-02-03 18:26:15"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Documents"
  - "Graphics system"
original_url: "https://www.keanw.com/2016/02/capturing-an-image-of-the-current-autocad-document-using-net.html "
typepad_basename: "capturing-an-image-of-the-current-autocad-document-using-net"
typepad_status: "Publish"
---

<p>This is a topic that has been addressed a few times on this blog, whether by posts that use the 3D graphics system to <a href="http://through-the-interface.typepad.com/through_the_interface/2009/09/taking-screenshots-of-autocads-main-and-drawing-windows-using-net.html" target="_blank">capture</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2009/09/taking-a-screenshot-of-a-user-selected-portion-of-a-drawing-using-net.html" target="_blank">screenshots</a> or the series of <a href="http://through-the-interface.typepad.com/through_the_interface/2009/09/taking-a-screenshot-of-a-user-selected-portion-of-a-drawing-using-net.html">posts</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2009/09/taking-screenshots-of-autocads-main-and-drawing-windows-using-net.html">regarding</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2009/10/design-choices-for-the-next-plugin-of-the-month.html">the</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2009/10/design-iteration-1-of-screenshot-novembers-plugin-of-the-month.html">Screenshot</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2009/10/design-iteration-2-of-screenshot-novembers-plugin-of-the-month.html">Plugin</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2009/10/design-iteration-3-of-screenshot-novembers-plugin-of-the-month.html">of</a>&nbsp;<a href="http://through-the-interface.typepad.com/through_the_interface/2009/11/novembers-plugin-of-the-month-screenshot.html" target="_blank">the</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2009/11/updated-version-of-screenshot-now-available.html" target="_blank">Month</a> from a few years ago. I thought it worth revisiting, though, as I noticed an API that I hadn’t used before and decided to put it through its paces.</p> <p>The API is a simple one – Document.CapturePreviewImage() – and it’s been covered before <a href="http://adndevblog.typepad.com/autocad/2013/07/capturepreviewimage-api-to-create-the-image-from-a-autocad-document.html" target="_blank">on the AutoCAD DevBlog</a>. But I thought I’d take some file-selection code from the Screenshot app and see whether it was possible to create a full-size screenshot of the current drawing window using it.</p> <p>Here’s the C# implementation of a CPI command that uses the API to save a “preview” image that’s the same exact size as the document window.</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p> <p style="margin: 0px"><span style="color: blue">using</span> System;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Drawing.Imaging;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.IO;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">namespace</span> ListApplications</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">class</span> <span style="color: #2b91af">Extensions</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Return the image format to use for a particular filename</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: #2b91af">ImageFormat</span> GetFormat(<span style="color: blue">this</span> <span style="color: blue">string</span> filename)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// If all else fails, let's create a PNG</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// (might also choose to throw an exception)</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> imf = <span style="color: #2b91af">ImageFormat</span>.Png;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (filename.Contains(<span style="color: #a31515">"."</span>))</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Get the filename's extension (what follows the last ".")</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span> ext = filename.Substring(filename.LastIndexOf(<span style="color: #a31515">"."</span>) + 1);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Get the first three characters of the extension</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (ext.Length &gt; 3)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ext = ext.Substring(0, 3);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Choose the format based on the extension (in lowercase)</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">switch</span> (ext.ToLower())</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">case</span> <span style="color: #a31515">"bmp"</span>:</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imf = <span style="color: #2b91af">ImageFormat</span>.Bmp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">break</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">case</span> <span style="color: #a31515">"gif"</span>:</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imf = <span style="color: #2b91af">ImageFormat</span>.Gif;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">break</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">case</span> <span style="color: #a31515">"jpg"</span>:</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imf = <span style="color: #2b91af">ImageFormat</span>.Jpeg;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">break</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">case</span> <span style="color: #a31515">"tif"</span>:</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imf = <span style="color: #2b91af">ImageFormat</span>.Tiff;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">break</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">case</span> <span style="color: #a31515">"wmf"</span>:</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imf = <span style="color: #2b91af">ImageFormat</span>.Wmf;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">break</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">default</span>:</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imf = <span style="color: #2b91af">ImageFormat</span>.Png;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">break</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> imf;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Commands</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">"CPI"</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">static</span> <span style="color: blue">public</span> <span style="color: blue">void</span> CreatePreviewImage()</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>) <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> ed = doc.Editor;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Select the filename and type for our output image</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> pofo = <span style="color: blue">new</span> <span style="color: #2b91af">PromptSaveFileOptions</span>(<span style="color: #a31515">"\nSelect image location"</span>);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pofo.Filter =</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #a31515">"Bitmap (*.bmp)|*.bmp|GIF (*.gif)|*.gif|JPEG (*.jpg)|*.jpg|"</span> +</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #a31515">"PNG (*.png)|*.png|TIFF (*.tif)|*.tif"</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Set the default save location to be that of the current drawing</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span> fn = doc.Database.Filename;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (fn.Contains(<span style="color: #a31515">"."</span>))</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">int</span> extIdx = fn.LastIndexOf(<span style="color: #a31515">"."</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (fn.Substring(extIdx + 1) != <span style="color: #a31515">"dwt"</span> &amp;&amp; fn.Contains(<span style="color: #a31515">"\\"</span>))</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pofo.InitialDirectory = <span style="color: #2b91af">Path</span>.GetDirectoryName(doc.Database.Filename);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> pfnr = ed.GetFileNameForSave(pofo);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (pfnr.Status != <span style="color: #2b91af">PromptStatus</span>.OK)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> outFile = pfnr.StringResult;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Get the size of the document and capture the preview at that size</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> size = doc.Window.DeviceIndependentSize;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> bmp =</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; doc.CapturePreviewImage(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Convert</span>.ToUInt32(size.Width), <span style="color: #2b91af">Convert</span>.ToUInt32(size.Height)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Save the file with the format derived from the filename</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bmp.Save(outFile, outFile.GetFormat());</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Here’s a sample drawing we’ll run the command against:</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb08b56fed970d-pi" target="_blank"><img title="A drawing to be screenshotted" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 30px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="A drawing to be screenshotted" src="/assets/image_183916.jpg" width="504" height="409"></a></p> <p>And here’s the output of the command:</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb08b56ff5970d-pi" target="_blank"><img title="A full-size screenshot of the drawing" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 30px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="A full-size screenshot of the drawing" src="/assets/image_612490.jpg" width="504" height="277"></a></p>
