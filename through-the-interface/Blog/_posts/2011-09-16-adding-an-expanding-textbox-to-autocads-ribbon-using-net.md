---
layout: "post"
title: "Adding an expanding textbox to AutoCAD&rsquo;s ribbon using .NET"
date: "2011-09-16 05:29:00"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Notification / Events"
  - "User interface"
  - "WPF"
original_url: "https://www.keanw.com/2011/09/adding-an-expanding-textbox-to-autocads-ribbon-using-net.html "
typepad_basename: "adding-an-expanding-textbox-to-autocads-ribbon-using-net"
typepad_status: "Publish"
---

<p>In <a href="http://through-the-interface.typepad.com/through_the_interface/2011/09/adding-a-textbox-to-autocads-ribbon-using-net.html" target="_blank">the last post</a>, we saw a great little sample for adding a textbox to AutoCAD’s ribbon which notifies your application of the “commands” entered into it (however you choose to interpret them in your code).</p>
<p>In this post, we’ll take that further and have that textbox expand vertically as text gets entered, wrapping the contents across multiple lines (only breaking the text at the ends of words, too).</p>
<p>Here’s the updated C# code, with modified lines in red. You can get <a href="http://through-the-interface.typepad.com/files/ribbon-textbox-expanding.cs" target="_blank">the original file here</a>.</p>
<div style="font-family: Courier New; font-size: 8pt; color: black; background: white;">
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;1</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.ApplicationServices;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;2</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.EditorInput;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;3</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.Runtime;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;4</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.Windows;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;&#0160;&#0160;5</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System.Windows.Media;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;6</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System.Windows.Controls;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;7</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System.Windows.Input;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;8</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System.Windows;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;&#0160;9</span>&#0160;<span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;10</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;11</span>&#0160;<span style="color: blue; line-height: 140%;">namespace</span><span style="line-height: 140%;"> NotifyingRibbonTextbox</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;12</span>&#0160;<span style="line-height: 140%;">{</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;13</span>&#0160;<span style="line-height: 140%;">&#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">class</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">Commands</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;14</span>&#0160;<span style="line-height: 140%;">&#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;15</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> _added = </span><span style="color: blue; line-height: 140%;">false</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;16</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;17</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; [</span><span style="color: #2b91af; line-height: 140%;">CommandMethod</span><span style="line-height: 140%;">(</span><span style="color: #a31515; line-height: 140%;">&quot;RTB&quot;</span><span style="line-height: 140%;">)]</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;18</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> RibbonTextBox()</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;19</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;20</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (!_added)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;21</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;22</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Look for the standard &quot;Plug-ins&quot; tab</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;23</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;24</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">RibbonControl</span><span style="line-height: 140%;"> rc = </span><span style="color: #2b91af; line-height: 140%;">ComponentManager</span><span style="line-height: 140%;">.Ribbon;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;25</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">RibbonTab</span><span style="line-height: 140%;"> rt = </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;26</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;27</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">foreach</span><span style="line-height: 140%;"> (</span><span style="color: #2b91af; line-height: 140%;">RibbonTab</span><span style="line-height: 140%;"> tab </span><span style="color: blue; line-height: 140%;">in</span><span style="line-height: 140%;"> rc.Tabs)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;28</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;29</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (tab.AutomationName == </span><span style="color: #a31515; line-height: 140%;">&quot;Plug-ins&quot;</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;30</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;31</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; rt = tab;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;32</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">break</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;33</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;34</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;35</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;36</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// If we didn&#39;t find it, create a custom tab</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;37</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;38</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (rt == </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;39</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;40</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; rt = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">RibbonTab</span><span style="line-height: 140%;">();</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;41</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; rt.Title = </span><span style="color: #a31515; line-height: 140%;">&quot;Custom&quot;</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;42</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; rt.Id = </span><span style="color: #a31515; line-height: 140%;">&quot;ID_CUSTOMRIBBONTAB&quot;</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;43</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; rc.Tabs.Add(rt);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;44</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;45</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;46</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Create our custom panel, add it to the ribbon tab</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;47</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;48</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">RibbonPanelSource</span><span style="line-height: 140%;"> rps = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">RibbonPanelSource</span><span style="line-height: 140%;">();</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;49</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; rps.Title = </span><span style="color: #a31515; line-height: 140%;">&quot;Notifying Textbox&quot;</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;50</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">RibbonPanel</span><span style="line-height: 140%;"> rp = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">RibbonPanel</span><span style="line-height: 140%;">();</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;51</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; rp.Source = rps;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;52</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; rt.Panels.Add(rp);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;53</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;54</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Create our custom textbox, add it to the panel</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;55</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;&#0160;56</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">NotifyingTextBox</span><span style="line-height: 140%;"> tb =</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;&#0160;57</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">NotifyingTextBox</span><span style="line-height: 140%;">(150, 15, 17, 5);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;58</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; tb.IsEmptyTextValid = </span><span style="color: blue; line-height: 140%;">false</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;59</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; tb.AcceptTextOnLostFocus = </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;60</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; tb.InvokesCommand = </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;61</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; tb.CommandHandler = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">TextboxCommandHandler</span><span style="line-height: 140%;">();</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;62</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; rps.Items.Add(tb);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;63</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;64</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Set our tab to be active</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;65</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;66</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; rt.IsActive = </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;67</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;68</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// We only want to add it once, so set a flag</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;69</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;70</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; _added = </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;71</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;72</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;73</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;74</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> Print(</span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> s)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;75</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;76</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// A simple helper to write to the command-line</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;77</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;78</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">Document</span><span style="line-height: 140%;"> doc =</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;79</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; Autodesk.AutoCAD.ApplicationServices.</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;80</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">Application</span><span style="line-height: 140%;">.DocumentManager.MdiActiveDocument;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;81</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; doc.Editor.WriteMessage(s);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;82</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;83</span>&#0160;<span style="line-height: 140%;">&#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;84</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;85</span>&#0160;<span style="line-height: 140%;">&#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">class</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">TextboxCommandHandler</span><span style="line-height: 140%;"> : </span><span style="color: #2b91af; line-height: 140%;">ICommand</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;86</span>&#0160;<span style="line-height: 140%;">&#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;87</span>&#0160;<span style="color: blue; line-height: 140%;">#pragma</span><span style="line-height: 140%;"> warning disable 67</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;88</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">event</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">EventHandler</span><span style="line-height: 140%;"> CanExecuteChanged;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;89</span>&#0160;<span style="color: blue; line-height: 140%;">#pragma</span><span style="line-height: 140%;"> warning restore 67</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;90</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;91</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> CanExecute(</span><span style="color: blue; line-height: 140%;">object</span><span style="line-height: 140%;"> parameter)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;92</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;93</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Yes, we can execute</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;94</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;95</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">return</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;96</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;97</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;98</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> Execute(</span><span style="color: blue; line-height: 140%;">object</span><span style="line-height: 140%;"> parameter)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;&#0160;99</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;100</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Dump the textbox contents to the command-line</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;101</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;102</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">NotifyingTextBox</span><span style="line-height: 140%;"> tb = parameter </span><span style="color: blue; line-height: 140%;">as</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">NotifyingTextBox</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;103</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (tb != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;104</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;105</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">Commands</span><span style="line-height: 140%;">.Print(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;106</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: #a31515; line-height: 140%;">&quot;\nRibbon Textbox: &quot;</span><span style="line-height: 140%;"> +</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;107</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; tb.GetTextWithoutNewlines() + </span><span style="color: #a31515; line-height: 140%;">&quot;\n&quot;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;108</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; );</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;109</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; tb.ClearText();</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;110</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;111</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;112</span>&#0160;<span style="line-height: 140%;">&#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;113</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;114</span>&#0160;<span style="line-height: 140%;">&#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">class</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">NotifyingTextBox</span><span style="line-height: 140%;"> : </span><span style="color: #2b91af; line-height: 140%;">RibbonTextBox</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;115</span>&#0160;<span style="line-height: 140%;">&#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;116</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> _baseHeight;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;117</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> _baseWidth;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;118</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> _heightPadding;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;119</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> _widthPadding;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;120</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> _textChanging = </span><span style="color: blue; line-height: 140%;">false</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;121</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;122</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> NotifyingTextBox(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;123</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> width, </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> height,</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;124</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> widthPadding,</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;125</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">double</span><span style="line-height: 140%;"> heightPadding</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;126</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; )</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;127</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;128</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Set some member variables, some of which</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;129</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// we also use to set the TextBox dimensions</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;130</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;131</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; _baseWidth = width;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;132</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; _baseHeight = height;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;133</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; _widthPadding = widthPadding;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;134</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; _heightPadding = heightPadding;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;135</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;136</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; Width = width;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;137</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; Height = height;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;138</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; MinWidth = width;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;139</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;140</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Register our focus-related event handlers</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;141</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;142</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">EventManager</span><span style="line-height: 140%;">.RegisterClassHandler(</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;143</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">typeof</span><span style="line-height: 140%;">(</span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">), </span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">.GotKeyboardFocusEvent,</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;144</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">RoutedEventHandler</span><span style="line-height: 140%;">(OnGotFocus)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;145</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; );</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;146</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;147</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">EventManager</span><span style="line-height: 140%;">.RegisterClassHandler(</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;148</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">typeof</span><span style="line-height: 140%;">(</span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">), </span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">.LostKeyboardFocusEvent,</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;149</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">RoutedEventHandler</span><span style="line-height: 140%;">(OnLostFocus)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;150</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; );</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;151</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;152</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// And out additional TextChanged event handler</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;153</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;154</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">EventManager</span><span style="line-height: 140%;">.RegisterClassHandler(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;155</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">typeof</span><span style="line-height: 140%;">(</span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">), </span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">.TextChangedEvent,</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;156</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">RoutedEventHandler</span><span style="line-height: 140%;">(OnTextChanged)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;157</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; );</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;158</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;159</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;160</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> GetTextWithoutNewlines()</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;161</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;162</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Return the contained text without newline characters</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;163</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;164</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">return</span><span style="line-height: 140%;"> TextValue.ReplaceNewlinesWithSpaces();</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;165</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;166</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;167</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> ClearText()</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;168</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;169</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; TextValue = </span><span style="color: #a31515; line-height: 140%;">&quot;&quot;</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;170</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;171</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;172</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">private</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> OnTextChanged(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;173</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">object</span><span style="line-height: 140%;"> sender, </span><span style="color: #2b91af; line-height: 140%;">RoutedEventArgs</span><span style="line-height: 140%;"> e</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;174</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; )</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;175</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;176</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (!_textChanging &amp;&amp; e != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;"> &amp;&amp; e.Source != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;177</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;178</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;"> tb = e.Source </span><span style="color: blue; line-height: 140%;">as</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;179</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;180</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (tb != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;181</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;182</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// We need the typeface to calculate the text width</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;183</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;184</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">var</span><span style="line-height: 140%;"> faces = tb.FontFamily.GetTypefaces();</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;185</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">Typeface</span><span style="line-height: 140%;"> face = </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;186</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">foreach</span><span style="line-height: 140%;"> (</span><span style="color: #2b91af; line-height: 140%;">Typeface</span><span style="line-height: 140%;"> tf </span><span style="color: blue; line-height: 140%;">in</span><span style="line-height: 140%;"> faces)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;187</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;188</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (tf != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;189</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;190</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; face = tf;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;191</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">break</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;192</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;193</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;194</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;195</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Get the last line of text, to see how long it is</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;196</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;197</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> text = tb.Text.GetLastLine();</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;198</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;199</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Calculate the width of this last line of text</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;200</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;201</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">FormattedText</span><span style="line-height: 140%;"> ft =</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;202</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">FormattedText</span><span style="line-height: 140%;">(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;203</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; text,</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;204</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; System.Globalization.</span><span style="color: #2b91af; line-height: 140%;">CultureInfo</span><span style="line-height: 140%;">.CurrentCulture,</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;205</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">FlowDirection</span><span style="line-height: 140%;">.LeftToRight,</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;206</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; face,</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;207</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; tb.FontSize * (96.0 / 72.0),</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;208</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">Brushes</span><span style="line-height: 140%;">.Black</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;209</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; );</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;210</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;211</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// If the width of the last line of text</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;212</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// is over our boundary (the width of the box</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;213</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// minus some padding), then start the next</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;214</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// line</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;215</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;216</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (ft.Width - _widthPadding &gt; _baseWidth)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;217</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;218</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Set our flag to stop re-entry of the event</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;219</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// handler, then replace the last space in the</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;220</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// TextBox contents with a newline</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;221</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;222</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; _textChanging = </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;223</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; tb.Text =</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;224</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; tb.Text.InsertNewlineAtLastSpace();</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;225</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; _textChanging = </span><span style="color: blue; line-height: 140%;">false</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;226</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;227</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Set the cursor to be at the end of our text</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;228</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// so that typing continues properly</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;229</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;230</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; tb.SelectionStart = tb.Text.Length;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;231</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;232</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;233</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Find the number of lines of text</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;234</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;235</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;"> lines = tb.Text.GetLineCount();</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;236</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;237</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Change the height based on the number of lines</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;238</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;239</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; tb.Height = _heightPadding + (lines * _baseHeight);</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;240</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; tb.MinLines = lines;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;241</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;242</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;243</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;244</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;245</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Both events call the same helper, with a custom message</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;246</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;247</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">private</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> OnGotFocus(</span><span style="color: blue; line-height: 140%;">object</span><span style="line-height: 140%;"> sender, </span><span style="color: #2b91af; line-height: 140%;">RoutedEventArgs</span><span style="line-height: 140%;"> e)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;248</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;249</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; OnFocusChange(sender, e, </span><span style="color: #a31515; line-height: 140%;">&quot;\nTextbox got focus :)\n&quot;</span><span style="line-height: 140%;">);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;250</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;251</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;252</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">private</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> OnLostFocus(</span><span style="color: blue; line-height: 140%;">object</span><span style="line-height: 140%;"> sender, </span><span style="color: #2b91af; line-height: 140%;">RoutedEventArgs</span><span style="line-height: 140%;"> e)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;253</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;254</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; OnFocusChange(sender, e, </span><span style="color: #a31515; line-height: 140%;">&quot;\nTextbox lost focus :(\n&quot;</span><span style="line-height: 140%;">);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;255</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;256</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;257</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Our helper function to print&#0160; a message only when</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;258</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: green; line-height: 140%;">// our custom textbox exists</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;259</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;260</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">private</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> OnFocusChange(</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;261</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">object</span><span style="line-height: 140%;"> sender, </span><span style="color: #2b91af; line-height: 140%;">RoutedEventArgs</span><span style="line-height: 140%;"> e, </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> msg</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;262</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; )</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;263</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;264</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (e != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;"> &amp;&amp; e.Source != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;265</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;266</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;"> tb = e.Source </span><span style="color: blue; line-height: 140%;">as</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">TextBox</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;267</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;268</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (tb != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;269</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;270</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">NotifyingTextBox</span><span style="line-height: 140%;"> mtb =</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;271</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; tb.DataContext </span><span style="color: blue; line-height: 140%;">as</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">NotifyingTextBox</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;272</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;273</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (mtb != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;274</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;275</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; </span><span style="color: #2b91af; line-height: 140%;">Commands</span><span style="line-height: 140%;">.Print(msg);</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;276</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;277</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;278</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;279</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;280</span>&#0160;<span style="line-height: 140%;">&#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;281</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;282</span>&#0160;<span style="line-height: 140%;">&#0160; </span><span style="color: green; line-height: 140%;">// String-related extension methods</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;283</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;284</span>&#0160;<span style="line-height: 140%;">&#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">class</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">StringExtensions</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;285</span>&#0160;<span style="line-height: 140%;">&#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;286</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">const</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> newline = </span><span style="color: #a31515; line-height: 140%;">&quot;\r\n&quot;</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;287</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;288</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> InsertNewlineAtLastSpace(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;289</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">this</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> s</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;290</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; )</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;291</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;292</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// If the string contains a space, replace it</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;293</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// with a newline character, otherwise we simply</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;294</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// append the newline to the string</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;295</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;296</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> ret;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;297</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (s.Contains(</span><span style="color: #a31515; line-height: 140%;">&quot; &quot;</span><span style="line-height: 140%;">))</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;298</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;299</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;"> index = s.LastIndexOf(</span><span style="color: #a31515; line-height: 140%;">&quot; &quot;</span><span style="line-height: 140%;">);</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;300</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; ret =</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;301</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; s.Substring(0, index) + newline +</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;302</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; s.Substring(index + 1);</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;303</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;304</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">else</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;305</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;306</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; ret = s + newline;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;307</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;308</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">return</span><span style="line-height: 140%;"> ret;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;309</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;310</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;311</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> ReplaceNewlinesWithSpaces(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;312</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">this</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> s</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;313</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; )</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;314</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;315</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Replace all the newlines with spaces</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;316</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;317</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (</span><span style="color: #2b91af; line-height: 140%;">String</span><span style="line-height: 140%;">.IsNullOrEmpty(s))</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;318</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">return</span><span style="line-height: 140%;"> s;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;319</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">return</span><span style="line-height: 140%;"> s.Replace(newline, </span><span style="color: #a31515; line-height: 140%;">&quot; &quot;</span><span style="line-height: 140%;">);</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;320</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;321</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;322</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> GetLastLine(</span><span style="color: blue; line-height: 140%;">this</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> s)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;323</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;324</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Return the last line of the text (or</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;325</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// the whole thing if there&#39;s no newline in it)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;326</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;327</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> ret;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;328</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (s.Contains(newline))</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;329</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;330</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; ret =</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;331</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; s.Substring(</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;332</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; s.LastIndexOf(newline) + newline.Length</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;333</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; );</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;334</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;335</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">else</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;336</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;337</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; ret = s;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;338</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;339</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">return</span><span style="line-height: 140%;"> ret;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;340</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;341</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;342</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;"> GetLineCount(</span><span style="color: blue; line-height: 140%;">this</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> s)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;343</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; {</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;344</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// Count the number of lines by checking the</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;345</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// overall length of the string against the</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;346</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: green; line-height: 140%;">// string without newline sequences in it</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;347</span>&#0160;</p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;348</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; </span><span style="color: blue; line-height: 140%;">return</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;349</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; (</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;350</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; (s.Length -</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;351</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; s.Replace(newline, </span><span style="color: #a31515; line-height: 140%;">&quot;&quot;</span><span style="line-height: 140%;">).Length)</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;352</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; &#0160; / newline.Length</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;353</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; &#0160; &#0160; ) + 1;</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;354</span>&#0160;<span style="line-height: 140%;">&#0160; &#0160; }</span></p>
<p style="margin: 0px;"><span style="color: red;">&#0160;&#0160;355</span>&#0160;<span style="line-height: 140%;">&#0160; }</span></p>
<p style="margin: 0px;"><span style="color: #2b91af;">&#0160;&#0160;356</span>&#0160;<span style="line-height: 140%;">}</span></p>
</div>
<p>In terms of changes to the code, the main things to note are some additional parameters on the constructor of the NotifyingTextBox class (which control the size and behaviour of the textbox), where we also attach another event handler to be called when the contents of the textbox are modified.</p>
<p>In this event handler, we calculate the width of the last line of text (basically the one being typed), to see whether we need to break the line or not. We use the FormattedText class to do this, which uses the font and its size from the textbox (with some modification to convert the size, as per <a href="http://stackoverflow.com/questions/3444371/converting-between-wpf-font-size-and-standard-font-size" target="_blank">this information</a>). If the line is wider than the width of our textbox – taking into account an additional buffer amount, just to make it work better – we insert a newline at the preceding space, which keeps the entered words intact.</p>
<p>Something to note: we check a flag in the event handler to stop re-entering when we modify the text by inserting the newline. If we didn’t do this we’d soon get ourselves in trouble (trust me on this ;-).</p>
<p>Otherwise, the code itself should be reasonably straightforward. It uses some extension methods on the string class to make life a little easier, but that&#39;s about it.</p>
<p>Putting this updated code through its paces…</p>
<p>Now when we run the RTB command and start to enter text into our textbox, we see it expands as we get to the end of a line:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2015435727e92970c-pi" target="_blank"><img alt="Our textbox now expands" border="0" height="135" src="/assets/image_808891.jpg" style="background-image: none; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; padding-top: 0px; border-width: 0px;" title="Our textbox now expands" width="390" /></a></p>
<p>And it keeps on going:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2014e8b931a83970d-pi" target="_blank"><img alt="And expands" border="0" height="167" src="/assets/image_476110.jpg" style="background-image: none; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; padding-top: 0px; border-width: 0px;" title="And expands" width="390" /></a></p>
<p>When we’ve finished, it echoes the contents – without the additional line-breaks – to the command-line:</p>
<div style="font-family: courier new; background: white; color: black; font-size: 8pt;">
<p style="margin: 0px;"><span style="line-height: 140%;">Textbox got focus :)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">Ribbon Textbox: Let&#39;s now enter a longer string of text, to see what</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">happens when we write and write and write and write and write - we</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">actually see the ribbon starting to stretch, which is pretty cool.</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">Textbox lost focus :(</span></p>
</div>
<p>I didn’t manage to get the ribbon to stretch horizontally: the width seems based on the size of the controls you place on it at startup, so while we can make the textbox stretch horizontally, getting the ribbon panel to accommodate the larger size proved harder (i.e. I couldn’t work out how to do it). Please post a comment if you’ve managed to do this, yourself.</p>
