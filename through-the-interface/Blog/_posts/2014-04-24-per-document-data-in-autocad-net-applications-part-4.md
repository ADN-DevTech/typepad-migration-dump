---
layout: "post"
title: "Per-document data in AutoCAD .NET applications &ndash; Part 4"
date: "2014-04-24 18:16:00"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Documents"
  - "Runtime"
original_url: "https://www.keanw.com/2014/04/per-document-data-in-autocad-net-applications-part-4.html "
typepad_basename: "per-document-data-in-autocad-net-applications-part-4"
typepad_status: "Publish"
---

<p>In <a href="http://through-the-interface.typepad.com/through_the_interface/2014/04/per-document-data-in-autocad-net-applications-part-3.html" target="_blank">yesterday’s post</a>, we looked at a mechanism that has been introduced in AutoCAD 2015 to simplify associating custom data with a Document. In today’s post we’re going to swap out the custom manager class to make use of the standard UserData mechanism, showing how the PerDocumentClass attribute and the UserData property are actually highly complementary.</p>  <p>Here’s the updated C# code:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// The all-important attribute telling AutoCAD to instantiate</span></p>    <p style="margin: 0px"><span style="color: green">// the PerDocData class for each open or new document</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">[<span style="color: blue">assembly</span>: <span style="color: #2b91af">PerDocumentClass</span>(<span style="color: blue">typeof</span>(PerDocSample.<span style="color: #2b91af">PerDocData</span>))]</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> PerDocSample</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#0160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Commands</span></p>    <p style="margin: 0px">&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// A simple command to write the contents of our per-document</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// data to the command-line</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;PPDD&quot;</span>)]</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">void</span> PrintPerDocData()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> perDocData = doc.UserData[<span style="color: #a31515">&quot;TtifData&quot;</span>] <span style="color: blue">as</span> <span style="color: #2b91af">PerDocData</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; doc.Editor.WriteMessage(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; perDocData == <span style="color: blue">null</span> ?</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&quot;\nNo user data found.&quot;</span> :</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; perDocData.OpenDateTime.ToString()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Our per-document data class. This will get instanciated for</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// each existing or new document: we get the creation</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// notification via either the static Create() method or via</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// the public constructor that takes a Document argument</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PerDocData</span></p>    <p style="margin: 0px">&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// We will store the time the document was opened or created</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">private</span> <span style="color: #2b91af">DateTime</span> _openDateTime;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Provide a public read-only property for that</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: #2b91af">DateTime</span> OpenDateTime</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">get</span> { <span style="color: blue">return</span> _openDateTime; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Public constructor taking a Document</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> PerDocData(<span style="color: #2b91af">Document</span> doc)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _openDateTime = <span style="color: #2b91af">DateTime</span>.Now;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; doc.UserData.Add(<span style="color: #a31515">&quot;TtifData&quot;</span>, <span style="color: blue">this</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Static Create method: this is the first approach tried</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// (to differentiate we&#39;re adding an hour to the current</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// time, so it&#39;s clear this method is being called)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: #2b91af">PerDocData</span> Create(<span style="color: #2b91af">Document</span> doc)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> pdd = <span style="color: blue">new</span> <span style="color: #2b91af">PerDocData</span>(doc);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; pdd._openDateTime += <span style="color: #2b91af">TimeSpan</span>.FromHours(1);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> pdd;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p> </div>  <p>You’ll see that we’ve simplified the code quite a bit by using UserData, which is really just a per-document map that associates custom application data with an application ID. As the map disappears when the owning Document gets destroyed we no longer have to worry about removing data from a central map as we did last time. And as mentioned last time, Dispose() will be called on any objects implementing it, simplifying the work needed to clean up after ourselves.</p>  <p>For simplicity’s sake I’ve chosen to hardcode the application ID (“TtifData”) in a couple of places in the above code. It’s clearly better to have this defined centrally, but I’ve left that as an exercise for the user (it’s being used across two separate classes, which complicates things slightly: obvious ways to share the definition would be via a common “utils” class or even to combine the two classes into one containing a single definition of the constant).</p>  <p>The code should work exactly as the code in the last post did: try loading it into AutoCAD and running the PPDD command in a few different documents.</p>  <p>It’s simple and works well: hopefully it’s clear that PerDocumentClass in combination with UserData greatly simplifies the work needed to associate data at a per-document level in AutoCAD.</p>
