---
layout: "post"
title: "Using IronPython with AutoCAD"
date: "2009-03-20 17:00:17"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "AutoLISP / Visual LISP"
  - "Commands"
  - "F#"
  - "IronPython"
  - "Python"
  - "Runtime"
original_url: "https://www.keanw.com/2009/03/using-ironpython-with-autocad.html "
typepad_basename: "using-ironpython-with-autocad"
typepad_status: "Publish"
---

<p>I’ve been meaning to play around with <a href="http://python.org/">the Python language</a> for some<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201156fbedf67970b-pi"><img align="right" alt="Python Logo" border="0" height="75" src="/assets/image_444080.jpg" style="border-bottom: 0px; border-left: 0px; display: inline; margin-left: 0px; border-top: 0px; margin-right: 0px; border-right: 0px" title="Python Logo" width="263" /></a> time, now, and with the recent release of <a href="http://ironpython.codeplex.com/">IronPython</a> 2 it seems a good time to start.</p>  <p><a href="http://www.linuxjournal.com/article/3882">Why Python?</a> A number of people in my team – including <a href="http://blogs.autodesk.com/thebuildingcoder">Jeremy Tammik</a> and the people within our Media&#0160; &amp; Entertainment workgroup who support Python’s use with Maya and MotionBuilder – are fierce proponents of the language. I’m told that it’s an extremely easy, general-purpose, <a href="http://en.wikipedia.org/wiki/Type_system#Dynamic_typing">dynamic</a> programming language. All of which sounds interesting, of course, although I have to admit I’m less convinced of the importance of the dynamic piece: I’ve found a lot of value in static typing over the years (even F# is statically typed, although many people – even some who work with it - don’t realise this… its type inference system allows you to code safely without specifying types all over the place).</p>  <p>Let’s take a quick step back and talk about what makes a language dynamic. The most common example of a dynamic language – one that I’m sure most of you will have touched at some point – is JavaScript. In JavaScript you declare everything as a var, assign it, call methods on it and hope that they work at runtime. I admit that I’ve always disliked developing in JavaScript because of the lack of decent tool support: I’m a big fan of Intellisense (based on an object’s design-time type) and want the compiler to tell me if I’m dealing with an object that doesn’t support a particular method. But perhaps that’s largely what I’ve become used to from modern development tools, and I’m trying to remain open to new things. Really, I am.</p>  <p>Another dynamic language with which I’ve had much more favourable (but still, at times, frustrating) experiences is LISP. But my relationship with LISP is different: like most early AutoCAD programmers I adopted it out of necessity – and at the time I started with it programming environments were, in any case, generally very basic - I then grew to love it and have since never forgotten it, even when more attractive/productive development environments came along. So I’m extremely loathe to paint it with the same brush as the one I’ve used for JavaScript.</p>  <p>Python is also of interest because of its cross-platform availability: it’s an open source language with its roots in the UNIX/Linux world, but is now gaining popularity across a variety of OS platforms (one of the reasons it’s the scripting language chosen for at least one of our cross-platform products, Autodesk Maya).</p>  <p>Microsoft is definitely now very open to the possibilities of dynamic languages: they’re making a significant investment in the <a href="http://en.wikipedia.org/wiki/Dynamic_Language_Runtime">Dynamic Language Runtime</a>, to support languages such as IronPython and IronRuby, as well as adding more dynamic features with C# 4.0 (<a href="http://blogs.msdn.com/charlie/archive/2008/01/25/future-focus.aspx">which is finally going to get something comparable to VB’s “late binding” capability</a>).</p>  <p>So all in all, the world we live in seems to be becoming increasingly dynamic. :-)</p>  <p>Anyway – now on to getting IronPython working with AutoCAD. I had originally hoped to build a .NET assembly directly using IronPython – something that appears to have been enabled with the 2.0 release of IronPython - which could then be loaded into AutoCAD. Unfortunately this was an exercise in frustration: AutoCAD makes heavy use of custom attributes for identifying commands etc., but IronPython doesn’t currently support the use of attributes. It is possible to do some clever stuff by compiling attributed C# on-the-fly and deriving classes from it (information on this is available <a href="http://lists.ironpython.com/pipermail/users-ironpython.com/2007-July/005323.html">here</a>), which will – in theory, at least – get you something in memory that’s attributed but, as AutoCAD scans the physical assembly for custom attributes before loading it, this didn’t help. I also spent a great deal of time just trying to derive a class from Autodesk.AutoCAD.Runtime.IExtensionApplication – to have the Initialize() function called automatically on load – but I just couldn’t get this to work, either.</p>  <p>Then, thankfully, Tim Riley came to the rescue: we’ve been in touch on and off over the years since he started <a href="http://pyacaddotnet.googlecode.com">the PyAcad.NET project</a> to run IronPython code inside AutoCAD, and Tim was able to put together some working code which actually registered commands (after I’d pointed him at a function he could use from AutoCAD 2009’s acmgdinternal.dll – an unsupported assembly that exposes some otherwise quite helpful functions). He ended up choosing an implementation that had also been suggested to me by Albert Szilvasy: to implement a PYLOAD command using C# which allows selection and loading of a Python script (because Python is, ultimately, all about scripting rather than building static, compiled assemblies).</p>  <p>Before we get on to the C# module, I should point out that I installed <a href="http://ironpython.codeplex.com/">IronPython</a> 2.0.1 as well as <a href="http://ironpythonstudio.codeplex.com/">IronPython Studio</a> 1.0 for the Visual Studio 2008 integration. It turns out that as we’re relying on C# to manage the loading of Python – rather than compiling a .NET assembly – the main advantage of IronPython Studio is around the ability to work with Python source code inside Visual Studio.</p>  <p>To build the below C# code into a standard .NET Class Library assembly (a .DLL) you’ll need to add assembly references to IronPython.dll, IronPython.Modules.dll, Microsoft.Scripting.dll and Microsoft.Scripting.Core.dll – all of which can be found in the main IronPython install folder (on my system this is in “C:\Program Files\IronPython 2.0.1”). As well as the standard references to acmgd.dll and acdbmgd.dll, of course.</p>  <p>Here’s the C# code:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> IronPython.Hosting;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Microsoft.Scripting.Hosting;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> PythonLoader</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">CommandsAndFunctions</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;-PYLOAD&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> PythonLoadCmdLine()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; PythonLoad(</span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;PYLOAD&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> PythonLoadUI()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; PythonLoad(</span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> PythonLoad(</span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> useCmdLine)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%"> fd =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.GetSystemVariable(</span><span style="line-height: 140%; color: #a31515">&quot;FILEDIA&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// As the user to select a .py file</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">PromptOpenFileOptions</span><span style="line-height: 140%"> pfo =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptOpenFileOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #a31515">&quot;Select Python script to load&quot;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; pfo.Filter = </span><span style="line-height: 140%; color: #a31515">&quot;Python script (*.py)|*.py&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; pfo.PreferCommandLine =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (useCmdLine || fd == 0);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">PromptFileNameResult</span><span style="line-height: 140%"> pr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.GetFileNameForOpen(pfo);</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// And then try to load and execute it</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status == </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ExecutePythonScript(pr.StringResult);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; [</span><span style="line-height: 140%; color: #2b91af">LispFunction</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;PYLOAD&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%"> PythonLoadLISP(</span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%"> rb)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> RTSTR = 5005;</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (rb == </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.WriteMessage(</span><span style="line-height: 140%; color: #a31515">&quot;\nError: too few arguments\n&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// We&#39;re only really interested in the first argument</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">Array</span><span style="line-height: 140%"> args = rb.AsArray();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%"> tv = (</span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%">)args.GetValue(0);</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// Which should be the filename of our script</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tv != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> &amp;&amp; tv.TypeCode == RTSTR)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// If we manage to execute it, let&#39;s return the</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// filename as the result of the function</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// (just as (arxload) does)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> success =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ExecutePythonScript(</span><span style="line-height: 140%; color: #2b91af">Convert</span><span style="line-height: 140%">.ToString(tv.Value));</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">return</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (success ?</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%">(RTSTR, tv.Value)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; : </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> ExecutePythonScript(</span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> file)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// If the file exists, let&#39;s load and execute it</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// (we could/should probably add some more robust</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green">// exception handling here)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> ret = System.IO.</span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Exists(file);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ret)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af">ScriptEngine</span><span style="line-height: 140%"> engine = </span><span style="line-height: 140%; color: #2b91af">Python</span><span style="line-height: 140%">.CreateEngine();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; engine.ExecuteFile(file);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> ret;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">}</span></p> </div>  <p>The code behind the PYLOAD command is actually really simple. I could have kept it basic but decided it would be a good opportunity to show some best practices. So not only do we have the standard PYLOAD command, which respects the FILEDIA variable to decide whether to use dialogs or the command-line, we also have a command-line version –PYLOAD and a LISP function (pyload). All of which call into the same function to load a Python script.</p>  <p>OK, now let’s take a look at a simple IronPython script that calls into AutoCAD via its .NET API. Thanks again to Tim Riley for providing something that works. Even with Python being (apparently) so easy to learn, I’m such a neophyte that without his help I’d still be stumbling around in the dark.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> clr</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">path = </span><span style="line-height: 140%; color: maroon">&#39;C:\\Program Files\\Autodesk\\AutoCAD 2009\\&#39;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">clr.AddReferenceToFileAndPath(path + </span><span style="line-height: 140%; color: maroon">&#39;acdbmgd.dll&#39;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">clr.AddReferenceToFileAndPath(path + </span><span style="line-height: 140%; color: maroon">&#39;acmgd.dll&#39;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">clr.AddReferenceToFileAndPath(path + </span><span style="line-height: 140%; color: maroon">&#39;acmgdinternal.dll&#39;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Autodesk</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime as ar</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices as aas</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices as ads</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry as ag</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Autodesk.AutoCAD.Internal as ai</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> Autodesk.AutoCAD.Internal </span><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Utils</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: green"># Function to register AutoCAD commands</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: green"># To be used via a function decorator</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> autocad_command(function):</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green"># First query the function name</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; n = function.__name__</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green"># Create the callback and add the command</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; cc = ai.CommandCallback(function)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; Utils.AddCommand(</span><span style="line-height: 140%; color: maroon">&#39;pycmds&#39;</span><span style="line-height: 140%">, n, n, ar.CommandFlags.Modal, cc)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green"># Let&#39;s now write a message to the command-line</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; doc = aas.Application.DocumentManager.MdiActiveDocument</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; ed = doc.Editor</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; ed.WriteMessage(</span><span style="line-height: 140%; color: maroon">&quot;\nRegistered Python command: {0}&quot;</span><span style="line-height: 140%">, n)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: green"># A simple &quot;Hello World!&quot; command</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">@autocad_command</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> msg():</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; doc = aas.Application.DocumentManager.MdiActiveDocument</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; ed = doc.Editor</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; ed.WriteMessage(</span><span style="line-height: 140%; color: maroon">&quot;\nOur test command works!&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: green"># And one to do something a little more complex...</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: green"># Adds a circle to the current space</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">@autocad_command</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> mycir():</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; doc = aas.Application.DocumentManager.MdiActiveDocument</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; db = doc.Database</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; tr = doc.TransactionManager.StartTransaction()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; bt = tr.GetObject(db.BlockTableId, ads.OpenMode.ForRead)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; btr = tr.GetObject(db.CurrentSpaceId, ads.OpenMode.ForWrite)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; cir = ads.Circle(ag.Point3d(10,10,0),ag.Vector3d.ZAxis, 2)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; btr.AppendEntity(cir)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(cir, True)</span></p>    <p style="margin: 0px; font-size: 8pt">&#0160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; tr.Commit()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#0160;&#0160;&#0160; tr.Dispose()</span></p> </div>  <p>As we’re stuck without the ability to use custom attributes in IronPython, we’re making use of the Autodesk.AutoCAD.Internal namespace to register commands at runtime. I don’t like doing this, but at the same time I was left with little choice, unless we choose to find another way to call into the code. Please be warned that anything contained in the Autodesk.AutoCAD.Internal namespace is unsupported functionality, and subject to change without warning.</p>  <p>Now that I have that off my chest, let’s comment a little further on the above code…</p>  <ul>   <li>Even without custom attributes, we have used a pretty cool Python language feature known as <a href="http://avinashv.net/2008/04/python-decorators-syntactic-sugar/">decorators</a> (thanks *again* for the tip, Tim :-) which helps us to mark functions as commands. The autocad_command function is called for each decorated function, and this is where we register a command for the function based on the function’s name. Pretty cool. </li>    <li>You’ll notice a distinct lack of types in the code (and yes, that still scares me). When I was previously trying to compile a DLL based on this code, I had a lot of trouble getting anything at all to fail at compile-time, but clearly a lot would fail at runtime (when I could actually get anything to execute :-S). I feel as though I still need to get my head around this trade-off: I can see the argument for simplicity/elegance/succinctness – and even the power it brings in some situations - but the Computer Scientist in me is screaming for safety/reliability/determinism/debuggability (if that’s even a word). Oh well. The main thing is that I’m starting the journey, at least: we’ll see if it ends up somewhere I like. :-) </li> </ul>  <p>When we build and NETLOAD our PythonLoader C# application and execute the PYLOAD command, we can select our Python script:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">Command: <font color="#ff0000">PYLOAD</font></span></p> </div>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20111690e7331970c-pi"><img alt="File selection during the PYLOAD command" border="0" height="302" src="/assets/image_375228.jpg" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="File selection during the PYLOAD command" width="420" /></a> </p>  <p>Once selected, the script gets loaded and should register a couple of commands:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">Registered Python command: msg</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">Registered Python command: mycir</span></p> </div>  <p>Running the MSG command will execute a simple “Hello World!”-like function, just printing a message to the command-line:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">Command: <font color="#ff0000">MSG</font></span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">Our test command works!</span></p> </div>  <p>And running the MYCIR command should just add a simple circle to the current space in the active drawing.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">Command: <font color="#ff0000">MYCIR</font></span></p> </div>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20111690e733d970c-pi"><img alt="Results of the MYCIR command" border="0" height="270" src="/assets/image_324103.jpg" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Results of the MYCIR command" width="287" /></a> </p>  <p>That’s it for my initial foray into the world of Python. I hope you’ve found this helpful and enjoy playing around with the Python programming language inside AutoCAD. Please do post a comment if you have experiences or anecdotes to share on this topic!</p>
