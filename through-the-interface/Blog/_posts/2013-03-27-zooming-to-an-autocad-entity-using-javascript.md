---
layout: "post"
title: "Zooming to an AutoCAD entity using JavaScript"
date: "2013-03-27 10:30:42"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "JavaScript"
  - "JSON"
original_url: "https://www.keanw.com/2013/03/zooming-to-an-autocad-entity-using-javascript.html "
typepad_basename: "zooming-to-an-autocad-entity-using-javascript"
typepad_status: "Publish"
---

<p>As promised in <a href="http://through-the-interface.typepad.com/through_the_interface/2013/03/autocad-2014-for-developers.html" target="_blank">yesterday’s post</a>, here’s my first attempt at writing a simple JavaScript app for AutoCAD. This app is purely JavaScript – no HTML to be seen, anywhere – and implements a command inside AutoCAD that will zoom to the extents of an entity selected by the user.</p>  <p>Let’s start by looking at the source code, which has been posted <a href="http://through-the-interface.typepad.com/files/ZoomEntity.js" target="_blank">here</a>.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Command to zoom to the extents of a selected entity</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> zoomEntity() {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">try</span><span style="line-height: 140%"> {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Set the options for our user prompt</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> peo = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.PromptEntityOptions();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; peo.setMessageAndKeywords(</span><span style="line-height: 140%; color: maroon">&quot;\nSelect an entity&quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: maroon">&quot;&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; peo.allowObjectOnLockedLayer = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Ask the user to select an entity</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Acad.Editor.getEntity(peo).then(onComplete, onError);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">catch</span><span style="line-height: 140%">(e) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; write(e.message);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onComplete(jsonPromptResult) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">try</span><span style="line-height: 140%"> {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Parse the JSON string containing the prompt result</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> resultObj = JSON.parse(jsonPromptResult);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (resultObj &amp;&amp; resultObj.status == 5100) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// If it was successful, get the selected entity...</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> entity = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.DBEntity(resultObj.objectId);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// ... and its extents</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ext = entity.getExtents();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Zoom to the object's extents, choosing to animate the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// view transition (if possible to do so)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Acad.Editor.CurrentViewport.zoomExtents(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ext.minPoint3d, ext.maxPoint3d, </span><span style="line-height: 140%; color: blue">true</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">catch</span><span style="line-height: 140%">(e) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; write(e.message);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onError(jsonPromptResult) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; write(</span><span style="line-height: 140%; color: maroon">&quot;\nProblem encountered.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Add the command, we'll make it transparent</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">Acad.Editor.addCommand(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;ZOOM_CMDS&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;ZEN&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;ZEN&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Acad.CommandFlag.TRANSPARENT,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; zoomEntity</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">write(</span><span style="line-height: 140%; color: maroon">&quot;\nRegistered ZEN command.\n&quot;</span><span style="line-height: 140%">);</span></p> </div>  <p>A few things to note about this code:</p>  <ul>   <li>There are some things that are very familiar about it (e.g. the PromptEntityOptions class). Wherever possible we’ve tried to extend the “AutoCAD Object Model” you’ve become familiar with via .NET to the world of JavaScript.</li>    <ul>     <li>This should help reduce the <a href="http://en.wikipedia.org/wiki/Cognitive_dissonance" target="_blank">cognitive dissonance</a> when working with the new API. </li>   </ul>    <li>The selection method – getEntity() – returns a PromptEntityResult (again, familiar from the world of .NET), but in JavaScript this class implements <a href="http://wiki.commonjs.org/wiki/Promises/A" target="_blank">the Promise pattern</a>. Which means it implements the then() method to which you can pass callbacks that will get called depending on the results of the selection event.       <ul>       <li>This approach of “continuation passing” is very common inside JavaScript and takes some getting used to. C# has the fantastic async/await capability that asks the compiler to care of the messiness that comes with asynchronous callbacks (they’re there, just not in your source code), but I don’t know of plans to add this to JavaScript. (It is <a href="http://blogs.msdn.com/b/dsyme/archive/2013/03/24/asynchronous-programming-from-f-to-python.aspx" target="_blank">coming to Python</a>, though.) </li>        <li>The onComplete() and onError() callbacks take a <a href="http://en.wikipedia.org/wiki/JSON" target="_blank">JSON</a> string as an argument: we need to de-serialize this to get at the properties we’re looking for (in our case we care about <em>status</em> and <em>objectId</em>).</li>     </ul>   </li>    <li>The zoomExtents() method is pretty handy, and zooms to the <em>specified</em> extents rather than to those of the current drawing. It takes a flag that indicates whether you want AutoCAD to perform a smooth view transition, if it’s at all possible to do so. Pretty cool. </li> </ul>  <p>Regarding the development/deployment process…</p>  <p>It’s a bit tricky going back to JavaScript from the world of .NET, especially given how dependent we’ve (probably) all become on IntelliSense.</p>  <p>Now I expect there are text editors that provide syntax completion capabilities for arbitrary JavaScript libraries (you’ll find we have no reference in the code above to <a href="http://www.autocadws.com/jsapi/v1/Autodesk.AutoCAD.js" target="_blank">the Autodesk.AutoCAD.js file</a> – this is assumed, which means any such editor would need to be configured to point to it), but the way I’ve enabled this within Visual Studio is to code within an HTML wrapper:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">html</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">head</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">script</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">type</span><span style="line-height: 140%; color: blue">=&quot;text/javascript&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">src</span><span style="line-height: 140%; color: blue">=&quot;http://www.autocadws.com/jsapi/v1/Autodesk.AutoCAD.js&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">script</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">script</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">type</span><span style="line-height: 140%; color: blue">=&quot;text/javascript&quot;&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// You can code here...</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">script</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">head</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">body</span><span style="line-height: 140%; color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">html</span><span style="line-height: 140%; color: blue">&gt;</span></p> </div>  <p>You can write your code in the area indicated above and receive at least some IntelliSense from Visual Studio, before copying and pasting to a separate .js file for deployment (assuming you have no HTML UI to deploy, of course).</p>  <p>You can then use the WEBLOAD command inside AutoCAD to load from the URL this code has been posted at (and you can do this now inside AutoCAD 2014 – you don’t need to post to your own URL, of course):</p>  <p><font face="Courier New">(command &quot;_.WEBLOAD&quot; &quot;</font><a title="http://through-the-interface.typepad.com/files/ZoomEntity.js" href="http://through-the-interface.typepad.com/files/ZoomEntity.js"><font face="Courier New">http://through-the-interface.typepad.com/files/ZoomEntity.js</font></a><font face="Courier New">&quot;)</font></p>  <p>As mentioned in the last post, to avoid the security warning related to loading the code from this domain, you can add it to the TRUSTEDDOMAINS sysvar:</p>  <p><font face="Courier New">(setvar &quot;TRUSTEDDOMAINS&quot; (strcat (getvar &quot;TRUSTEDDOMAINS&quot;) &quot;;through-the-interface.typepad.com&quot;))</font></p>  <p>When loaded, it’s then a simple matter of running the ZEN command and selecting an entity to which you’d like to zoom.</p>  <p>I did see a quirk related to this: the view modification operation did not get included in the undo stack. I’ll ask around to see whether that’s a deliberate choice, or not.</p>  <p>A bit of trickiness I came across when deploying to my blog (you can also WEBLOAD from a local folder, of course, which certainly makes sense while developing your code) is that the hosted browser (more on this in a future post where we’ll go under the cover on the implementation) seems to save a cache of the page for performance reasons. I so far haven’t been able to find a way to clear that cache, which means that I’ve resorted to posting different versions of the file under different names (which renders caching irrelevant and guarantees the latest code will be loaded at the expense of having lots of source files on the web to clean up, afterwards).</p>  <p>Right – I’m going to leave it there, for today. In the next post (which may well be tomorrow, as Friday is a holiday, here) we’ll take a look at a simple HTML5 UI – with some JavaScript included – which we’ll load into an AutoCAD palette.</p>
