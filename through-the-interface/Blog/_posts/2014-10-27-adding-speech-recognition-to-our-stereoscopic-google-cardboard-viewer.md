---
layout: "post"
title: "Adding speech recognition to our stereoscopic Google Cardboard viewer"
date: "2014-10-27 15:45:09"
author: "Kean Walmsley"
categories:
  - "Autodesk"
  - "HTML"
  - "JavaScript"
  - "PaaS"
  - "User interface"
  - "Virtual Reality"
original_url: "https://www.keanw.com/2014/10/adding-speech-recognition-to-our-stereoscopic-google-cardboard-viewer.html "
typepad_basename: "adding-speech-recognition-to-our-stereoscopic-google-cardboard-viewer"
typepad_status: "Publish"
---

<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb07a06b47970d-pi" target="_blank"><img align="right" alt="Speech recognition, not at its best" border="0" height="264" src="/assets/image_672189.jpg" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; margin: 0px 0px 10px 20px; display: inline; padding-right: 0px; border-top-width: 0px" title="Speech recognition, not at its best" width="150" /></a>I nearly named this post “<em>Creating a stereoscopic viewer for Google Cardboard using the Autodesk 360 viewer – Part 4</em>”, leading on from <a href="http://through-the-interface.typepad.com/through_the_interface/2014/10/gearing-up-for-the-vr-hackathon.html" target="_blank">the series introduction</a> and then parts <a href="http://through-the-interface.typepad.com/through_the_interface/2014/10/creating-a-stereoscopic-viewer-for-google-cardboard-using-the-autodesk-360-viewer-part-1.html" target="_blank">1</a>, <a href="http://through-the-interface.typepad.com/through_the_interface/2014/10/creating-a-stereoscopic-viewer-for-google-cardboard-using-the-autodesk-360-viewer-part-2.html" target="_blank">2</a> &amp; <a href="http://through-the-interface.typepad.com/through_the_interface/2014/10/creating-a-stereoscopic-viewer-for-google-cardboard-using-the-autodesk-360-viewer-part-3.html" target="_blank">3</a>. But then I decided this topic deserved it’s very own title. :-)</p>  <p>The seed for this post was sown during <a href="http://through-the-interface.typepad.com/through_the_interface/2014/10/vr-hackathon-2014-in-sf.html" target="_blank">the VR Hackathon</a>, at the beginning of which I had an inspiring chat with <a href="http://www.theoarmour.com/p/about-theo.html" target="_blank">Theo Armour</a>. Not only does Theo have a name worthy of a gladiator – and it turns out there is <a href="http://nameberry.com/list/430/Gladiator-Baby-Names" target="_blank">a list of gladiator names</a> on the Internet, just one more reason I love it – he has an inspiring view of technology and what it can bring us. <a href="http://thebuildingcoder.typepad.com" target="_blank">Jeremy Tammik</a> <a href="http://thebuildingcoder.typepad.com/blog/2014/05/aec-hackathon-from-the-midst-of-the-fray.html" target="_blank">collaborated with Theo</a> <a href="http://thebuildingcoder.typepad.com/blog/2014/05/rvtva3c-revit-va3c-generic-aec-viewer-json-export.html" target="_blank">at the recent AEC Hackathon</a> in New York, so I’m sure he knows what I’m talking about.</p>  <p>Anyway, firstly it turns out Theo is the person behind <a href="http://www.jaanga.com" target="_blank">jaanga.com</a>, and it was he who put together <a href="https://github.com/jaanga/cookbook/tree/gh-pages/cardboard" target="_blank">the template</a> that got me started with Google Cardboard and the Autodesk Viewing &amp; Data service. So I already owe Theo a debt of thanks for that.</p>  <p>Secondly, Theo has been thinking about where to go next with VR, specifically with regards to user input. A problem with holding a set of goggles in your hands is that it’s hard to do very much with them otherwise. Google Cardboard does have a “button” on the side, which is really just a movable washer connected to a fixed magnet that influences the phone’s magnetometer, but as you can only access that from a native Android app – not an HTML page – then it’s basically useless for our purposes.</p>  <p>I’d been looking at Leap Motion to help with this, which implies having one or more hands free but also adds a platform dependency: not only is their mobile SDK currently Android-specific, it’s also supported on a limited set of devices with sufficiently powerful processors, such as the Nexus 5. I’m still planning on pre-ordering a Nexus 6 and getting it working with that, but I’m also keen to move things forward in the meantime and consider solutions that don’t reduce the possible audience for this application.</p>  <p>Theo was clearly very excited about the potential for getting access to speech recognition in HTML5 apps. My initial reaction was “wow – surely you can’t do that from HTML5!?!” but Theo was keen to pursue this direction. Before I left San Francisco, Theo very kindly invited me for a nice <a href="http://en.wiktionary.org/wiki/ap%C3%A9ro" target="_blank">apéro</a> at <a href="http://www.marketbar.com" target="_blank">the ferry building</a> – I was taking the ferry back to Marin on Wednesday afternoon – where he unveiled <a href="http://jaanga.github.io/cookbook/voice-commands/readme-reader.html" target="_blank">a working prototype of his HTML5 viewer with functioning speech recognition</a>. Too cool!</p>  <p>Theo’s demo app makes use of <a href="https://www.talater.com/annyang" target="_blank">annyang</a>, a simple JavaScript API that sits on top of the <a href="http://shapeshed.com/html5-speech-recognition-api/" target="_blank">HTML5 Speech Recognition API</a> that it turns out is exposed by most modern browsers. Who knew?</p>  <p>So I went and shamelessly copied Theo’s approach, extending it for the Autodesk 360 viewer sample. I initially focused on implementing commands such as “explode”, “combine”, and zooming “in” and “out” – as well as “reset” and “reload” – but I also managed to find a way to make it work with the command definitions used to create our UI buttons for the front page. So you can also now switch models by saying the name of the model you want to load. A very handy enhancement.</p>  <p>It’s worth noting that it’s really best to load the first model via the UI – this allows us to force the page to fullscreen, as some UI interaction is needed for that – but after that you can simply use speech to load subequent models.</p>  <p>Google Chrome does keep <a href="https://github.com/TalAter/annyang/issues/66" target="_blank">asking for permission to access the microphone</a>, which is a little annoying, but it turns out that loading the page via “https” allows the browser to remember this. You just get the occasional beep, which is rather less annoying.</p>  <p>The interesting part of <a href="https://http://safe-reef-1847.herokuapp.com/stereo-voice.html" target="_blank">the HTML app</a> is, as usual, <a href="http://safe-reef-1847.herokuapp.com/js/stereo-voice.js" target="_blank">the JavaScript code</a>. So here that is:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">var</span> viewerLeft, viewerRight;</p>    <p style="margin: 0px"><span style="color: blue">var</span> updatingLeft = <span style="color: blue">false</span>, updatingRight = <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: blue">var</span> leftLoaded, rightLoaded, cleanedModel;</p>    <p style="margin: 0px"><span style="color: blue">var</span> leftPos, baseDir, upVector, initLeftPos;</p>    <p style="margin: 0px"><span style="color: blue">var</span> initZoom;</p>    <p style="margin: 0px"><span style="color: blue">var</span> expFac = 0, exp = 0;</p>    <p style="margin: 0px"><span style="color: blue">var</span> targExp = 0.5, xfac = 0.05, zfac = 0.3;</p>    <p style="margin: 0px"><span style="color: blue">var</span> direction = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">var</span> buttons = {</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;robot arm&#39;</span> : <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; launchViewer(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&#39;dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6c3RlYW1idWNrL1JvYm90QXJtLmR3Zng=&#39;</span>&#0160;&#0160;&#0160; </p>    <p style="margin: 0px">&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;front loader&#39;</span> : <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; launchViewer(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&#39;dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6c3RlYW1idWNrL0Zyb250JTIwTG9hZGVyLmR3Zng=&#39;</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">new</span> THREE.Vector3(0, 0, 1)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;suspension&#39;</span> : <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; launchViewer(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&#39;dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6c3RlYW1idWNrL1N1c3BlbnNpb24uZHdm&#39;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;house&#39;</span> : <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; launchViewer(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&#39;dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6c3RlYW1idWNrL2hvdXNlLmR3Zng=&#39;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;V8 engine&#39;</span> : <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; launchViewer(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&#39;dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6c3RlYW1idWNrL1Y4RW5naW5lLnN0cA==&#39;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;morgan&#39;</span> : <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; launchViewer(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&#39;dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6c3RlYW1idWNrL1NwTTNXNy5mM2Q=&#39;</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">new</span> THREE.Vector3(0, 0, 1),</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; zoom(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; viewerLeft,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; -48722.5, -54872, 44704.8,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; 10467.3, 1751.8, 1462.8</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">var</span> commands = {</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;explode&#39;</span>: <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (checkViewers()) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; expFac = expFac + 1;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; explode(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;combine&#39;</span>: <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (checkViewers()) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (expFac &gt; 0) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; expFac = expFac - 1;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; explode(<span style="color: blue">false</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;in&#39;</span>: <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (checkViewers()) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; zoomInwards(-zfac);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;out&#39;</span>: <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (checkViewers()) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; zoomInwards(zfac);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;reset&#39;</span>: <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (checkViewers()) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; expFac = 0;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; explode(<span style="color: blue">false</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (initLeftPos) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> trg = viewerLeft.navigation.getTarget();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> up = viewerLeft.navigation.getCameraUpVector();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; leftPos = initLeftPos.clone();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; zoom(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; viewerLeft,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; initLeftPos.x, initLeftPos.y, initLeftPos.z,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; trg.x, trg.y, trg.z, up.x, up.y, up.z</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; },</p>    <p style="margin: 0px">&#0160; <span style="color: #a31515">&#39;reload&#39;</span>: <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; location.reload();</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">};</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> initialize() {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Populate our initial UI with a set of buttons, one for each</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// function in the Buttons object</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> panel = document.getElementById(<span style="color: #a31515">&#39;control&#39;</span>);</p>    <p style="margin: 0px">&#0160; <span style="color: blue">for</span> (<span style="color: blue">var</span> name <span style="color: blue">in</span> buttons) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">var</span> fn = buttons[name];</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">var</span> button = document.createElement(<span style="color: #a31515">&#39;div&#39;</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; button.classList.add(<span style="color: #a31515">&#39;cmd-btn&#39;</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Replace any underscores with spaces before setting the</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// visible name</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; button.innerHTML = name;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; button.onclick = (<span style="color: blue">function</span> (name) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> <span style="color: blue">function</span> () { name(); };</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; })(fn);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Add the button with a space under it</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; panel.appendChild(button);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; panel.appendChild(document.createTextNode(<span style="color: #a31515">&#39;\u00a0&#39;</span>));</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (annyang) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Add our buttons and commands to annyang</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; annyang.addCommands(buttons);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; annyang.addCommands(commands);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Start listening</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; annyang.start();</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> checkViewers() {</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (viewerLeft &amp;&amp; viewerRight)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">return</span> viewerLeft.running &amp;&amp; viewerRight.running;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> launchViewer(docId, upVec, zoomFunc) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Reset some variables when we reload</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (viewerLeft) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; viewerLeft.uninitialize();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; viewerLeft = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (viewerRight) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; viewerRight.uninitialize();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; viewerRight = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160; updatingLeft = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160; updatingRight = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160; leftPos = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160; baseDir = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160; upVector = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160; initLeftPos = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160; initZoom = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160; expFac = 0;</p>    <p style="margin: 0px">&#0160; exp = 0;</p>    <p style="margin: 0px">&#0160; direction = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Assume the default &quot;world up vector&quot; of the Y-axis</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// (only atypical models such as Morgan and Front Loader require</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// the Z-axis to be set as up)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; upVec =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">typeof</span> upVec !== <span style="color: #a31515">&#39;undefined&#39;</span> ?</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; upVec :</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">new</span> THREE.Vector3(0, 1, 0);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Ask for the page to be fullscreen</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// (can only happen in a function called from a</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// button-click handler or some other UI event)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; requestFullscreen();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Hide the controls that brought us here</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> controls = document.getElementById(<span style="color: #a31515">&#39;control&#39;</span>);</p>    <p style="margin: 0px">&#0160; controls.style.visibility = <span style="color: #a31515">&#39;hidden&#39;</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Bring the layer with the viewers to the front</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// (important so they also receive any UI events)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> layer1 = document.getElementById(<span style="color: #a31515">&#39;layer1&#39;</span>);</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> layer2 = document.getElementById(<span style="color: #a31515">&#39;layer2&#39;</span>);</p>    <p style="margin: 0px">&#0160; layer1.style.zIndex = 1;</p>    <p style="margin: 0px">&#0160; layer2.style.zIndex = 2;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Store the up vector in a global for later use</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; upVector = upVec.clone();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// The same for the optional Initial Zoom function</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; initZoom =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">typeof</span> zoomFunc !== <span style="color: #a31515">&#39;undefined&#39;</span> ?</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; zoomFunc :</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Get our access token from the internal web-service API</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; $.get(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; window.location.protocol + <span style="color: #a31515">&#39;//&#39;</span> +</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; window.location.host + <span style="color: #a31515">&#39;/api/token&#39;</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">function</span> (accessToken) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Specify our options, including the provided document ID</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> options = {};</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; options.env = <span style="color: #a31515">&#39;AutodeskProduction&#39;</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; options.accessToken = accessToken;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; options.document = docId;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Create and initialize our two 3D viewers</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> elem = document.getElementById(<span style="color: #a31515">&#39;viewLeft&#39;</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; viewerLeft = <span style="color: blue">new</span> Autodesk.Viewing.Viewer3D(elem, {});</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; Autodesk.Viewing.Initializer(options, <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; viewerLeft.initialize();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; loadDocument(viewerLeft, options.document);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; });</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; elem = document.getElementById(<span style="color: #a31515">&#39;viewRight&#39;</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; viewerRight = <span style="color: blue">new</span> Autodesk.Viewing.Viewer3D(elem, {});</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; Autodesk.Viewing.Initializer(options, <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; viewerRight.initialize();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; loadDocument(viewerRight, options.document);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; });</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; );</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> loadDocument(viewer, docId) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// The viewer defaults to the full width of the container,</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// so we need to set that to 50% to get side-by-side</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; viewer.container.style.width = <span style="color: #a31515">&#39;50%&#39;</span>;</p>    <p style="margin: 0px">&#0160; viewer.resize();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Let&#39;s zoom in and out of the pivot - the screen</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// real estate is fairly limited - and reverse the</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// zoom direction</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; viewer.navigation.setZoomTowardsPivot(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160; viewer.navigation.setReverseZoomDirection(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (docId.substring(0, 4) !== <span style="color: #a31515">&#39;urn:&#39;</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; docId = <span style="color: #a31515">&#39;urn:&#39;</span> + docId;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; Autodesk.Viewing.Document.load(docId,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">function</span> (document) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Boilerplate code to load the contents</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> geometryItems = [];</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (geometryItems.length == 0) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; geometryItems =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Autodesk.Viewing.Document.getSubItemsWithProperties(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; document.getRootItem(),</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; { <span style="color: #a31515">&#39;type&#39;</span>: <span style="color: #a31515">&#39;geometry&#39;</span>, <span style="color: #a31515">&#39;role&#39;</span>: <span style="color: #a31515">&#39;3d&#39;</span> },</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">true</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (geometryItems.length &gt; 0) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; viewer.load(document.getViewablePath(geometryItems[0]));</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Add our custom progress listener and set the loaded</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// flags to false</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; leftLoaded = rightLoaded = cleanedModel = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; viewer.addEventListener(<span style="color: #a31515">&#39;progress&#39;</span>, progressListener);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; },</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">function</span> (errorMsg, httpErrorCode) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> container = document.getElementById(<span style="color: #a31515">&#39;viewerLeft&#39;</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (container) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; alert(<span style="color: #a31515">&#39;Load error &#39;</span> + errorMsg);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; );</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// Progress listener to set the view once the data has started</span></p>    <p style="margin: 0px"><span style="color: green">// loading properly (we get a 5% notification early on that we</span></p>    <p style="margin: 0px"><span style="color: green">// need to ignore - it comes too soon)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> progressListener(e) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// If we haven&#39;t cleaned this model&#39;s materials and set the view</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// and both viewers are sufficiently ready, then go ahead</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (!cleanedModel &amp;&amp;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; ((e.percent &gt; 0.1 &amp;&amp; e.percent &lt; 5) || e.percent &gt; 5)) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (e.target.clientContainer.id === <span style="color: #a31515">&#39;viewLeft&#39;</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; leftLoaded = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (e.target.clientContainer.id === <span style="color: #a31515">&#39;viewRight&#39;</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; rightLoaded = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (leftLoaded &amp;&amp; rightLoaded &amp;&amp; !cleanedModel) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (initZoom) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Iterate the materials to change any red ones to grey</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// (We only need this for the Morgan model, which has</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// translation issues from Fusion 360... which is also</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// the only model to provide an initial zoom function)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">for</span> (<span style="color: blue">var</span> p <span style="color: blue">in</span> viewerLeft.impl.matman().materials) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> m = viewerLeft.impl.matman().materials[p];</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (m.color.r &gt;= 0.5 &amp;&amp; m.color.g == 0 &amp;&amp; m.color.b == 0) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m.color.r = m.color.g = m.color.b = 0.5;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m.needsUpdate = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">for</span> (<span style="color: blue">var</span> p <span style="color: blue">in</span> viewerRight.impl.matman().materials) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> m = viewerRight.impl.matman().materials[p];</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (m.color.r &gt;= 0.5 &amp;&amp; m.color.g == 0 &amp;&amp; m.color.b == 0) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m.color.r = m.color.g = m.color.b = 0.5;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m.needsUpdate = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// If provided, use the &quot;initial zoom&quot; function</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; initZoom();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; setTimeout(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; initLeftPos = viewerLeft.navigation.getPosition();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">//TOREMOVE</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">//viewerLeft.autocam.setCurrentViewAsFront();</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; transferCameras(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; },</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; 500</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; watchTilt();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; cleanedModel = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160; <span style="color: blue">else</span> <span style="color: blue">if</span> (cleanedModel &amp;&amp; e.percent &gt; 10) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// If we have already cleaned and are even further loaded,</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// remove the progress listeners from the two viewers and</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// watch the cameras for updates</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; unwatchProgress();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; watchCameras();</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> requestFullscreen() {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Must be performed from a UI event handler</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> el = document.documentElement,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; rfs =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; el.requestFullScreen ||</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; el.webkitRequestFullScreen ||</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; el.mozRequestFullScreen;</p>    <p style="margin: 0px">&#0160; rfs.call(el);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// Add and remove the pre-viewer event handlers</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> watchCameras() {</p>    <p style="margin: 0px">&#0160; viewerLeft.addEventListener(<span style="color: #a31515">&#39;cameraChanged&#39;</span>, left2right);</p>    <p style="margin: 0px">&#0160; viewerRight.addEventListener(<span style="color: #a31515">&#39;cameraChanged&#39;</span>, right2left);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> unwatchCameras() {</p>    <p style="margin: 0px">&#0160; viewerLeft.removeEventListener(<span style="color: #a31515">&#39;cameraChanged&#39;</span>, left2right);</p>    <p style="margin: 0px">&#0160; viewerRight.removeEventListener(<span style="color: #a31515">&#39;cameraChanged&#39;</span>, right2left);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> unwatchProgress() {</p>    <p style="margin: 0px">&#0160; viewerLeft.removeEventListener(<span style="color: #a31515">&#39;progress&#39;</span>, progressListener);</p>    <p style="margin: 0px">&#0160; viewerRight.removeEventListener(<span style="color: #a31515">&#39;progress&#39;</span>, progressListener);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> watchTilt() {</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (window.DeviceOrientationEvent)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; window.addEventListener(<span style="color: #a31515">&#39;deviceorientation&#39;</span>, orb);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// Event handlers for the cameraChanged events</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> left2right() {</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (!updatingRight) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; updatingLeft = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; transferCameras(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; setTimeout(<span style="color: blue">function</span> () { updatingLeft = <span style="color: blue">false</span>; }, 500);</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> right2left() {</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (!updatingLeft) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; updatingRight = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; transferCameras(<span style="color: blue">false</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; setTimeout(<span style="color: blue">function</span> () { updatingRight = <span style="color: blue">false</span>; }, 500);</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// And for the deviceorientation event</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> orb(e) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (e.alpha &amp;&amp; e.gamma) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Remove our handlers watching for camera updates,</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// as we&#39;ll make any changes manually</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// (we won&#39;t actually bother adding them back, afterwards,</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// as this means we&#39;re in mobile mode and probably inside</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// a Google Cardboard holder)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; unwatchCameras();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// Our base direction allows us to make relative horizontal</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: green">// rotations when we rotate left &amp; right</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (!baseDir)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; baseDir = e.alpha;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">if</span> (checkViewers()) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> deg2rad = Math.PI / 180;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// gamma is the front-to-back in degrees (with</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// this screen orientation) with +90/-90 being</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// vertical and negative numbers being &#39;downwards&#39;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// with positive being &#39;upwards&#39;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> vert = (e.gamma + (e.gamma &lt;= 0 ? 90 : -90)) * deg2rad;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// alpha is the compass direction the device is</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// facing in degrees. This equates to the</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// left - right rotation in landscape</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// orientation (with 0-360 degrees)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> horiz = (e.alpha - baseDir) * deg2rad;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; orbitViews(vert, horiz);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> transferCameras(leftToRight) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// The direction argument dictates the source and target</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> source = leftToRight ? viewerLeft : viewerRight;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> target = leftToRight ? viewerRight : viewerLeft;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> pos = source.navigation.getPosition();</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> trg = source.navigation.getTarget();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Set the up vector manually for both cameras</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; source.navigation.setWorldUpVector(upVector);</p>    <p style="margin: 0px">&#0160; target.navigation.setWorldUpVector(upVector);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Get the new position for the target camera</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> up = source.navigation.getCameraUpVector();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Get the position of the target camera</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> newPos = offsetCameraPos(source, pos, trg, leftToRight);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Save the left-hand camera position: device tilt orbits</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// will be relative to this point</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; leftPos = leftToRight ? pos : newPos;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Zoom to the new camera position in the target</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; zoom(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; target, newPos.x, newPos.y, newPos.z, trg.x, trg.y, trg.z,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; up.x, up.y, up.z</p>    <p style="margin: 0px">&#0160; );</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> getDistance(v1,v2) {</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> diff = <span style="color: blue">new</span> THREE.Vector3().subVectors(v1, v2);</p>    <p style="margin: 0px">&#0160; <span style="color: blue">return</span> diff.length();</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> offsetCameraPos(source, pos, trg, leftToRight) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Use a small fraction of the distance for the camera offset</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> disp = getDistance(pos, trg) * 0.04;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Clone the camera and return its X translated position</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> clone = source.autocamCamera.clone();</p>    <p style="margin: 0px">&#0160; clone.translateX(leftToRight ? disp : -disp);</p>    <p style="margin: 0px">&#0160; <span style="color: blue">return</span> clone.position;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> orbitViews(vert, horiz) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// We&#39;ll rotate our position based on the initial position</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// and the target will stay the same</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> pos = leftPos.clone();</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> trg = viewerLeft.navigation.getTarget();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Start by applying the left/right orbit</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// (we need to check the up/down value, though)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (vert &lt; 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; horiz = horiz + Math.PI;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> zAxis = upVector.clone();</p>    <p style="margin: 0px">&#0160; pos.applyAxisAngle(zAxis, horiz);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Now add the up/down rotation</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> axis = <span style="color: blue">new</span> THREE.Vector3().subVectors(trg, pos).normalize();</p>    <p style="margin: 0px">&#0160; axis.cross(zAxis);</p>    <p style="margin: 0px">&#0160; pos.applyAxisAngle(axis, -vert);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Zoom in with the lefthand view</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> up = viewerLeft.navigation.getCameraUpVector();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; zoom(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; viewerLeft,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; pos.x, pos.y, pos.z,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; trg.x, trg.y, trg.z</p>    <p style="margin: 0px">&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Get a camera slightly to the right</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> pos2 = offsetCameraPos(viewerLeft, pos, trg, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// And zoom in with that on the righthand view, too</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; zoom(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; viewerRight,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; pos2.x, pos2.y, pos2.z,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; trg.x, trg.y, trg.z,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; up.x, up.y, up.z</p>    <p style="margin: 0px">&#0160; );</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> explode(outwards) {</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (outwards != direction)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; direction = outwards;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; setTimeout(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; exp = exp + (direction ? xfac : -xfac);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; setTimeout(<span style="color: blue">function</span> () { viewerLeft.explode(exp); }, 0);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; setTimeout(<span style="color: blue">function</span> () { viewerRight.explode(exp); }, 0);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> ((direction &amp;&amp; exp &lt; targExp * expFac) ||</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (!direction &amp;&amp; exp &gt; targExp * expFac))</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; explode(direction);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; },</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; 50</p>    <p style="margin: 0px">&#0160; );</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> zoomAlongCameraDirection(viewer, factor) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> pos = leftPos.clone();</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> trg = viewer.navigation.getTarget();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">var</span> disp = trg.clone().sub(pos).multiplyScalar(factor);</p>    <p style="margin: 0px">&#0160; pos.sub(disp);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">return</span> pos;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> zoomInwards(factor) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; leftPos = zoomAlongCameraDirection(viewerLeft, factor);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// Set the camera based on a position, target and optional up vector</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> zoom(viewer, px, py, pz, tx, ty, tz, ux, uy, uz) {</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Make sure our up vector is correct for this model</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; viewer.navigation.setWorldUpVector(upVector, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; viewer.navigation.setView(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">new</span> THREE.Vector3(px, py, pz),</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">new</span> THREE.Vector3(tx, ty, tz)</p>    <p style="margin: 0px">&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">if</span> (ux &amp;&amp; uy &amp;&amp; uz) {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> up = <span style="color: blue">new</span> THREE.Vector3(ux, uy, uz);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; viewer.navigation.setCameraUpVector(up);</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p> </div>  <p>Here’s a video of how it works.</p>  <p>   <br /><iframe allowfullscreen="allowfullscreen" frameborder="0" height="264" src="//www.youtube.com/embed/FVIQXlKrRzI?rel=0&amp;showinfo=0" width="470"></iframe></p>  <p>You’ll note that the odd command gets dropped – and that’s in a relatively noise-free environment – but I think you’ll find it’s mostly a very helpful addition to viewer’s feature-set. Thanks again to Theo for the inspiration!</p>  <p><span style="color: #666666">photo credit: </span><a href="https://www.flickr.com/photos/filmstalker/8445578188/"><span style="color: #666666">Filmstalker</span></a><span style="color: #666666"> via </span><a href="http://photopin.com"><span style="color: #666666">photopin</span></a><a href="http://creativecommons.org/licenses/by-nc-nd/2.0/"><span style="color: #666666">cc</span></a></p>  <p><strong><em>Update:</em></strong></p>  <p>I fixed a logic error in the code: the zoom was being applied to the camera position post tilt transformation, and so would end up being rotated. The above, updated code works much better than the version posted originally.</p>
