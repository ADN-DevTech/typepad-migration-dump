---
layout: "post"
title: "Preventing selection of room geometry in the Forge viewer"
date: "2017-02-28 15:12:07"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk"
  - "Autodesk Research"
  - "HTML"
  - "IoT"
  - "JavaScript"
original_url: "https://www.keanw.com/2017/02/preventing-selection-of-room-geometry-in-the-forge-viewer.html "
typepad_basename: "preventing-selection-of-room-geometry-in-the-forge-viewer"
typepad_status: "Publish"
---

<p>Some of you may remember <a href="http://through-the-interface.typepad.com/through_the_interface/2016/06/getting-room-information-for-revit-models-in-the-forge-viewer.html" target="_blank">this post</a>, which talks about the ability to export to Navisworks from Revit to bring room information into the Forge viewer. One of the side effects of using this technique is that there’s a bunch of semi-transparent room boundary geometry in the resultant model, which can make navigation a little tricky.</p> <p>For instance, here’s what happens when I try to select the wall at the end of a corridor (you can’t see the cursor, but you should get the idea – the invisible room geometry gets selected rather than the wall).</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb097e2d5e970d-pi" target="_blank"><img title="When there's a room to select" style="float: none; margin: 30px auto; display: block" alt="When there's a room to select" src="/assets/image_425293.jpg" width="500" height="410"></a></p> <p>To help improve the user experience in <a href="http://dasher360.com" target="_blank">Dasher 360</a>, we’ve been working on reducing the impact of this room geometry on the selection mechanism. The first step was to make sure the room geometry doesn’t get selected: very often it will get selected when the user actually wants to select something behind it. The way I worked around this was to check for the “on selection changed” event and then – if a highly transparent solid (which I’m taking to be a room) gets selected – we go ahead and select the next non-transparent object instead. To do this we need to track the cursor coordinates via the “on mouse move” event.</p> <p>The second thing I ended up doing was to change the material used for room geometry – which has a very specific opacity of 0.09999999 – to be completely invisible. This stops a problem of the unselected room appearing as a haze across the view.</p> <p>This has all been wrapped up into an extension to make it easier to load and unload, as needed. Here’s the TypeScript code:</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: green">/// &lt;reference path='../../../../../typings/lmv-client/lmv-client.d.ts' /&gt;</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">export</span> <span style="color: blue">default</span> <span style="color: blue">class</span> HideRoomsExtension <span style="color: blue">extends</span> Autodesk.Viewing.Extension {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">protected</span> _controller: Dasher.IViewerControllerInterface;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">protected</span> _dataModel: Dasher.IDataModel;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> _textures: string[] = [];</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> _canvasX: number;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> _canvasY: number;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; constructor(viewer: Autodesk.Viewing.Private.GuiViewer3D, options: any) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">super</span>(viewer, options);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>._dataModel = options.dataModel;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>._controller = options.controller;</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; load(): boolean {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; document.addEventListener(<span style="color: #a31515">'mousemove'</span>, <span style="color: blue">this</span>.onMouseMove);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, <span style="color: blue">this</span>.onSelectionChanged);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.hideTransparentMaterials();</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; unload(): boolean {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; document.removeEventListener(<span style="color: #a31515">'mousemove'</span>, <span style="color: blue">this</span>.onMouseMove);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.viewer.removeEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, <span style="color: blue">this</span>.onSelectionChanged);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.showTransparentMaterials();</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: green">// This isn't ideal: we store the current mouse location as we need</span></p> <p style="margin: 0px">&nbsp; <span style="color: green">// it to reselect when a room is selected</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> onMouseMove = (event: any): <span style="color: blue">void</span> =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>._canvasX = event.canvasX;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>._canvasY = event.canvasY;</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> onSelectionChanged = (event: any): <span style="color: blue">void</span> =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Check for transparent solids</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (event.dbIdArray.length &gt; 0) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; event.dbIdArray.forEach((id: number) =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.viewer.model.getProperties(id, (result: any) =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (result.name === <span style="color: #a31515">'Solid'</span>) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (result.properties.findIndex((prop: any) =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> prop.displayName === <span style="color: #a31515">'Transparency'</span> &amp;&amp; prop.displayValue &gt; 0.8;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }) &gt; -1) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Reselect based on the current mouse position</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> res = <span style="color: blue">this</span>.viewer.impl.hitTest(<span style="color: blue">this</span>._canvasX, <span style="color: blue">this</span>._canvasY, <span style="color: blue">true</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (res &amp;&amp; res.dbId &amp;&amp; res.model) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.viewer.impl.selector.setSelection([res.dbId], res.model);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <span style="color: blue">else</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>._dataModel.clearViewerSelection();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> hideTransparentMaterials(): <span style="color: blue">void</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> store = (<span style="color: blue">this</span>._textures.length === 0);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> mats = <span style="color: blue">this</span>.viewer.impl.matman()._materials;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; Object.keys(mats).forEach((p: string) =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> m = mats[p];</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (m.opacity &lt; 0.1 &amp;&amp; m.opacity &gt; 0.099 &amp;&amp; m.visible) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (store) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>._textures.push(p);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.visible = <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.needsUpdate = <span style="color: blue">true</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; });</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> showTransparentMaterials(): <span style="color: blue">void</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (<span style="color: blue">this</span>._textures) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> mats = <span style="color: blue">this</span>.viewer.impl.matman()._materials;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>._textures.forEach((p: string) =&gt; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> m = mats[p];</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.visible = <span style="color: blue">true</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.needsUpdate = <span style="color: blue">true</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Here’s the new behaviour, where we see the end wall gets selected rather than one of the phantom rooms.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d26565bf970c-pi" target="_blank"><img title="Now with selection overridden" style="float: none; margin: 30px auto; display: block" alt="Now with selection overridden" src="/assets/image_491140.jpg" width="500" height="410"></a></p>
