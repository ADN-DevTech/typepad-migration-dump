---
layout: "post"
title: "Securing your AutoCAD app using .NET"
date: "2016-02-10 11:06:34"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Autodesk App Store"
  - "REST"
original_url: "https://www.keanw.com/2016/02/securing-your-autocad-app-using-net.html "
typepad_basename: "securing-your-autocad-app-using-net"
typepad_status: "Publish"
---

<p>Many, many thanks for the congratulatory messages I received after <a href="http://through-the-interface.typepad.com/through_the_interface/2016/02/time-for-a-change.html" target="_blank">my last post</a>, whether via this blog, <a href="http://twitter.com/keanw" target="_blank">Twitter</a>, <a href="https://www.linkedin.com/in/keanw" target="_blank">LinkedIn</a> or email. I was genuinely overwhelmed by the response! :-)</p> <p>Here’s a post I’ve been meaning to write for some time: a common question I’ve seen, over the years, is about how best to implement copy protection or licensing in your application. While this post doesn’t fully address that requirement, it does show you how to use a REST API to check the user entitlement for your application via the <a href="https://apps.autodesk.com" target="_blank">Autodesk App Store</a> (formerly known as Autodesk Exchange Apps). This post is therefore really only relevant if you’ve posted your app there (or are considering it… just this mechanism could be enough of a reason for some to adopt this infrastructure).</p> <p>The Entitlement API needs a couple of parameters to work: the “user ID” and the “app ID”.</p> <p>The <em>user ID</em> can be accessed in AutoCAD via the ONLINEUSERID sysvar which was introduced in AutoCAD 2014. It provides a unique ID that identifies the current user in the A360 back-end. If it’s an empty string then the current user isn’t logged in to A360.</p> <p>The <em>app ID</em> can be determined using the URL for the app’s entry in the Autodesk App Store. For instance, here’s the link to the Screenshot app:</p> <p><a title="https://apps.autodesk.com/ACD/en/Detail/Index?id=appstore.exchange.autodesk.com%3ascreenshot%3aen" href="https://apps.autodesk.com/ACD/en/Detail/Index?id=appstore.exchange.autodesk.com%3ascreenshot%3aen">https://apps.autodesk.com/ACD/en/Detail/Index?id=appstore.exchange.autodesk.com%3ascreenshot%3aen</a></p> <p>You can see the ID at the end, in this case it’s <em>appstore.exchange.autodesk.com:screenshot:en</em> (%3a is the URI encoding for “:”). You can also find this ID for your own apps via the publishing mechanism.</p> <p>The Entitlement API is really easy to use. For instance, here’s a check to see whether the user with the made-up ID “1234567890” is entitled to use the Screenshot app:</p> <p><a title="https://apps.autodesk.com/webservices/checkentitlement?userid=1234567890&amp;appid=appstore.exchange.autodesk.com%3ascreenshot%3aen" href="https://apps.autodesk.com/webservices/checkentitlement?userid=1234567890&amp;appid=appstore.exchange.autodesk.com%3ascreenshot%3aen">https://apps.autodesk.com/webservices/checkentitlement?userid=1234567890&amp;appid=appstore.exchange.autodesk.com%3ascreenshot%3aen</a></p> <p>You should see this JSON string returned when you click on it:</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px">{"UserId":"1234567890","AppId":"appstore.exchange.autodesk.com:screenshot:en","IsValid":false,"Message":"Ok"}</p> <p style="margin: 0px">&nbsp;</p></div> <p>It’s clearly a simple matter to check this API in your code. Here’s some C# code that defines a CE command that checks the currently logged in user’s entitlement for the Screenshot app. (You would want to change the ID for your own app’s of course.)</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p> <p style="margin: 0px"><span style="color: blue">using</span> Newtonsoft.Json;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Net;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Threading.Tasks;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">namespace</span> EntitlementChecker</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">class</span> <span style="color: #2b91af">Extensions</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">async</span> <span style="color: #2b91af">Task</span>&lt;<span style="color: blue">bool</span>&gt; IsEntitled(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span> <span style="color: #2b91af">Editor</span> ed, <span style="color: blue">string</span> userId, <span style="color: blue">string</span> appId</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; )</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: blue">var</span> wc = <span style="color: blue">new</span> <span style="color: #2b91af">WebClient</span>())</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Use the REST API to check entitlement</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">try</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> url =</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span>.Format(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #a31515">"https://apps.autodesk.com/webservices/checkentitlement?userid={0}&amp;appid={1}"</span>,</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.<span style="color: #2b91af">Uri</span>.EscapeUriString(userId), System.<span style="color: #2b91af">Uri</span>.EscapeUriString(appId)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> res = <span style="color: blue">await</span> wc.DownloadStringTaskAsync(url);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Deserialize the response and return the entitlement value</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> json = <span style="color: #2b91af">JsonConvert</span>.DeserializeObject&lt;<span style="color: blue">dynamic</span>&gt;(res);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> (<span style="color: blue">bool</span>)json.IsValid;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">catch</span> (System.Net.<span style="color: #2b91af">WebException</span>)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ed.WriteMessage(<span style="color: #a31515">"\nCould not access the online entitlement API.\n"</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Commands</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">"CE"</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">async</span> <span style="color: blue">void</span> CheckEntitlement()</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>) <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> ed = doc.Editor;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> appId = <span style="color: #a31515">"appstore.exchange.autodesk.com:screenshot:en"</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> userId = (<span style="color: blue">string</span>)<span style="color: #2b91af">Application</span>.GetSystemVariable(<span style="color: #a31515">"ONLINEUSERID"</span>);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrEmpty(userId))</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ed.WriteMessage(<span style="color: #a31515">"\nYou are not logged in to the AutoCAD App Store."</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Check entitlement</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> entitled = <span style="color: blue">await</span> ed.IsEntitled(userId, appId);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ed.WriteMessage(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #a31515">"\nYou are {0}entitled to use app \"{1}\".\n"</span>,</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entitled ? <span style="color: #a31515">""</span> : <span style="color: #a31515">"not "</span>, appId</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Right now I’ve implemented an extension method off the Editor class, mainly as I wanted to print a message to the command-line using WriteMessage(). In reality you’d probably want to throw an exception from within the check function and catch it in an our exception handler. At least that’s what I’d look at doing for a real-world application.</p> <p>Here’s the CE command in action:</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d19dc19a970c-pi" target="_blank"><img title="Checking for entitlement" style="float: none; margin: 30px auto; display: block" alt="Checking for entitlement" src="/assets/image_22023.jpg" width="500" height="280"></a></p> <p align="left">I’ve deliberately kept things simple for this blog post. If you want to find out more about this topic – including best practices for dealing with offline use, etc. – then I recommend reading <a href="http://adndevblog.typepad.com/cloud_and_mobile/2014/05/how-to-protect-my-intellectual-property-of-my-app-on-autodesk-exchange-part-3.html" target="_blank">this ADN DevBlog post</a> and <a href="http://usa.autodesk.com/adsk/servlet/item?siteID=123112&amp;id=24243865" target="_blank">this DevCenter article</a>.</p>
