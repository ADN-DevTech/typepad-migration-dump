---
layout: "post"
title: "Kinect Fusion: comparing approaches for point cloud generation inside AutoCAD"
date: "2013-10-21 18:54:39"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Kinect"
  - "Point clouds"
  - "Reality capture"
original_url: "https://www.keanw.com/2013/10/kinect-fusion-approaches-for-point-cloud-generation-inside-autocad.html "
typepad_basename: "kinect-fusion-approaches-for-point-cloud-generation-inside-autocad"
typepad_status: "Publish"
---

<p>Something you realise quite early on when working with the Kinect Fusion component in the Microsoft Kinect SDK is that it’s really meant to integrate into a 2D UI: it takes care of rendering the volume that’s being mapped, and you simply have to integrate the generated bitmap somewhere into your app’s UI. The primary benefit of this approach is its low latency: it all happens very quickly and the only data you need to move from the runtime into your app is the bitmap itself.</p>  <p>With 3D systems such as AutoCAD, though, you really want to take the 3D data directly and integrate it into your 3D scene in some way, such as via a jig.</p>  <p>I haven’t been very happy with the approach I’ve so far taken to do this: I’ve been asking the Kinect Fusion runtime <a href="http://through-the-interface.typepad.com/through_the_interface/2013/03/kinect-fusion-inside-autocad.html" target="_blank">to calculate a mesh for a reconstruction volume</a> and have then used its vertices to get point (XYZ) – <a href="http://through-the-interface.typepad.com/through_the_interface/2013/10/kinect-fusion-updated-to-include-colour.html" target="_blank">and now colour</a> (RGB) – data. This has always felt like a bit of a longwinded way of doing things, as we’re throwing away a bunch of data – we’re only using the vertices, not the triangles – but that’s what I was able to get working.</p>  <p>The reason for doing this is simple: AutoCAD is not architected to deal with huge, dynamically generated meshes (we have other products such as Maya and now <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/project-memento-now-available-on-autodesk-labs.html" target="_blank">Project Memento</a> that are much better at this), so it’s a deliberate choice to just take the points.</p>  <p>This “point cloud generation” is then (hopefully) happening multiple times a second as we execute our jig before we then perform a more detailed query of the volume’s data to generate the final, full-colour point cloud.</p>  <p>Back when I first started working with Kinect Fusion, I identified this need to pass via a mesh object as a potential issue and raised it with the Kinect for Windows team. They very kindly went ahead and implemented <a href="http://msdn.microsoft.com/en-us/library/microsoft.kinect.toolkit.fusion.reconstruction.exportvolumeblock.aspx" target="_blank">a new API named ExportVolumeBlock()</a>, which provided more direct access to the volume’s low-level data. You basically create an appropriately sized array of shorts that the method populates with the volume’s voxel data.</p>  <p>When I first worked with this API I had trouble getting my head around it (the documentation on MSDN seemed to require a better understanding of voxels – in particular – than I had at the time), and so I eventually gave up and stuck with my existing approach of generating meshes.</p>  <p>This week I decided that in order to do <a href="http://through-the-interface.typepad.com/through_the_interface/2013/09/au-2013-class-schedule-preview.html" target="_blank">my AU talk</a> <a href="https://events.au.autodesk.com/connect/sessionDetail.ww?SESSION_ID=1441" target="_blank">on Kinect Fusion</a> justice, I really wanted to get this working and be able to compare the performance of these two approaches.</p>  <p>So that’s what I did: I finally worked out how to find out which of the voxels in the volume array was “on” (i.e. a point contributing to the point cloud) and then use that as an alternative approach for generating points from the Kinect Fusion reconstruction volume. This approach seemed to have some advantages, such as being able to leave the array allocated rather than reusing it the whole time, so I was hopeful we’d see some performance gains.</p>  <p>In order to help test this out, I modified my jig with the approach shown in <a href="http://through-the-interface.typepad.com/through_the_interface/2008/12/drawing-text-pl.html" target="_blank">this previous post</a> to display FPS (frames per second) information during execution, as well as implementing some additional UI to choose which of these two approaches to use.</p>  <p>Here’s s snapshot of the jig in action with the FPS at the bottom-left corner of the screen:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019b00376df3970b-pi" target="_blank"><img title="Kinect Fusion capturing a chair" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Kinect Fusion capturing a chair" src="/assets/image_961832.jpg" width="454" height="323" /></a></p>  <p>It’s actually a handy tool for tweaking the various settings and bringing the FPS count up, which can help a great deal with the tracking between frames.</p>  <p>So how did it work out?</p>  <p>I ended up discovering that using the mesh calculation approach is actually pretty comparable to using ExportVolumeBlock(), performance-wise. It’s possible that using a parallel loop to crank through the results of the latter might help speed things up, but with a standard sequential loop the results are comparable. I’m happy to have the code working, nonetheless.</p>  <p>And just the act of bringing the frame rate up allows you to do pretty cool captures – here’s a dining room chair, as an example (which resulted in a 33MB, 1.7 million point PCG file).</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019b00375ad0970c-pi" target="_blank"><img title="Dining chair capture via Kinect Fusion" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Dining chair capture via Kinect Fusion" src="/assets/image_581316.jpg" width="454" height="323" /></a></p>  <p>Here’s the C# code allowing you to experiment with these two approaches:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Collections.Generic;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Collections.ObjectModel;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Diagnostics;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Drawing;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Threading;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Threading.Tasks;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Windows.Threading;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Microsoft.Kinect;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Microsoft.Kinect.Toolkit.Fusion;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.GraphicsInterface;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">#pragma</span><span style="line-height: 140%"> warning disable 162</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> KinectSamples</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorUtils</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Point3dFromColoredPointCollection(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">IList</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt; vecs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pts = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> vec </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> vecs)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pts.Add(</span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(vec.X, vec.Y, vec.Z));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> pts;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Point3dFromVertCollection(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ReadOnlyCollection</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%">&gt; vecs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pts = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> vec </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> vecs)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pts.Add(</span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(vec.X, vec.Z, -vec.Y));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> pts;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ColoredPoint3FromVertCollection(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ReadOnlyCollection</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">Vector3</span><span style="line-height: 140%">&gt; vecs, </span><span style="color: #2b91af; line-height: 140%">ReadOnlyCollection</span><span style="line-height: 140%">&lt;</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">&gt; cols</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Debug</span><span style="line-height: 140%">.Assert(vecs.Count == cols.Count);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pts = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt;();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%">(</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> i=0; i &lt; vecs.Count; i++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> vec = vecs[i];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> col = cols[i];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pts.Add(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; vec.X, vec.Z, -vec.Y,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (col &gt;&gt; 16) &amp; 255,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (col &gt;&gt; 8) &amp; 255,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; col &amp; 255</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> pts;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">KinectFusionColorJig</span><span style="line-height: 140%"> : </span><span style="color: #2b91af; line-height: 140%">KinectPointCloudJig</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Constants</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> MaxTrackingErrors = 100;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ReconstructionProcessor</span><span style="line-height: 140%"> ProcessorType =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ReconstructionProcessor</span><span style="line-height: 140%">.Amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> DeviceToUse = -1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> ColorIntegrationInterval = 2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> AutoResetReconstructionWhenLost = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DepthImageFormat</span><span style="line-height: 140%"> DepthFormat =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">DepthImageFormat</span><span style="line-height: 140%">.Resolution640x480Fps30;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%"> ColorFormat =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.RgbResolution640x480Fps30;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Member variables</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Editor</span><span style="line-height: 140%"> _ed;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SynchronizationContext</span><span style="line-height: 140%"> _ctxt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> _roomWidth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> _roomLength;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> _roomHeight;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _lowResStep;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> _useMesh;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _voxelsPerMeter;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">FusionFloatImageFrame</span><span style="line-height: 140%"> _depthFloatBuffer;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Matrix4</span><span style="line-height: 140%"> _worldToCameraTransform;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Matrix4</span><span style="line-height: 140%"> _defaultWorldToVolumeTransform;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorReconstruction</span><span style="line-height: 140%"> _volume;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _processedFrameCount;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> _lastTrackingAttemptSucceeded;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _trackingErrors;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _frameDataLength;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> _processing;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> _translateResetPoseByMinDepthThreshold = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> _minDepthClip =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultMinimumDepth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> _maxDepthClip =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultMaximumDepth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DepthImagePixel</span><span style="line-height: 140%">[] _depthImagePixels;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">byte</span><span style="line-height: 140%">[] _colorImagePixels;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">FusionColorImageFrame</span><span style="line-height: 140%"> _mappedColorFrame;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImagePoint</span><span style="line-height: 140%">[] _colorCoordinates;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">[] _mappedColorPixels;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">CoordinateMapper</span><span style="line-height: 140%"> _mapper;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _depthWidth = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _depthHeight = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _colorWidth = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _colorHeight = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">[] _voxels = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">TextStyle</span><span style="line-height: 140%"> _style;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// FPS tracking stuff</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> FpsInterval = 2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DispatcherTimer</span><span style="line-height: 140%"> _fpsTimer;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DateTime</span><span style="line-height: 140%"> _lastFPSTimestamp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> _currentFps;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Constructor</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> KinectFusionColorJig(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Editor</span><span style="line-height: 140%"> ed, </span><span style="color: #2b91af; line-height: 140%">SynchronizationContext</span><span style="line-height: 140%"> ctxt,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> width, </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> length, </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> height, </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> vpm, </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> step,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> useMesh</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ed = ed;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ctxt = ctxt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _roomWidth = width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _roomLength = length;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _roomHeight = height;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _voxelsPerMeter = vpm;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _lowResStep = step;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _useMesh = useMesh;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _processing = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _lastTrackingAttemptSucceeded = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _vecs = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt;();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> PostToAutoCAD(</span><span style="color: #2b91af; line-height: 140%">SendOrPostCallback</span><span style="line-height: 140%"> cb)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ctxt.Post(cb, </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; System.Windows.Forms.</span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DoEvents();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Get the depth image size from the input depth image format.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%"> GetImageSize(</span><span style="color: #2b91af; line-height: 140%">DepthImageFormat</span><span style="line-height: 140%"> imageFormat)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">switch</span><span style="line-height: 140%"> (imageFormat)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DepthImageFormat</span><span style="line-height: 140%">.Resolution320x240Fps30:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(320, 240);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DepthImageFormat</span><span style="line-height: 140%">.Resolution640x480Fps30:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(640, 480);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DepthImageFormat</span><span style="line-height: 140%">.Resolution80x60Fps30:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(80, 60);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">throw</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ArgumentOutOfRangeException</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;imageFormat&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Get the color image size from the input color image format.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%"> GetImageSize(</span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%"> imageFormat)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">switch</span><span style="line-height: 140%"> (imageFormat)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.RgbResolution640x480Fps30:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(640, 480);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.RgbResolution1280x960Fps12:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(1280, 960);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.InfraredResolution640x480Fps30:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(640, 480);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.RawBayerResolution1280x960Fps12:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(1280, 960);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.RawBayerResolution640x480Fps30:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(640, 480);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.RawYuvResolution640x480Fps15:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(640, 480);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">case</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImageFormat</span><span style="line-height: 140%">.YuvResolution640x480Fps15:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%">(640, 480);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">throw</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ArgumentOutOfRangeException</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;imageFormat&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> StartSensor()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_kinect != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.Start();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.ElevationAngle = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.Stop();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%"> depthImageSize = GetImageSize(DepthFormat);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthWidth = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)depthImageSize.Width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthHeight = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)depthImageSize.Height;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Size</span><span style="line-height: 140%"> colorImageSize = GetImageSize(ColorFormat);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _colorWidth = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)colorImageSize.Width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _colorHeight = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)colorImageSize.Height;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.DepthStream.Enable(DepthFormat);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.ColorStream.Enable(ColorFormat);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _frameDataLength = _kinect.DepthStream.FramePixelDataLength;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthImagePixels = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DepthImagePixel</span><span style="line-height: 140%">[_frameDataLength];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Allocate a volume</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> volParam =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ReconstructionParameters</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _voxelsPerMeter,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_voxelsPerMeter * _roomWidth),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_voxelsPerMeter * _roomHeight),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_voxelsPerMeter * _roomLength)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _worldToCameraTransform = </span><span style="color: #2b91af; line-height: 140%">Matrix4</span><span style="line-height: 140%">.Identity;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ColorReconstruction</span><span style="line-height: 140%">.FusionCreateReconstruction(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; volParam, ProcessorType, DeviceToUse,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _worldToCameraTransform</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _defaultWorldToVolumeTransform =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.GetCurrentWorldToVolumeTransform();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_translateResetPoseByMinDepthThreshold)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ResetReconstruction();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">InvalidOperationException</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;Invalid operation: &quot;</span><span style="line-height: 140%"> + ex.Message);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">DllNotFoundException</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;DLL not found: &quot;</span><span style="line-height: 140%"> + ex.Message);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">ArgumentException</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;Invalid argument: &quot;</span><span style="line-height: 140%"> + ex.Message);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">OutOfMemoryException</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;Out of memory: &quot;</span><span style="line-height: 140%"> + ex.Message);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthFloatBuffer =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">FusionFloatImageFrame</span><span style="line-height: 140%">(_depthWidth, _depthHeight);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mappedColorFrame =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">FusionColorImageFrame</span><span style="line-height: 140%">(_depthWidth, _depthHeight);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> depthImageArraySize = _depthWidth * _depthHeight;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> colorImageArraySize =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _colorWidth * _colorHeight * </span><span style="color: blue; line-height: 140%">sizeof</span><span style="line-height: 140%">(</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthImagePixels =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DepthImagePixel</span><span style="line-height: 140%">[depthImageArraySize];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _colorImagePixels = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">byte</span><span style="line-height: 140%">[colorImageArraySize];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _colorCoordinates =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorImagePoint</span><span style="line-height: 140%">[depthImageArraySize];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mappedColorPixels = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">[depthImageArraySize];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> res = _voxelsPerMeter / _lowResStep;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResX = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomWidth * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResY = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomHeight * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResZ = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomLength * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destRes = destResX * destResY * destResZ;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _voxels = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">[destRes];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Initialize and start the FPS timer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _fpsTimer = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">DispatcherTimer</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _fpsTimer.Tick += </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EventHandler</span><span style="line-height: 140%">(FpsTimerTick);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _fpsTimer.Interval = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">TimeSpan</span><span style="line-height: 140%">(0, 0, FpsInterval);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _fpsTimer.Start();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _lastFPSTimestamp = </span><span style="color: #2b91af; line-height: 140%">DateTime</span><span style="line-height: 140%">.UtcNow;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Text style for our jig</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _style = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">TextStyle</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _style.Font =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">FontDescriptor</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;Calibri&quot;</span><span style="line-height: 140%">, </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">, </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">, 0, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _style.TextSize = 14;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.Start();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;\nUnable to start Kinect sensor - &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;are you sure it's plugged in?&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Handler for FPS timer tick</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> FpsTimerTick(</span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> sender, </span><span style="color: #2b91af; line-height: 140%">EventArgs</span><span style="line-height: 140%"> e)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Calculate time span from last calculation of FPS</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> intervalSeconds =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: #2b91af; line-height: 140%">DateTime</span><span style="line-height: 140%">.UtcNow - _lastFPSTimestamp).TotalSeconds;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Calculate and show fps on status bar</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _currentFps =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%">)(_processedFrameCount / intervalSeconds);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Reset frame counter</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _processedFrameCount = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _lastFPSTimestamp = </span><span style="color: #2b91af; line-height: 140%">DateTime</span><span style="line-height: 140%">.UtcNow;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> OnAllFramesReady(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> sender, </span><span style="color: #2b91af; line-height: 140%">AllFramesReadyEventArgs</span><span style="line-height: 140%"> e</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (!_processing &amp;&amp; !_finished)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> colorFrame = e.OpenColorImageFrame())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> != colorFrame)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Copy color pixels from the image to a buffer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; colorFrame.CopyPixelDataTo(_colorImagePixels);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> depthFrame = e.OpenDepthImageFrame())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (depthFrame != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Copy depth pixels to buffer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; depthFrame.CopyDepthImagePixelDataTo(_depthImagePixels);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Stop other processing from happening until the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// background processing of this frame has completed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _processing = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Process on a background thread</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Dispatcher</span><span style="line-height: 140%">.CurrentDispatcher.BeginInvoke(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">DispatcherPriority</span><span style="line-height: 140%">.Background,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="color: #2b91af; line-height: 140%">Action</span><span style="line-height: 140%">)(() =&gt; ProcessDepthData())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Process the depth input</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> ProcessDepthData()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_finished)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Convert the depth image frame to depth float image frame</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.DepthToDepthFloatFrame(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthImagePixels,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthFloatBuffer,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultMinimumDepth,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultMaximumDepth,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">false</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> trackingSucceeded = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> integrateColor =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _processedFrameCount % ColorIntegrationInterval == 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (integrateColor)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; MapColorToDepth();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; trackingSucceeded =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.ProcessFrame(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthFloatBuffer,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mappedColorFrame,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultAlignIterationCount,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultIntegrationWeight,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultColorIntegrationOfAllAngles,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.GetCurrentWorldToCameraTransform()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; trackingSucceeded =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.ProcessFrame(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthFloatBuffer,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultAlignIterationCount,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">FusionDepthProcessor</span><span style="line-height: 140%">.DefaultIntegrationWeight,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.GetCurrentWorldToCameraTransform()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (!trackingSucceeded)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _trackingErrors++;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; PostToAutoCAD(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; a =&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;\nTracking failure. Keep calm and carry on.&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (AutoResetReconstructionWhenLost)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot; ({0}/{1})&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _trackingErrors, MaxTrackingErrors</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot; {0}&quot;</span><span style="line-height: 140%">, _trackingErrors);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (!_lastTrackingAttemptSucceeded)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; PostToAutoCAD(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; a =&gt; _ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;\nWe're back on track!&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Set the camera pose and reset tracking errors</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _worldToCameraTransform =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.GetCurrentWorldToCameraTransform();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _trackingErrors = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _lastTrackingAttemptSucceeded = trackingSucceeded;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AutoResetReconstructionWhenLost &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; !trackingSucceeded &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _trackingErrors &gt;= MaxTrackingErrors</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; PostToAutoCAD(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; a =&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;\nReached error threshold: automatically resetting.&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vecs.Clear();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Console</span><span style="line-height: 140%">.Beep();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ResetReconstruction();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _points =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _useMesh ? GetPointCloud(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">) : GetPointCloud2(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ++_processedFrameCount;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">InvalidOperationException</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; PostToAutoCAD(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; a =&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;\nInvalid operation: {0}&quot;</span><span style="line-height: 140%">, ex.Message</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">finally</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// We can now let other processing happen</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _processing = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Process the color and depth inputs, converting the color into</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// the depth space</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">unsafe</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> MapColorToDepth()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> == _mapper)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create a coordinate mapper</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mapper = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">CoordinateMapper</span><span style="line-height: 140%">(_kinect);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _mapper.MapDepthFrameToColorFrame(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; DepthFormat,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthImagePixels,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ColorFormat,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _colorCoordinates</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Here we make use of unsafe code to just copy the whole</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// pixel as an int for performance reasons, as we do</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// not need access to the individual rgba components</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">fixed</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">byte</span><span style="line-height: 140%">* ptrColorPixels = _colorImagePixels)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">* rawColorPixels = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">*)ptrColorPixels;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Horizontal flip the color image as the standard depth</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// image is flipped internally in Kinect Fusion</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// to give a viewpoint as though from behind the Kinect</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// looking forward by default</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Parallel</span><span style="line-height: 140%">.For(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthHeight,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; y =&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> destIndex = y * _depthWidth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> flippedDestIndex = destIndex + (_depthWidth - 1);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> x = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; x &lt; _depthWidth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ++x, ++destIndex, --flippedDestIndex</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Calculate index into depth array</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> colorInDepthX = _colorCoordinates[destIndex].X;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> colorInDepthY = _colorCoordinates[destIndex].Y;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Make sure the depth pixel maps to a valid point</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// in color space</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; colorInDepthX &gt;= 0 &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; colorInDepthX &lt; _colorWidth &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; colorInDepthY &gt;= 0 &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; colorInDepthY &lt; _colorHeight &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthImagePixels[destIndex].Depth != 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Calculate index into color array- this will</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// perform a horizontal flip as well</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> sourceColorIndex =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; colorInDepthX + (colorInDepthY * _colorWidth);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Copy color pixel</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mappedColorPixels[flippedDestIndex] =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawColorPixels[sourceColorIndex];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mappedColorPixels[flippedDestIndex] = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _mappedColorFrame.CopyPixelDataFrom(_mappedColorPixels);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Reset the reconstruction to initial value</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> ResetReconstruction()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Reset tracking error counter</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _trackingErrors = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Set the world-view transform to identity, so the world</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// origin is the initial camera location.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _worldToCameraTransform = </span><span style="color: #2b91af; line-height: 140%">Matrix4</span><span style="line-height: 140%">.Identity;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_volume != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Translate the reconstruction volume location away from</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// the world origin by an amount equal to the minimum depth</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// threshold. This ensures that some depth signal falls</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// inside the volume. If set false, the default world origin</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// is set to the center of the front face of the volume,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// which has the effect of locating the volume directly in</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// front of the initial camera position with the +Z axis</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// into the volume along the initial camera direction of</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// view.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_translateResetPoseByMinDepthThreshold)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Matrix4</span><span style="line-height: 140%"> worldToVolumeTransform =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _defaultWorldToVolumeTransform;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Translate the volume in the Z axis by the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// minDepthThreshold distance</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">float</span><span style="line-height: 140%"> minDist =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (_minDepthClip &lt; _maxDepthClip) ?</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _minDepthClip :</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _maxDepthClip;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; worldToVolumeTransform.M43 -= minDist * _voxelsPerMeter;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.ResetReconstruction(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _worldToCameraTransform, worldToVolumeTransform</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.ResetReconstruction(_worldToCameraTransform);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%"> SamplerData()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_vecs.Count &gt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _points.Clear();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> vec </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> _vecs)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _points.Add(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(vec.X, vec.Y, vec.Z)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ForceMessage();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%">.OK;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> WorldDrawData(</span><span style="color: #2b91af; line-height: 140%">WorldDraw</span><span style="line-height: 140%"> draw)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> wg = draw.Geometry;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Push our transforms onto the stack</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; wg.PushOrientationTransform(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">OrientationBehavior</span><span style="line-height: 140%">.Screen</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; wg.PushPositionTransform(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">PositionBehavior</span><span style="line-height: 140%">.Screen,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point2d</span><span style="line-height: 140%">(30, 30)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Draw our screen-fixed text</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; wg.Text(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(0, 0, 0),&#160; </span><span style="color: green; line-height: 140%">// Position</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3d</span><span style="line-height: 140%">(0, 0, 1), </span><span style="color: green; line-height: 140%">// Normal</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Vector3d</span><span style="line-height: 140%">(1, 0, 0), </span><span style="color: green; line-height: 140%">// Direction</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">String</span><span style="line-height: 140%">.Format(</span><span style="color: #a31515; line-height: 140%">&quot;{0:F1} FPS&quot;</span><span style="line-height: 140%">, _currentFps), </span><span style="color: green; line-height: 140%">// Text</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Rawness</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _style&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// TextStyle</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Remember to pop our transforms off the stack</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; wg.PopModelTransform();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; wg.PopModelTransform();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">base</span><span style="line-height: 140%">.WorldDrawData(draw);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> AttachHandlers()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Attach the event handlers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_kinect != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.AllFramesReady +=</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EventHandler</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">AllFramesReadyEventArgs</span><span style="line-height: 140%">&gt;(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; OnAllFramesReady</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> RemoveHandlers()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Detach the event handlers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_kinect != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _kinect.AllFramesReady -=</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EventHandler</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">AllFramesReadyEventArgs</span><span style="line-height: 140%">&gt;(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; OnAllFramesReady</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorMesh</span><span style="line-height: 140%"> GetMesh()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> _volume.CalculateMesh(1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Get a point cloud from the vertices of a mesh</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// (would be better to access the volume info directly)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span><span style="line-height: 140%"> GetPointCloud(</span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> lowRes = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> m = _volume.CalculateMesh(lowRes ? _lowResStep : 1))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; m != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> ?</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">ColorUtils</span><span style="line-height: 140%">.Point3dFromVertCollection(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; m.GetVertices()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ) :</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt; GetColoredPointCloud(</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> step)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> m = _volume.CalculateMesh(step))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColorUtils</span><span style="line-height: 140%">.ColoredPoint3FromVertCollection(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; m.GetVertices(), m.GetColors()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Get a point cloud from the volume directly</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span><span style="line-height: 140%"> GetPointCloud2(</span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> lowRes = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> step = lowRes ? _lowResStep : 1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> res = (</span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%">)(_voxelsPerMeter / step);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResX = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomWidth * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResY = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomHeight * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResZ = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomLength * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destRes = destResX * destResY * destResZ;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> offx = _roomWidth / -2.0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> offy = _roomHeight / -2.0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> offz = 0.0; </span><span style="color: green; line-height: 140%">//_roomLength / -2.0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pts = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3dCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.ExportVolumeBlock(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0, 0, 0, destResX, destResY, destResZ, step, _voxels</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pitch = destResX;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> slice = destResY * pitch;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> x = 0; x &lt; destResX; x++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> y = 0; y &lt; destResY; y++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> z = 0; z &lt; destResZ; z++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> vox = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_voxels[z * slice + y * pitch + x]);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> v = (</span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%">)((vox | 0xFFFF) / 0xFFFF);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (v &gt; 0.0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pts.Add(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; x / res + offx,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; z / res + offz,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; -(y / res + offy)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> { }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> pts;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt; GetColoredPointCloud2(</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> step)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> res = (</span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%">)(_voxelsPerMeter / step);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResX = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomWidth * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResY = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomHeight * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destResZ = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)(_roomLength * res);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> destRes = destResX * destResY * destResZ;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> offx = _roomWidth / -2.0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> offy = _roomHeight / -2.0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> offz = 0.0; </span><span style="color: green; line-height: 140%">//_roomLength / -2.0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> voxels = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">short</span><span style="line-height: 140%">[destRes];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> colors = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">[destRes];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// This should return an array of voxels:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// these are currently all 0</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pts = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt;();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.ExportVolumeBlock(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0, 0, 0, destResX, destResY, destResZ, step, voxels, colors</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pitch = destResX;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> slice = destResY * pitch;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> x = 0; x &lt; destResX; x++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> y = 0; y &lt; destResY; y++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> z = 0; z &lt; destResZ; z++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> idx = z * slice + y * pitch + x;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> vox = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)voxels[idx];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> v = (</span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%">)((vox | 0xFFFF) / 0xFFFF);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (v &gt; 0.0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> col = colors[idx];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pts.Add(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; x / res + offx,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; z / res + offz,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; -(y / res + offy),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (col &gt;&gt; 16) &amp; 255,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (col &gt;&gt; 8) &amp; 255,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; col &amp; 255</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> { }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> pts;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> CleanUp()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> != _depthFloatBuffer)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthFloatBuffer.Dispose();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _depthFloatBuffer = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> != _mappedColorFrame)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mappedColorFrame.Dispose();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _mappedColorFrame = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> != _fpsTimer)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _fpsTimer.Stop();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _fpsTimer.Tick -= </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EventHandler</span><span style="line-height: 140%">(FpsTimerTick);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> != _volume)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume.Dispose();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _volume = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> != _style)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _style.Dispose();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _style = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">KinectFusionColorCommands</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> RoomWidth = 3;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> RoomHeight = 2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> RoomLength = 3;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> VoxelsPerMeter = 128;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> LowResStep = 4;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> UseMesh = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> _roomWidth = RoomWidth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> _roomLength = RoomLength;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">double</span><span style="line-height: 140%"> _roomHeight = RoomHeight;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _voxelsPerMeter = VoxelsPerMeter;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> _lowResStep = LowResStep;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> _useMesh = UseMesh;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="color: #2b91af; line-height: 140%">CommandMethod</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;ADNPLUGINS&quot;</span><span style="line-height: 140%">, </span><span style="color: #a31515; line-height: 140%">&quot;KINFUSCOL&quot;</span><span style="line-height: 140%">, </span><span style="color: #2b91af; line-height: 140%">CommandFlags</span><span style="line-height: 140%">.Modal)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> ImportFromKinectFusionWithColor()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Autodesk.AutoCAD.ApplicationServices.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Ask the user for double information</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pdo = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptDoubleOptions</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;\nEnter width of volume&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.AllowNegative = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.AllowZero = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.DefaultValue = _roomWidth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.UseDefaultValue = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pdr = ed.GetDouble(pdo);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pdr.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _roomWidth = pdr.Value;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.Message = </span><span style="color: #a31515; line-height: 140%">&quot;\nEnter length of volume&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.DefaultValue = _roomLength;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdr = ed.GetDouble(pdo);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pdr.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _roomLength = pdr.Value;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.Message = </span><span style="color: #a31515; line-height: 140%">&quot;\nEnter height of volume&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdo.DefaultValue = _roomHeight;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pdr = ed.GetDouble(pdo);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pdr.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _roomHeight = pdr.Value;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Ask the user for integer information</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pio =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptIntegerOptions</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;\nEnter voxels per meter&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pio.AllowNegative = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pio.AllowZero = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pio.DefaultValue = _voxelsPerMeter;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pio.UseDefaultValue = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pir = ed.GetInteger(pio);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pir.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _voxelsPerMeter = pir.Value;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pio.Message = </span><span style="color: #a31515; line-height: 140%">&quot;\nLow resolution sampling&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pio.DefaultValue = _lowResStep;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pir = ed.GetInteger(pio);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pir.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _lowResStep = pir.Value;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Ask the user for keyword information</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pko =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptKeywordOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;\nUse a mesh object to calculate points?&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pko.AllowNone = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pko.Keywords.Add(</span><span style="color: #a31515; line-height: 140%">&quot;Yes&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pko.Keywords.Add(</span><span style="color: #a31515; line-height: 140%">&quot;No&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pko.Keywords.Default = _useMesh ? </span><span style="color: #a31515; line-height: 140%">&quot;Yes&quot;</span><span style="line-height: 140%"> : </span><span style="color: #a31515; line-height: 140%">&quot;No&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pkr = ed.GetKeywords(pko);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pkr.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _useMesh = (pkr.StringResult == </span><span style="color: #a31515; line-height: 140%">&quot;Yes&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create a form to set the sync context properly</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> (</span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> f1 = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Form1</span><span style="line-height: 140%">())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> ctxt = </span><span style="color: #2b91af; line-height: 140%">SynchronizationContext</span><span style="line-height: 140%">.Current;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ctxt == </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">throw</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> System.</span><span style="color: #2b91af; line-height: 140%">Exception</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;Current sync context is null.&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: green; line-height: 140%">// Create our jig</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> kj =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">KinectFusionColorJig</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed, ctxt,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _roomWidth, _roomLength, _roomHeight,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _voxelsPerMeter, _lowResStep, _useMesh</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (!kj.StartSensor())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.StopSensor();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.CleanUp();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pr = ed.Drag(kj);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK &amp;&amp; !kj.Finished)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.StopSensor();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.CleanUp();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.PauseSensor();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;\nCapture complete: examining points...\n&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Windows.Forms.</span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DoEvents();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> voxelStep = 1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> loop = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">, cancel = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #2b91af; line-height: 140%">List</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ColoredPoint3d</span><span style="line-height: 140%">&gt; pts;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">do</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; loop = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pts =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _useMesh ?</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.GetColoredPointCloud(voxelStep) :</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.GetColoredPointCloud2(voxelStep);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;Extracted mesh data: {0} vertices with&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot; voxel step of {1}.\n&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pts.Count, voxelStep</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pio2 =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptIntegerOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: #a31515; line-height: 140%">&quot;Enter new voxel step or accept default to continue&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pio2.AllowNegative = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pio2.AllowZero = </span><span style="color: blue; line-height: 140%">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pio2.DefaultValue = voxelStep;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">var</span><span style="line-height: 140%"> pir2 = ed.GetInteger(pio2);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pir2.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cancel = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">else</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pir2.Status == </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pir2.Value != voxelStep</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; voxelStep = pir2.Value;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; loop = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </span><span style="color: blue; line-height: 140%">while</span><span style="line-height: 140%"> (loop);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (!cancel)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.WriteAndImportPointCloud(doc, pts);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; line-height: 140%">catch</span><span style="line-height: 140%"> (System.</span><span style="color: #2b91af; line-height: 140%">Exception</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;\nException: {0}&quot;</span><span style="line-height: 140%">, ex.Message);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.StopSensor();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; kj.CleanUp();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px"></p> </div>
