---
layout: "post"
title: "Finally working with the Async CTP for VS 2010"
date: "2011-06-27 11:12:14"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Concurrent programming"
  - "F#"
  - "Point clouds"
  - "Visual Studio"
original_url: "https://www.keanw.com/2011/06/finally-working-with-the-async-ctp-for-vs-2010.html "
typepad_basename: "finally-working-with-the-async-ctp-for-vs-2010"
typepad_status: "Publish"
---

<p>I’ve been planning to look at it for ages – and have certainly mentioned it before – but other things have kept on cropping up. Well last Thursday, on my train trip back from <a href="http://en.wikipedia.org/wiki/Wallisellen" target="_blank">Wallisellen</a> (the home of <a href="http://www.microsoft.com/fr/ch/default.aspx" target="_blank">Microsoft Switzerland</a>), I finally managed to take the plunge and start working with the <a href="http://msdn.com/async" target="_blank">Async CTP for Visual Studio 2010</a>. I’d been in Wallisellen to attend an MSDN TechTalk presentation by Stephen Toub, Principal Architect on Microsoft’s Parallel Computing Platform team. I’ve followed Stephen via <a href="http://blogs.msdn.com/toub" target="_blank">his blog</a> – and <a href="http://blogs.msdn.com/pfxteam" target="_blank">the Parallel Programming with .NET blog</a> – for a long time, and thought it’d be a great opportunity to see him present in person (especially as such events in Switzerland tend to be quite intimate affairs – a great opportunity to have your questions answered).</p>  <p>I wasn’t disappointed: Stephen really (and I mean <u>really</u>) knows his stuff, and I left the seminar inspired and itching to try some things out with the Async CTP. I can only hope that developers working with Autodesk technology get the same feeling when leaving one of my presentations (it’s certainly a goal worth striving for, at least).</p>  <p>The ability to make asynchronous function calls easily is going to really significant for developers in .NET 5: I’ve been using <a href="http://en.wikipedia.org/wiki/F_Sharp_(programming_language)" target="_blank">F#</a>’s excellent Asynchronous Workflows capability to do that, before – getting <a href="http://through-the-interface.typepad.com/through_the_interface/2010/11/au-2010-handout-integrate-f-into-your-c-or-vbnet-application-for-an-8x-performance-boost.html" target="_blank">significant speed-ups on sequential/synchronous code</a> – but having the capability integrated directly into the .NET Framework makes it even simpler for such a use-case (where there’s an existing C# or VB.NET codebase). The basic premise is simple enough: when you call a synchronous method to get data over the wire (in particular, although you also get delays from accessing local storage) you have to wait for the results to come back. And if you’re getting multiple files and processing each one, you’re going to have significant overhead in your processing loop. The fact that synchronous calls block your UI is also significant: ideally you want to at least have the UI repaint – and probably show a progress bar – during such operations, rather than just going grey and showing the “Not responding” message in the application’s title bar.</p>  <p>Until now, asynchronous calls were typically handled by separate threads and lots of manual coordination code: you typically wrap your code up into a delegate and attach it to an event called on completion of asynchronous method (basically a very manual <a href="http://en.wikipedia.org/wiki/Continuation-passing_style" target="_blank">continuation passing</a> mechanism), which makes for messy, messy code.</p>  <p>The Async CTP (and presumably the same will be true of .NET 5) does all this under the covers: whenever you use the “await” keyword to wait for the results of an asynchronous call, execution continues in the outer, calling function – so it can continue to iterate through a loop, for instance – and the remaining code after the asynchronous call will get executed once the method returns. And that code will execute by default on the UI thread, which means you can update AutoCAD’s UI without having to implement any special coordination capability (in F# I <a href="http://through-the-interface.typepad.com/through_the_interface/2009/11/using-erlang-style-message-passing-from-f-to-coordinate-asynchronous-tasks-in-autocad.html" target="_blank">used a MailboxProcessor for this</a>).</p>  <p>Which means that you can literally take synchronous code and add a few keywords (a combination of <em>async</em> and <em>await</em>) – and change your method calls to the usually-also-available Async versions – and the code will speed up significantly. You not only stop your code from blocking while waiting for asynchronous calls to complete, you make more efficient use of your CPU(s) as the work gets spread across whatever cores are available. And all this with minimal changes to your application’s code. Too cool!</p>  <p>For now there are a few extra steps – such as adding a project reference to <em>AsyncCtpLibrary.dll</em>, which contains (no doubt among other things) asynchronous extension methods on System.Net.WebClient such as DownloadFileTaskAsync(), which creates an asynchronous task for which you can await completion – but these will disappear once the capabilities are integrated into the core .NET Framework. The steps for using the CTP are in <a href="http://msdn.microsoft.com/en-us/gg440604.aspx" target="_blank">this migration guide</a>, which is well worth a look.</p>  <p>I went through the process for my BrowsePhotosynth application, which previous had three modes of operation: C# Synchronous, F# Synchronous and F# Asynchronous. It was really easy to add C# Asynchronous into the mix using the CTP.</p>  <p>Here’s the new source file, with the lines where it differs from the original synchronous version in <font color="#ff0000">red</font>:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 1</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 2</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 3</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160;&#160; 4</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Threading.Tasks;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 5</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Net;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 6</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.IO;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 7</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 8</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160;&#160; 9</span>&#160;<span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> PhotosynthProcAsyncCs</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 10</span>&#160;<span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 11</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PointCloudProcessor</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 12</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 13</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> _ed;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 14</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ProgressMeter</span><span style="line-height: 140%"> _pm;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 15</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> _localPath;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 16</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 17</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> PointCloudProcessor(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 18</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed, </span><span style="line-height: 140%; color: #2b91af">ProgressMeter</span><span style="line-height: 140%"> pm, </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> localPath</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 19</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 20</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 21</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ed = ed;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 22</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _pm = pm;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 23</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _localPath = localPath;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 24</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 25</span>&#160;</p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 26</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">async</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Task</span><span style="line-height: 140%">&lt;</span><span style="line-height: 140%; color: blue">long</span><span style="line-height: 140%">&gt; ProcessPointCloud(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 27</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> path, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">[] dims, </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> txtPath</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 28</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 29</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 30</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Counter for the total number of points</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 31</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 32</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">long</span><span style="line-height: 140%"> totalPoints = 0;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 33</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 34</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create our intermediate text file in the temp folder</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 35</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 36</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">FileInfo</span><span style="line-height: 140%"> t = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">FileInfo</span><span style="line-height: 140%">(txtPath);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 37</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">StreamWriter</span><span style="line-height: 140%"> sw = t.CreateText();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 38</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (sw)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 39</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 40</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We'll use a web client to download each .bin file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 41</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 42</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">WebClient</span><span style="line-height: 140%"> wc = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">WebClient</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 43</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (wc)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 44</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 45</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> maj=0; maj &lt; dims.Length; maj++)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 46</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 47</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> min=0; min &lt; dims[maj]; min++)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 48</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 49</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Loop for each .bin file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 50</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 51</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> root =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 52</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; maj.ToString() + </span><span style="line-height: 140%; color: #a31515">&quot;_&quot;</span><span style="line-height: 140%"> + min.ToString() + </span><span style="line-height: 140%; color: #a31515">&quot;.bin&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 53</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> src = path + root;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 54</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> loc = _localPath + root;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 55</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 56</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 57</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: red">&#160;&#160; 58</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">await</span><span style="line-height: 140%"> wc.DownloadFileTaskAsync(src, loc);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 59</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 60</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">catch</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 61</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 62</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 63</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 64</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 65</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Exists(loc))</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 66</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 67</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Open our binary file for reading</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 68</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 69</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 70</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 71</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Open(loc, </span><span style="line-height: 140%; color: #2b91af">FileMode</span><span style="line-height: 140%">.Open)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 72</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 73</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (br)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 74</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 75</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 76</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 77</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// First information is the file version</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 78</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (for now we support version 1.0 only)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 79</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 80</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">ushort</span><span style="line-height: 140%"> majVer = ReadBigEndianShort(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 81</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">ushort</span><span style="line-height: 140%"> minVer = ReadBigEndianShort(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 82</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 83</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (majVer != 1 || minVer != 0)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 84</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 85</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 86</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nCannot read a Photosynth point &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 87</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;cloud of this version ({0}.{1}).&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 88</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; majVer, minVer</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 89</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 90</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 91</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 92</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 93</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Clear some header bytes we don't use</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 94</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 95</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> n = ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 96</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i = 0; i &lt; n; i++)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 97</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 98</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> m = ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 99</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 100</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> j = 0; j &lt; m; j++)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 101</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 102</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 103</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 104</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 105</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 106</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 107</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Find the number of points in the file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 108</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 109</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> numPoints = ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 110</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; totalPoints += numPoints;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 111</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 112</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 113</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nProcessed points_{0} containing {1} &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 114</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;points.&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 115</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; root, numPoints</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 116</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 117</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 118</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> k = 0; k &lt; numPoints; k++)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 119</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 120</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Read our coordinates</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 121</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 122</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> x = ReadBigEndianFloat(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 123</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> y = ReadBigEndianFloat(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 124</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> z = ReadBigEndianFloat(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 125</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 126</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Read and extract our RGB values</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 127</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 128</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">UInt16</span><span style="line-height: 140%"> rgb = ReadBigEndianShort(br);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 129</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 130</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> r = (rgb &gt;&gt; 11) * 255 / 31;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 131</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> g = ((rgb &gt;&gt; 5) &amp; 63) * 255 / 63;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 132</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> b = (rgb &amp; 31) * 255 / 31;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 133</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 134</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Write the point with its color to file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 135</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 136</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sw.WriteLine(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 137</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;{0},{1},{2},{3},{4},{5}&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 138</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; x, y, z, r, g, b</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 139</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 140</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 141</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 142</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">catch</span><span style="line-height: 140%"> (System.</span><span style="line-height: 140%; color: #2b91af">Exception</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 143</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 144</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 145</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nError processing point cloud file &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 146</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\&quot;points_{0}\&quot;: {1}&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 147</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; root, ex.Message</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 148</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 149</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 150</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 151</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 152</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Delete our local .bin file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 153</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 154</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Delete(loc);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 155</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 156</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Show some progress</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 157</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 158</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _pm.MeterProgress();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 159</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Windows.Forms.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DoEvents();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 160</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 161</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 162</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; PhotosynthImporter.</span><span style="line-height: 140%; color: #2b91af">Commands</span><span style="line-height: 140%">.CheckEscape(_ed)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 163</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 164</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 165</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 166</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 167</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 168</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 169</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 170</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 171</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 172</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> totalPoints;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 173</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 174</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 175</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> ReadCompressedInt(</span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 176</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 177</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i = 0;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 178</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%"> b;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 179</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 180</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">do</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 181</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 182</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; b = br.ReadByte();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 183</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; i = (i &lt;&lt; 7) | (b &amp; 127);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 184</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 185</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> (b &lt; 128);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 186</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 187</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> i;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 188</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 189</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 190</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> ReadBigEndianFloat(</span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 191</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 192</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%">[] b = br.ReadBytes(4);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 193</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">BitConverter</span><span style="line-height: 140%">.ToSingle(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 194</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%">[] { b[3], b[2], b[1], b[0] },</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 195</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 196</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 197</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 198</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 199</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">UInt16</span><span style="line-height: 140%"> ReadBigEndianShort(</span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 200</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 201</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%"> b1 = br.ReadByte();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 202</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%"> b2 = br.ReadByte();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 203</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 204</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">ushort</span><span style="line-height: 140%">)(b2 | (b1 &lt;&lt; 8));</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 205</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 206</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 207</span>&#160;<span style="line-height: 140%">}</span></p> </div>  <p>The calling code also ended up being very similar to the C# Synchronous implementation – the only difference being we receive a Task&lt;long&gt; back rather than a long (hopefully it’s also safe to just extract the Result from the Task – at least it worked well in my various tests):</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">PhotosynthProcAsyncCs.</span><span style="line-height: 140%; color: #2b91af">PointCloudProcessor</span><span style="line-height: 140%"> pcp =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> PhotosynthProcAsyncCs.</span><span style="line-height: 140%; color: #2b91af">PointCloudProcessor</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ed, pm, localPath</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">System.Threading.Tasks.</span><span style="line-height: 140%; color: #2b91af">Task</span><span style="line-height: 140%">&lt;</span><span style="line-height: 140%; color: blue">long</span><span style="line-height: 140%">&gt; task =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pcp.ProcessPointCloud(path, dims, txtPath);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">totalPts = task.Result;</span></p> </div>  <p>I know I’ll get asked whether I still prefer F# Asynchronous Workflows to the Async CTP capabilities. On the one hand, I certainly like the purity of describing tasks in F#’s more declarative style – this definitely appeals to me – but on the other hand (which must be the more pragmatic of the two :-) the fact you can integrate this capability with so few modified lines of C# code is astonishing. I’ll definitely keep space in my toolbox for both approaches.</p>  <p>In terms of performance, the C# Asynchronous implementation is equivalent to F# Asynchronous (and both are 8-10X quicker than their synchronous siblings, for this particular implementation scenario). I think I’m going to put together a quick screen-cam video to show this in action. I’ll hopefully post something in the next few days.</p>
