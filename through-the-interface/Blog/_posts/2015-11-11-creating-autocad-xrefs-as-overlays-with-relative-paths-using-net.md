---
layout: "post"
title: "Creating AutoCAD Xrefs as overlays with relative paths using .NET"
date: "2015-11-11 14:43:34"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Blocks"
  - "Drawing structure"
original_url: "https://www.keanw.com/2015/11/creating-autocad-xrefs-as-overlays-with-relative-paths-using-net.html "
typepad_basename: "creating-autocad-xrefs-as-overlays-with-relative-paths-using-net"
typepad_status: "Publish"
---

<p>After showing <a href="http://through-the-interface.typepad.com/through_the_interface/2015/11/attaching-autocad-xrefs-and-inserting-them-at-the-origin-using-net.html" target="_blank">how to automatically attach xrefs at the origin</a> inside AutoCAD, and then <a href="http://through-the-interface.typepad.com/through_the_interface/2015/11/converting-units-between-different-autocad-drawings-using-net.html" target="_blank">redoing the approach to take care of different unit systems</a>, I then had the request from a couple of places to look at making the xrefs overlays and adjusting their paths to be relative rather than absolute.</p>  <p>Looking around, I found <a href="http://adndevblog.typepad.com/autocad/2012/06/use-the-converter-class-to-format-distances-and-angles.html" target="_blank">some code on the AutoCAD DevBlog</a> that changes an attachment to an overlay, after the fact. Henrik Ericson found the code didn’t work for him, but did spot the db.OverlayXref() method which did. So I went ahead and made use of that for overlays. I factored out the logic into a single helper method which I now call from two commands: XAO for attachments and XOO for overlays.</p>  <p>For relative paths, I ended up making a couple of extension methods based on <a href="http://adndevblog.typepad.com/autocad/2012/07/changing-xref-paths-from-absolute-to-relative.html" target="_blank">this DevBlog post</a> and <a href="http://stackoverflow.com/questions/703281/getting-path-relative-to-the-current-working-directory" target="_blank">this one on Stack Overflow</a>. I also threw in a simple helper class that makes sure an object is upgraded to being open for write for the duration of its existence. I could also have required the object to be open for write in the first place, but I felt like seeing if the approach worked.</p>  <p>Here’s the updated code with the XAO and XOO commands. Both now use relative paths by default.</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Geometry;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.IO;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> XrefAttachAtZero</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#0160; <span style="color: green">// Simple helper to make sure an object is &quot;open for write&quot;, downgrading</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// its open status when finished. It&#39;s intended to be used in the same way</span></p>    <p style="margin: 0px">&#0160; <span style="color: green">// as a document lock from a using() statement.</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Upgrader</span> : <span style="color: #2b91af">IDisposable</span></p>    <p style="margin: 0px">&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">private</span> <span style="color: blue">bool</span> _upgraded;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">private</span> <span style="color: #2b91af">DBObject</span> _object;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> Upgrader(<span style="color: #2b91af">DBObject</span> o)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _object = o;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; _upgraded = o.IsReadEnabled;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_upgraded)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; o.UpgradeOpen();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; Dispose(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">GC</span>.SuppressFinalize(<span style="color: blue">this</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> Dispose(<span style="color: blue">bool</span> disposing)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (disposing) </p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (_upgraded &amp;&amp; _object != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _object.DowngradeOpen();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _object = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">class</span> <span style="color: #2b91af">Extensions</span></p>    <p style="margin: 0px">&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> Generates a relative path from one string to another.</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;to&quot;&gt;</span><span style="color: green">The path to which to return a relative path.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">The relative path between this one and the destination.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">string</span> RelativePathTo(<span style="color: blue">this</span> <span style="color: blue">string</span> from, <span style="color: blue">string</span> to)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> fromUri = <span style="color: blue">new</span> <span style="color: #2b91af">Uri</span>(from);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> toUri = <span style="color: blue">new</span> <span style="color: #2b91af">Uri</span>(to);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Convert to URIs for the sake of the relative path determination</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> relUri = fromUri.MakeRelativeUri(toUri);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> relPath = <span style="color: #2b91af">Uri</span>.UnescapeDataString(relUri.ToString());</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Then change back</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> relPath.Replace(<span style="color: #a31515">&#39;/&#39;</span>, <span style="color: #2b91af">Path</span>.DirectorySeparatorChar);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> Changes the path of an xref&#39;s block definition to have a relative path.</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;root&quot;&gt;</span><span style="color: green">Path from which to create the relative path.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">Whether the path was changed - only fails for non-xrefs.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> ChangePathToRelative(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">this</span> <span style="color: #2b91af">BlockTableRecord</span> btr, <span style="color: blue">string</span> root</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; )</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> ret = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (btr.IsFromExternalReference)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">using</span> (<span style="color: blue">new</span> <span style="color: #2b91af">Upgrader</span>(btr))</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; btr.PathName = root.RelativePathTo(btr.PathName);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ret = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> ret;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> Attaches the specified Xref to the current space in the current drawing.</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;path&quot;&gt;</span><span style="color: green">Path to the drawing file to attach as an Xref.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;pos&quot;&gt;</span><span style="color: green">Position of Xref in WCS coordinates.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;name&quot;&gt;</span><span style="color: green">Optional name for the Xref.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">Whether the attach operation succeeded.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> XrefAttachAndInsert(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">this</span> <span style="color: #2b91af">Database</span> db, <span style="color: blue">string</span> path, <span style="color: #2b91af">Point3d</span> pos,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">string</span> name = <span style="color: blue">null</span>, <span style="color: blue">bool</span> overlay = <span style="color: blue">false</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160; )</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> ret = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (!<span style="color: #2b91af">File</span>.Exists(path))</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> ret;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (<span style="color: #2b91af">String</span>.IsNullOrEmpty(name))</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; name = <span style="color: #2b91af">Path</span>.GetFileNameWithoutExtension(path);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// We&#39;ll collect any xref definitions that need reloading after our</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// transaction (there should be at most one)</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> xIds = <span style="color: blue">new</span> <span style="color: #2b91af">ObjectIdCollection</span>();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">try</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">using</span> (<span style="color: blue">var</span> tr = db.TransactionManager.StartOpenCloseTransaction())</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Attach or overlay the Xref - add it to the database&#39;s block table</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> xId =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; overlay ? db.OverlayXref(path, name) : db.AttachXref(path, name);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (xId.IsValid)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Open the newly created block, so we can get its units</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> xbtr = (<span style="color: #2b91af">BlockTableRecord</span>)tr.GetObject(xId, <span style="color: #2b91af">OpenMode</span>.ForRead);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Get the path of the current drawing</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> loc = <span style="color: #2b91af">Path</span>.GetDirectoryName(db.Filename);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (xbtr.ChangePathToRelative(loc))</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; xIds.Add(xId);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Determine the unit conversion between the xref and the target</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// database</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> sf = <span style="color: #2b91af">UnitsConverter</span>.GetConversionFactor(xbtr.Units, db.Insunits);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Create the block reference and scale it accordingly</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> br = <span style="color: blue">new</span> <span style="color: #2b91af">BlockReference</span>(pos, xId);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; br.ScaleFactors = <span style="color: blue">new</span> <span style="color: #2b91af">Scale3d</span>(sf);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Add the block reference to the current space and the transaction</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> btr =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (<span style="color: #2b91af">BlockTableRecord</span>)tr.GetObject(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.CurrentSpaceId, <span style="color: #2b91af">OpenMode</span>.ForWrite</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; btr.AppendEntity(br);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(br, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ret = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.Commit();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// If we modified our xref&#39;s path, let&#39;s reload it</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (xIds.Count &gt; 0)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.ReloadXrefs(xIds);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">catch</span> (Autodesk.AutoCAD.Runtime.<span style="color: #2b91af">Exception</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; { }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span> ret;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160; <span style="color: blue">public static</span> <span style="color: blue">class</span> <span style="color: #2b91af">Commands</span></p>    <p style="margin: 0px">&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;XAO&quot;</span>)]</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> XrefAttachAtOrigin()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; XrefAttachOrOverlayAtOrigin();</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;XOO&quot;</span>)]</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> XrefOverlayAtOrigin()</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; XrefAttachOrOverlayAtOrigin(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">void</span> XrefAttachOrOverlayAtOrigin(<span style="color: blue">bool</span> overlay = <span style="color: blue">false</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> db = doc.Database;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> ed = doc.Editor;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Ask the user to specify a file to attach</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> opts = <span style="color: blue">new</span> <span style="color: #2b91af">PromptOpenFileOptions</span>(<span style="color: #a31515">&quot;Select Reference File&quot;</span>);</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; opts.Filter = <span style="color: #a31515">&quot;Drawing (*.dwg)|*.dwg&quot;</span>;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> pr = ed.GetFileNameForOpen(opts);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">if</span> (pr.Status == <span style="color: #2b91af">PromptStatus</span>.OK)</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; {</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: green">// Overlay the specified file and insert it at the origin</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: blue">var</span> res =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.XrefAttachAndInsert(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pr.StringResult, <span style="color: #2b91af">Point3d</span>.Origin, <span style="color: blue">null</span>, overlay</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.WriteMessage(</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&quot;External reference {0}{1} at the origin.&quot;</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; res ? <span style="color: #a31515">&quot;&quot;</span> : <span style="color: #a31515">&quot;not &quot;</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; overlay ? <span style="color: #a31515">&quot;overlaid&quot;</span> : <span style="color: #a31515">&quot;attached&quot;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; }</p>    <p style="margin: 0px">&#0160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p> </div>  <p>Here’s the XOO command in action. We check the created xref using the XOO command, right afterwards.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c7eac1ec970b-pi"><img alt="Overlay xref with relative path" height="516" src="/assets/image_803474.jpg" style="float: none; margin: 50px auto; display: block" title="Overlay xref with relative path" width="508" /></a></p>  <p>I like the way the code has evolved during this series from something almost ridiculously simplistic to being much more useable. Please post a comment if you see something else that needs adding!</p>
