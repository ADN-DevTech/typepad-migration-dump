---
layout: "post"
title: "Knowing when operations are complete in the Forge viewer"
date: "2020-03-06 16:03:19"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk Research"
  - "IoT"
original_url: "https://www.keanw.com/2020/03/knowing-when-operations-are-complete-in-the-forge-viewer.html "
typepad_basename: "knowing-when-operations-are-complete-in-the-forge-viewer"
typepad_status: "Publish"
---

<p>We have a feature in Dasher called “kiosk mode”. It basically takes control of the browser to run a sequence of operations that show people how Dasher works. I published a <a href="https://www.keanw.com/2017/03/implementing-a-demo-mode-inside-the-forge-viewer-part-1.html" target="_blank">series</a> <a href="https://www.keanw.com/2017/03/implementing-a-demo-mode-inside-the-forge-viewer-part-2.html" target="_blank">of</a> <a href="https://www.keanw.com/2017/03/implementing-a-demo-mode-inside-the-forge-viewer-part-3.html" target="_blank">posts</a> a couple of years ago that explain a bit about how we implemented it.</p><p>One of the issues in kiosk mode is knowing when Forge viewer operations – such as view transitions or state restorations – are complete. Until recently the code just checked the viewer’s <font face="Courier New">progressbar</font> property, to see whether its value was close to 100 or not. This wasn’t ever a very good approach, because the progress bar is used multiple times when re-rendering a view of a model, especially when applying ground shadows or reflections. But it worked well enough because we could start the next operation in our sequence of features to show off even if the rendering was underway. Lately, though, I’ve found it isn’t working well, probably because the relative time it takes to perform certain operations has changed. So anyway, I started looking for another way of waiting for the viewer to be in “idle” state (a term we use a lot in desktop tools such as AutoCAD and Revit).</p><p>I came across two pointers to <font face="Courier New">Autodesk.Viewing.FINAL_FRAME_RENDERED_CHANGED_EVENT</font>, an event that’s fired by the Forge viewer when the very last frame of an animated sequence (such as a view transition) has been rendered. The first was by Jan Liska on an internal Slack discussion; on Googling it I found that Adam Nagy had mentioned it in <a href="https://forge.autodesk.com/blog/wait-restorestate-finish" target="_blank">a blog post on the Forge blog with respect to viewer state restoration</a>. Anyway, it turned out to be exactly what we needed (thanks, Jan and Adam!). Kiosk mode now waits a little longer between operations, but it does now show features off more effectively. Definitely a positive change. If you need to find out when things have completed inside the Forge viewer, be sure to check out this event and the code in Adam’s post.</p><p>On a largely unrelated note, I’ve been using the downtime imposed by Covid-19 event cancellation to work on getting our new timeline component integrated into Dasher. For a while I found that it was behaving poorly inside kiosk mode – which had me looking into how I can control target framerates in Pixi.js-based components – but I then realised it was my own fault: when integrating the new timeline I’d mistakenly wired it up to our old “playback manager” code that tries to control the timeline’s playback, inadvertently competing with the timeline’s own built-in playback management.</p><p>Once I’d disabled the old playback manager things started working super-smoothly. Here’s an animation of various time-series graphs – and some surface-shading – being animated at 16x via the new timeline:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a4ef28de200d-pi" target="_blank"><img width="500" height="312" title="16x playback" style="margin: 30px auto; float: none; display: block;" alt="16x playback" src="/assets/image_29553.jpg"></a></p><p>The timeline still has a few kinks we need to iron out before we can push it live, but it’s looking really promising. I’ll for sure post again once we have something people can take for a spin and give us feedback on.</p>
