---
layout: "post"
title: "Implementing tooltips for individual points in a point cloud in the Forge viewer"
date: "2017-01-26 19:51:33"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk"
  - "Autodesk Research"
  - "IoT"
  - "JavaScript"
  - "Point clouds"
  - "User interface"
original_url: "https://www.keanw.com/2017/01/implementing-tooltips-for-individual-points-in-a-point-cloud-in-the-forge-viewer.html "
typepad_basename: "implementing-tooltips-for-individual-points-in-a-point-cloud-in-the-forge-viewer"
typepad_status: "Publish"
---

<p>In <a href="http://through-the-interface.typepad.com/through_the_interface/2017/01/optimizing-dasher-360-using-a-point-cloud-to-display-sensor-markers.html" target="_blank">the last post</a> we talked about a recent optimization to Dasher 360, where we implemented a point cloud rather than individual SVG-based markers for our various sensors. As mentioned, last time, this was pretty straightforward to get working, but did add some complexity: rather than having seperate DOM-resident markers – which can easily have separate tooltips assigned – we now have a single object and need to be able to display tooltips when individual points in the cloud are hovered over.</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c8ce7de6970b-pi" target="_blank"><img title="A tooltip on our sensor point cloud un Dasher 360" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 30px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="A tooltip on our sensor point cloud un Dasher 360" src="/assets/image_255047.jpg" width="438" height="281"></a></p> <p>Here’s the basic algorithm we used to determine when an individual sensor was being hovered over:</p> <ol> <li>Implement a ‘mousemove’ event listener on the viewer’s container. The rest of this algorithm is executed on mouse move.  <li>Check whether the cursor is on a UI element (see below for more details on this).  <li>Fire a ray along the camera direction (there’s code for this you can find in the Forge viewer .js file).  <li>Check for intersections with our point cloud.  <li>If there are hits, filter out any that aren’t visible.  <li>Sort the remaining hits by distance from the camera.  <li>Get the closest point to the camera. Change its colour to your hover colour.  <li>Get the screen point of its world coordinates and then use this as the location for the tooltip.</li></ol> <p>We use <a href="http://iamceege.github.io/tooltipster/" target="_blank">tooltipster</a> to display tooltips, but there are various other JavaScript tooltip libraries out there.</p> <p>For the 2nd step: when I first looked at this, I realised I could iterate through the UI panels and check their various client coordinates. The below is in TypeScript, but that really only means the function signature – the rest is pure JavaScript. </p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px">cursorOnPanel(x: number, y: number): Boolean {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">let</span> panels = <span style="color: blue">this</span>.viewer.dockingPanels;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: green">// Panels may not be present when dealing with an instance of Viewer3D.js</span></p> <p style="margin: 0px">&nbsp; <span style="color: green">// (as opposed to an instance of GuiViewer3D.js)</span></p> <p style="margin: 0px">&nbsp; <span style="color: blue">if</span> (!panels) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">for</span> (<span style="color: blue">let</span> i = 0; i &lt; panels.length; ++i) {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> panel = panels[i];</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">let</span> cont = panel.container;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (cont.clientWidth &gt; 0 &amp;&amp; cont.clientHeight &gt; 0) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x &gt;= cont.offsetLeft &amp;&amp; x &lt;= cont.offsetLeft + cont.offsetWidth &amp;&amp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; y &gt;= cont.offsetTop &amp;&amp; y &lt;= cont.offsetTop + cont.offsetHeight</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>When I first ran this code, it didn’t include our custom dialogs. It was then that I realised we hadn’t been calling viewer.addPanel() for these dialogs. This is well worth doing and not only for the above code to include them: if they’ve been added to the viewer then as the viewer gets resized the dialogs will get moved to stay inside the viewer’s extents. Very handy.</p> <p>In an internal discussion resident JavaScript guru, Philippe Leefsma, suggested an alternative approach. He mentioned document.elementFromPoint(), which allowed me to simplify the code somewhat. Now we only return false if the cursor isn’t over the canvas.</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px">cursorOnPanel(x: number, y: number): Boolean {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">let</span> elem = document.elementFromPoint(x, y);</p> <p style="margin: 0px">&nbsp; <span style="color: blue">if</span> (elem &amp;&amp; elem.localName === <span style="color: #a31515">'canvas'</span>) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>I suppose this could even be reduced to this, albeit at the expense of readability.</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px">cursorOnPanel(x: number, y: number): Boolean {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">let</span> elem = document.elementFromPoint(x, y);</p> <p style="margin: 0px">&nbsp; <span style="color: blue">return</span> !(elem &amp;&amp; elem.localName === <span style="color: #a31515">'canvas'</span>);</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>The code seems to work well. There are lots of situations where people will want to use THREE.js point clouds to display large numbers of markers, such as this, so at some point we’ll try to package this into a more reusable extension for the Forge viewer.</p>
