---
layout: "post"
title: "Using Erlang-style message passing from F# to coordinate asynchronous tasks in AutoCAD"
date: "2009-11-26 18:01:38"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Concurrent programming"
  - "F#"
original_url: "https://www.keanw.com/2009/11/using-erlang-style-message-passing-from-f-to-coordinate-asynchronous-tasks-in-autocad.html "
typepad_basename: "using-erlang-style-message-passing-from-f-to-coordinate-asynchronous-tasks-in-autocad"
typepad_status: "Publish"
---

<p>This is something I’ve been meaning to attempt for a while, and have finally been spurred to do it by <a href="http://through-the-interface.typepad.com/through_the_interface/2009/10/au-2009-attend-one-of-my-sessions-from-the-comfort-of-your-armchair.html">next week’s AU Virtual session on F#</a>. Not that I expect to have time to present this during the session (60 minutes is already feeling way too short for the material I want to cover), but I at least wanted to have this working so I could present with a touch more authority. :-)</p>  <p>In <a href="http://through-the-interface.typepad.com/through_the_interface/2008/10/au-handouts-a-1.html">last year’s session</a> we used <a href="http://through-the-interface.typepad.com/through_the_interface/2008/01/harnessing-f-as.html">Asynchronous Workflows</a> to improve the performance of IO-bound operations, such as retrieving multiple RSS feeds and displaying the results in AutoCAD. Asynchronous Workflows works very well for coordinating such tasks, but the mechanism also has limitations when coordinating activities that require more complex networks of communication. This is where agent-based <a href="http://en.wikipedia.org/wiki/Message_passing">message passing</a> – a technique that has gained a great deal of press lately thanks to <a href="http://en.wikipedia.org/wiki/Erlang_(programming_language)">Erlang</a>, another functional programming language, and that Microsoft has also adopted in another of its object-oriented programming languages called <a href="http://en.wikipedia.org/wiki/Axum_(programming_language)">Axum</a> – comes into its own. </p>  <p>The idea is that you set up a number of agents (also known as actors) that perform different roles, and they sit there waiting for messages telling them when to perform the task(s) they’ve been designed for. If needed, these agents can send their own messages to other agents to get further tasks done. The results of these tasks can be reported back to whoever needs to know what has happened (or is happening). I’m sure this is a gross over-simplification of the technique, but there you go.</p>  <p>In the below code, which solves the same “problem” of <a href="http://through-the-interface.typepad.com/through_the_interface/2008/01/turning-autocad.html">turning AutoCAD into an RSS reader</a>, defines a single agent which collects hyperlink information by downloading and parsing RSS feeds before sending a response with this data back to the caller. The collection is done asynchronously, but the code that fires off the “jobs” to collect the data is actually synchronous. In the next post we’ll look at a completely asynchronous version to see whether it’s worth the effort of making it so.</p>  <p>Here’s the F# code, defining our MRSS command:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: green">// Declare a specific namespace and module name</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">module</span><span style="line-height: 140%"> AgentSyncRssReader.Commands</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Import managed namespaces</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Xml</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.IO</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Net</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Microsoft.FSharp.Control.WebExtensions</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// The RSS feeds we wish to get. The first two values are</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// only used if our code is not able to parse the feed's XML</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> feeds =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; [ (</span><span style="line-height: 140%; color: maroon">&quot;Through the Interface&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://blogs.autodesk.com/through-the-interface&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://through-the-interface.typepad.com/&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;through_the_interface/rss.xml&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: maroon">&quot;Don Syme's F# blog&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://blogs.msdn.com/dsyme/&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://blogs.msdn.com/dsyme/rss.xml&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: maroon">&quot;Shaan Hurley's Between the Lines&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://autodesk.blogs.com/between_the_lines&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://autodesk.blogs.com/between_the_lines/rss.xml&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: maroon">&quot;Scott Sheppard's It's Alive in the Lab&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://blogs.autodesk.com/labs&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://labs.blogs.com/its_alive_in_the_lab/rss.xml&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: maroon">&quot;Volker Joseph's Beyond the Paper&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://blogs.autodesk.com/beyond_the_paper&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;http://dwf.blogs.com/beyond_the_paper/rss.xml&quot;</span><span style="line-height: 140%">) ]</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Fetch the contents of a web page, asynchronously</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> httpAsync(url:string) = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; async { </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> req = WebRequest.Create(url) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">use!</span><span style="line-height: 140%"> resp = req.AsyncGetResponse()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> stream = resp.GetResponseStream() </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> reader = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> StreamReader(stream) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> reader.ReadToEnd() }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Load an RSS feed's contents into an XML document object</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// and use it to extract the titles and their links</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Hopefully these always match (this could be coded more</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// defensively)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> titlesAndLinks (name, url, xml) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> xdoc = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> XmlDocument()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; xdoc.LoadXml(xml)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> titles =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; [ </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> n </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> xdoc.SelectNodes(</span><span style="line-height: 140%; color: maroon">&quot;//*[name()='title']&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> n.InnerText ]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> links =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; [ </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> n </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> xdoc.SelectNodes(</span><span style="line-height: 140%; color: maroon">&quot;//*[name()='link']&quot;</span><span style="line-height: 140%">) </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> inn = n.InnerText</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">&#160; inn.Length &gt; 0 </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; inn</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> href = n.Attributes.GetNamedItem(</span><span style="line-height: 140%; color: maroon">&quot;href&quot;</span><span style="line-height: 140%">).Value</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> rel = n.Attributes.GetNamedItem(</span><span style="line-height: 140%; color: maroon">&quot;rel&quot;</span><span style="line-height: 140%">).Value</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> List.exists</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> x </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> href.Contains(x))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; [</span><span style="line-height: 140%; color: maroon">&quot;feedburner&quot;</span><span style="line-height: 140%">;</span><span style="line-height: 140%; color: maroon">&quot;feedproxy&quot;</span><span style="line-height: 140%">;</span><span style="line-height: 140%; color: maroon">&quot;hubbub&quot;</span><span style="line-height: 140%">] </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; href ]</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> descs =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; [ </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> n </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> xdoc.SelectNodes</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: maroon">&quot;//*[name()='description' or name()='subtitle'&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot; or name()='summary']&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> n.InnerText ]</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// A local function to filter out duplicate entries in</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// a list, maintaining their current order.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Another way would be to use:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">//&#160;&#160;&#160; Set.of_list lst |&gt; Set.to_list</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// but that results in a sorted (probably reordered) list.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">rec</span><span style="line-height: 140%"> nub lst =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">match</span><span style="line-height: 140%"> lst </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; | a::[] </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> [a]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; | a::b </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> a = List.head b </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; nub b</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; a::nub b</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; | [] </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> []</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Filter the links to get (hopefully) the same number</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// and order as the titles and descriptions</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> real = List.filter (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> (x:string) </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> x.Length &gt; 0)&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> lnks = real links |&gt; nub</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Return a link to the overall blog, if we don't have</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// the same numbers of titles, links and descriptions</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> lnum = List.length lnks</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> tnum = List.length titles</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> dnum = List.length descs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> tnum = 0 || lnum = 0 || lnum &lt;&gt; tnum ||</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; dnum &lt;&gt; tnum </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; [(name,url,url)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; List.zip3 titles lnks descs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">with</span><span style="line-height: 140%"> _ </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> []</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// For a particular (name,url) pair,</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// create an AutoCAD HyperLink object</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> hyperlink (name,url,desc) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> hl = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> HyperLink()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; hl.Name &lt;- url</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; hl.Description &lt;- desc</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; (name, hl)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Use asynchronous workflows in F# to download</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// an RSS feed and return AutoCAD HyperLinks</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// corresponding to its posts</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> hyperlinksAsync (name, url, feed) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; async { </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> xml = httpAsync feed</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> tl = titlesAndLinks (name, url, xml)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> List.map hyperlink tl }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Now we declare our command</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">[&lt;CommandMethod(</span><span style="line-height: 140%; color: maroon">&quot;mrss&quot;</span><span style="line-height: 140%">)&gt;]</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> createHyperlinksFromRssAsyncViaMailbox() =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> starttime = System.DateTime.Now</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Let's get the usual helpful AutoCAD objects</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Application.DocumentManager.MdiActiveDocument</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> ed = doc.Editor</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> db = doc.Database</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// &quot;use&quot; has the same effect as &quot;using&quot; in C#</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; db.TransactionManager.StartTransaction()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Get appropriately-typed BlockTable and BTRs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> bt =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; tr.GetObject</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (db.BlockTableId,OpenMode.ForRead)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; :?&gt; BlockTable</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> ms =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; tr.GetObject</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (bt.[BlockTableRecord.ModelSpace],</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; OpenMode.ForWrite)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; :?&gt; BlockTableRecord</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Add text objects linking to the provided list of</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// HyperLinks, starting at the specified location</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Note the valid use of tr and ms, as they are in scope</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> addTextObjects (pt : Point3d) lst =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Use a for loop, as we care about the index to</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// position the various text items</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> len = List.length lst</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> index = 0 </span><span style="line-height: 140%; color: blue">to</span><span style="line-height: 140%"> len - 1 </span><span style="line-height: 140%; color: blue">do</span><span style="line-height: 140%"> </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> txt = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> DBText()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> (name:string,hl:HyperLink) = List.nth lst index</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; txt.TextString &lt;- name</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> offset =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> index = 0 </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1.0</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// This is where you can adjust:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">//&#160; the initial outdent (x value)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">//&#160; and the line spacing (y value)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> vec =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Vector3d</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (1.0 * offset,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; -0.5 * (float index),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> pt2 = pt + vec</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; txt.Position &lt;- pt2</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ms.AppendEntity(txt) |&gt; ignore</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(txt,</span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; txt.Hyperlinks.Add(hl) |&gt; ignore</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Define our agent to process messages regarding</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// hyperlinks to gather and process</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> agent =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; MailboxProcessor.Start(</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> inbox </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">rec</span><span style="line-height: 140%"> loop() = async {&#160;&#160;&#160;&#160;&#160; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// An asynchronous operation to receive the message</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> (i, tup, reply :</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AsyncReplyChannel&lt;(string * HyperLink) list&gt;) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; inbox.Receive()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And another to collect the hyperlinks for a feed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> res = hyperlinksAsync tup</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And then we reply with the results</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (the list of hyperlinks)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; reply.Reply(res)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Recurse to process more messages</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return!</span><span style="line-height: 140%"> loop()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Start the loop</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; loop()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Iterate through the list of feeds, firing off messages</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// to our agent for each one</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; List.iteri</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> i item </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> res = agent.PostAndReply(</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> rep </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> (i, item, rep))</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Once we have the response (synchronously), create</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// the corresponding AutoCAD text objects</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> pt =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Point3d</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (15.0 * (float i),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 30.0,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; addTextObjects pt res</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; feeds</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; tr.Commit()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> elapsed =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; System.DateTime.op_Subtraction</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (System.DateTime.Now, starttime)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ed.WriteMessage(</span><span style="line-height: 140%; color: maroon">&quot;\nElapsed time: &quot;</span><span style="line-height: 140%"> + elapsed.ToString())</span></p> </div> <!--EndFragment--><!--EndFragment--><!--EndFragment--><!--EndFragment-->  <p>&#160;</p>  <p>Here are the results of the MRSS command:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a6ddc20d970b-pi"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Results of the MRSS command" border="0" alt="Results of the MRSS command" src="/assets/image_409308.jpg" width="485" height="74" /></a> </p>  <p>The code executes a little more slowly than the “pure” asynchronous workflows version (ARSS), but more quickly than the purely synchronous version (RSS). I think this can probably be explained by the additional effort needed under the covers to coordinate the various workers that are getting the data and processing it, before modifying the contents of the AutoCAD Database. The ARSS command did this by waiting to get the data on all the feeds before creating the text objects in one fell swoop, which – for this relatively simple example – is probably more efficient. I suspect the complexity of a message-passing architecture (at least I find it complex right now – I’m sure it grows on you) becomes worthwhile when you start tackling more complex tasks.</p>
