---
layout: "post"
title: "Integrating Hyperion's volumetric room heatmaps into Dasher – Part 1"
date: "2021-05-12 13:26:53"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk Research"
  - "IoT"
  - "MX3D"
original_url: "https://www.keanw.com/2021/05/integrating-hyperions-volumetric-heatmaps-into-dasher.html "
typepad_basename: "integrating-hyperions-volumetric-heatmaps-into-dasher"
typepad_status: "Publish"
---

<p>Today’s post is a follow-on from the first part where we looked at <a href="https://www.keanw.com/2021/04/integrating-hyperion-sprites-into-dasher.html" rel="noopener" target="_blank">integrating Hyperion sprites into Dasher</a>. (The posts are independent, though, so you don’t have to read the first one if you’re only interested in integrating heatmaps.)</p>
<p>I was supposed to publish this at the beginning of the week, but I ended up getting bogged down by a couple of urgent projects – both of which I’m happy to say have led to me making some interesting enhancements to Dasher, which is, at least, something.</p>
<p>Anyway, the topic I wanted to share is the approach for integrating Hyperion’s surface shading back into its original host (i.e. Dasher). I was highly apprehensive of this task, I fully admit: I’d understood that I needed to have a Revit-based workflow with <a href="https://forge.autodesk.com/blog/consume-aec-data-which-are-model-derivative-api" rel="noopener" target="_blank">AECModelData</a> available (and even to <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/quickstart/generating_room_elements/" rel="noopener" target="_blank">generate</a>&#0160;<a href="https://forge.autodesk.com/blog/new-rvt-svf-model-derivative-parameter-generates-additional-content-including-rooms-and-spaces" rel="noopener" target="_blank">master views</a>) for our model: neither of which is available to us with Dasher’s Navisworks-based workflow. (We export NWC files from Revit to avoid the messiness of <a href="https://forge.autodesk.com/blog/bim360-docs-setting-external-references-between-files-upload-linked-files" rel="noopener" target="_blank">dealing with multiple files</a>, and – and this was the primary driver – this approach gave use rooms back before the master views capability was introduced into Forge’s Model Derivative service.)</p>
<p>The good news was that when looking into the process to set up the surface shading environment, I realised there’s an optional RoomLevelsMap you can pass in if you have the mapping between levels, rooms and sensor devices established elsewhere. This was all information we derive through Forge properties and project configuration settings, so it was actually pretty easy to populate this object and pass it in. Here’s the code that does that (although it does rely on some state inside Dasher, so you should think of this as pseudocode in case you need to implement something similar):</p>
<div class="vscode" style="white-space: pre;">
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #569cd6;">private</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #dcdcaa;">buildLevelRoomsMap</span><span style="color: #d4d4d4;">(</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">sensors</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">Dasher</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">ISensor</span><span style="color: #d4d4d4;">[],</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">structureInfo</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">Autodesk</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">DataVisualization</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Core</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">ModelStructureInfo</span></div>
<div><span style="color: #d4d4d4;">&#0160; ): [</span><span style="color: #4ec9b0;">Autodesk</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">DataVisualization</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Core</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">LevelRoomsMap</span><span style="color: #d4d4d4;">, </span><span style="color: #4ec9b0;">Record</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">string</span><span style="color: #d4d4d4;">, </span><span style="color: #4ec9b0;">unknown</span><span style="color: #d4d4d4;">&gt;[]] {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">dataVizCore</span><span style="color: #d4d4d4;"> = </span><span style="color: #4ec9b0;">Autodesk</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">DataVisualization</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Core</span><span style="color: #d4d4d4;">;</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">dm</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">_dataModel</span><span style="color: #d4d4d4;">;</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">sm</span><span style="color: #d4d4d4;"> = </span><span style="color: #4fc1ff;">dm</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">sensorManager</span><span style="color: #d4d4d4;">;</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">levels</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">new</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">dataVizCore</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">LevelRoomsMap</span><span style="color: #d4d4d4;">();</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">devices</span><span style="color: #d4d4d4;"> = [];</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">structureInfo</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rooms</span><span style="color: #d4d4d4;"> = [];</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (</span><span style="color: #569cd6;">let</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #9cdcfe;">lev</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">lev</span><span style="color: #d4d4d4;"> &lt; </span><span style="color: #4fc1ff;">dm</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">roomNodes</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">length</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">lev</span><span style="color: #d4d4d4;">++) {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">levelRooms</span><span style="color: #d4d4d4;"> = </span><span style="color: #4fc1ff;">dm</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">roomNodes</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">lev</span><span style="color: #d4d4d4;">];</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">levelName</span><span style="color: #d4d4d4;"> = </span><span style="color: #4fc1ff;">dm</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">getLevelName</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">lev</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">dbId</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #569cd6;">of</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">levelRooms</span><span style="color: #d4d4d4;">) {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">name</span><span style="color: #d4d4d4;"> = </span><span style="color: #4fc1ff;">dm</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">getRoomName</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">dbId</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">bounds</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">_controller</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">viewerModel</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">getBounds</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">dbId</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">room</span><span style="color: #d4d4d4;"> = </span><span style="color: #569cd6;">new</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">dataVizCore</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Room</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">dbId</span><span style="color: #d4d4d4;">, </span><span style="color: #4fc1ff;">name</span><span style="color: #d4d4d4;">, </span><span style="color: #4fc1ff;">bounds</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">roomsWithSensors</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">indexOf</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">dbId</span><span style="color: #d4d4d4;">) &gt;= </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">sensorsForRoom</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">sensors</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">filter</span><span style="color: #d4d4d4;">((</span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">) </span><span style="color: #569cd6;">=&gt;</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">sm</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">sensorsByRoom</span><span style="color: #d4d4d4;">[</span><span style="color: #4fc1ff;">dbId</span><span style="color: #d4d4d4;">]?.</span><span style="color: #dcdcaa;">indexOf</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">id</span><span style="color: #d4d4d4;">) &gt;= </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> (</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">roomSensor</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #569cd6;">of</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">sensorsForRoom</span><span style="color: #d4d4d4;">) {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">dev</span><span style="color: #d4d4d4;"> = {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">id</span><span style="color: #9cdcfe;">:</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">roomSensor</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">id</span><span style="color: #d4d4d4;">,</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">position</span><span style="color: #9cdcfe;">:</span><span style="color: #d4d4d4;">&#0160;</span><span style="color: #4fc1ff;">roomSensor</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">location</span><span style="color: #d4d4d4;">,</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">sensorTypes</span><span style="color: #9cdcfe;">:</span><span style="color: #d4d4d4;"> [</span><span style="color: #4fc1ff;">roomSensor</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">sensorInfo</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">type</span><span style="color: #d4d4d4;">]</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; };</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #4fc1ff;">room</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">addDevice</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">dev</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #4fc1ff;">devices</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">push</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">dev</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #4fc1ff;">levels</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">addRoomToLevel</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">levelName</span><span style="color: #d4d4d4;">, </span><span style="color: #4fc1ff;">room</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">structureInfo</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">rooms</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">push</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">room</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; }</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> [</span><span style="color: #4fc1ff;">levels</span><span style="color: #d4d4d4;">, </span><span style="color: #4fc1ff;">devices</span><span style="color: #d4d4d4;">];</span></div>
<div><span style="color: #d4d4d4;">&#0160; }</span></div>
</div>
<p>Otherwise the implementation was pretty painless: I just followed the <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/examples/heatmap/" rel="noopener" target="_blank">excellent instructions</a> in the <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/introduction/overview/" rel="noopener" target="_blank">documentation provided by the Hyperion team</a>.</p>
<p>There was an additional step needed to generate fragIds for the various room objects: this is normally done automatically by a call to SurfaceShadingData.initialize(model): it turned out that for Navisworks models to work, the call to enumNodeFragments() needed to have the third parameter (requesting the operation to recurse) set to true, as the default is false. And because Navisworks probably has a more fragmented (or perhaps indirect) approach when it comes to geometry organisation, so the fragment is not a direct child of the geometry. Or something like that. I admit I don’t understand all the ins and outs of this. Anyway – this has now been fixed in an internal release, and will make its way into a public one before we know it. (Just bear this in mind if you’re implementing heatmaps for Navisworks models using v7.43 – perhaps even v7.44 – or earlier of the Forge viewer and the heatmaps aren’t showing up: it might well be due to this issue.)</p>
<p>Integrating Hyperion is certainly allowing me to rip out big chunks of old Dasher code, which feels <u>so</u> good. I also switched across to use their hideTextures() method (inspired by a similar Dasher feature), and decided to demote the UI for enabling the hiding of textures to the user settings, rather than taking up space in the Dasher toolbar. While I was at it, I rejigged the icons for some of features that were staying: we now have a paint drop for surface shading, and used the eye that it had before for occlusion (this makes more sense, frankly). We also replaced the sensor dots icon – which was previously a set of scales, to indicate measurement – for a pin/placemarker, which I feel is more logical.</p>
<p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2026bded156e7200c-pi" rel="noopener" target="_blank"><img alt="Another shading snapshot" border="0" height="312" src="/assets/image_551702.jpg" style="margin: 30px auto; border: 0px currentcolor; float: none; display: block; background-image: none;" title="Another shading snapshot" width="500" /></a></p>
<p>It’s frankly awesome to see how well Hyperion has slotted into Dasher, and how well it performs. The team has done a great job of streamlining the original implementation and making it easy to consume/adopt. There are still types of heatmap that we manage on our own, for now – the 2D panels that allow you to compare different sensor types, but also the Types By Level UI – but it’s great to be able to gradual reduce the amount of code in the project (although, being honest, the code ends up building up elsewhere in the codebase, soon enough.)</p>
<p>In the end I did start looking at what it would take to switch across to using Revit for our models. It is pretty easy to host multiple models with a single master model inside BIM360 – you just need to upload using &quot;the “upload linked files” option. So far so good. I did need to make some tweaks to Dasher to allow it to deal with the different property structure available inside Revit models – as the export process does shift the hierarchy around somewhat – but it wasn’t too hard. I did find the coordinate space to be different between the two environments, which meant that sensors placed locally in Dasher (rather than being defined by the model) needed some remapping, as well as the initial view onto the model.</p>
<p>All of this was just grunt work and straightforward enough to work through. The main blocker came when I tried to use Hyperion with the master views generated for my model: it turns out that master views do not pick up geometry (including rooms) stored in linked models. Which is definitely an issue for the way our main Dasher model has been built, as rooms are stored in the model for the respective unit (the NEST building is highly modular). Many thanks to Eason Kang from the Developer Advocacy and Support team for his help digging into this problem. I’m hoping the Hyperion team (or the DAS team, for that matter) is able to share something to help with this, as it would be unfortunate if every developer hitting this had to build something themselves. I’m looking forward to implementing a Revit-based workflow in Dasher, and this seems to be the main outstanding blocker.</p>
<p>This was a look at what it took to integrate volumetric heatmaps for rooms, which has historically been the main focus of Dasher. We do apply <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/examples/heatmap_for_arbitrary_models/" rel="noopener" target="_blank">heatmaps to the surface of objects</a> – such as the MX3D bridge – so I’m going to spend some time looking at that over the coming weeks, too. As an alternative to volumetric shading of rooms, the Hyperion team have also provided a <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/examples/planar_heatmap/" rel="noopener" target="_blank">planar heatmap</a> that can be put at the bottom or top of your room volumes – depending on which makes most sense – I also expect to spend some time looking at that, too.</p>
