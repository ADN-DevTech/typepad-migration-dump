---
layout: "post"
title: "Exporting to DWG from the Clipboard Manager"
date: "2010-11-01 14:34:34"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Plugin of the Month"
  - "User interface"
original_url: "https://www.keanw.com/2010/11/exporting-to-dwg-from-the-clipboard-manager.html "
typepad_basename: "exporting-to-dwg-from-the-clipboard-manager"
typepad_status: "Publish"
---

<p>I’ve made a couple of updates to the Clipboard Manager in <a href="http://through-the-interface.typepad.com/files/ClipboardManager-1.0.7.zip" target="_blank">this latest version</a>.</p>  <p>Firstly I wanted to remove a peculiar situation that occurred in the previous versions when you copy something to the clipboard that <strong>isn’t</strong> AutoCAD geometry: for some reason this act invalidates the ability to access data – such as the preview images – from the items in the Clipboard Manager. The pasting into the drawing still works, as setting an AutoCAD object back onto the clipboard re-enables access to AutoCAD data. You can try this with the previous version by creating a number of entries on the Clipboard Manager before copying some text to the clipboard from Notepad (although the issue was <a href="http://through-the-interface.typepad.com/through_the_interface/2010/10/automatically-cropping-a-bitmap-more-quickly.html#comment-6a00d83452464869e201348882e22b970c" target="_blank">first reported</a> with copying text from the MText IPE). Doing so stops the preview from working properly (and whether that blanks the preview image or causes an old one to remain depends on the version you’re using).</p>  <p>Anyway, the fix I decided upon is simple enough but could create user confusion: if the preview image is blank – as we attempt to retrieve it – when selection is changed in the Clipboard Manager, then we copy the contents of that entry to the clipboard. This allows us to get the preview image, and life is good. The downside is that this clears the previous contents of the clipboard – which may well be undesirable from the user’s perspective. That said, the fact that the user has clicked onto the Clipboard Manager palette does imply they want to use it for something, and so perhaps this is an acceptable compromise. Let me know if you have thoughts on this – I’d be happy to hear them.</p>  <p>The second change is the promised “Export to DWG” capability. I thought this would be very easy to implement – as we already had our function to get the temporary DWG file from AutoCAD’s clipboard data – but it proved harder than expected for one reason: AutoCAD only keeps the temporary DWG while the contents are on the clipboard. As soon as an item gets relegated to 2nd place, its temporary DWG file gets deleted from disk! This took me a while to work out and frankly I’m still scratching my head as to how the Clipboard Manager actually functions at all: if the DWG is inaccessible then PASTECLIP must retrieve it or regenerate it from somewhere else, but I don’t know how or why. At some point I may dig a little deeper into the implementation of the PASTECLIP command, but for now I’ll just be happy that it works when prior clipboard objects are copied back onto the clipboard.</p>  <p>The logical way to get around this situation is to copy the DWG file while it’s still valid, when the entry is first placed onto the clipboard. This means we then have to maintain a list of these temporary DWGs that might get used by the Export option but then they might very well not: this seems an acceptable overhead, especially if we clean up after ourselves. We then also have to store the location of this DWG file along with the DataObject defining the clipboard contents. We were previously just storing the DataObject in the “tag” property of each DataGridViewRow (a very handy field that can be used to associate arbitrary data with an item in the list). Now that we have more data to store we’ll instead store a key into a dictionary of “clipboard data items”, each of which stores the DataObject and the temporary DWG path. You’ll find this in the new “<em>Clipboard_Data.vb</em>” file implementing the CbDataManager class which manages items of class CbEntry. This manager object also knows how to clean up after itself by deleting temporary DWGs from disk when items are removed from the list or when the session finishes.</p>  <p>The resultant EXPORTCB command (as wherever possible we want to drive commands from modeless dialogs such as palettes) ends up being pretty simple:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">&#160; &lt;CommandMethod(</span><span style="line-height: 140%; color: #a31515">&quot;ADNPLUGINS&quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">&quot;EXPORTCB&quot;</span><span style="line-height: 140%">, CommandFlags.Modal)&gt; _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">Public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Shared</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Sub</span><span style="line-height: 140%"> ExportClipboard()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Make sure we only have one item selected</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> _cp.clipboardDataGridView.SelectedRows.Count = 1 </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Get the selected item and its associated DWG file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> item </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> DataGridViewRow = _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cp.clipboardDataGridView.SelectedRows.Item(0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> dwgFile </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">String</span><span style="line-height: 140%"> = _cp.GetTempDwg(item.Tag)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Not</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">String</span><span style="line-height: 140%">.IsNullOrEmpty(dwgFile) </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> ed </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Editor = _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Autodesk.AutoCAD.ApplicationServices.Application _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .DocumentManager.MdiActiveDocument.Editor()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Get the name of the entry as shown in the list</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> itemName </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">String</span><span style="line-height: 140%"> = item.Cells(0).FormattedValue</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Set up our Save dialog options</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> opts </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> PromptSaveFileOptions = _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">New</span><span style="line-height: 140%"> PromptSaveFileOptions( _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Export &quot;&quot;&quot;</span><span style="line-height: 140%"> + itemName + </span><span style="line-height: 140%; color: #a31515">&quot;&quot;&quot; Contents To&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; opts.Filter = </span><span style="line-height: 140%; color: #a31515">&quot;Drawing (*.dwg)|*.dwg&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; opts.InitialDirectory = _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">My</span><span style="line-height: 140%">.Computer.FileSystem.SpecialDirectories.MyDocuments</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; opts.InitialFileName = itemName + </span><span style="line-height: 140%; color: #a31515">&quot;.dwg&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Ask the user to selected the output location</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> pr </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> PromptFileNameResult = ed.GetFileNameForSave(opts)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> pr.Status = PromptStatus.OK </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> dwgDest </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">String</span><span style="line-height: 140%"> = pr.StringResult</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' If the file exists, the user has already</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' chosen to overwrite it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> File.Exists(dwgDest) </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; File.Delete(dwgDest)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Copy the file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; File.Copy(dwgFile, dwgDest)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Inform the user of success</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage( _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; vbCr + </span><span style="line-height: 140%; color: #a31515">&quot;Exported contents of &quot;&quot;{0}&quot;&quot; to &quot;&quot;{1}&quot;&quot;&quot;</span><span style="line-height: 140%">, _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; itemName, dwgDest)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Catch</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Sub</span></p> </div> <!--EndFragment-->  <p>Here’s the Clipboard Manager containing four nicely-renamed entries:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2013488a02d77970c-pi"><img style="border-bottom: 0px; border-left: 0px; margin: 20px auto; display: block; float: none; border-top: 0px; border-right: 0px" title="Clipboard Manager containing four entries" border="0" alt="Clipboard Manager containing four entries" src="/assets/image_854718.jpg" width="224" height="400" /></a> </p>  <p>Here’s the temporary location containing our four DWG files:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2013488a02d9c970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Our corresponding (temporary) DWG files" border="0" alt="Our corresponding (temporary) DWG files" src="/assets/image_206562.jpg" width="479" height="214" /></a>As items get removed from the list, the corresponding DWG files also get removed. When we want to export a particular item to DWG, we simply right-click it and select “Export to DWG”:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f57fe719970b-pi"><img style="border-bottom: 0px; border-left: 0px; margin: 20px auto; display: block; float: none; border-top: 0px; border-right: 0px" title="Exporting to a DWG from the Clipboard Manager" border="0" alt="Exporting to a DWG from the Clipboard Manager" src="/assets/image_46498.jpg" width="224" height="400" /></a>At which point we see our file selection dialog for the destination DWG file:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f57fe74f970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Our file selection dialog for the destination DWG" border="0" alt="Our file selection dialog for the destination DWG" src="/assets/image_703697.jpg" width="443" height="319" /></a>And selecting “Save” will result in a simple file-copy from the temporary file to our specified destination, and a confirmation on the command-line:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">Exported contents of &quot;Six Circles&quot; to &quot;C:\Users\walmslk\Documents\Six </span><span style="line-height: 140%">Circles.dwg&quot;</span></p> </div> <!--EndFragment-->  <p>That’s it for today’s update. There’s one last issue that’s been reported that I’m working through: sometimes you need to click twice in the drawing after selecting “paste” from a newly-selected item for it to place the geometry. There’s clearly some kind of focus-related issue, but it’s proving a little tricky to chase down (such issues often prove tough to debug). Hopefully I’ll find a way to address it, otherwise I’ll just recommend people to right-click directly, which appears to avoid the problem.</p>
