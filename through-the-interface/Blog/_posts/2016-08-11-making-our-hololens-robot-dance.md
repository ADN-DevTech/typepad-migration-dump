---
layout: "post"
title: "Making our HoloLens robot dance!"
date: "2016-08-11 13:56:15"
author: "Kean Walmsley"
categories:
  - "Augmented Reality"
  - "HoloLens"
  - "Robotics"
  - "Unity3D"
  - "Visual Studio"
  - "Web/Tech"
original_url: "https://www.keanw.com/2016/08/making-our-hololens-robot-dance.html "
typepad_basename: "making-our-hololens-robot-dance"
typepad_status: "Publish"
---

<p>As promised, way back when we started this series of posts looking at various Windows Holographic platform capabilities to build an app that displays an animated ABB industrial robot inside HoloLens, here’s the part where we make it dance. :-)</p> <p><a href="http://stackoverflow.com/questions/15738062/asyncusertoken-class-is-missing-in-socketasynceventargs-sample-how-to-make-the" target="_blank"><img title="Dancing robot" style="float: none; margin: 30px auto; display: block" alt="Dancing robot" src="/assets/image_441049.jpg" width="500" height="281"></a></p> <p>During Autodesk Switzerland’s 25th anniversary party in late October, people will be able to give the app a try and hopefully see the robot dancing along to whatever tunes the DJ plays. Let’s talk a bit about how the system works…</p> <p>Quite early on I decided against doing the additional audio processing directly on the HoloLens device itself. So I wanted to set the HoloLens up as a TCP server that a client could connect to and send messages to whenever it detected a beat.</p> <p>Let’s take a look at what was needed on the HoloLens for this…</p> <p>The big challenge here is that Unity’s C# implementation is based on Mono, which doesn’t yet have async/await implemented. And as Universal Windows Apps (UWPs) live in a sandbox, it’s not always easy to get things working.</p> <p>What I really wanted was a <a href="https://github.com/dotnet/corefx/issues/5939" target="_blank">System.Net.Sockets.TcpListener</a>, which is apparently available in <a href="https://www.nuget.org/packages/System.Net.Sockets/4.1.0" target="_blank">a new version of the System.Net.Sockets component</a>, but I couldn’t work out how to make use of this from inside a Unity app.</p> <p>My next attempt was influenced heavily by <a href="http://stackoverflow.com/questions/36526332/unity3d-c-sharp-plugin-to-act-as-a-socket-server/36526634#36526634" target="_blank">a StackOverflow thread</a>. I’d hoped to use a <a href="http://stackoverflow.com/questions/32665847/cannot-connect-to-streamsocketlistener" target="_blank">SocketStreamListener</a>, but due to the lack of async/await support I was out of luck, once again.</p> <p>It was time to go *way* back to basics… it was time to crack open some VS 2008 (perhaps even older) code on MSDN.</p> <p>I took the Server implementation from example code for <a href="https://msdn.microsoft.com/en-us/library/system.net.sockets.socketasynceventargs(v=vs.110).aspx" target="_blank">System.Net.Sockets.SocketAsyncEventArgs</a>. I took the BufferManager implementation from the example code for <a href="https://msdn.microsoft.com/en-us/library/bb517542(v=vs.110).aspx" target="_blank">its SetBuffer method</a>. I took the SocketAsyncEventArgsPool implementation from the example code for <a href="https://msdn.microsoft.com/en-us/library/system.net.sockets.socketasynceventargs.socketasynceventargs(v=vs.110).aspx" target="_blank">its constructor</a>. And finally, I added the missing AsyncUserToken implementation, as per <a href="http://stackoverflow.com/questions/15738062/asyncusertoken-class-is-missing-in-socketasynceventargs-sample-how-to-make-the" target="_blank">StackOverflow</a>.</p> <p>With these pieces in my Unity project, it was trivial to start a TCP server from my MonoBehaviour:</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> UnityEngine;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Net;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Dance</span> : <span style="color: #2b91af">MonoBehaviour</span></p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> <span style="color: blue">bool</span> toggle = <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> <span style="color: blue">int</span> port = 4444;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> <span style="color: #2b91af">TcpServer</span> s;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> Start()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; s = <span style="color: blue">new</span> <span style="color: #2b91af">TcpServer</span>(10, 100);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; s.Init(ReceiveCompleted);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; s.Start(<span style="color: blue">new</span> <span style="color: #2b91af">IPEndPoint</span>(<span style="color: #2b91af">IPAddress</span>.Any, port));</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">internal</span> <span style="color: blue">void</span> ReceiveCompleted()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; toggle = <span style="color: blue">true</span>;</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> Update()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (toggle)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.BroadcastMessage(<span style="color: #a31515">"OnReverse"</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toggle = <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Whenever a TCP message is received, we simply go and reverse the direction of the robot: i.e. all the moving parts of the robot change their rotation direction. We could make it more sophisticated, but for now it at least clearly responds to messages it receives.</p> <p>So how do we detect beats in the music? </p> <p>I found some <a href="http://processing.org" target="_blank">Processing</a> <a href="https://github.com/kctess5/Processing-Beat-Detection" target="_blank">code on the web</a> that performs beat detection on an audio stream and displays the results in a graphical window on my Mac (it uses Soundflower, an OS X system extension). As Processing has some limited support for HTTP &amp; TCP, I went ahead and added a few lines of code to send a message via a TCP connection to the HoloLens device. The client code is really trivial: I just create a <a href="https://processing.org/reference/libraries/net/Client.html" target="_blank">Processing.Net.Client</a> object – pointing to the IP address and port of the HoloLens’s TCP server – and use the write() method to send a single character (a “b”, but it could be anything).</p> <p>Here it is in action:</p> <p>&nbsp;</p> <p align="center"><iframe height="281" src="https://www.youtube-nocookie.com/embed/gUxdhAdY0Bo?rel=0&amp;showinfo=0" frameborder="0" width="500" allowfullscreen></iframe></p> <p>&nbsp;</p> <p>It doesn’t dance very well, but then I can say that it dances significantly better than I do. So perhaps I’m not in a position to criticise. ;-)</p>
