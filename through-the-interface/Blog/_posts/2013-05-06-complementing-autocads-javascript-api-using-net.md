---
layout: "post"
title: "Complementing AutoCAD&rsquo;s JavaScript API using .NET"
date: "2013-05-06 18:09:14"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Graphics system"
  - "JavaScript"
  - "Jigs"
  - "Runtime"
original_url: "https://www.keanw.com/2013/05/complementing-autocads-javascript-api-using-net.html "
typepad_basename: "complementing-autocads-javascript-api-using-net"
typepad_status: "Publish"
---

<p>After having some fun writing our first jig inside AutoCAD, last week, and calling it either from <a href="http://through-the-interface.typepad.com/through_the_interface/2013/05/jigging-an-autocad-circle-using-javascript.html" target="_blank">an HTML page</a> or <a href="http://through-the-interface.typepad.com/through_the_interface/2013/05/jigging-an-autocad-circle-from-a-javascript-defined-command.html" target="_blank">an AutoCAD command defined in a .js file</a>, in today’s post we’re going to see how we can use AutoCAD’s .NET API to extend its new JavaScript layer.</p>  <p>We’re going to take a concrete problem we had in last week’s implementation: it turns out that when you draw a transient circle beneath the cursor using JavaScript – as we do during our jig – it absorbs mouse clicks. This is something we’ve logged as an issue, but it seems an interesting problem to work around using the extensibility framework we’ve built into AutoCAD’s JavaScript API. It’s always nice to have a concrete problem to get your teeth into. :-)</p>  <p>For some background to both the extensibility mechanism and AutoCAD’s JavaScript implementation, I recommend taking a look at <a href="http://adndevblog.typepad.com/autocad/2013/04/getting-started-with-javascript-api-on-autocad-2014.html" target="_blank">Philippe Leefsma’s DevTV recording over on the AutoCAD DevBlog</a>. The provided downloadable archive includes demos that show how to complement the JavaScript API using either ObjectARX or .NET.</p>  <p>So what do we want to do to work around our problem? Well, rather than drawing the transient graphics directly in JavaScript, we’re going to define a couple of methods in .NET that will get called from our JavaScript code via some functions that implement the required data marshaling.</p>  <p>Firstly, we need a drawCircle() function that draws a circle with the provided center and radius. The first time it’s called, this function will create a Circle and keep it in memory for subsequent calls. We also need a clearCircle() function both to remove the transient graphics and to dispose of the Circle object (otherwise there’ll be a crash when the object is <a href="http://through-the-interface.typepad.com/through_the_interface/2008/06/cleaning-up-aft.html" target="_blank">disposed of by the .NET finalizer, which works on a background thread</a>).</p>  <p>Let’s start with the C# implementation code. This code needs to be compiled into a DLL and then NETLOADed into AutoCAD for all this to work, of course:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.GraphicsInterface;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Newtonsoft.Json.Linq;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> JavaScriptExtender</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Functions</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Circle</span><span style="line-height: 140%"> _cir = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">JavaScriptCallback</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;NetDrawCircle&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> DrawCircle(</span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> jsonArgs)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Unpack our JSON-encoded parameters using Json.NET</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> o = </span><span style="line-height: 140%; color: #2b91af">JObject</span><span style="line-height: 140%">.Parse(jsonArgs);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> x = (</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)o[</span><span style="line-height: 140%; color: #a31515">&quot;functionParams&quot;</span><span style="line-height: 140%">][</span><span style="line-height: 140%; color: #a31515">&quot;center&quot;</span><span style="line-height: 140%">][</span><span style="line-height: 140%; color: #a31515">&quot;x&quot;</span><span style="line-height: 140%">];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> y = (</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)o[</span><span style="line-height: 140%; color: #a31515">&quot;functionParams&quot;</span><span style="line-height: 140%">][</span><span style="line-height: 140%; color: #a31515">&quot;center&quot;</span><span style="line-height: 140%">][</span><span style="line-height: 140%; color: #a31515">&quot;y&quot;</span><span style="line-height: 140%">];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> z = (</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)o[</span><span style="line-height: 140%; color: #a31515">&quot;functionParams&quot;</span><span style="line-height: 140%">][</span><span style="line-height: 140%; color: #a31515">&quot;center&quot;</span><span style="line-height: 140%">][</span><span style="line-height: 140%; color: #a31515">&quot;z&quot;</span><span style="line-height: 140%">];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> center = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%">(x, y, z);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> radius = (</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)o[</span><span style="line-height: 140%; color: #a31515">&quot;functionParams&quot;</span><span style="line-height: 140%">][</span><span style="line-height: 140%; color: #a31515">&quot;radius&quot;</span><span style="line-height: 140%">];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Draw our transient circle</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ic = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntegerCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> tm = </span><span style="line-height: 140%; color: #2b91af">TransientManager</span><span style="line-height: 140%">.CurrentTransientManager;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_cir == </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the first time, create our circle</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ed =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument.Editor;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> norm =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.CurrentUserCoordinateSystem.CoordinateSystem3d.Zaxis;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cir = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Circle</span><span style="line-height: 140%">(center, norm, radius);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And then draw it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tm.AddTransient(_cir, </span><span style="line-height: 140%; color: #2b91af">TransientDrawingMode</span><span style="line-height: 140%">.Main, 0, ic);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If not the first time, update our circle and</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// the transient graphics representation of it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cir.Center = center;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cir.Radius = radius;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tm.UpdateTransient(_cir, ic);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;{\&quot;retCode\&quot;:0, \&quot;result\&quot;:\&quot;OK\&quot;}&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">JavaScriptCallback</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;NetClearCircle&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> ClearCircle(</span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> jsonArgs)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_cir != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Clear the transient graphics we've added</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ic = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntegerCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> tm = </span><span style="line-height: 140%; color: #2b91af">TransientManager</span><span style="line-height: 140%">.CurrentTransientManager;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tm.EraseTransient(_cir, ic);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Very importantly dispose of our Circle</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cir.Dispose();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cir = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;{\&quot;retCode\&quot;:0, \&quot;result\&quot;:\&quot;OK\&quot;}&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>You’ll notice that the two methods we want to call from JavaScript – DrawCircle() and ClearCircle() – are tagged with the custom JavaScriptCallback attribute.</p>  <p>Something else to note is that the arguments passed into these methods are packaged as JSON (although this will be null for ClearCircle() as it doesn’t take logical arguments – we’ll see that later) that we’ll therefore need to unpack. In the first function, we do this using Newtonsoft’s excellent Json.NET library.</p>  <p>The simple way to add Json.NET to your project is via NuGet. In the Visual Studio interface select Tools –&gt; Library Package Manager –&gt; Manage NuGet Packages for Solution…</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201901be032ae970b-pi" target="_blank"><img style="background-image: none; border-right-width: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Getting Json.NET via the package manager" border="0" alt="Getting Json.NET via the package manager" src="/assets/image_241409.jpg" width="454" height="304" /></a></p>  <p>Check the beginning of the DrawCircle() method to see how Json.NET helps us unpack the JSON that’s passed into the function.</p>  <p>That’s the .NET side of things: now let’s take a look at what we need to add to our JavaScript code to essentially extend the JavaScript Shaping Layer.</p>  <p>Here’s the updated JavaScript code – the standalone version we saw at the end of last week. We could also update the HTML palette, but that would take more work to marshal across the data set by its various UI elements.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> doc = Acad.Application.activedocument;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> center = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.Point3d(0, 0, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> radius = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">//var trId;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> pointToString(pt) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ret =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pt.x.toString() + </span><span style="line-height: 140%; color: maroon">&quot;,&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pt.y.toString() + </span><span style="line-height: 140%; color: maroon">&quot;,&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pt.z.toString();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> ret;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> createCircle(cen, rad, first) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Build an XML string containing data to create</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// an AcGiTransient that represents the circle</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> cursor = </span><span style="line-height: 140%; color: maroon">''</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> drawable =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;'</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;drawable '</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'xmlns=&quot;http://www.autodesk.com/AutoCAD/drawstream.xsd&quot; '</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'xmlns:t=&quot;http://www.autodesk.com/AutoCAD/transient.xsd&quot; '</span><span style="line-height: 140%">+</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'t:onmouseover=&quot;onmouseover&quot;'</span><span style="line-height: 140%"> + cursor + </span><span style="line-height: 140%; color: maroon">'&gt;'</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;graphics id=&quot;id1&quot;&gt;&lt;circle center =&quot;'</span><span style="line-height: 140%"> + pointToString(cen) +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&quot; radius =&quot;'</span><span style="line-height: 140%"> + rad.toString() + </span><span style="line-height: 140%; color: maroon">'&quot;/&gt;'</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;/graphics&gt;&lt;/drawable&gt;'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> drawable;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> circleJig() {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onJigUpdate(args) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> res = JSON.parse(args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (res) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// The value being updated is the distance</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; radius = res.distance;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Use it to create the XML for a transient</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// circle and ask for it to be displayed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">//var x = createCircle(center, radius);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">//doc.transientManager.updateTransient(trId, x);&#160;&#160;&#160;&#160;&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; drawCircle(center, radius);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onJigComplete(args) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// When the jig is over, remove the transient</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">//doc.transientManager.eraseTransient(trId);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; clearCircle();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> res = JSON.parse(args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (res &amp;&amp; res.dragStatus == Acad.DragStatus.kNormal) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Acad.Editor.executeCommandAsync(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'_.CIRCLE '</span><span style="line-height: 140%"> + pointToString(center) + </span><span style="line-height: 140%; color: maroon">' '</span><span style="line-height: 140%"> + radius</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onJigError(args) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; write(</span><span style="line-height: 140%; color: maroon">'\nUnable to create circle: '</span><span style="line-height: 140%"> + args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onPointSelected(args) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> res = JSON.parse(args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (res) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; center =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.Point3d(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; res.value.x,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; res.value.y,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; res.value.z</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Now we can create our transient</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">//var tran = new Acad.Transient();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">//trId = tran.getId();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// And ask for it to be drawn</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">//var x = createCircle(center, 0, true);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">//doc.transientManager.addTransient(tran, x);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; drawCircle(center, 0);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Set up our jig options</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> opts =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.JigPromptDistanceOptions(</span><span style="line-height: 140%; color: maroon">'Point on radius'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; opts.basePoint = center;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; opts.useBasePoint = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Run the jig to select the distance</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> jig = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.DrawJig(onJigUpdate, opts);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Acad.Editor.drag(jig).then(onJigComplete, onJigError);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onPointError(args) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; write(</span><span style="line-height: 140%; color: maroon">'\nUnable to select point: '</span><span style="line-height: 140%"> + args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Ask the user to select the center point before we</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// start the jig</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> opts = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.PromptPointOptions(</span><span style="line-height: 140%; color: maroon">'Select center'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Acad.Editor.getPoint(opts).then(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; onPointSelected, onPointError</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Our extensions to the AutoCAD Shaping Layer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> drawCircle(cen, rad) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; execAsync(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; JSON.stringify({</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; functionName: </span><span style="line-height: 140%; color: maroon">'NetDrawCircle'</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; invokeAsCommand: </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; functionParams: {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; center: cen,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; radius: rad</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; onInvokeSuccess,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; onInvokeError</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> clearCircle() {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; execAsync(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; JSON.stringify({</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; functionName: </span><span style="line-height: 140%; color: maroon">'NetClearCircle'</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; invokeAsCommand: </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; functionParams: undefined</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; onInvokeSuccess,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; onInvokeError</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onInvokeSuccess(result) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; write(</span><span style="line-height: 140%; color: maroon">&quot;\n&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onInvokeError(result) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; write(</span><span style="line-height: 140%; color: maroon">&quot;\nOnInvokeError: &quot;</span><span style="line-height: 140%"> + result);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">Acad.Editor.addCommand(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;JIG_CMDS&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;CJ&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;CJ&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Acad.CommandFlag.MODAL,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; circleJig</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p> </div>  <p>I’ve commented out the various uses of transient graphics (although I’ve left in the now-unused createCircle() function) so you can contrast the calls with the new ones to drawCircle() and clearCircle().</p>  <p>It should be fairly obvious how we’ve implemented our drawCircle() and clearCircle() functions to simply call through to .NET using execAsync() (I suppose exec() might also have been called, but I tend to prefer to use asynchronous calls unless it’s absolutely required to use synchronous ones).</p>  <p>If you’d like to give this version a try – and it seems to work very well for me, at least – copy &amp; paste the following into the command-line of AutoCAD 2014:</p>  <p><font face="Courier New">(command &quot;_.WEBLOAD&quot; &quot;</font><a href="http://through-the-interface.typepad.com/files/CircleJigNet.js"><font face="Courier New">http://through-the-interface.typepad.com/files/CircleJigNet.js</font></a><font face="Courier New">&quot;)</font></p>  <p>As mentioned earlier, you’ll need to have built the post’s C# code into a DLL that you NETLOAD into AutoCAD before the JavaScript code will function correctly. This will clearly impact the portability of your JavaScript code – unless you add the same capability across the other (future) platforms – but hopefully you can see how it’s possible to extend our JavaScript API implementation when you really need to.</p>
