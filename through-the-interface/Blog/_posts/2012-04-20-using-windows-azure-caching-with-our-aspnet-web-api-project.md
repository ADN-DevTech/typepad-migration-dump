---
layout: "post"
title: "Using Windows Azure Caching with our ASP.NET Web API project"
date: "2012-04-20 09:33:18"
author: "Kean Walmsley"
categories:
  - "ASP.NET"
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Azure"
  - "F#"
  - "REST"
original_url: "https://www.keanw.com/2012/04/using-windows-azure-caching-with-our-aspnet-web-api-project.html "
typepad_basename: "using-windows-azure-caching-with-our-aspnet-web-api-project"
typepad_status: "Publish"
---

<p>As mentioned in <a href="http://through-the-interface.typepad.com/through_the_interface/2012/04/hosting-our-aspnet-web-api-project-on-windows-azure-part-2.html" target="_blank">the last post</a>, while working on deploying our web-site and its related services to Windows Azure, I started to chew on <a href="https://www.windowsazure.com/en-us/home/features/compute/" target="_blank">the economics of Azure hosting</a>. This is especially relevant as I start to see my free 3-month subscription’s resources being burned through by all of you checking them the links in the last post. ;-)</p>  <p>Here’s what I found… “<a href="http://go.microsoft.com/fwlink/?LinkId=164387" target="_blank">extra small</a>” instances are a mere sixth of the cost of “small” instances (not taking into account the 6-month pre-purchase discount on small instances, admittedly), which got me thinking: if I can reduce the resources needed for each instance, perhaps using a central caching service, then that would make financial sense.</p>  <p>For example: say we chose two small instances per month. According to <a href="http://www.windowsazure.com/en-us/pricing/calculator/" target="_blank">the Azure pricing calculator</a>, that would cost $180 per month (or $143.98 with the 20% reduction for a 6-month plan). If we could scale down to using 2 extra small VM instances, that would cost $30 per month. Of course we’d need to add the cost of the caching service (which currently runs at $45 per month for 128MB, which is more than enough for our needs, size-wise), but it still works out well, cost-wise. And also makes it really cheap for us to scale upwards, depending on usage, as one cache could server multiple VM instances.</p>  <p>So let’s look at what our web-services are currently doing, to see what opportunities we have for performance optimization.</p>  <p>As mentioned previously, the service currently does a lot of repeated operations, which isn’t optimal. Every time it gets a request to generate the 2D Apollonian gasket or 3D Apollonian packing for a given radius and recursion level, it calculates the results again. And actually the results for different radii – but the same recursion level – are basically the same: it’s really just a matter of multiplying the unit result (i.e. for a radius of 1.0) by the specific radius passed in (which means adjusting the X, Y, Z and radius values accordingly). </p>  <p>Assuming we only want to support 10 “levels” for both circles and spheres, that means we could effectively store 20 records (with those for the higher recursion levels getting quite big, of course) in a cache, and then very rarely need to call into our CPU-consuming, core F# algorithms. Which hopefully means we can then scale back the size of our VM instances, as suggested earlier.</p>  <p>I briefly mentioned two optimization approaches, in <a href="http://through-the-interface.typepad.com/through_the_interface/2012/04/architecting-for-the-cloud.html" target="_blank">this previous post</a>: memoization and caching.</p>  <p><a href="http://en.wikipedia.org/wiki/Memoization" target="_blank">Memoization</a> is a technique that stores the results of <a href="http://en.wikipedia.org/wiki/Pure_function" target="_blank">pure</a> function calls and reuses them where needed. <a href="http://fssnip.net/3v" target="_blank">This F# snippet</a> (based on this <a href="http://www.cs.utexas.edu/~wcook/Drafts/2006/MemoMixins.pdf" target="_blank">academic paper</a>) does this very well for the <a href="http://en.wikipedia.org/wiki/Fibonacci_number" target="_blank">Fibonacci sequence</a>, for instance. This would actually give some pretty cool benefits, especially as we have recursive operations that are highly repetitive in our code, but on the other hand would not give us benefits across server instances (and this is certainly something to consider if your application ends up scaling, over time).</p>  <p>Enter <a href="http://en.wikipedia.org/wiki/Cache_(computing)" target="_blank">caching</a>… while this doesn’t give us the internal efficiencies of memoization – meaning within the execution pass needed to generate the results for a single request – caching would allow us to store the results for a given request and simply not have to generate them again the next time they were needed. And if we implemented caching – which really does seem to make sense, given our desire to provide a scalable service – we would ultimately only see any benefits from memoization in the pass needed to populate the cache, anyway.</p>  <p>So let’s go ahead and implement caching for our service…</p>  <p>Caching in Windows Azure is <u>really</u> easy to implement. The main steps to follow can be found in <a href="https://www.windowsazure.com/en-us/develop/net/how-to-guides/cache/" target="_blank">this very straightforward set of instructions</a> [<strong>update:</strong> with the new distributed caching capability this link now points to something else… <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg278346.aspx" target="_blank">these instructions</a> show how I set up caching for this service]. I won’t repeat these steps, here – as the provided documentation is really good – but I will make a few comments before we take a look at the client-side changes to make use of this cache.</p>  <p>The caching service is not currently available in all Azure data-center locations:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20168ea712fe4970c-pi" target="_blank"><img style="background-image: none; border-right-width: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Creating our caching service" border="0" alt="Creating our caching service" src="/assets/image_943151.jpg" width="474" height="286" /></a></p>  <p>It’s for this reason I ended up choosing Western Europe to host my service, in the last post, as at least I knew the caching service would be co-locatable with it.</p>  <p>It’s also worth mentioning that if you’re using the caching service from your local ASP.NET service – which still works, but doesn’t make as much sense, as there’s communication overhead – then you may hit a different category of errors than you would when deployed in the cloud.</p>  <p>For instance, during integration of the caching service into my code, I regularly hit <a href="http://blogs.msdn.com/b/narahari/archive/2012/03/20/datacacheexception-errorcode-lt-errca0016-gt-substatus-lt-es0001-gt-is-being-thrown-when-using-windows-azure-cache.aspx" target="_blank">a DataCacheException exception</a>. This error can occur when you have large – in excess of 8 MB – records in your cache (which I know isn’t the case, as our level 10 circles results take up about 4.3 MB in a text file, and so shouldn’t hit the limit, even allowing for some inflation when in memory), but can also occur when you get a communication timeout (&gt;15s). This was almost certainly the case with my local web-service attempting to save to the central cache, but went away (I believe!) when everything was hosted on Azure.</p>  <p>I should also point out that I’ve now gone ahead and reduced the footprint of the JSON returned by our service (something I mentioned in an update to the last post): I never really liked having “Curvature” as a field name for every circle – and “Radius” for every sphere – so I reduced them to a single character (“C” and “R”, respectively). Which brings the data transferred down by a not-inconsiderable amount (~8% for spheres and ~14% for circles), so it was worth doing if at the expense of human-readability of the JSON output.</p>  <p>Now for the code to make use of our caching service… hopefully it’s reasonably obvious – even in F# – what was needed to use the service from a client (even if that client is inside our own services’ code :-) perspective. I've added some comments to help explain what’s going on.</p>  <p>Here’s the adjusted <em>CircleController.fs</em> file:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> FsWeb.Controllers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Net</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Web.Http</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Microsoft.ApplicationServer.Caching</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// A more compact profile for our data: we've shortened the field</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// names to keep the data store/transmitted down</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> Circle (X, Y, C, L) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.x = X</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.y = Y</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.k = C</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.l = L</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> CirclesController() =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">inherit</span><span style="line-height: 140%"> ApiController()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Get the cache - this is currently called for each request,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// it would be better to place this somewhere where it's called</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// only once</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cacheFactory = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> DataCacheFactory()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cache = cacheFactory.GetDefaultCache()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// A function to help scale our unit result by a given radius</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// (for circles we need to divide - rather than multiply - the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// curvature value)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> circleOfRad rad ((a:float, b:float, c:float), d:int) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Circle(a * rad, b * rad, c / rad, d)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Use a unique prefix to help us identify the &quot;circles&quot; results</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// in our cache (as it's shared across the two services)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cacheId steps = </span><span style="line-height: 140%; color: maroon">&quot;Circles&quot;</span><span style="line-height: 140%"> + steps.ToString();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// GET /api/circles/rad/steps</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.Get(rad:double, steps:int) =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We'll now reject calls for recursion levels above 10</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> steps &gt; 10 </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; raise (</span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> HttpResponseException(HttpStatusCode.BadRequest))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the cache doesn't contain the unit results we need,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// generate the</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cached = cache.Get(cacheId steps)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> cached = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> results =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CirclePackingFullFs.Packer.ApollonianGasket 1.0 steps</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And then attempt to add them into the cache, with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// an expiration time of two weeks hence. Note that we</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// serialize an array: serializing an F# list quickly</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// results in a stack overflow exception</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cache.Add(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cacheId steps,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; results |&gt; List.toArray,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; TimeSpan.FromDays(14.)) |&gt; ignore</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | _ </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> ()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Return the results, scaled by our radius</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; results |&gt; List.map (circleOfRad rad) |&gt; List.toSeq</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the cache contained the required unit results, cast</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// them to the right format and map our scaling function</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; cached :?&gt; (((float * float * float) * int) array) |&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Array.map (circleOfRad rad) |&gt; Array.toSeq</span></p> </div>  <p>And here’s the analogous – and very similar – <em>SpheresController.fs:</em></p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> FsWeb.Controllers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Net</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Web.Http</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> Microsoft.ApplicationServer.Caching</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// A more compact profile for our data: we've shortened the field</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// names to keep the data store/transmitted down</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> Sphere (X, Y, Z, R, L) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.x = X</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.y = Y</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.z = Z</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.r = R</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> this.l = L</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> SpheresController() =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">inherit</span><span style="line-height: 140%"> ApiController()&#160;&#160;&#160; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Get the cache - this is currently called for each request,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// it would be better to place this somewhere where it's called</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// only once</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cacheFactory = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> DataCacheFactory()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cache = cacheFactory.GetDefaultCache()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// A function to help scale our unit result by a given radius</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> sphereOfRad rad ((a:float, b:float, c:float, d:float), e:int) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Sphere(a * rad, b * rad, c * rad, d * rad, e)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Use a unique prefix to help us identify the &quot;spheres&quot; results</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// in our cache (as it's shared across the two services)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cacheId steps = </span><span style="line-height: 140%; color: maroon">&quot;Spheres&quot;</span><span style="line-height: 140%"> + steps.ToString();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// GET /api/spheres/rad/steps</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.Get(rad:double, steps:int) =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We'll now reject calls for recursion levels above 10</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> steps &gt; 10 </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; raise (</span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> HttpResponseException(HttpStatusCode.BadRequest))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the cache doesn't contain the unit results we need,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// generate them</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cached = cache.Get(cacheId steps)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> cached = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> results =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SpherePackingInversionFs.Packer.ApollonianGasket</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; steps 0.01 </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And then attempt to add them into the cache, with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// an expiration time of two weeks hence. Note that we</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// serialize an array: serializing an F# list quickly</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// results in a stack overflow exception</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cache.Add(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cacheId steps,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; results |&gt; List.toArray,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; TimeSpan.FromDays(14.)) |&gt; ignore</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | _ </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> ()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Return the results, scaled by our radius</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; results |&gt; List.map (sphereOfRad rad) |&gt; List.toSeq</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the cache contained the required unit results, cast</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// them to the right format and map our scaling function</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; cached :?&gt; (((float * float * float * float) * int) array) |&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Array.map (sphereOfRad rad) |&gt; Array.toSeq</span></p> </div>  <p>We’re choosing to cache our results for 2 weeks: the default is 48 hours, but I decided to extend that. We could also have extended that further, but for now I decided to keep it lower, as that way if I make errors during development the unnecessary entries will go away before too long. :-)</p>  <p>Let’s take a look at the cache usage (via my new favourite online tool, <a href="http://windows.azure.com" target="_blank">the Windows Azure Management Portal</a>):</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20163047bbeac970d-pi" target="_blank"><img style="background-image: none; border-right-width: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Our cache usage" border="0" alt="Our cache usage" src="/assets/image_108375.jpg" width="474" height="286" /></a></p>  <p>We’re up at about 40 MB: well below our 128 MB quota, and I suspect that’s about twice as big as it needs to be (when I changed the JSON format I also changed the cache prefix identifier, which will have led to the cache getting repopulated when actually it wasn’t needed: we’re not actually storing the JSON in the cache, but an array of F# tuples which then get mapped to JSON after retrieval… so the cache should be back down at around 20 MB in a couple of weeks’ time :-).</p>  <p>A very quick comment on whether this was all worth the effort, or not. I honestly <em>believe</em> so. While I haven’t undergone extensive performance benchmarking of the before and after state, I’ve seen the performance remain quite adequate (this may vary geographically, but spinning up instances in other data-centers would help that).</p>  <p>In this particular case where we have a fairly limited set of outcomes that are used repeatedly to generate results for the service, it makes good sense to implement caching, in this way. And the economics will certainly be favourable should we choose to scale the service upwards, adding additional extra-small VM instances over time to cope with increased demand.</p>  <p>Over the next couple of posts in this series, we’ll look at consuming the data in different ways. We’ll start with the classic AutoCAD client, and then have some real fun looking at a client developed using a game engine. :-)</p>  <p><strong><em>Update</em></strong></p>  <p>Thanks to <a href="http://through-the-interface.typepad.com/through_the_interface/2012/04/using-windows-azure-caching-with-our-aspnet-web-api-project.html#comment-6a00d83452464869e20163047c0601970d" target="_blank">prompting from Michael</a>, I went ahead and rounded off the decimals being returned to the caller to 4 decimal places. It was a simple matter of swapping the circleOfRad and sphereOfRad functions for these implementations:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> circleOfRad rad ((a:float, b:float, c:float), d:int) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Circle(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Math.Round(a * rad, 4),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Math.Round(b * rad, 4),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Math.Round(c / rad, 4),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; d)</span></p> </div>  <p>and</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> sphereOfRad rad ((a:float, b:float, c:float, d:float), e:int) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Sphere(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Math.Round(a * rad, 4),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Math.Round(b * rad, 4),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Math.Round(c * rad, 4),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Math.Round(d * rad, 4),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; e)</span></p> </div>  <p>Which led to a further reduction of 40-50% in the JSON download. :-)</p>
