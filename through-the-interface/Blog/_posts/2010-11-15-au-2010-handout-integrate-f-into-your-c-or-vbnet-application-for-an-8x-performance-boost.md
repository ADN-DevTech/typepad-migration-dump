---
layout: "post"
title: "AU 2010 Handout: Integrate F# into Your C# or VB.NET Application for an 8x Performance Boost"
date: "2010-11-15 21:19:14"
author: "Kean Walmsley"
categories:
  - "AU"
  - "AutoCAD"
  - "AutoCAD .NET"
  - "F#"
  - "Plugin of the Month"
  - "Point clouds"
  - "WPF"
original_url: "https://www.keanw.com/2010/11/au-2010-handout-integrate-f-into-your-c-or-vbnet-application-for-an-8x-performance-boost.html "
typepad_basename: "au-2010-handout-integrate-f-into-your-c-or-vbnet-application-for-an-8x-performance-boost"
typepad_status: "Publish"
---

<p>This handout is for the companion class to the one whose handout formed <a href="http://through-the-interface.typepad.com/through_the_interface/2010/11/au-2010-handout-point-clouds-on-a-shoestring.html" target="_blank">my last post</a>. While that class was user-focused, this one, “<em>CP322-2 - Integrate F# into Your C# or VB.NET Application for an 8x Performance Boost</em>”, is more developer-focused and takes the hood off the implementation of the BrowsePhotosynth application. The code for this special version of the application – which imports synchronously via C# and synchronously/asynchronously via F# – is available <a href="http://through-the-interface.typepad.com/files/BrowsePhotosynth-for-AU.zip" target="_blank">here for download</a>.</p>  <p><strong>Introduction</strong></p>  <p>This class takes a look at the implementation of BrowsePhotosynth for AutoCAD, the <a href="http://labs.autodesk.com/utilities/ADN_plugins" target="_blank">ADN Plugin of the Month</a> from October 2010 and the application showcased in the companion, user-oriented class, “<em>AC427-4 - Point Clouds on a Shoestring</em>”. We’ll look at some of the design decisions behind the application, particularly with respect to the use of F# to help download and process the various files making up a Photosynth’s point cloud.</p>  <p>To understand more about the purpose of this application, it’s first worth taking a look at <a href="http://through-the-interface.typepad.com/through_the_interface/2010/11/au-2010-handout-point-clouds-on-a-shoestring.html" target="_blank">the handout to the companion class</a>. In a nutshell, the BrowsePhotosynth application allows users of AutoCAD 2011 (and, in due course, above) to browse the contents of the Photosynth web-service and easily bring down point clouds corresponding to the “synths” hosted on the site.</p>  <p><strong>The System Architecture</strong></p>  <p>Let’s take a look at the overall architecture of the system before diving into the individual components.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f5e0ebd9970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Component architecture" border="0" alt="Component architecture" src="/assets/image_105363.jpg" width="475" height="207" /></a>Here we can see a few DLLs are hosted by AutoCAD: the primary one is called <em>ADNPlugin-BrowsePhotosynth.dll</em> and implements a number of commands, the most important of which are BROWSEPS and IMPORTPS. It is this DLL that needs to be NETLOADed or&#160; demand-loaded into AutoCAD for the BrowsePhotosynth application to work properly.</p>  <p>Users will call BROWSEPS, which causes the UI component - <em>ADNPlugin-PhotosynthBrowser.exe – </em>to be launched to present a dialog user to the user. This dialog will – in turn – call the IMPORTPS back in AutoCAD to download, process and import the point cloud data. It’s during this processing phase that the main Importer may choose to use a separate component, the Processor DLL (<em>ADNPlugin-PhotosynthProcessor.dll</em>). This functionality has been packaged as a separate component as it was written in F#.</p>  <p><strong>The User Interface</strong></p>  <p>As mentioned above, the main entry-point into the application is the BROWSEPS command, which launches a <a href="http://en.wikipedia.org/wiki/Windows%20Presentation%20Foundation" target="_blank">WPF</a> dialog implemented in the “<em>Browser</em>” project of the main solution.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134890113d7970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="The BrowsePhotosynth dialog in AutoCAD 2011" border="0" alt="The BrowsePhotosynth dialog in AutoCAD 2011" src="/assets/image_461086.jpg" width="456" height="319" /></a> This project actually builds an EXE (<em>ADNPlugin-PhotosynthBrowser.exe</em>), rather than a DLL, which is interesting for a few reasons:</p>  <ul>   <li><strong>Isolation</strong> from AutoCAD       <ul>       <li>This 32-bit EXE can be executed via <a href="http://en.wikipedia.org/wiki/WoW64" target="_blank">WoW64</a> on 64-bit systems (more later on why this is important) </li>        <li>The memory footprint is managed separately – it doesn’t contribute to the size of AutoCAD’s process space </li>     </ul>   </li>    <li><strong>Portability</strong> to other products       <ul>       <li>As we support point clouds across more of our products, having an independent GUI component will simplify migration to support them </li>     </ul>   </li>    <li>Can even by used <strong>standalone</strong>       <ul>       <li>As the browser does not depend on AutoCAD, it can also be executed separately, allowing the user to build up the lost of point clouds to import before even launching AutoCAD </li>     </ul>   </li> </ul>  <p>The overriding reason for this design was the first: the ability to run as 32-bit even on 64-bit OSs was important as we make use of a 3rd party component, <a href="http://code.google.com/p/csexwb2/" target="_blank">csExWb2</a>, which is currently only available as a 32-bit version. This component also causes an error when the hosting dialog closes (which you will see if you launch the EXE separately, as described in the third point above). It’s also for this reason – to isolate the user from this error, which cause AutoCAD stability problems when it happened in an in-process component – that the dialog is hosted in a separate application. The main plugin launches and maintains an instance of the dialog’s process: when the dialog is closed it is effectively hidden and the process gets terminated at an appropriate point later on, thus avoiding the error. If AutoCAD gets terminated unexpectedly (such as via the debugger), there may be a stray process which is detected and terminated (should the user request it) when the application is next used.</p>  <p>So why used a 3rd party component, if it causes all this problems? The component implements a web-browser control that reports the HTTP traffic generated by its contents to the application. This allows us to detect when the user has visited a page containing a synth, as the embedded Silverlight control requests a file named “<em>points_0_0.bin</em>”, the file containing the point cloud’s first 5,000 points. There may be other browser controls available that implement this capability, but I unfortunately haven’t found any.</p>  <p>As the application detects point clouds being accessed, they get added to the list on the right of the dialog using an image that is also pulled down from the Photosynth server.</p>  <p>The original UI was implemented using <a href="http://en.wikipedia.org/wiki/Windows%20Forms" target="_blank">WinForms</a>, but the benefits of using WPF quickly became apparent as additional UI features – such as the ability to resize the items using a slider – became desirable. It’s worth taking a look at some of the techniques used in the WPF application – here are some of them:</p>  <ul>   <li>Our list of point clouds is bound to an ObservableCollection&lt;&gt; of objects containing the information we care about      <ul>       <li>We had to implement INotifyPropertyChanged for this to work properly </li>        <li>We add items to this list when our HTTP event is fired, but as we’re not executing on the UI thread, at that point, we need to request the list to be updated via Dispatcher.Invoke() </li>     </ul>   </li>    <li>We use a WindowInteropHelper to make AutoCAD’s main window the parent of the EXE      <ul>       <li>This gives a modal – rather than modeless – feel to the UI </li>     </ul>   </li>    <li>The display of our listbox has been customized significantly      <ul>       <li>It selects on hover </li>        <li>It has a custom gradient fill to better fit the look &amp; feel of the Photosynth site </li>     </ul>   </li> </ul>  <p>For additional information regarding the development of the WPF UI for this application, see <a href="http://through-the-interface.typepad.com/through_the_interface/2010/04/importing-photosynth-point-clouds-into-autocad-2011---part-3.html" target="_blank">this blog post</a>.</p>  <p>Now on to how the UI communicates with AutoCAD. To avoid any dependency on AutoCAD from the WPF application, it simply uses Windows messages to launch the IMPORTPS command. This decoupling is healthy for portability reasons but also to make sure the command gets launched cleanly: it is considered best practice to launch commands in AutoCAD from a modeless UI, whether using AutoCAD’s SendStringToExecute() API or using Win32’s SendMessage().</p>  <p><strong>The Import Process</strong></p>  <p>The IMPORTPS command – which is actually the real heart of the application – has the following process:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20134890113fb970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="BrowsePhotosynth flow chart" border="0" alt="BrowsePhotosynth flow chart" src="/assets/image_792256.jpg" width="485" height="116" /></a> </p>  <p>It’s worth noting that the application doesn’t actually make much use of AutoCAD’s APIs: it uses SendStringToExecute() to fire off standard commands to index and attach the point cloud, but aside from that the plugin’s code is also fairly standalone in nature.</p>  <p>We’re most interested with the left-hand part of this process, where we bring the <em>.bin</em> files down from the Photosynth server and process them into a single text file. Let’s start by understanding why there are all these files to download, process and combine.</p>  <p>Photosynth’s web service stores point clouds in chunks of 5,000 points. So if we have a point cloud comprising 26,000 points it will be stored in 6 files named <em>points_0_0.bin</em>, <em>points_0_1.bin</em>, <em>points_0_2.bin</em>, <em>points_0_3.bin</em>, <em>points_0_4.bin</em> and <em>points_0_5.bin</em>, each containing 5,000 points, apart from the last which will only contain 1,000. This has most probably been done to enable the Silverlight control to stream down sections of the point cloud selectively/progressively. There may be additional point clouds (contained in files such as <em>points_2_0.bin</em>, etc.), but as these do not share a coordinate system with the primary point cloud, including them only proves confusing. These could easily be downloaded and combined into separate PCG files inside AutoCAD, but this has been left as an exercise for the user, as the merit of doing so seems somewhat dubious.</p>  <p>Now onto the main purpose of this class. :-)</p>  <p>Given the unordered nature of point clouds – at least from AutoCAD’s perspective – this presents us with a really interesting optimization opportunity: rather than downloading and processing the files sequentially via synchronous API calls, we can choose to perform this work asynchronously. Asynchronous programming is a hot topic, right now, and currently a key benefit F# brings over VB.NET and C# – hence the somewhat provocative title for this class. That said, <a href="http://bit.ly/bBGOfV" target="_blank">Anders Hejlsberg’s recent announcement</a> at <a href="http://player.microsoftpdc.com/" target="_blank">PDC 2010</a> regarding the addition of <a href="http://msdn.microsoft.com/en-us/vstudio/async.aspx" target="_blank">asynchronous programming support to VB.NET and C#</a> – which can be used right now with <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=18712f38-fcd2-4e9f-9028-8373dc5732b2&amp;displaylang=en" target="_blank">the Visual Studio Async CTP</a> – will definitely enable this kind of functionality from your preferred .NET language, over time. Also worth checking out is <a href="http://channel9.msdn.com/Blogs/Charles/Anders-Hejlsberg-Introducing-Async" target="_blank">the accompanying Channel 9 interview</a>.</p>  <p>Anders’ demo shows very eloquently why the current mode of making asynchronous calls from VB.NET and C# is inadequate. While the <a href="http://en.wikipedia.org/wiki/Parallel_Extensions" target="_blank">Parallel Extensions for .NET</a> – provided in .NET 4.0 – was a great addition for simplifying the management of multiple tasks, strong support for asynchronous calls was missing. This area is still a key advantage of using F#: its elegant Asynchronous Workflows feature makes the description and execution of asynchronous tasks really easy.</p>  <p>Before we look at applying Asynchronous Workflows to this problem, let’s see a standard synchronous approach in C#:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Net;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.IO;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> PhotosynthProcSyncCs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PointCloudProcessor</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> _ed;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ProgressMeter</span><span style="line-height: 140%"> _pm;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> _localPath;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> PointCloudProcessor(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed, </span><span style="line-height: 140%; color: #2b91af">ProgressMeter</span><span style="line-height: 140%"> pm, </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> localPath</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ed = ed;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _pm = pm;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _localPath = localPath;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">long</span><span style="line-height: 140%"> ProcessPointCloud(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> path, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">[] dims, </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> txtPath</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Counter for the total number of points</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">long</span><span style="line-height: 140%"> totalPoints = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create our intermediate text file in the temp folder</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">FileInfo</span><span style="line-height: 140%"> t = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">FileInfo</span><span style="line-height: 140%">(txtPath);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">StreamWriter</span><span style="line-height: 140%"> sw = t.CreateText();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (sw)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We'll use a web client to download each .bin file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">WebClient</span><span style="line-height: 140%"> wc = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">WebClient</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (wc)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> maj=0; maj &lt; dims.Length; maj++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> min=0; min &lt; dims[maj]; min++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Loop for each .bin file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> root =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; maj.ToString() + </span><span style="line-height: 140%; color: #a31515">&quot;_&quot;</span><span style="line-height: 140%"> + min.ToString() + </span><span style="line-height: 140%; color: #a31515">&quot;.bin&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> src = path + root;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> loc = _localPath + root;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; wc.DownloadFile(src, loc);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">catch</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Exists(loc))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Open our binary file for reading</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Open(loc, </span><span style="line-height: 140%; color: #2b91af">FileMode</span><span style="line-height: 140%">.Open)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (br)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// First information is the file version</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (for now we support version 1.0 only)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">ushort</span><span style="line-height: 140%"> majVer = ReadBigEndianShort(br);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">ushort</span><span style="line-height: 140%"> minVer = ReadBigEndianShort(br);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (majVer != 1 || minVer != 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nCannot read a Photosynth point cloud &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;of this version ({0}.{1}).&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; majVer, minVer</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Clear some header bytes we don't care about</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> n = ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i = 0; i &lt; n; i++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> m = ReadCompressedInt(br);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> j = 0; j &lt; m; j++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Find out the number of points in the file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> numPoints = ReadCompressedInt(br);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; totalPoints += numPoints;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nProcessed points_{0} containing {1} points.&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; root, numPoints</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> k = 0; k &lt; numPoints; k++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Read our coordinates</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> x = ReadBigEndianFloat(br);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> y = ReadBigEndianFloat(br);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> z = ReadBigEndianFloat(br);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Read and extract our RGB values</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">UInt16</span><span style="line-height: 140%"> rgb = ReadBigEndianShort(br);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> r = (rgb &gt;&gt; 11) * 255 / 31;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> g = ((rgb &gt;&gt; 5) &amp; 63) * 255 / 63;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> b = (rgb &amp; 31) * 255 / 31;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Write the point with its color to file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sw.WriteLine(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;{0},{1},{2},{3},{4},{5}&quot;</span><span style="line-height: 140%">, x, y, z, r, g, b</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">catch</span><span style="line-height: 140%"> (System.</span><span style="line-height: 140%; color: #2b91af">Exception</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nError processing point cloud file &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\&quot;points_{0}\&quot;: {1}&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; root, ex.Message</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Delete our local .bin file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Delete(loc);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Show some progress</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _pm.MeterProgress();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Windows.Forms.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DoEvents();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> totalPoints;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> ReadCompressedInt(</span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%"> b;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">do</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; b = br.ReadByte();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; i = (i &lt;&lt; 7) | (b &amp; 127);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> (b &lt; 128);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> i;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> ReadBigEndianFloat(</span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%">[] b = br.ReadBytes(4);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">BitConverter</span><span style="line-height: 140%">.ToSingle(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%">[] { b[3], b[2], b[1], b[0] },</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">UInt16</span><span style="line-height: 140%"> ReadBigEndianShort(</span><span style="line-height: 140%; color: #2b91af">BinaryReader</span><span style="line-height: 140%"> br)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%"> b1 = br.ReadByte();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">byte</span><span style="line-height: 140%"> b2 = br.ReadByte();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">ushort</span><span style="line-height: 140%">)(b2 | (b1 &lt;&lt; 8));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div> <!--EndFragment-->  <p>The important thing to note about the signature of the ProcessPointCloud() function – which I’ve kept the same across the C# and F# implementations – is the way the dims variable works: this is a simple array – populated by querying the Photosynth web service – of the number of files to download for the various point clouds in the synth. For example: if a synth contains three point clouds, the first comprising 5 files, the second of 3 files and the third of 1 file, { 5, 3, 1 } would get passed into the function, which would then attempt to download the following files: <em>points_0_0.bin</em>, <em>points_0_1.bin</em>, <em>points_0_2.bin</em>, <em>points_0_3.bin</em>, <em>points_0_4.bin</em>, <em>points_1_0.bin</em>, <em>points_1_1.bin</em>, <em>points_1_2.bin</em> and <em>points_2_0.bin</em>. As mentioned earlier, I’ve recently change the approach to only download the first point cloud for each synth, so only the <em>points_0_x.bin</em> files will be downloaded and processed. Which means dims will now always only have one entry.</p>  <p>The above code works in a very linear fashion: download a file, process it, download the next, process that, etc.</p>  <p>Now let’s take a look at the equivalent Asynchronous Workflows implementation in F#:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">module</span><span style="line-height: 140%"> PhotosynthProcAsyncFs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Globalization</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Threading</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Text</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.Net</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System.IO</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">open</span><span style="line-height: 140%"> System</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// We need the SynchronizationContext of the UI thread,</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// to allow us to make sure our UI update events get</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// processed correctly in the calling application</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">mutable</span><span style="line-height: 140%"> syncContext : SynchronizationContext = </span><span style="line-height: 140%; color: blue">null</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Asynchronous Worker courtesy of Don Syme:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">//&#160; http://blogs.msdn.com/dsyme/archive/2010/01/10/async-and-</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">//&#160; parallel-design-patterns-in-f-reporting-progress-with-</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">//&#160; events-plus-twitter-sample.aspx</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> Agent&lt;'T&gt; = MailboxProcessor&lt;'T&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> SynchronizationContext </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// A standard helper extension method to raise an event on</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// the GUI thread</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> syncContext.RaiseEvent (event: Event&lt;_&gt;) args =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syncContext.Post((</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> _ </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> event.Trigger args),state=</span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> AsyncWorker&lt;'T&gt;(jobs: seq&lt;Async&lt;'T&gt;&gt;) =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Each of these lines declares an F# event that we can raise</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> allCompleted&#160; = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Event&lt;'T[]&gt;()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> error&#160;&#160;&#160;&#160;&#160;&#160;&#160; = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Event&lt;System.Exception&gt;()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> canceled&#160;&#160;&#160;&#160;&#160; = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Event&lt;System.OperationCanceledException&gt;()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> jobCompleted&#160; = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Event&lt;int * 'T&gt;()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> cancellationCapability = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> CancellationTokenSource()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Start an instance of the work</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.Start() =&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Capture the synchronization context to allow us to raise</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// events back on the GUI thread</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> syncContext = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; syncContext &lt;- SynchronizationContext.Current</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> syncContext = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; raise(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.NullReferenceException(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;Synchronization context is null.&quot;</span><span style="line-height: 140%">))&#160;&#160;&#160;&#160;&#160; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Mark up the jobs with numbers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> jobs = jobs |&gt; Seq.mapi (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> i job </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> (job,i+1))</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> work = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Async.Parallel</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; [ </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (job,jobNumber) </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> jobs </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; async { </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> result = job</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; syncContext.RaiseEvent</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; jobCompleted (jobNumber,result)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> result } ]</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Async.StartWithContinuations(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; work,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> res </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> syncContext.RaiseEvent allCompleted res),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> exn </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> syncContext.RaiseEvent error exn),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> exn </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> syncContext.RaiseEvent canceled exn ),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; cancellationCapability.Token)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.CancelAsync() =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cancellationCapability.Cancel()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Raised when a particular job completes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.JobCompleted = jobCompleted.Publish</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Raised when all jobs complete</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.AllCompleted = allCompleted.Publish</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Raised when the composition is cancelled successfully</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.Canceled = canceled.Publish</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Raised when the composition exhibits an error</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.Error = error.Publish</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">type</span><span style="line-height: 140%"> PointCloudProcessor() =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Mutable state to track progress and results</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">mutable</span><span style="line-height: 140%"> jobsComplete = 0 </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">mutable</span><span style="line-height: 140%"> jobsFailed = 0 </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">mutable</span><span style="line-height: 140%"> totalJobs = 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">mutable</span><span style="line-height: 140%"> totalPoints = 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">mutable</span><span style="line-height: 140%"> completed = </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Event to allow caller to update the UI</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> jobCompleted&#160; = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Event&lt;string * int&gt;()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Function to access a stream asynchronously</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> httpAsync(url:string) =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; async {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> req = WebRequest.Create(url)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> rsp = req.AsyncGetResponse()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> rsp.GetResponseStream()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Functions to read data from our point stream</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">rec</span><span style="line-height: 140%"> readCompressedInt (i:int) (br:BinaryReader) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> b = br.ReadByte()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> i = (i &lt;&lt;&lt; 7) ||| ((int)b &amp;&amp;&amp; 127)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (int)b &lt; 128 </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; readCompressedInt i br</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; i</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> readBigEndianFloat (br:BinaryReader) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> b = br.ReadBytes(4)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; BitConverter.ToSingle( [| b.[3]; b.[2]; b.[1]; b.[0] |], 0)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> readBigEndianShort (br:BinaryReader) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> b1 = br.ReadByte()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> b2 = br.ReadByte()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ((uint16)b2 ||| ((uint16)b1 &lt;&lt;&lt; 8))</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Recursive function to read n points from our stream</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// (We use an accumulator variable to enable tail-call</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// optimization)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">rec</span><span style="line-height: 140%"> readPoints acc n br =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> n &lt;= 0 </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; acc</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Read our coordinates</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> x = readBigEndianFloat br</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> y = readBigEndianFloat br</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> z = readBigEndianFloat br</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Read and extract our RGB values</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> rgb = readBigEndianShort br</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> r = (rgb &gt;&gt;&gt; 11) * 255us / 31us</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> g = ((rgb &gt;&gt;&gt; 5) &amp;&amp;&amp; 63us) * 255us / 63us</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> b = (rgb &amp;&amp;&amp; 31us) * 255us / 31us</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; readPoints ((x,y,z,r,g,b) :: acc) (n-1) br</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Function to extract the various point information</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// from a stream corresponding to a single point file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> extractPoints br =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// First information is the file version</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (for now we support version 1.0 only)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> majVer = readBigEndianShort br</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> minVer = readBigEndianShort br</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (int)majVer &lt;&gt; 1 || (int)minVer &lt;&gt; 0 </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; []</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Clear some header bytes we don't care about</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> n = readCompressedInt 0 br</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> i </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> 0..(int)n-1 </span><span style="line-height: 140%; color: blue">do</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> m = readCompressedInt 0 br</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> j </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> 0..(int)m-1 </span><span style="line-height: 140%; color: blue">do</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; readCompressedInt 0 br |&gt; ignore</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; readCompressedInt 0 br |&gt; ignore</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Find out the number of points in the file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> npts = readCompressedInt 0 br</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Read and return the points</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; readPoints [] npts br</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Recursive function to create a string from a list</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// of points. Our accumulator is a StringBuilder,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// which is the most efficient way to collate a</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// string</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">rec</span><span style="line-height: 140%"> pointsToString (acc : StringBuilder) pts =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">match</span><span style="line-height: 140%"> pts </span><span style="line-height: 140%; color: blue">with</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; | [] </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> acc.ToString()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; | (x:float32,y:float32,z:float32,r,g,b) :: t </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; acc.AppendFormat(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;{0},{1},{2},{3},{4},{5}\n&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; x.ToString(CultureInfo.InvariantCulture),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; y.ToString(CultureInfo.InvariantCulture),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; z.ToString(CultureInfo.InvariantCulture),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; r,g,b)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; |&gt; ignore</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pointsToString acc t</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Expose an event that's subscribable from C#/VB</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; [&lt;CLIEvent&gt;]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.JobCompleted = jobCompleted.Publish</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Property to indicate that we're done</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.IsComplete = completed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Property to find out of any fyailures</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.Failures = jobsFailed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Property to return the results</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.TotalPoints = totalPoints</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Our main function to download and process the point</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// cloud(s) associated with a particular Photosynth</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">member</span><span style="line-height: 140%"> x.ProcessPointCloud baseUrl dims txtPath =</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// A local function to add the URL prefix to each file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> pathToFile file = baseUrl + file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Generate our list of files from the list of dimensions</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// of the various point clouds</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Each entry in dims corresponds to the number of files:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">//&#160; dims[0] = 5 means &quot;points_0_0.bin&quot; .. &quot;points_0_4.bin&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">//&#160; dims[6] = 3 means &quot;points_6_0.bin&quot; .. &quot;points_6_2.bin&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> files =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Array.mapi</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> i d </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Array.map (</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> j </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> sprintf </span><span style="line-height: 140%; color: maroon">&quot;%d_%d.bin&quot;</span><span style="line-height: 140%"> i j) [| 0..d-1 |]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; dims</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; |&gt; Array.concat</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; |&gt; List.ofArray</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set/reset mutable state</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; totalJobs &lt;- files.Length</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; jobsComplete &lt;- 0</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Open the local, temporary text file to hold our points</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> t = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> FileInfo(txtPath)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> sw = t.Create()</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// An agent to store our points in the file...</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Loops and receives messages, so that we ensure we don't</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// have a conflict of simultaneous writes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> fileAgent =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Agent.Start(</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> inbox </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; async { </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">do</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> (msg : string) = inbox.Receive()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">do!</span><span style="line-height: 140%"> sw.AsyncWrite(Encoding.ASCII.GetBytes(msg)) })</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our basic asynchronous task to process a file, returning</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// the number of points</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> processFile (file:string) =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; async {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> stream = httpAsync file</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> reader = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> BinaryReader(stream)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> pts = extractPoints reader</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pointsToString (</span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> StringBuilder()) pts |&gt; fileAgent.Post</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> file, pts.Length</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our jobs are a set of tasks, one for each file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> jobs =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; [</span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> file </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> files </span><span style="line-height: 140%; color: blue">-&gt;</span><span style="line-height: 140%"> pathToFile file |&gt; processFile]</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create our AsyncWorker for our jobs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> worker = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> AsyncWorker&lt;_&gt;(jobs)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Raise an event when each file is processed and update</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// our internal state</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; worker.JobCompleted.Add(</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> (jobNumber, (url , ptnum)) </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> file = url.Substring(url.LastIndexOf(</span><span style="line-height: 140%; color: maroon">'/'</span><span style="line-height: 140%">)+1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; jobsComplete &lt;- jobsComplete + 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; syncContext.RaiseEvent jobCompleted (file, ptnum)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the last job, close our temporary file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> jobsComplete = totalJobs </span><span style="line-height: 140%; color: blue">then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; sw.Close()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; sw.Dispose()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Raise an event when an error occurs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; worker.Error.Add(</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> ex </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; jobsComplete &lt;- jobsComplete + 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; jobsFailed &lt;- jobsFailed + 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; syncContext.RaiseEvent jobCompleted (</span><span style="line-height: 140%; color: maroon">&quot;Failed&quot;</span><span style="line-height: 140%">, 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Raise an event on cancellation</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; worker.Canceled.Add(</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> ex </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; worker.CancelAsync()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; jobsComplete &lt;- totalJobs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; jobsFailed &lt;- totalJobs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Once we're all done, set the results as state to be</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// accessed by our calling routine</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; worker.AllCompleted.Add(</span><span style="line-height: 140%; color: blue">fun</span><span style="line-height: 140%"> results </span><span style="line-height: 140%; color: blue">-&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; totalPoints &lt;- Array.sumBy snd results</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; completed &lt;- </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Now start the work</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; worker.Start()</span></p> </div> <!--EndFragment-->  <p>This implementation makes use of the AsyncWorker&lt;&gt; class: a standard <a href="http://blogs.msdn.com/b/dsyme/archive/2010/01/10/async-and-parallel-design-patterns-in-f-reporting-progress-with-events-plus-twitter-sample.aspx" target="_blank">design pattern implemented by Don Syme</a> to report progress during a series of asynchronous tasks. We have events – raised on the UI thread, which means we can call back into AutoCAD safely – for when tasks complete, fail or get cancelled. Let’s take a closer look at the core function in this implementation, that which processes a single file:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 1</span>&#160;<span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> processFile (file:string) =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 2</span>&#160;<span style="line-height: 140%">&#160; async {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 3</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let!</span><span style="line-height: 140%"> stream = httpAsync file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 4</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">use</span><span style="line-height: 140%"> reader = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> BinaryReader(stream)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 5</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">let</span><span style="line-height: 140%"> pts = extractPoints reader</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 6</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; pointsToString (</span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> StringBuilder()) pts |&gt; fileAgent.Post</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 7</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> file, pts.Length</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 8</span>&#160;<span style="line-height: 140%">&#160; }</span></p> </div> <!--EndFragment-->  <p>The first line names the function and declares it to take a string argument. The second line says the whole operation is to be considered an asynchronous task, which means it can be executed in a non-blocking way. The third line is the only actual call that is made asynchronously, as denoted by the “!”, which tells the F# compiler to call the function but only continue with the assignment and the code following it once the results arrive. The rest of the code actually just takes the downloaded file and processes its contents by using a BinaryReader and extracting the various points in a very linear fashion. There was really no advantage to be had in attempting to make the processing asynchronous – the real benefit is derived from performing the download asynchronously rather than the processing.</p>  <p>One important point about the way this code works: it’s all very well requesting data which then gets processed in a random order as it arrives back, but we do need to coordinate placing that data into our text file (which, as you saw in the process diagram, will then get processed into a LAS file before that, in turn, gets indexed into a PCG and attached inside an AutoCAD drawing). The points can come in any order – we’re not fussy about the ordering – but they do need to all make it in there. The way I’ve approached that is to use a agent-based message-passing (as described in more detail in <a href="http://through-the-interface.typepad.com/through_the_interface/2009/11/using-erlang-style-message-passing-from-f-to-coordinate-asynchronous-tasks-in-autocad.html" target="_blank">this blog post)</a>. This sets up a central mailbox for requests to write to out text file: as the messages get processed, the points get added to the file.</p>  <p>What’s important to note about these “tasks”: we have spent all out time saying what needs to happen – not when. The timing of the execution of these tasks is handled completely by the F# runtime and the .NET Framework – we really don’t need to care about how and when things happen.</p>  <p>Just to make sure there wasn’t any inherent benefit from using F# rather than C#, I also implemented an additional “F# synchronous” mode. The code is provided in <a href="http://through-the-interface.typepad.com/files/BrowsePhotosynth-for-AU.zip" target="_blank">the project associated with this class</a>.</p>  <p>What’s potentially of more interest is the approach I’ve used to switch between the various implementations: I’ve used a capability in AutoCAD 2011 allowing system variables to be added via the Registry. Here’s the .reg file I’ve used to do this:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">Windows Registry Editor Version 5.00</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">[HKEY_LOCAL_MACHINE\SOFTWARE\Autodesk\AutoCAD\R18.1\ACAD-9001:409\Variables\BROWSEPSSYNC]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;StorageType&quot;=dword:00000002</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;LowerBound&quot;=dword:00000000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;UpperBound&quot;=dword:00000002</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;PrimaryType&quot;=dword:0000138b</span></p>    <p style="margin: 0px"><span style="line-height: 140%">@=&quot;0&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">[HKEY_LOCAL_MACHINE\SOFTWARE\Autodesk\AutoCAD\R18.1\ACAD-9001:409\Variables\BROWSEPSLOG]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;StorageType&quot;=dword:00000002</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;LowerBound&quot;=dword:00000000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;UpperBound&quot;=dword:00000001</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&quot;PrimaryType&quot;=dword:0000138b</span></p>    <p style="margin: 0px"><span style="line-height: 140%">@=&quot;0&quot;</span></p>    <p style="margin: 0px">&#160;</p> </div> <!--EndFragment-->  <p>This adds two sysvars to AutoCAD:</p>  <ul>   <li>BROWSEPSSYNC – an integer between 0 and 2, stored per-user</li>    <ul>     <li>Used to indicate the synchrony mode:</li>      <ul>       <li>0 = C# synchronous</li>        <li>1 = F# synchronous</li>        <li>2 = F# asynchronous</li>     </ul>   </ul>    <li>BROWSEPSLOG – an integer between 0 and 1, stored per-user</li>    <ul>     <li>Used to indicate whether to save the performance information in a log file</li>   </ul> </ul>  <p>We’re then able to get the values of these system variables using (for instance) Application.GetSystemVariable(“BROWSEPSSYNC”) in our code. The IMPORTPS implementation now uses the appropriate user-selected synchrony mode, and – optionally – stores the performance data in “<em>Documents\Photosynth Point Clouds\log.txt</em>”.</p>  <p>To put the code through its paces, I modified the mode before importing each of a number of my favourite synths, in increasing order of size:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">Vietnam Memorial Statue using C# synchronous: 46293 points from 10 files in 00:00:06.7260000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">Vietnam Memorial Statue using F# synchronous: 46293 points from 10 files in 00:00:02.3120000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">Vietnam Memorial Statue using F# asynchronous: 46293 points from 10 files in 00:00:01.5560000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">National Geographic - Sphinx using C# synchronous: 102219 points from 21 files in 00:00:17.3470000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">National Geographic - Sphinx using F# synchronous: 102219 points from 21 files in 00:00:16.5290000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">National Geographic - Sphinx using F# asynchronous: 102219 points from 21 files in 00:00:04.2920000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">L'epee de la Tene using C# synchronous: 405998 points from 82 files in 00:00:57.8160000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">L'epee de la Tene using F# synchronous: 405998 points from 82 files in 00:00:54.2560000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">L'epee de la Tene using F# asynchronous: 405998 points from 82 files in 00:00:08.3740000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">Another Tres Yonis Synth using C# synchronous: 1141257 points from 229 files in 00:03:56.0490000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">Another Tres Yonis Synth using F# synchronous: 1141257 points from 229 files in 00:04:20.4900000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">Another Tres Yonis Synth using F# asynchronous: 1141257 points from 229 files in 00:00:21.3790000</span></p> </div> <!--EndFragment-->  <p>Just to be clear: I did change the order of the execution – to make sure “C# synchronous” didn’t have the disadvantage of pulling down data that was cached for the other modes – but I’ve reordered them for ease of reading (it didn’t change anything at all in terms of results).</p>  <p>Here’s the data in a graphical form:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2013489011433970c-pi"><img style="border-bottom: 0px; border-left: 0px; margin: 20px auto; display: block; float: none; border-top: 0px; border-right: 0px" title="Performance graph" border="0" alt="Performance graph" src="/assets/image_975765.jpg" width="485" height="240" /></a> We can see that the difference in performance between C# and F# when working synchronously is modest: F# seems a bit quicker overall by then C# was much a bit quicker on the largest. But both were blown away by F# asynchronous: at worst F# async was 4 times faster, but at best it was 12 times faster!</p>
