---
layout: "post"
title: "Streamlined QuickSaveAs command for AutoCAD 2010"
date: "2009-10-30 06:38:00"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Commands"
  - "User interface"
original_url: "https://www.keanw.com/2009/10/streamlined-quicksaveas-command-for-autocad-2010.html "
typepad_basename: "streamlined-quicksaveas-command-for-autocad-2010"
typepad_status: "Publish"
---

<P>A big thanks to Tony Tanzillo for providing some tips to help improve the implementation of the application we saw in these <A href="http://through-the-interface.typepad.com/through_the_interface/2009/10/implementing-a-quick-saveas-command-in-autocad-using-net.html">previous</A> <A href="http://through-the-interface.typepad.com/through_the_interface/2009/10/adding-items-to-an-autocad-tool-palette-using-net.html">posts</A>: in particular Tony pointed out the ability of AutoCAD 2010 to generate a thumbnail image for a document in the editor programmatically (something I had forgotten was possible… at least I think I knew it existed – it certainly seemed familiar once I saw it :-S). Anyway, the version of the code in this post will only work from AutoCAD 2010 onwards because of the use of this function, Document.CapturePreviewImage().</P>
<P>Tony’s code also showed some interesting capabilities of the .NET Framework related to filename and path manipulation, so I also borrowed some of those techniques to avoid some ugly string parsing/manipulation.</P>
<P>Because of this ability to generate thumbnails – something I really wanted from the beginning – we can avoid the use of SAVEAS and simply use Document.SaveAs(), which will save a copy of the drawing without renaming the version in the editor (which in my particular situation is desirable). And clearly there’s no longer any need for a continuation function (whether or not you believe that was an appropriate way to implement the application in the first place).</P>
<P>Here’s the updated C# code:</P>
<div style="font-family: Courier New; font-size: 8pt; color: black; background: white;"><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.ApplicationServices;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.DatabaseServices;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.EditorInput;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.Runtime;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.Windows.ToolPalette;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System.Runtime.InteropServices;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System.Drawing;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System.IO;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="color: blue; line-height: 140%;">namespace</span><span style="line-height: 140%;"> QuickSaveAs</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">{</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">class</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">Commands</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Set up static variable for the path to our folder</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// of drawings, as well as the base filename and a</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// counter to make the unique filename</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> _path = </span><span style="color: #a31515; line-height: 140%;">""</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _base = </span><span style="color: #a31515; line-height: 140%;">""</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;"> _count = 0;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Various filename and path-related constants</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">const</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> sfxSep = </span><span style="color: #a31515; line-height: 140%;">" "</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  pthSep = </span><span style="color: #a31515; line-height: 140%;">"\\"</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  lspSep = </span><span style="color: #a31515; line-height: 140%;">"/"</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dwgExt = </span><span style="color: #a31515; line-height: 140%;">".dwg"</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  scrExt = </span><span style="color: #a31515; line-height: 140%;">".txt"</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  bmpExt = </span><span style="color: #a31515; line-height: 140%;">".bmp"</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  bmpLoc = </span><span style="color: #a31515; line-height: 140%;">"Images"</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  scrLoc = </span><span style="color: #a31515; line-height: 140%;">"Scripts"</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Our QuickSaveAs command</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; [</span><span style="color: #2b91af; line-height: 140%;">CommandMethod</span><span style="line-height: 140%;">(</span><span style="color: #a31515; line-height: 140%;">"QSAVEAS"</span><span style="line-height: 140%;">)]</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> QuickSaveAs()</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Document</span><span style="line-height: 140%;"> doc =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Application</span><span style="line-height: 140%;">.DocumentManager.MdiActiveDocument;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Editor</span><span style="line-height: 140%;"> ed = doc.Editor;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Database</span><span style="line-height: 140%;"> db = doc.Database;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// If this is the first time run...</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (_path == </span><span style="color: #a31515; line-height: 140%;">""</span><span style="line-height: 140%;"> || _base == </span><span style="color: #a31515; line-height: 140%;">""</span><span style="line-height: 140%;">)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Ask the user for a base file location</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">PromptSaveFileOptions</span><span style="line-height: 140%;"> opts =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">PromptSaveFileOptions</span><span style="line-height: 140%;">(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #a31515; line-height: 140%;">"Select location to save first drawing file"</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; opts.Filter = </span><span style="color: #a31515; line-height: 140%;">"Drawing (*.dwg)|*.dwg"</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">PromptFileNameResult</span><span style="line-height: 140%;"> pr =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ed.GetFileNameForSave(opts);</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (pr.Status == </span><span style="color: #2b91af; line-height: 140%;">PromptStatus</span><span style="line-height: 140%;">.OK)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// If a file was selected, and it contains a path...</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Separate the path from the file name</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _base =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Path</span><span style="line-height: 140%;">.GetFileNameWithoutExtension(pr.StringResult);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _path =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Path</span><span style="line-height: 140%;">.GetDirectoryName(pr.StringResult);</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Create folders for our icons and our scripts</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Directory</span><span style="line-height: 140%;">.CreateDirectory(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _path + pthSep + bmpLoc</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Directory</span><span style="line-height: 140%;">.CreateDirectory(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _path + pthSep + scrLoc</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Assuming the path and name were set appropriately...</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (_path != </span><span style="color: #a31515; line-height: 140%;">""</span><span style="line-height: 140%;"> &amp;&amp; _base != </span><span style="color: #a31515; line-height: 140%;">""</span><span style="line-height: 140%;">)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> name = _base,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  dwgFile;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Add our suffix if not the first time run</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">do</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (_count &gt; 0)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name += sfxSep + _count.ToString();</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Our drawing is located in the base path</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwgFile = _path + pthSep + name + dwgExt;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _count++;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">while</span><span style="line-height: 140%;"> (</span><span style="color: #2b91af; line-height: 140%;">File</span><span style="line-height: 140%;">.Exists(dwgFile));</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// While our script is in a sub-folder</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> scrPath =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _path + pthSep + scrLoc + pthSep + name + scrExt;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Create a dummy script, so we can make sure we pick</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// up the contents in our dummy execute command</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">File</span><span style="line-height: 140%;">.WriteAllText(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scrPath,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #a31515; line-height: 140%;">"This is a dummy script for "</span><span style="line-height: 140%;"> + name + </span><span style="color: #a31515; line-height: 140%;">"."</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Now we want to save our drawing and use the image</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// for our tool icon</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (!</span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;">.IsNullOrEmpty(dwgFile))</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Bitmap</span><span style="line-height: 140%;"> thumb = doc.CapturePreviewImage(320, 240);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doc.Database.ThumbnailBitmap = thumb;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doc.Database.SaveAs(dwgFile, </span><span style="color: #2b91af; line-height: 140%;">DwgVersion</span><span style="line-height: 140%;">.Current);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ed.WriteMessage(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #a31515; line-height: 140%;">"\nCopy of current document saved to {0}"</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Path</span><span style="line-height: 140%;">.GetFileName(dwgFile)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CreateCommand(thumb, name, scrPath);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Function to add a command tool to our tool palette to</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// execute the script</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">private</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> CreateCommand(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Bitmap</span><span style="line-height: 140%;"> thumb,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> name,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> scrPath</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; )</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">const</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> catName = </span><span style="color: #a31515; line-height: 140%;">"ScriptCatalog"</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">const</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> palName = </span><span style="color: #a31515; line-height: 140%;">"Scripts"</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">ToolPaletteManager</span><span style="line-height: 140%;"> tpm = </span><span style="color: #2b91af; line-height: 140%;">ToolPaletteManager</span><span style="line-height: 140%;">.Manager;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Get the GUID of our dummy custom tool</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Type</span><span style="line-height: 140%;"> t = </span><span style="color: blue; line-height: 140%;">typeof</span><span style="line-height: 140%;">(</span><span style="color: #2b91af; line-height: 140%;">DummyTool</span><span style="line-height: 140%;">);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">GuidAttribute</span><span style="line-height: 140%;"> ga =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; (</span><span style="color: #2b91af; line-height: 140%;">GuidAttribute</span><span style="line-height: 140%;">)t.GetCustomAttributes(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">typeof</span><span style="line-height: 140%;">(</span><span style="color: #2b91af; line-height: 140%;">GuidAttribute</span><span style="line-height: 140%;">), </span><span style="color: blue; line-height: 140%;">false</span><span style="line-height: 140%;">)[0];</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Guid</span><span style="line-height: 140%;"> g = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">Guid</span><span style="line-height: 140%;">(ga.Value);</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Instanciate our dummy tool - this will allow us to use</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// its helper functions</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">DummyTool</span><span style="line-height: 140%;"> tool = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">DummyTool</span><span style="line-height: 140%;">();</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Catalog</span><span style="line-height: 140%;"> cat;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Palette</span><span style="line-height: 140%;"> pal = </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// First we check whether our GUID is in a catalog</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">CatalogItem</span><span style="line-height: 140%;"> ci = tpm.StockToolCatalogs.Find(g);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (ci != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// If it is, search each catalog for our palette</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">foreach</span><span style="line-height: 140%;">(</span><span style="color: #2b91af; line-height: 140%;">CatalogItem</span><span style="line-height: 140%;"> ci2 </span><span style="color: blue; line-height: 140%;">in</span><span style="line-height: 140%;"> tpm.Catalogs)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">for</span><span style="line-height: 140%;"> (</span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;"> i = 0; i &lt; ci2.ChildCount; i++)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">CatalogItem</span><span style="line-height: 140%;"> ci3 = ci2.GetChild(i);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (ci3 != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;"> &amp;&amp; ci3.Name == palName)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pal = ci3 </span><span style="color: blue; line-height: 140%;">as</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">Palette</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">break</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (pal != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">break</span><span style="line-height: 140%;">;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// If we didn't find our palette, create it</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (pal == </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; cat = tool.CreateStockTool(catName);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; pal = tool.CreatePalette(cat, palName);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// To add our command tool instance we need an icon</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">ImageInfo</span><span style="line-height: 140%;"> ii = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">ImageInfo</span><span style="line-height: 140%;">();</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (thumb != </span><span style="color: blue; line-height: 140%;">null</span><span style="line-height: 140%;">)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Which we create from the Database's thumbnail</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> bmpPath =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _path + pthSep + bmpLoc + pthSep + name + bmpExt;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; thumb.Save(bmpPath);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; ii.ResourceFile = bmpPath;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; ii.Size = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> System.Drawing.</span><span style="color: #2b91af; line-height: 140%;">Size</span><span style="line-height: 140%;">(65, 65);</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// And then we use our dummy tool to create the</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// command tool</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; tool.CreateCommandTool(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; pal,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; name,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; ii,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #a31515; line-height: 140%;">"_EXECSCR \""</span><span style="line-height: 140%;"> + scrPath.Replace(pthSep, lspSep) + </span><span style="color: #a31515; line-height: 140%;">"\""</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// Finally we reload the catalogs to display the change</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; tpm.LoadCatalogs(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">CatalogTypeFlags</span><span style="line-height: 140%;">.Catalog,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">LoadFlags</span><span style="line-height: 140%;">.LoadImages</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// A dummy command to simulate the execution of our script</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// (which simply reads the contents and displays them on</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// the command-line)</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; [</span><span style="color: #2b91af; line-height: 140%;">CommandMethod</span><span style="line-height: 140%;">(</span><span style="color: #a31515; line-height: 140%;">"EXECSCR"</span><span style="line-height: 140%;">)]</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> ExecuteScript()</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Document</span><span style="line-height: 140%;"> doc =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Application</span><span style="line-height: 140%;">.DocumentManager.MdiActiveDocument;</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">Editor</span><span style="line-height: 140%;"> ed = doc.Editor;</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">PromptResult</span><span style="line-height: 140%;"> pr =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; ed.GetString(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #a31515; line-height: 140%;">"\nEnter location of script to execute: "</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (pr.Status == </span><span style="color: #2b91af; line-height: 140%;">PromptStatus</span><span style="line-height: 140%;">.OK)</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> path =</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pr.StringResult.Replace(lspSep, pthSep);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (</span><span style="color: #2b91af; line-height: 140%;">File</span><span style="line-height: 140%;">.Exists(path))</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> contents = </span><span style="color: #2b91af; line-height: 140%;">File</span><span style="line-height: 140%;">.ReadAllText(path);</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ed.WriteMessage(</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #a31515; line-height: 140%;">"\nDummy script contained: \"{0}\""</span><span style="line-height: 140%;">,</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; contents</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; &nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; </span><span style="color: green; line-height: 140%;">// Our dummy tool which simply derives from CustomToolBase</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; </span><span style="color: green; line-height: 140%;">// (there may be a more straightforward way to get access</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; </span><span style="color: green; line-height: 140%;">// to the helpers in CustomToolBase, but anyway)</span></p><p style="margin: 0px; font-size: 8pt;">&nbsp;</p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; [Guid(</span><span style="color: #a31515; line-height: 140%;">"3B725500-0451-4081-A1BB-B37CE6A65767"</span><span style="line-height: 140%;">)]</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; [</span><span style="color: #2b91af; line-height: 140%;">Tool</span><span style="line-height: 140%;">(</span><span style="color: #a31515; line-height: 140%;">"MyDummyTool"</span><span style="line-height: 140%;">, </span><span style="color: #a31515; line-height: 140%;">"IDB_TOOL"</span><span style="line-height: 140%;">)]</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; [</span><span style="color: #2b91af; line-height: 140%;">ClassInterface</span><span style="line-height: 140%;">(</span><span style="color: #2b91af; line-height: 140%;">ClassInterfaceType</span><span style="line-height: 140%;">.AutoDual)]</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">class</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">DummyTool</span><span style="line-height: 140%;"> : </span><span style="color: #2b91af; line-height: 140%;">CustomToolBase</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; {</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">&nbsp; }</span></p><p style="margin: 0px; font-size: 8pt;"><span style="line-height: 140%;">}</span></p></div>
<P>The QSAVEAS command executes more quickly and cleanly, providing results comparable to the previous version’s:</P>
<P><A href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a68aaedd970c-pi"><img  style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px"title="Streamlined QSaveAs in action" border=0 alt="Streamlined QSaveAs in action" src="/assets/image_998676.jpg" width=485 height=359 /></A></P>
