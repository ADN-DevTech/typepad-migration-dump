---
layout: "post"
title: "Adding gaze and gestures to control our Unity model in HoloLens"
date: "2016-07-14 15:29:55"
author: "Kean Walmsley"
categories:
  - "Augmented Reality"
  - "HoloLens"
  - "Robotics"
  - "Selection"
  - "Unity3D"
original_url: "https://www.keanw.com/2016/07/adding-gaze-and-gestures-to-control-our-unity-model-in-hololens.html "
typepad_basename: "adding-gaze-and-gestures-to-control-our-unity-model-in-hololens"
typepad_status: "Publish"
---

<p>Now that <a href="http://through-the-interface.typepad.com/through_the_interface/2016/07/animating-our-unity-model-for-hololens.html" target="_blank">our industrial robot is animated</a>, I thought it a good time to head back on over and finish more of the <a href="https://developer.microsoft.com/en-us/windows/holographic/holograms_101" target="_blank">Holograms 101</a> tutorial.</p> <p>The next section of the tutorial focuses on adding a gaze cursor to the application: you have a torus mesh that tracks against the geometry the user is looking at. The instructions were reasonably straightforward – even when retrofitting the approach for a different project – but there were a few “gotchas” that are worth documenting:</p> <ul> <li>The simplest way to get the cursor – and its dependent bits and pieces – across into your project is to export the asset from the tutorial project and import it into your own. Perhaps obvious, but there it is.  <li>For your own geometry you’re going to need to add “collider” objects for Unity’s physics engine to perform raycasts into the model. It’ll still do it, without the colliders, but they won’t hit anything. :-)  <ul> <li>For our robot model there are lots of meshes, so I added MeshCollider components to each one. This worked a treat, although you should probably use cubes/spheres where you can, as presumably these perform better (not that I saw a particular issue there, I’m just saying).</li></ul></li></ul> <p>Here’s the gaze cursor on our robot. To make it more visible than the red one in the tutorial, I changed its colour to green. It’s cool to see how nicely (and responsively) it hugs even complex geometry in our model.</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d205291e970c-pi" target="_blank"><img title="The gaze cursor on our robot" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 30px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="The gaze cursor on our robot" src="/assets/image_414194.jpg" width="504" height="389"></a></p> <p>Once you have a gaze cursor in place, the next step is to add gesture support, so that the user can perform actions on objects selected by the gaze cursor.</p> <p>In our case I decided to use the standard air-tap gesture to pause or restart (in reverse) the particular part’s animation. Which is actually really cool: you can basically control the robot, placing its components exactly where you want them in 3D space, but turning the various animations on and off.</p> <p>Once again it was pretty easy to implement: I added an “isStopped” property to the Rotate script – bypassing the transformation if this is set – and then set this property from the “command”. I also added an “isFast” property with the expectation that I might use it to make things faster, at some point (although accessing the speed parameter directly is also clearly an option). Aside from these minor changes, the approach I used is identical to the one shown in the tutorial.</p> <p>Here’s the modified <em>Rotate.cs</em> file:</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> UnityEngine;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Collections;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Rotate</span> : MonoBehaviour</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; <span style="color: green">// Parameters provided by Unity that will vary per object</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">float</span> speed = 50f; <span style="color: green">// Speed of the rotation</span></p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> Vector3 axis = Vector3.up; <span style="color: green">// Axis of rotation</span></p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">float</span> maxRot = 170f; <span style="color: green">// Minimum angle of rotation (to contstrain movement)</span></p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">float</span> minRot = -170f; <span style="color: green">// Maximim angle of rotation (if == min then unconstrained)</span></p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">bool</span> isFast = <span style="color: blue">false</span>; <span style="color: green">// Flag to allow speed-up on selection</span></p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">bool</span> isStopped = <span style="color: blue">false</span>; <span style="color: green">// Flag to allow stopping</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: green">// Internal variable to track overall rotation (if constrained)</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">private</span> <span style="color: blue">float</span> rot = 0f;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> Update()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (isStopped)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Calculate the rotation amount as speed x time</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// (may get reduced to a smaller amount if near the angle limits)</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> locRot = speed * Time.deltaTime * (isFast ? 2f : 1f);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// If we're constraining movement (via min &amp; max angles)...</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (minRot != maxRot)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Then track the overall rotation</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (locRot + rot &lt; minRot)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Don't go below the minimum angle</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; locRot = minRot - rot;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">else</span> <span style="color: blue">if</span> (locRot + rot &gt; maxRot)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Don't go above the maximum angle</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; locRot = maxRot - rot;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rot += locRot;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// And reverse the direction if we're at a limit</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (rot &lt;= minRot || rot &gt;= maxRot)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; speed = -speed;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Perform the rotation itself</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; transform.Rotate(axis, locRot);</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Here’s the new <em>PartCommands.cs</em>:</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> UnityEngine;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PartCommands</span> : MonoBehaviour</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; <span style="color: green">// Called by GazeGestureManager when the user performs a Select gesture</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">void</span> OnSelect()</p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> rot = <span style="color: blue">this</span>.gameObject.GetComponentInParent&lt;Rotate&gt;();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (rot)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (rot.isStopped)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rot.speed = -rot.speed;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rot.isStopped = !rot.isStopped;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>The only slight nuance was that I had to place the command on the geometry – while the Rotate script was on the container, to make sure it affects the various descendants – but that just meant I needed to call GetComponentInParent&lt;Rotate&gt;() rather than GetComponent&lt;Rotate&gt;().</p> <p>My next step was to add a few voice commands – mainly to start and stop individual parts and the whole robot – but I didn’t manage to get these working, for now. While trying to do so, I did notice that the “select” voice command is there by default – implemented at a low level in the system, to make it equivalent to an air-tap – so I actually didn’t really need them, after all.</p> <p>Here’s selection working on the robot, both via air-taps and the built-in “select” voice command:</p> <p align="center">&nbsp;</p> <p align="center"><iframe height="281" src="https://www.youtube-nocookie.com/embed/ZbX3oThkEcw?rel=0&amp;showinfo=0" frameborder="0" width="500" allowfullscreen></iframe></p> <p align="center">&nbsp;</p> <p>The next section in the tutorial shows how to add spatial sound, but this is once again Windows 10-specific. Boo. So I’ll look again at an OS upgrade (or just skipping this, until I can). I do want to place the robot on the ground – and perhaps make sure it won’t collide with anything – so the spatial mapping section is certainly going to get a closer look.</p>
