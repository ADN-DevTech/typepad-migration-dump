---
layout: "post"
title: "Extracting code from blog posts using F# &ndash; Part 1"
date: "2014-12-17 16:53:58"
author: "Kean Walmsley"
categories:
  - "F#"
  - "HTML"
  - "Web/Tech"
original_url: "https://www.keanw.com/2014/12/extracting-code-from-blog-posts-using-f-part-1.html "
typepad_basename: "extracting-code-from-blog-posts-using-f-part-1"
typepad_status: "Publish"
---

<p>I mentioned some weeks ago that I was looking to automate the validation of a bunch of source files I have on disk before <a href="http://through-the-interface.typepad.com/through_the_interface/2014/11/time-to-go-git.html" target="_blank">uploading them to GitHub</a>. I decided to get started on that, this week, to see what was involved. As mentioned in the previous post, I wanted to programmatically query posts from Typepad, extract any embedded code from them and compare it with what I had on disk, to see which files were already correct and which needed to be created or removed.</p>  <p>The first step was to choose a language. The fact this is really an OS-level task – with a bunch of string processing and file I/O, but nothing whatsoever to do with AutoCAD – gave me some freedom to choose pretty much any language that can be run on OS X or Windows. I briefly considered Python or Ruby, but ended up going back to F#: it’s nicely integrated into Visual Studio (my primary development tool) and a functional approach makes a lot of sense for this kind of problem. I also had the itch to do more with F# after <a href="http://through-the-interface.typepad.com/through_the_interface/2014/11/net-goes-open-source-machine-learning-with-f.html" target="_blank">my recent (too brief) foray into machine learning</a>. One final factor in the decision process – not that it precludes the use of F#, at all – is that as this is a one-off activity I’m not at all worried about performance or memory constraints. It doesn’t matter if it takes 10 minutes to complete, for instance. Just as long as it completes. ;-)</p>  <p>Armed with F#, I then started looking at the problem itself. First up was pulling data down from the blog: I needed an API to access my blog’s content on Typepad – thankfully there’s <a href="http://www.typepad.com/services/apidocs/endpoints/blogs/%253Cid%253E/post-assets" target="_blank">a simple REST API</a> which gives access to its posts’ complete content – and then had some additional choices to make about how to access the data.</p>  <p>To simplify working with the blog’s post data, I decided to use <a href="http://msdn.microsoft.com/en-us/library/hh156509.aspx" target="_blank">F# Type Providers</a>. These allow you to code against data-oriented services as if they had local object models. Which is exactly what happens, I guess: when the code instantiates a <a href="http://fsharp.github.io/FSharp.Data/library/JsonProvider.html" target="_blank">JSON Type Provider</a> against a particular resource – I downloaded a sample JSON file from the Typepad API for this – it’s contents are then accessible via a locally-generated set of objects and properties. </p>  <p>The next problem was the “<a href="http://en.wikipedia.org/wiki/Data_scraping#Screen_scraping" target="_blank">screen scraping</a>”: we need to extract HTML code and convert it to plain text to compare with the local files. I opted for the <a href="http://htmlagilitypack.codeplex.com" target="_blank">HtmlAgilityPack</a> for this: it comes with <a href="http://htmlagilitypack.codeplex.com/SourceControl/latest#Release/1_4_0/Html2Txt/HtmlConvert.cs" target="_blank">an Html2Txt sample</a> that I converted to F#. I haven’t followed it exactly, as I wanted to keep some amount of whitespace in the generated plain text, but it got me a good part of the way there.</p>  <p>In a general sense, here’s what the algorithm needs to do:</p>  <ol>   <li>Parse the various C# files on disk and create an index that links a comma-separated command-list with the source filename      <ul>       <li>The order isn’t significant: if the commands don’t come in the same order then the files will be different </li>     </ul>   </li>    <li>Extract the post content from my blog and parse it for code fragments      <ul>       <li>I’ve used <a href="http://through-the-interface.typepad.com/through_the_interface/2006/08/some_cool_copyp.html" target="_blank">the same CopyAsHtml tool</a> since this blog’s inception, so all code sections are enclosed in a similar-looking &lt;div&gt; </li>        <li>For now I only care about posts with a single code section. There are certainly posts where I’ve used this tool to copy smaller fragments for illustrative purposes, so at some point I need the code to pick these up, too </li>     </ul>   </li>    <li>For the posts with a single code section, extract the code and convert it to plain text </li>    <li>Extract the commands implemented in the code and check for which files have the same commands – in the same sequence – on disk </li>    <li>Perform a lower-level comparison between the code extracted from HTML with the files of disk      <ul>       <li>This still needs some work: there are files which should match that for some reason don’t, right now, but overall it’s working quite well </li>        <li>For debugging purposes I’m currently writing any unmatched code fragments as files in another folder, so that I can go through and see what problems are worth fixing </li>     </ul>   </li>    <li>The ultimate output is a list of post titles with the matching local filename      <ul>       <li>It’ll be a simple matter to copy these files programmatically into a local folder that will sync with GitHub </li>     </ul>   </li> </ol>  <p>Here’s the code I have, so far:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: green">(*</span></p>    <p style="margin: 0px"><span style="color: green">#r &quot;Z:/GitHub/FSharp.Data/bin/FSharp.Data.dll&quot;</span></p>    <p style="margin: 0px"><span style="color: green">#r &quot;packages\HtmlAgilityPack.1.4.9\lib\Net45\HtmlAgilityPack.dll&quot;</span></p>    <p style="margin: 0px"><span style="color: green">#r &quot;System.Xml&quot;</span></p>    <p style="margin: 0px"><span style="color: green">*)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">open</span> FSharp.Data</p>    <p style="margin: 0px"><span style="color: blue">open</span> HtmlAgilityPack</p>    <p style="margin: 0px"><span style="color: blue">open</span> System.Xml</p>    <p style="margin: 0px"><span style="color: blue">open</span> System</p>    <p style="margin: 0px"><span style="color: blue">open</span> System.IO</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> codeHeader = <span style="color: #a31515">&quot;&lt;div style=&quot;</span></p>    <p style="margin: 0px"><span style="color: blue">let</span> blogRoot = <span style="color: #a31515">&quot;http://api.typepad.com/blogs/6a00d83452464869e200d83452baa169e2/post-assets.json&quot;</span></p>    <p style="margin: 0px"><span style="color: blue">let</span> csFolder = <span style="color: #a31515">@&quot;Z:\data\Blogs\Projects\Basic C# app&quot;</span></p>    <p style="margin: 0px"><span style="color: blue">let</span> tmpFolder = <span style="color: #a31515">@&quot;Z:\data\Blogs\Projects\Basic C# app\Notfound&quot;</span></p>    <p style="margin: 0px"><span style="color: blue">let</span> csTest =</p>    <p style="margin: 0px">&#160; <span style="color: #a31515">@&quot;Z:\data\Blogs\Projects\Basic C# app\enumerate-sysvars.cs&quot;</span></p>    <p style="margin: 0px"><span style="color: blue">let</span> cmdAttrib = <span style="color: #a31515">&quot;[CommandMethod(&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">type</span> Post = JsonProvider&lt;<span style="color: #a31515">&quot;data.json&quot;</span>&gt;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Use TypePad's REST API to retrieve batches of posts</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> getPosts m n =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> url = String.Format(<span style="color: #a31515">&quot;{0}?max-results={1}&quot;</span>, blogRoot, m)</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> url2 =</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">match</span> n <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160;&#160;&#160; | 0 <span style="color: blue">-&gt;</span> url</p>    <p style="margin: 0px">&#160;&#160;&#160; | _ <span style="color: blue">-&gt;</span> url + <span style="color: #a31515">&quot;&amp;start-index=&quot;</span> + (m * n).ToString()</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> doc = Post.Load(url2)</p>    <p style="margin: 0px">&#160; doc.Entries</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Count the number of times a substring appears in a string</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> countOccurrences (sub:string) (text:string) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">match</span> sub <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160; | <span style="color: #a31515">&quot;&quot;</span> <span style="color: blue">-&gt;</span> 0</p>    <p style="margin: 0px">&#160; | _ <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; (text.Length - text.Replace(sub, <span style="color: #a31515">@&quot;&quot;</span>).Length) / sub.Length</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// These are HTML entity codes etc. that need to be replaced</span></p>    <p style="margin: 0px"><span style="color: green">// as we convert from HTML to plain text</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> reps =</p>    <p style="margin: 0px">&#160; [(<span style="color: #a31515">&quot;&amp;#0160;&quot;</span>,<span style="color: #a31515">&quot; &quot;</span>);(<span style="color: #a31515">&quot;&amp;#160;&quot;</span>,<span style="color: #a31515">&quot; &quot;</span>);(<span style="color: #a31515">&quot;&amp;nbsp;&quot;</span>,<span style="color: #a31515">&quot; &quot;</span>);(<span style="color: #a31515">&quot;&amp;gt;&quot;</span>,<span style="color: #a31515">&quot;&gt;&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160; (<span style="color: #a31515">&quot;&amp;lt;&quot;</span>,<span style="color: #a31515">&quot;&lt;&quot;</span>);(<span style="color: #a31515">&quot;&amp;#39;&quot;</span>,<span style="color: #a31515">&quot;'&quot;</span>);(<span style="color: #a31515">&quot;&amp;quot;&quot;</span>, <span style="color: #a31515">&quot;\&quot;&quot;</span>);(<span style="color: #a31515">&quot;&amp;ndash;&quot;</span>,<span style="color: #a31515">&quot;-&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160; (<span style="color: #a31515">&quot;&amp;amp;&quot;</span>,<span style="color: #a31515">&quot;&amp;&quot;</span>);(<span style="color: #a31515">&quot;Â&quot;</span>,<span style="color: #a31515">&quot;&quot;</span>)]</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> convertText (t : string) = </p>    <p style="margin: 0px">&#160; List.fold</p>    <p style="margin: 0px">&#160;&#160;&#160; (<span style="color: blue">fun</span> (a : string) (b : string, c : string) <span style="color: blue">-&gt;</span> a.Replace(b,c))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; t reps</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Use the HtmlAgilityPack to convert from HTML to plain text</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> <span style="color: blue">rec</span> convertTo (node : HtmlNode ) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">match</span> node.NodeType <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160; | HtmlNodeType.Comment <span style="color: blue">-&gt;</span> <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160; | HtmlNodeType.Document <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; Seq.map convertTo node.ChildNodes |&gt;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Seq.fold (<span style="color: blue">fun</span> r s <span style="color: blue">-&gt;</span> r + s) <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160; | HtmlNodeType.Text <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// script and style must not be output</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">let</span> parentName = node.ParentNode.Name</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> parentName = <span style="color: #a31515">&quot;script&quot;</span> || parentName = <span style="color: #a31515">&quot;style&quot;</span> <span style="color: blue">then</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// get text</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">let</span> html = (node :?&gt; HtmlTextNode).Text;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// is it in fact a special closing node output as text?</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> HtmlNode.IsOverlappedClosingElement(html) <span style="color: blue">then</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; convertText html</p>    <p style="margin: 0px">&#160; | HtmlNodeType.Element <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> node.Name = <span style="color: #a31515">&quot;p&quot;</span> <span style="color: blue">then</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> node.HasChildNodes <span style="color: blue">then</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (Seq.map convertTo node.ChildNodes |&gt;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Seq.fold (<span style="color: blue">fun</span> r s <span style="color: blue">-&gt;</span> r + s) <span style="color: #a31515">&quot;&quot;</span>) + <span style="color: #a31515">&quot;\r\n&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;\r\n&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span> <span style="color: blue">if</span> node.HasChildNodes <span style="color: blue">then</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Seq.map convertTo node.ChildNodes |&gt;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Seq.fold (<span style="color: blue">fun</span> r s <span style="color: blue">-&gt;</span> r + s) <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160; | _ <span style="color: blue">-&gt;</span> <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Take post data and extract the HTML fragment representing code</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> extractCode (content : string) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> start = content.IndexOf(codeHeader)</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> finish = content.LastIndexOf(<span style="color: #a31515">&quot;&lt;/div&gt;&quot;</span>) + 6</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> html = content.Substring(start, finish - start)</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> doc = <span style="color: blue">new</span> HtmlDocument()</p>    <p style="margin: 0px">&#160; doc.LoadHtml(html)</p>    <p style="margin: 0px">&#160; convertTo doc.DocumentNode</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// If a post contains only 1 code segment, we'll extract it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> processPost (ent : Post.Entry) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> count = countOccurrences codeHeader ent.Content</p>    <p style="margin: 0px">&#160; ent.Title,</p>    <p style="margin: 0px">&#160; count,</p>    <p style="margin: 0px">&#160; <span style="color: blue">match</span> count <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160; | 1 <span style="color: blue">-&gt;</span> extractCode ent.Content</p>    <p style="margin: 0px">&#160; | _ <span style="color: blue">-&gt;</span> <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// List the files conforming to a pattern in a folder</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> filesInFolder pat folder =</p>    <p style="margin: 0px">&#160; <span style="color: blue">try</span> Directory.GetFiles(folder, pat, SearchOption.TopDirectoryOnly)</p>    <p style="margin: 0px">&#160;&#160;&#160; |&gt; Array.toList</p>    <p style="margin: 0px">&#160; <span style="color: blue">with</span> | e <span style="color: blue">-&gt;</span> []</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Get the indices at which a substring occurs in a string</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> stringIndices (pat:string) (text:string) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> <span style="color: blue">rec</span> getIndices (pat:string) (text:string) (start:int) =</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">match</span> text.IndexOf(pat, start) <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160;&#160;&#160; | -1 <span style="color: blue">-&gt;</span> []</p>    <p style="margin: 0px">&#160;&#160;&#160; | x <span style="color: blue">-&gt;</span> x :: getIndices pat text (x+1)</p>    <p style="margin: 0px">&#160; getIndices pat text 0</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Extract the command name from a CommandMethod attribute</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> extractCommandName (text : string) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> delim = <span style="color: #a31515">&quot;\&quot;&quot;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> count = countOccurrences delim text</p>    <p style="margin: 0px">&#160; <span style="color: blue">match</span> count <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160; | 0 <span style="color: blue">-&gt;</span> <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160; | 1 <span style="color: blue">-&gt;</span> <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160; | 2 <span style="color: blue">-&gt;</span> text.Substring(1, text.LastIndexOf(delim) - 1)</p>    <p style="margin: 0px">&#160; | 3 <span style="color: blue">-&gt;</span> <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160; | _ <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">let</span> idxs = stringIndices delim text</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; text.Substring(idxs.[2] + 1, idxs.[3] - idxs.[2] - 1)</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Extract the various command names from a code segment</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> <span style="color: blue">rec</span> commandsFromCode (text : string) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">match</span> text.Contains(cmdAttrib) <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160; | <span style="color: blue">false</span> <span style="color: blue">-&gt;</span> []</p>    <p style="margin: 0px">&#160; | <span style="color: blue">true</span> <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">let</span> start = text.IndexOf(cmdAttrib) + cmdAttrib.Length</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">let</span> finish = text.IndexOf(<span style="color: #a31515">&quot;)&quot;</span>, start + 1)</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">let</span> name = </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; text.Substring(start, finish - start) |&gt; extractCommandName</p>    <p style="margin: 0px">&#160;&#160;&#160; name :: commandsFromCode (text.Substring finish)</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Create a comma-separated string from a list of strings</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> <span style="color: blue">rec</span> commaSepString (cmds : string list) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">match</span> cmds <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160; | [] <span style="color: blue">-&gt;</span> <span style="color: #a31515">&quot;&quot;</span></p>    <p style="margin: 0px">&#160; | x::[] <span style="color: blue">-&gt;</span> x</p>    <p style="margin: 0px">&#160; | x::xs <span style="color: blue">-&gt;</span> x + <span style="color: #a31515">&quot;,&quot;</span> + commaSepString xs</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Get the commands for a particular file on disk as a</span></p>    <p style="margin: 0px"><span style="color: green">// comma-separated list and return them with the filename</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> commandsForFile file =</p>    <p style="margin: 0px">&#160; File.ReadAllText file |&gt;</p>    <p style="margin: 0px">&#160; commandsFromCode |&gt;</p>    <p style="margin: 0px">&#160; commaSepString |&gt;</p>    <p style="margin: 0px">&#160; (<span style="color: blue">fun</span> x <span style="color: blue">-&gt;</span> (x, file))</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Get the command names for a set of files on disk</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> <span style="color: blue">rec</span> commandsForFiles files =</p>    <p style="margin: 0px">&#160; <span style="color: blue">match</span> files <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160; | [] <span style="color: blue">-&gt;</span> []</p>    <p style="margin: 0px">&#160; | file::xs <span style="color: blue">-&gt;</span> commandsForFile file :: commandsForFiles xs</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Create an index from commands to files for a particular folder</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> indexCommands (folder : string) =</p>    <p style="margin: 0px">&#160; filesInFolder <span style="color: #a31515">&quot;*.cs&quot;</span> folder |&gt; commandsForFiles</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// From our index, get the files associated with a command-set</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> filesForCommandsFromIndex index cmds =</p>    <p style="margin: 0px">&#160; index |&gt;</p>    <p style="margin: 0px">&#160; List.filter (<span style="color: blue">fun</span> (a,b) <span style="color: blue">-&gt;</span> a = cmds &amp;&amp; a &lt;&gt; <span style="color: #a31515">&quot;&quot;</span>) |&gt;</p>    <p style="margin: 0px">&#160; List.map (<span style="color: blue">fun</span> (a,b) <span style="color: blue">-&gt;</span> b)</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Strip blank lines from a sequence of strings</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> stripBlanks (s : seq&lt;string&gt;) =</p>    <p style="margin: 0px">&#160; Seq.filter (<span style="color: blue">fun</span> x <span style="color: blue">-&gt;</span> not(String.IsNullOrWhiteSpace(x))) s</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Compare sequences of strings, ignoring non-relevant whitespace</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> compareSequences (s1 : seq&lt;string&gt;) (s2 : seq&lt;string&gt;) =</p>    <p style="margin: 0px">&#160; Seq.compareWith</p>    <p style="margin: 0px">&#160;&#160;&#160; (<span style="color: blue">fun</span> (a:string) (b:string) <span style="color: blue">-&gt;</span> String.Compare(a.Trim(), b.Trim()))</p>    <p style="margin: 0px">&#160;&#160;&#160; (stripBlanks s1) (stripBlanks s2)</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Write code to a temp file - for debugging only</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> writeToTmpFile (code:string) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> <span style="color: blue">rec</span> getTmpFile i =</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">let</span> file = tmpFolder + <span style="color: #a31515">&quot;\\&quot;</span> + i.ToString() + <span style="color: #a31515">&quot;.cs&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> not(File.Exists(file)) <span style="color: blue">then</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; file</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; getTmpFile (i+1)</p>    <p style="margin: 0px">&#160; <span style="color: blue">use</span> wr = <span style="color: blue">new</span> StreamWriter((getTmpFile 0))</p>    <p style="margin: 0px">&#160; wr.Write(code)</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Take a code fragment and a file and check them for equivalence</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> checkCodeAgainstFile (code:string) (file:string) =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> clines = code.Split(<span style="color: #a31515">&quot;\n\r&quot;</span>.ToCharArray())</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> flines = File.ReadAllLines(file)</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> s1 = Seq.ofArray clines</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> s2 = Seq.ofArray flines</p>    <p style="margin: 0px">&#160; <span style="color: blue">if</span> compareSequences s1 s2 = 0 <span style="color: blue">then</span></p>    <p style="margin: 0px">&#160;&#160;&#160; [file]</p>    <p style="margin: 0px">&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160; []</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Take a code fragment and a set of files and see if one matches</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> checkCodeAgainstFiles code files =</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> <span style="color: blue">rec</span> checkAgainstFiles code files =</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">match</span> files <span style="color: blue">with</span></p>    <p style="margin: 0px">&#160;&#160;&#160; | [] <span style="color: blue">-&gt;</span> []</p>    <p style="margin: 0px">&#160;&#160;&#160; | x::xs <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; checkCodeAgainstFile code x :: checkAgainstFiles code xs</p>    <p style="margin: 0px">&#160; checkAgainstFiles code files |&gt; List.concat</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Our main function</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">[&lt;EntryPoint&gt;]</p>    <p style="margin: 0px"><span style="color: blue">let</span> main argv = </p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: green">// Build an index from commands to source files on the hard drive</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> index = indexCommands csFolder</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: green">// Pull down post information from TypePad and process it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> posts =</p>    <p style="margin: 0px">&#160;&#160;&#160; [|0..25|] |&gt;</p>    <p style="margin: 0px">&#160;&#160;&#160; Array.map (getPosts 50) |&gt; <span style="color: green">// Get 1250 posts in batches of 50</span></p>    <p style="margin: 0px">&#160;&#160;&#160; Array.concat |&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Flatten the nested arrays</span></p>    <p style="margin: 0px">&#160;&#160;&#160; Array.map processPost&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Process the posts</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: green">// Separate the posts into posts with code and those without</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> postsWith, postsWithout =</p>    <p style="margin: 0px">&#160;&#160;&#160; Array.partition (<span style="color: blue">fun</span> (a,b,c) <span style="color: blue">-&gt;</span> b &gt; 0) posts</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: green">// Separate the posts with code into those with one section</span></p>    <p style="margin: 0px">&#160; <span style="color: green">// and those with more</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> postsWithOne, postsWithMore =</p>    <p style="margin: 0px">&#160;&#160;&#160; Array.partition (<span style="color: blue">fun</span> (a,b,c) <span style="color: blue">-&gt;</span> b = 1) postsWith</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; printfn</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;%d posts with zero, %d posts with one, %d posts with more&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; postsWithout.Length</p>    <p style="margin: 0px">&#160;&#160;&#160; postsWithOne.Length</p>    <p style="margin: 0px">&#160;&#160;&#160; postsWithMore.Length</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: green">// We'll take the posts with a single code section and process</span></p>    <p style="margin: 0px">&#160; <span style="color: green">// them</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: blue">let</span> res =</p>    <p style="margin: 0px">&#160;&#160;&#160; postsWithOne |&gt;</p>    <p style="margin: 0px">&#160;&#160;&#160; Array.map (<span style="color: blue">fun</span> (a,b,c) <span style="color: blue">-&gt;</span> commandsFromCode c) |&gt; <span style="color: green">// Get commands</span></p>    <p style="margin: 0px">&#160;&#160;&#160; Array.map commaSepString |&gt; <span style="color: green">// Make a comma-delimited cmd list</span></p>    <p style="margin: 0px">&#160;&#160;&#160; Array.map (filesForCommandsFromIndex index) |&gt; <span style="color: green">// Use our index</span></p>    <p style="margin: 0px">&#160;&#160;&#160; Array.map2 (<span style="color: blue">fun</span> (a,b,c) d <span style="color: blue">-&gt;</span> (a,c,d)) postsWithOne |&gt; <span style="color: green">//</span></p>    <p style="margin: 0px">&#160;&#160;&#160; Array.filter (<span style="color: blue">fun</span> (a,b,c) <span style="color: blue">-&gt;</span> b &lt;&gt; <span style="color: #a31515">&quot;&quot;</span>) |&gt; <span style="color: green">// Strip codeless</span></p>    <p style="margin: 0px">&#160;&#160;&#160; Array.map</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; (<span style="color: blue">fun</span> (a,b,c) <span style="color: blue">-&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; a,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">let</span> x = checkCodeAgainstFiles b c</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> x = [] <span style="color: blue">then</span> writeToTmpFile b <span style="color: green">// This is for debugging</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; x) |&gt;</p>    <p style="margin: 0px">&#160;&#160;&#160; Array.filter (<span style="color: blue">fun</span> (a,b) <span style="color: blue">-&gt;</span> b &lt;&gt; []) <span style="color: green">// Strip fileless</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; 0 <span style="color: green">// return an integer exit code</span></p> </div>  <p>Right now it finds 108 source files that are “correct” on disk. This is a reasonable start, but there are certainly more to be found.</p>  <p>By the way, while I don’t currently have a second part of this series planned, specifically, I know I’m going to need one to share the final version of the code. Which I’ll also place on GitHub, of course. :-)</p>
