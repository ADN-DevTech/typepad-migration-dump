---
layout: "post"
title: "Update on the project to de-skew images inside AutoCAD"
date: "2013-08-21 19:38:03"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "IronPython"
  - "Python"
original_url: "https://www.keanw.com/2013/08/update-on-the-project-to-de-skew-images-inside-autocad.html "
typepad_basename: "update-on-the-project-to-de-skew-images-inside-autocad"
typepad_status: "Publish"
---

<p>I’ve managed to find the time to make good progress on <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/coursera-the-future-of-education.html" target="_blank">my linear algebra class</a>, which means I have an update to share on <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/applications-for-linear-algebra-straightening-out-perspective.html" target="_blank">the image deskewing project</a> I mentioned last week. Thanks to all of you who provided comments on that post, by the way: there’s some really valuable information there.</p>  <p>The current implementation has been developed in Python and runs completely separately from AutoCAD. Here’s my rough integration plan to get it working in an AutoCAD plug-in: </p>  <ol>   <li>Adapt the code to make sure it can easily be applied to other images. </li>    <li>Remove any dependencies that might stop the code working in IronPython.      <ul>       <li><a href="http://ironpython.codeplex.com/workitem/33067" target="_blank">Compiled Python (.pyc) modules do not appear to be supported by IronPython</a>, for instance. </li>     </ul>   </li>    <li>Build the code into a .NET module using IronPython. </li>    <li>Develop a user-input mechanism allowing the user to specify the four corners of the portion of the image that needs straightening. </li>    <li>Swap out the existing display procedure, creating a cropped image file, instead. </li>    <li>Automate the insertion of a RasterImage (adding the appropriate definition, of course) into the current space. </li> </ol>  <p>I’ve so far managed to complete tasks 1 &amp; 2. Here’s how it worked on a picture taken in my living room, for instance (having manually located and hardcoded the pixel locations of the four corners):</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20192aca9b304970d-pi" target="_blank"><img style="background-image: none; border-right-width: 0px; margin: 20px 2px 20px 0px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Painting" border="0" alt="Painting" align="left" src="/assets/image_842693.jpg" width="249" height="331" /></a><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201901eea7720970b-pi" target="_blank"><img style="background-image: none; border-right-width: 0px; margin: 20px 10px 30px 2px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="The straightened painting" border="0" alt="The straightened painting" align="left" src="/assets/image_834313.jpg" width="220" height="324" /></a></p>  <p>I also had to wait until this week to manage task 2: the solver component that we’d previously been using (until we had to roll our own, this week) was provided as a .pyc file, but I now have equivalent code working in straight .py modules.</p>  <p>So progress is being made: I now believe I know enough to say that this can be made to work. I expect it to work <u><em>really</em></u> slowly, but as a proof of concept the project should be good enough.</p>  <p>I’m not yet sharing the complete code, mainly because it includes homework answers that many people won’t yet have submitted. But here’s the main .py file to give you a taste of the basic approach – the four functions at the end were used to test the ability to straighten and display different images (or portions of images).</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> mat </span><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Mat</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> vec </span><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> Vec</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> matutil </span><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> rowdict2mat, mat2coldict, coldict2mat</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> QR_solve </span><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> QR_solve</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> image_mat_util </span><span style="line-height: 140%; color: blue">import</span><span style="line-height: 140%"> *</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> move2board(v):</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #a31515">'''</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; Input:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - v: a vector with domain {'y1','y2','y3'}, the coordinate</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; representation of a point q.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; Output:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - A {'y1','y2','y3'}-vector z, the coordinate representation</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; in whiteboard coordinates of the point p such that the line</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; through the origin and q intersects the whiteboard plane at p.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; '''</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> Vec({</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">},</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">:v[</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">]/v[</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">],</span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">:v[</span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">]/v[</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">],</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">:1})</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> make_equations(x1, x2, w1, w2):</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #a31515">'''</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; Input:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - x1 &amp; x2: photo coordinates of a point on the board</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - y1 &amp; y2: whiteboard coordinates of a point on the board</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; Output:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - List [u,v] where u*h = 0 and v*h = 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; '''</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; domain = {(a, b) </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> a </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> {</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">}</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> b </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> {</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'x2'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'x3'</span><span style="line-height: 140%">}}</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; u = Vec(domain,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {(</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">):-x1, (</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x2'</span><span style="line-height: 140%">):-x2, (</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x3'</span><span style="line-height: 140%">):-1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">):w1 * x1, (</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x2'</span><span style="line-height: 140%">):w1 * x2, (</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x3'</span><span style="line-height: 140%">):w1})</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; v = Vec(domain,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {(</span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">):-x1, (</span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x2'</span><span style="line-height: 140%">):-x2, (</span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x3'</span><span style="line-height: 140%">):-1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">):w2 * x1, (</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x2'</span><span style="line-height: 140%">):w2 * x2, (</span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x3'</span><span style="line-height: 140%">):w2})</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> [u, v]</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> mat_move2board(Y):</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #a31515">'''</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; Input:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - Y: Mat instance, each column of which is a 'y1', 'y2', 'y3'</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; vector giving the whiteboard coordinates of a point q.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; Output:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - Mat instance, each column of which is the corresponding</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; point in the whiteboard plane (the point of intersection</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; with the whiteboard plane of the line through the origin</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; and q).</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; '''</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cd = mat2coldict(Y)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; md = { i: move2board(v) </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (i,v) </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> cd</span><span style="line-height: 140%; color: blue">.</span><span style="line-height: 140%">items() }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> coldict2mat(md)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> display_image(name, xtl, ytl, xbl, ybl, xtr, ytr, xbr, ybr,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; xscale, dispscale):</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #a31515">'''</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; Input:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - name: name (including path, if needed) of the image file.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - xtl, ytl: x/y coords of top left corner to straighten.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - xbl, ybl: x/y coords of bottom left corner to straighten.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - xtr, ytr: x/y coords of top right corner to straighten.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - xbr, ybr: x/y coords of bottom right corner to straighten.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - xscale: scale of x direction (relative to y==1).</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; - dispscale: scale of the image to display in the browser.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160; '''</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; yd = {</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">}</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; xd = {</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'x2'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'x3'</span><span style="line-height: 140%">}</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; domain = {(a, b) </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> a </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> yd </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> b </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> xd}</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; tl = make_equations(xtl,ytl,0,0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; bl = make_equations(xbl,ybl,0,1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; tr = make_equations(xtr,ytr,xscale,0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; br = make_equations(xbr,ybr,xscale,1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; w = Vec(domain, {(</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">):1})</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; L = rowdict2mat({0:tl[0],1:tl[1],2:bl[0],3:bl[1],4:tr[0],</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 5:tr[1],6:br[0],7:br[1],8:w})</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; b = Vec(set(range(9)), {8:1})</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; h = QR_solve(L, b)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; H = Mat((yd,xd), h</span><span style="line-height: 140%; color: blue">.</span><span style="line-height: 140%">f)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; (X_pts, colors) = file2mat(name, (</span><span style="line-height: 140%; color: #a31515">'x1'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x2'</span><span style="line-height: 140%">,</span><span style="line-height: 140%; color: #a31515">'x3'</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Y_pts = H * X_pts</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Y_board = mat_move2board(Y_pts)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; mat2display(Y_board, colors, (</span><span style="line-height: 140%; color: #a31515">'y1'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'y2'</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">'y3'</span><span style="line-height: 140%">),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; scale=dispscale, xmin=None, ymin=None)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> display1():</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; display_image(</span><span style="line-height: 140%; color: #a31515">'board.png'</span><span style="line-height: 140%">,358,36,329,597,592,157,580,483,2,300)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> display2():</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; display_image(</span><span style="line-height: 140%; color: #a31515">'cit.png'</span><span style="line-height: 140%">,82,73,81,103,105,69,105,102,1,50)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> display3():</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; display_image(</span><span style="line-height: 140%; color: #a31515">'cit.png'</span><span style="line-height: 140%">,136,64,136,98,152,71,152,103,1,50)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">def</span><span style="line-height: 140%"> display4():</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; display_image(</span><span style="line-height: 140%; color: #a31515">'pntng.png'</span><span style="line-height: 140%">,133,144,142,512,335,36,347,644,0.6,300)</span></p> </div>
