---
layout: "post"
title: "Attaching AutoCAD Xrefs and inserting them at the origin using .NET"
date: "2015-11-02 12:04:46"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Blocks"
  - "Drawing structure"
original_url: "https://www.keanw.com/2015/11/attaching-autocad-xrefs-and-inserting-them-at-the-origin-using-net.html "
typepad_basename: "attaching-autocad-xrefs-and-inserting-them-at-the-origin-using-net"
typepad_status: "Publish"
---

<p>I just received this interesting (and quick to solve) question from Henrik Ericson, this morning:</p>  <blockquote>   <p><em>I’m looking for a new xref command (or perhaps overriding the internal xref command) that always insert the selected xref at 0,0,0 coordinates and in World coordinate system. I’m often inserting an xref and ’nothing happens’ and then I realize that I’m in a UCS.</em></p> </blockquote>  <p>I created a simple command called XAO – for XrefAttach[At]Origin – that does just this. As a helper function I implemented a simple extension method to both attach and insert an external reference in the current space of the active AutoCAD drawing, basing it on <a href="http://help.autodesk.com/view/ACD/2015/ENU/?guid=GUID-D6EE5FE7-C0BC-4E9B-AAE3-3B5A14B870FE" target="_blank">the online documentation</a>.</p>  <p>Here’s the C# code:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Geometry;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.IO;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> XrefAttachAtZero</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">class</span> <span style="color: #2b91af">Extensions</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> Attaches the specified Xref to the current space in the current drawing.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;path&quot;&gt;</span><span style="color: green">Path to the drawing file to attach as an Xref.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;pos&quot;&gt;</span><span style="color: green">Position of Xref in WCS coordinates.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name=&quot;name&quot;&gt;</span><span style="color: green">Optional name for the Xref.</span><span style="color: gray">&lt;/param&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">Whether the attach operation succeeded.</span><span style="color: gray">&lt;/returns&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> XrefAttachAndInsert(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span> <span style="color: #2b91af">Database</span> db, <span style="color: blue">string</span> path, <span style="color: #2b91af">Point3d</span> pos, <span style="color: blue">string</span> name = <span style="color: blue">null</span></p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ret = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!<span style="color: #2b91af">File</span>.Exists(path))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> ret;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: #2b91af">String</span>.IsNullOrEmpty(name))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; name = <span style="color: #2b91af">Path</span>.GetFileNameWithoutExtension(path);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">try</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (<span style="color: blue">var</span> tr = db.TransactionManager.StartOpenCloseTransaction())</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> xId = db.AttachXref(path, name);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (xId.IsValid)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> btr =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">BlockTableRecord</span>)tr.GetObject(db.CurrentSpaceId, <span style="color: #2b91af">OpenMode</span>.ForWrite);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> br = <span style="color: blue">new</span> <span style="color: #2b91af">BlockReference</span>(pos, xId);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; btr.AppendEntity(br);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(br, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ret = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">catch</span> (Autodesk.AutoCAD.Runtime.<span style="color: #2b91af">Exception</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; { }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> ret;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Commands</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;XAO&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> XrefAttachAtOrigin()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> db = doc.Database;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ed = doc.Editor;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Ask the user to specify a file to attach</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> opts = <span style="color: blue">new</span> <span style="color: #2b91af">PromptOpenFileOptions</span>(<span style="color: #a31515">&quot;Select Reference File&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; opts.Filter = <span style="color: #a31515">&quot;Drawing (*.dwg)|*.dwg&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> pr = ed.GetFileNameForOpen(opts);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (pr.Status == <span style="color: #2b91af">PromptStatus</span>.OK)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Attach the specified file and insert it at the origin</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> res = db.XrefAttachAndInsert(pr.StringResult, <span style="color: #2b91af">Point3d</span>.Origin);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;External reference {0}attached at the origin.&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; res ? <span style="color: #a31515">&quot;&quot;</span> : <span style="color: #a31515">&quot;not &quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p> </div>  <p>And here’s the XAO command in action:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c7e64ea1970b-pi" target="_blank"><img title="Xref Attach at Origin" style="float: none; margin: 50px auto; display: block" alt="Xref Attach at Origin" src="/assets/image_297637.jpg" width="508" height="516" /></a></p>  <p>A simple enough command, but I can see how it would be useful for users of external references who also work with custom User Coordinate Systems. Thanks for the question, Henrik!</p>  <p><strong><em>Update:</em></strong></p>  <p>A big thanks to Glenn Ryan for reminding me of his RefUcsSpy tool which was <a href="http://through-the-interface.typepad.com/through_the_interface/2010/07/preview-of-augusts-plugin-of-the-month-refucsspy.html" target="_blank">published as an ADN Plugin of the Month</a>, way back when. The good news is that it’s <a href="https://apps.autodesk.com/ACD/en/Detail/Index?id=autodesk.appstore.exchange.autodesk.com:ADNPlugins_RefUcsSpy:en" target="_blank">still available on the AutoCAD App Store</a>. It takes a slightly different approach to the problem, and warns you if a custom UCS is active when you launch reference-adding commands such as XATTACH. A task dialog allows you to carry on and use the custom UCS or to switch to WCS for the duration of the attachment. Check it out!</p>
