---
layout: "post"
title: "Taking a screenshot of a user-selected portion of a drawing using .NET"
date: "2009-09-23 10:03:01"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Graphics system"
  - "Selection"
original_url: "https://www.keanw.com/2009/09/taking-a-screenshot-of-a-user-selected-portion-of-a-drawing-using-net.html "
typepad_basename: "taking-a-screenshot-of-a-user-selected-portion-of-a-drawing-using-net"
typepad_status: "Publish"
---

<p>Following on from <a href="http://through-the-interface.typepad.com/through_the_interface/2009/09/taking-screenshots-of-autocads-main-and-drawing-windows-using-net.html">this recent post</a> – and inspired by a question we received recently from a developer – I decided to extend the previous code to allow a user to select a portion of a drawing they would like to save to a file or place on the clipboard. This is actually a really useful tool for me when I’m writing this blog, so there was certainly a degree of self-interest involved. :-)</p>  <p>The technique shown in today’s post is actually pretty handy for other situations: it’s quite common to want to transform a point from drawing coordinates (which may well be in a specific User Coordinate System (UCS)) into screen coordinates, especially when wanting to display a window or a custom context menu at the cursor location.</p>  <p>To transform from UCS to screen coordinates we actually need three steps (and thanks to Adam Nagy, from DevTech EMEA, for creating code I borrowed from to get this working):</p>  <ol>   <li>Transform the selected point by the current UCS matrix to get WCS      <ul>       <li>This can be achieved using the .NET interface </li>     </ul>   </li>    <li>Transform the WCS point into Windows client coordinates      <ul>       <li>For this we need to P/Invoke the ObjectARX function acedCoordFromWorldToPixel() </li>     </ul>   </li>    <li>Transform the client coordinates into screen coordinates      <ul>       <li>For this we need to P/Invoke the Win32 API function ClientToScreen() </li>     </ul>   </li> </ol>  <p>We need to do this for both corners of our user-selected window, of course. Once we have the corners in screen coordinates, the code from last time can be used: with a few modifications to support selection of top-right/bottom-left corners, rather than the assumed top-left/bottom-right, as well as adding support for placing the bitmap on the clipboard, rather than saving it to a file.</p>  <p>Here’s the updated C# code with our new WSS command:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> acApp = Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Drawing.Imaging;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Drawing;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Runtime.InteropServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Windows.Interop;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> ScreenshotTest</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Commands</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// For the coordinate tranformation we need...&#160; </span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// An ObjectARX function:</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;acad.exe&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; EntryPoint=</span><span style="line-height: 140%; color: #a31515">&quot;?acedCoordFromWorldToPixel@@YAHHQBNAAVCPoint@@@Z&quot;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> acedCoordFromWorldToPixel(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> windnum,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">[] ptIn,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">out</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> ptOut</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And a Win32 function:</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;user32.dll&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> ClientToScreen(</span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWnd, </span><span style="line-height: 140%; color: blue">ref</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Command to capture the main and active drawing windows</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;CSS&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> CaptureScreenShot()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.MainWindow,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0, 0, 0, 0,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;c:\\main-window.png&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument.Window,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 30, 26, 10, 10,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;c:\\doc-window.png&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Command to capture a user-selected portion of a drawing</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;WSS&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> WindowScreenShot()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Ask the user for the screen window to capture</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptPointResult</span><span style="line-height: 140%"> ppr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.GetPoint(</span><span style="line-height: 140%; color: #a31515">&quot;\nSelect first point of capture window: &quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> first = ppr.Value;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ppr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.GetCorner(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nSelect second point of capture window: &quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; first</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> second = ppr.Value;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Generate screen coordinate points based on the</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// drawing points selected</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt1, pt2; </span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// First we get the viewport number</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%"> vp =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%">)acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.GetSystemVariable(</span><span style="line-height: 140%; color: #a31515">&quot;CVPORT&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the current UCS matrix (would be indentify if in WCS)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Matrix3d</span><span style="line-height: 140%"> ucsMat =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.CurrentUserCoordinateSystem;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And then the handle to the current drawing window</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWnd = doc.Window.Handle;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Now calculate the selected corners in screen coordinates</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt1 = ScreenFromDrawingPoint(ucsMat, hWnd, first, vp);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt2 = ScreenFromDrawingPoint(ucsMat, hWnd, second, vp);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Now save this portion of our screen as a raster image</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ScreenShotToFile(pt1, pt2, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Perform our three tranformations to get from UCS (or WCS)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// to screen coordinates</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> ScreenFromDrawingPoint(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Matrix3d</span><span style="line-height: 140%"> ucsMat,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWnd,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> ucsPt,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%"> vpNum</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> res;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> wcsPt = ucsPt.TransformBy(ucsMat);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; acedCoordFromWorldToPixel(vpNum, wcsPt.ToArray(), </span><span style="line-height: 140%; color: blue">out</span><span style="line-height: 140%"> res);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ClientToScreen(hWnd, </span><span style="line-height: 140%; color: blue">ref</span><span style="line-height: 140%"> res);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> res;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save the display of an AutoCAD window as a raster file</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// and/or an image on the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Autodesk.AutoCAD.Windows.</span><span style="line-height: 140%; color: #2b91af">Window</span><span style="line-height: 140%"> wd,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> top, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> bottom, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> left, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> right,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> filename,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> clipboard</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt = wd.Location;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%"> sz = wd.Size;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt.X += left;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt.Y += top;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; sz.Height -= top + bottom;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; sz.Width -= left + right;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; SaveScreenPortion(pt, sz, filename, clipboard);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save a screen window between two corners as a raster file</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// and/or an image on the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt1,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt2,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> filename,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> clipboard</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create the top left corner from the two corners</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// provided (by taking the min of both X and Y values)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Min(pt1.X, pt2.X), </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Min(pt1.Y, pt2.Y));</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Determine the size by subtracting X &amp; Y values and</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// taking the absolute value of each</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%"> sz =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Abs(pt1.X - pt2.X), </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Abs(pt1.Y - pt2.Y));</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; SaveScreenPortion(pt, sz, filename, clipboard);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save a portion of the screen display as a raster file</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// and/or an image on the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> SaveScreenPortion(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%"> sz,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> filename,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> clipboard</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set the bitmap object to the size of the window</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%"> bmp =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sz.Width,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sz.Height,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PixelFormat</span><span style="line-height: 140%">.Format32bppArgb</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (bmp)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create a graphics object from the bitmap</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">Graphics</span><span style="line-height: 140%"> gfx = </span><span style="line-height: 140%; color: #2b91af">Graphics</span><span style="line-height: 140%">.FromImage(bmp))</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Take a screenshot of our window</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; gfx.CopyFromScreen(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pt.X, pt.Y, 0, 0, sz,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">CopyPixelOperation</span><span style="line-height: 140%">.SourceCopy</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save the screenshot to the specified location</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (filename != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> &amp;&amp; filename != </span><span style="line-height: 140%; color: #a31515">&quot;&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bmp.Save(filename, </span><span style="line-height: 140%; color: #2b91af">ImageFormat</span><span style="line-height: 140%">.Png);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Copy it to the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (clipboard)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Windows.Forms.</span><span style="line-height: 140%; color: #2b91af">Clipboard</span><span style="line-height: 140%">.SetImage(bmp);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">}</span></p> </div> <!--EndFragment-->  <p>To get the code working, you may need to add an additional assembly reference to System.Windows.Forms.dll, which gives us access to the Clipboard. I should also mention that I’m running this code on AutoCAD 2010 on a 32-bit OS: if the DllImport statement to P/Invoke our ObjectARX function, you may need to <a href="http://through-the-interface.typepad.com/through_the_interface/2006/07/calling_objecta.html">find and declare the appropriate function signature</a>.</p>  <p>To put our WSS command through its paces, let’s load a drawing and set a random UCS (I do this by changing the view using 3DORBIT and using the UCS command, setting it to the current View) and on top of that changing the view to be from a another random angle not aligned with this new UCS:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a59033e4970b-pi"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Site layout with random UCS and viewing angle" border="0" alt="Site layout with random UCS and viewing angle" src="/assets/image_362255.jpg" width="489" height="353" /></a> </p>  <p>Now we NETLOAD our assembly and run the WSS command, selecting the two corners of our window:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a5e6c15e970c-pi"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Selecting our screen capture window" border="0" alt="Selecting our screen capture window" src="/assets/image_809392.jpg" width="489" height="353" /></a> </p>  <p>And we can see that the resultant image is on the clipboard by pasting it somewhere (we could very easily adjust the code to save to a file, if we so chose) :</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a59033f2970b-pi"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Our captured image from the clipboard" border="0" alt="Our captured image from the clipboard" src="/assets/image_895173.jpg" width="241" height="93" /></a></p>  <p>&#160;</p>  <p><strong><em>Update:</em></strong></p>  <p>Paavo pointed out in a comment that I had missed a managed API method to replace the P/Invoke of acedCoordFromWorldToPixel(), which makes the code much cleaner and more portable across versions: Editor.PointToScreen(). We still have to P/Invoke ClientToScreen(), but at least that’s undecorated/unmangled.</p>  <p>Here’s the revised C# code, which I’ve included in its entirety because it has ended up meaning a change both to the ScreenFromDrawingPoint() function and the code that calls it: we need the editor to perform our transformation so we might as well use it within the function to retrieve the matrix representing the current UCS. Which simplifies things somewhat.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> acApp = Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Drawing.Imaging;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Drawing;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Runtime.InteropServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Windows.Interop;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> ScreenshotTest</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Commands</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// For the coordinate tranformation we need...&#160; </span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// A Win32 function:</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;user32.dll&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> ClientToScreen(</span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWnd, </span><span style="line-height: 140%; color: blue">ref</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Command to capture the main and active drawing windows</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;CSS&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> CaptureScreenShot()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.MainWindow,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0, 0, 0, 0,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;c:\\main-window.png&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument.Window,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 30, 26, 10, 10,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;c:\\doc-window.png&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Command to capture a user-selected portion of a drawing</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;WSS&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> WindowScreenShot()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Ask the user for the screen window to capture</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptPointResult</span><span style="line-height: 140%"> ppr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.GetPoint(</span><span style="line-height: 140%; color: #a31515">&quot;\nSelect first point of capture window: &quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> first = ppr.Value;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ppr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.GetCorner(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nSelect second point of capture window: &quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; first</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ppr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> second = ppr.Value;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Generate screen coordinate points based on the</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// drawing points selected</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt1, pt2; </span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// First we get the viewport number</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%"> vp =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%">)acApp.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.GetSystemVariable(</span><span style="line-height: 140%; color: #a31515">&quot;CVPORT&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Then the handle to the current drawing window</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWnd = doc.Window.Handle;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Now calculate the selected corners in screen coordinates</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt1 = ScreenFromDrawingPoint(ed, hWnd, first, vp);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt2 = ScreenFromDrawingPoint(ed, hWnd, second, vp);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Now save this portion of our screen as a raster image</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ScreenShotToFile(pt1, pt2, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Perform our three tranformations to get from UCS (or WCS)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// to screen coordinates</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> ScreenFromDrawingPoint(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWnd,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> ucsPt,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%"> vpNum</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {&#160;&#160;&#160;&#160;&#160; </span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> wcsPt =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ucsPt.TransformBy(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.CurrentUserCoordinateSystem</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> res = ed.PointToScreen(wcsPt, vpNum);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ClientToScreen(hWnd, </span><span style="line-height: 140%; color: blue">ref</span><span style="line-height: 140%"> res);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> res;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save the display of an AutoCAD window as a raster file</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// and/or an image on the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Autodesk.AutoCAD.Windows.</span><span style="line-height: 140%; color: #2b91af">Window</span><span style="line-height: 140%"> wd,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> top, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> bottom, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> left, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> right,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> filename,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> clipboard</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt = wd.Location;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%"> sz = wd.Size;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt.X += left;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pt.Y += top;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; sz.Height -= top + bottom;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; sz.Width -= left + right;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; SaveScreenPortion(pt, sz, filename, clipboard);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save a screen window between two corners as a raster file</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// and/or an image on the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> ScreenShotToFile(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt1,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt2,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> filename,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> clipboard</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create the top left corner from the two corners</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// provided (by taking the min of both X and Y values)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Min(pt1.X, pt2.X), </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Min(pt1.Y, pt2.Y));</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Determine the size by subtracting X &amp; Y values and</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// taking the absolute value of each</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%"> sz =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Abs(pt1.X - pt2.X), </span><span style="line-height: 140%; color: #2b91af">Math</span><span style="line-height: 140%">.Abs(pt1.Y - pt2.Y));</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; SaveScreenPortion(pt, sz, filename, clipboard);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save a portion of the screen display as a raster file</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// and/or an image on the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> SaveScreenPortion(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%"> pt,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%"> sz,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> filename,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> clipboard</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set the bitmap object to the size of the window</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%"> bmp =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sz.Width,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sz.Height,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PixelFormat</span><span style="line-height: 140%">.Format32bppArgb</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (bmp)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create a graphics object from the bitmap</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">Graphics</span><span style="line-height: 140%"> gfx = </span><span style="line-height: 140%; color: #2b91af">Graphics</span><span style="line-height: 140%">.FromImage(bmp))</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Take a screenshot of our window</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; gfx.CopyFromScreen(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pt.X, pt.Y, 0, 0, sz,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">CopyPixelOperation</span><span style="line-height: 140%">.SourceCopy</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Save the screenshot to the specified location</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (filename != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%"> &amp;&amp; filename != </span><span style="line-height: 140%; color: #a31515">&quot;&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bmp.Save(filename, </span><span style="line-height: 140%; color: #2b91af">ImageFormat</span><span style="line-height: 140%">.Png);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Copy it to the clipboard</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (clipboard)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Windows.Forms.</span><span style="line-height: 140%; color: #2b91af">Clipboard</span><span style="line-height: 140%">.SetImage(bmp);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">}</span></p> </div> <!--EndFragment-->
