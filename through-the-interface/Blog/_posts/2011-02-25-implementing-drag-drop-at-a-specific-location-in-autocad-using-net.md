---
layout: "post"
title: "Implementing drag &amp; drop at a specific location in AutoCAD using .NET"
date: "2011-02-25 08:19:07"
author: "Kean Walmsley"
categories: []
original_url: "https://www.keanw.com/2011/02/implementing-drag-drop-at-a-specific-location-in-autocad-using-net.html "
typepad_basename: "implementing-drag-drop-at-a-specific-location-in-autocad-using-net"
typepad_status: "Publish"
---

<p>As a follow up to <a href="http://through-the-interface.typepad.com/through_the_interface/2011/02/managing-drag-drop-from-a-palette-into-autocad-using-net.html" target="_blank">the last post</a>, here’s the update that places the dropped content at the cursor location. I‘ve been busy in meetings for most of the week, so I haven’t yet had time to integrate the jig for sizing.</p>  <p>Thanks for Mike Schumacher for pointing me at Editor.PointToWorld() (I’m not sure how I managed to miss it – let’s blame it on the jetlag).</p>  <p>Here’s the updated C# code with the new/modified lines in <font color="#ff0000">red</font> (and <a href="http://through-the-interface.typepad.com/files/drag-drop-at-location.cs" target="_blank">the complete, unnumbered source file here</a>):</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 1</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 2</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 3</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 4</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 5</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 6</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Windows;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 7</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Runtime.InteropServices;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 8</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Windows.Forms;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160;&#160; 9</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Drawing;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 10</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.IO;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 11</span>&#160;<span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 12</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 13</span>&#160;<span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> DragAndDrop</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 14</span>&#160;<span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 15</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">enum</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Msgs</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 16</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 17</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; WM_DRAWCLIPBOARD = 0x0308,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 18</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; WM_CHANGECBCHAIN = 0x030D</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 19</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 20</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 21</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ClipboardView</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #2b91af">UserControl</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 22</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 23</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;user32.dll&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 24</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> SetClipboardViewer(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 25</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWndNewViewer</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 26</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 27</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 28</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">DllImport</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;user32.dll&quot;</span><span style="line-height: 140%">, CharSet = </span><span style="line-height: 140%; color: #2b91af">CharSet</span><span style="line-height: 140%">.Auto)]</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 29</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">extern</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> SendMessage(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 30</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> hWnd, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> Msg, </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> wParam, </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> lParam</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 31</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 32</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 33</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntPtr</span><span style="line-height: 140%"> _nxtVwr;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 34</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PictureBox</span><span style="line-height: 140%"> _img;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 35</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PaletteSet</span><span style="line-height: 140%"> _ps;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 36</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 37</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> System.Drawing.</span><span style="line-height: 140%; color: #2b91af">Image</span><span style="line-height: 140%"> Contents</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 38</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 39</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">get</span><span style="line-height: 140%"> { </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> _img.Image; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 40</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 41</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 42</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> ClipboardView(</span><span style="line-height: 140%; color: #2b91af">PaletteSet</span><span style="line-height: 140%"> ps)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 43</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 44</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _img = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PictureBox</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 45</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _img.Anchor =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 46</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">AnchorStyles</span><span style="line-height: 140%">)(</span><span style="line-height: 140%; color: #2b91af">AnchorStyles</span><span style="line-height: 140%">.Top |</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 47</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">AnchorStyles</span><span style="line-height: 140%">.Bottom |</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 48</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">AnchorStyles</span><span style="line-height: 140%">.Left |</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 49</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">AnchorStyles</span><span style="line-height: 140%">.Right);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 50</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _img.Location = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%">(0, 0);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 51</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _img.Size = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.Size;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 52</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _img.SizeMode = </span><span style="line-height: 140%; color: #2b91af">PictureBoxSizeMode</span><span style="line-height: 140%">.StretchImage;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 53</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Controls.Add(_img);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 54</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 55</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Add our event handler to launch a new drag event</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 56</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// when someone clicks on the control</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 57</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 58</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _img.MouseDown +=</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 59</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">delegate</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: blue">object</span><span style="line-height: 140%"> sender, </span><span style="line-height: 140%; color: #2b91af">MouseEventArgs</span><span style="line-height: 140%"> e)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 60</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 61</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Simply initiate the drag &amp; drop in AutoCAD,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 62</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// specifying an instance of our custom &quot;drop</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 63</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// target&quot; class</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 64</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 65</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Autodesk.AutoCAD.ApplicationServices.</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 66</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DoDragDrop(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 67</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _img, </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.Contents, </span><span style="line-height: 140%; color: #2b91af">DragDropEffects</span><span style="line-height: 140%">.Copy,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 68</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">MyDropTarget</span><span style="line-height: 140%">()</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 69</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 70</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 71</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 72</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _nxtVwr = SetClipboardViewer(</span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.Handle);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 73</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ps = ps;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 74</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 75</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 76</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> ExtractImage()</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 77</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 78</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">IDataObject</span><span style="line-height: 140%"> iData;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 79</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">try</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 80</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 81</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; iData = </span><span style="line-height: 140%; color: #2b91af">Clipboard</span><span style="line-height: 140%">.GetDataObject();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 82</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 83</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">catch</span><span style="line-height: 140%"> (System.</span><span style="line-height: 140%; color: #2b91af">Exception</span><span style="line-height: 140%"> ex)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 84</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 85</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">MessageBox</span><span style="line-height: 140%">.Show(ex.ToString());</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 86</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 87</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 88</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 89</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (iData.GetDataPresent(</span><span style="line-height: 140%; color: #a31515">&quot;Bitmap&quot;</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 90</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 91</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">object</span><span style="line-height: 140%"> o = iData.GetData(</span><span style="line-height: 140%; color: #a31515">&quot;Bitmap&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 92</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%"> b = o </span><span style="line-height: 140%; color: blue">as</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 93</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (b != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 94</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 95</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _img.Image = b;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 96</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_ps != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 97</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 98</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ps.Size =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;&#160; 99</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%">(b.Size.Width / 3, b.Size.Height / 3);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 100</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 101</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 102</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 103</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 104</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 105</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">protected</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> WndProc(</span><span style="line-height: 140%; color: blue">ref</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Message</span><span style="line-height: 140%"> m)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 106</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 107</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">switch</span><span style="line-height: 140%"> ((</span><span style="line-height: 140%; color: #2b91af">Msgs</span><span style="line-height: 140%">)m.Msg)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 108</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 109</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Msgs</span><span style="line-height: 140%">.WM_DRAWCLIPBOARD:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 110</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ExtractImage();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 111</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SendMessage(_nxtVwr, m.Msg, m.WParam, m.LParam);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 112</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 113</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">case</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Msgs</span><span style="line-height: 140%">.WM_CHANGECBCHAIN:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 114</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (m.WParam == _nxtVwr)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 115</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _nxtVwr = m.LParam;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 116</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 117</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SendMessage(_nxtVwr, m.Msg, m.WParam, m.LParam);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 118</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 119</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">default</span><span style="line-height: 140%">:</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 120</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">base</span><span style="line-height: 140%">.WndProc(</span><span style="line-height: 140%; color: blue">ref</span><span style="line-height: 140%"> m);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 121</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">break</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 122</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 123</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 124</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 125</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 126</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Our custom drop target class</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 127</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 128</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">MyDropTarget</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #2b91af">DropTarget</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 129</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 130</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> OnDrop(</span><span style="line-height: 140%; color: #2b91af">DragEventArgs</span><span style="line-height: 140%"> e)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 131</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 132</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 133</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Autodesk.AutoCAD.ApplicationServices.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 134</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 135</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 136</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If we have a valid bitmap, save it and send</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 137</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// our custom command (RINS)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 138</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 139</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (e.Data.GetDataPresent(</span><span style="line-height: 140%; color: #a31515">&quot;Bitmap&quot;</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 140</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 141</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">object</span><span style="line-height: 140%"> o = e.Data.GetData(</span><span style="line-height: 140%; color: #a31515">&quot;Bitmap&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 142</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%"> b = o </span><span style="line-height: 140%; color: blue">as</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 143</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (b != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 144</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 145</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We'll save the bitmap as a &quot;temp&quot; file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 146</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (as its unique - a better approach</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 147</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// would probably to create a unique file</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 148</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// in the same folder as the drawing, but</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 149</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// that's left to the reader)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 150</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 151</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> path = </span><span style="line-height: 140%; color: #2b91af">Path</span><span style="line-height: 140%">.GetTempFileName();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 152</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; b.Save(path);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 153</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 154</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Call our command</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 155</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">156</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> cmd =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">157</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">String</span><span style="line-height: 140%">.Format(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">158</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;_RINS {0}\n{1},{2},0\n&quot;</span><span style="line-height: 140%">, path, e.X, e.Y</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">159</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 160</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.SendStringToExecute(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 161</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cmd, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 162</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 163</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 164</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 165</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 166</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 167</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 168</span>&#160;<span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Commands</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 169</span>&#160;<span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 170</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PaletteSet</span><span style="line-height: 140%"> _ps = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 171</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ClipboardView</span><span style="line-height: 140%"> _cv = </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 172</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> _pt = </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%">.Origin;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 173</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 174</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;DRAGDROP&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 175</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> DragAndDropClipboardRaster()</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 176</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 177</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_ps == </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 178</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 179</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ps = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PaletteSet</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 180</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;DRAGDROP&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 181</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Guid</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;5C8FC28C-45ED-4796-BD40-28D235B6D7DA&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 182</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 183</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 184</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_cv == </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 185</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 186</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _cv = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ClipboardView</span><span style="line-height: 140%">(_ps);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 187</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 188</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 189</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ps.Text = </span><span style="line-height: 140%; color: #a31515">&quot;Clipboard&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 190</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ps.DockEnabled =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 191</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DockSides</span><span style="line-height: 140%">.Left | </span><span style="line-height: 140%; color: #2b91af">DockSides</span><span style="line-height: 140%">.Right | </span><span style="line-height: 140%; color: #2b91af">DockSides</span><span style="line-height: 140%">.None;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 192</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ps.Size = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> System.Drawing.</span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%">(300, 500);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 193</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _ps.Add(</span><span style="line-height: 140%; color: #a31515">&quot;ClipboardView&quot;</span><span style="line-height: 140%">, _cv);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 194</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 195</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _ps.Visible = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 196</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 197</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 198</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 199</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our custom command to insert a raster image</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 200</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 201</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;RINS&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 202</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> RasterInsert()</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 203</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 204</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 205</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Autodesk.AutoCAD.ApplicationServices.</span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 206</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 207</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 208</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 209</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 210</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Pick up the location of the bitmap image</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 211</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 212</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptStringOptions</span><span style="line-height: 140%"> pso =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 213</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptStringOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 214</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nPath of raster image: &quot;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 215</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 216</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; pso.AllowSpaces = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 217</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptResult</span><span style="line-height: 140%"> pr = ed.GetString(pso);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 218</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 219</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 220</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 221</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!</span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Exists(pr.StringResult))</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 222</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 223</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 224</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nFile does not exist.&quot;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 225</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 226</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 227</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 228</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 229</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> path = pr.StringResult;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 230</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">231</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Pick up the position of the drop in screen coords</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">232</font></span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">233</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptPointOptions</span><span style="line-height: 140%"> ppo =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">234</font></span><font color="#ff0000">&#160;</font><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptPointOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">235</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nPosition of raster image: &quot;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160;<font color="#ff0000"> 236</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">237</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptPointResult</span><span style="line-height: 140%"> ppr = ed.GetPoint(ppo);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">238</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">239</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">240</font></span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">241</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> pos = ppr.Value;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">242</font></span><font color="#ff0000">&#160;</font></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">243</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Calculate the displacement vector</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">244</font></span><font color="#ff0000">&#160;</font></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">245</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> pt =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">246</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PointToWorld(</span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point</span><span style="line-height: 140%">((</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)pos.X, (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)pos.Y));</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">247</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Matrix3d</span><span style="line-height: 140%"> disp =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">248</font></span><font color="#ff0000">&#160;</font><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Matrix3d</span><span style="line-height: 140%">.Displacement(pt - </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%">.Origin);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 249</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 250</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Transaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 251</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.TransactionManager.StartTransaction();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 252</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 253</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 254</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get or create our raster image dictionary</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 255</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 256</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> dictId =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 257</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%">.GetImageDictionary(db);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 258</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (dictId == </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">.Null)</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 259</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dictId = </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%">.CreateImageDictionary(db);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 260</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 261</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And open it for write</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 262</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 263</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBDictionary</span><span style="line-height: 140%"> dict =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 264</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">DBDictionary</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 265</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dictId, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForWrite</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 266</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 267</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 268</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get a unique name for our definition object</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 269</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 270</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> name = </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%">.SuggestName(dict, path);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 271</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 272</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create the definition and add it to the dictionary</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 273</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 274</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%"> rid = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">RasterImageDef</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 275</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; rid.SourceFileName = path;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 276</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; rid.Load();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 277</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> ridId = dict.SetAt(name, rid);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 278</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(rid, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 279</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 280</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Now we'll add our raster image reference</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 281</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// to the current space</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 282</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 283</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%"> btr =</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 284</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 285</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.CurrentSpaceId,</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 286</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForWrite</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 287</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 288</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 289</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create and add the image reference</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 290</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 291</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RasterImage</span><span style="line-height: 140%"> ri = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">RasterImage</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 292</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.ImageDefId = ridId;</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 293</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.SetClipBoundaryToWholeImage();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 294</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; btr.AppendEntity(ri);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 295</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(ri, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; <font color="#ff0000">296</font></span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ri.TransformBy(disp);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 297</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 298</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Of course we commit</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 299</span>&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 300</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 301</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 302</span>&#160;<span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 303</span>&#160;<span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="color: #2b91af">&#160; 304</span>&#160;<span style="line-height: 140%">}</span></p> </div> <!--EndFragment-->  <p>The changes, as you can see, are very modest: the SendStringToExecute() call now sends the point in screen coordinates (adding a zero for Z, just to simplify collection by the command). The command collects and transforms the point before creating a displacement vector to apply to the raster image reference. The matrix gets applied to the image after it has been added to the drawing, but we could very well do so beforehand.</p>  <p>The code now allows the user to drop images from our palette at specific locations in the drawing:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20147e2ce7b62970b-pi"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top: 0px; border-right: 0px; padding-top: 0px" title="After multiple drops" border="0" alt="After multiple drops" src="/assets/image_505351.jpg" width="475" height="281" /></a></p>    <p>I’m heading off to Las Vegas in the morning, but will hopefully still have time to post the jig update at the beginning of next week.</p>
