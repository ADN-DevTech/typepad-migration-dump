---
layout: "post"
title: "Draping temperature data from a thermal image across the Forge viewer scene - Part 2"
date: "2022-01-19 07:03:00"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk"
  - "IoT"
original_url: "https://www.keanw.com/2022/01/draping-temperature-data-from-a-thermal-image-across-the-forge-viewer-scene-part-2.html "
typepad_basename: "draping-temperature-data-from-a-thermal-image-across-the-forge-viewer-scene-part-2"
typepad_status: "Publish"
---

<p>In <a href="https://www.keanw.com/2022/01/draping-temperature-data-from-a-thermal-image-across-the-forge-viewer-scene-part-1.html" rel="noopener" target="_blank">the last post</a> we looked at how it’s possible to take temperature data from a thermal image and use the <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/introduction/overview/" rel="noopener" target="_blank">Data Visualization Extension</a> to connect that information to locations in a 3D Forge viewer scene.</p>
<p>In this post we look at how we can use <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/examples/handling_sprite_events/" rel="noopener" target="_blank">the events from the same extension</a> to display a simple tooltip showing the temperature when one of these locations is hovered over.</p>
<p>Let’s start by looking at what we get from the thermal image. It’s pretty simple: we have colour. As we’re averaging a number of pixels it’s likely to be on a gradient, across the chosen palette, so we’re going to have to do a little work to get the numeric temperature value it represents.</p>
<p>Last time we talked about using <a href="https://www.imgonline.com.ua/eng/add-effect-thermal-imager.php" rel="noopener" target="_blank">this site</a> to generate synthetic thermal image. The site doesn’t specifically talk about the palette that’s used for the image generation, but the closest I could find is <a href="https://www.flir.com/discover/industrial/picking-a-thermal-color-palette/" rel="noopener" target="_blank">Rainbow HC from the FLIR website</a>:</p>
<p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e202942f93e865200c-pi" rel="noopener" target="_blank"><img alt="FLIR&#39;s Rainbow HC colour palette" border="0" height="375" src="/assets/image_124765.jpg" style="margin: 30px auto; border: 0px currentcolor; float: none; display: block; background-image: none;" title="FLIR&#39;s Rainbow HC colour palette" width="500" /></a></p>
<p>This palette includes all the colours shown in the source scene:</p>
<p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20282e13ece04200b-pi" rel="noopener" target="_blank"><img alt="Thermal Scene" border="0" height="265" src="/assets/image_59682.jpg" style="margin: 30px auto; border: 0px currentcolor; float: none; display: block; background-image: none;" title="Thermal Scene" width="500" /></a></p>
<p>Looking at the palette’s legend, I worked on the assumption that the palette could be defined as follows. Bear in mind that I’ve chosen a colour range that mostly makes sense for an office, rather than what is shown in FLIR’s image.</p>
<div class="vscode" style="white-space: pre;">
<div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">palette</span><span style="color: #d4d4d4;"> = {</span></div>
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #9cdcfe;">min</span><span style="color: #9cdcfe;">:</span> <span style="color: #b5cea8;">15</span><span style="color: #d4d4d4;">,</span></div>
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #9cdcfe;">max</span><span style="color: #9cdcfe;">:</span> <span style="color: #b5cea8;">30</span><span style="color: #d4d4d4;">,</span></div>
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #9cdcfe;">units</span><span style="color: #9cdcfe;">:</span> <span style="color: #ce9178;">&#39;°C&#39;</span><span style="color: #d4d4d4;">,</span></div>
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #9cdcfe;">colors</span><span style="color: #9cdcfe;">:</span><span style="color: #d4d4d4;"> [</span> <span style="color: #ce9178;">&#39;magenta&#39;</span><span style="color: #d4d4d4;">, </span><span style="color: #ce9178;">&#39;blue&#39;</span><span style="color: #d4d4d4;">, </span><span style="color: #ce9178;">&#39;cyan&#39;</span><span style="color: #d4d4d4;">,</span> <span style="color: #ce9178;">&#39;green&#39;</span><span style="color: #d4d4d4;">,</span> <span style="color: #ce9178;">&#39;yellow&#39;</span><span style="color: #d4d4d4;">,</span> <span style="color: #ce9178;">&#39;red&#39; </span><span style="color: #d4d4d4;">]</span></div>
<div><span style="color: #d4d4d4;">};</span></div>
</div>
<p>You can see that at a basic level we’re working with just 6 colour stops.</p>
<p>The process to check a colour against this list is fairly simple. First we need a version of the colour stops but with the HTML colour names converted to RGB values. You can find an example of a function that can do this work <a href="https://gist.github.com/njvack/02ad8efcb0d552b0230d" rel="noopener" target="_blank">here</a>.</p>
<p>Then, whenever a sprite is hovered over, we take the HEX colour assigned to it (I tend to store strings for each one rather than having the overhead of storing a THREE.Vector3), convert it to a THREE.Vector3() containing R, G and B values, then check the <a href="https://en.wikipedia.org/wiki/Euclidean_distance" rel="noopener" target="_blank">Euclidean distance</a> between it and each of the colour stops. Here’s a function that does this (should be obvious what colorToRGB() and indexOfSmallest() do… the former is mentioned above while the latter <a href="https://devblogs.microsoft.com/oldnewthing/20140526-00/?p=903" rel="noopener" target="_blank">returns the index of the smallest item in an array</a>):</p>
<div class="vscode" style="white-space: pre;">
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #dcdcaa;">getTemperatureFromColor</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">string</span><span style="color: #d4d4d4;">): </span><span style="color: #4ec9b0;">number</span><span style="color: #d4d4d4;"> {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">col</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">colorToRGB</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">color</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">dists</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">stops</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">map</span><span style="color: #d4d4d4;">((</span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">) </span><span style="color: #569cd6;">=&gt;</span> <span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">distanceTo</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">col</span><span style="color: #d4d4d4;">));</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">smallestIdx</span><span style="color: #d4d4d4;"> = </span><span style="color: #dcdcaa;">indexOfSmallest</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">dists</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">stopSize</span><span style="color: #d4d4d4;"> = (</span><span style="color: #9cdcfe;">palette</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">max</span><span style="color: #d4d4d4;"> - </span><span style="color: #9cdcfe;">palette</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">min</span><span style="color: #d4d4d4;">) / (</span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">_stops</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">length</span><span style="color: #d4d4d4;"> - </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">return</span> <span style="color: #9cdcfe;">palette</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">min</span><span style="color: #d4d4d4;"> + </span><span style="color: #4fc1ff;">smallestIdx</span><span style="color: #d4d4d4;"> * </span><span style="color: #4fc1ff;">stopSize</span><span style="color: #d4d4d4;">;</span></div>
<div><span style="color: #d4d4d4;">&#0160; }<br /></span></div>
</div>
<p>The stops variable contains the colour stops that have been converted to RGB. The return value of this function is pretty simple: it’s a numeric value derived by adding the bottom end of the temperature range to position of the closest stop multiplied by the “stop size” (there must be at least 2 colour stops to avoid a divide by zero, by the way… proper error checking is left as an exercise for the reader ;-).</p>
<p>With just 6 stops the effect is fairly coarse:</p>
<p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2027880663135200d-pi" rel="noopener" target="_blank"><img alt="Coarse thermal hovering" height="240" src="/assets/image_800940.jpg" style="margin: 30px auto; float: none; display: block;" title="Coarse thermal hovering" width="500" /></a></p>
<p>Now this is where things got interesting. Initially I started thinking about how best to get finer-grained temperatures… I started down the route of looking at the distance from the closest stop and determining in which direction to approximate a better value. But then I thought, “hang on, how about just adding a few intermediate values into the array of stops?”. It turns out that adding intermediate stops – going from 6 to 11 to 21 to 41 to 81 to 161, and on – allows you to get a *much* more fine-grained temperature value using exactly the same code.</p>
<div class="vscode" style="white-space: pre;">
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #dcdcaa;">addStops</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">stops</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">THREE</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Vector3</span><span style="color: #d4d4d4;">[]): </span><span style="color: #4ec9b0;">THREE</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Vector3</span><span style="color: #d4d4d4;">[] {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">return</span> <span style="color: #9cdcfe;">stops</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">reduce</span><span style="color: #d4d4d4;">((</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">v</span><span style="color: #d4d4d4;">) </span><span style="color: #569cd6;">=&gt;</span><span style="color: #d4d4d4;"> {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">last</span><span style="color: #d4d4d4;"> = </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">[</span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">length</span><span style="color: #d4d4d4;"> - </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">];</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> (</span><span style="color: #4fc1ff;">last</span><span style="color: #d4d4d4;">) {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">push</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">new</span> <span style="color: #4ec9b0;">THREE</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Vector3</span><span style="color: #d4d4d4;">().</span><span style="color: #dcdcaa;">addVectors</span><span style="color: #d4d4d4;">(</span><span style="color: #4fc1ff;">last</span><span style="color: #d4d4d4;">, </span><span style="color: #9cdcfe;">v</span><span style="color: #d4d4d4;">).</span><span style="color: #dcdcaa;">divideScalar</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">));</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">push</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">v</span><span style="color: #d4d4d4;">);</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">return</span> <span style="color: #9cdcfe;">p</span><span style="color: #d4d4d4;">;</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; }, []);</span></div>
<div><span style="color: #d4d4d4;">&#0160; }</span></div>
<div>&#0160;</div>
<div><span style="color: #d4d4d4;">&#0160; </span><span style="color: #dcdcaa;">addStopsRec</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">stops</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">THREE</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Vector3</span><span style="color: #d4d4d4;">[], </span><span style="color: #9cdcfe;">times</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">number</span><span style="color: #d4d4d4;">): </span><span style="color: #4ec9b0;">THREE</span><span style="color: #d4d4d4;">.</span><span style="color: #4ec9b0;">Vector3</span><span style="color: #d4d4d4;">[] {</span></div>
<div><span style="color: #d4d4d4;">&#0160;&#0160;&#0160; </span><span style="color: #c586c0;">return</span> <span style="color: #9cdcfe;">times</span><span style="color: #d4d4d4;"> &gt; </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> ? </span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">addStopsRec</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">.</span><span style="color: #dcdcaa;">addStops</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">stops</span><span style="color: #d4d4d4;">), </span><span style="color: #9cdcfe;">times</span><span style="color: #d4d4d4;"> - </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">) : </span><span style="color: #9cdcfe;">stops</span><span style="color: #d4d4d4;">;</span></div>
<div><span style="color: #d4d4d4;">&#0160; }</span></div>
</div>
<p>So far I found that having 81 stops – using stops = addStopsRec(stops, 4) during initialization – works well enough for my purposes (the temperature isn’t precise, anyway, so there’s not need to go further). And it seems responsive enough during a mouse-hover event:</p>
<p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e202942f93ea21200c-pi" rel="noopener" target="_blank"><img alt="Fine-grained thermal hovering" height="240" src="/assets/image_501404.jpg" style="margin: 30px auto; float: none; display: block;" title="Fine-grained thermal hovering" width="500" /></a></p>
<p>The tooltips clearly work in a more 3D view, too.</p>
<p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20278806644a3200d-pi" rel="noopener" target="_blank"><img alt="Thermal tooltips in 3D" height="361" src="/assets/image_637861.jpg" style="margin: 30px auto; float: none; display: block;" title="Thermal tooltips in 3D" width="500" /></a></p>
<p>I haven&#39;t provided a complete example for this functionality, but it should be possible to replicate fairly easy based on the pointers I&#39;ve given.</p>
<p>I’m now quite pleased with where we are with this proof-of-concept, at least in terms of the visualization possibilities. Hopefully it’ll be something that’s properly viable, assuming our computer vision magicians find a way to determine the 3D camera information for a particular shot.</p>
