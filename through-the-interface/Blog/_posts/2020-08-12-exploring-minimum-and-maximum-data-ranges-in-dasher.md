---
layout: "post"
title: "Exploring minimum and maximum data ranges in Dasher"
date: "2020-08-12 10:28:17"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk Research"
  - "IoT"
original_url: "https://www.keanw.com/2020/08/exploring-minimum-and-maximum-data-ranges-in-dasher.html "
typepad_basename: "exploring-minimum-and-maximum-data-ranges-in-dasher"
typepad_status: "Publish"
---

<p>Last week <a href="https://www.keanw.com/2020/08/data-resolutions-in-project-dasher.html" target="_blank">I posted</a> about how roll-ups in the time-series back-end used by Project Dasher enable some interesting visualization opportunities. When my colleague Hali Larsen saw the post, she made a really interesting suggestion:</p><blockquote><p><em>It would be cool if the user could select whether the heatmap visualizes the Max, Min, or Average of the data for the selected rollup. (Yet another drop down...) The advantage would be that someone looking for a feature in the data would see the "spikes" whereas when you use the rollups as they currently work you lose a lot of the variability of colour due to the smoothing out of the values associated with the rolled up data through averaging.</em></p></blockquote><p>This was one of those insightful comments that I simply couldn’t ignore… I could immediately see a lot of potential for this mechanism (without knowing how it might be implemented). One great example – that we’ll come back to later – being the ability to scan the maximum values of “Presence” data for long periods to understand which areas in a building might be empty for complete days, perhaps over weekends, etc.</p><p>Anyway, the mental wheels started turning, and so I dove into what it would take to implement it.</p><p>First off, I needed to dig into the data returned for a typical call to our back-end. Here’s a quick view in the debugger of some typical time-series data we receive back when querying the readings for a set of sensors:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2026bde8919e0200c-pi" target="_blank"><img width="483" height="620" title="Our time-series data queried via REST" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Our time-series data queried via REST" src="/assets/image_440813.jpg" border="0"></a></p><p>You can see that for this first sensor we have values with ‘~minValue’ and ‘~maxValue’ as suffixes which provide the data we would want to cache. Bear in mind that other systems will no doubt have different approaches to summarise data – and to communicate minimum and maximum data ranges – so this is probably very specific to our implementation.</p><p>I had a couple of options for making this data available: one would be to extend our existing cache to contain minimum and maximum range values. This would have the advantage of being populated once – as the data is returned in response to each REST call for a particular sensor/roll-up combination, we wouldn’t need to go back and ask again – but it would lead to some memory overhead as we’d be storing three doubles per reading rather than just one.</p><p>The option I ended up going with was to have multiple caches, one to store each of the average (i.e. the standard one we use today), the minimum and the maximum values. These latter two caches are optional: they only get populated when the dropdown is used to choose either ‘minimum’ or ‘maximum’. As I don’t think this is going to be a feature that is used heavily – it’s really just something you will want occasionally for niche exploration tasks – I think it’s better not to keep the data in memory “just-in-case”, and that we query the data “just-in-time” should we need to populate one or both of these optional caches.</p><p>A side-note: you may remember having seen minimum and maximum range values in the Splash graphing module (see the below image for an example of this – you can see the min/max ranges in pale blue). Splash manages its own cache that’s essentially independent of the one used elsewhere in Dasher (which hinges heavily on the time range selected in the timeline).</p><p>This has been a lot of detail on how I approached implementing this, but let’s now go back and reconsider the example workflow I mentioned at the beginning to illustrate how it might be useful.</p><p>In the NEST dataset we have a number of “Presence” sensors, which return Boolean values indicating whether spaces are empty (0) or occupied (1). The raw data – which appears to have a 1-minute granularity – is simply 0s and 1s, but as soon as we get into the higher-level roll-ups (i.e. 15M and above) the values get averaged across that particular time period.</p><p>Here’s a 10-day view of data from one presence sensor, and we can see that the averaged values give a sense of the overall occupancy:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20263e95bc977200b-pi" target="_blank"><img width="500" height="359" title="Presence graph" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Presence graph" src="/assets/image_496825.jpg" border="0"></a></p><p>This is interesting, but when we look at the way this appears during surface shading, it’s hard to get much direct value from visualising the rolled-up data. Here’s the standard, averaged data shown with a 1-hour resolution:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2026be407e1c4200d-pi" target="_blank"><img width="500" height="312" title="Average presence for 1-hour roll-up" style="margin: 30px auto; float: none; display: block;" alt="Average presence for 1-hour roll-up" src="/assets/image_444955.jpg"></a></p><p>If you want to see this view yourself, <a href="https://dasher360.com/share/oVAM3dF7M?basId=default_421120055&amp;level=auto&amp;shade=auto&amp;start=2020-07-01T00:00:00.000Z&amp;end=2020-07-10T23:59:00.007Z&amp;current=2020-07-06T21:46:58.995Z&amp;padding=5&amp;play=1&amp;loop=1&amp;speed=4&amp;sensors=1&amp;fixPlots=1&amp;resolution=1H&amp;view=pos|-85.3,-13.5,15.4|tgt|95.0,78.7,-53.7" target="_blank">here’s a link to bring it up inside Dasher</a> (I implemented the resolution parameter in the API to allow this to be selected in a custom URL).</p><p>Using the latest feature that’s been added to <a href="http://dasher360.com" target="_blank">Project Dasher</a> (and is now live via the NEST demo for you to try), we can enable the Avg/Min/Max dropdown during surface shading via the application settings:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2026bde892149200c-pi" target="_blank"><img width="257" height="500" title="New setting inside Dasher" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="New setting inside Dasher" src="/assets/image_128456.jpg" border="0"></a></p><p>Then we can try again by looking at the Maximum values for the same time period, this time using the 1-day data resolution. We can immediately see areas that have gone full days without being occupied – and yes, this is most obvious from the dark blue coverage during weekends where the maximum Presence value for most sensors is zero.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2026be407e1ce200d-pi"><img width="500" height="312" title="Maximum presence for 1-day roll-up" style="margin: 30px auto; float: none; display: block;" alt="Maximum presence for 1-day roll-up" src="/assets/image_784475.jpg"></a></p><p>And as I went ahead and implemented an URL parameter API for the Avg/Min/Max option, too, you can <a href="https://dasher360.com/share/oVAM3dF7M?basId=default_421120055&amp;level=auto&amp;shade=auto&amp;start=2020-07-01T00:00:00.000Z&amp;end=2020-07-10T23:59:00.007Z&amp;current=2020-07-08T02:53:23.687Z&amp;padding=5&amp;play=1&amp;loop=1&amp;speed=4&amp;sensors=1&amp;fixPlots=1&amp;resolution=1D&amp;avgMinMax=2&amp;view=pos|-85.3,-13.5,15.4|tgt|95.0,78.7,-53.7" target="_blank">try this for yourself via this link</a>.</p><p>Hopefully you can see that adjusting the roll-up and choosing to view the upper or lower end of its range can help get a different sense of what’s been captured in the data. Thanks again for the suggestion, Hali – I agree that this could be very useful!</p><p>A quick side note on some additional work that’s been done in this update: while I was implementing this mechanism, I ended up digging more into our caching code – which admittedly I’ve done my best to stay away from until now. When updating the cache, we were querying the sensor readings for groups of sensors in a single REST call, but only those with a single type (Temperature, CO2, Humidity, etc.). I adjusted the mechanism to batch up requests into larger groups across sensor types – as well as adjusting the timing of when the cache gets updated – which seems to be more efficient. I’d been seeing some strange behaviour where the “Loading Sensor Data” message gets stuck on certain requests: eventually the request gets processed, but I still don’t have a sense of where it’s getting stuck (I have a feeling it’s because we have some legacy code that uses $.ajax() to get our time-series data. I may have to dig more into this, at some point, but for now reducing the number of calls does seem to help.)</p>
