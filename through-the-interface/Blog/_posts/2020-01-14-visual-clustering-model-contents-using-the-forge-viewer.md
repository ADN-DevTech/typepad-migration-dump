---
layout: "post"
title: "Visually clustering the contents of models in the Forge viewer"
date: "2020-01-14 17:39:54"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk"
  - "Autodesk Research"
  - "IoT"
original_url: "https://www.keanw.com/2020/01/visual-clustering-model-contents-using-the-forge-viewer.html "
typepad_basename: "visual-clustering-model-contents-using-the-forge-viewer"
typepad_status: "Publish"
---

<p>Some of you may already have seen <a href="https://twitter.com/augustomaia/status/1214878004465127427" target="_blank">Augusto’s tweet showing the “Visual Clusters" Forge viewer extension</a> that has been developed by the BIM 360 Design team.</p><p>It really is <strong>super-cool</strong>: the extension takes the content of the model loaded in the Forge viewer and clusters it spatially based on the value of the various items’ <em>category</em> property. The extension was first published in v7.6 of the Forge viewer, so it’s been around a little while. If you don’t have a Forge viewer application to test it out with, fear not! Petr Broz has <a href="https://twitter.com/ipetrbroz/status/1217051378029355009" target="_blank">added the capability to load extensions into his awesome Visual Code extension</a> that hosts the Forge viewer. That seems to be an easy way to test out the extension’s capabilities with your own derivatives. There really isn’t any code needed beyond loading the “Autodesk.VisualClusters” extension in your custom viewer session: this leads to the extension’s button being added to the standard toolbar next to the <em>Explode</em> button.</p><p>Anyway, I figured I’d give the extension a try, to see what value it might bring to <a href="http://dasher360.com" target="_blank">Dasher 360</a>. The first major hurdle I hit was that the extension, when loaded, wouldn’t actually do anything with the models we use inside Dasher (most notably the NEST and 210 King Street East models we’ve been using to demo Dasher 360’s capabilities). From digging into the issue, I found something interesting: our leaf content doesn’t have a <em>category</em> property directly on it; this is something that is found in their parent nodes. I haven’t looked into why this might be – it could be because we’re exporting our models to NWC before loading them into Dasher – but it was interesting to realise there was a difference in the way the data was structured.</p><p>As I work for Autodesk, it was a relatively simple task to get hold of the code for the Forge viewer and build a custom version of the extension that works for Dasher 360 models.</p><p>The default approach the extension takes is the following: it takes the dbIds that have geometry fragments associated with them, then queries for their <em>category</em> properties (this is just the default, by the way, as the code has been generalised to cluster based on other properties even if this feature isn’t currently exposed), which it uses as the basis for the clustering process.</p><p>My updated version gives the option to search all dbIds (not just leaf nodes associated with geometry) for the chosen property, and then clusters the geometric children of these nodes. Hopefully this approach (or one like it), will get added to a future version of the viewer: in the meantime I can only share videos and images showing it working.</p><p>Here’s an animation that shows how the modified extension can work with the NEST model, for instance:<a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a4b41e2c200c-pi" target="_blank"><img width="500" height="312" title="NEST visual clustering" style="margin: 30px auto; float: none; display: block;" alt="NEST visual clustering" src="/assets/image_382365.jpg"></a></p><p>I did have to jump through some hoops to turn off ground shadows and reflections before transitioning the view: be warned that the extension currently doesn’t do this for you, so it may look a bit strange if you’re using either effect.</p><p>The overall layout is pretty huge, but really cool to search through. Here’s a zoomed out view of it all:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a4b41e32200c-pi"><img width="500" height="312" title="Visual clustering of NEST" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Visual clustering of NEST" src="/assets/image_479062.jpg" border="0"></a></p><p>Here’s one close-up showing some of the content. Check out the stack of ceilings on the right, and the flex ducts in the foreground.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a501f105200b-pi"><img width="500" height="312" title="Pieces of the NEST model clustered" style="margin: 30px auto; border-image: none; float: none; display: block; background-image: none;" alt="Pieces of the NEST model clustered" src="/assets/image_486696.jpg" border="0"></a></p><p>Here’s another view, showing the rooves, floors and walls. Such fun!</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a501f10d200b-pi"><img width="500" height="312" title="More pieces of the NEST model clustered" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="More pieces of the NEST model clustered" src="/assets/image_733819.jpg" border="0"></a></p><p>If you end up implementing this extension in your application and need something additional (such as clustering on a property other than <em>category</em> or needing to turns off ground shadows/reflections) then do let me (or the Forge team) know: this extension is still in its infancy, and the development team are definitely looking for feedback on possible directions for this extension.</p><p>In the meantime, happy clustering!</p>
