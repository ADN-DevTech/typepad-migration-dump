---
layout: "post"
title: "Connecting Dynamo to the Internet of Things"
date: "2016-05-13 20:46:13"
author: "Kean Walmsley"
categories:
  - "Autodesk"
  - "Autodesk Research"
  - "Dynamo"
  - "Generative design"
  - "IoT"
original_url: "https://www.keanw.com/2016/05/connecting-dynamo-to-the-internet-of-things.html "
typepad_basename: "connecting-dynamo-to-the-internet-of-things"
typepad_status: "Publish"
---

<p>We have our annual, internal Technical Summit coming up in a couple of weeks. I’ll be heading across to Montreal with 700+ other Autodesk employees to learn more about the cool stuff going on within the company. As I’ve done in previous years, I’ll do my best to report information that I think will be interesting to this blog’s readers (and that is ready to be discussed publicly, of course).</p> <p>One of the event’s activities is being hosted by my team: the IoT Hackday. We’ll have 30+ participants spread across 8 different teams. Each team will get provided some sensors, some LEDs, a Raspberry Pi 3 and the access credentials to connect to the back-end IoT data service Autodesk Research is building. They’ll use these ingredients to cook up interesting IoT-related projects that use our back-end data service.</p> <p>As part of this effort, I was asked to put together a custom Dynamo node that allows you to query the service for the latest reading from a particular sensor.</p> <p>I’m happy to say it’s working well. At some point – as the API gets closer to being publicly consumable – I’ll share the complete code, here. The project really is basically a <a href="https://github.com/DynamoDS/Dynamo/wiki/Zero-Touch-Plugin-Development" target="_blank">“zero touch” plugin</a> – a&nbsp; .NET Class Library (.DLL) which can be imported into Dynamo Studio – that calls into our back-end service via its REST API. In our case we want our sensor readings to be read periodically, so we need to mark that particular method with [CanUpdatePeriodicallyAttribute(true)]. This tells Dynamo Studio to enable the otherwise greyed-out “Periodic” execution option (in addition to “Manual” and “Automatic”) so that the values will be read regularly and have their values propagated through the graph.</p> <p>As the API we’re using for this isn’t yet live, I decided to consider other REST APIs that return sensor-like data that changes frequently. I settled on retrieving <a href="http://finance.yahoo.com/webservice/v1/symbols/ADSK/quote?format=json" target="_blank">stock quotes from Yahoo Finance</a>, and using this data to adjust geometry in Dynamo Studio. (I <a href="https://www.google.com/finance/info?q=ADSK" target="_blank">first looked at Google Finance</a>, but it seems this API is long-deprecated… neither API can be used for commercial applications, in case you’re considering it.)</p> <p>And so it was that DynaQuote was born. :-)</p> <p>So yes, the title of this post should probably be “Connecting Dynamo to Realtime Stock Data”, but that’s not really the point: this is about the approach you can take to have generative geometry connect to REST APIs, which could well be based on IoT sensor data (as we’ll be exploring at the Hackday).</p> <p>Here’s the C# code. To get it working you’ll need to NuGet in the <a href="https://www.nuget.org/packages/DynamoVisualProgramming.ZeroTouchLibrary/0.9.1" target="_blank">ZeroTouchLibrary</a> and <a href="https://www.nuget.org/packages/Newtonsoft.Json/8.0.3" target="_blank">Json.NET</a>. I also added a project reference to System.Net.Http. Otherwise you should be able to get it working by copy &amp; pasting it into a simple Class Library project.</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.DesignScript.Runtime;</p> <p style="margin: 0px"><span style="color: blue">using</span> Newtonsoft.Json.Linq;</p> <p style="margin: 0px"><span style="color: blue">using</span> System;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Net.Http;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Threading.Tasks;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">namespace</span> DynaQuote</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; <span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: blue">class</span> <span style="color: #2b91af">Extensions</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Extension to simplify adding key-value pairs to a list</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: blue">void</span> AddPair(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span> <span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">KeyValuePair</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;&gt; list, <span style="color: blue">string</span> key, <span style="color: blue">string</span> val</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.Add(<span style="color: blue">new</span> <span style="color: #2b91af">KeyValuePair</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;(key, val));</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Stock</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">string</span> quoteUrl =</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #a31515">"http://finance.yahoo.com/webservice/v1/symbols/{0}/quote?format=json"</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Another alternative is...</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">//"http://www.google.com/finance/info?q={0}";</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Which requires different unpacking, of course</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">string</span> _ticker;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// The constructor is internal as Dynamo users will construct it via a</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// static method</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">internal</span> Stock(<span style="color: blue">string</span> ticker)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ticker = ticker;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> Creates a stock node based on a ticker.</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;param name="ticker"&gt;</span><span style="color: green">The stock ticker</span><span style="color: gray">&lt;/param&gt;</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">A node representing the specified stock</span><span style="color: gray">&lt;/returns&gt;</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: #2b91af">Stock</span> ByTicker(<span style="color: blue">string</span> ticker)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">Stock</span>(ticker);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;summary&gt;</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> Gets the most recent stock quote</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;/summary&gt;</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: gray">///</span><span style="color: green"> </span><span style="color: gray">&lt;returns&gt;</span><span style="color: green">The most recent stock quote</span><span style="color: gray">&lt;/returns&gt;</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">CanUpdatePeriodicallyAttribute</span>(<span style="color: blue">true</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">double</span> Quote()</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">try</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Format the URL to return the quote for a particular stock</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> url = <span style="color: #2b91af">String</span>.Format(quoteUrl, _ticker);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> res = Invoke(url).Result;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// If we still haven't succeeded, return an invalid value</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (<span style="color: #2b91af">String</span>.IsNullOrEmpty(res))</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: #2b91af">Double</span>.NaN;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Parse and sort the results</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> json = <span style="color: #2b91af">JObject</span>.Parse(res);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; json[<span style="color: #a31515">"list"</span>][<span style="color: #a31515">"resources"</span>][0][<span style="color: #a31515">"resource"</span>][<span style="color: #a31515">"fields"</span>][<span style="color: #a31515">"price"</span>].Value&lt;<span style="color: blue">double</span>&gt;();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">catch</span> { <span style="color: blue">return</span> <span style="color: #2b91af">Double</span>.NaN; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">static</span> <span style="color: blue">private</span> <span style="color: blue">async</span> <span style="color: #2b91af">Task</span>&lt;<span style="color: blue">string</span>&gt; Invoke(<span style="color: blue">string</span> uri)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: blue">var</span> hc = <span style="color: blue">new</span> <span style="color: #2b91af">HttpClient</span>())</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Get the response: if it's valid return the JSON string else null</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> res = <span style="color: blue">await</span> hc.GetAsync(uri);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (res.IsSuccessStatusCode ? <span style="color: blue">await</span> res.Content.ReadAsStringAsync() : <span style="color: blue">null</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Here’s the code in action, adjusting the size of a sphere based on Autodesk’s stock price.</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c85aaf45970b-pi" target="_blank"><img title="DynaQuote" style="float: none; margin: 30px auto; display: block" alt="DynaQuote" src="/assets/image_242481.jpg" width="500" height="286"></a></p> <p>I used a couple of tricks to make it all more visible: firstly I took away the integer component of the stock price (as 2 cent fluctuations on a base of $58 aren’t very visible), before using that for the sphere’s radius. I also edited out big chunks of the video, as stock-watching is boring business. I tried having the colour of the sphere keyed off the stock price, too – which would make this very much like a virtual version of <a href="https://en.wikipedia.org/wiki/Ambient_Devices" target="_blank">Ambient Devices’</a> <a href="http://ambientdevices.myshopify.com/products/stock-orb" target="_blank">Stock Orb</a>, a ground-breaking device that’s incredibly been around for 14 or so years – but as I’m running Dynamo Studio in a virtual machine, and the <a href="http://dynamobim.org/dynamo-0-8-1-now-in-technicolor/" target="_blank">Display.ByGeometryColor node apparently uses hardware rendering</a>, this didn’t actually do anything beyond adding unwanted complexity to the graph.</p> <p>I hope you have fun with this technique: I actually think it has really interesting potential, given the broad availability of realtime data APIs (and not just in the domains of IoT and finance). It’ll be interesting to see how people end up using it at the Hackday!</p>
