---
layout: "post"
title: ".NET goes open source | Machine learning with F#"
date: "2014-11-13 16:03:31"
author: "Kean Walmsley"
categories:
  - "F#"
  - "Training"
original_url: "https://www.keanw.com/2014/11/net-goes-open-source-machine-learning-with-f.html "
typepad_basename: "net-goes-open-source-machine-learning-with-f"
typepad_status: "Publish"
---

<p>Taking a rest from my <a href="http://au.autodesk.com" target="_blank">AU</a> prep, I headed across to Zurich last night for <a href="http://www.meetup.com/zurich-fsharp-users/events/212973172" target="_blank">an F# meetup focused on machine learning</a>. Primarily because I’m interested in machine learning as a field but also because it seemed a good opportunity to dust off my F# skills.</p>  <p>It was interesting to be on the train when <a href="http://blogs.msdn.com/b/somasegar/archive/2014/11/12/opening-up-visual-studio-and-net-to-every-developer-any-application-net-server-core-open-source-and-cross-platform-visual-studio-community-2013-and-preview-of-visual-studio-2015-and-net-2015.aspx" target="_blank">the news from the first day of Microsoft’s Connect(); event</a> hit the airwaves: the main headline being that .NET is going open source and cross-platform. Yes, folks, it’s actually happening: .NET 5 is going to be supported on Linux and OS X. And .NET is <a href="https://github.com/dotnet" target="_blank">already on GitHub</a> with <a href="https://github.com/dotnet/corefx/pull/31" target="_blank">the first pull request already approved</a>. It’s not clear what exactly the impact of this news is with respect to desktop software on the Mac: the initial target for this is .NET Core – the server-targeting subset of .NET – but I have to see this as a great thing for the .NET community, however it plays out.</p>  <p>So, back to last night’s F# session, which was of course with a room full of people who are used to working with an open source language: <a href="http://blogs.msdn.com/b/fsharpteam/archive/2012/09/24/announcing-the-f-3-0-open-source-code-drop.aspx" target="_blank">F# went open source a couple of years ago</a>. The session was run by <a href="https://twitter.com/brandewinder" target="_blank">Mathias Brandewinder</a>, who is holding this same “coding dojo” at various locations around Europe. Mathias is originally from France but is now based in San Francisco. He’s clearly passionate about using F# for machine learning applications and engaging with the F# community as a whole.</p>  <p>The dojo was based around <a href="http://www.kaggle.com/c/digit-recognizer" target="_blank">a programming challenge from Kaggle.com</a>: to write a hand-written digit recognizer that takes a sequence of greyscale bitmaps (stored in a CSV file as a series of per-pixel integers) and attempts to classify them based on some training data (a subset of <a href="http://www.kaggle.com/c/digit-recognizer/data" target="_blank">the data provided on Kaggle.com</a>, I should add). We were sorted into groups, although the members of our group ended up deciding to attack the problem independently (<a href="https://twitter.com/iceypoi" target="_blank">Daniel</a>, the person sitting to my left in the below photo, is a professional F# programmer… he was already porting his code to be parallelized on the GPU by the time I’d managed to finish the exercise).<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c705de44970b-pi" target="_blank"><img title="Machine learning dojo" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Machine learning dojo" src="/assets/image_110178.jpg" width="420" height="320" /></a></p>  <p>Here’s the F# code I managed to come up with for the basic challenge (after a bit of tidy up).</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">open</span> System</p>    <p style="margin: 0px"><span style="color: blue">open</span> System.IO</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Functions to go from an array of comma-separated strings</span></p>    <p style="margin: 0px"><span style="color: green">// to a list of tuples of the classified digit and an array</span></p>    <p style="margin: 0px"><span style="color: green">// integers representing pixels</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> split a = List.map (<span style="color: blue">fun</span> (s:string) <span style="color: blue">-&gt;</span> s.Split(<span style="color: #a31515">','</span>)) a</p>    <p style="margin: 0px"><span style="color: blue">let</span> ints = Array.map Int32.Parse</p>    <p style="margin: 0px"><span style="color: blue">let</span> tuple a = Seq.head a, Seq.skip 1 a |&gt; Seq.toArray</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Classify using the nearest-neighbour algorithm, checking</span></p>    <p style="margin: 0px"><span style="color: green">// the Euclidean distance between the respective pixels in the</span></p>    <p style="margin: 0px"><span style="color: green">// images being compared.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> eucDist p1 p2 = p1-p2 |&gt; <span style="color: blue">fun</span> x <span style="color: blue">-&gt;</span> x*x</p>    <p style="margin: 0px"><span style="color: blue">let</span> dist a b = Array.map2 eucDist a b |&gt; Array.sum</p>    <p style="margin: 0px"><span style="color: blue">let</span> classify a r = r |&gt; List.minBy (<span style="color: blue">fun</span> t <span style="color: blue">-&gt;</span> dist (snd t) a) |&gt; fst</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Read in a CSV file from the specified path and create</span></p>    <p style="margin: 0px"><span style="color: green">// a list of tuples containing the classified digit and an</span></p>    <p style="margin: 0px"><span style="color: green">// array of integers for the pixels</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> read path =</p>    <p style="margin: 0px">&#160; File.ReadAllLines(path) |&gt; Array.toList |&gt; split</p>    <p style="margin: 0px">&#160; |&gt; List.tail |&gt; List.map ints |&gt; List.map tuple</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> tpath = <span style="color: #a31515">&quot;Z:\\Data\\FSharp dojo\\trainingsample.csv&quot;</span></p>    <p style="margin: 0px"><span style="color: blue">let</span> vpath = <span style="color: #a31515">&quot;Z:\\Data\\FSharp dojo\\validationsample.csv&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Read in the training data and store it for later use</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">let</span> tdata = read tpath</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Read in the validation sample and print the percentage of</span></p>    <p style="margin: 0px"><span style="color: green">// cases that are correctly classified</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">read vpath</p>    <p style="margin: 0px">&#160; |&gt; List.averageBy (<span style="color: blue">fun</span> x <span style="color: blue">-&gt;</span> </p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (classify (snd x) tdata = fst x) <span style="color: blue">then</span> 1. <span style="color: blue">else</span> 0.)</p>    <p style="margin: 0px">&#160; |&gt; (*) 100. |&gt; printfn <span style="color: #a31515">&quot;%g%% of entries classified&quot;</span></p> </div>  <p>As suggested by Mathias, the code implements the “nearest neighbor” algorithm (i.e. the <a href="http://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm" target="_blank">k-nearest neighbors</a> algorithm where k == 1). This morning I went ahead and coded up a version of the classify function that allows the k nearest neighbours to vote on the result, too…</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">let</span> classify2 a r =</p>    <p style="margin: 0px">&#160; r |&gt; List.sortBy (<span style="color: blue">fun</span> t <span style="color: blue">-&gt;</span> dist (snd t) a)</p>    <p style="margin: 0px">&#160; |&gt; Seq.take 5 |&gt; Seq.countBy id</p>    <p style="margin: 0px">&#160; |&gt; Seq.head |&gt; fst |&gt; fst</p> </div>  <p>… but it didn’t actually change anything: both versions returned the same result (which is the one expected, unless you start to implement more advanced techniques to recognise off-centre digits, etc.).</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px">94.4% of entries classified</p> </div>  <p>It was a really fun introduction to solving machine learning problems using F#. This is a field that’s clearly relevant when users interact with complex systems – including design tools – so I’m happy to have taken at least a baby step towards some real understanding of the domain.</p>  <p><font color="#a5a5a5">Photo copyright Mathias Brandewinder.</font></p>
