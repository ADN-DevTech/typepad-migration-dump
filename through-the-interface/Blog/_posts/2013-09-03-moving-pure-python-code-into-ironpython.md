---
layout: "post"
title: "Moving pure Python code into IronPython"
date: "2013-09-03 17:16:04"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Geometry"
  - "HTML"
  - "IronPython"
  - "JavaScript"
  - "Python"
original_url: "https://www.keanw.com/2013/09/moving-pure-python-code-into-ironpython.html "
typepad_basename: "moving-pure-python-code-into-ironpython"
typepad_status: "Publish"
---

<p>As part of <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/applications-for-linear-algebra-straightening-out-perspective.html" target="_blank">the project I’m working on to deskew perspective images</a> and insert them as RasterImage entities inside AutoCAD, I spent quite some time migrating pure Python code – a good deal of which I had to create for various assignments as part of <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/coursera-the-future-of-education.html" target="_blank">the linear algebra class</a> I’ve now finished – for it to work inside IronPython. For those of you who aren’t familiar with it, IronPython is a variant of Python that works with .NET via the Dynamic Language Runtime. Making it really easy to integrate with AutoCAD.</p>  <p>The code as it stood previously was working inside <a href="http://en.wikipedia.org/wiki/CPython" target="_blank">CPython</a>, which I used on my Mac to complete the assignments for this course:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019aff2addec970c-pi" target="_blank"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top: 0px; border-right: 0px; padding-top: 0px" title="python3 running our code" border="0" alt="python3 running our code" src="/assets/image_390626.jpg" width="450" height="346" /></a></p>  <p>And it worked pretty well: I’d previously spent quite a bit of time getting the code in a reasonable shape for porting to other environments (placing loose code in functions, etc).</p>  <p>As <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/update-on-the-project-to-de-skew-images-inside-autocad.html" target="_blank">mentioned previously</a>, one of the big issues to resolve was to make sure my code wasn’t dependent on compiled Python (.pyc) files, as these currently don’t work inside IronPython. With that particular issue resolved – we had to implement our own “solver” module in one of the later homework assignments, effectively replacing the compiled one we’d been given previously – it remained to get cracking on getting the .py modules themselves to work inside IronPython.</p>  <p>The most straightforward way to get moving on this was to use the Python <a href="http://en.wikipedia.org/wiki/REPL" target="_blank">REPL</a> – provided as IPY.EXE, a command-line application – to try out the code and look at the results (and <a href="http://en.wikipedia.org/wiki/Heart_of_Darkness" target="_blank">the errors… the errors…</a> :-). My aim was to build a single codebase that would work via the command-line in CPython, with standalone IronPython (i.e. IPY.EXE) and then inside IronPython hosted by an AutoCAD app. And the Python code inside AutoCAD should integrate with its the UI, sending messages to the user via the command-line and displaying the progress of long-running operations via the progress meter in the status bar.</p>  <p>The first part of this was to get the .py files available to the IPY executable. Now there may well be a more elegant way to deal with this – in fact, there must be – but I just went ahead and copied them into the “<em>C:\Program Files (x86)\IronPython 2.7</em>” folder. When I then launched IPY I could load and execute them:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019aff2ade00970c-pi" target="_blank"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top: 0px; border-right: 0px; padding-top: 0px" title="IPY running our code" border="0" alt="IPY running our code" src="/assets/image_313743.jpg" width="424" height="216" /></a></p>  <p>Much of the code worked well enough, but there were some really subtle issues that took me time to identify and fix. One that took me ages to find was due to an operator inside the matrix class: the operator checks the type of the arguments in order to determine whether to use matrix-vector multiplication, matrix-matrix multiplication or simple scalar multiplication. Because the type test it was performing – e.g. “Mat == type(other)” – was always failing, the code always fell through to scalar-matrix multiplication. I eventually fixed it by using “isinstance(other, Mat)”, which worked in the various flavours of Python in which I tested it.</p>  <p>Being in a dynamic environment certainly has its challenges: as the type you’re expecting from a certain operation – whether it’s a matrix-vector multiplication that should return another vector, a scalar multiplication on a matrix that should return another matrix, etc. – doesn’t always get returned and doesn’t necessarily cause a problem there and then. It’s only as the data flows onwards that the problem surfaces in what often turns out to be a really obscure way.</p>  <p>And the problematic results are often really hard to troubleshoot: there wasn’t a straightforward way for me to debug into this code inside either IPY or AutoCAD, at least not that I could find.</p>  <p>Another “fun” one was due to the accumulator for a vector-vector dot product operation being initialised to an integer (0) rather than a decimal (0.0). In IronPython this meant the results would always be returned as an integer, while in CPython the data-type morphed to a decimal as it needed to. Finding that one was also really tricky, although it did create some pretty cool images in the meantime (creating anything at all was exciting, by this point, and besides that I liked the effects ;-).</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019aff2b3a18970d-pi" target="_blank"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top: 0px; border-right: 0px; padding-top: 0px" title="Interesting effect on the whiteboard" border="0" alt="Interesting effect on the whiteboard" src="/assets/image_198825.jpg" width="469" height="190" /></a></p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019aff2b3a3e970d-pi" target="_blank"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top: 0px; border-right: 0px; padding-top: 0px" title="Interesting effect on the painting" border="0" alt="Interesting effect on the painting" src="/assets/image_273901.jpg" width="256" height="319" /></a></p>  <p>Eventually it all worked well, which meant I could also successfully build the code into an app hosted inside AutoCAD. We’ll take a look at that in the next post in this series. In the meantime, <a href="http://through-the-interface.typepad.com/files/PythonDeskewing.zip" target="_blank">here’s a ZIP containing the Python code that you can run for yourself in IronPython or CPython</a> before seeing the final version working inside AutoCAD. Check <em>deskew.py</em> for the various tests that are included (deskew2()… deskew4(), in particular).</p>  <p>Before I wrap this post up, I’ll give a quick update on one of the later tasks, specifically the one to create a UI allowing selection of the four corner points to feed the de-skewing code. I’d previously thought to create a WPF app for this but I’ve now changed my mind: in order to create something that’s ultimately more flexible – an asset that could be repurposed much more broadly – I’ve decided to create something inside HTML5 and JavaScript.</p>  <p>Which means that by the time we’re done, we’ll have an app that’s running C#, Python and JavaScript code (and dealing with the various interop issues this combination will raise). Fun, fun, fun! :-)</p>
