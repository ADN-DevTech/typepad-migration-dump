---
layout: "post"
title: "AU 2014 Handout: Using SensorTag as a Low-Cost Sensor Array for AutoCAD"
date: "2014-11-19 10:31:29"
author: "Kean Walmsley"
categories:
  - "AU"
  - "AutoCAD"
  - "AutoCAD .NET"
original_url: "https://www.keanw.com/2014/11/au-2014-handout-using-sensortag-as-a-low-cost-sensor-array-for-autocad.html "
typepad_basename: "au-2014-handout-using-sensortag-as-a-low-cost-sensor-array-for-autocad"
typepad_status: "Publish"
---

<p><em>[This handout is for “<a href="https://events.au.autodesk.com/connect/sessionDetail.ww?SESSION_ID=5013">SD5013 - Using SensorTag as a Low-Cost Sensor Array for AutoCAD</a>”, a 60-minute class I’ll be presenting at AU 2014. <a href="http://through-the-interface.typepad.com/files/SensOrbit.zip">Here’s the sample project</a> that accompanies this handout.]</em></p>  <p><em></em></p>  <p>&#160;</p>  <h2>Introducing SensorTag</h2>  <p>SensorTag is <a href="https://estore.ti.com/CC2541DK-SENSOR-P3192.aspx">a $25 device</a> containing a number of sensors – an accelerometer, a gyroscope, a magnetometer, a thermometer, a hygrometer and a barometer – that communicates to a monitoring system (whether an iOS or Android mobile device or a Windows or Linux PC) via <a href="http://en.wikipedia.org/wiki/Bluetooth_low_energy">Bluetooth 4.0</a> (also known as Bluetooth Smart or Bluetooth Low Energy – BLE). Texas Instruments have packaged their CC2541 sensor platform in a consumer-friendly package with the intention of driving adoption from app developers who will use it to create solutions for health monitoring and the Internet of Things (just to name a couple of “hot” areas).</p>  <p>The device is powered by a single CR2032 coin cell battery, which is enough to power the low-power sensor array and Bluetooth communications for several months (this will depend on the number of sensors used and the frequency of communication, of course).</p>  <p>Developers might use the device to monitor the temperature of cooking pans and hot drinks, to track the location of keys using the newer iBeacon capability, or even to test how level a surface is.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb07ae919e970d-pi" target="_blank"><img title="Uses for SensorTag" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Uses for SensorTag" src="/assets/image_893236.jpg" width="404" height="436" /></a></p>  <p>At the core of the SensorTag is the CC2541 chip. We’ll see later on that this is also used to power other devices, too. </p>  <p>Here’s a block diagram of the SensorTag device, outlining the various components:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d093551e970c-pi" target="_blank"><img title="SensorTag block diagram" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="SensorTag block diagram" src="/assets/image_561830.jpg" width="390" height="199" /></a></p>  <p>Here’s an assembly diagram alongside a close-up of the SensorTag’s internals, showing where each of the sensors resides:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d0935524970c-pi" target="_blank"><img title="Hardware description" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: left; padding-top: 0px; padding-left: 0px; margin: 10px 0px 20px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Hardware description" src="/assets/image_440646.jpg" width="300" align="left" height="300" /></a></p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c70949d7970b-pi" target="_blank"><img title="Assembly" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Assembly" src="/assets/image_107881.jpg" width="160" height="315" /></a></p>  <h3>Applications for 3D design apps</h3>  <p>While the SensorTag contains some interesting sensors, those that are of most interest for controlling 3D design applications are the spatial sensors. Just like many other devices, SensorTag contains an IMU – or inertial measurement unit – which consists of 3-axis accelerometer, gyroscope and magnetometer components. The IMU provides accurate information on where the SensorTag is located in 3D space.</p>  <p>This creates some interesting with respect to using SensorTag to control model navigation inside AutoCAD, for instance. Movements of the SensorTag can drive view changes in AutoCAD.</p>  <p>The same mechanism could almost certainly be implemented using a smartphone rather than a SensorTag, for instance, but there are certainly advantages to building a cheap, dedicated device for this.</p>  <h3>Getting to know your SensorTag</h3>  <p>The simplest way to connect with a SensorTag device and get to know its services is to install the SensorTag app for <a href="http://itunes.apple.com/app/ti-ble-sensortag/id552918064?l=nb&amp;mt=8">iOS</a> or <a href="https://play.google.com/store/apps/details?id=com.ti.ble.sensortag">Android</a>:</p>  <p>This will allow you to experience the data streaming from the device and determine whether it’s of interest to your specific domain.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d09355a3970c-pi" target="_blank"><img title="SensorTag Android app" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; border-left: 0px; display: block; padding-right: 0px" border="0" alt="SensorTag Android app" src="/assets/image_637903.jpg" width="204" height="381" /></a></p>  <h3>Transitioning to the Desktop</h3>  <h4>Hardware</h4>  <p>Connecting SensorTag with a Windows machine is more complicated, however. </p>  <p><a href="http://www.ti.com/tool/cc2540emk-usb"><img title="CC2531_USB_dongle" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; margin: 20px 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="CC2531_USB_dongle" src="/assets/image_549930.jpg" width="100" align="right" height="71" /></a>You need to use a compatible Bluetooth USB dongle, <a href="http://www.ti.com/tool/cc2540emk-usb">the TI CC2540 USB dongle</a>. This can be bought for $49 from the TI website.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb07ae924b970d-pi" target="_blank"><img title="CC_Debugger" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: right; padding-top: 0px; padding-left: 0px; margin: 20px 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="CC_Debugger" src="/assets/image_482306.jpg" width="100" align="right" height="111" /></a>You’ll also need a <a href="http://www.ti.com/tool/cc-debugger">CC Debugger</a> to be able to flash the CC2540 device with the required firmware, which is also available for $49.</p>  <p>These two components are bundled together in a couple of different packages. The first possibility was <a href="http://www.ti.com/tool/cc2541dk-mini">the CC2541 Mini Development Kit</a>, which – for $99 – includes a dongle, a debugger and a “keyfob” device with a few basic components (LEDs, a buzzer, two buttons and an accelerometer).<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d0935534970c-pi" target="_blank"><img title="med_cc2541dk-mini_cc2541dk-mini_web" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="med_cc2541dk-mini_cc2541dk-mini_web" src="/assets/image_820736.jpg" width="350" height="225" /></a></p>  <p>The second, <a href="http://www.ti.com/tool/CC2541DK-RC">the CC2541 Bluetooth Smart Remote Control Kit</a> – for $50 more at $149 – includes a Smart Remote Control which contains a gyroscope, an accelerometer and a many more buttons (it’s a remote control, after all).</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb07ae91f9970d-pi" target="_blank"><img title="med_cc2541dk-rc_cc2541dk-rc_web" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="med_cc2541dk-rc_cc2541dk-rc_web" src="/assets/image_112754.jpg" width="350" height="225" /></a></p>  <h4>Software</h4>  <p>Besides this hardware, there is some software needed to communicate with the SensorTag device.</p>  <p><b>BTool</b> is essentially the driver for the CC2540 dongle: it allows you to map a virtual COM port that will be used for communication between the software and the SensorTag (via the dongle, of course).</p>  <p><b>BLE Device Monitor</b> is the desktop equivalent of the tool we saw earlier for iOS/Android. It allows you to discover and understand the SensorTag’s services, as well as to upgrade the firmware (providing it already has appropriate firmware – for earlier versions you’ll need SmartRF Studio).</p>  <p><b>SmartRF Studio</b> is a tool you can use in conjunction with the CC Debugger to flash or reflash CC254x devices (e.g. the dongle or the SensorTag).</p>  <p>&#160;</p>  <h2>Coding with SensorTag</h2>  <p>The main resource available for developers interested in developing applications based on SensorTag is the SensorTag wiki: <a href="http://ti.com/sensortag-wiki">http://ti.com/sensortag-wiki</a></p>  <p>This lists links to a number of samples – including one to my blog – showing how to connect with SensorTag. As you’d expect, there are a number of mobile-oriented samples and toolkits as well as two main samples of interest to Windows developers.</p>  <h3>SensorTag C# Library</h3>  <p>This library – posted at <a href="http://sensortag.codeplex.com/">http://sensortag.codeplex.com</a> – simplifies the creation of SensorTag apps for the Windows Store. It makes use of APIs available in Windows 8.1, which clearly creates a platform dependency. That said, the APIs are clean and modern, allowing you to use language constructs such as async/await, for instance.</p>  <p>If you’re creating a Windows Store app for Windows 8.1 or higher, this is the way to go.</p>  <h3>BLEHealthDemo</h3>  <p><a href="http://orcs.sebsoft.com/openvision/index.php/8-vision/37-how-to-acquire-data-by-c-from-bluetooth-4-bluetooth-low-energy-ti-ble-keyfob-ti-sensor-tag">This is the project</a> used as a basis for the AutoCAD integration prototype. The app was in development on .NET until Beta 10, but development has apparently since shifted across to Android. The existing codebase is probably 50% complete (according to the developer, and based on their milestones), but has some useful core code, despite the need for significant restructuring.</p>  <p>Here are some snapshots from this app. This first one shows the main page with a lot of UI:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d093553a970c-pi" target="_blank"><img title="BLEHealthDemo sample" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="BLEHealthDemo sample" src="/assets/image_717792.jpg" width="394" height="224" /></a></p>  <p>It’s this tab that shows some of the potential for our purposes: we have a 3D view representing the orientation of the SensorTag device.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb07ae9200970d-pi" target="_blank"><img title="With the 3D view" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="With the 3D view" src="/assets/image_176644.jpg" width="394" height="224" /></a></p>  <h2><font size="3"></font></h2>  <h2>&#160;</h2>  <h2>Integrating SensorTag with AutoCAD</h2>  <p>The main goal of this sample it to manipulate the current AutoCAD view based on spatial input from an external device (in this case we’re using SensorTag). For this simple scenario we’re going to focus on using the accelerometer data.</p>  <p>This gives us greater simplicity and reduced power consumption, as we’re only enabling input from a single sensor. That said, it doesn’t provide the best accuracy: we’ll see later what might be done to improve the situation.</p>  <p>This application can easily just be command-line based: we will interact with AutoCAD via a jig, but there’s no need to provide a GUI. During the jig we’ll poll SensorTag for input, using the data to modify the current 3D view appropriately and then forcing another cycle by pumping a Windows message. This is a similar approach to the one we saw with the AutoCAD sample integrations for Kinect and Leap Motion.</p>  <h3>Understanding 3D input</h3>  <p>An Inertial Measurement Unit (IMU) contains three main components:</p>  <ul>   <li>Accelerometer      <ul>       <li>This measures linear acceleration – including that due to gravity </li>     </ul>   </li>    <li>Gyroscope      <ul>       <li>Measures relative changes in rotational orientation </li>     </ul>   </li>    <li>Magnetometer      <ul>       <li>Measures orientation relative to Earth’s magnetic field </li>     </ul>   </li> </ul>  <p>The best results are obtained via sensor fusion – combining the results of all three sources of input – but clearly is more complex to implement.</p>  <p>Some accelerometers provide higher level roll, pitch and yaw values, but SensorTag’s does not: we have to calculate this for ourselves.</p>  <h3>What we need from the SensorTag</h3>  <p>We’re going to subscribe to two main services from the SensorTag: the accelerometer and the “simple keys service”, which tells us when one or other of the buttons is pressed.</p>  <p>For the accelerometer, we need to set the update frequency to the minimum interval, so we get called 10 times per second with sensor data.</p>  <p>The standard orbit mode – which is active when no buttons are pressed – really only needs X and Y values from the accelerometer: we’re going to ignore the Z value, as adding “yaw” makes the experience a lot less predictable. For the “zoom &amp; pan” mode – active when the left button gets pressed – we’re going to use all three axes. We’re going to estimate the distance travelled along X and Y directions to drive panning of the view and along the Z direction for zooming.</p>  <p>The right button will simply reset the view to the original one: this is helpful as some rotation does creep in, over time.</p>  <h5>Determining the distance travelled</h5>  <p>Our accelerometer provides the <i>acceleration</i> along three axes. To get the <i>distance</i> travelled we need to integrate twice: the first integration provides the <i>velocity</i> at a particular moment which we need to integrate again to get <i>distance</i>.</p>  <p>Thankfully we don’t actually need the data to be particularly accurate: the main thing is to determine the general direction, although some measure of magnitude would be nice. This approach of doubly integrating accelerometer data is <a href="http://physics.stackexchange.com/questions/36312/calculation-of-distance-from-measured-acceleration-vs-time">notoriously inaccurate</a>: small amounts of noise – and issues such as device tilting – can lead to big issues in the data.</p>  <p>We’re going to use a fairly crude but effective integration technique: the <a href="http://people.oregonstate.edu/~haggertr/487/integrate.htm">trapezoidal rule</a>:     <br /></p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c70949ef970b-pi" target="_blank"><img title="Trapezoidal rule" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Trapezoidal rule" src="/assets/image_821510.jpg" width="390" height="217" /></a></p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c7094a67970b-pi" target="_blank"><img title="trapezoidal rule - equation" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; border-left: 0px; display: block; padding-right: 0px" border="0" alt="trapezoidal rule - equation" src="/assets/image_622173.jpg" width="199" height="48" /></a></p>  <p>Given the frequency of our sampling, this will prove accurate results. But if the sensor data is noisy we’ll suffer from GIGO (Garbage In, Garbage Out).</p>  <p>&#160;</p>  <h2>Improvements and Applications</h2>  <p>Accelerometers – while accurate in the longer term as they don’t suffer from drift – can be quite noisy in the short term. It’s not possible to accurately track spatial position over a multi-second period using accelerometer data alone.</p>  <p>Gyroscopes measure relative rotation and so suffer from drift in the longer term (while being accurate in the short term).</p>  <p>For more “serious” applications, some kind of filtering should be applied to the data:</p>  <ul>   <li>Complementary filters      <ul>       <li>The simplest filter type, assigns a higher weighting to the previous data and a smaller weighting to the newly arrived data </li>     </ul>   </li>    <li>Kalman filters      <ul>       <li>These measure state over time, assessing the quality of the newly arrived data relative to the existing set. Clearly more complicated to implement </li>     </ul>   </li>    <li>Mahony &amp; Madgwick filters      <ul>       <li>These more advanced filters take 3-axis data from each of the accelerometer, the gyroscope and the magnetometer to get ultimate positioning accuracy </li>     </ul>   </li> </ul>  <p>.NET implementations are available of the Mahony &amp; Madgwick filters at:</p>  <p><a href="http://www.x-io.co.uk/open-source-imu-and-ahrs-algorithms">http://www.x-io.co.uk/open-source-imu-and-ahrs-algorithms</a></p>  <p>The tricky part will be making sure the various data streams are synchronized in time.</p>  <h3>Moving forwards</h3>  <p>IMUs and spatial data are everywhere: integrated into all modern smartphones, but also in custom chips that are being placed into all kinds of devices. As an example, you can access the ‘deviceorientation’ event in an HTML page on a smartphone to effectively implement a VR application based on Google Cardboard. This event provides handy roll, pitch &amp; yaw values.</p>  <p>It seems as though every day there are new IMU projects being launched: check <a href="http://www.varesano.net/projects/hardware/FreeIMU">FreeIMU</a> or <a href="https://www.kickstarter.com/projects/1265095814/imuduino-wireless-3d-motion-html-js-apps-arduino-p?ref=discovery">IMUduino</a> as examples.</p>  <p>As spatial device input becomes more widespread, the tools to work with it will become easier: filters should be components you can integrate painlessly, for instance.</p>  <p>SensorTag is just one way to get started integrating this kind of input into your apps. It’s worth starting to think about how you might make use of spatial data – or data coming from SensorTag’s other 3 sensors, for that matter. There are definitely interesting use cases for integrating accurate spatial data into a 3D modeling environment.</p>  <p>[Source of some content: <a href="http://through-the-interface.typepad.com/through_the_interface/2013/11/driving-autocad-via-the-accelerometer-in-a-sensortag.html">this previous post</a> &amp; <a href="http://www.olliw.eu/2013/imu-data-fusing">http://www.olliw.eu/2013/imu-data-fusing</a>] </p>
