---
layout: "post"
title: "Creating a face-recognising security cam with a Raspberry Pi &ndash; Part 3"
date: "2012-09-25 19:39:29"
author: "Kean Walmsley"
categories:
  - "Raspberry Pi"
original_url: "https://www.keanw.com/2012/09/creating-a-face-recognising-security-cam-with-a-raspberry-pi-part-3.html "
typepad_basename: "creating-a-face-recognising-security-cam-with-a-raspberry-pi-part-3"
typepad_status: "Publish"
---

<p>In the last <a href="http://through-the-interface.typepad.com/through_the_interface/2012/09/creating-a-face-recognising-security-cam-with-a-raspberry-pi-part-1.html" target="_blank">two</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2012/09/creating-a-face-recognising-security-cam-with-a-raspberry-pi-part-2.html" target="_blank">posts</a> in this series, we introduced the concept and architecture behind the Facecam, and looked at the desktop-based component to build our face recognition database (<em>facedata.xml</em>).</p>  <p>In this post we’ll take a look at the Raspberry Pi-resident face recognition engine. This component is implemented as a daemon (which is basically the Unix/Linux equivalent of a Windows service, for those unfamiliar with the term) that looks in an “input” folder for images to process and populates an “output” folder with the results of the face recognition process.</p>  <p>In the next post in the series, we’ll look at the implementation of a simple daemon to process the text files in this “output” folder, sending the text to an LED message-board.</p>  <p>But back to today’s topic… the first thing we need to do is to install OpenCV on the Raspberry Pi, for which <a href="http://eduardofv.com/read_post/192-OpenCV-on-the-Raspberry-Pi-with-Arch-Linux-ARM" target="_blank">this post</a> proved very helpful.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%"># Install OpenCV and its samples</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">sudo pacman -S python2-numpy opencv opencv-samples</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"># Add the pi user to the video group</span></p>    <p style="margin: 0px"><span style="line-height: 140%"># (good for testing webcam-related samples)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">sudo usermod -a -G video pi</span></p> </div>  <p>At this stage it should be possible for you to browse to and test the OpenCV samples, a step I’m going to skip here.</p>  <p>Next up, we can get the source for the daemon onto the local system and build it. Now at some point I’ll get around to <a href="http://linuxgazette.net/issue83/heriyanto.html" target="_blank">creating a makefile</a> for this, but as it’s only one .cpp file for now I haven’t bothered, although I have put it in a ZIP along with a couple of XML files it depends on.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">sudo pacman -S unzip gcc pkg-config</span></p>    <p style="margin: 0px"><span style="line-height: 140%">cd</span></p>    <p style="margin: 0px"><span style="line-height: 140%">mkdir facerecog</span></p>    <p style="margin: 0px"><span style="line-height: 140%">cd facerecog</span></p>    <p style="margin: 0px"><span style="line-height: 140%">wget &quot;http://through-the-interface.typepad.com/files/FacRecSrc.zip&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">unzip FacRecSrc.zip</span></p>    <p style="margin: 0px"><span style="line-height: 140%">g++ `pkg-config opencv --cflags --libs` FaceRecDaemon.cpp -o facerecd</span></p>    <p style="margin: 0px"><span style="line-height: 140%">sudo cp facerecd /etc/rc.d</span></p> </div>  <p>It should now be possible to run the daemon by launching the facerecd command, but first we need to create our input and output directories:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">cd</span></p>    <p style="margin: 0px"><span style="line-height: 140%">mkdir –p faces/in</span></p>    <p style="margin: 0px"><span style="line-height: 140%">mkdir faces/out</span></p>    <p style="margin: 0px"><span style="line-height: 140%">mkdir faces/debug</span></p>    <p style="margin: 0px"><span style="line-height: 140%">facerecd</span></p> </div>  <p>To avoid having to launch this manually, we can edit the rc.conf file to have it launch on boot:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">sudo nano /etc/rc.conf</span></p> </div>  <p>Then if you scroll down to the last line in the file, you can make sure both motion and facerecd are there:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px">DAEMONS=(!hwclock syslog-ng network openntpd @netfs @crond @sshd @motion facerecd)</p> </div>  <p>You’ll also need to edit the motion.conf file, to hook it up to the face detection component:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">sudo nano /etc/motion/motion.conf</span></p> </div>  <p>You need to make sure motion is saving images, and that they get copied to the “input” folder. These are the settings I changed:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">output normal</span></p>    <p style="margin: 0px"><span style="line-height: 140%"></span></p>    <p style="margin: 0px"><span style="line-height: 140%">jpeg_filename %C-%v-%q</span></p>    <p style="margin: 0px"><span style="line-height: 140%"></span></p>    <p style="margin: 0px"><span style="line-height: 140%">on_picture_save cp %f /home/pi/faces/in</span></p> </div>  <p>This breaks the uploader Python script we introduced <a href="http://through-the-interface.typepad.com/through_the_interface/2012/09/creating-a-motion-detecting-security-cam-with-a-raspberry-pi-part-2.html" target="_blank">way back when</a>, but for now I’m just fine with that (it’ll be a trivial change in the code to strip of the frame number from the JPG filename).</p>  <p>Let’s now take a look at he C++ source for our daemon. To get started with writing the daemon, I took the boilerplate code from <a href="http://www.netzmafia.de/skripten/unix/linux-daemon-howto.html" target="_blank">this article</a>. I then took a big chunk of <a href="http://www.shervinemami.info/faceRecognition.html" target="_blank">Shervin Emami’s original face recognition implementation</a>, but stripped out a lot that wasn’t needed (as we’re only reading from the database and don’t need to train it, for instance).</p>  <p>Most of this was using an earlier version of the OpenCV API (which seems to be standard C functions), but I also ended up including some more recent C++ code – OpenCV thankfully provides helpful functions to interoperate between its C and C++ APIs – but that also means the code is less consistent than I’d have liked. At some point I’d like to come back and rework the C-based implementation to use C++ – I’m currently using a horrible mix of strings and char*, just for starters – but I have to find the time (and right now this is working well enough for my purposes). Part of the issue stems from my decision – right or wrong – to code inside Visual Studio, transfer the .cpp across to the Pi via SFTP and then build locally using gcc. If this loop was streamlined – by cross compiling directly on Windows or OSX, or even by editing the C++ code directly on the Pi – then I might be more inclined to take the time to rework the implementation.</p>  <p>Here’s the C++ code from <em>FaceRecDaemon.cpp</em>:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;sys/types.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;sys/stat.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;stdio.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;stdlib.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;fcntl.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;errno.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;unistd.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;dirent.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;string.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;string&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;vector&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;iostream&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;fstream&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;algorithm&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&lt;syslog.h&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;cv.h&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;cvaux.h&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;highgui.h&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#include</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #a31515">&quot;opencv2/opencv.hpp&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#ifndef</span><span style="line-height: 140%"> BOOL</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">#define</span><span style="line-height: 140%"> BOOL </span><span style="line-height: 140%; color: blue">bool</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#endif</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> std;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> cv;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Input and output folder locations</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> * inDir = </span><span style="line-height: 140%; color: #a31515">&quot;/home/pi/faces/in&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> * outDir = </span><span style="line-height: 140%; color: #a31515">&quot;/home/pi/faces/out&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> * debugDir = </span><span style="line-height: 140%; color: #a31515">&quot;/home/pi/faces/debug&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Haar Cascade file, used for Face Detection</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *faceCascadeFilename =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #a31515">&quot;/home/pi/facerecog/haarcascade_frontalface_alt.xml&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *lblCascadeFilename =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #a31515">&quot;/home/pi/facerecog/lbpcascade_frontalface.xml&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *faceDataXml = </span><span style="line-height: 140%; color: #a31515">&quot;/home/pi/facerecog/facedata.xml&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Set to 0 if you dont want images of the Eigenvectors</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// saved to files (for debugging)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> SAVE_EIGENFACE_IMAGES = 1;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// You might get better recognition accuracy if you enable this</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">//#define USE_MAHALANOBIS_DISTANCE</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Global variables</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">IplImage ** faceImgArr&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0; </span><span style="line-height: 140%; color: green">// array of face images</span></p>    <p style="margin: 0px"><span style="line-height: 140%">CvMat&#160;&#160;&#160; *&#160; personNumTruthMat = 0; </span><span style="line-height: 140%; color: green">// array of person numbers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Array of person names (indexed by the person number)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">vector&lt;string&gt; personNames;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Default dimensions for faces in the face recognition database</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> faceWidth = 120;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> faceHeight = 90;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// The number of people in the training set</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> nPersons&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// The number of training images</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> nTrainFaces&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// The number of eigenvalues</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> nEigens&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// The average image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">IplImage * pAvgTrainImg&#160;&#160;&#160;&#160;&#160;&#160; = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Eigenvectors</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">IplImage ** eigenVectArr&#160;&#160;&#160;&#160;&#160; = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Eigenvalues</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">CvMat * eigenValMat&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Projected training faces</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">CvMat * projectedTrainFaceMat = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">CvMemStorage* storage&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> IplImage * small_img&#160;&#160; = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%"> scale = 3;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">CascadeClassifier faceCascade;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#define</span><span style="line-height: 140%"> PAD_FACE 40</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#define</span><span style="line-height: 140%"> PAD_FACE_2 80</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Function prototypes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> getdir(string dir, vector&lt;string&gt; &amp;files);</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">&#160; loadTrainingData(CvMat ** pTrainPersonNumMat);</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">&#160; findNearestNeighbor(</span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> * projectedTestFace);</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> findNearestNeighbor(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> * projectedTestFace, </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> *pConfidence</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> recognizeFromFile(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *inputFile,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *outputFile,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvHaarClassifierCascade *cascade,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> * projectedTestFace,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvMat *trainPersonNumMat</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">IplImage* resizeImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> IplImage *origImg, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> newWidth, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> newHeight</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">CvRect cropRect(</span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> CvRect rect, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> w, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> h);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">IplImage* cropImage(</span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> IplImage *img, </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> CvRect region);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">CvRect detectFaceInImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; IplImage* img, CascadeClassifier &amp;cascade</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> execute();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Get the list of files in a directory</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> getdir(string dir, vector&lt;string&gt; &amp;files)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; DIR *dp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">struct</span><span style="line-height: 140%"> dirent *dirp;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">((dp = opendir(dir.c_str())) == NULL)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> msg[200];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; snprintf(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; msg, </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">sizeof</span><span style="line-height: 140%">(msg)-1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Error(%d) opening %s&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; errno,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; dir.c_str()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(LOG_INFO, msg);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> errno;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> ((dirp = readdir(dp)) != NULL)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; files.push_back(string(dirp-&gt;d_name));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; closedir(dp);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; sort(files.begin(), files.end());</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Open the training data from the file 'facedata.xml'</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> loadTrainingData(CvMat ** pTrainPersonNumMat)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Create a file-storage interface</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvFileStorage* fileStorage =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvOpenFileStorage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; faceDataXml, 0, CV_STORAGE_READ</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!fileStorage)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(LOG_INFO, </span><span style="line-height: 140%; color: #a31515">&quot;Unable to open training database.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Load the names</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; personNames.clear();&#160; </span><span style="line-height: 140%; color: green">// Make sure it starts as empty</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; nPersons = cvReadIntByName(fileStorage, 0, </span><span style="line-height: 140%; color: #a31515">&quot;nPersons&quot;</span><span style="line-height: 140%">, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (nPersons == 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(LOG_INFO, </span><span style="line-height: 140%; color: #a31515">&quot;No people found in training database.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Load each person's name</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i=0; i &lt; nPersons; i++) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; string sPersonName;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> varname[200];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; snprintf(varname, </span><span style="line-height: 140%; color: blue">sizeof</span><span style="line-height: 140%">(varname)-1, </span><span style="line-height: 140%; color: #a31515">&quot;personName_%d&quot;</span><span style="line-height: 140%">, (i+1));</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; sPersonName = cvReadStringByName(fileStorage, 0, varname);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; personNames.push_back(sPersonName);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Load the data</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; nEigens = cvReadIntByName(fileStorage, 0, </span><span style="line-height: 140%; color: #a31515">&quot;nEigens&quot;</span><span style="line-height: 140%">, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; nTrainFaces = cvReadIntByName(fileStorage, 0, </span><span style="line-height: 140%; color: #a31515">&quot;nTrainFaces&quot;</span><span style="line-height: 140%">, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; *pTrainPersonNumMat =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (CvMat*)cvReadByName(fileStorage, 0, </span><span style="line-height: 140%; color: #a31515">&quot;trainPersonNumMat&quot;</span><span style="line-height: 140%">, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; eigenValMat =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (CvMat*)cvReadByName(fileStorage, 0, </span><span style="line-height: 140%; color: #a31515">&quot;eigenValMat&quot;</span><span style="line-height: 140%">, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; projectedTrainFaceMat =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (CvMat*)cvReadByName(fileStorage, 0, </span><span style="line-height: 140%; color: #a31515">&quot;projectedTrainFaceMat&quot;</span><span style="line-height: 140%">, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pAvgTrainImg =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (IplImage*)cvReadByName(fileStorage, 0, </span><span style="line-height: 140%; color: #a31515">&quot;avgTrainImg&quot;</span><span style="line-height: 140%">, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; eigenVectArr =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (IplImage**)cvAlloc(nTrainFaces*</span><span style="line-height: 140%; color: blue">sizeof</span><span style="line-height: 140%">(IplImage *));</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i=0; i &lt; nEigens; i++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> varname[200];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; snprintf(varname, </span><span style="line-height: 140%; color: blue">sizeof</span><span style="line-height: 140%">(varname)-1, </span><span style="line-height: 140%; color: #a31515">&quot;eigenVect_%d&quot;</span><span style="line-height: 140%">, i);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; eigenVectArr[i] =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (IplImage *)cvReadByName(fileStorage, 0, varname, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// release the file-storage interface</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvReleaseFileStorage(&amp;fileStorage);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; syslog(LOG_INFO, </span><span style="line-height: 140%; color: #a31515">&quot;Face recognition database loaded.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> 1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Find the most likely person based on a detection.</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Returns the index, and stores the confidence value</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// into pConfidence.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> findNearestNeighbor(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> * projectedTestFace, </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> *pConfidence</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%"> leastDistSq = DBL_MAX;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> iNearest = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> iTrain=0; iTrain &lt; nTrainFaces; iTrain++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%"> distSq = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i=0; i &lt; nEigens; i++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> d_i =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; projectedTestFace[i] -</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; projectedTrainFaceMat-&gt;data.fl[iTrain * nEigens + i];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#ifdef</span><span style="line-height: 140%"> USE_MAHALANOBIS_DISTANCE</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Mahalanobis distance (might give better results</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// than Eucalidean distance)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; distSq += d_i*d_i / eigenValMat-&gt;data.fl[i]; </span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Euclidean distance</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; distSq += d_i*d_i;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">#endif</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (distSq &lt; leastDistSq)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; leastDistSq = distSq;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; iNearest = iTrain;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Return the confidence level based on the Euclidean distance,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// so that similar images should give a confidence between</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// 0.5 to 1.0, and very different images should give a</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// confidence between 0.0 to 0.5</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; *pConfidence =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; 1.0f -</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; sqrt(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; leastDistSq / (</span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%">)(nTrainFaces * nEigens)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ) / 255.0f;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Return the found index</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> iNearest;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Make sure the given rectangle is completely within the given</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// image dimensions</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Creates a new image copy that is of a desired size</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">IplImage* resizeImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> IplImage *origImg, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> newWidth, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> newHeight</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> origWidth = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> origHeight = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (origImg != NULL)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; origWidth = origImg-&gt;width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; origHeight = origImg-&gt;height;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; origImg == NULL ||</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; newWidth &lt;= 0 || newHeight &lt;= 0 ||</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; origWidth &lt;= 0 || origHeight &lt;= 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; LOG_INFO, </span><span style="line-height: 140%; color: #a31515">&quot;ERROR in resizeImage: Bad desired image size.&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Scale the image to the new dimensions, even if the aspect</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// ratio will be changed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; IplImage *outImg =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvCreateImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; cvSize(newWidth, newHeight),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; origImg-&gt;depth,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; origImg-&gt;nChannels</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (newWidth &gt; origImg-&gt;width &amp;&amp; newHeight &gt; origImg-&gt;height)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Make the image larger</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvResetImageROI((IplImage*)origImg);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// CV_INTER_CUBIC or CV_INTER_LINEAR is good for enlarging</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvResize(origImg, outImg, CV_INTER_LINEAR);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Make the image smaller</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvResetImageROI((IplImage*)origImg);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// CV_INTER_AREA is good for shrinking/decimation,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// but bad at enlarging</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvResize(origImg, outImg, CV_INTER_AREA);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> outImg;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">CvRect cropRect(</span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> CvRect rectIn, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> w, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> h)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvRect roi = CvRect(rectIn);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Make sure the displayed image is within the viewing dimensions</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Limit the bottom-right from past the image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.x + roi.width &gt; w)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.width = w - roi.x;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.y + roi.height &gt; h)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.height = h - roi.y;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Limit the top-left from before the image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.x &lt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.x = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.y &lt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.y = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Limit the top-left from after the image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.x &gt; w-1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.x = w-1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.y &gt; h-1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.y = h-1;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Limit the negative sizes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.width &lt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.width = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.height &lt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.height = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Limit the large sizes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.width &gt; w)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.width = w - roi.x;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (roi.height &gt; h)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; roi.height = h - roi.y;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> roi;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Returns a new image, a cropped version of the original</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">IplImage* cropImage(</span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> IplImage *img, </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> CvRect region)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvSize size;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; size.height = img-&gt;height;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; size.width = img-&gt;width;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (img-&gt;depth != IPL_DEPTH_8U)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; LOG_INFO,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ERROR in cropImage: unknown image depth given in cropImage().&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// First create a new (color or greyscale) IPL Image and copy</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// contents of img into it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; IplImage *imageTmp =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvCreateImage(size, IPL_DEPTH_8U, img-&gt;nChannels);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvCopy(img, imageTmp, NULL);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Create a new image of the detected region</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Set region of interest to that surrounding the face</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvRect checked = cropRect(region, img-&gt;width, img-&gt;height);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvSetImageROI(imageTmp, checked);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Copy region of interest (i.e. face) into a new iplImage</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// (imageRGB) and return it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; size.width = checked.width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; size.height = checked.height;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; IplImage *imageRGB =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvCreateImage(size, IPL_DEPTH_8U, img-&gt;nChannels);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvCopy(imageTmp, imageRGB, NULL);&#160; </span><span style="line-height: 140%; color: green">// Copy just the region.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvReleaseImage(&amp;imageTmp);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> imageRGB;&#160;&#160;&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Perform face detection on the input image, using the given Haar</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// cascade classifier. Assumes greyscale for input images.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Returns a rectangle for the detected region in the given image.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">CvRect detectFaceInImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; IplImage* img, CascadeClassifier &amp;cascade</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvRect found_face;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!small_img)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; small_img =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; cvCreateImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; cvSize(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cvRound(img-&gt;width / scale),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cvRound(img-&gt;height / scale)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 8, 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvResize(img, small_img, CV_INTER_LINEAR);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvEqualizeHist(small_img, small_img);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Mat imgMat(small_img);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Detect objects in the small grayscale image.</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; vector&lt;Rect&gt; objects;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cascade.detectMultiScale(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; imgMat,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; objects,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; 1.1f,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; 2,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; CASCADE_FIND_BIGGEST_OBJECT,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Size(20, 20)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (objects.size() &gt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Found at least one face</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Rect r = (Rect)objects.at(0);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; found_face.x = (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)((</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)r.x * scale);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; found_face.y = (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)((</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)r.y * scale);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; found_face.width = (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)((</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)r.width * scale);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; found_face.height = (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)((</span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%">)r.height * scale);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Couldn't find the face</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; found_face = cvRect(-1,-1,-1,-1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> found_face;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">string convert(</span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> string&amp; line)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{ </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> len = line.length();&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; string nLine = </span><span style="line-height: 140%; color: #a31515">&quot;&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (len)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; nLine += line[0];&#160; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i = 1; i &lt; len; ++i)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (isupper(line[i]))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; nLine += </span><span style="line-height: 140%; color: #a31515">' '</span><span style="line-height: 140%">;&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; nLine += line[i];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> nLine;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">} </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Recognize the person in the supplied image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> recognizeFromFile(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *inputFile,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *outputFile,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *debugFile,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvHaarClassifierCascade *cascade,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> * projectedTestFace,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvMat *trainPersonNumMat</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">//syslog(LOG_INFO, &quot;recognizeFromFile begins&quot;);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Load the image directly as greyscale</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; IplImage *checkImg =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvLoadImage(inputFile, CV_LOAD_IMAGE_GRAYSCALE);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!checkImg)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> msg[200];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; snprintf(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; msg,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">sizeof</span><span style="line-height: 140%">(msg)-1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ERROR in recognizeFromFile(): Bad input image file: %s&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; inputFile</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(LOG_INFO, msg);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// We'll try to detect the face using LBP</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvRect faceRect = detectFaceInImage(checkImg, faceCascade);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Make sure a valid face was detected</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (faceRect.width &gt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the detected face image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; IplImage *faceImg = cropImage(checkImg, faceRect);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Make sure the image is the same dimensions as the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// training images</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; IplImage *sizedImg =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; resizeImage(faceImg, faceWidth, faceHeight);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Give the image a standard brightness and contrast,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// in case it was too dark or low contrast</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create an empty greyscale image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; IplImage *equalizedImg =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; cvCreateImage(cvGetSize(sizedImg), 8, 1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvEqualizeHist(sizedImg, equalizedImg);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!equalizedImg)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; syslog(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; LOG_INFO,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ERROR in recognizeFromFile(): no input image.&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; exit(1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> imageFile[200];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; strcpy(imageFile, debugFile);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *dot = strrchr(imageFile, </span><span style="line-height: 140%; color: #a31515">'.'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; *dot = 0;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvSaveImage(imageFile, equalizedImg);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the face rec database has been loaded, then try to</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// recognize the person currently detected</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (nEigens &gt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Project the test image onto the PCA subspace</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; cvEigenDecomposite(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; equalizedImg,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; nEigens,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; eigenVectArr,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0, 0,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pAvgTrainImg,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; projectedTestFace</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Check which person it is most likely to be</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> confidence;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> iNearest =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; findNearestNeighbor(projectedTestFace, &amp;confidence);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> nearest = trainPersonNumMat-&gt;data.i[iNearest];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Write results to the output file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> msg[200];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; snprintf(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; msg,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">sizeof</span><span style="line-height: 140%">(msg)-1,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Recognised %s with a confidence of %f&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (nearest &gt; 0 ? personNames[nearest-1].c_str() : </span><span style="line-height: 140%; color: #a31515">&quot;nobody&quot;</span><span style="line-height: 140%">),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; confidence</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; syslog(LOG_INFO, msg);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; string message =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (nearest &gt; 0 ?</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; convert(personNames[nearest-1]) :</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Unrecognized&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; std::ofstream o1(outputFile);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; o1 &lt;&lt; message.c_str() &lt;&lt; std::endl;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; std::ofstream o2(debugFile);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; o2 &lt;&lt; message.c_str() &lt;&lt; std::endl;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Free the resources used for this frame</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvReleaseImage(&amp;faceImg);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvReleaseImage(&amp;sizedImg);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvReleaseImage(&amp;equalizedImg);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvReleaseImage(&amp;checkImg);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> main(</span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Our process ID and Session ID</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pid_t pid, sid;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Fork off the parent process</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pid = fork();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pid &lt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(EXIT_FAILURE);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// If we got a good PID, then we can exit the parent process</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pid &gt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(EXIT_SUCCESS);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Change the file mode mask</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; umask(0);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Open any logs here</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; openlog(</span><span style="line-height: 140%; color: #a31515">&quot;facerecd&quot;</span><span style="line-height: 140%">, LOG_PID|LOG_CONS, LOG_USER);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Create a new SID for the child process</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; sid = setsid();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (sid &lt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Log the failure</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(LOG_INFO, </span><span style="line-height: 140%; color: #a31515">&quot;Unable to get SID.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(EXIT_FAILURE);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Change the current working directory</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (chdir(</span><span style="line-height: 140%; color: #a31515">&quot;/&quot;</span><span style="line-height: 140%">) &lt; 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Log the failure</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(LOG_INFO, </span><span style="line-height: 140%; color: #a31515">&quot;Unable to change working directory.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(EXIT_FAILURE);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Close out the standard file descriptors</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; close(STDIN_FILENO);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; close(STDOUT_FILENO);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; close(STDERR_FILENO);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Daemon-specific initialization goes here</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">struct</span><span style="line-height: 140%"> stat st = {0};</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (stat(inDir, &amp;st) == -1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; mkdir(inDir, 0700);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (stat(outDir, &amp;st) == -1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; mkdir(outDir, 0700);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (stat(debugDir, &amp;st) == -1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; mkdir(debugDir, 0700);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; execute();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; exit(EXIT_SUCCESS);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> execute()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Load the previously saved training data</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvMat *trainPersonNumMat = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (loadTrainingData(&amp;trainPersonNumMat))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; faceWidth = pAvgTrainImg-&gt;width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; faceHeight = pAvgTrainImg-&gt;height;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Project the test images onto the PCA subspace</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> *projectedTestFace =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%"> *)cvAlloc(nEigens*</span><span style="line-height: 140%; color: blue">sizeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: blue">float</span><span style="line-height: 140%">));</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Load the HaarCascade classifier for face detection</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; faceCascade.load(lblCascadeFilename);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (faceCascade.empty())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; LOG_INFO,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ERROR in main loop: Could not load face detection classifier.&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CvHaarClassifierCascade* cascade =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (CvHaarClassifierCascade*)cvLoad(faceCascadeFilename, 0, 0, 0);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!cascade)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; syslog(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; LOG_INFO,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ERROR in main loop: Could not load face detection classifier.&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; exit(1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; vector&lt;string&gt; files = vector&lt;string&gt;();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">const</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *contents = NULL;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">/* The Big Loop */</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">while</span><span style="line-height: 140%"> (1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the files in our &quot;in&quot; directory</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; files.clear();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; getdir(inDir, files);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> ((</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)files.size() &gt;= 3)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; contents = files[2].c_str();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; contents = NULL;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (contents != NULL)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> input[256];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; input[0] = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(input, inDir);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(input, </span><span style="line-height: 140%; color: #a31515">&quot;/&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(input, contents);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> *last = strrchr(input, </span><span style="line-height: 140%; color: #a31515">'/'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> output[256];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; output[0] = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(output, outDir);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(output, </span><span style="line-height: 140%; color: #a31515">&quot;/&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(output, last + 1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(output, </span><span style="line-height: 140%; color: #a31515">&quot;.txt&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">char</span><span style="line-height: 140%"> debug[256];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; debug[0] = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(debug, debugDir);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(debug, </span><span style="line-height: 140%; color: #a31515">&quot;/&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(debug, last + 1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; strcat(debug, </span><span style="line-height: 140%; color: #a31515">&quot;.txt&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; recognizeFromFile(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; input,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; output,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; debug,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cascade,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; projectedTestFace,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; trainPersonNumMat</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; remove(input);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; sleep(0.5); </span><span style="line-height: 140%; color: green">/* wait half a second */</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvReleaseHaarClassifierCascade(&amp;cascade);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (storage)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvReleaseMemStorage(&amp;storage);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (cascade)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; cvReleaseHaarClassifierCascade(&amp;cascade);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; cvReleaseImage(&amp;small_img);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; closelog();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>The daemon’s job is to scan the incoming images – saved by the motion detection component and copied into the “input” folder – and find the largest contained face, should one exist. Any detected faces get extracted (and a copy gets saved to our “debug” folder, just so we can see how it’s working) and checked against the face recognition database (once again using the <a href="http://en.wikipedia.org/wiki/Eigenface" target="_blank">Eigenface</a> algorithm). The results get stored to a text file in the “output” folder, to be displayed on the LED message-board.</p>  <p>The most time-consuming part of this process – by at least an order of magnitude – is the initial face detection. I originally made use of <a href="http://en.wikipedia.org/wiki/Haar-like_features" target="_blank">Haar-like</a> face detection, but even with some optimisations I borrowed from <a href="http://www.morethantechnical.com/2009/08/09/near-realtime-face-detection-on-the-iphone-w-opencv-port-wcodevideo" target="_blank">an iOS-based OpenCV implementation</a>, I still found it far too slow on the Raspberry Pi (I as looking for &lt;1s results and was finding anything from 5s to 90s, depending on the settings). There’s a lot that can be tweaked to control this – such as increasing the minimum size of the object to be detected – but despite various attempts, it still remained too slow.</p>  <p>At Shervin’s suggestion – he even kindly shared some implementation details from his upcoming book, <a href="http://www.packtpub.com/opencv-2-hotshot/book" target="_blank">OpenCV 2 Hotshot: RAW</a> – I ended up making use of <a href="http://en.wikipedia.org/wiki/Local_binary_patterns" target="_blank">LBP</a> face detection, instead. This is apparently only available in the C++ API – hence the mixing of the C and C++ in today’s implementation – and the good news is that it certainly brought the cost of the detection down within acceptable limits.</p>  <p>The bad news is that it generates lots of false positives, which means portions of the image often end up getting detected as faces and the Eigenface algorithm often seems to recognise these faces in the database with a depressingly high confidence level.</p>  <p>I’m sure there’s lots that can be done to improve the quality of the face detection, such as using a mask image. Here’s a thought… if Motion was able to save the information from its “locate” feature to be picked up by the facerecd, that would be even better: we’d only have to search the area of motion in the image.</p>  <p>Philipp Wagner <a href="http://through-the-interface.typepad.com/through_the_interface/2012/09/creating-a-face-recognising-security-cam-with-a-raspberry-pi-part-1.html#comment-6a00d83452464869e2017c31d18f37970b" target="_blank">kindly suggested</a> adopting the approach shown in <a href="http://docs.opencv.org/trunk/modules/contrib/doc/facerec/tutorial/facerec_video_recognition.html" target="_blank">this tutorial</a>, which may well help with performance and/or accuracy. I haven’t yet taken a very close look, as integrating this approach would probably lead to quite fundamental changes in the implementation (and I’ve just got too much else going on, at the moment).</p>  <p>Even though the accuracy leaves a lot to be desired, the results are often very entertaining, but we’ll see more about that, next time. And every so often lightning strikes and the correct person is flagged.</p>
