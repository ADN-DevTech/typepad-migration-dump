---
layout: "post"
title: "Running custom .NET code in the cloud using AutoCAD I/O &ndash; Part 4"
date: "2015-06-17 16:27:03"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD I/O"
  - "JSON"
  - "REST"
original_url: "https://www.keanw.com/2015/06/running-custom-net-code-in-the-cloud-using-autocad-io-part-4.html "
typepad_basename: "running-custom-net-code-in-the-cloud-using-autocad-io-part-4"
typepad_status: "Publish"
---

<p>Now that we’ve <a href="http://through-the-interface.typepad.com/through_the_interface/2015/06/running-custom-net-code-in-the-cloud-using-autocad-io-part-3.html" target="_blank">introduced how the CRX will be loaded by AutoCAD I/O</a> – via an Autoloader bundle – we’re going to take a look at the code needed to create and test our Activity using it.</p>  <p>As a starting point – and as mentioned last time – you should get hold of the code in <a href="https://github.com/Developer-Autodesk/workflow-custom-activity-with-apppackage-autocad.io" target="_blank">this sample on GitHub</a> and copy &amp; paste the (C# &amp; XML) code we’ve seen in the last two posts into their respective files.</p>  <p>The code we’re going to see in today’s post belongs in <em>Client\Program.cs</em>. We’re very much tailoring the existing implementation, making sure it works specifically with our project. You’ll notice from the code that I’ve also made some changes to the name of the <em>CrxApp</em> project – you’ll want to do the same, for your own.</p>  <p>This project is basically intended to administer your Activity and the AppPackage it depends upon. It has a service reference to the AutoCAD I/O REST API, accessible via the AIO namespace. The code embeds the ConsumerKey and ConsumerSecret – that you can get in a few clicks via our <a href="http://developer.autodesk.com" target="_blank">developer portal</a> – which is really ill-advised for a client-side application. You should only ever embed this information in a server-side application (which we’ll see in the next post in this series), but as this is strictly admin-only – and not being distributed to customers – it’s OK.</p>  <p>As part of the tool’s upload process, we’re also going to create a WorkItem with some dummy parameters (we’re specifying a size of 20x15 and about 100 pieces for our puzzle, we’re not providing any engraving layer) to exercise the Activity and make sure it works.</p>  <p>Here’s the C# code:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Newtonsoft.Json;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.IO;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.IO.Compression;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Linq;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Net.Http;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> Client</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160; <span style="color: blue">class</span> <span style="color: #2b91af">Credentials</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Get your ConsumerKey/ConsumerSecret at http://developer.autodesk.com</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">string</span> ConsumerKey = <span style="color: #a31515">&quot;th15Isn0tAk3y&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">string</span> ConsumerSecret = <span style="color: #a31515">&quot;n0rI5th15aS3cr3t&quot;</span>;</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">&#160; <span style="color: blue">class</span> <span style="color: #2b91af">Program</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">readonly</span> <span style="color: blue">string</span> PackageName = <span style="color: #a31515">&quot;JigsawPackage&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">readonly</span> <span style="color: blue">string</span> ActivityName = <span style="color: #a31515">&quot;JigsawActivity&quot;</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> AIO.<span style="color: #2b91af">Container</span> container;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">void</span> Main(<span style="color: blue">string</span>[] args)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Instruct client side library to insert token as Authorization value</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// into each request</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Container</span>(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">Uri</span>(<span style="color: #a31515">&quot;https://developer.api.autodesk.com/autocad.io/v1/&quot;</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> token = GetToken();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.SendingRequest2 +=</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (sender, e) =&gt; e.RequestMessage.SetHeader(<span style="color: #a31515">&quot;Authorization&quot;</span>, token);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Check if our app package exists</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> package =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.AppPackages.Where(a =&gt; a.Id == PackageName).FirstOrDefault();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> res = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (package != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; res =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Prompts</span>.PromptForKeyword(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span>.Format(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;AppPackage '{0}' already exists. What do you want to do? &quot;</span> +</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;[Delete/Recreate/Update/Leave]&lt;Update&gt;&quot;</span>, PackageName</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (res == <span style="color: #a31515">&quot;Delete&quot;</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.DeleteObject(package);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.SaveChanges();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; package = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> activity2 =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.Activities.Where(a =&gt; a.Id == ActivityName).FirstOrDefault();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (activity2 != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.DeleteObject(activity2);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.SaveChanges();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; activity2 = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (res == <span style="color: #a31515">&quot;Recreate&quot;</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.DeleteObject(package);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.SaveChanges();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; package = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (res != <span style="color: #a31515">&quot;Leave&quot;</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; package = CreateOrUpdatePackage(CreateZip(), package);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Check if our activity already exist</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> activity =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.Activities.Where(a =&gt; a.Id == ActivityName).FirstOrDefault();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (activity != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Prompts</span>.PromptForKeyword(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span>.Format(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;Activity '{0}' already exists. Do you want to recreate it? &quot;</span> +</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;[Yes/No]&lt;No&gt;&quot;</span>, ActivityName</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ) == <span style="color: #a31515">&quot;Yes&quot;</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.DeleteObject(activity);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.SaveChanges();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; activity = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (activity == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; activity = CreateActivity(package);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Save outstanding changes if any</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.SaveChanges(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Data.Services.Client.<span style="color: #2b91af">SaveChangesOptions</span>.PatchOnUpdate</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Finally submit workitem against our activity</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; SubmitWorkItem(activity);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">string</span> GetToken()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Getting authorization token...&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (<span style="color: blue">var</span> client = <span style="color: blue">new</span> <span style="color: #2b91af">HttpClient</span>())</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> values = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">KeyValuePair</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;&gt;();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; values.Add(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">KeyValuePair</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;client_id&quot;</span>, <span style="color: #2b91af">Credentials</span>.ConsumerKey</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; values.Add(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">KeyValuePair</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;client_secret&quot;</span>, <span style="color: #2b91af">Credentials</span>.ConsumerSecret</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; values.Add(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">KeyValuePair</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;(<span style="color: #a31515">&quot;grant_type&quot;</span>, <span style="color: #a31515">&quot;client_credentials&quot;</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> requestContent = <span style="color: blue">new</span> <span style="color: #2b91af">FormUrlEncodedContent</span>(values);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> response =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; client.PostAsync(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;https://developer.api.autodesk.com/authentication/v1/authenticate&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; requestContent</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ).Result;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> responseContent = response.Content.ReadAsStringAsync().Result;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> resValues =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">JsonConvert</span>.DeserializeObject&lt;<span style="color: #2b91af">Dictionary</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;&gt;(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; responseContent</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> resValues[<span style="color: #a31515">&quot;token_type&quot;</span>] + <span style="color: #a31515">&quot; &quot;</span> + resValues[<span style="color: #a31515">&quot;access_token&quot;</span>];</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">string</span> CreateZip()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Generating autoloader zip...&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> zip = <span style="color: #a31515">&quot;package.zip&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: #2b91af">File</span>.Exists(zip))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">File</span>.Delete(zip);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (<span style="color: blue">var</span> archive = <span style="color: #2b91af">ZipFile</span>.Open(zip, <span style="color: #2b91af">ZipArchiveMode</span>.Create))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> bundle = PackageName + <span style="color: #a31515">&quot;.bundle&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> name = <span style="color: #a31515">&quot;PackageContents.xml&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; archive.CreateEntryFromFile(name, <span style="color: #2b91af">Path</span>.Combine(bundle, name));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; name = <span style="color: #a31515">&quot;Jigsaw.dll&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; archive.CreateEntryFromFile(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; name, <span style="color: #2b91af">Path</span>.Combine(bundle, <span style="color: #a31515">&quot;Contents&quot;</span>, name)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; name = <span style="color: #a31515">&quot;Newtonsoft.Json.dll&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; archive.CreateEntryFromFile(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; name, <span style="color: #2b91af">Path</span>.Combine(bundle, <span style="color: #a31515">&quot;Contents&quot;</span>, name)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> zip;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> AIO.<span style="color: #2b91af">AppPackage</span> CreateOrUpdatePackage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> zip, AIO.<span style="color: #2b91af">AppPackage</span> package</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Creating/Updating AppPackage...&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// First step -- query for the url to upload the AppPackage file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">UriBuilder</span> builder = <span style="color: blue">new</span> <span style="color: #2b91af">UriBuilder</span>(container.BaseUri);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; builder.Path += <span style="color: #a31515">&quot;AppPackages/GenerateUploadUrl&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> url =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.Execute&lt;<span style="color: blue">string</span>&gt;(builder.Uri, <span style="color: #a31515">&quot;POST&quot;</span>, <span style="color: blue">true</span>, <span style="color: blue">null</span>).First();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Second step -- upload AppPackage file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; UploadObject(url, zip);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (package == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Third step -- after upload, create the AppPackage entity</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; package = <span style="color: blue">new</span> AIO.<span style="color: #2b91af">AppPackage</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; UserId = <span style="color: #a31515">&quot;&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Id = PackageName,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Version = 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RequiredEngineVersion = <span style="color: #a31515">&quot;20.0&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Resource = url</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.AddToAppPackages(package);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//Or update the existing one with the new url</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; package.Resource = url;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.UpdateObject(package);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.SaveChanges(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Data.Services.Client.<span style="color: #2b91af">SaveChangesOptions</span>.PatchOnUpdate</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> package;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">void</span> UploadObject(<span style="color: blue">string</span> url, <span style="color: blue">string</span> filePath)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Uploading autoloader zip...&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> client = <span style="color: blue">new</span> <span style="color: #2b91af">HttpClient</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; client.PutAsync(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; url,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">StreamContent</span>(<span style="color: #2b91af">File</span>.OpenRead(filePath))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ).Result.EnsureSuccessStatusCode();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Creates an activity with 2 inputs and variable number of outputs.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// All outputs are placed in a folder 'outputs'</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> AIO.<span style="color: #2b91af">Activity</span> CreateActivity(AIO.<span style="color: #2b91af">AppPackage</span> package)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Creating/Updating Activity...&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> activity = <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Activity</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; UserId = <span style="color: #a31515">&quot;&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Id = ActivityName,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Version = 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Instruction = <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Instruction</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Script = <span style="color: #a31515">&quot;_erase _all&#160; _jigio params.json outputs\n&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Parameters = <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Parameters</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; InputParameters =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Parameter</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Name = <span style="color: #a31515">&quot;HostDwg&quot;</span>, LocalFileName = <span style="color: #a31515">&quot;$(HostDwg)&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Parameter</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Name = <span style="color: #a31515">&quot;Params&quot;</span>, LocalFileName = <span style="color: #a31515">&quot;params.json&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; OutputParameters = {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Parameter</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Name = <span style="color: #a31515">&quot;Results&quot;</span>, LocalFileName = <span style="color: #a31515">&quot;outputs&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; RequiredEngineVersion = <span style="color: #a31515">&quot;20.0&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.AddToActivities(activity);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.SaveChanges(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Data.Services.Client.<span style="color: #2b91af">SaveChangesOptions</span>.PatchOnUpdate</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Establish link to package</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.AddLink(activity, <span style="color: #a31515">&quot;AppPackages&quot;</span>, package);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.SaveChanges();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> activity;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">void</span> SubmitWorkItem(AIO.<span style="color: #2b91af">Activity</span> activity)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Submitting workitem...&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Create a workitem</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> wi = <span style="color: blue">new</span> AIO.<span style="color: #2b91af">WorkItem</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; UserId = <span style="color: #a31515">&quot;&quot;</span>, <span style="color: green">// Must be set to empty</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Id = <span style="color: #a31515">&quot;&quot;</span>, <span style="color: green">// Must be set to empty</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Arguments = <span style="color: blue">new</span> AIO.<span style="color: #2b91af">Arguments</span>(),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Version = 1, <span style="color: green">// Should always be 1</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ActivityId =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> AIO.<span style="color: #2b91af">EntityId</span> { Id = activity.Id, UserId = activity.UserId }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; wi.Arguments.InputArguments.Add(<span style="color: blue">new</span> AIO.<span style="color: #2b91af">Argument</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Name = <span style="color: #a31515">&quot;HostDwg&quot;</span>, <span style="color: green">// Must match the input parameter in activity</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Resource =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;http://download.autodesk.com/us/samplefiles/acad/title_block-iso.dwg&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; StorageProvider = <span style="color: #a31515">&quot;Generic&quot;</span> <span style="color: green">// Generic HTTP download (vs A360)</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; });</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; wi.Arguments.InputArguments.Add(<span style="color: blue">new</span> AIO.<span style="color: #2b91af">Argument</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Name = <span style="color: #a31515">&quot;Params&quot;</span>, <span style="color: green">// Must match the input parameter in activity</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Use data URL to send json parameters without having to upload</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// them to storage</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ResourceKind = <span style="color: #a31515">&quot;Embedded&quot;</span>, </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Resource =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">@&quot;data:application/json, &quot;</span> +</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">JsonConvert</span>.SerializeObject(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> JigsawGenerator.<span style="color: #2b91af">Parameters</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Width = 20, Height = 15, Pieces = 100</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; StorageProvider = <span style="color: #a31515">&quot;Generic&quot;</span> <span style="color: green">// Generic HTTP download (vs A360)</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; });</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; wi.Arguments.OutputArguments.Add(<span style="color: blue">new</span> AIO.<span style="color: #2b91af">Argument</span>()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Name = <span style="color: #a31515">&quot;Results&quot;</span>, <span style="color: green">// Must match the output parameter in activity</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; StorageProvider = <span style="color: #a31515">&quot;Generic&quot;</span>, <span style="color: green">// Generic HTTP upload (vs A360)</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; HttpVerb = <span style="color: #a31515">&quot;POST&quot;</span>, <span style="color: green">// Use HTTP POST when delivering result</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Resource = <span style="color: blue">null</span>, <span style="color: green">// Use storage provided by AutoCAD.IO</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ResourceKind = <span style="color: #a31515">&quot;ZipPackage&quot;</span> <span style="color: green">// Upload files as zip to output directory</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; });</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.AddToWorkItems(wi);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.SaveChanges();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Polling loop</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">do</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Sleeping for 2 sec...&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Threading.<span style="color: #2b91af">Thread</span>.Sleep(2000);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.LoadProperty(wi, <span style="color: #a31515">&quot;Status&quot;</span>); <span style="color: green">// HTTP request is made here</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;WorkItem status: {0}&quot;</span>, wi.Status);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">while</span> (wi.Status == <span style="color: #a31515">&quot;Pending&quot;</span> || wi.Status == <span style="color: #a31515">&quot;InProgress&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Re-query the service so that we can look at the details provided</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// by the service</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; container.MergeOption =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Data.Services.Client.<span style="color: #2b91af">MergeOption</span>.OverwriteChanges;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; wi =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.WorkItems.Where(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; p =&gt; p.UserId == wi.UserId &amp;&amp; p.Id == wi.Id</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ).First();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Resource property of the output argument &quot;Results&quot; will have</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// the output url</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> url =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; wi.Arguments.OutputArguments.First(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; a =&gt; a.Name == <span style="color: #a31515">&quot;Results&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ).Resource;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DownloadToDocs(url, <span style="color: #a31515">&quot;AIO.zip&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Download the status report</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; url = wi.StatusDetails.Report;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DownloadToDocs(url, <span style="color: #a31515">&quot;AIO-report.txt&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">static</span> <span style="color: blue">void</span> DownloadToDocs(<span style="color: blue">string</span> url, <span style="color: blue">string</span> localFile)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> client = <span style="color: blue">new</span> <span style="color: #2b91af">HttpClient</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> content = (<span style="color: #2b91af">StreamContent</span>)client.GetAsync(url).Result.Content;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> fname =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Path</span>.Combine(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Environment</span>.GetFolderPath(<span style="color: #2b91af">Environment</span>.<span style="color: #2b91af">SpecialFolder</span>.MyDocuments),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; localFile</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Downloading to {0}.&quot;</span>, fname);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (<span style="color: blue">var</span> output = System.IO.<span style="color: #2b91af">File</span>.Create(fname))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; content.ReadAsStreamAsync().Result.CopyTo(output);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; output.Close();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;</p> </div>  <p>When we execute it for the first time, it should just upload and exercise the Activity. For subsequent runs there’s an “Update” options, although I’ve found it more effective to use “Delete” (an option I added) and then run it again.</p>  <p>Here’s the output we see in the command prompt when it executes properly:<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d1297261970c-pi" target="_blank"><img title="Command-prompt output from our Activity creation and test" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="Command-prompt output from our Activity creation and test" src="/assets/image_503707.jpg" width="434" height="221" /></a></p>  <p>The output from the CRX app – which has been updated to create output, more details in <a href="http://through-the-interface.typepad.com/through_the_interface/2015/06/running-custom-net-code-in-the-cloud-using-autocad-io-part-2.html" target="_blank">the original post showing it</a> – should have been Zipped up and downloaded to your “<em>My Documents</em>” folder. There should be an execution report there, too, showing exactly what went on on the command-line.</p>  <p>Here’s the PNG that was generated by the test WorkItem:<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b8d1297265970c-pi" target="_blank"><img title="JIGIO output" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin: 20px auto; display: block; padding-right: 0px; border-top-width: 0px" border="0" alt="JIGIO output" src="/assets/image_636332.jpg" width="434" height="248" /></a></p>  <p>The DWG is also there, of course, which will drive our imaginary laser cutter. Here are the contents of <em>AIO-report.txt</em>, showing what went on:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px">[06/17/2015 14:09:07] Starting work item 34365e590f80433ebe4a75d4c3a9b8bc</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Start download phase.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Start downloading file http://download.autodesk.com/us/samplefiles/acad/title_block-iso.dwg.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] End downloading file http://download.autodesk.com/us/samplefiles/acad/title_block-iso.dwg. 128233 bytes have been written to C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\title_block-iso.dwg.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Embedded resource data:application/json, {&quot;Width&quot;:20.0,&quot;Height&quot;:15.0,&quot;Pieces&quot;:100,&quot;XRes&quot;:0,&quot;YRes&quot;:0,&quot;Pixels&quot;:null} is saved as file: C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\params.json.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] End download phase.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Start preparing script and command line parameters.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Folder &quot;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\outputs&quot; has been created.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Start preparing AppPackage JigsawPackage.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Downloading bits to local cache.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Done preparing AppPackage JigsawPackage.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Start script content.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] _erase _all&#160; _jigio params.json outputs</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">[06/17/2015 14:09:07] End script content.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Command line: /i &quot;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\title_block-iso.dwg&quot; /sandbox /isolate job_34365e590f80433ebe4a75d4c3a9b8bc &quot;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\userdata&quot; /al &quot;Z:\Aces\AcesRoot\20.0\coreEngine\AppCache\JigsawPackage.package&quot; /s &quot;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\script.scr&quot;</p>    <p style="margin: 0px">[06/17/2015 14:09:07] End preparing script and command line parameters.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Start script phase.</p>    <p style="margin: 0px">[06/17/2015 14:09:07] Start AutoCAD Core Console output.</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Redirect stdout (file: C:\Users\ACESWO~1\AppData\Local\Temp\accc284452).</p>    <p style="margin: 0px">[06/17/2015 14:09:09] AutoCAD Core Engine Console - Copyright 2014 by Autodesk, Inc. (J.48.C.62)</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Isolating to userId=job_34365e590f80433ebe4a75d4c3a9b8bc, userDataFolder=C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\userdata.</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Launching sandbox process: [&quot;Z:\Aces\AcesRoot\20.0\coreEngine\Exe\accoreconsole.exe&quot;&#160; /i &quot;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\title_block-iso.dwg&quot; /sandbox /isolate job_34365e590f80433ebe4a75d4c3a9b8bc &quot;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\userdata&quot; /al &quot;Z:\Aces\AcesRoot\20.0\coreEngine\AppCache\JigsawPackage.package&quot; /s &quot;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\script.scr&quot;]</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Redirect stdout (file: C:\Users\acesworker\AppData\LocalLow\temp\accc108871).</p>    <p style="margin: 0px">[06/17/2015 14:09:09] AutoCAD Core Engine Console - Copyright 2014 by Autodesk, Inc. (J.48.C.62)</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Running at low integrity.</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Regenerating model.</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Command:</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Command:</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Command:</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Command: _erase</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Select objects: _all 2 found</p>    <p style="margin: 0px">[06/17/2015 14:09:09] 1 was not in current space.</p>    <p style="margin: 0px">[06/17/2015 14:09:09] Select objects:</p>    <p style="margin: 0px">[06/17/2015 14:09:10] Command: _jigio</p>    <p style="margin: 0px">[06/17/2015 14:09:10] Specify parameter file: params.json</p>    <p style="margin: 0px">[06/17/2015 14:09:10] Specify output folder: outputs</p>    <p style="margin: 0px">[06/17/2015 14:09:11] Puzzle will be 12 x 8 (96 in total)._zoom</p>    <p style="margin: 0px">[06/17/2015 14:09:11] Specify corner of window, enter a scale factor (nX or nXP), or</p>    <p style="margin: 0px">[06/17/2015 14:09:11] [All/Center/Dynamic/Extents/Previous/Scale/Window/Object] &lt;real time&gt;: _extents _pngout Enter file name &lt;C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\title_block-iso.png&gt;: outputs\jigsaw.png Select objects or &lt;all objects and viewports&gt;:</p>    <p style="margin: 0px">[06/17/2015 14:09:11] Command: _quit</p>    <p style="margin: 0px">[06/17/2015 14:09:11] End AutoCAD Core Console output</p>    <p style="margin: 0px">[06/17/2015 14:09:11] End script phase.</p>    <p style="margin: 0px">[06/17/2015 14:09:11] Start upload phase.</p>    <p style="margin: 0px">[06/17/2015 14:09:11] Zipping directory C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\outputs as C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\outputs.zip.</p>    <p style="margin: 0px">[06/17/2015 14:09:11] Start uploading C:\Users\acesworker\AppData\LocalLow\jobs\34365e590f80433ebe4a75d4c3a9b8bc\outputs.zip</p>    <p style="margin: 0px">to <a href="https://acadio.s3.amazonaws.com/aces-workitem-outputs/34365e590f80433ebe4a75d4c3a9b8bc/outputs.zip">https://acadio.s3.amazonaws.com/aces-workitem-outputs/34365e590f80433ebe4a75d4c3a9b8bc/outputs.zip</a>?</p>    <p style="margin: 0px">AWSAccessKeyId=ASIAI2C57P7J27QHKLFQ&amp;Expires=1434553752&amp;x-amz-security-token=AQoDYXdzEC4a4APZUiKTndtDnbB</p>    <p style="margin: 0px">jLIBMYhX1hCvyhmosYwYpoks0mmbOn4wbdDYB4kMEkTv8x3SlG7v3Rqd3mLgiT24mzq9FFHhI3Gt25Yix8ZYrGYFONo3BigltsE%2Fk</p>    <p style="margin: 0px">XuF5ddYea3GiuEaL9prC5RBo2BEl2xIfEFjATy9EH1MsrpnJl%2B3gzOuYp5WASaJuIpgqSt4z36Hwc6s1uVq0bqvHFEQP2iqCibB%2</p>    <p style="margin: 0px">FL9HmQZOH%2FrCirvGLMin0GysAIH7ZGNrKJsvnsEBIGhRoxPC8j5FRwUoa21je06jz4moDSGCE5%2FsTuYSZfWRuH5afPqubJZmB5Z</p>    <p style="margin: 0px">S9Me%2FEG89%2BmcZslctHtueKrYAHAme4t5Sw3srdaWLmRaXb6vj9Zm8GPyB4W07JOE1RjdoAii61%2BX6vHMjJWFie%2BnRx2hma%</p>    <p style="margin: 0px">2Fs37Pp8pAbUYBt0M7Zu9%2BhqMPQfjOadS8uTBTY88RsCit1bd6HBD0XDjISxwozLUMgKBDjyJQvfFsgGyzhDkJJNrkAtufFMjcB4p</p>    <p style="margin: 0px">cNnaa9eajG%2BuIFTmj%2BVSR2EdeWdbbvKLlxIfZ2OAjHlypMz84kTBCXq%2FvfH3hv%2F3fSP4mR5z4BfyqYUHubM8ydyQcYfaTCv</p>    <p style="margin: 0px">eBPc%2FqNRaRVUYTjioiXgmVvDnAOV%2BjPj0jTWB0tsg7eKFrAU%3D&amp;Signature=Li9T3WxlTsmvIXjmSjGZG3csJUo%3D.</p>    <p style="margin: 0px">[06/17/2015 14:09:12] End upload phase.</p>    <p style="margin: 0px">[06/17/2015 14:09:12] Job finished with result Succeeded</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;</p> </div>  <p>One thing I need to fix: right now the test code passes in <a href="http://download.autodesk.com/us/samplefiles/acad/title_block-iso.dwg" target="_blank">a sample DWG that’s posted on web</a>. I haven’t yet worked out how to start without a base DWG file – we’re generating all our geometric content from scratch, of course – so we’re currently erasing any existing geometry before we start. I’m sure there’s an easy fix: once I’ve found out what it is I’ll update this post.</p>  <p>The next couple of posts will be on other topics, as we need a small break from this series (and I have some other things to talk about). When we return we’ll be looking at how to call our Activity from the Node.js back-end of our <a href="http://jigsawify.com" target="_blank">Jigsawify.com</a> web-site.</p>  <p><strong><em>Update:</em></strong></p>  <p>It turns out you do indeed need to provide a HostDwg input parameter: this is by far the most common scenario, even if it’s to specify a blank initial drawing. Luckily the <a href="http://knowledge.autodesk.com/support/autocad/downloads/caas/downloads/content/autocad-2016-templates.html" target="_blank">standard AutoCAD drawing templates are available online</a>, so you can replace the above-linked DWG with <a href="http://download.autodesk.com/us/support/files/autocad_2015_templates/acad.dwt" target="_blank">this one</a>. And remove the “_erase _all&#160; ” part of the test script, of course, as it doesn’t contain anything to erase.</p>
