---
layout: "post"
title: "Introducing Capturefinery, a Dynamo package that creates presentation graphics for Refinery studies"
date: "2019-05-09 18:49:52"
author: "Kean Walmsley"
categories:
  - "Autodesk Research"
  - "Dynamo"
  - "Generative design"
  - "Graphics system"
original_url: "https://www.keanw.com/2019/05/introducing-capturefinery-a-dynamo-package-that-creates-presentation-graphics-for-refinery-studies.html "
typepad_basename: "introducing-capturefinery-a-dynamo-package-that-creates-presentation-graphics-for-refinery-studies"
typepad_status: "Publish"
---

<p>A few weeks ago I posted <a href="https://twitter.com/keanw/status/1121534435143376898" rel="noopener" target="_blank">a GIF on Twitter that showed a few images from an earlier version</a> of the <a href="https://www.keanw.com/2019/04/revisiting-mars-for-au-london-2019.html" rel="noopener" target="_blank">Project Rediscover</a> graph. I created this in a very manual, low-tech way: firstly, I selected a number of designs in <a href="https://www.autodesk.com/solutions/refinery-beta" rel="noopener" target="_blank">Refinery</a>, one-by-one, took a screenshot of each and then used <a href="https://www.gimp.org/" rel="noopener" target="_blank">GIMP</a> to build an animated GIF. (This used to be very easy to do with previous versions of OS X, by the way: the Preview tool allowed you to drag images across into a GIF file and create new frames, and you could then use GIMP to adjust the timing of the frames, if needed. These days – since the OS X feature was deprecated a release or so ago, leading to images dragged onto the Preview thumbnail sheet to load them into Preview as new documents – you have to use GIMP or another tool for the whole process.)</p>
<p>It occurred to me that there had to be a simpler way, so I went about exploring whether a <a href="https://developer.dynamobim.org/03-Development-Options/3-6-extensions.html" rel="noopener" target="_blank">Dynamo view extension</a> had access to the required capabilities to manage this process. Basically I wanted something that would create presentation graphics for Refinery runs that had already been performed on your system.</p>
<p>My idea was that the tool would:</p>
<ol>
<li>Access the “<em>MyFilename.RefineryResults</em>” folder – where <em>MyFilename</em> is the current Dynamo graph – and use the folder names to populate a dialog list.</li>
<li>Allow the user to select the Refinery study of interest, at which point it would parse the contained <em>RefineryResults.json</em> file.</li>
<li>Use the input parameters contained in the “hall of fame” to run each design.</li>
<li>Take a screenshot once the run was complete and save it to disk.</li>
<li>Once all the designs have been captured, use the various images to create animated GIFs of different sizes.</li>
</ol>
<p>The good news is that a bunch of these steps are “solved problems”: the first is straightforward using .NET’s System.IO, the second was done in <a href="http://github.com/KeanW/Warnamo" rel="noopener" target="_blank">Warnamo</a>, the third is done by Refinery when you select a design, and the <a href="https://stackoverflow.com/questions/1163761/capture-screenshot-of-active-window" rel="noopener" target="_blank">fourth</a> and <a href="https://stackoverflow.com/questions/1196322/how-to-create-an-animated-gif-in-net/32810041" rel="noopener" target="_blank">fifth</a> have solutions on StackOverflow.</p>
<p class="p1">So I went ahead and assembled the various pieces into a project, <a href="http://github.com/KeanW/Capturefinery"><span class="s1">which you can find on GitHub</span></a>. It works well, although I haven’t spent a great amount of time on the UX, which is a little rudimentary.</p>
<p class="p1">I decided to call the tool Capturefinery, which could be parsed as CaptuRefinery or CaptureFinery (hence the lack of a capital letter in the middle). I wouldn’t say it’s an amazing name, but it does the trick.</p>
<p class="p1">When you launch it from Dynamo’s View menu, it brings up a dialog listing the IDs of the Refinery tasks you’ve run for the current graph:</p><p class="p1"><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a485952b200d-pi" target="_blank"><img alt="Study list" border="0" height="312" src="/assets/image_121281.jpg" style="margin: 30px auto; border-image: none; float: none; display: block; background-image: none;" title="Study list" width="500" /></a></p>
<p class="p1">When you click one, the dialog is hidden until the various designs have been captured – bear in mind the whole screen is captured, right now, not just the Dynamo window – and compiled into a number of GIFs in the results folder of the study. Or until the tool crashes.</p>
<p class="p1">Speaking of crashes… in general the tool seems surprisingly stable, but there’s an enormous caveat I found after leaving Capturefinery to run unattended a few times: it would always crash after creating 12 or so images. But if I was there to watch it, the process would go much longer. It was very strange… a bit like the opposite effect of “a watched pot never boils”… it was more like “an unwatched Refinery capture never succeeds”. :-)</p>
<p class="p1">I eventually worked out that the code would crash after the computer had locked automatically. I adjusted the power settings, to make sure the screen wouldn’t turn off, but unfortunately our IT department controls the auto-locking of our systems… it’s not something we can adjust on our machines. Argh.</p>
<p class="p1">I took the problem to our dinner table, and asked my kids to come up with solutions to moving the mouse or pressing a key regularly for 2+ hours (the time it would take to capture 130 images for one of the runs I wanted to test with). One of my sons suggested he play Minecraft – a non-starter unless I wanted a GIF of 130 random moments in his Minecraft world – while the other suggested he program his Sphero to move the mouse around (not bad). The winning solution came from my daughter, who suggested setting a timer on my phone to vibrate every 10 minutes, and putting the mouse on top of it. Genius! I managed to set a vibrating alarm that would snooze indefinitely for 10 minutes at a time. The vibrations were enough to move the mouse cursor minutely which kept the computer awake for the 2 hours that were needed. :-)</p>
<p>Here’s one of the images captured by the tool:</p>
<p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20240a4855a9d200d-pi" rel="noopener" target="_blank"><img alt="A sample screenshot" border="0" height="312" src="/assets/image_33762.jpg" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" title="A sample screenshot" width="500" /></a></p>
<p>I decided that the tool should create 3 different resolutions of file: the native screen resolution, and then one at 1000 pixels width and one at 500 pixels width. For the capture with 130 images these GIFs weighed in at 165MB, 30MB and 9MB respectively. So fairly hefty.</p>
<p>Here’s the smallest of them:</p>
<p><a href="/assets/image_602499.jpg" rel="noopener" target="_blank"><img alt="The smallest GIF captured" height="312" src="/assets/image_602499.jpg" style="margin: 30px auto; float: none; display: block;" title="The smallest GIF captured" width="500" /></a></p>
<p>Unfortunately there isn’t a simple way to control the frame delay period when creating the GIF using .NET: you will have to post-process it using (for instance) GIMP to slow it down, if that’s your preference. (There wasn’t even a way to request the GIF should loop, but I found <a href="https://stackoverflow.com/questions/18719302/net-creating-a-looping-gif-using-gifbitmapencoder" rel="noopener" target="_blank">a hack that enabled that</a>.)</p><p>Something to bear in mind about the above results, for those of you who may be trying to make sense of them (good luck with that, by the way ;-): I actually used an old Refinery study with a newer version of the Dynamo graph: the geometry system is the same but the metrics have evolved quite a bit. This was actually really helpful, as it highlighted a bug in the graph we needed to fix, but I don’t expect Refinery to generate the same set of solutions when I run the next study.</p>
<p class="p1">I’m a little hesitant to publish Capturefinery via the Dynamo Package Manager – mainly due to the UX issues, but also the stability issue related to screen locking – but for sure I’d love people with Visual Studio to build it for themselves and give it a try (and even contribute to the project – send me a Pull Request if you want to make it better!). This situation will hopefully change, once I have time to tidy things up and make it a little more useable.</p><p class="p1">Next week I’m heading to New Orleans for our annual, internal <strike>geekfest</strike> technical summit. Simon Breslav has added some really nice features to Project Rediscover, over the last week or so – we’re getting really close now! – so I’ll hopefully manage to share a quick update related to that, at least.</p><p class="p1"><strong><em>Update:</em></strong></p><p class="p1">A big thanks to <a href="https://twitter.com/Gytaco" target="_blank">Adam Sheather</a> who suggested the <a href="https://www.autohotkey.com" target="_blank">AutoHotkey</a> tool to stop my system from going to sleep, something he’s <a href="https://twitter.com/Gytaco/status/1126782926526373888" target="_blank">used successfully in the past for similar situations</a>. I can get my phone back for those two hours!</p><p class="p1">Here’s the script I used, which moves the mouse by a few pixels every 10 minutes:</p><p><font face="Courier New" size="2">#Persistent<br />
SetTimer, MoveTheMouse, 600000<br />
Return</font></p><font face="Courier New" size="2">
</font><p><font face="Courier New" size="2">MoveTheMouse:<br />
MouseMove, 2, 2, 50, R<br />
Return</font></p><p class="p1">This seems to work well enough. (Please bear in mind that I’m new to AutoHotkey, so there may be better approaches for this.)</p>
