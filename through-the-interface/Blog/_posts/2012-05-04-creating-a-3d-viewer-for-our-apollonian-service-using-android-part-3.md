---
layout: "post"
title: "Creating a 3D viewer for our Apollonian service using Android &ndash; Part 3"
date: "2012-05-04 10:31:14"
author: "Kean Walmsley"
categories:
  - "Android"
  - "Java"
  - "JSON"
  - "Mobile"
  - "REST"
  - "SaaS"
original_url: "https://www.keanw.com/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-android-part-3.html "
typepad_basename: "creating-a-3d-viewer-for-our-apollonian-service-using-android-part-3"
typepad_status: "Publish"
---

<p>I hadn’t actually planned a 3rd part to this series, but Dennis Ippel kindly spent some time looking at the code posted in <a href="http://through-the-interface.typepad.com/through_the_interface/2012/05/creating-a-3d-viewer-for-our-apollonian-service-using-android-part-2.html" target="_blank">the last post</a>, to see where optimisations might be made to increase the sphere count.</p>
<p>Consequently, Dennis made some changes to the Rajawali framework to support batch rendering of objects, as well as suggesting some client-side changes that make use of object cloning to avoid the need for replicated vertex buffers, index buffers, textures, etc. – all properties/dependent objects that the code was previously creating per sphere.</p>
<p>The results were stunning: with really a modest change to the client code (and an update to the Rajawali library, of course), the geometry creation phase has been sped up significantly and the app can now load up to Level 10 packings on my Kindle Fire. Although the frame-rate is down around a single frame-per-second, should you actually try to do anything with the model. But hey. :-)</p>
<p>Here is the only function that needed updating:</p>
<div class="java"><code><span style="color: #ffffff;">&#0160; </span><span style="color: #0000c0;"><strong>private </strong></span><span style="color: #c00000;"><strong>void </strong></span><span style="color: #000000;">createSphere</span><span style="color: #000000;">(</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #c00000;"><strong>float </strong></span><span style="color: #000000;">x, </span><span style="color: #c00000;"><strong>float </strong></span><span style="color: #000000;">y, </span><span style="color: #c00000;"><strong>float </strong></span><span style="color: #000000;">z, </span><span style="color: #c00000;"><strong>float </strong></span><span style="color: #000000;">radius,</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #c00000;"><strong>int </strong></span><span style="color: #000000;">level, </span><span style="color: #c00000;"><strong>boolean </strong></span><span style="color: #000000;">isRoot</span> <br /><span style="color: #ffffff;">&#0160; </span><span style="color: #000000;">)</span> <br /><span style="color: #ffffff;">&#0160; </span><span style="color: #000000;">{</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #0000c0;"><strong>if </strong></span><span style="color: #000000;">(</span><span style="color: #000000;">isRoot &amp;&amp; mRootSphere != </span><span style="color: #0000c0;"><strong>null</strong></span><span style="color: #000000;">)</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #0000c0;"><strong>return</strong></span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">BaseObject3D sphere = </span><span style="color: #0000c0;"><strong>null</strong></span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #0000c0;"><strong>if </strong></span><span style="color: #000000;">(</span><span style="color: #000000;">mRootSphere == </span><span style="color: #0000c0;"><strong>null</strong></span><span style="color: #000000;">)</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">{</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #008000;">// Create our initial sphere</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere = </span><span style="color: #0000c0;"><strong>new </strong></span><span style="color: #000000;">Sphere</span><span style="color: #000000;">(</span><span style="color: #000000;">radius, </span><span style="color: #990000;">9</span><span style="color: #000000;">, </span><span style="color: #990000;">9</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setScale</span><span style="color: #000000;">(</span><span style="color: #000000;">radius</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.getMaterial</span><span style="color: #000000;">()</span><span style="color: #000000;">.setUseColor</span><span style="color: #000000;">(</span><span style="color: #0000c0;"><strong>true</strong></span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setRenderChildrenAsBatch</span><span style="color: #000000;">(</span><span style="color: #0000c0;"><strong>true</strong></span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">mRootSphere = sphere;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">}</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #0000c0;"><strong>else</strong></span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">{</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #008000;">// Cloning re-uses vertex buffers, index buffers,</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #008000;">// textures, etc.</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere = mRootSphere.clone</span><span style="color: #000000;">()</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setScale</span><span style="color: #000000;">(</span><span style="color: #000000;">radius</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">}</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setScale</span><span style="color: #000000;">(</span><span style="color: #000000;">sphere.getScale</span><span style="color: #000000;">()</span><span style="color: #000000;">.multiply</span><span style="color: #000000;">(</span><span style="color: #990000;">100f</span><span style="color: #000000;">))</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setX</span><span style="color: #000000;">(</span><span style="color: #000000;">x</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setY</span><span style="color: #000000;">(</span><span style="color: #000000;">y</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setZ</span><span style="color: #000000;">(</span><span style="color: #000000;">z</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #008000;">// Add our light</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.addLight</span><span style="color: #000000;">(</span><span style="color: #000000;">mLight</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #008000;">// Set the material and color</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">sphere.setColor</span><span style="color: #000000;">(</span><span style="color: #000000;">level &gt; </span><span style="color: #990000;">10 </span><span style="color: #000000;">? Color.WHITE : mColors</span><span style="color: #000000;">[</span><span style="color: #000000;">level</span><span style="color: #000000;">]</span><span style="color: #000000;">, </span><span style="color: #0000c0;"><strong>true</strong></span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #008000;">// Make it our root sphere or add it as a child</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #0000c0;"><strong>if </strong></span><span style="color: #000000;">(</span><span style="color: #000000;">isRoot</span><span style="color: #000000;">)</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">{</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">mRootSphere = sphere;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">addChild</span><span style="color: #000000;">(</span><span style="color: #000000;">mRootSphere</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">}</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #0000c0;"><strong>else if </strong></span><span style="color: #000000;">(</span><span style="color: #000000;">mRootSphere != </span><span style="color: #0000c0;"><strong>null</strong></span><span style="color: #000000;">)</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">{&#0160;&#0160;&#0160;&#0160;&#0160; </span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #000000;">mRootSphere.addChild</span><span style="color: #000000;">(</span><span style="color: #000000;">sphere</span><span style="color: #000000;">)</span><span style="color: #000000;">;</span> <br /><span style="color: #ffffff;">&#0160;&#0160;&#0160; </span><span style="color: #000000;">}</span> <br /><span style="color: #ffffff;">&#0160; </span><span style="color: #000000;">}</span></code></div>
<p>Here are some screenshots of these higher levels:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20163052789bb970d-pi" target="_blank"><img alt="Level 6" border="0" height="149" src="/assets/image_618042.jpg" style="background-image: none; margin: 20px 8px 20px 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Level 6" width="89" /></a><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20168eb1cf1ee970c-pi" target="_blank"><img alt="Level 7" border="0" height="149" src="/assets/image_745297.jpg" style="background-image: none; margin: 20px 8px 20px 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Level 7" width="89" /></a><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20168eb1cf33b970c-pi" target="_blank"><img alt="Level 8" border="0" height="149" src="/assets/image_156966.jpg" style="background-image: none; margin: 20px 8px 20px 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Level 8" width="89" /></a><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2016305278e18970d-pi" target="_blank"><img alt="Level 9" border="0" height="149" src="/assets/image_298544.jpg" style="background-image: none; margin: 20px 8px 20px 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Level 9" width="89" /></a><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2016305278ec7970d-pi" target="_blank"><img alt="Level 10" border="0" height="149" src="/assets/image_937984.jpg" style="background-image: none; margin: 20px 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Level 10" width="89" /></a></p>
<p>With a couple of close-ups of the detail on Level 10:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20167661ae769970b-pi" target="_blank"><img alt="Level 10 - zoomed in" border="0" height="319" src="/assets/image_28697.jpg" style="background-image: none; margin: 20px 25px 20px 30px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Level 10 - zoomed in" width="189" /></a><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20167661ae94f970b-pi" target="_blank"><img alt="Another Level 10 view" border="0" height="319" src="/assets/image_976965.jpg" style="background-image: none; margin: 20px 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Another Level 10 view" width="189" /></a></p>
<p>I still get some quirks where the spheres don’t all come in when loading a particular level (and that’s from Level 6 upwards), but I strongly suspect this is due to inherent limitations of the Kindle Fire (which is a fairly modest device, as far as Android tablets go).</p>
<p>Here’s <a href="http://through-the-interface.typepad.com/files/ApollonianViewer2.apk" target="_blank">the updated .apk file</a>, and <a href="http://through-the-interface.typepad.com/files/ApollonianViewer.zip" target="_blank">the complete project</a>, as it currently stands. I was going to update the application to target a lower version of Android, but it seems Rajawali requires at least 2.2, in any case (and my current target is 2.3.3). If anyone really needs a version for 2.2, do let me know.</p>
<p>By the way – some of you may be wondering why the difference is fairly modest between Levels 9 and 10, in terms of the number of spheres created: this is because we set a lower radius threshold of 0.01, which – as we’re only generating the data for a radius of 1.0 and reusing that for other radii – means we will only return spheres as small as 1% of the provided radius, nothing smaller. We could very easily adjust this on the server, of course, which would clearly lead to more data being downloaded, particularly for these higher levels.</p>
<p>I’ve now started work on an iOS version of the app, or at least trying to identify an appropriate, open-source 3D engine that keeps me away from making calls to OpenGL ES directly. Hopefully I’ll have something to share sometime next week.</p>
