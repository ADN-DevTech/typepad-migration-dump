---
layout: "post"
title: "Draping temperature data from a thermal image across the Forge viewer scene - Part 1"
date: "2022-01-17 11:36:07"
author: "Kean Walmsley"
categories:
  - "APS (Forge)"
  - "Autodesk Research"
  - "IoT"
original_url: "https://www.keanw.com/2022/01/draping-temperature-data-from-a-thermal-image-across-the-forge-viewer-scene-part-1.html "
typepad_basename: "draping-temperature-data-from-a-thermal-image-across-the-forge-viewer-scene-part-1"
typepad_status: "Publish"
---

<p>I work in the Research Engineering team at Autodesk, a centralised pool of software engineering talent that contributes to research projects across our various industries. Organising this way allows us to explore commonalities (and efficiencies) that would otherwise be hard to achieve. Every year or two we have an internal “Innovation Days” event, which is essentially an internal team hackathon. (Lots of other teams at Autodesk do this, of course, we’re far from being unique in that regard.)</p><p>Our latest Innovation Days took place on Thursday and Friday of last week, with the theme of sustainability. I met with the extended Dasher team (which is still very small, even when extended :-) for our team meeting the day before, and we brainstormed a few possible ideas (the broader team had had a very interesting presentation by Zoé Bezpalko, a Sustainability Strategy Manager at Autodesk, before the break, but I wanted to get some Dasher-specific ideas on paper). Alex Tessier suggested bring thermal imagery data – apparently people are using <a href="https://www.flir.com/browse/camera-cores-amp-components/thermal-camera-cores/" target="_blank">FLIR infrared camera modules</a> with their iPhones to capture such images, these days – into Dasher. At first I was a bit sceptical – understanding the position of the camera relative to the scene is a big job! – but we agreed to set that problem to one side, for now, and just worry about analysing a thermal image and bringing its data into Dasher.</p><p>That sounded much more tractable, to me, so on Thursday I went ahead and started work on bringing thermal image data into Dasher. As I don’t have actual thermal imagery for a 3D scene, I took a somewhat cheeky shortcut and used <a href="https://www.imgonline.com.ua/eng/add-effect-thermal-imager.php" target="_blank">this site</a> to generate an image for a screenshot of a scene inside Dasher.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e202942f93e025200c-pi" target="_blank"><img width="500" height="265" title="Thermal Scene" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Thermal Scene" src="/assets/image_152711.jpg" border="0"></a></p><p>Here’s the original, for comparison:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20282e13ec49b200b-pi" target="_blank"><img width="500" height="265" title="Scene" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Scene" src="/assets/image_196525.jpg" border="0"></a></p><p>The basic idea was to analyse the data in the thermal image, and – for the corresponding 3D view, which we already have – to “drape” the temperature onto the 3D locations represented in the image. I initially thought about creating a coloured sphere at each location, but decided to skip that and directly use the Forge viewer’s <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/introduction/overview/" target="_blank">Data Visualization Extension</a> to display coloured <a href="https://forge.autodesk.com/en/docs/dataviz/v1/developers_guide/examples/sprites/" target="_blank">sprites</a> instead. One benefit of this approach would be the ability to display tooltips for each of these sprites, something we’ll see in Part 2.</p><p>I didn’t want to create a sprite for every single pixel in the thermal image – at a resolution of 1792 x 950 that’s a lot of sprites – and so decided to create one sprite for every 25 pixels in the X and Y directions (i.e. one in every 625 pixels). For my first implementation I wrote some code that averaged the pixel values for a section of the thermal image – <a href="https://www.keanw.com/2009/02/importing-and-pixelizing-images-inside-autocad-using-f.html" target="_blank">something I’d done, way back when, inside AutoCAD</a> – but then my son reminded me that you could just draw the image into a scaled down canvas element (we’re in any case using a canvas to access the image data), which does this automagically. You can then access the data, pixel by pixel, and the canvas has done all the heavy lifting for you. (I think it’s wonderful that I’m now getting programming hints from my kids!)</p><p>This scaling allowed easy access to 2,698 (71 x 38) temperature values, which seemed like a decent number of points to create for a single thermal image.</p><p>Now that we have an RGB value for a particular area of the thermal image, we can find the corresponding location in the 3D model. For this we use the hitTest() method of the Forge viewer’s impl object to fire a ray from the screen position along the view direction and find its intersection with the 3D scene. (We use this technique already inside Dasher to place sensors beneath the cursor, so I was familiar with how it worked.)</p><p>Then we can simply create a sprite with the appropriate colour at that 3D location. Because we create them in a uniform grid relative to the view (and the thermal image) – and that the sprites have a uniform size from any distance – we seem them as a grid once they’re created:</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2027880662739200d-pi" target="_blank"><img width="500" height="312" title="Our sprites" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Our sprites" src="/assets/image_48710.jpg" border="0"></a></p><p>Here’s the same view with a small application window, which shows them more densely packed.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e2027880662740200d-pi" target="_blank"><img width="500" height="372" title="Now with closer spacing" style="margin: 30px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" alt="Now with closer spacing" src="/assets/image_412854.jpg" border="0"></a></p><p>One question I have is whether windows radiate heat that can then be picked up by a thermal camera. Or, in other words, whether the hitTest() function be instructed to ignore transparent materials. I assume so: my sense is that the default setting of this flag to false (i.e. to take into account hits on things like windows) is appropriate, in this case. But it’s something that is easy to tweak if I have this wrong.</p><p>As soon as we pan or orbit the view, we see that these points are truly in 3D.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20282e13ec4b7200b-pi" target="_blank"><img width="500" height="372" title="3D thermal points" style="margin: 30px auto; float: none; display: block;" alt="3D thermal points" src="/assets/image_746592.jpg"></a></p><p>I was already pretty happy with this implementation. Of course there are a lot of missing pieces to this… I’m hoping that my colleagues working on computer vision and machine learning research will be able give me a nicely calibrated camera for a single thermal image, but even if they can’t I think it demonstrates some interesting possibilities for harnessing the Forge viewer and its Data Visualization Extension to display this kind of data. It would be so cool to aggregate a point cloud from various thermal images – or from thermal video footage – but that would bring lots of other challenges around storing and displaying larger amounts of data. All of which I’m leaving for another day, way in the future.</p><p>On a day in the much nearer-term future – I’m thinking tomorrow or the day after – we’ll take a look at the approach I took on the second Innovation Day to implement tooltips showing an approximation of the temperature at a particular location.</p>
