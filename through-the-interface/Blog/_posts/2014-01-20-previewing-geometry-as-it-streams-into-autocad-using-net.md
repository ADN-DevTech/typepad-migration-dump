---
layout: "post"
title: "Previewing geometry as it streams into AutoCAD using .NET"
date: "2014-01-20 15:02:27"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Geometry"
  - "Graphics system"
  - "Solid modeling"
original_url: "https://www.keanw.com/2014/01/previewing-geometry-as-it-streams-into-autocad-using-net.html "
typepad_basename: "previewing-geometry-as-it-streams-into-autocad-using-net"
typepad_status: "Publish"
---

<p>While developing <a href="http://through-the-interface.typepad.com/through_the_interface/2014/01/leaving-israel.html" target="_blank">the prototype ShapeShifter-AutoCAD integration</a>, last week, it became clear that the user really needed something to look at as geometry was being marshalled across between the JavaScript hosting process and AutoCAD’s address space. We might have used a standard progress bar, of course, but decided to do something a bit different: implement a mechanism to take the vertices of a mesh as they are being streamed/decoded and display them inside the drawing.</p>  <p>For us this proved to be a 2-stage process: the vertices were brought in and displayed as red, and these same vertices – as referenced by the various faces that were brought in during the second stage – were then displayed in yellow. Once all the data was there to generate the SubDMesh, we went ahead and did so.</p>  <p>This should give you an idea of what the results were like:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019b050a7a0b970d-pi"><img style="display: inline" title="Streaming a mesh into AutoCAD" alt="Streaming a mesh into AutoCAD" src="/assets/image_224210.jpg" width="470" height="322" /></a></p>  <p>The primary technique was to derive a Transient object that could display the two sets of points in its SubWorldDraw() method:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">struct</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TransFace</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> a, b, c, d;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PointDisplay</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #2b91af">Transient</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #2b91af">Point3dCollection</span><span style="line-height: 140%"> _vertices, _facepts;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> PointDisplay()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; _vertices = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point3dCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; _facepts = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Point3dCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> AddPoint(</span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> pt)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; _vertices.Add(pt);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> AddFace(</span><span style="line-height: 140%; color: #2b91af">TransFace</span><span style="line-height: 140%"> face)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pt1 = _vertices[face.a];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pt2 = _vertices[face.b];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pt3 = _vertices[face.c];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; _facepts.Add(pt1);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; _facepts.Add(pt2);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; _facepts.Add(pt3);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (face.c != face.d)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; _facepts.Add(_vertices[face.d]);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">protected</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> SubSetAttributes(</span><span style="line-height: 140%; color: #2b91af">DrawableTraits</span><span style="line-height: 140%"> traits)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DrawableAttributes</span><span style="line-height: 140%">.None;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">protected</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> SubViewportDraw(</span><span style="line-height: 140%; color: #2b91af">ViewportDraw</span><span style="line-height: 140%"> vd)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">protected</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> SubWorldDraw(</span><span style="line-height: 140%; color: #2b91af">WorldDraw</span><span style="line-height: 140%"> wd)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">short</span><span style="line-height: 140%"> oc = wd.SubEntityTraits.Color;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; wd.SubEntityTraits.Color = 1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; wd.Geometry.Polypoint(_vertices, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; wd.SubEntityTraits.Color = 2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; wd.Geometry.Polypoint(_facepts, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; wd.SubEntityTraits.Color = oc;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>Then, during the course of our command, we needed to instantiate the PointDisplay() class (I chose to store mine in a member variable called _pd, as I’m going to populate it from another method) and then display it via the Transient Graphics Manager:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">_pd = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PointDisplay</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: #2b91af">TransientManager</span><span style="line-height: 140%">.CurrentTransientManager.AddTransient(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; _pd, </span><span style="line-height: 140%; color: #2b91af">TransientDrawingMode</span><span style="line-height: 140%">.DirectShortTerm,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; 128, </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntegerCollection</span><span style="line-height: 140%">()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p> </div>  <p>As we streamed in/generated the data, we added points and or TransFaces (a struct I created as a convenience: you can create your own depending on the data you’re streaming/displaying) and then, at an appropriate interval, updated the transient:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: #2b91af">TransientManager</span><span style="line-height: 140%">.CurrentTransientManager.UpdateTransient(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; _pd, </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntegerCollection</span><span style="line-height: 140%">()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p> </div>  <p>(You may need to throw in a call to DoEvents(), while you’re at it.)</p>  <p>When it’s all finished, we erased the transient and called Dispose() on it, of course:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: #2b91af">TransientManager</span><span style="line-height: 140%">.CurrentTransientManager.EraseTransient(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; _pd, </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">IntegerCollection</span><span style="line-height: 140%">()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">_pd.Dispose();</span></p>    <p style="margin: 0px">&#160;</p> </div>  <p>That’s about it. I’m not sharing the complete source for this project, as it’s an internal prototype that includes a fair amount of other code, but this should give you enough information to get it working on your side.</p>  <p>I can see this technique being of interest for applications dealing with time-consuming model creation operations. Please let me know if you have your own thoughts on how it might be used or extended.</p>
