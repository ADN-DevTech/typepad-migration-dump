---
layout: "post"
title: "Batch-processing AutoCAD drawings from LISP without SDI (take 2)"
date: "2009-06-24 14:10:10"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoLISP / Visual LISP"
  - "Batch processing"
original_url: "https://www.keanw.com/2009/06/batch-processing-autocad-drawings-from-lisp-without-sdi-take-2.html "
typepad_basename: "batch-processing-autocad-drawings-from-lisp-without-sdi-take-2"
typepad_status: "Publish"
---

<p>In <a href="http://through-the-interface.typepad.com/through_the_interface/2009/06/batch-processing-autocad-drawings-from-lisp-without-sdi.html">this recent post</a> we looked at an approach combining AutoLISP with a script generated on-the-fly to get around the fact that (command &quot;_.OPEN&quot; …) does nothing when SDI == 0. As mentioned in a comment in the post, I realised that the approach of using a single master script to do this is more prone to failure: a number of commands can cause scripts to stop executing, for instance, so it would be better practice to minimise the operations contained in a particular script to increase the application’s fault tolerance.</p>  <p>This modified approach was suggested by a member of our Engineering team in a recent thread (one that I came across after Monday’s post). It uses a data file to store a list of the drawings to process and only creates a script to load – and launch processing on – the next drawing in that list:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%"><font color="#0000ff"><font color="#ff0000">(</font>defun</font> C:BATCH<font color="#ff0000">(</font><font color="#0000ff">/</font> dwgs lsp-name data-name<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> dwgs '<font color="#ff0000">(</font><font color="#ff00ff">&quot;C:/A.DWG&quot; &quot;C:/B.DWG&quot; &quot;C:/C.DWG&quot; &quot;C:/D.DWG&quot;</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; lsp-name <font color="#ff00ff">&quot;c:/tmp.lsp&quot;</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; data-name <font color="#ff00ff">&quot;c:/dwgs.tmp&quot;</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font>create-drawing-list data-name dwgs<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font>process-next-drawing data-name lsp-name <font color="#ff00ff">&quot;(create-circle)&quot;</font> <font color="#0000ff">T T</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">princ</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">(</font><font color="#0000ff">defun</font> create-circle<font color="#ff0000">(</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">command</font> <font color="#ff00ff">&quot;_.CIRCLE&quot; &quot;10,10,0&quot; &quot;5&quot;</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">(</font><font color="#0000ff">defun</font> create-drawing-list<font color="#ff0000">(</font>data dwgs / f dwg<font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; Create data file containing the DWG names</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> f <font color="#ff0000">(</font><font color="#0000ff">open</font> data-name <font color="#ff00ff">&quot;w&quot;</font><font color="#ff0000">)</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">foreach</font> dwg dwgs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">write-line</font> dwg f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">close</font> f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; Get the first drawing from the list, removing it</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">(</font><font color="#0000ff">defun</font> get-next-drawing<font color="#ff0000">(</font>data <font color="#0000ff">/</font> dwg dwgs f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; Read in the whole list of DWGs</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> f <font color="#ff0000">(</font><font color="#0000ff">open</font> data &quot;r&quot;<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; dwgs '<font color="#ff0000">(</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font>while <font color="#ff0000">(</font><font color="#0000ff">setq</font> dwg <font color="#ff0000">(</font><font color="#0000ff">read-line</font> f<font color="#ff0000">)</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> dwgs <font color="#ff0000">(</font><font color="#0000ff">cons</font> dwg dwgs<font color="#ff0000">)</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">close</font> f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; Reverse the list, take the head and write</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; back the remainder to the file</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">if</font> <font color="#ff0000">(</font><font color="#0000ff">&gt;</font> <font color="#ff0000">(</font><font color="#0000ff">length</font> dwgs<font color="#ff0000">)</font> 0<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font>progn</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> dwgs <font color="#ff0000">(</font><font color="#0000ff">reverse</font> dwgs<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dwg <font color="#ff0000">(</font><font color="#0000ff">car</font> dwgs<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dwgs <font color="#ff0000">(</font><font color="#0000ff">cdr</font> dwgs<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> f <font color="#ff0000">(</font><font color="#0000ff">open</font> data <font color="#ff00ff">&quot;w&quot;</font><font color="#ff0000">)</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">foreach</font> dwg dwgs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">write-line</font> dwg f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">close</font> f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; dwg</span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; Process the current drawing and use a script to open</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; the next one in the list</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">(</font><font color="#0000ff">defun</font> process-next-drawing<font color="#ff0000">(</font>data lsp func save first <font color="#0000ff">/</font> scr<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> scr <font color="#ff00ff">&quot;c:/tmp.scr&quot;</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; We only want to run the function if not the first</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; time called... the same for save</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">if</font> <font color="#ff0000">(</font><font color="#0000ff">not</font> first<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">progn</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">eval</font> <font color="#ff0000">(</font><font color="#0000ff">read</font> func<font color="#ff0000">)</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">if</font> save</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">command</font> <font color="#ff00ff">&quot;_.QSAVE&quot;</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; Get the next DWG name from the file</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> dwg <font color="#ff0000">(</font>get-next-drawing data<font color="#ff0000">)</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; If there is one, create a script to open it, reload</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font style="background-color: #c0c0c0; color: #800080">;; the application and process our function</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">if</font> dwg</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">progn</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font>create-script scr data dwg lsp save first<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">command</font> <font color="#ff00ff">&quot;_.SCRIPT&quot;</font> scr<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; For the last drawing we simply close it and</font></span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; delete the now-empty data file</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">progn</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">vl-file-delete</font> data<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">vl-file-delete</font> scr<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">command</font> <font color="#ff00ff">&quot;_.CLOSE&quot;</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">)</font>&#160; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; Create a script to close the current drawing and</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; open the next, calling back to our process function</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font style="background-color: #c0c0c0; color: #800080">;; (after having loaded the file that defines it)</font></span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">(</font><font color="#0000ff">defun</font> create-script<font color="#ff0000">(</font>scr data dwg lsp save first <font color="#0000ff">/</font> f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">setq</font> f <font color="#ff0000">(</font><font color="#0000ff">open</font> scr <font color="#ff00ff">&quot;w&quot;</font><font color="#ff0000">)</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">if</font> <font color="#ff0000">(</font><font color="#0000ff">not</font> first<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">write-line</font> <font color="#ff00ff">&quot;_.CLOSE&quot;</font> f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">write-line</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">strcat</font> <font color="#ff00ff">&quot;_.OPEN \&quot;&quot;</font> dwg <font color="#ff00ff">&quot;\&quot;&quot;</font><font color="#ff0000">)</font> f</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">write-line</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">strcat</font> <font color="#ff00ff">&quot;(load \&quot;&quot;</font> lsp <font color="#ff00ff">&quot;\&quot;)&quot;</font><font color="#ff0000">)</font> f</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">write-line</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">strcat</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff00ff">&quot;(process-next-drawing \&quot;&quot;</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; data <font color="#ff00ff">&quot;\&quot; \&quot;&quot;</font> lsp <font color="#ff00ff">&quot;\&quot; \&quot;&quot;</font> func<font color="#ff00ff"> &quot;\&quot; &quot;</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; <font color="#ff0000">(</font><font color="#0000ff">if</font> save <font color="#ff00ff">&quot;T&quot; &quot;nil&quot;</font><font color="#ff0000">)</font> <font color="#ff00ff">&quot; nil)&quot;</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; f</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">close</font> f<font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; <font color="#ff0000">(</font><font color="#0000ff">princ</font><font color="#ff0000">)</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%"><font color="#ff0000">)</font></span></p> </div> <!--EndFragment-->  <p>I hope this is useful to people – as mentioned before, please do provide feedback on how/whether this works for you…</p>
