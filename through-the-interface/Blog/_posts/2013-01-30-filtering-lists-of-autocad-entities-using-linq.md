---
layout: "post"
title: "Filtering lists of AutoCAD entities using LINQ"
date: "2013-01-30 18:13:17"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "LINQ"
  - "RealDWG"
  - "Selection"
original_url: "https://www.keanw.com/2013/01/filtering-lists-of-autocad-entities-using-linq.html "
typepad_basename: "filtering-lists-of-autocad-entities-using-linq"
typepad_status: "Publish"
---

<p><a href="http://through-the-interface.typepad.com/through_the_interface/2013/01/performing-boolean-operations-on-autocad-solids-using-net.html#comment-6a00d83452464869e2017ee7fe6781970d" target="_blank">A comment</a> on <a href="http://through-the-interface.typepad.com/through_the_interface/2013/01/performing-boolean-operations-on-autocad-solids-using-net.html" target="_blank">the last post</a> made me think it’s probably worth diving into <a href="http://msdn.microsoft.com/en-us/library/vstudio/bb397926.aspx" target="_blank">LINQ</a> a bit further, as there’s clearly interest out there. Now I don’t actually use LINQ very much but whenever I do I tell myself I ought to use it more – it’s really very useful.</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2017c366cd4a6970b-pi" target="_blank"><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 0px 20px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Chain" border="0" alt="Chain" align="right" src="/assets/image_279280.jpg" width="163" height="149" /></a>A lot of LINQ is derived from the world of <a href="http://en.wikipedia.org/wiki/Functional_programming" target="_blank">Functional Programming</a> – in that it allows you to use <a href="http://en.wikipedia.org/wiki/Higher-order_function" target="_blank">higher order functions</a> to manipulate data – and it’s really just another way in which .NET languages have been influenced by FP (and have evolved to incorporate its techniques in their increasingly <a href="http://en.wikipedia.org/wiki/Multi-paradigm_programming_language#Multi-paradigm_programming_language" target="_blank">multi-paradigm</a> nature). This is a good thing.</p>  <p>When I think about using LINQ, I therefore tend to think back to “functional” languages – whether F# or LISP – to think about the types of operation that would streamline the process I’m trying to implement.</p>  <p>In the last post, we wanted to return the tail of a list (which means everything but the head, i.e. the first item). I chose to pass in the PromptSelectionResult object, as I felt it was more efficient to work from that directly:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] AllButFirst(</span><span style="line-height: 140%; color: #2b91af">PromptSelectionResult</span><span style="line-height: 140%"> psr)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Use LINQ to skip the first item in the IEnumerable</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// and then return the results as an ObjectId array</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; psr.Value.Cast&lt;</span><span style="line-height: 140%; color: #2b91af">SelectedObject</span><span style="line-height: 140%">&gt;().Skip(1).</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Select(o =&gt; { </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> o.ObjectId; }).ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>Breaking this down a little, we perform a cast on the contents of the IEnumerable (the Value property of PromptSelectionResult is a SelectionSet, which implements the IEnumerable interface), so that we know they’re SelectedObjects, and Skip the first of these results before using Select() to essentially <a href="http://en.wikipedia.org/wiki/Map_(higher-order_function)" target="_blank">map</a> to a list of the referenced ObjectIds. And then we call ToArray() on the results to return an array of ObjectIds.</p>  <p>This is all well and good, but it’s a little specific to selection (in that it takes a PromptSelectionResult parameter). To generalise the behaviour – and make it ultimately more flexible – we can adjust the function to take an ObjectId array instead (as this is also an enumerable data-type in .NET):</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] AllButFirst(</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] arr)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> arr.Skip&lt;</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">&gt;(1).ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>This is a bit simpler – as we no longer need to cast to an enumerable list of SelectedObjects and then map from these to ObjectIds – but means that we’re going to have to pass in an ObjectId array from the PromptSelectionResult object. We can do this via the GetObjectIds() method, which we assume (and this is really an important point) will return an array of ObjectIds in the order in which the objects were selected.</p>  <p>Let’s take a look at another example of using LINQ… this time we’ll essentially use it to filter a list of ObjectIds based on the type of object each belongs to. Here’s one version, which uses the LINQ extension methods to do the work in much the same way as we’ve seen above:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] OnlyOfClass(</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] ids, </span><span style="line-height: 140%; color: #2b91af">RXClass</span><span style="line-height: 140%"> c)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ids.Where(id =&gt; { </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> id.ObjectClass == c; }).ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>The beauty of this technique is that we don’t even need to open the object: the ObjectId class has a property that returns the type of the identified object. If we did need to go further, then it’d probably make sense to use the dynamic capabilities of ObjectId to open and close the associated object implicitly. But that’s for another day.</p>  <p>Now let’s rework the code a little to use the more elegant and “language-integrated” form (which is really just <a href="http://en.wikipedia.org/wiki/Syntactic_sugar" target="_blank">syntactic sugar</a> – I haven’t actually taken the time to check but would expect the generated <a href="http://en.wikipedia.org/wiki/Common_Intermediate_Language" target="_blank">IL</a> to be very similar if not identical).</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] OnlyOfClass2(</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] ids, </span><span style="line-height: 140%; color: #2b91af">RXClass</span><span style="line-height: 140%"> c)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> id </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> ids </span><span style="line-height: 140%; color: blue">where</span><span style="line-height: 140%"> id.ObjectClass == c </span><span style="line-height: 140%; color: blue">select</span><span style="line-height: 140%"> id).ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>To give these functions a try, let's now implement a quick command that allows you to select a bunch of objects and filter the results. I haven’t bothered implementing multiple commands for the different function alternatives (or to try with different object types) – that’s been left up to the reader.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> System.Linq;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> SelectionManipulation</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Commands</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;SELFIL&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> FilterSelection()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> doc = </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> psr = ed.GetSelection();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (psr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ids =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; OnlyOfClass(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; psr.Value.GetObjectIds(),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RXClass</span><span style="line-height: 140%">.GetClass(</span><span style="line-height: 140%; color: blue">typeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Line</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> tr = doc.TransactionManager.StartTransaction())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</span><span style="line-height: 140%; color: #a31515">&quot;\nFound {0} objects.&quot;</span><span style="line-height: 140%">, ids.Length);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">foreach</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> id </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> ids)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> obj = tr.GetObject(id, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nThis object is really a {0}.&quot;</span><span style="line-height: 140%">, obj.GetType().Name</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] AllButFirst(</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] arr)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> arr.Skip&lt;</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">&gt;(1).ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] OnlyOfClass(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] ids, </span><span style="line-height: 140%; color: #2b91af">RXClass</span><span style="line-height: 140%"> c</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ids.Where(id =&gt; { </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> id.ObjectClass == c; }).ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] OnlyOfClass2(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">[] ids, </span><span style="line-height: 140%; color: #2b91af">RXClass</span><span style="line-height: 140%"> c</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> id </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> ids </span><span style="line-height: 140%; color: blue">where</span><span style="line-height: 140%"> id.ObjectClass == c </span><span style="line-height: 140%; color: blue">select</span><span style="line-height: 140%"> id).</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ToArray();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>When we run the SELFIL command and select a number of entities – not all of which are lines – we will see something like this reported to the command-line:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">Command: <font color="#ff0000">SELFIL</font></span></p>    <p style="margin: 0px"><span style="line-height: 140%">Select objects: Specify opposite corner: 8 found</span></p>    <p style="margin: 0px"><span style="line-height: 140%">Select objects:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">Found 5 objects.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">This object is really a Line.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">This object is really a Line.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">This object is really a Line.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">This object is really a Line.</span></p>    <p style="margin: 0px"><span style="line-height: 140%">This object is really a Line.</span></p> </div>  <p>In most cases, I’d expect people to want to implement <a href="http://through-the-interface.typepad.com/through_the_interface/2008/07/conditional-sel.html" target="_blank">a SelectionFilter</a> to have this more “up-front” in the process – just as we saw last time for the user to only select Solid3d objects – but there are definitely cases where this is helpful. RealDWG clients, for instance, don’t have the Editor available to integrate more closely with AutoCAD’s selection mechanism, and so really need some way to easily filter large sets of entities. This approach should certainly help in that situation.</p> <font color="#a5a5a5">photo credit: </font><a href="http://www.flickr.com/photos/jamesjordan/3047451680/"><font color="#a5a5a5">James Jordan</font></a><font color="#a5a5a5"> via </font><a href="http://photopin.com"><font color="#a5a5a5">photopin</font></a><font color="#a5a5a5"> </font><a href="http://creativecommons.org/licenses/by-nd/2.0/"><font color="#a5a5a5">cc</font></a>
