---
layout: "post"
title: "Dynamo 2.7 &ndash; Migrating MaRS to CPython3"
date: "2020-07-23 18:22:55"
author: "Kean Walmsley"
categories:
  - "Autodesk"
  - "Dynamo"
original_url: "https://www.keanw.com/2020/07/dynamo-27-migrating-mars-to-cpython3.html "
typepad_basename: "dynamo-27-migrating-mars-to-cpython3"
typepad_status: "Publish"
---

<p>After being teased with <a href="https://dynamobim.org/dynamo-graphics-updates/" target="_blank">some graphics improvements coming in Dynamo</a>, I was excited to find on returning from <a href="https://www.keanw.com/2020/07/a-swiss-staycation.html" target="_blank">my recent holiday</a> to find <a href="https://dynamobim.org/dynamo-core-2-7-release/" target="_blank">a new release of Dynamo Sandbox was available for testing</a>. There are a number of notable features available in Dynamo 2.7, whether the ability to run CPython3 code – rather than using IronPython, which is based on Python2 – or improved graphics preview performance thanks to an upgrade to <a href="https://github.com/helix-toolkit/helix-toolkit" target="_blank">Helix</a>.</p><p>I started by just loading v2 of the <a href="http://autode.sk/mars-graph" target="_blank">MaRS graph</a>, without changing any of the code blocks to use CPython. Straightaway I found that the graphics performance when zooming and panning was improved when compared with earlier versions of Dynamo, so I was immediately sold on the upgrade. Here’s a little zooming and panning of the MaRS graph’s graphical output. It’s still slow to navigate the node view, but this is a helpful improvement for the graphics preview.</p><p><a href="https://through-the-interface.typepad.com/.a/6a00d83452464869e20263e957feda200b-pi" target="_blank"><img alt="Zoom and pan" height="312" src="/assets/image_832725.jpg" style="margin: 30px auto; float: none; display: block;" title="Zoom and pan" width="500" /></a></p><p>For fun I started fooling around with <a href="https://forum.dynamobim.com/t/new-feature-preview-python-3-support-issue-thread/51649" target="_blank">changing the various Python nodes to use CPython3 instead of IronPython2</a>. Here are some notes I made regarding the issues I needed to fix in the various code blocks.</p><ul><li><strong>TypeError : No method matches given arguments for <em>method</em></strong></li><ul><li>This usually seems to be due to a mismatch between ints and floats, something that is presumably done implicitly in IronPython. This is apparently <a href="https://github.com/DynamoDS/Dynamo/wiki/Work-in-progress-to-improve-Python-3-support" target="_blank">a known issue and will be fixed in Dynamo 2.8</a>, so I suggest waiting for that release before attempting major Python upgrades – otherwise you may find that you need to add a “.0” suffix to integer constants in your code.</li></ul><li><strong>TabError : inconsistent use of tabs and spaces in indentation</strong></li><ul><li>IronPython <em>seems</em> more tolerant of mixing spaces and tabs in your Python code. In reality it’s not that simple, though: when this was reported and I replaced all remaining tabs with spaces, the logic changed in one of our metrics: we were accumulating values in a nested loop, and the resultant value was actually wrong! You can see this in the “fixed” graphics above, where the congestion map is much darker. Moving to CPython should help identify and fix this class of lurking bug!</li></ul><li><strong>SynchronizationLockException : Object synchronization method was called from an unsynchronized block of code</strong></li><ul><li>We’d introduced a number of Parallel.For calls into the graph (via an optional “Parallelize” flag that is set to false by default). Because of this we had a critical section where shared data was protected via Monitor.Enter and Monitor.Exit. For simplicity I removed all use of Parallel.For and the Monitor object, too.</li></ul><li><strong>TypeError : &#39;&gt;&#39; not supported between instances of &#39;list&#39; and &#39;int&#39;</strong></li><ul><li>This highlighted a bug in our code where we were incorrectly comparing a list of floats with a numeric value. I have no idea how this didn’t cause an issue before, but summing the list first seemed to be the answer to this one.</li></ul><li><strong>TypeError : No method matches given arguments for Flatten</strong></li><ul><li>List.Flatten could not be found for love nor money. This one drove me completely potty. In the end I flattened the lists outside the code block using Dynamo nodes and passed them in as additional arguments.</li></ul><li><strong>AttributeError : &#39;zip&#39; object has no attribute &#39;sort&#39;</strong></li><ul><li>I had to call list() on the results of a zip(), to make sure I could then sort() it. It’s possible that zip() returns an enumerable object that isn’t strictly a list, so CPython apparently requires this additional step.</li></ul></ul><p>Overall I will say that the effort required wasn’t enormous for this particular graph, which does contain quite a lot of Python code. I would recommend holding off porting major graphs until at least Dynamo 2.8 (given the fact the first category of migration problem above will not need to be fixed in that release). Hopefully this list will be of use to you when you do embark on any migration to CPython3.</p>
