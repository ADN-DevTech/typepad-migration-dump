---
layout: "post"
title: "Gluing a point to an AutoCAD curve using overrules from .NET &ndash; Part 3"
date: "2009-08-31 23:27:39"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Drawing structure"
  - "Geometry"
  - "Overrules"
original_url: "https://www.keanw.com/2009/08/gluing-a-point-to-an-autocad-curve-using-overrules-from-net-part-3.html "
typepad_basename: "gluing-a-point-to-an-autocad-curve-using-overrules-from-net-part-3"
typepad_status: "Publish"
---

<p>In <a href="http://through-the-interface.typepad.com/through_the_interface/2009/08/gluing-a-point-to-an-autocad-curve-using-overrules-from-net-part-1-1.html">the most recent part of this series</a>, we looked at one possible mechanism to allow points to be moved along a network of curves, extending <a href="http://through-the-interface.typepad.com/through_the_interface/2009/08/gluing-a-point-to-an-autocad-curve-using-overrules-from-net-part-1.html">the first part in this series</a>, which focused on the case of a point on a single curve.</p>  <p>This post is going to focus on something slightly different: it’s going to look at making the points added to a particular curve be associative to that curve – i.e. travel along with it as the curve is moved – and in the process we’re going to adjust the way we link between our objects, by moving the information into an object’s Extended Entity Data (XData). This does a few things: firstly it breaks our network-related technique (never fear – we’ll be able to get it back, in due course :-) by removing the idea of a central list of curves. It also allows us to have points that are connected to curves, and points that are not (which is clearly desirable). It also lays a more solid foundation for other operations, such as erasing the points on a curve when the curve itself is erased. All good stuff.</p>  <p>Just to be clear: there are lots of ways ways to approach this problem – this is just another possible mechanism – so you might be interested in <a href="http://through-the-interface.typepad.com/through_the_interface/2006/11/linking_circles.html">checking</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2006/11/linking_circles_1.html">out</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2006/12/linking_circles_1.html">this</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2006/12/linking_circles.html">previous</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2006/12/linking_circles_2.html">series</a>, which addressed a similar problem a little differently.</p>  <p>For now let’s see this basic implementation of our XData-related code. Here’s the C# code:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%; color: blue">namespace</span><span style="line-height: 140%"> PointOnCurveTest</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">LinkApplication</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> regAppName = </span><span style="line-height: 140%; color: #a31515">&quot;TTIF_PTS&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">class</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">LinkTransOverrule</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #2b91af">TransformOverrule</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> _transforming = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// A static pointer to our overrule instance</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">LinkTransOverrule</span><span style="line-height: 140%"> theOverrule =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">LinkTransOverrule</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// A flag to indicate whether we're overruling</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> overruling = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our overrule should only be applied to objects</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// carrying our XData</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> LinkTransOverrule()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; SetXDataFilter(regAppName);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Turn on the transform overrule if it isn't already</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> TurnOn()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!overruling)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectOverrule</span><span style="line-height: 140%">.AddOverrule(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RXClass</span><span style="line-height: 140%">.GetClass(</span><span style="line-height: 140%; color: blue">typeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Entity</span><span style="line-height: 140%">)),</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">LinkTransOverrule</span><span style="line-height: 140%">.theOverrule,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">true</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; overruling = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">TransformOverrule</span><span style="line-height: 140%">.Overruling = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Turn off the transform overrule if it's on</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> TurnOff()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (overruling)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectOverrule</span><span style="line-height: 140%">.RemoveOverrule(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RXClass</span><span style="line-height: 140%">.GetClass(</span><span style="line-height: 140%; color: blue">typeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Entity</span><span style="line-height: 140%">)),</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">LinkTransOverrule</span><span style="line-height: 140%">.theOverrule</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; overruling = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">TransformOverrule</span><span style="line-height: 140%">.Overruling = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our primary overruled function</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">override</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> TransformBy(</span><span style="line-height: 140%; color: #2b91af">Entity</span><span style="line-height: 140%"> e, </span><span style="line-height: 140%; color: #2b91af">Matrix3d</span><span style="line-height: 140%"> mat)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If we're already transforming, don't re-enter, just</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// super-message to the base</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (_transforming)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">base</span><span style="line-height: 140%">.TransformBy(e, mat);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db = </span><span style="line-height: 140%; color: #2b91af">HostApplicationServices</span><span style="line-height: 140%">.WorkingDatabase;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Otherwise get our linked objects: check whether</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// there are any</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectIdCollection</span><span style="line-height: 140%"> ids = GetLinkedObjects(e);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ids.Count &gt; 0)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If we're dealing with a point...</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBPoint</span><span style="line-height: 140%"> pt = e </span><span style="line-height: 140%; color: blue">as</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">DBPoint</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pt != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Work through the curves to find the closest to our</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// transformed point</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">double</span><span style="line-height: 140%"> min = 0.0;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> bestPt = </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%">.Origin;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> first = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> bestId = </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">.Null;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// We're using an Open/Close transaction, to avoid</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// problems with us using transactions in an event</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// handler</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenCloseTransaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.TransactionManager.StartOpenCloseTransaction();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// For now linked objects can be curves, else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// they'll be ignored</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Curve</span><span style="line-height: 140%"> cur;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">foreach</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> curId </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> ids)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBObject</span><span style="line-height: 140%"> obj =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetObject(curId, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If our linked object was erased, remove it</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// from this object's links</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (obj.IsErased)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RemoveLinkedObject(e, curId);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Otherwise we get the closest point on it</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// to our point, to compare with others</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cur = obj </span><span style="line-height: 140%; color: blue">as</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Curve</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (cur != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> ptLoc =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pt.Position.TransformBy(mat);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> ptOnCurve =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cur.GetClosestPointTo(ptLoc, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Vector3d</span><span style="line-height: 140%"> dist = ptOnCurve - ptLoc;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (first || dist.Length &lt; min)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; first = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; min = dist.Length;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bestPt = ptOnCurve;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bestId = curId;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If we didn't find a point, super-message</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (will transform the point as normal)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (first)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">base</span><span style="line-height: 140%">.TransformBy(e, mat);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pt.Position = bestPt;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (e </span><span style="line-height: 140%; color: blue">is</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Curve</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Automatically super-message: we're not changing the</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// transform behaviour of the curve, only of the</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// linked objects</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">base</span><span style="line-height: 140%">.TransformBy(e, mat);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get each linked object and transform it along with</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// the &quot;parent&quot;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenCloseTransaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.TransactionManager.StartOpenCloseTransaction();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">foreach</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> id </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> ids)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBObject</span><span style="line-height: 140%"> obj = tr.GetObject(id, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForWrite);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Entity</span><span style="line-height: 140%"> ent = obj </span><span style="line-height: 140%; color: blue">as</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Entity</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (ent != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _transforming = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ent.TransformBy(mat);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _transforming = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Function to add a reference between one object and another</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (stored in an object's XData)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> AddLinkedObject(</span><span style="line-height: 140%; color: #2b91af">DBObject</span><span style="line-height: 140%"> obj, </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> id)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">HostApplicationServices</span><span style="line-height: 140%">.WorkingDatabase;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// First we need to make sure our application name is</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// in the Registered Application Table</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenCloseTransaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.TransactionManager.StartOpenCloseTransaction();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RegAppTable</span><span style="line-height: 140%"> rat =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">RegAppTable</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.RegAppTableId, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!rat.Has(regAppName))</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rat.UpgradeOpen();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">RegAppTableRecord</span><span style="line-height: 140%"> ratr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">RegAppTableRecord</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ratr.Name = regAppName;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(ratr, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rat.Add(ratr);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get our object's current XData</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%"> rb = obj.XData;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Check the XData, to see whether our link already exists</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> foundLink = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (rb != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> foundStart = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">foreach</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%"> tv </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> rb)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// The first TypedValue is our application name</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tv.TypeCode ==</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataRegAppName &amp;&amp;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tv.Value.ToString() == regAppName)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; foundStart = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (foundStart)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our links will all have the same code (1005)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tv.TypeCode == (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataHandle)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (id.Handle.ToString() == tv.Value.ToString())</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; foundLink = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If we didn't find the link, add it</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!foundLink)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// This is our link</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%"> tv2 =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataHandle, id.Handle</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If there was no previous XData, create the ResultBuffer</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (rb == </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rb =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataRegAppName,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; regAppName</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tv2</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Add our TypeValue to an existing ResultBuffer</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rb.Add(tv2);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Set the XData on our object</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.XData = rb;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; rb.Dispose();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Function to remove a reference from one object to another</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (stored in an object's XData)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> RemoveLinkedObject(</span><span style="line-height: 140%; color: #2b91af">DBObject</span><span style="line-height: 140%"> obj, </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> id)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the existing XData</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%"> oldRb = obj.XData;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Create a ResultBuffer for the &quot;filtered&quot; XData</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (will contain all the old links, except the one we want</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// to remove)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%"> newRb =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataRegAppName,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; regAppName)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> foundLink = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (oldRb != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> foundStart = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Loop through the XData</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">foreach</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%"> tv </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> oldRb)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// The first TypedValue is our application name</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tv.TypeCode ==</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataRegAppName &amp;&amp;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tv.Value.ToString() == regAppName)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; foundStart = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (foundStart)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our links will all have the same code (1005)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tv.TypeCode == (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataHandle)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If the link is not the one we want to remove,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// add it to our list of XData to retain,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// otherwise set a flag to say we found it</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (id.Handle.ToString() != tv.Value.ToString())</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; newRb.Add(tv);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; foundLink = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// If we found the link (and therefore have XData to set)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// change the object's XData</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (foundLink)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.XData = newRb;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Clean-up after ourselves</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; oldRb.Dispose();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; newRb.Dispose();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Function to retrieve the references from one object to another</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// (stored in an object's XData)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectIdCollection</span><span style="line-height: 140%"> GetLinkedObjects(</span><span style="line-height: 140%; color: #2b91af">DBObject</span><span style="line-height: 140%"> obj)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">HostApplicationServices</span><span style="line-height: 140%">.WorkingDatabase;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Will return an ObjectIdCollection</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectIdCollection</span><span style="line-height: 140%"> ids = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">ObjectIdCollection</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the object's XData</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">ResultBuffer</span><span style="line-height: 140%"> rb = obj.XData)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (rb != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> foundStart = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">foreach</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">TypedValue</span><span style="line-height: 140%"> tv </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> rb)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// The first TypedValue is our application name</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tv.TypeCode ==</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataRegAppName &amp;&amp;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tv.Value.ToString() == regAppName)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; foundStart = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (foundStart)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our links will all have the same code (1005)</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (tv.TypeCode == (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)</span><span style="line-height: 140%; color: #2b91af">DxfCode</span><span style="line-height: 140%">.ExtendedDataHandle)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get the long integer from the string stored in</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// our XData, and the Handle from the long</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">long</span><span style="line-height: 140%"> lg =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.</span><span style="line-height: 140%; color: #2b91af">Convert</span><span style="line-height: 140%">.ToInt64(tv.Value.ToString(), 16);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Handle</span><span style="line-height: 140%"> hd = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Handle</span><span style="line-height: 140%">(lg);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// And then the ObjectId from the Handle</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> id = db.GetObjectId(</span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, hd, -1);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Add it to our list, if it isn't already in it</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!ids.Contains(id))</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ids.Add(id);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> ids;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;POC&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> CreatePointOnCurve()</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Ask the user to select a curve</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptEntityOptions</span><span style="line-height: 140%"> opts =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptEntityOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nSelect curve at the point to create: &quot;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; opts.SetRejectMessage(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nEntity must be a curve.&quot;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; opts.AddAllowedClass(</span><span style="line-height: 140%; color: blue">typeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">Curve</span><span style="line-height: 140%">), </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">PromptEntityResult</span><span style="line-height: 140%"> per = ed.GetEntity(opts);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> curId = per.ObjectId;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (curId != </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%">.Null)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Let's make sure we'll be able to see our point</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.Pdmode = 97;&#160; </span><span style="line-height: 140%; color: green">// square with a circle</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.Pdsize = -10; </span><span style="line-height: 140%; color: green">// relative to the viewport size</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Transaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.TransactionManager.StartTransaction();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBObject</span><span style="line-height: 140%"> obj =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.GetObject(curId, </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Curve</span><span style="line-height: 140%"> cur = obj </span><span style="line-height: 140%; color: blue">as</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Curve</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (cur != </span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Our initial point should be the closest point</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// on the curve to the one picked</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Point3d</span><span style="line-height: 140%"> pos =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cur.GetClosestPointTo(per.PickedPoint, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">DBPoint</span><span style="line-height: 140%"> pt = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">DBPoint</span><span style="line-height: 140%">(pos);</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Add it to the same space as the curve</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%"> btr =</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cur.BlockId,</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">OpenMode</span><span style="line-height: 140%">.ForWrite</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> ptId = btr.AppendEntity(pt);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AddLinkedObject(pt, curId);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cur.UpgradeOpen();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AddLinkedObject(cur, ptId);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(pt, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</span></p>    <p style="margin: 0px; font-size: 8pt">&#160;</p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">LinkTransOverrule</span><span style="line-height: 140%">.TurnOn();</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px; font-size: 8pt"><span style="line-height: 140%">}</span></p> </div> <!--EndFragment-->  <p>Some points to note about this implementation:</p>  <ul>   <li>We now register the overrule to work for all entity types, but at the same time we tell AutoCAD to filter on our Register Application Name      <ul>       <li>Only objects with our XData will cause the overrule to be called </li>     </ul>   </li>    <li>Our TransformBy() function will therefore apply to all entities with our XData, although we’re only (currently) interested in DBPoints and Curves      <ul>       <li>We do need to stop the function re-entering for the points we transform along with the parent curve, but that’s a simple matter of setting/checking a boolean flag </li>     </ul>   </li>    <li>We have kept the technique of checking a number of curves, to see which is closest, but as we’re only adding the XData during the POC command – which currently only allows selection of a single curve – the behaviour is now once again similar to the first post in the series (although this is very easy to change) </li> </ul>  <p>Now let’s see what happens when our code is executed. We’ll take the same drawing as last time – which contains a Spline and a Polyline – and use the POC command to add a few points on each:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a58fefe6970c-pi"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Two points on each curve" border="0" alt="Two points on each curve" src="/assets/image_876525.jpg" width="485" height="212" /></a> </p>  <p>When we move the Spline, we see the points on it now move along with it:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a58ff058970c-pi"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Moving the spline with its points" border="0" alt="Moving the spline with its points" src="/assets/image_417674.jpg" width="485" height="213" /></a> </p>  <p>What’s interesting is that when we do the same for a Polyline, the points don’t appear during the drag…</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a58ff0b9970c-pi"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Moving the polyline without its points" border="0" alt="Moving the polyline without its points" src="/assets/image_459671.jpg" width="485" height="213" /></a> </p>  <p>… but they do, indeed, show up in the right place once the Polyline has completed the move to its destination:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a58ff102970c-pi"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Both curves moved with their points" border="0" alt="Both curves moved with their points" src="/assets/image_62060.jpg" width="485" height="214" /></a> </p>  <p>This is apparently due to optimization inside AutoCAD: during a recent discussion with our Engineering team I learned that during certain operations – such as when a modification to an object or set of objects can be represented by a standard transformation (such as scale, rotate or move) – AutoCAD captures the graphics of those objects and then performs a “sprite” optimization to move the object(s), rather than continually asking the object(s) to participate in the movement by drawing their own graphics or by transforming their internal state.</p>  <p>It’s not fully clear to me why this is happening in this particular situation – and with the Polyline rather than the Spline – but it does appear that this optimization has been turned on during the movement of the Polyline. This only occurs in very specific situations – such as in 3D rather than 2D – but it does seem something that would be valuable for applications to have more explicit control over.</p>  <p>That’s it for today’s post. I’m actually on vacation this week, but I do have something to share later in the week related to our “Plugin on the Month” initiative…</p>
