---
layout: "post"
title: "Displaying a graph of AutoCAD drawing objects using JavaScript and .NET"
date: "2014-11-07 09:59:29"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "HTML"
  - "JavaScript"
  - "LINQ"
  - "Notification / Events"
  - "User interface"
original_url: "https://www.keanw.com/2014/11/displaying-a-graph-of-autocad-drawing-objects-using-javascript-and-net.html "
typepad_basename: "displaying-a-graph-of-autocad-drawing-objects-using-javascript-and-net"
typepad_status: "Publish"
---

<p>It seems like I’ve been living in JavaScript land (and no, I deliberately didn’t say “hell” – it’s actually been fun :-) for the last few weeks, between one thing or another. But I think I’ve finally put the finishing touches on the last of the JavaScript API samples I’ve prepared for <a href="http://au.autodesk.com" target="_blank">AU 2014</a>.</p>  <p>This sample was inspired by Jim Awe – an old friend and colleague – who is working on something similar for another platform. So I can’t take any credit for the way it works, just for the plumbing it took to make it work with AutoCAD.</p>  <p>It’s basically an HTML palette using a handy open source library called <a href="http://d3js.org" target="_blank">D3.js</a> – for Data-Driven Documents – and <a href="http://d3pie.org" target="_blank">d3pie</a>, a layer on top of that to simplify creating pie charts. The palette connects to the active drawing and asks to .NET to provides some data on the entities inside modelspace. From our .NET code we use LINQ to query the types of object from the modelspace’s ObjectIds, which we then package up as JSON and return for display in HTML.</p>  <p>This is all that’s needed to get this data, in case – it can all be done via the ObjectId without opening any of the entities (just the modelspace). LINQ is really great at this kind of query.</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">var</span> q =</p>    <p style="margin: 0px">&#160; <span style="color: blue">from</span> <span style="color: #2b91af">ObjectId</span> o <span style="color: blue">in</span> ms</p>    <p style="margin: 0px">&#160; <span style="color: blue">group</span> o <span style="color: blue">by</span> o.ObjectClass.DxfName <span style="color: blue">into</span> counts</p>    <p style="margin: 0px">&#160; <span style="color: blue">select</span> <span style="color: blue">new</span> { Count = counts.Count(), Group = counts.Key };</p> </div>  <p>When the user clicks on a wedge in the pie chart – representing the objects of a particular type – those objects get places in the pickfirst selection set, ready for something to be done with them.</p>  <p>Here’s a screencast of the application working:</p>  <br /><iframe height="264" src="https://screencast.autodesk.com/Embed/7ca5895c-c216-4be9-9b5b-74d229bad7c4" frameborder="0" width="470" webkitallowfullscreen="webkitallowfullscreen" allowfullscreen="allowfullscreen"></iframe>  <br />  <br />  <p>Here’s the HTML…</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: maroon">!doctype</span> <span style="color: red">html</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: maroon">html</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: maroon">head</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">title</span><span style="color: blue">&gt;</span>Chart<span style="color: blue">&lt;/</span><span style="color: maroon">title</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">link</span> <span style="color: red">rel</span><span style="color: blue">=&quot;stylesheet&quot;</span> <span style="color: red">href</span><span style="color: blue">=&quot;style.css&quot;&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">style</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: maroon">html</span>, <span style="color: maroon">body</span> { <span style="color: red">height</span>: <span style="color: blue">100%</span>; <span style="color: red">width</span>: <span style="color: blue">100%</span>; <span style="color: red">margin</span>: <span style="color: blue">0</span>; <span style="color: red">padding</span>: <span style="color: blue">0</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: maroon">body</span> { <span style="color: red">display</span>: <span style="color: blue">table</span>; }</p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">style</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: red">src</span><span style="color: blue">=&quot;http://app.autocad360.com/jsapi/v2/Autodesk.AutoCAD.js&quot;&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">src</span><span style="color: blue">=&quot;js/acadext2.js&quot;&gt;&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">src</span><span style="color: blue">=&quot;js/d3.min.js&quot;&gt;&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">src</span><span style="color: blue">=&quot;js/d3pie.min.js&quot;&gt;&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">src</span><span style="color: blue">=&quot;js/chart.js&quot;&gt;&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: maroon">head</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: maroon">body</span> <span style="color: red">onload</span><span style="color: blue">=&quot;</span>init();<span style="color: blue">&quot;&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">div</span> <span style="color: red">id</span><span style="color: blue">=&quot;pieChart&quot;</span> <span style="color: red">class</span><span style="color: blue">=&quot;centered-on-page&quot;&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">div</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: maroon">body</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: maroon">html</span><span style="color: blue">&gt;</span></p> </div>  <p>Here’s the JavaScript, including the Shaping Layer extensions…</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">function</span> getObjectCountsFromAutoCAD() {</p>    <p style="margin: 0px">&#160; <span style="color: blue">var</span> jsonResponse =</p>    <p style="margin: 0px">&#160;&#160;&#160; exec(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; JSON.stringify({</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; functionName: <span style="color: #a31515">'GetObjectCountData'</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; invokeAsCommand: <span style="color: blue">false</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; functionParams: undefined</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; })</p>    <p style="margin: 0px">&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160; <span style="color: blue">var</span> jsonObj = JSON.parse(jsonResponse);</p>    <p style="margin: 0px">&#160; <span style="color: blue">if</span> (jsonObj.retCode !== Acad.ErrorStatus.eJsOk) {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">throw</span> Error(jsonObj.retErrorString);</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">&#160; <span style="color: blue">return</span> jsonObj.result;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> selectObjectsOfType(jsonArgs) {</p>    <p style="margin: 0px">&#160; <span style="color: blue">var</span> jsonResponse =</p>    <p style="margin: 0px">&#160;&#160;&#160; exec(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; JSON.stringify({</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; functionName: <span style="color: #a31515">'SelectObjectsOfType'</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; invokeAsCommand: <span style="color: blue">false</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; functionParams: jsonArgs</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; })</p>    <p style="margin: 0px">&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160; <span style="color: blue">var</span> jsonObj = JSON.parse(jsonResponse);</p>    <p style="margin: 0px">&#160; <span style="color: blue">if</span> (jsonObj.retCode !== Acad.ErrorStatus.eJsOk) {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">throw</span> Error(jsonObj.retErrorString);</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">&#160; <span style="color: blue">return</span> jsonObj.result;</p>    <p style="margin: 0px">}</p> </div>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">var</span> _pie = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> init() {</p>    <p style="margin: 0px">&#160; registerCallback(<span style="color: #a31515">&quot;refpie&quot;</span>, refreshPie);</p>    <p style="margin: 0px">&#160; loadPieData();</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> refreshPie(args) {</p>    <p style="margin: 0px">&#160; loadPieData();</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> loadPieData() {</p>    <p style="margin: 0px">&#160; <span style="color: blue">var</span> pieOpts = setupPieDefaults();</p>    <p style="margin: 0px">&#160; <span style="color: blue">try</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">var</span> contents = getObjectCountsFromAutoCAD();</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (contents) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; pieOpts.data = contents;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_pie)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _pie.destroy();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _pie = <span style="color: blue">new</span> d3pie(<span style="color: #a31515">&quot;pieChart&quot;</span>, pieOpts);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">&#160; <span style="color: blue">catch</span> (ex) {</p>    <p style="margin: 0px">&#160;&#160;&#160; _pie.destroy();</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> clickPieWedge(evt) {</p>    <p style="margin: 0px">&#160; selectObjectsOfType(</p>    <p style="margin: 0px">&#160;&#160;&#160; { <span style="color: #a31515">&quot;class&quot;</span>: evt.data.label, <span style="color: #a31515">&quot;expanded&quot;</span>: evt.expanded }</p>    <p style="margin: 0px">&#160; );</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">function</span> setupPieDefaults() {</p>    <p style="margin: 0px">&#160; <span style="color: blue">var</span> pieDefaults = {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;header&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;title&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;text&quot;</span>: <span style="color: #a31515">&quot;Object Types&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;fontSize&quot;</span>: 24,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;font&quot;</span>: <span style="color: #a31515">&quot;Calibri&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;subtitle&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;text&quot;</span>: <span style="color: #a31515">&quot;Quantities of objects in modelspace.&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;color&quot;</span>: <span style="color: #a31515">&quot;#999999&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;fontSize&quot;</span>: 12,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;font&quot;</span>: <span style="color: #a31515">&quot;Calibri&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;titleSubtitlePadding&quot;</span>: 9</p>    <p style="margin: 0px">&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;data&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// nothing initially</span></p>    <p style="margin: 0px">&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;footer&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;color&quot;</span>: <span style="color: #a31515">&quot;#999999&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;fontSize&quot;</span>: 10,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;font&quot;</span>: <span style="color: #a31515">&quot;Calibri&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;location&quot;</span>: <span style="color: #a31515">&quot;bottom-left&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;size&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;canvasWidth&quot;</span>: 400,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;pieInnerRadius&quot;</span>: <span style="color: #a31515">&quot;49%&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;pieOuterRadius&quot;</span>: <span style="color: #a31515">&quot;81%&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;labels&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;outer&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;pieDistance&quot;</span>: 32</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;inner&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//&quot;hideWhenLessThanPercentage&quot;: 3,</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;format&quot;</span>: <span style="color: #a31515">&quot;value&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;mainLabel&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;fontSize&quot;</span>: 11</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;percentage&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;color&quot;</span>: <span style="color: #a31515">&quot;#ffffff&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;decimalPlaces&quot;</span>: 0</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;value&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;color&quot;</span>: <span style="color: #a31515">&quot;#adadad&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;fontSize&quot;</span>: 11</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;lines&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;enabled&quot;</span>: <span style="color: blue">true</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;effects&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;pullOutSegmentOnClick&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;effect&quot;</span>: <span style="color: #a31515">&quot;linear&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;speed&quot;</span>: 400,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;size&quot;</span>: 8</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;misc&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;gradient&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;enabled&quot;</span>: <span style="color: blue">true</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;percentage&quot;</span>: 100</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; },</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">&quot;callbacks&quot;</span>: {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; onClickSegment: clickPieWedge</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: blue">return</span> pieDefaults;</p>    <p style="margin: 0px">}</p> </div>  <p>And here’s the C# code…</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Windows;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Newtonsoft.Json.Linq;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Linq;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Runtime.InteropServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Text;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> JavaScriptSamples</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">ChartCommands</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">PaletteSet</span> _chps = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">Document</span> _curDoc = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">bool</span> _refresh = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">DllImport</span>(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;AcJsCoreStub.crx&quot;</span>, CharSet = <span style="color: #2b91af">CharSet</span>.Auto,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; CallingConvention = <span style="color: #2b91af">CallingConvention</span>.Cdecl,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; EntryPoint = <span style="color: #a31515">&quot;acjsInvokeAsync&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">extern</span> <span style="color: blue">static</span> <span style="color: blue">private</span> <span style="color: blue">int</span> acjsInvokeAsync(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> name, <span style="color: blue">string</span> jsonArgs</p>    <p style="margin: 0px">&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;CHART&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> ChartPalette()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We're storing the &quot;launch document&quot; as we're attaching</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// various event handlers to it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _curDoc =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Only attach event handlers if the palette isn't already</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// there (in which case it will already have them)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> attachHandlers = (_chps == <span style="color: blue">null</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _chps =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Utils</span>.ShowPalette(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _chps,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">Guid</span>(<span style="color: #a31515">&quot;F76509E7-25E4-4415-8C67-2E92118F3B84&quot;</span>),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;CHART&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;D3.js Examples&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetHtmlPathChart()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (attachHandlers &amp;&amp; _curDoc != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; AddHandlers(_curDoc);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentManager.DocumentActivated +=</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; OnDocumentActivated;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _curDoc.BeginDocumentClose +=</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (s, e) =&gt;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RemoveHandlers(_curDoc);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _curDoc = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// When the PaletteSet gets destroyed we remove</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// our event handlers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _chps.PaletteSetDestroy += OnPaletteSetDestroy;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">JavaScriptCallback</span>(<span style="color: #a31515">&quot;SelectObjectsOfType&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> SelectObjectsOfType(<span style="color: blue">string</span> jsonArgs)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Default result is an error</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> res = <span style="color: #a31515">&quot;{\&quot;retCode\&quot;:1}&quot;</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> res;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ed = doc.Editor;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">//ed.SetImpliedSelection(new ObjectId[]{});</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Extract the DXF name to select from the JSON arguments</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> jo = <span style="color: #2b91af">JObject</span>.Parse(jsonArgs);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> dxfName = jo.Property(<span style="color: #a31515">&quot;class&quot;</span>).Value.ToString();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> expanded = (<span style="color: blue">bool</span>)jo.Property(<span style="color: #a31515">&quot;expanded&quot;</span>).Value;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We'll select all the entities of this class</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> tvs =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">TypedValue</span>[] {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">TypedValue</span>((<span style="color: blue">int</span>)<span style="color: #2b91af">DxfCode</span>.Start, dxfName)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// If the wedge is already expanded, we want to clear the</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// pickfirst set (so the default value is null)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">ObjectId</span>[] ids = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!expanded)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Perform the selection</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> sf = <span style="color: blue">new</span> <span style="color: #2b91af">SelectionFilter</span>(tvs);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> psr = ed.SelectAll(sf);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (psr.Status != <span style="color: #2b91af">PromptStatus</span>.OK)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> res;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Get the results in our array</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ids = psr.Value.GetObjectIds();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Set or clear the pickfirst selection</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.SetImpliedSelection(ids);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Set the focus on the main window for the update to display</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// (this works fine when floating, less well when docked)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.MainWindow.Focus();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Return success</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: #a31515">&quot;{\&quot;retCode\&quot;:0}&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">JavaScriptCallback</span>(<span style="color: #a31515">&quot;GetObjectCountData&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> GetObjectData(<span style="color: blue">string</span> jsonArgs)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: #a31515">&quot;{\&quot;retCode\&quot;:1}&quot;</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Initialize the JSON string to return the count information</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> sb =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">StringBuilder</span>(<span style="color: #a31515">&quot;{\&quot;retCode\&quot;:0, \&quot;result\&quot;:&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; sb.Append(<span style="color: #a31515">&quot;{\&quot;sortOrder\&quot;:\&quot;value-desc\&quot;,\&quot;content\&quot;:[&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> tr = doc.TransactionManager.StartOpenCloseTransaction()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">bool</span> first = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ms =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">BlockTableRecord</span>)tr.GetObject(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">SymbolUtilityServices</span>.GetBlockModelSpaceId(doc.Database),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">OpenMode</span>.ForRead</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Use LINQ to count the objects in the modelspace,</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// grouping the results by type (all done via ObjectIds,</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// no need to open the objects themselves)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> q =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">from</span> <span style="color: #2b91af">ObjectId</span> o <span style="color: blue">in</span> ms</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">group</span> o <span style="color: blue">by</span> o.ObjectClass.DxfName <span style="color: blue">into</span> counts</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">select</span> <span style="color: blue">new</span> { Count = counts.Count(), Group = counts.Key };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Serialize the results out to JSON</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> i <span style="color: blue">in</span> q)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!first)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sb.Append(<span style="color: #a31515">&quot;,&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; first = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sb.AppendFormat(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;{{\&quot;label\&quot;:\&quot;{0}\&quot;,\&quot;value\&quot;:{1}}}&quot;</span>, i.Group, i.Count</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; sb.Append(<span style="color: #a31515">&quot;]}}&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> sb.ToString();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnDocumentActivated(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> s, <span style="color: #2b91af">DocumentCollectionEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_chps != <span style="color: blue">null</span> &amp;&amp; e.Document != _curDoc)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We're going to monitor when objects get added and</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// erased. We'll use CommandEnded to refresh the</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// palette at most once per command (might also use</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// DocumentManager.DocumentLockModeWillChange)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// The document is dead...</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; RemoveHandlers(_curDoc);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// ... long live the document!</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _curDoc = e.Document;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; AddHandlers(_curDoc);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_curDoc != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Refresh our palette by setting the flag and running</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// a command (could be any command, we've chosen REGEN)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _refresh = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _curDoc.SendStringToExecute(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;_.REGEN &quot;</span>, <span style="color: blue">false</span>, <span style="color: blue">false</span>, <span style="color: blue">false</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; acjsInvokeAsync(<span style="color: #a31515">&quot;refpie&quot;</span>, <span style="color: #a31515">&quot;{}&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> AddHandlers(<span style="color: #2b91af">Document</span> doc)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc.Database != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.Database.ObjectAppended += OnObjectAppended;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.Database.ObjectErased += OnObjectErased;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.CommandEnded += OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> RemoveHandlers(<span style="color: #2b91af">Document</span> doc)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc.Database != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.Database.ObjectAppended -= OnObjectAppended;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.Database.ObjectErased -= OnObjectErased;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.CommandEnded -= OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnObjectAppended(<span style="color: blue">object</span> s, <span style="color: #2b91af">ObjectEventArgs</span> e)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _refresh = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnObjectErased(<span style="color: blue">object</span> s, <span style="color: #2b91af">ObjectErasedEventArgs</span> e)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _refresh = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnCommandEnded(<span style="color: blue">object</span> s, <span style="color: #2b91af">CommandEventArgs</span> e)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Invoke our JavaScript functions to refresh the palette</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_refresh &amp;&amp; _chps != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acjsInvokeAsync(<span style="color: #a31515">&quot;refpie&quot;</span>, <span style="color: #a31515">&quot;{}&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _refresh = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPaletteSetDestroy(<span style="color: blue">object</span> s, <span style="color: #2b91af">EventArgs</span> e)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// When our palette is closed, detach the various</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// event handlers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_curDoc != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; RemoveHandlers(_curDoc);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _curDoc = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">Uri</span> GetHtmlPathChart()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">Uri</span>(<span style="color: #2b91af">Utils</span>.GetHtmlPath() + <span style="color: #a31515">&quot;chart.html&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>I’ve actually found this to be quite a useful little sample: not just from the way it shows interactions from HTML5/JavaScript to .NET and back but also from a user perspective. If you want to quickly select all the objects of a particular type from a drawing – perhaps to change their layer or erase them, then this tool could be very handy. It’s essentially a streamlined, graphical version of the QSELECT command.</p>
