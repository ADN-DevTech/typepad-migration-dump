---
layout: "post"
title: "Adding support for global keywords at AutoCAD&rsquo;s command-line using .NET &ndash; Part 2"
date: "2015-03-11 16:57:06"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Commands"
  - "Notification / Events"
  - "Runtime"
  - "User interface"
  - "WPF"
original_url: "https://www.keanw.com/2015/03/adding-support-for-global-keywords-at-autocads-command-line-using-net-part-2.html "
typepad_basename: "adding-support-for-global-keywords-at-autocads-command-line-using-net-part-2"
typepad_status: "Publish"
---

<p>Today we’re going to look at the implementation talked about in <a href="http://through-the-interface.typepad.com/through_the_interface/2015/03/adding-support-for-global-keywords-at-autocads-command-line-using-net-part-1.html" target="_blank">the last post</a>: we’re going to see how it’s possible to use the Application.PreTranslateMessage() method to hack AutoCAD’s message-loop and basically convert typed keywords into global ones.</p>  <p>This is actually pretty neat (yes, even if I do say so myself :-) and frankly I’m surprised it works. Here’s the overall approach:</p>  <ul>   <li>Track the characters typed into the command-line      <ul>       <li>Add individual characters into a list </li>        <li>Backspace removes the tail of the list </li>        <li>Arrow-keys invalidate the tracking: if the user accesses entries in the command-history we can’t deal with that, and even navigating left and right along the typed text is tricky </li>     </ul>   </li>    <li>When we encounter a termination character – enter or space – the fun really starts…      <ul>       <li>We check the entered string to see whether it matches any in our global keywords list. If it doesn’t match any – or it matches too many – then we let the keyword get processed as normal (which should either result in a local keyword being interpreted or an error) </li>        <li>If we find a single keyword match, we swallow the “keydown” message – setting e.Handled to true – which means the enter/space won’t be processed </li>        <li>We create a string consisting of the right number of backspace characters (ASCII 8) to erase the existing keyword and append an underscore and the typed keyword </li>        <li>We use Document.SendStringToExecute() to send this to the command-line </li>     </ul>   </li> </ul>  <p>I didn’t find AutoCAD’s keyword matching code accessible via an API, so I did my best to replicate it. I don’t really like doing that, but it was actually quite fun to think through how AutoCAD detects keywords. I could well have missed edge cases, though – if you come across any strange behaviour, please let me know!</p>  <br /><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201bb08039b18970d-pi"><img title="CmdLineHelper" style="float: none; margin-left: auto; display: block; margin-right: auto" alt="CmdLineHelper" src="/assets/image_25602.jpg" width="450" height="399" /></a>   <br />  <p>Looking at the above recording – recorded using the French version of AutoCAD 2015 – there are some important points to note: we’re only using global commands and keywords entered via the command-line (as opposed to clicking from the menu, as we saw last time). When a keyword matches one in the global list (such as “arc” or “line” during the PLINE command), an underscore gets prefixed directly in the command-line.</p>  <p>Here’s <a href="http://through-the-interface.typepad.com/files/CmdLineHelper.zip" target="_blank">the complete project for you to play with</a> and here’s the C# source file containing the implementation described above:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Specialized;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Text.RegularExpressions;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> CmdLineHelper</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">KeywordCommands</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// The keyword display window</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">KeywordWindow</span> _window = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// We will store the &quot;core&quot; set of keywords for when we have</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// nested keywords that need to be appended</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">KeywordCollection</span> _coreKeywords = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Keystrokes to recreate the commands entered</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">char</span>&gt; _keystrokes = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Flag for whether we're tracking keystrokes or not</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">bool</span> _tracking = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// The previous value of DYNMODE, which we override to 0</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// during keyword display</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">int</span> _dynmode = 0;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// List of &quot;special&quot; commands that need a timer to reset</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// the keyword list</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: blue">string</span>[] specialCmds = { <span style="color: #a31515">&quot;MTEXT&quot;</span> };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Constants for our keystroke interpretation code</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">int</span> WM_KEYDOWN = 256;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">int</span> WM_KEYUP = 257;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">int</span> WM_CHAR = 258;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// 37 - left arrow (no char, keydown/up)</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// 38 - up arrow (no char, keydown/up)</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// 39 - right arrow (no char, keydown/up)</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// 40 - down arrow (no char, keydown/up)</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// 46 - delete (no char, keydown/up)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; cancelKeys =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; { 37, 38, 39, 40, 46 };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// 13 - enter (char + keydown/up)</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// 32 - space (char + keydown/up)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; enterKeys =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; { 13, 32 };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;KWS&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> KeywordTranslation()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ed = doc.Editor;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_window == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _window = <span style="color: blue">new</span> <span style="color: #2b91af">KeywordWindow</span>(<span style="color: #2b91af">Application</span>.MainWindow.Handle);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _window.Show();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.MainWindow.Focus();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Add our various event handlers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// For displaying the keyword list...</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForAngle += OnPromptingForAngle;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForCorner += OnPromptingForCorner;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForDistance += OnPromptingForDistance;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForDouble += OnPromptingForDouble;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForEntity += OnPromptingForEntity;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForInteger += OnPromptingForInteger;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForKeyword += OnPromptingForKeyword;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForNestedEntity += OnPromptingForNestedEntity;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForPoint += OnPromptingForPoint;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForSelection += OnPromptingForSelection;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.PromptingForString += OnPromptingForString;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// ... and removing it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.CommandWillStart += OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.CommandEnded += OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.CommandCancelled += OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.CommandFailed += OnCommandEnded;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.EnteringQuiescentState += OnEnteringQuiescentState;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We'll also watch keystrokes, to see when global keywords</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// are entered</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.PreTranslateMessage += OnPreTranslateMessage;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _keystrokes = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">char</span>&gt;();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We need to turn off dynamic input: we'll reset the value</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// when we unload or in KWSX</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _dynmode = (<span style="color: blue">short</span>)<span style="color: #2b91af">Application</span>.GetSystemVariable(<span style="color: #a31515">&quot;DYNMODE&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_dynmode != 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.SetSystemVariable(<span style="color: #a31515">&quot;DYNMODE&quot;</span>, 0);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;\nDynamic input has been disabled and can be re-enabled&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; + <span style="color: #a31515">&quot; by the KWSX command.&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;\nGlobal keyword dialog enabled. Run KWSX to turn it off.&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;\nGlobal keyword dialog already enabled.&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;KWSX&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> StopKeywordTranslation()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ed = doc.Editor;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_window == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// This means KWS hasn't been called...</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;\nGlobal keyword dialog already disabled.&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _window.Hide();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _window = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Remove our various event handlers</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// For displaying the keyword list...</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForAngle -= OnPromptingForAngle;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForCorner -= OnPromptingForCorner;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForDistance -= OnPromptingForDistance;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForDouble -= OnPromptingForDouble;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForEntity -= OnPromptingForEntity;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForInteger -= OnPromptingForInteger;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForKeyword -= OnPromptingForKeyword;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForNestedEntity -= OnPromptingForNestedEntity;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForPoint -= OnPromptingForPoint;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForSelection -= OnPromptingForSelection;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.PromptingForString -= OnPromptingForString;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// ... and removing it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; doc.CommandWillStart -= OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; doc.CommandEnded -= OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; doc.CommandCancelled -= OnCommandEnded;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; doc.CommandFailed -= OnCommandEnded;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.EnteringQuiescentState -= OnEnteringQuiescentState;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.PreTranslateMessage -= OnPreTranslateMessage;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.SetSystemVariable(<span style="color: #a31515">&quot;DYNMODE&quot;</span>, _dynmode);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;\nGlobal keyword dialog disabled. Run KWS to turn it on.&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Event handlers to display the keyword list</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// (each of these handlers needs a separate function due to the</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// signature, but they all do the same thing)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForAngle(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptAngleOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForCorner(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptPointOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForDistance(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptDistanceOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForDouble(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptDoubleOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForEntity(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptEntityOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForInteger(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptIntegerOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">void</span> OnPromptingForKeyword(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptKeywordOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForNestedEntity(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptNestedEntityOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForPoint(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptPointOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForSelection(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptSelectionOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Nested selection sometimes happens (e.g. the HATCH command)</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// so only display keywords when there are some to display</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (e.Options.Keywords.Count &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPromptingForString(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PromptStringOptionsEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; DisplayKeywords(e.Options.Keywords);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnCommandWillStart(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">CommandEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; HideKeywords();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnCommandEnded(<span style="color: blue">object</span> sender, <span style="color: #2b91af">CommandEventArgs</span> e)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; HideKeywords();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Event handlers to clear &amp; hide the keyword list</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnEnteringQuiescentState(<span style="color: blue">object</span> sender, <span style="color: #2b91af">EventArgs</span> e)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; HideKeywords();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPreTranslateMessage(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> sender, <span style="color: #2b91af">PreTranslateMessageEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_tracking)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Use of the arrow keys or delete kills our tracking</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> wp = e.Message.wParam.ToInt32();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.Message.message == WM_KEYDOWN &amp;&amp; cancelKeys.Contains(wp)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _tracking = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span> <span style="color: blue">if</span> (</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.Message.message == WM_KEYDOWN &amp;&amp; enterKeys.Contains(wp)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Get our characters and then clear the list</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> chars = _keystrokes.ToArray();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _keystrokes.Clear();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// If the keyword list contains our string, send it</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// with a prefix of backspaces (to erase the prior</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// characters) and an underscore</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> kw = <span style="color: blue">new</span> <span style="color: blue">string</span>(chars);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_window.ContainsKeyword(kw))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.Handled = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; LaunchCommand(kw, kw.Length, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span> <span style="color: blue">if</span> (e.Message.message == WM_CHAR)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// If we have a backspace character, remove the last</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// entry in our character list, otherwise add the</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// character to the list</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (wp == 8) <span style="color: green">// Backspace</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_keystrokes.Count &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _keystrokes.RemoveAt(_keystrokes.Count - 1);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span> <span style="color: blue">if</span> (ValidCharacter(wp)) <span style="color: green">// Normal character</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _keystrokes.Add((<span style="color: blue">char</span>)wp);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Helper to display our keyword list</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> DisplayKeywords(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">KeywordCollection</span> kws, <span style="color: blue">bool</span> append = <span style="color: blue">false</span></p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!append)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _coreKeywords = kws;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// First we step through the keywords, collecting those</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// we want to display in a collection</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> sc = <span style="color: blue">new</span> <span style="color: #2b91af">StringCollection</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (append)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; sc.AddRange(ExtractKeywords(_coreKeywords));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; sc.AddRange(ExtractKeywords(kws));</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// If we don't have keywords to display, make sure the</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// current list is cleared/hidden</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (sc.Count == 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _window.ClearKeywords(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Otherwise we pass the keywords - as a string array -</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// to the display function along with a flag indicating</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// whether the current command is considered &quot;special&quot;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> sa = <span style="color: blue">new</span> <span style="color: blue">string</span>[sc.Count];</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; sc.CopyTo(sa, 0);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We should probably check for transparent/nested</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// command invocation...</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> cmd =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: blue">string</span>)<span style="color: #2b91af">Application</span>.GetSystemVariable(<span style="color: #a31515">&quot;CMDNAMES&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _window.ShowKeywords(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sa, <span style="color: #2b91af">Array</span>.IndexOf(specialCmds, cmd) &gt;= 0</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//Application.MainWindow.Focus();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Start tracking keyword keystrokes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _tracking = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">string</span>[] ExtractKeywords(<span style="color: #2b91af">KeywordCollection</span> kws)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> sc = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">string</span>&gt;();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (kws != <span style="color: blue">null</span> &amp;&amp; kws.Count &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">Keyword</span> kw <span style="color: blue">in</span> kws)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (kw.Enabled &amp;&amp; kw.Visible &amp;&amp; kw.GlobalName != <span style="color: #a31515">&quot;dummy&quot;</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sc.Add(kw.LocalName); <span style="color: green">// Expected this to be GlobalName</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> sc.ToArray();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> HideKeywords()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _keystrokes.Clear();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _tracking = <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _window.ClearKeywords(<span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: blue">void</span> GiveAutoCADFocus()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc.Window.Focus();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.MainWindow.Focus();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: blue">void</span> LaunchCommand(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> cmd, <span style="color: blue">int</span> numBspaces, <span style="color: blue">bool</span> terminate</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; doc.SendStringToExecute(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Backspaces(numBspaces) + <span style="color: #a31515">&quot;_&quot;</span> + cmd + (terminate ? <span style="color: #a31515">&quot; &quot;</span> : <span style="color: #a31515">&quot;&quot;</span>),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">true</span>, <span style="color: blue">false</span>, <span style="color: blue">true</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; GiveAutoCADFocus();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">string</span> Backspaces(<span style="color: blue">int</span> n)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">String</span>((<span style="color: blue">char</span>)8, n);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> ValidCharacter(<span style="color: blue">int</span> c)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> r = <span style="color: blue">new</span> <span style="color: #2b91af">Regex</span>(<span style="color: #a31515">&quot;^[a-zA-Z0-9]$&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> r.IsMatch(<span style="color: #2b91af">Char</span>.ToString((<span style="color: blue">char</span>)c));</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> KeywordsMatch(<span style="color: blue">string</span> typed, <span style="color: blue">string</span> keyword)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (Match(typed, keyword))</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Find the index of the first uppercase character in</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// the keyword being matched against</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> chars = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">char</span>&gt;(keyword.ToCharArray());</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> upp = chars.Find(c =&gt; <span style="color: #2b91af">Char</span>.IsUpper(c));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> nth = keyword.IndexOf(upp);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Perform a similar check as the first one, this time</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// starting with the first uppercase character</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; nth &lt;= 0 ? <span style="color: blue">false</span> : Match(typed, keyword.Substring(nth));</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">bool</span> Match(<span style="color: blue">string</span> typed, <span style="color: blue">string</span> keyword)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// We can't match a keyword that's shorter than what</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// was typed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (typed.Length &gt; keyword.Length)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Check the typed keyword against the initial section of the</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// keyword to match of the same length (in lowercase)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> tlow = typed.ToLower();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> klow = keyword.Substring(0, typed.Length).ToLower();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">bool</span> matchComplete = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (keyword.Length &gt; typed.Length)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> rest = keyword.Substring(typed.Length);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; matchComplete = (rest == rest.ToLower());</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> (tlow == klow &amp;&amp; matchComplete);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>I made some additional – actually fairly significant – changes to the project since we saw the code posted:</p>  <ul>   <li>There was an issue with <a href="http://through-the-interface.typepad.com/through_the_interface/2015/02/enabling-global-commands-on-localized-autocad-versions-using-net.html" target="_blank">the code I’d posted</a> for the global command helper: even though I thought I’d tested it thoroughly, Editor.Command() didn’t work in this particular context. I went back to Document.SendStringToExecute()… I’ll make sure the post gets updated. </li>    <li>We didn’t actually need a Popup window for <a href="http://through-the-interface.typepad.com/through_the_interface/2015/02/adding-a-global-keyword-menu-to-autocad-using-wpf-part-2.html" target="_blank">our global keywords list</a>. We now create a normal WPF window and make AutoCAD its owner, which means it will be minimised and restored along with AutoCAD and doesn’t stay “topmost” in the Z order. </li> </ul>  <p>Overall the app is really starting to shape up. We’re thinking about how best to distribute it for feedback (possibly via Labs – we’ll see). If you have the chance to give it a try yourself in the meantime, please post a comment or <a href="mailto:kean.walmsley@autodesk.com" target="_blank">drop me an email</a>.</p>
