---
layout: "post"
title: "Importing and pixelizing images inside AutoCAD using F#"
date: "2009-02-01 07:27:59"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "F#"
  - "Hatches"
original_url: "https://www.keanw.com/2009/02/importing-and-pixelizing-images-inside-autocad-using-f.html "
typepad_basename: "importing-and-pixelizing-images-inside-autocad-using-f"
typepad_status: "Publish"
---

<p>A friend and esteemed colleague asked - very validly - why I decided to use circles on a grid to display the results of a mathematical function in <a href="http://through-the-interface.typepad.com/through_the_interface/2009/01/implementing-a-simple-graphing-tool-inside-autocad-using-f.html">this last post</a>, rather than using a linear object of some kind. Well I did, in fact, have a plan in mind... :-)</p> <p>This post extends the concept, introduced in that post, of displaying data in a grid of solid-hatched circles. This post focuses on importing a bitmap image from a file, <a href="http://en.wikipedia.org/wiki/Pixelization">pixelizing</a> the contents and using the "averaged" pixel colours to modify our grid. The idea actually came to me during an <a href="http://en.wikipedia.org/wiki/R.E.M.">R.E.M.</a> concert I attended at <a href="http://www.paleo.ch">Pal√©o</a>, a Swiss music festival, last summer. The real-time manipulation performed on the live video feed of the band - and especially of <a href="http://en.wikipedia.org/wiki/Michael_Stipe">Michael Stipe</a>, the lead singer - which was then projected onto screens adjacent to the stage was really, really cool. They managed to pixelize and manipulate the colours in a way that I found incredible - it was like seeing real-time graphic design at work. I understand that much of the work is done in advance, but even so I found it very impressive. Some of you regular concert-goers may find what I've just described to be pretty run-of-the-mill, but I fully admit that these days - what with one thing and another - I don't get out much. :-)</p> <p>The pixelization approach I decided to take was to read in square chunks of the bitmap image and then average out the RGB values for all the pixels in each square. These average values are then used to colour the circles representing the "pixels" for their respective squares. You'll notice some inadvertent cropping of the imported image, which happens because we ask for the width in terms of our circular pixels and then sample the bitmap in chunks that have a whole number of pixels on each side: if the picture's width is not exactly divisible by the width entered there will be a little cropping.</p> <p>Why did I choose F# for this rather than C#? The image processing domain in general is a strong fit for functional programming techniques. And while I haven't yet taken the step in this post, certain parts of the below code are inherently parallelizable, especially the operations related to averaging of pixel colours. The reading of the bitmap itself might prove more difficult, as it uses "unsafe" direct memory access (via the NativePtr class), but it's by no means impossible to parallelize, at least in theory.</p> <p>Anyway, here's the F# code I put together:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Use lightweight F# syntax</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">#light</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Declare a specific namespace and module name</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">module</span><span style="line-height: 140%"> Pixelizor.Commands</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Import managed assemblies</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">#nowarn</span><span style="line-height: 140%"> </span><span style="color: maroon; line-height: 140%">"9"</span><span style="line-height: 140%"> </span><span style="color: green; line-height: 140%">// ... because we're using NativePtr</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Colors</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> System.Drawing.Imaging</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Microsoft.FSharp.NativeInterop</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Declare our command</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">[&lt;CommandMethod(</span><span style="color: maroon; line-height: 140%">"pix"</span><span style="line-height: 140%">)&gt;]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pixelate() =</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Let's get the usual helpful AutoCAD objects</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> doc =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; Application.DocumentManager.MdiActiveDocument</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ed = doc.Editor</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> db = doc.Database</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// "use" has the same effect as "using" in C#</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">use</span><span style="line-height: 140%"> tr =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; db.TransactionManager.StartTransaction()</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Get appropriately-typed BlockTable and BTRs</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bt =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; tr.GetObject</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (db.BlockTableId,OpenMode.ForRead)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; :?&gt; BlockTable</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ms =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; tr.GetObject</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (bt.[BlockTableRecord.ModelSpace],</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OpenMode.ForWrite)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; :?&gt; BlockTableRecord</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Function to create a filled circle (hatch) at a</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// specific location</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Note the valid use of tr and ms, as they are in scope</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> createCircle pt rad =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> hat = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> Hatch()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; hat.SetDatabaseDefaults()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; hat.SetHatchPattern</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (HatchPatternType.PreDefined,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: maroon; line-height: 140%">"SOLID"</span><span style="line-height: 140%">)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> id = ms.AppendEntity(hat)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; tr.AddNewlyCreatedDBObject(hat, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Now we create the loop, which we make db-resident</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// (appending a transient loop caused problems, so</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// we're going to use the circle and then erase it)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> cir = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> Circle()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; cir.Radius &lt;- rad</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; cir.Center &lt;- pt</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> lid = ms.AppendEntity(cir)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; tr.AddNewlyCreatedDBObject(cir, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Have the hatch use the loop we created</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> loops = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> ObjectIdCollection()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; loops.Add(lid) |&gt; ignore</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; hat.AppendLoop(HatchLoopTypes.Default, loops)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; hat.EvaluateHatch(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Now we erase the loop</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; cir.Erase()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; id</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Function to create our grid of circles</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> createGrid xsize ysize rad offset =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ids = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> ObjectIdCollection()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> i = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> xsize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> j = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> ysize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pt =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> Point3d</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (offset * (Int32.to_float i),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; offset * (Int32.to_float j),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> id = createCircle pt rad</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ids.Add(id) |&gt; ignore</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; ids</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Function to change the colour of an entity</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> changeColour (col : Color) (id : ObjectId) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> id.IsValid </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ent =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr.GetObject(id, OpenMode.ForWrite) :?&gt; Entity</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ent.Color &lt;- col</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Add up the RGB values of a list of pixels</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// We use a recursive function with an accumulator argument,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// (rt, gt, bt), to allow tail call optimization</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">rec</span><span style="line-height: 140%"> sumColors (pix : List&lt;(byte*byte*byte)&gt;) (rt,gt,bt) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">match</span><span style="line-height: 140%"> pix </span><span style="color: blue; line-height: 140%">with</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | [] </span><span style="color: blue; line-height: 140%">-&gt;</span><span style="line-height: 140%"> (rt, gt, bt)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | (r, g, b) :: tl </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sumColors tl</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (rt + Byte.to_int r,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gt + Byte.to_int g,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bt + Byte.to_int b)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Average out the RGB values of a list of pixels</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> getAverageColour (pixels : List&lt;(byte*byte*byte)&gt;) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> (rsum, gsum, bsum) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sumColors pixels (0, 0, 0)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> count = pixels.Length</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ravg = Byte.of_int (rsum / count)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> gavg = Byte.of_int (gsum / count)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bavg = Byte.of_int (bsum / count)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// For some reason the pixel needs ro be reversed - probably</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// because of the bitmap format (needs investigation)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; Color.FromRgb(bavg, gavg, ravg)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">//&nbsp; Get a chunk of pixels to average from one row</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// We use a recursive function with an accumulator argument</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// to allow tail call optimization</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">rec</span><span style="line-height: 140%"> getChunkRowPixels p xsamp acc =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> xsamp = 0 </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; acc</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">else</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pix =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [(NativePtr.get p 0,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NativePtr.get p 1,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NativePtr.get p 2)]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> p = NativePtr.add p 3</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getChunkRowPixels p (xsamp-1) (pix @ acc)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Get a chunk of pixels to average from multiple rows</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// We use a recursive function with an accumulator argument</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// to allow tail call optimization</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">rec</span><span style="line-height: 140%"> getChunkPixels p stride xsamp ysamp acc =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> ysamp = 0 </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; acc</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">else</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pix = getChunkRowPixels p xsamp []</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> p = NativePtr.add p stride</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getChunkPixels p stride xsamp (ysamp-1) (pix @ acc)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Get the various chunks of pixels to average across</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// a complete bitmap image</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pixelateBitmap (image:System.Drawing.Bitmap) xsize ysize =</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Create a 2-dimensional array of pixel lists (one list,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// which then needs averaging, per final pixel)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> (arr2 : List&lt;(byte*byte*byte)&gt;[,]) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Array2.create xsize ysize []</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Lock the entire memory block related to our image</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bd =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image.LockBits</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (System.Drawing.Rectangle</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (0, 0, image.Width ,image.Height),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ImageLockMode.ReadOnly, image.PixelFormat)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Establish the number of pixels to sample per chunk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// in each of the x and y directions</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> xsamp = image.Width / xsize</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ysamp = image.Height / ysize</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// We have a mutable pointer to step through the image</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">mutable</span><span style="line-height: 140%"> (p:nativeptr&lt;byte&gt;) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NativePtr.of_nativeint (bd.Scan0)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Loop through the various chunks</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> i = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> ysize - 1 </span><span style="color: blue; line-height: 140%">do</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// We take a copy of the current value of p, as we</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// don't want to mutate p while extracting the pixels</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// within a row</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">mutable</span><span style="line-height: 140%"> xp = p</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> j = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> xsize - 1 </span><span style="color: blue; line-height: 140%">do</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Get the square chunk of pixels starting at</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// this x,y position</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> chk =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getChunkPixels xp bd.Stride xsamp ysamp []</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Add it into our array</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; arr2.[j,ysize-1-i] &lt;- chk</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Mutate the pointer to move along to the right</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// by a value of 3 (our RGB value) times the</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// number of pixels we're sampling in x</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xp &lt;- NativePtr.add xp (xsamp * 3)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">done</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Mutate the original p pointer to move on one row</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p &lt;- NativePtr.add p (bd.Stride * ysamp)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">done</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Finally unlock the bitmap data and return the array</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; image.UnlockBits(bd)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; arr2</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Prompt the user for the file and the width of the image</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pofo =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> PromptOpenFileOptions</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span><span style="color: maroon; line-height: 140%">"Select an image to import and pixelate"</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; pofo.Filter &lt;-</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: maroon; line-height: 140%">"Jpeg Image (*.jpg)|*.jpg|All files (*.*)|*.*"</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pfnr = ed.GetFileNameForOpen(pofo)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> file =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">match</span><span style="line-height: 140%"> pfnr.Status </span><span style="color: blue; line-height: 140%">with</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; | PromptStatus.OK </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pfnr.StringResult</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; | _ </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: maroon; line-height: 140%">""</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> System.IO.File.Exists(file) </span><span style="color: blue; line-height: 140%">then</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> img = System.Drawing.Image.FromFile(file)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pio =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> PromptIntegerOptions</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span><span style="color: maroon; line-height: 140%">"\nEnter number of horizontal pixels: "</span><span style="line-height: 140%"> )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; pio.AllowNone &lt;- </span><span style="color: blue; line-height: 140%">true</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; pio.UseDefaultValue &lt;- </span><span style="color: blue; line-height: 140%">true</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; pio.LowerLimit &lt;- 1</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; pio.UpperLimit &lt;- img.Width</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; pio.DefaultValue &lt;- 100</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pir = ed.GetInteger(pio)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> xsize =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">match</span><span style="line-height: 140%"> pir.Status </span><span style="color: blue; line-height: 140%">with</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | PromptStatus.None </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; img.Width</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | PromptStatus.OK </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pir.Value</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | _ </span><span style="color: blue; line-height: 140%">-&gt;</span><span style="line-height: 140%"> -1</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> xsize &gt; 0 </span><span style="color: blue; line-height: 140%">then</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Calculate the vertical size from the horizontal</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ysize = img.Height * xsize / img.Width</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> ysize &gt; 0 </span><span style="color: blue; line-height: 140%">then</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Create our basic grid</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ids = createGrid xsize ysize 0.5 1.2</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Some helper functions using values we've just set...</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// From a certain index in the list, get an object ID</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> getId i =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> i &gt;= 0 </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ids.[i]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">else</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectId.Null</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// From a certain x and y in the grid, get an object ID</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> getId x y =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getId ((x * ysize) + y)</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Cast our image to a bitmap and then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// get the chunked pixels</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bmp = img :?&gt; System.Drawing.Bitmap</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> arr = pixelateBitmap bmp xsize ysize</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// Loop through the pixel list and average them out</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// (which could be parallelized), using the results</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green; line-height: 140%">// to change the colour of the circles in our grid</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> x = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> xsize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> y = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> ysize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> lst = arr.[x,y]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> col = getAverageColour lst</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> id = getId x y</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; changeColour col id</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">done</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue; line-height: 140%">done</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; </span><span style="color: green; line-height: 140%">// Commit the transaction</span></p><br> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&nbsp; tr.Commit()</span></p></div><!--EndFragment--><!--EndFragment--><!--EndFragment--> <p>Here are the results of running it and choosing a photo I took yesterday during my visit to <a href="http://en.wikipedia.org/wiki/Kodaikanal">Kodaikanal</a> in <a href="http://en.wikipedia.org/wiki/Tamil_Nadu">Tamil Nadu</a> (India's most southern state).</p> <p>First the original image:</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201116838cd63970c-pi"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="330" alt="Colourful truck on jack" src="/assets/image_971461.jpg" width="433" border="0"></a> </p> <p>Here's what happens when we run the PIX command, selecting the above image and choosing 20 pixels in width:</p> <p>&nbsp;<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201116838cd85970c-pi"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="343" alt="Truck with 20 pixel width" src="/assets/image_829460.jpg" width="438" border="0"></a> <br></p> <p>Now with a width of 50...</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201116838cdaa970c-pi"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="342" alt="Truck with 50 pixel width" src="/assets/image_459327.jpg" width="443" border="0"></a> </p> <p>And finally with a width of 100... </p> <p>&nbsp;<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201116838cdff970c-pi"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="339" alt="Truck with 100 pixel width" src="/assets/image_134893.jpg" width="438" border="0"></a></p> <p>Give it a try yourself, pixelizing different images at different resolutions - you can get some very cool results.</p> <p>This one is too fun to just let rest... I'm going to see if I get some time this week to work on the parallelization of the colour averaging operation, to see if that improves performance (even if it doesn't today, it will do eventually when I either get a 64-core machine or move some of the code to be hosted in the cloud... :-)</p>
