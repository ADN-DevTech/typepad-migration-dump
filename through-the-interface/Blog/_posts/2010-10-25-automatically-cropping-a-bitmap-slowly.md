---
layout: "post"
title: "Automatically cropping a bitmap (slowly)"
date: "2010-10-25 15:12:51"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Plugin of the Month"
  - "User interface"
original_url: "https://www.keanw.com/2010/10/automatically-cropping-a-bitmap-slowly.html "
typepad_basename: "automatically-cropping-a-bitmap-slowly"
typepad_status: "Publish"
---

<p>I received a few comments by email and otherwise regarding the preview capability added to the <a href="http://through-the-interface.typepad.com/through_the_interface/2009/09/clipboard-manager-octobers-adn-plugin-of-the-month-now-live-on-autodesk-labs.html" target="_blank">Clipboard Manager</a> <a href="http://labs.autodesk.com/utilities/ADN_Plugins" target="_blank">Plugin of the Month</a> in <a href="http://through-the-interface.typepad.com/through_the_interface/2010/10/updated-clipboard-manager-now-with-preview.html" target="_blank">the last post</a>. Basically it’s useful, but only to a point: the bitmap created on the clipboard is the same size as AutoCAD’s screen, with the copied objects in their location relative to the screen. This means that if you’re working on a drawing like this:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201348873e916970c-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Working on a fairly typical drawing" border="0" alt="Working on a fairly typical drawing" src="/assets/image_841214.jpg" width="479" height="318" /></a> And you want to copy the leader to the left of the cursor to the clipboard, the preview you’ll end up with will be something like this:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f553fb36970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Our clipboard preview" border="0" alt="Our clipboard preview" src="/assets/image_397212.jpg" width="479" height="217" /></a></p>  <p>Which – when scaled down to be placed at the bottom of a palette window – makes it very hard to see the geometry.</p>  <p>This feedback prompted me to think about auto-cropping the preview bitmap, so that we effectively “zoom in” on the geometry.</p>  <p>It turned out to be relatively straightforward to create a basic implementation. We loop through each pixel and check it against the background colour: if it’s not the same then we check to see whether it’s the left-/right-/bottom-/top-most, and, if so, we store it’s x and/or y coordinate to help define the limits of the cropped area.</p>  <p>Here are the helper functions I created to do this (in VB.NET, as that’s what the Clipboard Manager was originally written in):</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">Function</span><span style="line-height: 140%"> SameColor(</span><span style="line-height: 140%; color: blue">ByVal</span><span style="line-height: 140%"> a </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color, </span><span style="line-height: 140%; color: blue">ByVal</span><span style="line-height: 140%"> b </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color) </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Boolean</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Return</span><span style="line-height: 140%"> (a.R = b.R </span><span style="line-height: 140%; color: blue">And</span><span style="line-height: 140%"> a.G = b.G </span><span style="line-height: 140%; color: blue">And</span><span style="line-height: 140%"> a.B = b.B)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Function</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">Function</span><span style="line-height: 140%"> MostCommonColor(</span><span style="line-height: 140%; color: blue">ByVal</span><span style="line-height: 140%"> cols() </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color) </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Use a dictionary to count our colors</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> cd </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Dictionary(</span><span style="line-height: 140%; color: blue">Of</span><span style="line-height: 140%"> Color, </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%">) = _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">New</span><span style="line-height: 140%"> Dictionary(</span><span style="line-height: 140%; color: blue">Of</span><span style="line-height: 140%"> Color, </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Loop through the array, adding them one by one</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">For</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Each</span><span style="line-height: 140%"> col </span><span style="line-height: 140%; color: blue">In</span><span style="line-height: 140%"> cols</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> cd.ContainsKey(col) </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; cd.Item(col) += 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; cd.Add(col, 1)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Next</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Now go through the dictionary and get the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' most popular color</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> max </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> mostCommon </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color = Color.Black</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">For</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Each</span><span style="line-height: 140%"> kv </span><span style="line-height: 140%; color: blue">In</span><span style="line-height: 140%"> cd</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> kv.Value &gt; max </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; max = kv.Value</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; mostCommon = kv.Key</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Next</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Return</span><span style="line-height: 140%"> mostCommon</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Function</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">Function</span><span style="line-height: 140%"> Crop(</span><span style="line-height: 140%; color: blue">ByVal</span><span style="line-height: 140%"> b </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Bitmap, </span><span style="line-height: 140%; color: blue">ByVal</span><span style="line-height: 140%"> bg </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color) </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Bitmap</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Variables for the area to crop down to</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> left </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = b.Width</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> top </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = b.Height</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> right </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> bottom </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = 0</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Indeces and the current pixel</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> x, y </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> c </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> bg = </span><span style="line-height: 140%; color: blue">Nothing</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' If we don't have a background passed in, get the four</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' corners' colors and find the most common of them</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> cols() </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Color = { _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; b.GetPixel(0, 0), _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; b.GetPixel(0, b.Height - 1), _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; b.GetPixel(b.Width - 1, 0), _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; b.GetPixel(b.Width - 1, b.Height - 1)}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; bg = MostCommonColor(cols)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Loop through each pixel</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">For</span><span style="line-height: 140%"> y = 0 </span><span style="line-height: 140%; color: blue">To</span><span style="line-height: 140%"> b.Height - 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">For</span><span style="line-height: 140%"> x = 0 </span><span style="line-height: 140%; color: blue">To</span><span style="line-height: 140%"> b.Width - 1</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; c = b.GetPixel(x, y)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' If it's not the same as the background color</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Not</span><span style="line-height: 140%"> SameColor(c, bg) </span><span style="line-height: 140%; color: blue">Then</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Then we update our variables, as appropriate</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> x &lt; left </span><span style="line-height: 140%; color: blue">Then</span><span style="line-height: 140%"> left = x</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> y &lt; top </span><span style="line-height: 140%; color: blue">Then</span><span style="line-height: 140%"> top = y</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> x &gt; right </span><span style="line-height: 140%; color: blue">Then</span><span style="line-height: 140%"> right = x</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">If</span><span style="line-height: 140%"> y &gt; bottom </span><span style="line-height: 140%; color: blue">Then</span><span style="line-height: 140%"> bottom = y</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">If</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Next</span><span style="line-height: 140%"> x</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Next</span><span style="line-height: 140%"> y</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Now calculate the dimensions of the cropped output</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> width </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = (right - left)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> height </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = (bottom - top)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Add a buffer of 5% of the largest dimension (a little padding)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> buffer </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Integer</span><span style="line-height: 140%"> = Math.Max(width, height) * 0.05</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; width += 2 * buffer</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; height += 2 * buffer</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Create the new bitmap and the graphics object to draw to it</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> cropped </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">New</span><span style="line-height: 140%"> Bitmap(width, height)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Dim</span><span style="line-height: 140%"> gfx </span><span style="line-height: 140%; color: blue">As</span><span style="line-height: 140%"> Graphics = Graphics.FromImage(cropped)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Using</span><span style="line-height: 140%"> gfx</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Set the color of the bitmap to our background</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; gfx.Clear(bg)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' Draw the portion of the original image that we want to</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">' the new bitmap</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; gfx.DrawImage( _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; b, </span><span style="line-height: 140%; color: blue">New</span><span style="line-height: 140%"> Rectangle(buffer, buffer, width, height), _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">New</span><span style="line-height: 140%"> Rectangle(left, top, width, height), _</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; GraphicsUnit.Pixel)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Using</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">Return</span><span style="line-height: 140%"> cropped</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">End</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">Function</span></p> </div> <!--EndFragment-->  <p>One approach that was a little different: assuming no background colour is specified – which we could do, but I didn’t want to get the preferences object from AutoCAD and introduce a COM dependency on the project – we get the colours of the four corner pixels and then count the most popular. Unless very unlucky this will usually be the background color (and if we are, indeed, unlucky the image will simply not be cropped).</p>  <p>Now, overall, this approach to reading bitmap data is *slow* – it takes about a second to crop a preview using the above code on my system – but it does prove the concept effectively. To give it a try, <a href="http://through-the-interface.typepad.com/files/ClipboardManager-1.0.5.zip" target="_blank">here’s an updated version of the project</a> using the above code. This one is definitely <strong>not</strong> going to be posted to <a href="http://labs.autodesk.com" target="_blank">Autodesk Labs</a>: one way or another I intend to optimise this implementation, whether using Bitmap.LockBits()/UnlockBits() with lower-level memory access code or some simple file caching to make sure the copping only happens once per entry. I’m hoping that the first option will work out well, as it saves us having to clean up temporary files and is (hopefully) effective even the first time run - but we’ll see that in the next post.</p>  <p>At least the results are good from a visual perspective:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20133f553fb79970b-pi"><img style="border-right-width: 0px; margin: 20px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Cropped preview of our clipboard-resident object" border="0" alt="Cropped preview of our clipboard-resident object" src="/assets/image_876151.jpg" width="330" height="444" /></a></p>
