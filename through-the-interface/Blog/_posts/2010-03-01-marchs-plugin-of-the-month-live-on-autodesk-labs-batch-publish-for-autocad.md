---
layout: "post"
title: "March&rsquo;s Plugin of the Month live on Autodesk Labs: Batch Publish for AutoCAD"
date: "2010-03-01 06:45:00"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Batch processing"
  - "Plotting"
  - "Plugin of the Month"
  - "XML"
original_url: "https://www.keanw.com/2010/03/marchs-plugin-of-the-month-live-on-autodesk-labs-batch-publish-for-autocad.html "
typepad_basename: "marchs-plugin-of-the-month-live-on-autodesk-labs-batch-publish-for-autocad"
typepad_status: "Publish"
---

<p>I’m very pleased to announce the availability of this really interesting <a href="http://labs.autodesk.com/utilities/ADN_plugins/">Plugin of the Month</a> over on <a href="http://labs.autodesk.com">Autodesk Labs</a>: Batch Publish for AutoCAD. Here’s an excerpt from the ReadMe (which I happen to have written, but anyway):</p>
<blockquote>
<p><em>This plugin can be used with AutoCAD to simplify the process of publishing sets of drawings to DWF and/or PDF. It runs as a command within AutoCAD – as opposed to a separate executable – and uses a separate executable to monitor AutoCAD&#39;s health and restart it, as needed. The status of the batch publishing operation is stored to disk, allowing it to pick up from where it left off and also for any failed documents to be retried without starting from scratch. A setting is available to only publish drawings that have been modified since they were last published, making it easier to publish sets of documents on a regular basis.</em></p></blockquote>
<p>Varadan Krishnan and Viru Aithal from our DevTech India team have been working hard on this tool for some time. Viru and Varadan have added some very interesting enhancements over the last few months, as the plugin has evolved, and I think it’s going to prove a very useful tool for anyone needing to publish sets of drawings to DWF or PDF.</p>
<p>Typical batch publishing applications often take the form of standalone applications which call through to AutoCAD using COM to drive the publishing of drawings. This application takes a slightly different approach: it runs in-process to AutoCAD, as a standard .NET plugin defining a BATCHPUBLISH command, and this command will load and publish the various documents you care about, one after the other. So you have access to your publishing task right there in the AutoCAD application: no need to launch anything external. That said, as you’re launching a batch processing operation – which may be trying to read problematic source drawings – it’s highly recommended that you save and close any drawings you’re working on. As we’ll see below, AutoCAD may get restarted forcefully during the operation, so it’s highly recommended to launch it from a fresh instance of AutoCAD (or at least one with no unsaved drawings open in the editor).</p>
<p>The application uses a couple of very interesting techniques which may be of interest to people looking at this from a development perspective. Firstly, it has a separate little “regulator” application which monitors the health of AutoCAD: if AutoCAD hangs on loading a corrupt drawing, or the publish operation is taking suspiciously long to complete (relative to a user-defined timeout value), the regulator kills the AutoCAD session and restarts it, making sure the batch publish operation starts back up just after the problematic drawing. Once the other drawings have completed, the user can then choose to retry publishing of any unpublished drawings, specifying a different timeout, as appropriate.</p>
<p>The other technique that I found interesting is the way the application calls through to AutoCAD via COM: it uses <a href="http://through-the-interface.typepad.com/through_the_interface/2006/08/calling_command.html">Document.SendCommand()</a> to drive AutoCAD’s PUBLISH command synchronously, but – rather than creating a dependency on AutoCAD’s type library, which adds some complexity in terms of multiple version support – the code uses <a href="http://msdn.microsoft.com/en-us/library/66btctbe.aspx">Type.InvokeMember()</a> to dynamically call SendCommand() without needing the type library. The same effect can be achieved in VB quite easily using late binding and now in C# 4.0 we have <a href="http://msdn.microsoft.com/en-us/library/dd264736(VS.100).aspx">the dynamic keyword</a> or can <a href="http://msdn.microsoft.com/en-us/library/dd997297(VS.100).aspx">embed specific types from a type library</a> rather than needing the whole thing – but for older versions of C# this is a viable and interesting technique if you’re only interested in a small portion of an application’s COM object model.</p>
<p>The application makes heavy use of an XML file to persist information about the status of the batch publishing operation. This has a number of benefits, especially related to resuming the operation in case AutoCAD needs restarting, as well as restoring some temporarily-overridden system variables when everything’s finished. The approach used to read and write the XML is probably slightly lower-level than might have been used – especially as .NET provides some very interesting object-level XML serialization capabilities – but the need to persist a variety of different pieces of data at various times during the batch publishing operation led to this approach being adopted, for better or worse. The current implement works well, but this is potentially one section of code that might be streamlined in a future release.</p>
<p>Now let’s take a look at the BATCHPUBLISH command in action…</p>
<p>The first thing to do is to copy both the program files provided - <em>ADNPlugin-BatchPublish.dll</em> and its companion <em>ADNPlugin-BatchPublishRegulator.exe</em> – into the same folder on your local hard-drive (preferably AutoCAD’s main Program Files folder).</p>
<p>Then we can NETLOAD the DLL into AutoCAD – which will create demand-loading entries for subsequent loads – and launch the BATCHPUBLISH command:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a8e15583970b-pi"><img alt="Batch Publish main dialog" border="0" height="226" src="/assets/image_930429.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Batch Publish main dialog" width="397" /></a> </p>
<p>Once we’ve filled out the information in this main dialog…</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a8e15590970b-pi"><img alt="Filled out Batch Publish main dialog" border="0" height="197" src="/assets/image_246465.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Filled out Batch Publish main dialog" width="457" /></a> </p>
<p>… hitting configure will allow us to do additional fine-tuning of the application settings. We can choose whether to look for both DWG and DXF files in the source directory and we as having the option to exclude specific files or layouts. We can also change the timeout after which AutoCAD will be killed and restarted, as well as being able to choose whether to publish only the drawings that have been modified since the last time they were published (the alternative being to force a re-publish of everything).</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201310f48247e970c-pi"><img alt="Batch Publish configuration dialog" border="0" height="291" src="/assets/image_370871.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Batch Publish configuration dialog" width="469" /></a></p>
<p>Once we’ve finished, we can select “Done” and then launch the batch publish via the “Publish” button on the main form. You’ll now see AutoCAD publishing the various drawings from the specified source folder, along with a small dialog displayed by the regulator application. This will count down from our timeout threshold and will restart AutoCAD when it gets to zero.<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201310f48248f970c-pi"><img alt="Batch Publishing" border="0" height="322" src="/assets/image_17612.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Batch Publishing" width="464" /></a></p>
<p>30 seconds isn’t a very long time to publish both a DWF and PDF for complex drawings. If it’s clear that the timeout isn’t giving enough time for AutoCAD to complete both and the publish seems to be happening correctly, then you can either close the regulator (which will lead the rest of the batch publish to not be monitored, but will otherwise have no ill effects on the operation) or you can let AutoCAD be restarted and then try again later with a larger timeout value. In our case we’re going to do that.</p>
<p>Once AutoCAD has been killed we’ll see this message from the regulator:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201310f4824a7970c-pi"><img alt="Regulator waitiing to restart AutoCAD after killing it" border="0" height="77" src="/assets/image_133521.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Regulator waitiing to restart AutoCAD after killing it" width="247" /></a>The application waits for 10 seconds after killing AutoCAD before restarting it…</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20120a8e155ea970b-pi"><img alt="Restarting AutoCAD" border="0" height="77" src="/assets/image_786375.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Restarting AutoCAD" width="248" /></a></p>
<p>… and the batch publish operation should continue until all drawings have either been published or have failed to do so:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201310f4824c9970c-pi"><img alt="Failed a couple of drawings - time to retry" border="0" height="372" src="/assets/image_885363.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Failed a couple of drawings - time to retry" width="480" /></a></p>
<p>From here we can use “Retry” to attempt to publish any failed drawings again (possibly with a longer timeout specified in the top right of the dialog):</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201310f4824e6970c-pi"><img alt="Publish complete" border="0" height="372" src="/assets/image_888541.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Publish complete" width="480" /></a></p>
<p>We should now find our output folders filled with DWFs…</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201310f482510970c-pi"><img alt="Our output DWF files" border="0" height="274" src="/assets/image_540289.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Our output DWF files" width="489" /></a> </p>
<p>… and with PDFs:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201310f482530970c-pi"><img alt="Our output PDF files" border="0" height="274" src="/assets/image_973198.jpg" style="BORDER-RIGHT-WIDTH: 0px; MARGIN: 20px auto; DISPLAY: block; FLOAT: none; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Our output PDF files" width="489" /></a> </p>
<p>You’ll see two log files in each folder, as it took us two batch publish attempts to get the whole set of drawings published.</p>
<p>Please give this tool a try and <a href="mailto:labs.plugins@autodesk.com">let us know if you have any feedback</a>. Batch processing tools are often quite hard to get right, so please don’t be discouraged if it doesn’t work perfectly on some of your drawings: please let us know and we’ll do what we can to fix the issue.</p>
