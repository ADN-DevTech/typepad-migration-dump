---
layout: "post"
title: "Parallelized pixelization inside AutoCAD using F#"
date: "2009-02-02 18:28:46"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Concurrent programming"
  - "F#"
  - "Hatches"
original_url: "https://www.keanw.com/2009/02/parallelized-pixelization-inside-autocad-using-f.html "
typepad_basename: "parallelized-pixelization-inside-autocad-using-f"
typepad_status: "Publish"
---

<p>As promised in <a href="http://through-the-interface.typepad.com/through_the_interface/2009/02/importing-and-pixelizing-images-inside-autocad-using-f.html">the last post</a>, we&#39;re now going to look at how to change the code to make the colour averaging routine work in parallel. The overall performance is marginally better on my dual-core machine, but I fully expect it to get quicker and quicker as the number of cores multiply.</p> <p>To start with, though, here&#39;s the modified &quot;synchronous&quot; version of the code - as I went through making the code work in parallel, I noticed a bunch of general enhancements that were applicable to both versions. Here&#39;s the updated F# code:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Use lightweight F# syntax</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">#light</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Declare a specific namespace and module name</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">module</span><span style="line-height: 140%"> SyncPixelizer.Commands</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Import managed assemblies</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">#nowarn</span><span style="line-height: 140%"> </span><span style="color: maroon; line-height: 140%">&quot;9&quot;</span><span style="line-height: 140%"> </span><span style="color: green; line-height: 140%">// ... because we&#39;re using NativePtr</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Autodesk.AutoCAD.Colors</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> System.Drawing.Imaging</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">open</span><span style="line-height: 140%"> Microsoft.FSharp.NativeInterop</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Add up the RGB values of a list of pixels</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// We use a recursive function with an accumulator argument,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// (rt, gt, bt), to allow tail call optimization</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">rec</span><span style="line-height: 140%"> sumColors (pix : List&lt;(byte*byte*byte)&gt;) (rt,gt,bt) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">match</span><span style="line-height: 140%"> pix </span><span style="color: blue; line-height: 140%">with</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; | [] </span><span style="color: blue; line-height: 140%">-&gt;</span><span style="line-height: 140%"> (rt, gt, bt)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; | (r, g, b) :: tl </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; sumColors tl</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (rt + Byte.to_int r,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; gt + Byte.to_int g,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; bt + Byte.to_int b)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Average out the RGB values of a list of pixels</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> getAverageColour (pixels : List&lt;(byte*byte*byte)&gt;) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> (rsum, gsum, bsum) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; sumColors pixels (0, 0, 0)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> count = pixels.Length</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ravg = Byte.of_int (rsum / count)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> gavg = Byte.of_int (gsum / count)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bavg = Byte.of_int (bsum / count)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// For some reason the pixel needs ro be reversed - probably</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// because of the bitmap format (needs investigation)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; Color.FromRgb(bavg, gavg, ravg)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Function to get an index into our flat array</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// from an x,y pair</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> getIndexFromXY ysize x y =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; (x * ysize) + y</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">//&#0160; Get a chunk of pixels to average from one row</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// We use a recursive function with an accumulator argument</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// to allow tail call optimization</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">rec</span><span style="line-height: 140%"> getChunkRowPixels p xsamp acc =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> xsamp = 0 </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; acc</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">else</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pix =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; [(NativePtr.get p 0,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NativePtr.get p 1,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NativePtr.get p 2)]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> p = NativePtr.add p 3 </span><span style="color: green; line-height: 140%">// We do *not* mutate here</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; getChunkRowPixels p (xsamp-1) (pix @ acc)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Get a chunk of pixels to average from multiple rows</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// We use a recursive function with an accumulator argument</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// to allow tail call optimization</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">rec</span><span style="line-height: 140%"> getChunkPixels p stride xsamp ysamp acc =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> ysamp = 0 </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; acc</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">else</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pix = getChunkRowPixels p xsamp []</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> p = NativePtr.add p stride&#0160; </span><span style="color: green; line-height: 140%">// We do *not* mutate here</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; getChunkPixels p stride xsamp (ysamp-1) (pix @ acc)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Get the various chunks of pixels to average across</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// a complete bitmap image</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pixelizeBitmap (image:System.Drawing.Bitmap) xsize ysize =</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// Create a 1-dimensional array of pixel lists (one list,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// which then needs averaging, per final pixel)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> (arr : List&lt;(byte*byte*byte)&gt;[]) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; Array.create (xsize * ysize) []</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// Lock the entire memory block related to our image</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bd =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; image.LockBits</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; (System.Drawing.Rectangle</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (0, 0, image.Width ,image.Height),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; ImageLockMode.ReadOnly, image.PixelFormat)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// Establish the number of pixels to sample per chunk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// in each of the x and y directions</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> xsamp = image.Width / xsize</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ysamp = image.Height / ysize</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// We have a mutable pointer to step through the image</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">mutable</span><span style="line-height: 140%"> (p:nativeptr&lt;byte&gt;) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; NativePtr.of_nativeint (bd.Scan0)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// Loop through the various chunks</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> i = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> ysize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// We take a copy of the current value of p, as we</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// don&#39;t want to mutate p while extracting the pixels</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// within a row</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">mutable</span><span style="line-height: 140%"> xp = p</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> j = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> xsize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Get the square chunk of pixels starting at</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// this x,y position</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> chk =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; getChunkPixels xp bd.Stride xsamp ysamp []</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Add it into our array</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> idx = getIndexFromXY ysize j (ysize-1-i)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; arr.[idx] &lt;- chk</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Mutate the pointer to move along to the right</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// by a value of 3 (our RGB value) times the</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// number of pixels we&#39;re sampling in x</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; xp &lt;- NativePtr.add xp (xsamp * 3)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">done</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Mutate the original p pointer to move on one row</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; p &lt;- NativePtr.add p (bd.Stride * ysamp)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">done</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// Finally unlock the bitmap data and return the array</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; image.UnlockBits(bd)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; arr</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Create an array of ObjectIds from a collection</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> getIdArray (ids : ObjectIdCollection) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; [| </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> i </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> [0..ids.Count-1] </span><span style="color: blue; line-height: 140%">-&gt;</span><span style="line-height: 140%"> ids.[i] |]</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Declare our command</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">[&lt;CommandMethod(</span><span style="color: maroon; line-height: 140%">&quot;pix&quot;</span><span style="line-height: 140%">)&gt;]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pixelize() =</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// Let&#39;s get the usual helpful AutoCAD objects</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> doc =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; Application.DocumentManager.MdiActiveDocument</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ed = doc.Editor</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> db = doc.Database</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: green; line-height: 140%">// Prompt the user for the file and the width of the image</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pofo =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> PromptOpenFileOptions</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: maroon; line-height: 140%">&quot;Select an image to import and pixelize&quot;</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; pofo.Filter &lt;-</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: maroon; line-height: 140%">&quot;Jpeg Image (*.jpg)|*.jpg|All files (*.*)|*.*&quot;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pfnr = ed.GetFileNameForOpen(pofo)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> file =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">match</span><span style="line-height: 140%"> pfnr.Status </span><span style="color: blue; line-height: 140%">with</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; | PromptStatus.OK </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pfnr.StringResult</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; | _ </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: maroon; line-height: 140%">&quot;&quot;</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> System.IO.File.Exists(file) </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> img = System.Drawing.Image.FromFile(file)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pio =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> PromptIntegerOptions</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: maroon; line-height: 140%">&quot;\nEnter number of horizontal pixels: &quot;</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; pio.AllowNone &lt;- </span><span style="color: blue; line-height: 140%">true</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; pio.UseDefaultValue &lt;- </span><span style="color: blue; line-height: 140%">true</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; pio.LowerLimit &lt;- 1</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; pio.UpperLimit &lt;- img.Width</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; pio.DefaultValue &lt;- 100</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pir = ed.GetInteger(pio)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> xsize =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">match</span><span style="line-height: 140%"> pir.Status </span><span style="color: blue; line-height: 140%">with</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | PromptStatus.None </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; img.Width</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | PromptStatus.OK </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pir.Value</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; | _ </span><span style="color: blue; line-height: 140%">-&gt;</span><span style="line-height: 140%"> -1</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> xsize &gt; 0 </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Calculate the vertical size from the horizontal</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ysize = img.Height * xsize / img.Width</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> ysize &gt; 0 </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// We&#39;ll time the command, so we can check the</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// sync vs. async efficiency</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> starttime = System.DateTime.Now</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// &quot;use&quot; has the same effect as &quot;using&quot; in C#</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">use</span><span style="line-height: 140%"> tr =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.TransactionManager.StartTransaction()</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Get appropriately-typed BlockTable and BTRs</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bt =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.GetObject</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (db.BlockTableId,OpenMode.ForRead)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; :?&gt; BlockTable</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ms =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.GetObject</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (bt.[BlockTableRecord.ModelSpace],</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; OpenMode.ForWrite)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; :?&gt; BlockTableRecord</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Function to create a filled circle (hatch) at a</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// specific location</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Note the valid use of tr and ms, as they are in scope</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> createCircle pt rad =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> hat = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> Hatch()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; hat.SetDatabaseDefaults()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; hat.SetHatchPattern</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (HatchPatternType.PreDefined,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: maroon; line-height: 140%">&quot;SOLID&quot;</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> id = ms.AppendEntity(hat)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(hat, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Now we create the loop, which we make db-resident</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// (appending a transient loop caused problems, so</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// we&#39;re going to use the circle and then erase it)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> cir = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> Circle()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; cir.Radius &lt;- rad</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; cir.Center &lt;- pt</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> lid = ms.AppendEntity(cir)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(cir, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Have the hatch use the loop we created</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> loops = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> ObjectIdCollection()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; loops.Add(lid) |&gt; ignore</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; hat.AppendLoop(HatchLoopTypes.Default, loops)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; hat.EvaluateHatch(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Now we erase the loop</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; cir.Erase()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; id</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Function to create our grid of circles</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> createGrid xsize ysize rad offset =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ids = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> ObjectIdCollection()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> i = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> xsize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> j = 0 </span><span style="color: blue; line-height: 140%">to</span><span style="line-height: 140%"> ysize - 1 </span><span style="color: blue; line-height: 140%">do</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> pt =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> Point3d</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (offset * (Int32.to_float i),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; offset * (Int32.to_float j),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; 0.0)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> id = createCircle pt rad</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ids.Add(id) |&gt; ignore</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ids</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Function to change the colour of an entity</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> changeColour (id : ObjectId) (col : Color) =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> id.IsValid </span><span style="color: blue; line-height: 140%">then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ent =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.GetObject(id, OpenMode.ForWrite) :?&gt; Entity</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ent.Color &lt;- col</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Create our basic grid</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> ids = createGrid xsize ysize 0.5 1.2</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Cast our image to a bitmap and then</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// get the chunked pixels</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> bmp = img :?&gt; System.Drawing.Bitmap</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> arr = pixelizeBitmap bmp xsize ysize</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Loop through the pixel list and average them out</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// (which could be parallelized), using the results</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// to change the colour of the circles in our grid</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Array.map getAverageColour arr |&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Array.iter2 changeColour (getIdArray ids)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Commit the transaction</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.Commit()</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Check how long it took</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">let</span><span style="line-height: 140%"> elapsed =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; System.DateTime.op_Subtraction</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (System.DateTime.Now, starttime)</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.WriteMessage</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: maroon; line-height: 140%">&quot;\nElapsed time: &quot;</span><span style="line-height: 140%"> + elapsed.ToString())</span></p></div> <p>To change this to run the colour averaging asynchronously (in parallel, if you have the cores) is really simple. We replace one line of code &quot;Array.map getAverageColour arr&quot; with the following:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">Async.Run</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; (Async.Parallel</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; [ </span><span style="color: blue; line-height: 140%">for</span><span style="line-height: 140%"> a </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> arr </span><span style="color: blue; line-height: 140%">-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; async { </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> getAverageColour a }])</span></p></div> <p>This essentially performs a parallel array map (albeit a somewhat naive one), returning basically the same results as the previous line - just hopefully a little more quickly. In case you want to build the two files into one project to test them side-by-side, here they are, the <span class="at-xid-6a00d83452464869e2010537017c73970b"><a href="http://through-the-interface.typepad.com/files/pixelizer-sync.fs">synchronous</a> and <span class="at-xid-6a00d83452464869e20111683c4f9c970c"><a href="http://through-the-interface.typepad.com/files/pixelizer-async.fs">asynchronous</a> versions, with the changes needed to allow them to live in and execute from the same assembly.</span></span></p> <p>Here&#39;s one more image that&#39;s been processed by the PIX command:</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201116842bf57970c-pi"><img alt="Pixelized Swiss Air logo" border="0" height="474" src="/assets/image_707448.jpg" style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" width="484" /></a> </p> <p>In case you&#39;re interested, the original image can be found <a href="http://www.travelbrochuregraphics.com/Images_All/Airlines_Images/SwissAir_3.jpg">here</a>.</p>
