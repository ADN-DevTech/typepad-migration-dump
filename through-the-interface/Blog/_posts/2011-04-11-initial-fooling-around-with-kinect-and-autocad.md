---
layout: "post"
title: "Initial fooling around with Kinect and AutoCAD"
date: "2011-04-11 15:03:36"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Kinect"
  - "Point clouds"
  - "Reality capture"
original_url: "https://www.keanw.com/2011/04/initial-fooling-around-with-kinect-and-autocad.html "
typepad_basename: "initial-fooling-around-with-kinect-and-autocad"
typepad_status: "Publish"
---

<p>After a completely <span style="text-decoration: underline;">ridiculous</span> wait of close to 4 months, I finally received my <a href="http://en.wikipedia.org/wiki/Kinect" target="_blank">Kinect</a> a few weeks ago. Apart from it being <a href="http://community.guinnessworldrecords.com/_Kinect-Confirmed-As-Fastest-Selling-Consumer-Electronics-Device/blog/3376939/7691.html" target="_blank">the fastest selling consumer electronics device in history</a>, the delay was also due to the fact I was holding out for the very popular Xbox 360 250Gb Slim bundle (and also because the vendor I chose fumbled the order during the final few weeks, which just added insult to injury). I’d done my homework before receiving the Xbox, and realised that the bundled Kinect would not come with the external power supply needed to connect it to older Xbox systems and – more importantly – to a standard PC. So I went ahead and procured one of those – from <a href="http://ricardo.ch" target="_blank">ricardo.ch</a>, the Swiss equivalent of <a href="http://ebay.com" target="_blank">ebay.com</a> – so I’d be ready to go when it arrived.</p>
<p>I’ve now spent a few hours playing around with the Kinect – both with the Xbox and my PC – to get a feel for its capabilities. I haven’t been disappointed: the device is way cool, and is going to change fundamentally the way we think about <a href="http://en.wikipedia.org/wiki/Human%E2%80%93computer_interaction" target="_blank">HCI</a>.</p>
<p>I won’t get into how badly I play <a href="http://en.wikipedia.org/wiki/Kinect_Adventures" target="_blank">Kinect Adventures</a> or <a href="http://en.wikipedia.org/wiki/Kinect_Sports" target="_blank">Sports</a>, but I did want to discuss my initial attempts at integrating the Kinect with AutoCAD.</p>
<p>Overall there are two things I want to try with the Kinect:</p>
<ol>
<li>Some simple model capture using the Kinect’s RGB-D camera  
<ul>
<li>Perhaps using transient graphics or a jig to generate a dynamic preview of the input </li>
<li>Finally generate a point cloud with full colour information </li>
</ul>
</li>
<li>Some simple gesture-based control of AutoCAD </li>
</ol>
<p>The first seemed a fun approach to test out the Kinect interface, although ultimately the currently-available precision (the resolution has apparently been limited to 640 x 480 to keep the processing snappy) would probably not prove usable for any real-world model capture.</p>
<p>For the second I can see a few ways to utilise the Kinect, whether to create models or navigate through them. There are lots of gnarly issues to address if doing this properly, so I only see myself attempting to tackle a very small (and hopefully clearly defined) subset of the overall problem.</p>
<p>In terms of the actual implementation, it seems there are a few avenues open (and I may be missing some, as I – like most people – am new to all this):</p>
<ol>
<li>Use <a href="http://codelaboratories.com/nui/" target="_blank">the Code Laboratories NUI Platform Driver/SDK</a> 
<ul>
<li>NUI stands for <a href="http://en.wikipedia.org/wiki/Natural_user_interface" target="_blank">Natural User Interface</a> </li>
</ul>
</li>
<li>Use <a href="http://openkinect.org" target="_blank">OpenKinect</a> / <a href="https://github.com/OpenKinect/libfreenect" target="_blank">libfreenect</a> </li>
<li>Use Boris Scheiman’s <a href="http://nkinect.codeplex.com/" target="_blank">nKinect</a> abstraction layer  
<ul>
<li>This currently works on top of option 1, but will apparently be ported to option 2, in due course </li>
</ul>
</li>
<li>Wait for the official SDK from Microsoft Research </li>
</ol>
<p>As I want to integrate with AutoCAD, my first choice is to use a stable Windows driver &amp; SDK combination. At the time of writing, this currently means option 1 (or 3), although I’m hoping there’ll be some kind of release announced for option 4 at <a href="http://www.microsoft.com/events/mix/" target="_blank">MIX11</a> over the next few days.</p>
<p>After I briefly discussed nKinect in <a href="http://through-the-interface.typepad.com/through_the_interface/2011/01/checking-your-application-has-enough-memory-for-an-operation-using-net.html" target="_blank">this previous post</a>, Boris Scheiman has kindly been in touch to discuss the features I’d need from nKinect. Thanks to Boris, the latest version of the toolkit includes point cloud generation and I’ll certainly be taking a look at that, before long.</p>
<p>My first attempts have focused on getting option 1 up and running. After installing the driver and SDK, it was pretty straightforward to get the CLNUIDeviceTest sample application working with the Kinect attached to my PC.</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2014e60918273970c-pi"><img alt="Testing the Kinect" border="0" height="275" src="/assets/image_20002.jpg" style="background-image: none; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; padding-top: 0px; border: 0px;" title="Testing the Kinect" width="479" /></a></p>
<p>What has proven a lot less obvious is to get the same code working inside AutoCAD: after making the initial call to CLNUIDevice.GetDeviceCount(), which tells you how many Kinect devices you have attached, the call to CLNUIDevice.GetDeviceSerial(0) (which should return the first – and only, in my case – Kinect attached) causes AutoCAD to crash uncontrollably. This method should return a string, so my initial reaction – after thinking through the fact it couldn’t be a DLL dependency issue, as the first API call succeeded – was to look at the string marshalling used for the data. I fooled around with that for a while, but didn’t manage to find a solution (which leads me to believe&#0160; the problem is elsewhere).</p>
<p>In the end I went back to working on a standalone EXE which at least gets the data from the Kinect in a format that’s importable into AutoCAD. I created a very simple WPF application, with the main form containing a single button called “CaptureButton” and this C# code behind it:</p>
<div style="font-family: courier new; background: white; color: black; font-size: 8pt;">
<p style="margin: 0px;"><span style="line-height: 140%; color: blue;">using</span><span style="line-height: 140%;"> System.Runtime.InteropServices;</span></p>
<p style="margin: 0px;"><span style="line-height: 140%; color: blue;">using</span><span style="line-height: 140%;"> System.Windows.Media;</span></p>
<p style="margin: 0px;"><span style="line-height: 140%; color: blue;">using</span><span style="line-height: 140%;"> System.Windows;</span></p>
<p style="margin: 0px;"><span style="line-height: 140%; color: blue;">using</span><span style="line-height: 140%;"> System.IO;</span></p>
<p style="margin: 0px;"><span style="line-height: 140%; color: blue;">using</span><span style="line-height: 140%;"> System;</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%; color: blue;">namespace</span><span style="line-height: 140%;"> KinectIntegration</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">{</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160; </span><span style="line-height: 140%; color: blue;">public</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">partial</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">class</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: #2b91af;">MainWindow</span><span style="line-height: 140%;"> : </span><span style="line-height: 140%; color: #2b91af;">Window</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// We&#39;re dealing with 640 x 480 input</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">const</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> width = 640;</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">const</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> height = 480;</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">public</span><span style="line-height: 140%;"> MainWindow()</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; InitializeComponent();</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">private</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">static</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> GetDepth(</span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> d)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Extract the bits we need from a depth value</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">return</span><span style="line-height: 140%;"> d &amp; 0x7FF;</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">private</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">static</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">void</span><span style="line-height: 140%;"> GetDepths(</span><span style="line-height: 140%; color: #2b91af;">IntPtr</span><span style="line-height: 140%;"> source, </span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;">[] dest)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">if</span><span style="line-height: 140%;"> (source != </span><span style="line-height: 140%; color: #2b91af;">IntPtr</span><span style="line-height: 140%;">.Zero)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">for</span><span style="line-height: 140%;"> (</span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> i = 0; i &lt; dest.Length; i++)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; dest[i] = GetDepth(</span><span style="line-height: 140%; color: #2b91af;">Marshal</span><span style="line-height: 140%;">.ReadInt16(source, i * 2));</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">private</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">static</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: #2b91af;">Color</span><span style="line-height: 140%;"> GetColor(</span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> c)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Extract the ARGB values from a 32-bit integer</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;"> b = (</span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;">)(c &amp; 0xFF);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;"> g = (</span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;">)((c &gt;&gt; 8) &amp; 0xFF);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;"> r = (</span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;">)((c &gt;&gt; 16) &amp; 0xFF);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;"> a = (</span><span style="line-height: 140%; color: blue;">byte</span><span style="line-height: 140%;">)((c &gt;&gt; 24) &amp; 0xFF);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Return the corresponding color</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">return</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: #2b91af;">Color</span><span style="line-height: 140%;">.FromArgb(a, r, g, b);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">private</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">static</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">void</span><span style="line-height: 140%;"> GetColors(</span><span style="line-height: 140%; color: #2b91af;">IntPtr</span><span style="line-height: 140%;"> source, </span><span style="line-height: 140%; color: #2b91af;">Color</span><span style="line-height: 140%;">[] dest)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">if</span><span style="line-height: 140%;"> (source != </span><span style="line-height: 140%; color: #2b91af;">IntPtr</span><span style="line-height: 140%;">.Zero)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">for</span><span style="line-height: 140%;"> (</span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> i = 0; i &lt; dest.Length; i++)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; dest[i] = GetColor(</span><span style="line-height: 140%; color: #2b91af;">Marshal</span><span style="line-height: 140%;">.ReadInt32(source, i * 4));</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">private</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">void</span><span style="line-height: 140%;"> ExportPointCloud(</span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;">[] depths, </span><span style="line-height: 140%; color: #2b91af;">Color</span><span style="line-height: 140%;">[] cols)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Hardcode the creation of a text file to C:\</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">using</span><span style="line-height: 140%;"> (</span><span style="line-height: 140%; color: #2b91af;">StreamWriter</span><span style="line-height: 140%;"> sw = </span><span style="line-height: 140%; color: blue;">new</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: #2b91af;">StreamWriter</span><span style="line-height: 140%;">(</span><span style="line-height: 140%; color: #a31515;">&quot;c:\\pc.txt&quot;</span><span style="line-height: 140%;">))</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// For each pixel, write a line to the text file:</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// X, Y, Z, R, G, B</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">for</span><span style="line-height: 140%;"> (</span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> i = 0; i &lt; height; i++)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">for</span><span style="line-height: 140%;"> (</span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> j = 0; j &lt; width; j++)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">Color</span><span style="line-height: 140%;"> col = cols[(i * width) + j];</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; sw.WriteLine(</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #a31515;">&quot;{0}, {1}, {2}, {3}, {4}, {5}&quot;</span><span style="line-height: 140%;">,</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; j, height - i, -depths[(i * width) + j],</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; col.R, col.G, col.B</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">private</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">void</span><span style="line-height: 140%;"> CaptureButton_Click(</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">object</span><span style="line-height: 140%;"> sender, </span><span style="line-height: 140%; color: #2b91af;">RoutedEventArgs</span><span style="line-height: 140%;"> e</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; )</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">try</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Check how many devices we have</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;"> devNum = </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.GetDeviceCount();</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">if</span><span style="line-height: 140%;"> (devNum &lt; 1)</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// We need at least one connected</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">return</span><span style="line-height: 140%;">;</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// For now work with the first device found</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">string</span><span style="line-height: 140%;"> devSerial = </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.GetDeviceSerial(0);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Start the motor and the camera</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">IntPtr</span><span style="line-height: 140%;"> motor = </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.CreateMotor(devSerial);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">IntPtr</span><span style="line-height: 140%;"> camera = </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.CreateCamera(devSerial);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Reset the motor position</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.SetMotorPosition(motor, 0);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Create our color and depth images</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">NUIImage</span><span style="line-height: 140%;"> colorImage = </span><span style="line-height: 140%; color: blue;">new</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: #2b91af;">NUIImage</span><span style="line-height: 140%;">(width, height);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">NUIImage</span><span style="line-height: 140%;"> depthImage = </span><span style="line-height: 140%; color: blue;">new</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: #2b91af;">NUIImage</span><span style="line-height: 140%;">(width, height);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// If the camera started...</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">if</span><span style="line-height: 140%;"> (</span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.StartCamera(camera))</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// ... capture color and depth images</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.GetCameraColorFrameRGB32(</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; camera, colorImage.ImageData, 500</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.GetCameraDepthFrameRAW(</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; camera, depthImage.ImageData, 500</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Extract the depth information</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;">[] depths = </span><span style="line-height: 140%; color: blue;">new</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: blue;">int</span><span style="line-height: 140%;">[width * height];</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetDepths(depthImage.ImageData, depths);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// And the color information</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">Color</span><span style="line-height: 140%;">[] cols = </span><span style="line-height: 140%; color: blue;">new</span><span style="line-height: 140%;"> </span><span style="line-height: 140%; color: #2b91af;">Color</span><span style="line-height: 140%;">[width * height];</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetColors(colorImage.ImageData, cols);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Create a point cloud file for processing</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// by txt2las.exe</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ExportPointCloud(depths, cols);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Stop the camera</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.StopCamera(camera);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// And reset/destroy everything</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.SetMotorLED(motor, 0);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.DestroyMotor(motor);</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: #2b91af;">CLNUIDevice</span><span style="line-height: 140%;">.DestroyCamera(camera);</span></p>
<p style="margin: 0px;">&#0160;</p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: green;">// Closes the main dialog</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">this</span><span style="line-height: 140%;">.Close();</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%; color: blue;">catch</span><span style="line-height: 140%;"> { }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160;&#0160;&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">&#0160; }</span></p>
<p style="margin: 0px;"><span style="line-height: 140%;">}</span></p>
</div>
<p>Once the “capture” is complete, we have a point cloud file in “C:\pc.txt” with a line of X, Y, Z, R, G, B values for each point.</p>
<p>It’s now a simple matter to use our old friend <a href="http://liblas.org/utilities/txt2las.html" target="_blank">txt2las.exe</a> (which we’ve used extensively when bringing <a href="http://through-the-interface.typepad.com/through_the_interface/2010/10/octobers-plugin-of-the-month-browsephotosynth-for-autocad.html" target="_blank">point cloud data</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2010/08/bringing-3ds-max-point-clouds-into-autocad-2011.html" target="_blank">into AutoCAD</a>) to create a LAS, using the string “txt2las –parse xyzRGB –i pc.txt –o pc.las”:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2014e608b2d8a970c-pi"><img alt="txt2las creating our LAS file" border="0" height="116" src="/assets/image_624444.jpg" style="background-image: none; margin: 0px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; padding-top: 0px; border-width: 0px;" title="txt2las creating our LAS file" width="479" /></a></p>
<p>And from there POINTCLOUDINDEX / POINTCLOUDATTACH will bring in the point cloud into AutoCAD:</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2014e876cafa7970d-pi"><img alt="Our Kinect-captured point cloud" border="0" height="315" src="/assets/image_220575.jpg" style="background-image: none; margin: 0px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; padding-top: 0px; border: 0px;" title="Our Kinect-captured point cloud" width="407" /></a></p>
<p>Rotating the view in 3D allows us to see that is at least has some rudimentary depth information (aside from the <a href="http://en.wikipedia.org/wiki/Infrared" target="_blank">IR</a>-based depth camera losing accuracy at distance, we passed the depth in verbatim rather than normalising it in some way with the 640 x 480 indeces we used for the X &amp; Y coordinates in the point cloud):</p>
<p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2014e6091855f970c-pi"><img alt="Rotated view, to show depth" border="0" height="225" src="/assets/image_379890.jpg" style="background-image: none; margin: 0px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; padding-top: 0px; border: 0px;" title="Rotated view, to show depth" width="475" /></a></p>
<p>The data is coming in reasonably well, at this stage, so we have a foundation upon which to build a more dynamic solution. I’ll probably spend a little time, this week, seeing if it’s possible to get the same thing working directly inside AutoCAD (while crossing my fingers for the release of the official Windows drivers).</p>
<p><strong><em>Update</em></strong></p>
<p>I fixed a minor glitch in the code (negating the Z coordinate to make it depth instead of height) and retook the screenshots (this time at night rather during the day, as that’s when I’m updating the post :-).</p>
