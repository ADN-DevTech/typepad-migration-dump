---
layout: "post"
title: "Integrating physics into AutoCAD using JavaScript"
date: "2015-02-11 10:28:59"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "HTML"
  - "JavaScript"
  - "Solid modeling"
original_url: "https://www.keanw.com/2015/02/integrating-physics-into-autocad-using-javascript.html "
typepad_basename: "integrating-physics-into-autocad-using-javascript"
typepad_status: "Publish"
---

<p>My esteemed colleagues over in the ADN team, Philippe and Balaji, have been working their magic, creating samples to show how to make use of JavaScript-based physics engines within Autodesk software. They’ve inspired me to have a go myself.</p>  <p><a href="http://adndevblog.typepad.com/cloud_and_mobile/2015/01/integrating-ammojs-physics-with-autodesk-view-data-api.html" target="_blank">Philippe’s sample</a> – which carried on from <a href="http://adndevblog.typepad.com/cloud_and_mobile/2014/12/fun-with-the-physics.html" target="_blank">his preliminary research</a> into JavaScript-based physics engines – shows how you can integrate <a href="https://github.com/kripken/ammo.js/" target="_blank">ammo.js</a> with the <a href="http://developer.autodesk.com" target="_blank">View &amp; Data API</a> to add some gravity to an A360 model. Really fun stuff!</p>  <p>[Side note: I love that ammo.js stands for “Avoid Making My Own physics engine” as well as being an <a href="https://github.com/kripken/emscripten" target="_blank">emscripten</a> port of the popular <a href="https://github.com/bulletphysics/bullet3" target="_blank">Bullet</a> physics engine. That’s a truly excellent acronym. :-)]</p>  <p><a href="http://adndevblog.typepad.com/autocad/2015/01/using-physijs-for-collision-detection-in-autocad.html" target="_blank">Balaji’s sample</a> is more AutoCAD-centric. He uses <a href="http://chandlerprall.github.io/Physijs" target="_blank">Physijs</a> – which is based on ammo.js but targets Three.js specifically – to add Physics to an AutoCAD-hosted JavaScript app. As a starting point he took <a href="http://through-the-interface.typepad.com/through_the_interface/2014/10/connecting-threejs-to-an-autocad-model-part-2.html" target="_blank">my Three.js sample</a>, extending it to show how collision detection can be used with an AutoCAD model – albeit with the heavy lifting performed inside an HTML palette – to model the rotation of a swing arm. Balaji’s background – before software – is as a mechanical engineer, so this is bread and butter for him, of course.</p>  <br /><iframe height="264" src="https://www.youtube.com/embed/W8-GfDdSKnU?rel=0&amp;showinfo=0" frameborder="0" width="470" allowfullscreen="allowfullscreen"></iframe>  <br />  <br />  <p>I’m basically a software engineer, which no doubt makes me much more frivolous. Rather than building a useful sample using Physijs, as Balaji has done, I decided to integrate one of the existing Physijs samples inside AutoCAD, and to have a bit of fun of my own at the same time.</p>  <p>Of the various demo samples posted on the Physijs site, the one that stands out for me is <a href="http://chandlerprall.github.com/Physijs/examples/jenga.html" target="_blank">the Jenga sample</a>. All my family loves that game. While the demo doesn’t really include any gameplay, per se – it’s just a scene you can play around with – it feels very realistic. A nice demo of the engine’s capabilities when combined with Three.js.</p>  <p>I decided to take that sample as is, but integrate it into an AutoCAD palette and provide the ability to capture the graphics in the scene, bringing the various blocks into the current drawing as Solid3d objects.</p>  <p>Here’s how the integration ended up working:</p>  <br /><iframe height="264" src="https://www.youtube.com/embed/c7Q6gjMpSE8?rel=0&amp;showinfo=0" frameborder="0" width="470" allowfullscreen="allowfullscreen"></iframe>  <br />  <br />  <p>Here's the C# code, which is fairly unexceptional – the main trick being to apply the Euler angles in the right order when building our transformation matrix. Three.js is Y-up rather than Z-up, so this took me some work to get right.</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Geometry;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Windows;</p>    <p style="margin: 0px"><span style="color: blue">using</span> Newtonsoft.Json.Linq;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Runtime.InteropServices;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> JavaScriptSamples</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PhysicsCommands</span></p>    <p style="margin: 0px">&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">PaletteSet</span> _pps = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">Document</span> _curDoc = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">DllImport</span>(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;AcJsCoreStub.crx&quot;</span>, CharSet = <span style="color: #2b91af">CharSet</span>.Auto,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; CallingConvention = <span style="color: #2b91af">CallingConvention</span>.Cdecl,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; EntryPoint = <span style="color: #a31515">&quot;acjsInvokeAsync&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">extern</span> <span style="color: blue">static</span> <span style="color: blue">private</span> <span style="color: blue">int</span> acjsInvokeAsync(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> name, <span style="color: blue">string</span> jsonArgs</p>    <p style="margin: 0px">&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;JENGA&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> JengaPalette()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _curDoc =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _pps =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Utils</span>.ShowPalette(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _pps,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">Guid</span>(<span style="color: #a31515">&quot;ABDC33C6-5F7C-4366-B171-2F824097CD4B&quot;</span>),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;JENGA&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;Physi.js Examples&quot;</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetHtmlPathJenga()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _pps.SizeChanged += OnPaletteSizeChanged;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;JENGADOC&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> JengaDocument()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _curDoc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_curDoc != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _curDoc.BeginDocumentClose += (s, e) =&gt; _curDoc = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentWindowCollection.AddDocumentWindow(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;Physi.js Document&quot;</span>, GetHtmlPathJenga()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Create some classes to simplify de-serializing JSON</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// from our web-page</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Vector3</span></p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">double</span> x { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">double</span> y { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">double</span> z { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">SolidInfo</span></p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: #2b91af">Vector3</span> position { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: #2b91af">Vector3</span> rotation { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">double</span> length { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">double</span> height { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">double</span> width { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">JavaScriptCallback</span>(<span style="color: #a31515">&quot;JengaSolids&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> JengaSolids(<span style="color: blue">string</span> jsonArgs)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> res = <span style="color: #a31515">&quot;{\&quot;retCode\&quot;:1}&quot;</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> doc =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doc = _curDoc;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> res;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ed = doc.Editor;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> db = doc.Database;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (<span style="color: blue">var</span> l = doc.LockDocument())</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">using</span> (<span style="color: blue">var</span> tr = doc.TransactionManager.StartTransaction())</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> bt =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">BlockTable</span>)tr.GetObject(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.BlockTableId,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">OpenMode</span>.ForRead,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">false</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> btr =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">BlockTableRecord</span>)tr.GetObject(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bt[<span style="color: #2b91af">BlockTableRecord</span>.ModelSpace],</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">OpenMode</span>.ForWrite,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">false</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ja = <span style="color: #2b91af">JArray</span>.Parse(jsonArgs);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> sols = ja.ToObject&lt;<span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">SolidInfo</span>&gt;&gt;();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> sol <span style="color: blue">in</span> sols)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">double</span> length = sol.length,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; width = sol.width,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; height = sol.height;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> dbs = <span style="color: blue">new</span> <span style="color: #2b91af">Solid3d</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbs.CreateBox(length, width, height);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> p = sol.position;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> c = <span style="color: #2b91af">Point3d</span>.Origin;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> disp =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Matrix3d</span>.Displacement(<span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(p.x, p.y, p.z));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> rotx =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Matrix3d</span>.Rotation(sol.rotation.x, <span style="color: #2b91af">Vector3d</span>.XAxis, c);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> roty =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Matrix3d</span>.Rotation(sol.rotation.y, <span style="color: #2b91af">Vector3d</span>.YAxis, c);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> rotz =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Matrix3d</span>.Rotation(sol.rotation.z, <span style="color: #2b91af">Vector3d</span>.ZAxis, c);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Combine them following the &quot;XYZ&quot; order used in</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Three.js (although z and y are flipped)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> mat =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; roty.PreMultiplyBy(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rotz.PreMultiplyBy(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rotx.PreMultiplyBy(disp)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbs.TransformBy(mat);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; btr.AppendEntity(dbs);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.AddNewlyCreatedDBObject(dbs, <span style="color: blue">true</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tr.Commit();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: #a31515">&quot;{\&quot;retCode\&quot;:0}&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> OnPaletteSizeChanged(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">object</span> s, <span style="color: #2b91af">PaletteSetSizeEventArgs</span> e</p>    <p style="margin: 0px">&#160;&#160;&#160; )</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (_pps != <span style="color: blue">null</span> &amp;&amp; _pps.Count &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acjsInvokeAsync(<span style="color: #a31515">&quot;refresh&quot;</span>, <span style="color: #a31515">&quot;{}&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">Uri</span> GetHtmlPathJenga()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">Uri</span>(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//Utils.GetHtmlPath() +</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;http://through-the-interface.typepad.com/files/&quot;</span> +</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;jenga/jenga.html&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>Of more interest, overall, is the HTML file. Most of which comes from the Physijs sample verbatim, of course. The main piece I’ve added is the ability to package up the blocks from the scene as JSON for sending over to AutoCAD.</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%">   <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: maroon">!DOCTYPE</span> <span style="color: red">html</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: maroon">html</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">head</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">title</span><span style="color: blue">&gt;</span>Jenga - Physijs<span style="color: blue">&lt;/</span><span style="color: maroon">title</span><span style="color: blue">&gt;</span>&#160; </p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">style</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: maroon">html</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">margin</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">padding</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }&#160; </p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: maroon">body</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">margin</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">padding</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">font-family</span>: <span style="color: blue">Verdana</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">font-size</span>: <span style="color: blue">10pt</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">overflow</span>: <span style="color: blue">hidden</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: maroon">#viewport</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">position</span>: <span style="color: blue">relative</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: maroon">#heading</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">position</span>: <span style="color: blue">absolute</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">bottom</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">width</span>: <span style="color: blue">100%</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">margin</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">padding</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">background-color</span>: <span style="color: blue">#71b87b</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">text-align</span>: <span style="color: blue">center</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">-moz-user-select</span>: <span style="color: blue">none</span>; </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">-khtml-user-select</span>: <span style="color: blue">none</span>; </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">-webkit-user-select</span>: <span style="color: blue">none</span>; </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">-o-user-select</span>: <span style="color: blue">none</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: maroon">#heading</span> <span style="color: maroon">h1</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">margin</span>: <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">padding</span>: <span style="color: blue">6px</span> <span style="color: blue">0</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">background-color</span>: <span style="color: blue">#64a36d</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">font-size</span>: <span style="color: blue">16px</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">font-family</span>: <span style="color: blue">'Segoe UI'</span>, <span style="color: blue">Tahoma</span>, <span style="color: blue">Geneva</span>, <span style="color: blue">Verdana</span>, <span style="color: blue">sans-serif</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">vertical-align</span>: <span style="color: blue">bottom</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">style</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">type</span><span style="color: blue">=&quot;text/javascript&quot;</span> <span style="color: red">src</span><span style="color: blue">=&quot;js/three.min.js&quot;&gt;&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">type</span><span style="color: blue">=&quot;text/javascript&quot;</span> <span style="color: red">src</span><span style="color: blue">=&quot;js/stats.js&quot;&gt;&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">type</span><span style="color: blue">=&quot;text/javascript&quot;</span> <span style="color: red">src</span><span style="color: blue">=&quot;js/physi.js&quot;&gt;&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span>&#160; </p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: red">src</span><span style="color: blue">=&quot;http://app.autocad360.com/jsapi/v2/Autodesk.AutoCAD.js&quot;&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">script</span> <span style="color: red">type</span><span style="color: blue">=&quot;text/javascript&quot;&gt;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #a31515">'use strict'</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; Physijs.scripts.worker = <span style="color: #a31515">'js/physijs_worker.js'</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; Physijs.scripts.ammo = <span style="color: #a31515">'ammo.js'</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">function</span> sendBlocksToAutoCAD(jsonArgs) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> jsonResponse =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; exec(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; JSON.stringify({</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; functionName: <span style="color: #a31515">'JengaSolids'</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; invokeAsCommand: <span style="color: blue">false</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; functionParams: jsonArgs</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; })</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> jsonObj = JSON.parse(jsonResponse);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (jsonObj.retCode !== Acad.ErrorStatus.eJsOk) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">throw</span> Error(jsonObj.retErrorString);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> jsonObj.result;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">var</span> sendBlocks, initScene, initEventHandling, render,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; createTower, renderer, scene,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light, am_light, camera, table, blocks = [],</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; table_material, block_material, intersect_plane,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; selected_block = <span style="color: blue">null</span>, mouse_position = <span style="color: blue">new</span> THREE.Vector3,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; block_offset = <span style="color: blue">new</span> THREE.Vector3, _i,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; _v3 = <span style="color: blue">new</span> THREE.Vector3;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; sendBlocks = <span style="color: blue">function</span> () {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: blue">typeof</span> exec !== <span style="color: #a31515">&quot;undefined&quot;</span>) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> objects = [], obj, block;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">for</span> (<span style="color: blue">var</span> i=0; i &lt; blocks.length; i++) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block = blocks[i];</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj = <span style="color: blue">new</span> Object();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.position = {};</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.position.x = block.position.x;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.position.y = -block.position.z;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.position.z = block.position.y;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.rotation = {};</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.rotation.x = block.rotation.x;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.rotation.y = -block.rotation.z;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.rotation.z = block.rotation.y;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ext = block.geometry.boundingBox;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.length = Math.abs(ext.max.x - ext.min.x);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.height = Math.abs(ext.max.y - ext.min.y);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj.width = Math.abs(ext.max.z - ext.min.z);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; objects.push(obj);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; sendBlocksToAutoCAD(objects);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; initScene = <span style="color: blue">function</span>() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; renderer = <span style="color: blue">new</span> THREE.WebGLRenderer({ antialias: <span style="color: blue">true</span> });</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; renderer.setSize(window.innerWidth, window.innerHeight);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; renderer.shadowMapEnabled = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; renderer.shadowMapSoft = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> vp = document.getElementById(<span style="color: #a31515">'viewport'</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; vp.appendChild(renderer.domElement);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene = <span style="color: blue">new</span> Physijs.Scene({ fixedTimeStep: 1 / 120 });</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.setGravity(<span style="color: blue">new</span> THREE.Vector3(0, -30, 0));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.addEventListener(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">'update'</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">function</span>() {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (selected_block !== <span style="color: blue">null</span>) {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _v3.copy(mouse_position).add(block_offset).</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sub(selected_block.position).multiplyScalar(5);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _v3.y = 0;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.setLinearVelocity(_v3);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Reactivate all of the blocks</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _v3.set(0, 0, 0);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">for</span> (_i = 0; _i &lt; blocks.length; _i++) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; blocks[_i].applyCentralImpulse(_v3);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; scene.simulate(undefined, 1);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; camera = <span style="color: blue">new</span> THREE.PerspectiveCamera(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 35,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; window.innerWidth / window.innerHeight,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1000</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; camera.position.set(25, 20, 25);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; camera.lookAt(<span style="color: blue">new</span> THREE.Vector3(0, 7, 0));</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.add(camera);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// ambient light</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; am_light = <span style="color: blue">new</span> THREE.AmbientLight(0x444444);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.add(am_light);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// directional light</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light = <span style="color: blue">new</span> THREE.DirectionalLight(0xFFFFFF);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.position.set(20, 30, -5);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.target.position.copy(scene.position);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.castShadow = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowCameraLeft = -30;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowCameraTop = -30;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowCameraRight = 30;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowCameraBottom = 30;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowCameraNear = 20;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowCameraFar = 200;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowBias = -.001</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowMapWidth = dir_light.shadowMapHeight = 2048;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; dir_light.shadowDarkness = .5;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.add(dir_light);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Materials</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; table_material = Physijs.createMaterial(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.MeshLambertMaterial({</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; map: THREE.ImageUtils.loadTexture(<span style="color: #a31515">'images/wood.jpg'</span>),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ambient: 0xFFFFFF</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; .9, <span style="color: green">// high friction</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; .2 <span style="color: green">// low restitution</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; table_material.map.wrapS =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; table_material.map.wrapT = THREE.RepeatWrapping;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; table_material.map.repeat.set(5, 5);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; block_material = Physijs.createMaterial(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.MeshLambertMaterial({</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; map: THREE.ImageUtils.loadTexture(<span style="color: #a31515">'images/plywood.jpg'</span>),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ambient: 0xFFFFFF</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; .4, <span style="color: green">// medium friction</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; .4 <span style="color: green">// medium restitution</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; block_material.map.wrapS =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; block_material.map.wrapT = THREE.RepeatWrapping;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; block_material.map.repeat.set(1, .5);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Table</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; table = <span style="color: blue">new</span> Physijs.BoxMesh(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.BoxGeometry(50, 1, 50),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; table_material,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0, <span style="color: green">// mass</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; { restitution: .2, friction: .8 }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; table.position.y = -.5;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; table.receiveShadow = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.add(table);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; createTower();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; intersect_plane = <span style="color: blue">new</span> THREE.Mesh(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.PlaneGeometry(150, 150),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.MeshBasicMaterial({</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; opacity: 0, transparent: <span style="color: blue">true</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; })</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; intersect_plane.rotation.x = Math.PI / -2;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.add(intersect_plane);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; initEventHandling();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; requestAnimationFrame(render);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; scene.simulate();</p>    <p style="margin: 0px">&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; render = <span style="color: blue">function</span>() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; requestAnimationFrame(render);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; renderer.render(scene, camera);</p>    <p style="margin: 0px">&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; createTower = (<span style="color: blue">function</span>() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> block_length = 6, block_height = 1, block_width = 1.5,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; block_offset = 2,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; block_geometry =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.BoxGeometry(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block_length, block_height, block_width</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">function</span>() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> i, j, rows = 16, block;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">for</span> (i = 0; i &lt; rows; i++) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">for</span> (j = 0; j &lt; 3; j++) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> Physijs.BoxMesh(block_geometry, block_material);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block.position.y =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (block_height / 2) + block_height * i;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (i % 2 === 0) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// #TODO:</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// There's a bug somewhere when this is too close to 2</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block.rotation.y = Math.PI / 2.01;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block.position.x =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block_offset * j -</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (block_offset * 3 / 2 - block_offset / 2);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <span style="color: blue">else</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block.position.z =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block_offset * j -</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (block_offset * 3 / 2 - block_offset / 2);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block.receiveShadow = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block.castShadow = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; scene.add(block);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; blocks.push(block);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; })();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; initEventHandling = (<span style="color: blue">function</span>() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> _vector = <span style="color: blue">new</span> THREE.Vector3,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; projector = <span style="color: blue">new</span> THREE.Projector(),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; handleMouseDown, handleMouseMove, handleMouseUp;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; handleMouseDown = <span style="color: blue">function</span>(evt) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ray, intersections;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vector.set(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (evt.clientX / window.innerWidth) * 2 - 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; -(evt.clientY / window.innerHeight) * 2 + 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; projector.unprojectVector(_vector, camera);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ray =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.Raycaster(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; camera.position,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vector.sub(camera.position).normalize()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; intersections = ray.intersectObjects(blocks);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (intersections.length &gt; 0) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block = intersections[0].object;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vector.set(0, 0, 0);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.setAngularFactor(_vector);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.setAngularVelocity(_vector);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.setLinearFactor(_vector);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.setLinearVelocity(_vector);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mouse_position.copy(intersections[0].point);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; block_offset.subVectors(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.position, mouse_position</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; intersect_plane.position.y = mouse_position.y;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; handleMouseMove = <span style="color: blue">function</span>(evt) {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> ray, intersection, i, scalar;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (selected_block !== <span style="color: blue">null</span>) {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vector.set(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (evt.clientX / window.innerWidth) * 2 - 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; -(evt.clientY / window.innerHeight) * 2 + 1,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; projector.unprojectVector(_vector, camera);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ray =</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> THREE.Raycaster(</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; camera.position,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vector.sub(camera.position).normalize()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; intersection = ray.intersectObject(intersect_plane);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mouse_position.copy(intersection[0].point);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; handleMouseUp = <span style="color: blue">function</span>(evt) {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (selected_block !== <span style="color: blue">null</span>) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _vector.set(1, 1, 1);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.setAngularFactor(_vector);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block.setLinearFactor(_vector);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; selected_block = <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">function</span>() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> de = renderer.domElement;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; de.addEventListener(<span style="color: #a31515">'mousedown'</span>, handleMouseDown);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; de.addEventListener(<span style="color: #a31515">'mousemove'</span>, handleMouseMove);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; de.addEventListener(<span style="color: #a31515">'mouseup'</span>, handleMouseUp);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; };</p>    <p style="margin: 0px">&#160;&#160;&#160; })();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; window.onload = initScene;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">function</span> refreshPage(args) {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; camera.aspect = window.innerWidth / window.innerHeight;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; camera.updateProjectionMatrix();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; renderer.setSize(window.innerWidth, window.innerHeight);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; registerCallback(<span style="color: #a31515">&quot;refresh&quot;</span>, refreshPage);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">head</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;</span><span style="color: maroon">body</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">div</span> <span style="color: red">id</span><span style="color: blue">=&quot;viewport&quot;&gt;&lt;/</span><span style="color: maroon">div</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">div</span> <span style="color: red">id</span><span style="color: blue">=&quot;heading&quot;&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">&lt;</span><span style="color: maroon">h1</span> <span style="color: red">onclick</span><span style="color: blue">=&quot;</span>sendBlocks();<span style="color: blue">&quot;&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Have a play, then click here to import</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">h1</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">div</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">&lt;/</span><span style="color: maroon">body</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: maroon">html</span><span style="color: blue">&gt;</span></p> </div>  <p>That’s it for this brief look at integrating physics into AutoCAD palettes, and having the HTML/JavaScript code hosted in those palettes drive AutoCAD model changes. The sample I chose lacks practical value in and of itself, but that’s not really the point. The point is to show that you can connect a physics-based 3D scene that’s hosted in an HTML palette with AutoCAD. In this case we’ve made the link in one direction but we might also have populated the scene with the contents of the modelspace. In any case, Balaji’s already done a nice real-world sample, as we saw earlier, which left plenty of space for me to fool around.</p>  <p>If you’re after a deeper physics integration, I suggest looking into the work done by my team-mate Christer Janson – which despite being mentioned in this<a href="http://through-the-interface.typepad.com/through_the_interface/2012/03/360-convergence.html" target="_blank"> April Fools’ post</a> does actually exist – using ObjectARX to integrate the <a href="http://box2d.org" target="_blank">Box2D</a> physics engine into AutoCAD to give the modelspace contents physical properties and behaviours. You can download his <a href="http://au.autodesk.com/au-online/classes-on-demand/class-catalog/2012/autocad/grumpyblocks-a-tale-of-writing-a-game-in-autocad-using-objectarx" target="_blank">presentation with demo material from the AU website</a>.</p>
