---
layout: "post"
title: "Exposing AutoCAD's Properties Palette functionality to .NET - Part 2"
date: "2009-03-16 11:36:01"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Object properties"
  - "ObjectARX"
original_url: "https://www.keanw.com/2009/03/exposing-autocads-properties-palette-functionality-to-net---part-2.html "
typepad_basename: "exposing-autocads-properties-palette-functionality-to-net---part-2"
typepad_status: "Publish"
---

<p><em>In </em><a href="http://through-the-interface.typepad.com/through_the_interface/2009/03/exposing-autocads-properties-palette-functionality-to-net---part-1.html"><em>the last post</em></a><em> we looked at the code behind an ObjectARX module exposing AutoCAD&#39;s Properties Palette for use from managed .NET languages. Thanks again to Cyrille Fauvel for providing this implementation. In this post we&#39;re going to move right onto using this implementation from C#.</em></p> <p>First things first: if you didn&#39;t understand much of what was said in the previous post in this series, <span style="text-decoration: underline">Don&#39;t Panic!</span> (Yes, that&#39;s a quick reference to <a href="http://en.wikipedia.org/wiki/The_Hitchhiker&#39;s_Guide_to_the_Galaxy">The Hitchhiker&#39;s Guide to the Galaxy</a>.) The actual implementation details aren&#39;t particularly important - you only really need to understand them if you want to expose additional interfaces to .NET in the same way (such as IFilterableProperty, the interface discussed in <a href="http://through-the-interface.typepad.com/through_the_interface/2008/11/adding-custom-p.html">this previous post</a> and something I expect to extend the application to handle, at some point).</p> <p><span class="at-xid-6a00d83452464869e20112796dc91928a4"><a href="http://through-the-interface.typepad.com/files/opm.net.zip">Here is the project</a> that contains both the ObjectARX module implementing exposing these interfaces and the sample we&#39;re showing today. You simply have to make sure the .NET module can find our asdkOPMNetExt.dll module (ideally both this and your .NET module should be located under AutoCAD&#39;s program folder).</span></p> <p>Then you can simply implement code, as in the below sample, which loads and makes use of interfaces exposed by this assembly.</p> <p>Here’s the C# code:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new">  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Windows.OPM;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Reflection;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Runtime.InteropServices;</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPMNetSample</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">&#0160; #region</span><span style="line-height: 140%"> Our Custom Property</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; [</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Guid</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;F60AE3DA-0373-4d24-82D2-B2646517ABCB&quot;</span><span style="line-height: 140%">),</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ProgId</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;OPMNetSample.CustomProperty.1&quot;</span><span style="line-height: 140%">),</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// No class interface is generated for this class and</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// no interface is marked as the default.</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Users are expected to expose functionality through</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// interfaces that will be explicitly exposed by the object</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// This means the object can only expose interfaces we define</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ClassInterface</span><span style="line-height: 140%">(</span><span style="color: #2b91af; line-height: 140%">ClassInterfaceType</span><span style="line-height: 140%">.None),</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Set the default COM interface that will be used for</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Automation. Languages like: C#, C++ and VB allow to </span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//query for interface&#39;s we&#39;re interested in but Automation </span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// only aware languages like javascript do not allow to </span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// query interface(s) and create only the default one</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ComDefaultInterface</span><span style="line-height: 140%">(</span><span style="color: blue; line-height: 140%">typeof</span><span style="line-height: 140%">(</span><span style="color: #2b91af; line-height: 140%">IDynamicProperty2</span><span style="line-height: 140%">)),</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ComVisible</span><span style="line-height: 140%">(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; ]</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">CustomProp</span><span style="line-height: 140%"> : </span><span style="color: #2b91af; line-height: 140%">IDynamicProperty2</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">IDynamicPropertyNotify2</span><span style="line-height: 140%"> m_pSink = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Unique property ID</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetGUID(</span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Guid</span><span style="line-height: 140%"> propGUID)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; propGUID =</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Guid</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;F60AE3DA-0373-4d24-82D2-B2646517ABCB&quot;</span><span style="line-height: 140%">);</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Property display name</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDisplayName(</span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%"> szName)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; szName = </span><span style="color: #a31515; line-height: 140%">&quot;My integer property&quot;</span><span style="line-height: 140%">;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Show/Hide property in the OPM, for this object instance</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> IsPropertyEnabled(</span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> pUnk, </span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> bEnabled)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; bEnabled = 1;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Is property showing but disabled</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> IsPropertyReadOnly(</span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> bReadonly)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; bReadonly = 0;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Get the property description string</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDescription(</span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%"> szName)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; szName =</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;This property is an integer&quot;</span><span style="line-height: 140%">;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// OPM will typically display these in an edit field</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// optional: meta data representing property type name,</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// ex. ACAD_ANGLE</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetCurrentValueName(</span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%"> szName)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">throw</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> System.</span><span style="color: #2b91af; line-height: 140%">NotImplementedException</span><span style="line-height: 140%">();</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// What is the property type, ex. VT_R8</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetCurrentValueType(</span><span style="color: blue; line-height: 140%">out</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">ushort</span><span style="line-height: 140%"> varType)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// The Property Inspector supports the following data</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// types for dynamic properties:</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// VT_I2, VT_I4, VT_R4, VT_R8,VT_BSTR, VT_BOOL</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// and VT_USERDEFINED. </span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; varType = 3; </span><span style="color: green; line-height: 140%">// VT_I4</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Get the property value, passes the specific object</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// we need the property value for.</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetCurrentValueData(</span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> pUnk, </span><span style="color: blue; line-height: 140%">ref</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> pVarData)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// TODO: Get the value and return it to AutoCAD</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Because we said the value type was a 32b int (VT_I4)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; pVarData = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)4;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Set the property value, passes the specific object we</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// want to set the property value for</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> SetCurrentValueData(</span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> pUnk, </span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> varData)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// TODO: Save the value returned to you</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Because we said the value type was a 32b int (VT_I4)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%"> myVal = (</span><span style="color: blue; line-height: 140%">int</span><span style="line-height: 140%">)varData;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// OPM passes its implementation of IDynamicPropertyNotify, you</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// cache it and call it to inform OPM your property has changed</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Connect(</span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%"> pSink)</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; m_pSink = (</span><span style="color: #2b91af; line-height: 140%">IDynamicPropertyNotify2</span><span style="line-height: 140%">)pSink;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Disconnect() {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; m_pSink = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">&#0160; #endregion</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">&#0160; #region</span><span style="line-height: 140%"> Application Entry Point</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">MyEntryPoint</span><span style="line-height: 140%"> : </span><span style="color: #2b91af; line-height: 140%">IExtensionApplication</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">protected internal</span><span style="line-height: 140%">&#0160;</span><span style="color: #2b91af; line-height: 140%">CustomProp</span><span style="line-height: 140%"> custProp = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Initialize()</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Assembly</span><span style="line-height: 140%">.LoadFrom(</span><span style="color: #a31515; line-height: 140%">&quot;asdkOPMNetExt.dll&quot;</span><span style="line-height: 140%">);</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Add the Dynamic Property</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%"> classDict = </span><span style="color: #2b91af; line-height: 140%">SystemObjects</span><span style="line-height: 140%">.ClassDictionary;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">RXClass</span><span style="line-height: 140%"> lineDesc = (</span><span style="color: #2b91af; line-height: 140%">RXClass</span><span style="line-height: 140%">)classDict.At(</span><span style="color: #a31515; line-height: 140%">&quot;AcDbLine&quot;</span><span style="line-height: 140%">);</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">IPropertyManager2</span><span style="line-height: 140%"> pPropMan =</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">IPropertyManager2</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">xOPM</span><span style="line-height: 140%">.xGET_OPMPROPERTY_MANAGER(lineDesc);</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; custProp = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">CustomProp</span><span style="line-height: 140%">();</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; pPropMan.AddProperty((</span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%">)custProp);</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Terminate()</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Remove the Dynamic Property</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%"> classDict = </span><span style="color: #2b91af; line-height: 140%">SystemObjects</span><span style="line-height: 140%">.ClassDictionary;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">RXClass</span><span style="line-height: 140%"> lineDesc = (</span><span style="color: #2b91af; line-height: 140%">RXClass</span><span style="line-height: 140%">)classDict.At(</span><span style="color: #a31515; line-height: 140%">&quot;AcDbLine&quot;</span><span style="line-height: 140%">);</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">IPropertyManager2</span><span style="line-height: 140%"> pPropMan =</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">IPropertyManager2</span><span style="line-height: 140%">)</span><span style="color: #2b91af; line-height: 140%">xOPM</span><span style="line-height: 140%">.xGET_OPMPROPERTY_MANAGER(lineDesc);</span></p>  <p style="font-size: 8pt; margin: 0px">&#0160;</p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; pPropMan.RemoveProperty((</span><span style="color: blue; line-height: 140%">object</span><span style="line-height: 140%">)custProp);</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; custProp = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">&#0160; #endregion</span></p>  <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p> </div> <p>A few comments on what this code does…</p> <p>It defines a class for our custom dynamic property (CustomProp), for which we need a unique GUID (and yes, by definition GUIDs are unique, but if you use the same one twice it ceases to be :-), and implement various callbacks to indicate the name, type, description and writeability of the property, as well as methods to get and set the property value. For this example our property is called “My integer property”, and – guess what? – it’s an integer, and has been hardcoded to have the value 4. We’re not actually storing the data being exposed via this property, but in a real-world application you would probably store it either as XData attached to the object, inside an XRecord in the object’s extension dictionary or in an external database of some kind.</p> <p>In the rest of the code we’re defining functions that are called when the module is loaded and when AutoCAD terminates (see <a href="http://through-the-interface.typepad.com/through_the_interface/2006/09/initialization_.html">this previous post</a> for more information on this mechanism). We use the Initialize() callback to load our mixed-mode module for which we presented the code in the last post (asdkOPMNetExt.dll) and then go ahead and instantiate our property and attach it to line objects.<a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e20112796dc86228a4-pi"><img align="right" alt="Dynamic property defined using C#" border="0" height="354" src="/assets/image_66855.jpg" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; margin: 10px 20px 10px 30px; border-right-width: 0px" title="Dynamic property defined using C#" width="223" /></a></p> <p>When we build and load the sample, making sure the Properties Palette is visible (using the PROPS command or by double-clicking on the line) and selecting a line we’ve just drawn, we should see our dynamic property appear, as shown in this image. </p> <p>If you don’t see the property appear, the application is probably having trouble loading asdkOPMNetExt.dll: as mentioned earlier I have placed both this and the sample application in the root folder of my AutoCAD installation. If you’re not sure whether the module is loaded properly, you can step through the Initialize() function in the debugger or add a simple command to your code which will obviously only work if your application has been loaded (the Assembly.LoadFrom() call will throw an exception if it doesn’t find the module, and if an exception is thrown from Initialize() the application will not be loaded, as described in <a href="http://through-the-interface.typepad.com/through_the_interface/2008/09/preventing-a-ne.html">this previous post</a>).</p> <p>For the sake of simplicity I’m going to leave this basic sample as having just one, hardwired property: hopefully it’s obvious how the application could be extended to handle more properties and to store these properties with their objects (if not, let me know by posting a comment and I’ll put together a more extensive example when I get the chance).</p>
