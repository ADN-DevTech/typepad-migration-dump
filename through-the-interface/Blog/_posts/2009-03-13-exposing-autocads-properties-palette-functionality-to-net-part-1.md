---
layout: "post"
title: "Exposing AutoCAD's Properties Palette functionality to .NET - Part 1"
date: "2009-03-13 10:53:11"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Object properties"
  - "ObjectARX"
  - "User interface"
original_url: "https://www.keanw.com/2009/03/exposing-autocads-properties-palette-functionality-to-net---part-1.html "
typepad_basename: "exposing-autocads-properties-palette-functionality-to-net---part-1"
typepad_status: "Publish"
---

<p><em>A huge thanks to Cyrille Fauvel, who manages DevTech&#39;s Media &amp; Entertainment team but still finds the time to dip into the odd deeply-technical, AutoCAD-related issue. Cyrille provided the original article on this topic late last year, but it&#39;s taken me time to get around to editing and publishing it. A quick tip... if you&#39;re not interested in the technical details of how Cyrille has exposed the various Properties Palette interfaces to .NET, you can safely skip this post and join us again when we go ahead and make use of the implementation to add dynamic properties to core AutoCAD objects using C#. Most people won&#39;t want to know all the details included in this post, but are just interested in the end results: next time I&#39;ll be providing a pre-built ObjectARX module, along with full source-code, that can be loaded into AutoCAD 2007-2009 to enable the use of the Properties Palette from .NET.</em></p> <p>AutoCAD&#39;s Properties Palette - once known as the Object Properties Manager (OPM) - is a very handy way to display properties inside your application, whether those properties are associated with individual objects or with the application itself. The Properties Palette uses COM to communicate with the object(s) in question, and has always required the use of C++ to expose particular interfaces that control the display of the properties in the palette, so its functionality has not been available to developers using managed .NET languages such as C# and VB.NET.</p> <p>There is some portion of the Properties Palette functionality exposed via the Autodesk.AutoCAD.Windows.ToolPalette namespace, such as the IAcPiPropertyDisplay interface allowing objects and commands to customize the display of properties in the property inspector window, but this is far from complete. This post looks at exposing more of the standard Properties Palette functionality to .NET languages, and next time we&#39;ll look at some specific examples of using it from C#.</p> <p>Our first step is to expose some &quot;OPM&quot; interfaces to .NET. There are two ways to do this: we can expose them from our .NET application sung standard C# or VB.NET code, or we can use a small ObjectARX module to implement them. </p> <p>Well, we have to use ObjectARX to access some OPM functionality that is currently only exposed via C++, so we&#39;re going to go down that path. What we&#39;re going to do is expose the interface(s) we want from our ObjectARX module and marshal the various parameters to be useable from .NET. Simple! :-)</p> <p>To get started, we&#39;re going to look at AutoCAD&#39;s IPropertyManager2 interface, which is contained in dynprops.h on the ObjectARX SDK:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">//--------------------------</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// IPropertyManager2 interface</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// This is the main property manager class. Use this to add your</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// property classes for a given type of IUnknown object. </span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// You can get this interface using </span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// CreateOPMIUnknownProtocol(ppUnk)-&gt;GetPropertyManager2().</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">//--------------------------</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// {FABC1C70-1044-4aa0-BF8D-91FFF9052715}</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">DEFINE_GUID(IID_IPropertyManager2, 0xfabc1c70, 0x1044, 0x4aa0, 0xbf, 0x8d, 0x91, 0xff, 0xf9, 0x5, 0x27, 0x15);</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">interface</span><span style="line-height: 140%"> DECLSPEC_UUID(</span><span style="color: #a31515; line-height: 140%">&quot;FABC1C70-1044-4aa0-BF8D-91FFF9052715&quot;</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">IPropertyManager2 : </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; BEGIN_INTERFACE</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// *** IUnknown methods ****</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(QueryInterface)(THIS_ REFIID riid, LPVOID FAR* ppvObj) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD_(ULONG, AddRef)(THIS) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD_(ULONG, Release)(THIS) PURE;</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// *** IPropertyManager2 methods ***</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(AddProperty)(THIS_ IUnknown FAR* pDynPropObj) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(RemoveProperty)(THIS_ IUnknown FAR* pDynPropObj) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetDynamicProperty)(THIS_ </span><span style="color: green; line-height: 140%">/*[in]*/</span><span style="line-height: 140%">LONG index,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">IUnknown ** pDynPropObj) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetDynamicPropertyByName)(THIS_ </span><span style="color: green; line-height: 140%">/*[in]*/</span><span style="line-height: 140%">BSTR propName,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">IUnknown ** pDynPropObj) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetDynamicPropertyCountEx)(THIS_ </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">LONG* count) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//For COM Wrappers to generate dynamic property typeinfo</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetDynamicClassInfo)(THIS_ </span><span style="color: green; line-height: 140%">/*[in]*/</span><span style="line-height: 140%">IUnknown* pObj,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">ITypeInfo** pptiDynamic,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">DWORD* dwCookie) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">};</span></p></div> <p>Now in our ObjectARX application we&#39;re going to expose the IPropertyManager2 interface to .NET.</p> <p>At line 41 in the IPropertyManager2.h file in the provided project [<em>which will actually be provided with the final post of the series</em>], we declare the interface using the same Global Unique Identifier (GUID):</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">[InteropServices::Guid(</span><span style="color: #a31515; line-height: 140%">&quot;FABC1C70-1044-4aa0-BF8D-91FFF9052715&quot;</span><span style="line-height: 140%">)]</span></p></div> <p>Then we need to indicate that our interface is derived from the standard, root COM interface, IUnknown:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">[InteropServices::InterfaceTypeAttribute(InteropServices::ComInterfaceType::InterfaceIsIUnknown)]</span></p></div> <p>We make it visible to COM, of course:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">[InteropServices::ComVisible(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)]</span></p></div> <p>Now for the interface itself. We declare that it&#39;s a &quot;public interface class&quot; along with its various members, specifying how to marshal all the types. We&#39;re not going to return values from our methods (which usually indicate success or failure): we&#39;ll leave it to the .NET code that implements the interfaces (which we&#39;ll see in the final post of the series) to throw exceptions instead.</p> <p>Here&#39;s the full class declaration, edited for display on this blog:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Autodesk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> AutoCAD</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Windows</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPM</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Guid(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;FABC1C70-1044-4aa0-BF8D-91FFF9052715&quot;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::InterfaceTypeAttribute(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::ComInterfaceType::InterfaceIsIUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::ComVisible(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)]</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">interface</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> IPropertyManager2</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> AddProperty(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pDynPropObj</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> RemoveProperty(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pDynPropObj</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDynamicProperty(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In] </span><span style="color: blue; line-height: 140%">long</span><span style="line-height: 140%"> index,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;Object^&gt; value</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDynamicPropertyByName(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::BStr</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] System::String^ name,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;Object^&gt; value</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDynamicPropertyCountEx(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out] </span><span style="color: blue; line-height: 140%">long</span><span style="line-height: 140%">* count</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDynamicClassInfo(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pDynPropObj,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*InteropServices::UnmanagedType::ITypeInfo*/</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;Object^&gt; typeInfo,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out] ulong* dwCookie</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; };</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p></div> <p>This one class is really at the core of our effort to expose the OPM to .NET. To let us access and use this class, we&#39;re going to expose a &quot;property extension factory&quot;. We might have opted to P/Invoke an ObjectARX API for this, but it&#39;s ultimately cleaner to implement this from C++ and expose it via a managed wrapper.</p> <p>So how do we know we need a property extension factory? Typically to access the IPropertyManager2 instance from ObjectARX we use the GET_OPMPROPERTY_MANAGER() macro. From dynprops.h, we know that this macro expands into GET_OPMEXTENSION_CREATE_PROTOCOL()-&gt;CreateOPMObjectProtocol(pAcRxClass)-&gt;GetPropertyManager() and the GET_OPMEXTENSION_CREATE_PROTOCOL() macro expands, in turn, into OPMPropertyExtensionFactory::cast(AcDbDatabase::desc()-&gt;queryX(OPMPropertyExtensionFactory::desc())). This is how we know we need to expose the OPMPropertyExtensionFactory class.</p> <p>So let&#39;s take a look at the declaration in the ObjectARX SDK of OPMPropertyExtensionFactory, once again from dynprops.h:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">//--------------------------</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// OPMPropertyExtension interface</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// This class is implemented by AutoCAD and available through</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// GET_OPMEXTENSION_CREATE_PROTOCOL. You can add property classes </span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// by calling GET_OPMPROPERTY_MANAGER for a particular AcRxClass </span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// to get the property manager for that class. </span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// You can also enumerate the dynamic properties which have</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// been added to that class as well as its base class(es) via </span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// GetPropertyCount and GetPropertyClassArray</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">//--------------------------</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> OPMPropertyExtensionFactory: </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> AcRxObject</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%">:</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; ACRX_DECLARE_MEMBERS(OPMPropertyExtensionFactory);</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">virtual</span><span style="line-height: 140%"> ~OPMPropertyExtensionFactory(){}</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//Retrieves the OPMPropertyExtension for the specified class, if the</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//extension has not been added before, it creates it. Note: the implementation</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//of this class manages the lifetime of OPMPropertyExtension, as such you don&#39;t </span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//need to delete them.</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">virtual</span><span style="line-height: 140%"> OPMPropertyExtension* CreateOPMObjectProtocol(AcRxClass* pClass, </span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; LONG lReserved = NULL) = 0;</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%"><span style="line-height: 140%">...</span></span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%"><span style="line-height: 140%">}</span></span></p></div> <p>To expose this class through .NET we&#39;re going to use the Autodesk::AutoCAD::Runtime::Wrapper attribute class to tell AutoCAD to manage this class as an internal class object wrapper. We then derive our wrapper class from RXObject (as the base class of the corresponding ObjectARX class is AcRxObject), and implement a constructor, a GetImpObj() method to provide access to the unmanaged object and our factory function itself, CreateOPMObjectProtocol(). There&#39;s no need for a destructor as this is handled by the wrapper.</p> <p>Here&#39;s the complete class declaration from OPMPropertyExtensionFactory.h in the provided sample:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Autodesk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> AutoCAD</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Windows</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPM</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [Autodesk::AutoCAD::Runtime::Wrapper(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;OPMPropertyExtensionFactory&quot;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">ref</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> AcMgdOPMPropertyExtensionFactory</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; : </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> RXObject</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%">:</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AcMgdOPMPropertyExtensionFactory(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; System::IntPtr unmanagedPointer,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> bAutoDelete</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; : RXObject(unmanagedPointer, bAutoDelete) {}</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">internal</span><span style="line-height: 140%">:</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//- Returns the unmanaged ARX Object</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">inline</span><span style="line-height: 140%"> OPMPropertyExtensionFactory* GetImpObj()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">static_cast</span><span style="line-height: 140%">&lt;OPMPropertyExtensionFactory *&gt;(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; UnmanagedObject.ToPointer()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%">:</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">virtual</span><span style="line-height: 140%"> AcMgdOPMPropertyExtension^ CreateOPMObjectProtocol(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; RXClass^ runtimeClass,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">long</span><span style="line-height: 140%"> lReserved</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; } ;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p></div> <p>There is one last class that needs to be exposed: OPMPropertyExtension, which is what is created by the OPMPropertyExtensionFactory (logically enough). We&#39;ll use the same technique as for the OPMPropertyExtensionFactory.</p> <p>Here&#39;s the class declaration from OPMPropertyExtension.h:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Autodesk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> AutoCAD</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Windows</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPM</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [Autodesk::AutoCAD::Runtime::Wrapper(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;OPMPropertyExtension&quot;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">ref</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> AcMgdOPMPropertyExtension : </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> RXObject</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%">:</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AcMgdOPMPropertyExtension(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; System::IntPtr unmanagedPointer,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> bAutoDelete</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; : RXObject (unmanagedPointer, bAutoDelete) {}</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">internal</span><span style="line-height: 140%">:</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//- Returns the unmanaged ARX Object</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">inline</span><span style="line-height: 140%"> OPMPropertyExtension* GetImpObj()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> (</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">static_cast</span><span style="line-height: 140%">&lt;OPMPropertyExtension *&gt;(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; UnmanagedObject.ToPointer()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%">:</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">virtual</span><span style="line-height: 140%"> Object^ GetPropertyManager();</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">virtual</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> SetPropertyManager(Object^ pPropManager);</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; } ;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p></div> <p>Those are all the declarations (yes, in C++ you need declare your classes separately from their definitions... yawn... :-) so let&#39;s go ahead and implement the wrapper classes.</p> <p>First the OPMPropertyExtensionFactory class (from OPMPropertyExtensionFactory.cpp), with it&#39;s main method to create and return a new OPMPropertyExtension:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Autodesk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> AutoCAD</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Windows</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPM</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AcMgdOPMPropertyExtension^ </span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AcMgdOPMPropertyExtensionFactory::CreateOPMObjectProtocol(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; RXClass^ runtimeClass, </span><span style="color: blue; line-height: 140%">long</span><span style="line-height: 140%"> lReserved</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> (</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">gcnew</span><span style="line-height: 140%"> AcMgdOPMPropertyExtension(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; System::IntPtr(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetImpObj()-&gt;CreateOPMObjectProtocol(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">static_cast</span><span style="line-height: 140%">&lt;AcRxClass*&gt;(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//runtimeClass-&gt;GetImpObj()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; runtimeClass-&gt;UnmanagedObject.ToPointer()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; lReserved</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">false</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p></div> <p>Here&#39;s the implementation of the OPMPropertyExtension class (from OPMPropertyExtension.cpp), which gets us access to the OPMPropertyManager:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Autodesk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> AutoCAD</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Windows</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPM</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Object^ AcMgdOPMPropertyExtension::GetPropertyManager()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; IUnknown *pUnk =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetImpObj()-&gt;GetPropertyManager();</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> (</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; System::Runtime::InteropServices::Marshal::</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetObjectForIUnknown(</span><span style="line-height: 140%">System::IntPtr(pUnk))</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> AcMgdOPMPropertyExtension::SetPropertyManager(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Object^ pPropManager</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; IPropertyManager *pPropMgr =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">reinterpret_cast</span><span style="line-height: 140%">&lt;IPropertyManager *&gt;(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; System::Runtime::InteropServices::Marshal::</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetIUnknownForObject(</span><span style="line-height: 140%">pPropManager</span><span style="line-height: 140%">).ToPointer()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetImpObj()-&gt;SetPropertyManager(pPropMgr);</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p></div> <p>To finish off our implementation, we&#39;re going to re-implement the two handy macros we have in unmanaged C++ (i.e. ObjectARX), to give us the same capabilities when in a managed environment.</p> <p>Here&#39;s our implementation from xOPM.cpp:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Autodesk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> AutoCAD</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Windows</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPM</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AcMgdOPMPropertyExtensionFactory^</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; xOPM::xGET_OPMEXTENSION_CREATE_PROTOCOL()</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Dictionary^ classDict =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; SystemObjects::ClassDictionary;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; RXClass^ opmFactoryClass =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (RXClass^)classDict-&gt;At(</span><span style="color: #a31515; line-height: 140%">&quot;OPMPropertyExtensionFactory&quot;</span><span style="line-height: 140%">);</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; RXClass^ dbClass =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (RXClass^)classDict-&gt;At(</span><span style="color: #a31515; line-height: 140%">&quot;AcDbDatabase&quot;</span><span style="line-height: 140%">);</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">gcnew</span><span style="line-height: 140%"> AcMgdOPMPropertyExtensionFactory(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; dbClass-&gt;QueryX (opmFactoryClass),</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">false</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Object^</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; xOPM::xGET_OPMPROPERTY_MANAGER(RXClass^ pAcRxClass)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; AcMgdOPMPropertyExtensionFactory^ opmFactory =</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; xOPM::xGET_OPMEXTENSION_CREATE_PROTOCOL();</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; opmFactory-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; CreateOPMObjectProtocol(pAcRxClass, 0)-&gt;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetPropertyManager());</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p></div> <p>There&#39;s just one more interface that needs exposing to .NET, and that&#39;s IDynamicProperty2. We&#39;re going to expose this in much the same way as we did IPropertyManager2.</p> <p>Here&#39;s the original declaration from dynprops.h:</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">//--------------------------</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// IDynamicProperty2 interface</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// Implement this class to create dynamic properties for the PropertyPalette</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// it defines the base set of property attributes as well as</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// the name/type/data tuples. </span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">//--------------------------</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: green; line-height: 140%">// {9CAF41C2-CA86-4ffb-B05A-AC43C424D076}</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">DEFINE_GUID(IID_IDynamicProperty2, 0x9caf41c2, 0xca86, 0x4ffb, 0xb0, 0x5a, 0xac, 0x43, 0xc4, 0x24, 0xd0, 0x76);</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">interface</span><span style="line-height: 140%"> DECLSPEC_UUID(</span><span style="color: #a31515; line-height: 140%">&quot;9CAF41C2-CA86-4ffb-B05A-AC43C424D076&quot;</span><span style="line-height: 140%">)</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">IDynamicProperty2 : </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; BEGIN_INTERFACE</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// *** IUnknown methods ****</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(QueryInterface)(THIS_ REFIID riid, LPVOID FAR* ppvObj) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD_(ULONG, AddRef)(THIS) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD_(ULONG, Release)(THIS) PURE;</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// *** IDynamicProperty2 methods ***</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//Unique property ID</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetGUID)(THIS_ </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">GUID* propGUID) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Property display name</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetDisplayName)(THIS_ </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">BSTR* bstrName) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Show/Hide property in the OPM, for this object instance </span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(IsPropertyEnabled)(THIS_ </span><span style="color: green; line-height: 140%">/*[in]*/</span><span style="line-height: 140%">IUnknown *pUnk,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">BOOL* pbEnabled) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Is property showing but disabled</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(IsPropertyReadOnly)(THIS_ </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">BOOL* pbReadonly) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Get the property description string</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetDescription)(THIS_ </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">BSTR* bstrName) PURE;</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// *** Basic property value information ***</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// OPM will typically display these in an edit field</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// optional: meta data representing property type name, ex. ACAD_ANGLE</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetCurrentValueName)(THIS_ </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">BSTR* pbstrName) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// What is the property type, ex. VT_R8</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetCurrentValueType)(THIS_ </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">VARTYPE* pVarType) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Get the property value, passes the specific object we need the property</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// value for.</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(GetCurrentValueData)(THIS_ </span><span style="color: green; line-height: 140%">/*in*/</span><span style="line-height: 140%">IUnknown *pUnk, </span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*[out]*/</span><span style="line-height: 140%">VARIANT* pvarData) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Set the property value, passes the specific object we want to set the </span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// property value for</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(SetCurrentValueData)(THIS_ </span><span style="color: green; line-height: 140%">/*[in]*/</span><span style="line-height: 140%">IUnknown *pUnk, </span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*[in]*/</span><span style="color: blue; line-height: 140%">const</span><span style="line-height: 140%"> VARIANT varData) PURE;</span></p> <p style="font-size: 8pt; margin: 0px">&#0160;</p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//*** Notifications ***</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//OPM passes its implementation of IDynamicPropertyNotify, you</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">//cache it and call it to inform OPM your property has changed</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(Connect)(THIS_ </span><span style="color: green; line-height: 140%">/*[in]*/</span><span style="line-height: 140%">IDynamicPropertyNotify2* pSink) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; STDMETHOD(Disconnect)(THIS_ ) PURE;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">};</span></p></div> <p>And here&#39;s our own exposure of this interface to .NET (from IDynamicProperty2.h):</p> <div style="font-size: 8pt; background: white; color: black; font-family: courier new"> <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Autodesk</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> AutoCAD</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> Windows</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> OPM</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Guid(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;9CAF41C2-CA86-4ffb-B05A-AC43C424D076&quot;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="color: #a31515; line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="line-height: 140%">)]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::InterfaceTypeAttribute(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::ComInterfaceType::InterfaceIsIUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::ComVisible(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">interface</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> IDynamicProperty2</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetGUID(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out] System::Guid% propGUID</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDisplayName(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::BStr</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;System::String^&gt; name);</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> IsPropertyEnabled(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pUnk,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out] System::Int32% bEnabled</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> IsPropertyReadOnly(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out] System::Int32% bReadonly</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetDescription(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::BStr</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;System::String^&gt; description</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetCurrentValueName(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::BStr</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;System::String^&gt; name</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetCurrentValueType(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Out] ushort% pVarType</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetCurrentValueData(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pUnk,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::Struct</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;Object^&gt; varData</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> SetCurrentValueData(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pUnk,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::Struct</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="line-height: 140%">Object^ varData</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Connect(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">/*IDynamicPropertyNotify2*/</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pSink</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Disconnect();</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; };</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::Guid(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;975112B5-5403-4197-AFB8-90C6CA73B9E1&quot;</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::InterfaceTypeAttribute(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::ComInterfaceType::InterfaceIsIUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::ComVisible(</span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">)]</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">interface</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> IDynamicPropertyNotify2</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> OnChanged(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::IUnknown</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] Object^ pDynamicProperty</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> GetCurrentSelectionSet(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; [InteropServices::In,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::Out,</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::MarshalAs(</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; InteropServices::UnmanagedType::Struct</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ] </span><span style="color: blue; line-height: 140%">interior_ptr</span><span style="line-height: 140%">&lt;Object^&gt; pSelection</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; };</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p> <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p></div> <p>OK, that&#39;s it for the hardcore technical details on exposing AutoCAD&#39;s Properties Palette to .NET. In the next post we&#39;ll start the real fun with some real examples of using these interfaces from C# (and you can trust me when I say that&#39;s going to be a whole lot simpler than this post, honestly! :-).</p>
