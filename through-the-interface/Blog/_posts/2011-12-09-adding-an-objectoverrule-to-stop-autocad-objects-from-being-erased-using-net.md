---
layout: "post"
title: "Adding an ObjectOverrule to stop AutoCAD objects from being erased using .NET"
date: "2011-12-09 05:15:00"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Notification / Events"
  - "Overrules"
original_url: "https://www.keanw.com/2011/12/adding-an-objectoverrule-to-stop-autocad-objects-from-being-erased-using-net.html "
typepad_basename: "adding-an-objectoverrule-to-stop-autocad-objects-from-being-erased-using-net"
typepad_status: "Publish"
---

<p>As a follow-on from <a href="http://through-the-interface.typepad.com/through_the_interface/2011/12/adding-an-objectoverrule-to-watch-for-erasure-of-autocad-objects-using-net.html" target="_blank">the last post</a>, today we’re going to see how to actually stop the erase operation from happening for a certain type of object (in this case we’re going to focus on Lines). Thanks for Stephen Preston for showing us the way in his comment on that post: inspired by his suggestion I ended up coding this before breakfast (although I do recommend taking care when throwing exceptions on an empty stomach ;-).</p>  <p>Here’s the C# code implementing the PER (Prevent Erasure) command:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> WeLikeToBlock</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Commands</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EraseOverrule</span><span style="line-height: 140%"> : </span><span style="color: #2b91af; line-height: 140%">ObjectOverrule</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> Erase(</span><span style="color: #2b91af; line-height: 140%">DBObject</span><span style="line-height: 140%"> dbObject, </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> erasing)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">base</span><span style="line-height: 140%">.Erase(dbObject, erasing);</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">throw</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">new</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Autodesk.AutoCAD.Runtime.</span><span style="color: #2b91af; line-height: 140%">Exception</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ErrorStatus</span><span style="line-height: 140%">.NotApplicable</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EraseOverrule</span><span style="line-height: 140%"> _theOverrule = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; [</span><span style="color: #2b91af; line-height: 140%">CommandMethod</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;PER&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> PreventErase()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Editor</span><span style="line-height: 140%"> ed =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument.Editor;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_theOverrule == </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _theOverrule = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">EraseOverrule</span><span style="line-height: 140%">();</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ObjectOverrule</span><span style="line-height: 140%">.AddOverrule(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">RXObject</span><span style="line-height: 140%">.GetClass(</span><span style="color: blue; line-height: 140%">typeof</span><span style="line-height: 140%">(</span><span style="color: #2b91af; line-height: 140%">Line</span><span style="line-height: 140%">)),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _theOverrule,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">false</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ObjectOverrule</span><span style="line-height: 140%">.Overruling = </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;\nPreventing erasure of lines.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ObjectOverrule</span><span style="line-height: 140%">.RemoveOverrule(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">RXObject</span><span style="line-height: 140%">.GetClass(</span><span style="color: blue; line-height: 140%">typeof</span><span style="line-height: 140%">(</span><span style="color: #2b91af; line-height: 140%">Line</span><span style="line-height: 140%">)),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _theOverrule</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _theOverrule.Dispose();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _theOverrule = </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.WriteMessage(</span><span style="color: #a31515; line-height: 140%">&quot;\nNo longer preventing erasure of lines.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>The original reason I started investigating this topic was a discussion group post where someone was trying to stop certain blocks from being redefined. Based on the approach of throwing exceptions, I revisited the idea of blocking certain block table records from being opened for write. While it stopped the redefinition from happening, it did (unsurprisingly) cause AutoCAD to crash, which is also why such a technique – while powerful – should be used with extreme caution (hence my comment in the last post describing the act of blocking Erase as being contentious or potentially disastrous). Certain code paths may not be ready for low-level operations within AutoCAD being blocked arbitrarily, especially operations such as opening symbol table records.</p>  <p>There may yet be a simple way to stop block redefinition – if I end up finding a way, I’ll certainly post it here.</p>  <p><strong><em>Update:</em></strong></p>  <p>I’ve just seen an internal thread discussing a scenario where blocking erase by throwing ErrorStatus.NotApplicable caused issues with undo. I haven’t been able to reproduce the problem, but I did want to post the solution in case it proves to be of help: in this situation returning ErrorStatus.CannotBeErasedByCaller did the trick.</p>
