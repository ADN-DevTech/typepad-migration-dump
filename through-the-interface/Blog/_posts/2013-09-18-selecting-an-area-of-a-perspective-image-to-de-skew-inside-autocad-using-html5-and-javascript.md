---
layout: "post"
title: "Selecting an area of a perspective image to de-skew inside AutoCAD using HTML5 and JavaScript"
date: "2013-09-18 14:43:22"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "HTML"
  - "IronPython"
  - "JavaScript"
  - "Jigs"
  - "Python"
  - "SaaS"
original_url: "https://www.keanw.com/2013/09/selecting-an-area-of-a-perspective-image-to-de-skew-inside-autocad-using-html5-and-javascript.html "
typepad_basename: "selecting-an-area-of-a-perspective-image-to-de-skew-inside-autocad-using-html5-and-javascript"
typepad_status: "Publish"
---

<p>So after <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/applications-for-linear-algebra-straightening-out-perspective.html" target="_blank">several</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/update-on-the-project-to-de-skew-images-inside-autocad.html" target="_blank">posts</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/generating-png-files-for-de-skewed-portions-of-perspective-images.html" target="_blank">leading</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2013/09/moving-pure-python-code-into-ironpython.html" target="_blank">up</a> <a href="http://through-the-interface.typepad.com/through_the_interface/2013/09/executing-python-code-to-de-skew-images-inside-autocad-using-ironpython.html" target="_blank">to</a> the big reveal, as it were, in today’s post we’re going to see the full “De-skew Raster” application in action – and give you <a href="http://through-the-interface.typepad.com/files/DeskewRaster.zip" target="_blank">the complete source to fool around with</a>.</p>  <p>The main addition over where we were in the last post is the HTML5 and JavaScript UI implementation, as well as the new C# command – called DESKEW – that loads and displays it:</p>  <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e2019aff779dee970b-pi" target="_blank"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 20px auto; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top: 0px; border-right: 0px; padding-top: 0px" title="Selecting the area of the whiteboard to de-skew" border="0" alt="Selecting the area of the whiteboard to de-skew" src="/assets/image_151767.jpg" width="469" height="417" /></a></p>  <p>Our JavaScript code uses the new JavaScript API in AutoCAD 2014 to execute the other command (DESKEW_IMAGE, which we saw implemented last time) that drives the core Python implementation.</p>  <p>I had a lot of fun creating this UI. I started with <a href="http://www.script-tutorials.com/demos/197/index.html" target="_blank">an HTML5 sample I found that implements an image cropping tool</a>, but adjusted the code to maintain four separate vertices for the corners (rather than forcing the selection area to be aligned with the image itself). I also implemented a magnifying area to help with more precise selection of the respective vertices. </p>  <p>Here’s the HTML file, which is extremely simple:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">html</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">head</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">title</span><span style="line-height: 140%; color: blue">&gt;</span><span style="line-height: 140%">De-skew perspective image</span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">title</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">link</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">href</span><span style="line-height: 140%; color: blue">=&quot;main.css&quot;</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">rel</span><span style="line-height: 140%; color: blue">=&quot;stylesheet&quot;</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">type</span><span style="line-height: 140%; color: blue">=&quot;text/css&quot;</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">script</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">type</span><span style="line-height: 140%; color: blue">=&quot;text/javascript&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">src</span><span style="line-height: 140%; color: blue">=&quot;http://code.jquery.com/jquery-latest.min.js&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">script</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">script</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">type</span><span style="line-height: 140%; color: blue">=&quot;text/javascript&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">src</span><span style="line-height: 140%; color: blue">=&quot;http://www.autocadws.com/jsapi/v1/Autodesk.AutoCAD.js&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">script</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">script</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">src</span><span style="line-height: 140%; color: blue">=&quot;WindowSelect.js&quot;</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">type</span><span style="line-height: 140%; color: blue">=&quot;text/javascript&quot;&gt;&lt;/</span><span style="line-height: 140%; color: maroon">script</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">head</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">body</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">onload</span><span style="line-height: 140%; color: blue">=&quot;onLoad()&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">class</span><span style="line-height: 140%; color: blue">=&quot;container&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">class</span><span style="line-height: 140%; color: blue">=&quot;contr&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">class</span><span style="line-height: 140%; color: blue">=&quot;inside&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">style</span><span style="line-height: 140%; color: blue">=&quot;</span><span style="line-height: 140%; color: red">float</span><span style="line-height: 140%; color: blue">:left&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">button</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">onclick</span><span style="line-height: 140%; color: blue">=&quot;deskewCmd()&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; De-skew selected area</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">button</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">class</span><span style="line-height: 140%; color: blue">=&quot;facinput&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">style</span><span style="line-height: 140%; color: blue">=&quot;</span><span style="line-height: 140%; color: red">float</span><span style="line-height: 140%; color: blue">:right&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">title</span><span style="line-height: 140%; color: blue">=&quot;A value of 1 means a square output image&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Width over height:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">input</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">class</span><span style="line-height: 140%; color: blue">=&quot;numinput&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">id</span><span style="line-height: 140%; color: blue">=&quot;factor&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">type</span><span style="line-height: 140%; color: blue">=&quot;number&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: red">value</span><span style="line-height: 140%; color: blue">=&quot;1.0&quot;</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">id</span><span style="line-height: 140%; color: blue">=&quot;canvases&quot;&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">style</span><span style="line-height: 140%; color: blue">=&quot;</span><span style="line-height: 140%; color: red">float</span><span style="line-height: 140%; color: blue">:left&quot;&gt;&lt;</span><span style="line-height: 140%; color: maroon">canvas</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">id</span><span style="line-height: 140%; color: blue">=&quot;panel&quot;/&gt;&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">style</span><span style="line-height: 140%; color: blue">=&quot;</span><span style="line-height: 140%; color: red">float</span><span style="line-height: 140%; color: blue">:left&quot;&gt;&lt;</span><span style="line-height: 140%; color: maroon">canvas</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: red">id</span><span style="line-height: 140%; color: blue">=&quot;magnifier&quot;/&gt;&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">div</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">body</span><span style="line-height: 140%; color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">&lt;/</span><span style="line-height: 140%; color: maroon">html</span><span style="line-height: 140%; color: blue">&gt;</span></p> </div>  <p>The JavaScript behind it has a little more going on, but still:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Based on http://www.script-tutorials.com/demos/197/index.html</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Globals</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> canvas, ctx, magnifier, magctx;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> image;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> mouseX, mouseY = 1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> selArea;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> urlVars;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> off = 10;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> zs = 10;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> magsz = off * zs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Helper function to get URL vars, courtesy of:</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// http://papermashup.com/read-url-get-variables-withjavascript</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> getUrlVars() {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> vars = {};</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> parts =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; window.location.href.replace(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; /[?&amp;]+([^=&amp;]+)=([^&amp;]*)/gi,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> (m, key, value) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; vars[key] = value;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> vars;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Selection constructor</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> Selection(pts) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Our (usually 4) corners</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points = pts;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Some constants</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csize = 6; </span><span style="line-height: 140%; color: #006400">// Resize cubes size</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csizeh = 10; </span><span style="line-height: 140%; color: #006400">// Grip cubes size (on hover)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.highlight = </span><span style="line-height: 140%; color: maroon">'#f00'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.linecolor = </span><span style="line-height: 140%; color: maroon">'#000'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.textcolor = </span><span style="line-height: 140%; color: maroon">'#fff'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Status of whether the mouse is hovering over or dragging the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// corners</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.hovering = [</span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">]; </span><span style="line-height: 140%; color: #006400">// Hover status</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.dragging = [</span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">]; </span><span style="line-height: 140%; color: #006400">// Drag status</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: #006400">// Selection draw method</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">Selection.prototype.draw = </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> () {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Draw lines between the corners</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.strokeStyle = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.linecolor;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.lineWidth = 2;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.beginPath();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.moveTo(</span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[0][0], </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[0][1]);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (i = 1; i &lt; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points.length; i++) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ctx.lineTo(</span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0], </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][1]);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.lineTo(</span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[0][0], </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[0][1]);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.closePath();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.stroke();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Draw grip cubes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (i = 0; i &lt; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points.length; i++) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ctx.fillStyle =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.dragging[i] ? </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.highlight : </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.textcolor;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// If a vertex is being dragged, draw it in a highlight colour</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.dragging[i]) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> x = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> y = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][1];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> sz = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csizeh;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// First draw the grip cube</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctx.strokeStyle = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.highlight;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctx.strokeRect(x - sz, y - sz, sz * 2, sz * 2);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctx.strokeStyle = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.linecolor;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Next we'll draw a magnified portion of the part of the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// image under the cursor, with cross-hairs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.clearRect(0, 0, magsz, magsz);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> xpos = x &lt; off ? 0 : x - off;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ypos = y &lt; off ? 0 : y - off;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> fromRight = image.width - x;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> fromBottom = image.height - y;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> wid = fromRight &lt;= off ? off + fromRight - 1 : off * 2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> hgt = fromBottom &lt;= off ? off + fromBottom - 1 : off * 2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> fac = 1 / (off * 2);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.drawImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; image, xpos, ypos, wid, hgt,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (xpos - (x - off)) * zs / 2, (ypos - (y - off)) * zs / 2,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Math.floor(wid * fac * magsz),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Math.floor(hgt * fac * magsz)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// And the cross-hairs</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.strokeStyle = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.linecolor;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.lineWidth = 1;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Vertical</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.beginPath();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.moveTo(magsz / 2, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.lineTo(magsz / 2, magsz);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.closePath();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.stroke();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Horizontal</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.beginPath();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.moveTo(0, magsz / 2);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.lineTo(magsz, magsz / 2);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.closePath();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; magctx.stroke();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span><span style="line-height: 140%"> {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Draw filled cubes for the grips, larger if hovered over</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> csz = </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.hovering[i] ? </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csizeh : </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csize;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctx.fillRect(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0] - csz, </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][1] - csz,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; csz * 2, csz * 2</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Now we'll draw some text with the coordinate information in</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// them at an appropriate point for each of the corners</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Make the text centered (vertically)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ctx.textBaseline = </span><span style="line-height: 140%; color: maroon">'middle'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ctx.textAlign = </span><span style="line-height: 140%; color: maroon">'left'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// We'll work out X and Y offsets to make sure the text looks</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// OK and doesn't try to leave the canvas</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; xoff = -2 * </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csizeh;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; yoff = (i &gt; 0 &amp;&amp; i &lt; 3 ? 2 : -2) * </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csizeh;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// If at the bottom, reverse the Y offset</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][1] + yoff &gt; ctx.canvas.height ||</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][1] + yoff &lt; 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; yoff = -yoff;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// If at the left, make the text appear right at X = 0</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0] + xoff &lt; 0</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; xoff = -</span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// If nearly at the right, make the text right-justified and set</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// the location to be at the right margin</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0] + xoff &gt; ctx.canvas.width - (4 * </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.csizeh)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ctx.textAlign = </span><span style="line-height: 140%; color: maroon">'right'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; xoff = ctx.canvas.width - </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// And draw the coordinate text</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ctx.fillText(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0] + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> + </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][1],</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][0] + xoff,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">this</span><span style="line-height: 140%">.points[i][1] + yoff</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> drawScene() { </span><span style="line-height: 140%; color: #006400">// Main drawScene function</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Clear canvas</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.clearRect(0, 0, image.width, image.height);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Draw source image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx.drawImage(image, 0, 0, image.width, image.height);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; selArea.draw();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onLoad() {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Just load our URL parameters once</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; urlVars = getUrlVars();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Load the source image</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; image = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Image();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; image.onload = </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> () {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; window.resizeTo(image.width, image.Height);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Create initial selection with points at 1/3 and 2/3</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// across the width and height</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> x1 = Math.floor(image.width / 3);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> y1 = Math.floor(image.height / 3);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> x2 = x1 * 2;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> y2 = y1 * 2;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; selArea =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Selection([[x1, y1], [x1, y2], [x2, y2], [x2, y1]]);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; $(</span><span style="line-height: 140%; color: maroon">'#panel'</span><span style="line-height: 140%">).attr(</span><span style="line-height: 140%; color: maroon">'width'</span><span style="line-height: 140%">, image.width);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; $(</span><span style="line-height: 140%; color: maroon">'#panel'</span><span style="line-height: 140%">).attr(</span><span style="line-height: 140%; color: maroon">'height'</span><span style="line-height: 140%">, image.height);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; $(</span><span style="line-height: 140%; color: maroon">'#magnifier'</span><span style="line-height: 140%">).attr(</span><span style="line-height: 140%; color: maroon">'width'</span><span style="line-height: 140%">, magsz);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; $(</span><span style="line-height: 140%; color: maroon">'#magnifier'</span><span style="line-height: 140%">).attr(</span><span style="line-height: 140%; color: maroon">'height'</span><span style="line-height: 140%">, magsz);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; drawScene();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Load the image specified in the URL parameter or a stock</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// image if not (useful for testing outisde AutoCAD)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; image.src =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;input&quot;</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> urlVars ?</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;file:///&quot;</span><span style="line-height: 140%"> + decodeURIComponent(urlVars[</span><span style="line-height: 140%; color: maroon">&quot;input&quot;</span><span style="line-height: 140%">]) :</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;input.png&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Create canvas and context objects (also for magnified area)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; canvas = document.getElementById(</span><span style="line-height: 140%; color: maroon">'panel'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ctx = canvas.getContext(</span><span style="line-height: 140%; color: maroon">'2d'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; magnifier = document.getElementById(</span><span style="line-height: 140%; color: maroon">'magnifier'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; magctx = magnifier.getContext(</span><span style="line-height: 140%; color: maroon">'2d'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; $(</span><span style="line-height: 140%; color: maroon">'#panel'</span><span style="line-height: 140%">).mousemove(</span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> (e) { </span><span style="line-height: 140%; color: #006400">// Mouse-move event</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Calculate the position of the mouse on the canvas</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> canvasOffset = $(canvas).offset();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; mouseX = Math.floor(e.pageX - canvasOffset.left - 2);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; mouseY = Math.floor(e.pageY - canvasOffset.top - 2);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (mouseX &lt; 0) mouseX = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (mouseY &lt; 0) mouseY = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (mouseX &gt;= image.width) mouseX = image.width - 1;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (mouseY &gt;= image.height) mouseY = image.height - 1;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Hovering over resize cubes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (i = 0; i &lt; selArea.points.length; i++) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> x = selArea.points[i][0];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> y = selArea.points[i][1];</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> csz = selArea.csizeh;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; selArea.hovering[i] =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; mouseX &gt; x - csz &amp;&amp; mouseX &lt; x + csz &amp;&amp;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; mouseY &gt; y - csz &amp;&amp; mouseY &lt; y + csz;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// In case of dragging of resize cubes</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (i = 0; i &lt; selArea.points.length; i++) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (selArea.dragging[i]) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; selArea.points[i][0] = mouseX;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; selArea.points[i][1] = mouseY;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; drawScene();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; });</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; $(</span><span style="line-height: 140%; color: maroon">'#panel'</span><span style="line-height: 140%">).mousedown(</span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> (e) { </span><span style="line-height: 140%; color: #006400">// Mouse-down event</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Stop the standard behaviour from replacing our cursor</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// with an I-bar</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; e.preventDefault();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// If already hovering over a particular corner, set its</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// drag status to true</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (i = 0; i &lt; selArea.points.length; i++) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (selArea.hovering[i]) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; selArea.dragging[i] = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; });</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; $(</span><span style="line-height: 140%; color: maroon">'#panel'</span><span style="line-height: 140%">).mouseup(</span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> (e) { </span><span style="line-height: 140%; color: #006400">// Mouse-up event</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Set all the drag statuses to false</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%"> (i = 0; i &lt; selArea.points.length; i++) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; selArea.dragging[i] = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Clear the magnified view</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; magctx.clearRect(0, 0, magsz, magsz);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; });</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; drawScene();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> deskewCmd() {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Get the name of the output file chosen by the user from</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// the URL parameters and replace its backslashes with forward</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// slashes (or we just use a standard name, if not found)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> output =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;output&quot;</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> urlVars ?</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;file:///&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; decodeURIComponent(urlVars[</span><span style="line-height: 140%; color: maroon">&quot;output&quot;</span><span style="line-height: 140%">]).replace(/\\/g,</span><span style="line-height: 140%; color: maroon">&quot;/&quot;</span><span style="line-height: 140%">) :</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">&quot;output.png&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Execute our command to process the image with the provided</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// coordinates and width factor</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pts = selArea.points;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Acad.Editor.executeCommandAsync(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'_.DESKEW_IMAGE '</span><span style="line-height: 140%"> + </span><span style="line-height: 140%; color: maroon">'\&quot;'</span><span style="line-height: 140%"> + image.src + </span><span style="line-height: 140%; color: maroon">'\&quot; \&quot;'</span><span style="line-height: 140%"> + output + </span><span style="line-height: 140%; color: maroon">'\&quot; '</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pts[0][0].toString() + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> + pts[0][1].toString() + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pts[1][0].toString() + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> + pts[1][1].toString() + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pts[2][0].toString() + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> + pts[2][1].toString() + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pts[3][0].toString() + </span><span style="line-height: 140%; color: maroon">','</span><span style="line-height: 140%"> + pts[3][1].toString() + </span><span style="line-height: 140%; color: maroon">' '</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; $(</span><span style="line-height: 140%; color: maroon">'#factor'</span><span style="line-height: 140%">).val().toString()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Close this dialog (setting the commit flag to true)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Acad.Application.activedocument.modalDialogCommit(</span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>Now let’s look at the additional C# implementation we use to display the HTML page. What’s especially interesting about this is the way we tell the page what to load: we’re encoding the arguments we want to pass (which in this case means the input filename as well as the output filename – more on why we do that in a bit) as URL parameters, which means they come after the URL to the .htm page in this way:</p>  <p><a href="http://my-site.something/my-page.htm?input=inpuut-url&amp;output=output-url">http://my-site.something/my-page.htm?input<em>=input-url</em>&amp;output=<em>output-url</em></a></p>  <p>Please don’t click on this link – it won’t take you anywhere interesting. My apologies to those of you who clicked on it before reading this message. ;-)</p>  <p>The <em>input-url</em> and <em>output-url</em> parameters will be <a href="http://www.w3schools.com/tags/ref_urlencode.asp" target="_blank">URL-encoded</a> URLs (which would typically reside on the local file-system, but not necessarily, I suppose) to the input and output files. To say they’re URL-encoded means that they have any characters that might conflict with the outer URL (such as colons, forward-slashes, etc.) replaced with % and a hexadecimal number representing their ASCII value. An example as when you come across a space in an URL that gets replaced by %20. To encode filesystem URLs using .NET we had <a href="http://connect.microsoft.com/VisualStudio/feedback/details/594562/uri-class-does-not-parse-filesystem-url-with-query-string" target="_blank">a minor issue to deal with</a>, but the provided workaround was straightforward enough to include in our code.</p>  <p>So why also pass the output location? We could have maintained that value in the C# code, of course, setting it as a member variable on the Commands class that gets picked up later, but that makes for a more tightly-coupled system. We ideally want our DESKEW_IMAGE command to be a clean interface to our Python functionality so that it can be called separately. It does mean the values need to be URL-encoded, but that’s a fairly trivial task from most modern programming languages (and we could also adjust the code to pass these in a less web-centric – perhaps more LISP-friendly – way, if we so chose).</p>  <p>Here’s the additional C# code:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">[</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;DESKEW&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> DeskewRasterImageCommand()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> doc =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> asm = </span><span style="line-height: 140%; color: #2b91af">Assembly</span><span style="line-height: 140%">.GetExecutingAssembly();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> expath = </span><span style="line-height: 140%; color: #2b91af">Path</span><span style="line-height: 140%">.GetDirectoryName(asm.Location) + </span><span style="line-height: 140%; color: #a31515">&quot;\\&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> uipath = expath + </span><span style="line-height: 140%; color: #a31515">&quot;HTML\\&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pofo =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptOpenFileOptions</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;Select image file to de-skew&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pofo.Filter =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Portable Network Graphics (*.png)|*.png&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> cwd = </span><span style="line-height: 140%; color: #2b91af">Directory</span><span style="line-height: 140%">.GetCurrentDirectory();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pr = ed.GetFileNameForOpen(pofo);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> filename = pr.StringResult;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pofs =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptSaveFileOptions</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Specify file to save de-skewed image to&quot;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pofs.Filter =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Portable Network Graphics (*.png)|*.png&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pr = ed.GetFileNameForSave(pofs);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> deskewed = pr.StringResult;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Workaround: GetFileNameForOpen() seems to change the</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// working directory to that of the selected file</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #2b91af">Directory</span><span style="line-height: 140%">.SetCurrentDirectory(cwd);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> resized = </span><span style="line-height: 140%; color: #2b91af">Path</span><span style="line-height: 140%">.GetTempFileName();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> doresize = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> sz = ImageSize(filename);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (sz.Width &gt; 600 &amp;&amp; sz.Height &gt; 600) ||</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; sz.Width &gt; 1000 || sz.Height &gt; 1000</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; )</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ed.WriteMessage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;\nImage bounds are {0} x {1}. &quot;</span><span style="line-height: 140%">, sz.Width, sz.Height</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> newHeight, newWidth;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (sz.Width &gt; sz.Height)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; newHeight = 600;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; newWidth = sz.Width * newHeight / sz.Height;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; newWidth = 600;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; newHeight = sz.Height * newWidth / sz.Width;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; doresize =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; !GetYesOrNo(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;Resize to &quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; newWidth.ToString() + </span><span style="line-height: 140%; color: #a31515">&quot; x &quot;</span><span style="line-height: 140%"> + newHeight.ToString() + </span><span style="line-height: 140%; color: #a31515">&quot;?&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">true</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (doresize)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ResizeImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; filename, resized, newWidth, newHeight</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (!doresize)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">File</span><span style="line-height: 140%">.Copy(filename, resized, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// Workaround for Microsoft bug 594562:</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// http://connect.microsoft.com/VisualStudio/feedback/details/594562/uri-class-does-not-parse-filesystem-url-with-query-string</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// http://stackoverflow.com/questions/8757585/why-doesnt-system-uri-recognize-query-parameter-for-local-file-path</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> uriParserType = </span><span style="line-height: 140%; color: blue">typeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">UriParser</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> fileParserInfo =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; uriParserType.GetField(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;FileUri&quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #2b91af">BindingFlags</span><span style="line-height: 140%">.Static | </span><span style="line-height: 140%; color: #2b91af">BindingFlags</span><span style="line-height: 140%">.NonPublic</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> fileParser =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; (</span><span style="line-height: 140%; color: #2b91af">UriParser</span><span style="line-height: 140%">)fileParserInfo.GetValue(</span><span style="line-height: 140%; color: blue">null</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> fileFlagsInfo =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; uriParserType.GetField(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;m_Flags&quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #2b91af">BindingFlags</span><span style="line-height: 140%">.NonPublic | </span><span style="line-height: 140%; color: #2b91af">BindingFlags</span><span style="line-height: 140%">.Instance</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> fileFlags = (</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%">)fileFlagsInfo.GetValue(fileParser);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> mayHaveQuery = 0x20;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; fileFlags |= mayHaveQuery;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; fileFlagsInfo.SetValue(fileParser, fileFlags); </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> fileUri =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> System.</span><span style="line-height: 140%; color: #2b91af">Uri</span><span style="line-height: 140%">(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;file://&quot;</span><span style="line-height: 140%"> + uipath +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;ImageView.htm?input=&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">HttpUtility</span><span style="line-height: 140%">.UrlEncode(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; doresize ? resized : filename</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; ) +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #a31515">&quot;&amp;output=&quot;</span><span style="line-height: 140%"> + </span><span style="line-height: 140%; color: #2b91af">HttpUtility</span><span style="line-height: 140%">.UrlEncode(deskewed)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.ShowModalWindow(fileUri);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%"> ImageSize(</span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> imageFile)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> src = System.Drawing.</span><span style="line-height: 140%; color: #2b91af">Image</span><span style="line-height: 140%">.FromFile(imageFile))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Size</span><span style="line-height: 140%">(src.Width, src.Height);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// Based on</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: green">// http://stackoverflow.com/questions/11137979/image-resizing-using-c-sharp</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> ResizeImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> imageFile, </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> outputFile,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> newWidth, </span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> newHeight</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> src = System.Drawing.</span><span style="line-height: 140%; color: #2b91af">Image</span><span style="line-height: 140%">.FromFile(imageFile))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> newImage = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Bitmap</span><span style="line-height: 140%">(newWidth, newHeight))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">using</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> graphics = </span><span style="line-height: 140%; color: #2b91af">Graphics</span><span style="line-height: 140%">.FromImage(newImage))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; graphics.SmoothingMode = </span><span style="line-height: 140%; color: #2b91af">SmoothingMode</span><span style="line-height: 140%">.AntiAlias;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; graphics.InterpolationMode =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">InterpolationMode</span><span style="line-height: 140%">.HighQualityBicubic;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; graphics.PixelOffsetMode = </span><span style="line-height: 140%; color: #2b91af">PixelOffsetMode</span><span style="line-height: 140%">.HighQuality;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; graphics.DrawImage(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; src, </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">Rectangle</span><span style="line-height: 140%">(0, 0, newWidth, newHeight)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; newImage.Save(outputFile);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">private</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> GetYesOrNo(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> prompt,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> defval</span></p>    <p style="margin: 0px"><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> changed = </span><span style="line-height: 140%; color: blue">false</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pko =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: #2b91af">PromptKeywordOptions</span><span style="line-height: 140%">(prompt + </span><span style="line-height: 140%; color: #a31515">&quot; [Yes/No]: &quot;</span><span style="line-height: 140%">, </span><span style="line-height: 140%; color: #a31515">&quot;Yes No&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// The default depends on our current settings</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; pko.Keywords.Default = (defval ? </span><span style="line-height: 140%; color: #a31515">&quot;Yes&quot;</span><span style="line-height: 140%"> : </span><span style="line-height: 140%; color: #a31515">&quot;No&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> pr = ed.GetKeywords(pko);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pr.Status == </span><span style="line-height: 140%; color: #2b91af">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Change the settings, as needed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">bool</span><span style="line-height: 140%"> newval =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; (pr.StringResult == </span><span style="line-height: 140%; color: #a31515">&quot;Yes&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (defval != newval)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; changed = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> changed;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>Here are a few boring demonstration videos of the DESKEW command in action. I say they’re boring but the first minute and the last 5 seconds of each are actually quite interesting, and the bits in between I’ve left uncut to give people a sense of how long the code currently takes to work. Please feel free to fast forward those parts, although it is kinda cool to see AutoCAD’s progress meter being controlled from Python code.</p>  <p>Here’s the de-skewing of the painting in my living room:</p> <iframe height="264" src="//www.youtube.com/embed/ScmWhl73woo?rel=0" frameborder="0" width="470" allowfullscreen="allowfullscreen"></iframe>  <p>And here’s the de-skewing of the original whiteboard image provided as part of <a href="http://through-the-interface.typepad.com/through_the_interface/2013/08/coursera-the-future-of-education.html" target="_blank">the linear algebra class</a> that inspired this project: </p> <iframe height="264" src="//www.youtube.com/embed/Z9Ti8YH8mzc?rel=0" frameborder="0" width="470" allowfullscreen="allowfullscreen"></iframe>  <p>That’s about it for the main body of this series. That said – and as I’ve mentioned before – I do want to investigate the possibility of moving the Python core into the cloud, most probably using Google App Engine. We could then decouple the application even further from AutoCAD, by calling the web-service directly from the HTML page and only then launching (for instance) the IMAGEATTACH command inside AutoCAD with the output image location.</p>  <p>I’d also like to see whether Google’s famed <a href="http://en.wikipedia.org/wiki/MapReduce" target="_blank">MapReduce</a> mechanism can usefully be thrown at parts of the problem (the most likely candidate area being the code that currently generates the output pixels from the transformed image information). I expect the overhead would only make sense for larger images, but we’ll see.</p>
