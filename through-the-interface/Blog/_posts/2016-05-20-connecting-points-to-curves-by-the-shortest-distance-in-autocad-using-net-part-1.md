---
layout: "post"
title: "Connecting points to curves by the shortest distance in AutoCAD using .NET &ndash; Part 1"
date: "2016-05-20 11:30:33"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Geometry"
original_url: "https://www.keanw.com/2016/05/connecting-points-to-curves-by-the-shortest-distance-in-autocad-using-net-part-1.html "
typepad_basename: "connecting-points-to-curves-by-the-shortest-distance-in-autocad-using-net-part-1"
typepad_status: "Publish"
---

<p><a href="http://forums.autodesk.com/t5/visual-lisp-autolisp-and-general/draw-polyline-to-nearest-point/m-p/6338092" target="_blank">A question came into the LISP forum</a> during <a href="http://through-the-interface.typepad.com/through_the_interface/2016/05/the-autocad-answer-day-is-starting.html" target="_blank">Wednesday’s Answer Day</a>. It related to a really interesting task: to take certain blocks in a drawing and connect them to the closest polyline via a perpendicular line. It took me a little while to understand, but basically the problem relates to pipeline design: there are gully posts – represented as blocks – that need to be connected to pipelines (polylines) in the drawing. They need to be connected by the shortest path, which will be perpendicular to the pipeline (assuming the pipeline is long enough, of course).</p> <p>It was too juicy a problem to put to one side, so I ended up putting a little code together. I chose to solve it using C#: LISP wasn’t a hard and fast requirement, and it’s far easier for me to code it in .NET. The answer I originally gave on the forum was unnecessarily complicated, as it turns out, but we’ll see that on Monday when we extend this code to also search for pipelines in the drawing.</p> <p>So, to start with, let’s see some C# code that asks the user to select a block and a curve, and we connect the two via a line. As requested, the code takes the insertion point of the block for the initial connection point.</p> <div style="font-size: 8pt; font-family: courier new; background: white; color: black; line-height: 140%"> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.ApplicationServices;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.DatabaseServices;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.EditorInput;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Geometry;</p> <p style="margin: 0px"><span style="color: blue">using</span> Autodesk.AutoCAD.Runtime;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">namespace</span> ConnectBlocksToCurves</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">class</span> <span style="color: #2b91af">Extensions</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">double</span> DistanceFrom(<span style="color: blue">this</span> <span style="color: #2b91af">Curve</span> c, <span style="color: #2b91af">Point3d</span> pt)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> pt.DistanceTo(c.GetClosestPointTo(pt, <span style="color: blue">false</span>));</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> ConnectPointToCurve(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">BlockTableRecord</span> btr,</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Point3d</span> pt, <span style="color: #2b91af">Curve</span> c</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; )</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr.DrawLine(btr, pt, c.GetClosestPointTo(pt, <span style="color: blue">false</span>));</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> DrawLine(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span> <span style="color: #2b91af">Transaction</span> tr, <span style="color: #2b91af">BlockTableRecord</span> btr, <span style="color: #2b91af">Point3d</span> pt1, <span style="color: #2b91af">Point3d</span> pt2</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; )</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> ln = <span style="color: blue">new</span> <span style="color: #2b91af">Line</span>(pt1, pt2);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; btr.AppendEntity(ln);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr.AddNewlyCreatedDBObject(ln, <span style="color: blue">true</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Commands</span></p> <p style="margin: 0px">&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">"B2C"</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> Block2Curve()</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> doc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (doc == <span style="color: blue">null</span>)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> db = doc.Database;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> ed = doc.Editor;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Get the block to connect</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> peo = <span style="color: blue">new</span> <span style="color: #2b91af">PromptEntityOptions</span>(<span style="color: #a31515">"\nSelect the block"</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; peo.SetRejectMessage(<span style="color: #a31515">"\nMust be a block."</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; peo.AddAllowedClass(<span style="color: blue">typeof</span>(<span style="color: #2b91af">BlockReference</span>), <span style="color: blue">false</span>);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> per = ed.GetEntity(peo);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (per.Status != <span style="color: #2b91af">PromptStatus</span>.OK)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> brId = per.ObjectId;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Get the curve to connect it to</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> peo2 = <span style="color: blue">new</span> <span style="color: #2b91af">PromptEntityOptions</span>(<span style="color: #a31515">"\nSelect the curve"</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; peo2.SetRejectMessage(<span style="color: #a31515">"\nMust be a curve."</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; peo2.AddAllowedClass(<span style="color: blue">typeof</span>(<span style="color: #2b91af">Curve</span>), <span style="color: blue">false</span>);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> per2 = ed.GetEntity(peo2);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (per2.Status != <span style="color: #2b91af">PromptStatus</span>.OK)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> cId = per2.ObjectId;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Use a transaction for the geometry access and connection creation</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: blue">var</span> tr = doc.TransactionManager.StartTransaction())</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> br = tr.GetObject(brId, <span style="color: #2b91af">OpenMode</span>.ForRead) <span style="color: blue">as</span> <span style="color: #2b91af">BlockReference</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> c = tr.GetObject(cId, <span style="color: #2b91af">OpenMode</span>.ForRead) <span style="color: blue">as</span> <span style="color: #2b91af">Curve</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (br != <span style="color: blue">null</span> &amp;&amp; c != <span style="color: blue">null</span>)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// We'll be writing to the modelspace</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> btr =</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (<span style="color: #2b91af">BlockTableRecord</span>)tr.GetObject(</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">SymbolUtilityServices</span>.GetBlockModelSpaceId(db), <span style="color: #2b91af">OpenMode</span>.ForWrite</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Connect the point to the closest point on the curve</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr.ConnectPointToCurve(btr, br.Position, c);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr.Commit();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <p>Here’s the code in action:</p> <p><a href="http://through-the-interface.typepad.com/.a/6a00d83452464869e201b7c85f9df6970b-pi" target="_blank"><img title="Connecting a point to a curve" style="float: none; margin: 30px auto; display: block" alt="Connecting a point to a curve" src="/assets/image_248898.jpg" width="499" height="488"></a></p> <p>On Monday we’ll extend this to connect any block of the selected type to the nearest curve of any type in the drawing. Which is thankfully much simpler than it sounds.</p>
