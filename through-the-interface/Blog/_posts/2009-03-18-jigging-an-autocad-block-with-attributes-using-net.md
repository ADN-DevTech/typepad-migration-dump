---
layout: "post"
title: "Jigging an AutoCAD block with attributes using .NET"
date: "2009-03-18 17:55:35"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Blocks"
  - "Jigs"
original_url: "https://www.keanw.com/2009/03/jigging-an-autocad-block-with-attributes-using-net.html "
typepad_basename: "jigging-an-autocad-block-with-attributes-using-net"
typepad_status: "Publish"
---

<p><em>Thanks, once again, to Philippe Leefsma, a DevTech engineer based in Prague, for contributing the code for this post. While researching an issue he was working on Philippe stumbled across a comment on </em><a href="http://through-the-interface.typepad.com/through_the_interface/2007/05/using_a_jig_fro_1.html"><em>this previous post</em></a><em> where I more-or-less said jigging attributes wasn’t possible. Ahem. Anyway, Philippe decided to – quite rightly – prove me wrong, and the result is today’s post. :-)</em></p>  <p>It turns out that the trick to jigging a block with attributes is to add the block reference to the database prior to running the jig. I’d been coming at this from another direction – working out how to call through to the right version of the ObjectARX function, the one that allows the block reference to be in-memory rather than db-resident – but Philippe’s approach means that’s no longer needed. I see this technique as potentially being useful when jigging other entities that benefit from being database resident (Solid3d objects spring to mind), so I really appreciate Philippe’s hard work on this.</p>  <p>Here’s the C# code which I’ve edited for posting:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Collections.Generic;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> BlockJig</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">CBlockJig</span><span style="line-height: 140%"> : </span><span style="color: #2b91af; line-height: 140%">EntityJig</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> _pos;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%">&lt;</span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%">, </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">&gt; _attPos;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Transaction</span><span style="line-height: 140%"> _tr;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> CBlockJig(</span><span style="color: #2b91af; line-height: 140%">Transaction</span><span style="line-height: 140%"> tr, </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%"> br)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; : </span><span style="color: blue; line-height: 140%">base</span><span style="line-height: 140%">(br)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _pos = br.Position;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Initialize our dictionary with the tag /</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// AttributeDefinition position</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _attPos = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%">&lt;</span><span style="color: blue; line-height: 140%">string</span><span style="line-height: 140%">, </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">&gt;();</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _tr = tr;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%"> btr =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%">)_tr.GetObject(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; br.BlockTableRecord,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (btr.HasAttributeDefinitions)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%"> id </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> btr)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">DBObject</span><span style="line-height: 140%"> obj =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.GetObject(id, </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttributeDefinition</span><span style="line-height: 140%"> ad =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; obj </span><span style="color: blue; line-height: 140%">as</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttributeDefinition</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ad != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _attPos.Add(ad.Tag, ad.Position);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> Update()</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%"> br = Entity </span><span style="color: blue; line-height: 140%">as</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; br.Position = _pos;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (br.AttributeCollection.Count != 0)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%"> id </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> br.AttributeCollection)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">DBObject</span><span style="line-height: 140%"> obj =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _tr.GetObject(id, </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%"> ar =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; obj </span><span style="color: blue; line-height: 140%">as</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Apply block transform to att def position</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ar != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.UpgradeOpen();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.Position =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _attPos[ar.Tag].TransformBy(br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%"> Sampler(</span><span style="color: #2b91af; line-height: 140%">JigPrompts</span><span style="line-height: 140%"> prompts)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">JigPromptPointOptions</span><span style="line-height: 140%"> opts =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">JigPromptPointOptions</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;\nSelect insertion point:&quot;</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; opts.BasePoint = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(0, 0, 0);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; opts.UserInputControls =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">UserInputControls</span><span style="line-height: 140%">.NoZeroResponseAccepted;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptPointResult</span><span style="line-height: 140%"> ppr = prompts.AcquirePoint(opts);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_pos == ppr.Value)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%">.NoChange;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _pos = ppr.Value;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%">.OK;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%"> Run()</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptResult</span><span style="line-height: 140%"> promptResult = ed.Drag(</span><span style="color: blue; line-height: 140%">this</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> promptResult.Status;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Commands</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; [</span><span style="color: #2b91af; line-height: 140%">CommandMethod</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;BJ&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> BlockJig()</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Database</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptStringOptions</span><span style="line-height: 140%"> pso =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptStringOptions</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;\nEnter block name: &quot;</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptResult</span><span style="line-height: 140%"> pr = ed.GetString(pso);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Transaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; doc.TransactionManager.StartTransaction();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockTable</span><span style="line-height: 140%"> bt =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">BlockTable</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.BlockTableId,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%"> space =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.CurrentSpaceId,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (!bt.Has(pr.StringResult))</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.WriteMessage(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;\nBlock \&quot;&quot;</span><span style="line-height: 140%"> + pr.StringResult + </span><span style="color: #a31515; line-height: 140%">&quot;\&quot; not found.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; space.UpgradeOpen();</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%"> btr =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; bt[pr.StringResult],</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Block needs to be inserted to current space before</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// being able to append attribute to it</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%"> br =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%">(</span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(), btr.ObjectId);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; space.AppendEntity(br);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(br, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (btr.HasAttributeDefinitions)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%"> id </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> btr)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">DBObject</span><span style="line-height: 140%"> obj =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.GetObject(id, </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttributeDefinition</span><span style="line-height: 140%"> ad =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; obj </span><span style="color: blue; line-height: 140%">as</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttributeDefinition</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ad != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> &amp;&amp; !ad.Constant)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%"> ar =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%">();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.SetAttributeFromBlock(ad, br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.Position =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ad.Position.TransformBy(br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.TextString = ad.TextString;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; br.AttributeCollection.AppendAttribute(ar);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(ar, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Run the jig</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">CBlockJig</span><span style="line-height: 140%"> myJig = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">CBlockJig</span><span style="line-height: 140%">(tr, br);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (myJig.Run() != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Commit changes if user accepted, otherwise discard</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.Commit();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>When you run the BJ command (short for BlockJig) and specify the name of a block in the current drawing which contains attributes, you’ll now see the attributes with their default values shown as part of the block being jigged. Implementing the code to allow editing of those attributes after insertion is left as an exercise for the reader.</p>  <p><strong><em>Update:</em></strong></p>  <p>This code didn&#39;t work for a few situations, such as when using justification (attributes would end up at the origin after being dragged) or with MText attributes (which would start at the origin until the mouse was moved).</p>  <p>A big thanks to Roland Feletic from PAUSER ZT-GMBH for helping identify and diagnose the various cases.</p>  <p>Here&#39;s the updated C# code:</p>  <div style="font-size: 8pt; font-family: courier new; background: white; color: black">   <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Runtime;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.ApplicationServices;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.DatabaseServices;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.EditorInput;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> Autodesk.AutoCAD.Geometry;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> System.Collections.Generic;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="color: blue; line-height: 140%">namespace</span><span style="line-height: 140%"> BlockJigApplication</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttInfo</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> _pos;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> _aln;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> _aligned;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> AttInfo(</span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> pos, </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> aln, </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> aligned)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _pos = pos;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _aln = aln;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _aligned = aligned;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> Position</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">set</span><span style="line-height: 140%"> { _pos = </span><span style="color: blue; line-height: 140%">value</span><span style="line-height: 140%">; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">get</span><span style="line-height: 140%"> { </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> _pos; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> Alignment</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">set</span><span style="line-height: 140%"> { _aln = </span><span style="color: blue; line-height: 140%">value</span><span style="line-height: 140%">; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">get</span><span style="line-height: 140%"> { </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> _aln; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> IsAligned</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">set</span><span style="line-height: 140%"> { _aligned = </span><span style="color: blue; line-height: 140%">value</span><span style="line-height: 140%">; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">get</span><span style="line-height: 140%"> { </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> _aligned; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BlockJig</span><span style="line-height: 140%"> : </span><span style="color: #2b91af; line-height: 140%">EntityJig</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%"> _pos;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%">, </span><span style="color: #2b91af; line-height: 140%">AttInfo</span><span style="line-height: 140%">&gt; _attInfo;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">private</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Transaction</span><span style="line-height: 140%"> _tr;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> BlockJig(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Transaction</span><span style="line-height: 140%"> tr,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%"> br,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%">, </span><span style="color: #2b91af; line-height: 140%">AttInfo</span><span style="line-height: 140%">&gt; attInfo</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; ) : </span><span style="color: blue; line-height: 140%">base</span><span style="line-height: 140%">(br)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _pos = br.Position;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _attInfo = attInfo;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _tr = tr;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">bool</span><span style="line-height: 140%"> Update()</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%"> br = Entity </span><span style="color: blue; line-height: 140%">as</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; br.Position = _pos;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (br.AttributeCollection.Count != 0)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%"> id </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> br.AttributeCollection)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">DBObject</span><span style="line-height: 140%"> obj =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; _tr.GetObject(id, </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%"> ar =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; obj </span><span style="color: blue; line-height: 140%">as</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Apply block transform to att def position</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ar != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%">)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.UpgradeOpen();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttInfo</span><span style="line-height: 140%"> ai = _attInfo[ar.ObjectId];</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.Position =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ai.Position.TransformBy(br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ai.IsAligned)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.AlignmentPoint =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ai.Alignment.TransformBy(br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ar.IsMTextAttribute)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.UpdateMTextAttribute();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">protected</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">override</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%"> Sampler(</span><span style="color: #2b91af; line-height: 140%">JigPrompts</span><span style="line-height: 140%"> prompts)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">JigPromptPointOptions</span><span style="line-height: 140%"> opts =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">JigPromptPointOptions</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;\nSelect insertion point:&quot;</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; opts.BasePoint = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(0, 0, 0);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; opts.UserInputControls =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">UserInputControls</span><span style="line-height: 140%">.NoZeroResponseAccepted;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptPointResult</span><span style="line-height: 140%"> ppr = prompts.AcquirePoint(opts);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (_pos == ppr.Value)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%">.NoChange;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; _pos = ppr.Value;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">SamplerStatus</span><span style="line-height: 140%">.OK;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%"> Run()</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptResult</span><span style="line-height: 140%"> promptResult = ed.Drag(</span><span style="color: blue; line-height: 140%">this</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%"> promptResult.Status;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">class</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Commands</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; [</span><span style="color: #2b91af; line-height: 140%">CommandMethod</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;BJ&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">static</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">public</span><span style="line-height: 140%"> </span><span style="color: blue; line-height: 140%">void</span><span style="line-height: 140%"> BlockJigCmd()</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Document</span><span style="line-height: 140%"> doc =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Database</span><span style="line-height: 140%"> db = doc.Database;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Editor</span><span style="line-height: 140%"> ed = doc.Editor;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptStringOptions</span><span style="line-height: 140%"> pso =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">PromptStringOptions</span><span style="line-height: 140%">(</span><span style="color: #a31515; line-height: 140%">&quot;\nEnter block name: &quot;</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">PromptResult</span><span style="line-height: 140%"> pr = ed.GetString(pso);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (pr.Status != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Transaction</span><span style="line-height: 140%"> tr =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; doc.TransactionManager.StartTransaction();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">using</span><span style="line-height: 140%"> (tr)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockTable</span><span style="line-height: 140%"> bt =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">BlockTable</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.BlockTableId,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (!bt.Has(pr.StringResult))</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ed.WriteMessage(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #a31515; line-height: 140%">&quot;\nBlock \&quot;&quot;</span><span style="line-height: 140%"> + pr.StringResult + </span><span style="color: #a31515; line-height: 140%">&quot;\&quot; not found.&quot;</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%"> space =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; db.CurrentSpaceId,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForWrite</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%"> btr =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (</span><span style="color: #2b91af; line-height: 140%">BlockTableRecord</span><span style="line-height: 140%">)tr.GetObject(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; bt[pr.StringResult],</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Block needs to be inserted to current space before</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// being able to append attribute to it</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%"> br =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BlockReference</span><span style="line-height: 140%">(</span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Point3d</span><span style="line-height: 140%">(), btr.ObjectId);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; space.AppendEntity(br);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(br, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%">, </span><span style="color: #2b91af; line-height: 140%">AttInfo</span><span style="line-height: 140%">&gt; attInfo =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">Dictionary</span><span style="line-height: 140%">&lt;</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%">,</span><span style="color: #2b91af; line-height: 140%">AttInfo</span><span style="line-height: 140%">&gt;();</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (btr.HasAttributeDefinitions)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">foreach</span><span style="line-height: 140%"> (</span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%"> id </span><span style="color: blue; line-height: 140%">in</span><span style="line-height: 140%"> btr)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">DBObject</span><span style="line-height: 140%"> obj =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.GetObject(id, </span><span style="color: #2b91af; line-height: 140%">OpenMode</span><span style="line-height: 140%">.ForRead);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttributeDefinition</span><span style="line-height: 140%"> ad =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; obj </span><span style="color: blue; line-height: 140%">as</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttributeDefinition</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ad != </span><span style="color: blue; line-height: 140%">null</span><span style="line-height: 140%"> &amp;&amp; !ad.Constant)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%"> ar =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttributeReference</span><span style="line-height: 140%">();</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.SetAttributeFromBlock(ad, br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.Position =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ad.Position.TransformBy(br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ad.Justify != </span><span style="color: #2b91af; line-height: 140%">AttachmentPoint</span><span style="line-height: 140%">.BaseLeft)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.AlignmentPoint =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ad.AlignmentPoint.TransformBy(br.BlockTransform);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (ar.IsMTextAttribute)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.UpdateMTextAttribute();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ar.TextString = ad.TextString;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">ObjectId</span><span style="line-height: 140%"> arId =</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; br.AttributeCollection.AppendAttribute(ar);</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.AddNewlyCreatedDBObject(ar, </span><span style="color: blue; line-height: 140%">true</span><span style="line-height: 140%">);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Initialize our dictionary with the ObjectId of</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// the attribute reference + attribute definition info</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; attInfo.Add(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; arId,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">AttInfo</span><span style="line-height: 140%">(</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ad.Position,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ad.AlignmentPoint,</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ad.Justify != </span><span style="color: #2b91af; line-height: 140%">AttachmentPoint</span><span style="line-height: 140%">.BaseLeft</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; )</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; );</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Run the jig</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: #2b91af; line-height: 140%">BlockJig</span><span style="line-height: 140%"> myJig = </span><span style="color: blue; line-height: 140%">new</span><span style="line-height: 140%"> </span><span style="color: #2b91af; line-height: 140%">BlockJig</span><span style="line-height: 140%">(tr, br, attInfo);</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">if</span><span style="line-height: 140%"> (myJig.Run() != </span><span style="color: #2b91af; line-height: 140%">PromptStatus</span><span style="line-height: 140%">.OK)</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: blue; line-height: 140%">return</span><span style="line-height: 140%">;</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span><span style="color: green; line-height: 140%">// Commit changes if user accepted, otherwise discard</span></p>    <p style="font-size: 8pt; margin: 0px">&#0160;</p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; tr.Commit();</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160;&#0160;&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">&#0160; }</span></p>    <p style="font-size: 8pt; margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>A few comments on this code:</p>  <ul>   <li>It&#39;s been refactored to make a single pass through the block definition to both create the block reference and collect the attribute information to store in our dictionary. </li>    <li>The attribute information is now held in a class, which allows us to store more than just the position in our dictionary (without using multiple dictionaries), I went to the effort of exposing public properties for the various private members, as this is generally a good technique to use (if a little redundant, here). </li>    <li>The dictionary now stores this attribute information against an ObjectId rather than the tag string. Roland made the excellent point that blocks can contain attributes with duplicate tags, so this is much safe. We also had to use the ObjectId of the AttributeReference, as later on inside the jig&#39;s Update() function we no longer have access to the AttributeDefinition. </li> </ul>  <p><em><strong>Update 2:</strong></em></p>  <p>Please see <a href="http://through-the-interface.typepad.com/through_the_interface/2015/05/jigging-an-autocad-block-with-attributes-using-net-redux.html" target="_blank">this more recent post</a> for an implementation that works properly with multiline attributes, UCS and annotation scaling.</p>
