---
layout: "post"
title: "Jigging an AutoCAD circle from a JavaScript-defined command"
date: "2013-05-03 15:21:04"
author: "Kean Walmsley"
categories:
  - "AutoCAD"
  - "AutoCAD .NET"
  - "Commands"
  - "Geometry"
  - "Graphics system"
  - "JavaScript"
  - "Jigs"
  - "Runtime"
  - "Visual Studio"
original_url: "https://www.keanw.com/2013/05/jigging-an-autocad-circle-from-a-javascript-defined-command.html "
typepad_basename: "jigging-an-autocad-circle-from-a-javascript-defined-command"
typepad_status: "Publish"
---

<p>Just to complement <a href="http://through-the-interface.typepad.com/through_the_interface/2013/05/jigging-an-autocad-circle-using-javascript.html" target="_blank">yesterday’s post</a> showing how to define a simple jig using JavaScript, here’s the same code from <a href="http://through-the-interface.typepad.com/files/CircleJig.js" target="_blank">a separate .js file</a>:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> doc = Acad.Application.activedocument;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> center = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.Point3d(0, 0, 0);</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> radius = 0;</span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> trId;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> pointToString(pt) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> ret =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pt.x.toString() + </span><span style="line-height: 140%; color: maroon">&quot;,&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pt.y.toString() + </span><span style="line-height: 140%; color: maroon">&quot;,&quot;</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pt.z.toString();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> ret;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> createCircle(cen, rad, first) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Build an XML string containing data to create</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// an AcGiTransient that represents the circle</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> cursor = </span><span style="line-height: 140%; color: maroon">''</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> drawable =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;'</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;drawable '</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'xmlns=&quot;http://www.autodesk.com/AutoCAD/drawstream.xsd&quot; '</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'xmlns:t=&quot;http://www.autodesk.com/AutoCAD/transient.xsd&quot; '</span><span style="line-height: 140%">+</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'t:onmouseover=&quot;onmouseover&quot;'</span><span style="line-height: 140%"> + cursor + </span><span style="line-height: 140%; color: maroon">'&gt;'</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;graphics id=&quot;id1&quot;&gt;&lt;circle center =&quot;'</span><span style="line-height: 140%"> + pointToString(cen) +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&quot; radius =&quot;'</span><span style="line-height: 140%"> + rad.toString() + </span><span style="line-height: 140%; color: maroon">'&quot;/&gt;'</span><span style="line-height: 140%"> +</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'&lt;/graphics&gt;&lt;/drawable&gt;'</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> drawable;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> circleJig() {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onJigUpdate(args) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> res = JSON.parse(args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (res) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// The value being updated is the distance</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; radius = res.distance;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Use it to create the XML for a transient</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// circle and ask for it to be displayed</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> x = createCircle(center, radius);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; doc.transientManager.updateTransient(trId, x);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onJigComplete(args) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// When the jig is over, remove the transient</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; doc.transientManager.eraseTransient(trId);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> res = JSON.parse(args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (res &amp;&amp; res.dragStatus == Acad.DragStatus.kNormal) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Acad.Editor.executeCommandAsync(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: maroon">'_.CIRCLE '</span><span style="line-height: 140%"> + pointToString(center) + </span><span style="line-height: 140%; color: maroon">' '</span><span style="line-height: 140%"> + radius</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onJigError(args) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; write(</span><span style="line-height: 140%; color: maroon">'\nUnable to create circle: '</span><span style="line-height: 140%"> + args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onPointSelected(args) {</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> res = JSON.parse(args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (res) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; center =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.Point3d(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; res.value.x,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; res.value.y,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; res.value.z</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; );</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Now we can create our transient</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> tran = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.Transient();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; trId = tran.getId();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// And ask for it to be drawn</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> x = createCircle(center, 0, </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; doc.transientManager.addTransient(tran, x);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Set up our jig options</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> opts =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.JigPromptDistanceOptions(</span><span style="line-height: 140%; color: maroon">'Point on radius'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; opts.basePoint = center;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; opts.useBasePoint = </span><span style="line-height: 140%; color: blue">true</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #006400">// Run the jig to select the distance</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> jig = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.DrawJig(onJigUpdate, opts);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; Acad.Editor.drag(jig).then(onJigComplete, onJigError);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">function</span><span style="line-height: 140%"> onPointError(args) {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; write(</span><span style="line-height: 140%; color: maroon">'\nUnable to select point: '</span><span style="line-height: 140%"> + args);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// Ask the user to select the center point before we</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: #006400">// start the jig</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> opts = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> Acad.PromptPointOptions(</span><span style="line-height: 140%; color: maroon">'Select center'</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Acad.Editor.getPoint(opts).then(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; onPointSelected, onPointError</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; );</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">Acad.Editor.addCommand(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;JIG_CMDS&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;CJ&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: maroon">&quot;CJ&quot;</span><span style="line-height: 140%">,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; Acad.CommandFlag.MODAL,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; circleJig</span></p>    <p style="margin: 0px"><span style="line-height: 140%">);</span></p> </div>  <p>You can test this without the need for a separate .NET loader by just copying this into the command-line in AutoCAD 2014:</p>  <p><font face="Courier New">(command &quot;_.WEBLOAD&quot; &quot;</font><a href="http://through-the-interface.typepad.com/files/CircleJig.js"><font face="Courier New">http://through-the-interface.typepad.com/files/CircleJig.js</font></a><font face="Courier New">&quot;)</font></p>  <p>Then you should be able to run the CJ command to jig a circle from JavaScript.</p>  <p>Again, you’ll see the issue related to clicking the point on the radius (unless it’s system-specific, which would surprise me a great deal), but it’ll give you a sense of the kind of responsiveness to expect from a JavaScript-implemented jig.</p>  <p>On a general note, I’ve been finding that it’s simplest to code within a full HTML page – as the reference to the AutoCAD Shaping Layer JavaScript file gives more useful IntelliSense. It does mean you need a .NET loader module to test, but once you have it set up, it’s there. What’s also very handy about this approach is that each time the loader command (in my case it’s called JSP) is run, it reloads the palette from wherever it’s located. So you can change the code and re-run the loader command without restarting AutoCAD (something that’s really entered into <a href="http://en.wikipedia.org/wiki/Muscle_memory" target="_blank">muscle memory</a> after all these years of developing with .NET and <a href="http://connect.microsoft.com/VisualStudio/feedback/details/736684/edit-and-continue-is-not-supported-when-debugging-a-64-bit-application" target="_blank">not having Edit &amp; Continue</a>). One caveat to this is if your code causes the AcWebBrowser to crash: if that’s the case (and it’s pretty common, at least with my code ;-) then you’ll need to restart AutoCAD.</p>  <p>I also tend to load the HTML page from the local file system (using a URL such as&#160; “file://C:\Path\To\MyPalette.html” in the loader module), as this avoids the pain of having to push it to a web-server and deal with the caching issues when loading. It may not have been obvious from prior posts that you can load from a local file system, so I should confirm that it’s possible and furthermore works very well.</p>  <p>In terms of debugging, I’ve been using the technique shown in <a href="http://adndevblog.typepad.com/autocad/2013/03/enabling-autocad-2014-javascript-debugging.html" target="_blank">Fenton’s very handy blog post</a> to enable some level of debugging of HTML-defined palettes (another advantage over a separate .js loaded via WEBLOAD). The server that hosts the HTML inspector tool has changed, however – the URL needs to be changed to “<a href="http://drawingfeed.visualtao.net/DevTools/inspector/devtools.html">http://drawingfeed.visualtao.net/DevTools/inspector/devtools.html</a>” – but I’m sure the DevBlog post will be updated soon (and may well have been by the time many of you end up reading this).</p>  <p>That said, I still find I’m inserting lots of write() statements into my code (which causes messages to be written to the AutoCAD command-line, the equivalent of acutPrintf() or Editor.WriteMessage()). Maybe that’s another bit of (this time web-development focused) muscle memory that I’ve retained in spite of the world having moved on, but I find it’s a quick enough way of working out what’s going on in the code. Once I get around to using more capabilities provided by the JavaScript debugger, I’ll hopefully find I can afford to unlearn this particular behaviour, but then the fact the debugger also gets blown away when AcWebBrowser crashes means there are a lot of scenarios that write() is still better suited to report on.</p>
