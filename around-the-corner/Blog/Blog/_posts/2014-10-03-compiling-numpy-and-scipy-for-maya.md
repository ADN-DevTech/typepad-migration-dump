---
layout: "post"
title: "Compiling NumPy and SciPy for Maya"
date: "2014-10-03 00:25:12"
author: "Cyrille Fauvel"
categories:
  - "Cyrille Fauvel"
  - "Maya"
  - "Python"
  - "Tools"
  - "Windows"
original_url: "https://around-the-corner.typepad.com/adn/2014/10/compiling-numpy-and-scipy-for-maya.html "
typepad_basename: "compiling-numpy-and-scipy-for-maya"
typepad_status: "Draft"
---

<p>The&#0160;<a href="http://www.numpy.org/" rel="nofollow">NumPy&#0160;</a>and&#0160;<a href="http://www.scipy.org/" rel="nofollow">SciPy</a>&#0160;packages come up frequently in support requests. There exists 64 bits versions maintained by&#0160;<a href="http://www.lfd.uci.edu/~gohlke/pythonlibs" rel="nofollow">Christophe Gohlke</a>&#0160;built with VS 2008 but these are not compatible with Maya since the compiler used is more recent and the C/C++ runtime library mismatch causes instability.</p>
<p>Normally any user can build modules using the Express versions of Visual Studio and the provided setup.py scripts, but for these modules you need:</p>
<ul>
<li>a 3rd party linear algebra solver</li>
<li>a Fortran compiler</li>
</ul>
<h2>Solution:</h2>
<p>There are currently two ways to generate these 64 bit libraries:</p>
<ul>
<li>Use Intel Fortran compiler and the MKL solver</li>
<li>Use a custom built mingw-w64 toolchain with any compatible open sourced solver</li>
</ul>
<p>The NumPy/SciPy team are on the receiving end of&#0160;<a href="http://mail.scipy.org/pipermail/numpy-discussion/2013-September/067750.html" rel="nofollow">free copies</a>&#0160;of the Intel tools and they can redistribute the MKL libraries as part of the packages, but doing the same on the Autodesk side would require some licensing negotiations with Intel before proceeding further. This is a very viable option, but until the legal aspect is cleared, we are left with exploring ways where the Mingw-w64 toolchain can be used to generated these libraries.</p>
<h2>Packages:</h2>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/numpy-1.7.1-Maya2014.win-amd64.7z?version=1&amp;modificationDate=1380050503000&amp;api=v2">NumPy 1.7.1 for Maya 2014</a></p>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/scipy-0.12.0-Maya2014.win-amd64.7z?version=1&amp;modificationDate=1380050503000&amp;api=v2">SciPy 0.12.0 for Maya2014</a></p>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/Pillow-2.1.0.Maya2014-win-amd64.7z?version=1&amp;modificationDate=1380050503000&amp;api=v2">Pillow 2.1.0 for Maya2014</a>&#0160;a modern fork of the Python Imaging Library (PIL)</p>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/numpy-1.7.1-Maya2015.win-amd64.7z?version=2&amp;modificationDate=1380115479000&amp;api=v2">NumPy 1.7.1 for Maya2015</a></p>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/scipy-0.12.0-Maya2015.win-amd64.7z?version=2&amp;modificationDate=1380115526000&amp;api=v2">SciPy 0.12.0 for Maya2015</a></p>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/PyOpenGL-3.1.0b2.Maya2015.win-amd64.7z?version=1&amp;modificationDate=1396619397000&amp;api=v2">PyOpenGL-3.1.0b2 for Maya2015</a></p>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/PyOpenGL-accelerate-3.1.0b2.Maya2015.win-amd64.7z?version=1&amp;modificationDate=1396619411000&amp;api=v2">PyOpenGL-accelerate-3.1.0b2 for Maya2015</a></p>
<h2>Toolchains:</h2>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/mingw64-gcc481-msvcr100.7z?version=1&amp;modificationDate=1380050503000&amp;api=v2">Maya 2013/2014</a>&#0160;(uses the msvcr100 runtime DLL)</p>
<p><a href="https://wiki.autodesk.com/download/attachments/135930422/mingw64-gcc481-msvcr110.7z?version=1&amp;modificationDate=1380050503000&amp;api=v2">Maya 2015</a>&#0160;(uses the msvcr110 runtime DLL)</p>
<p>All toolchains use mingw-w64 built around GCC 4.8.1 using the SetJump/LongJump exception handling model.</p>
<h2>Setting up a mingw-w64 environment:</h2>
<p>1- Unpack a&#0160;<a href="http://sourceforge.net/projects/mingw-w64/files/External%20binary%20packages%20(Win64%20hosted)/MSYS%20(32-bit)/" rel="nofollow">lightweight msys</a>&#0160;Unix environment and a toolchain from the previous section in the same folder. You should have C:\mingw\msys and C:\mingw\mingw64</p>
<p>2- Start a msys command shell using C:\mingw\msys\msys.bat</p>
<p>3- use vim to create the /etc/fstab file containing the following line: &quot;c:/mingw/mingw64/mingw&quot;</p>
<p>4- Exit the shell and start a new one. Executing &quot;gcc --version&quot; should return a 4.8.1 compiler and &quot;gcc -dumpspecs&quot; should contain references to the msvcrXXX you want to link with.</p>
<h2>Setting up Python</h2>
<p>1- Apply the patches from&#0160;<a href="http://bugs.python.org/issue11723" rel="nofollow">issue 11723</a>&#0160;and&#0160;<a href="http://bugs.python.org/issue4709" rel="nofollow">issue 4709</a>&#0160;to your local 64 bit version of Python27. The patches do not apply cleanly to Python26, so if you really want to build Maya 2013 modules, you will need to apply them manually in a text editor.</p>
<p>2- At the very top of C:/Python27/Lib/distutils/cygwinccompiler.py add stanzas for msvcr100 in the get_msvcr function:</p>
<p><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; elif msc_ver == &#39;1500&#39;:<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; # VS2008 / MSVC 9.0<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; return [&#39;msvcr90&#39;]<br />+&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; elif msc_ver == &#39;1600&#39;:<br />+&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; # VS2010 / MSVC 10.0<br />+&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; return [&#39;msvcr100&#39;]<br />+&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; elif msc_ver == &#39;1700&#39;:<br />+&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; # VS2012 / MSVC 11.0<br />+&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; return [&#39;msvcr110&#39;]<br /></code></p>
<p>3- Generate the python 2.7 linker file in the MSYS command shell. The following lines assumes you have moved the python27.dll to C:\Python27 to prevent conflicts with the Python shipped with Maya.</p>
<pre>&#0160;&#0160;&#0160; $ cd /c/Python27/libs</pre>
<pre>&#0160;&#0160; &#0160;$ gendef ../python27.dll</pre>
<pre>&#0160;&#0160; &#0160;$ dlltool -D ../python27.dll -d python27.def -l libpython27.a</pre>
<pre>&#0160;&#0160; &#0160;$ cp python27.def libpython27.a ../Lib</pre>
<p>4- Add Python27 to the MSYS shell path</p>
<h2 id="CompilingNumPyandSciPyformaya-BuildingNumPy:">Building NumPy:</h2>
<p>There are many options for the solver, each with some gains and some difficulties. The BLAS/LAPACK combo is the easiest to integrate, but offers the least performance. Using highly optimized libraries like ATLAS or OpenBLAS is recommended, but a lot harder to maintain, especially if you want to target machines with varying SSE support and CPU chips.</p>
<p>1- Build BLAS and LAPACK as described&#0160;<a href="http://stackoverflow.com/questions/7496547/python-scipy-needs-blas" rel="nofollow">here</a>:<br />&#0160;&#0160;&#0160; In a MSYS shell:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd ~/builds</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ wget&#0160;<a href="http://www.netlib.org/blas/blas.tgz" rel="nofollow">http://www.netlib.org/blas/blas.tgz</a>&#0160;</code><br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ tar -xzf blas.tgz</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd BLAS</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ x86_64-w64-mingw32-gfortran.exe -O3 -std=legacy -m64 -fno-second-underscore -fPIC -c *.f</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ ar r libfblas.a *.o</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ ranlib libfblas.a</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ rm -rf *.o</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ export BLAS=~/builds/BLAS/libfblas.a</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd ..</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ wget&#0160;<a href="http://www.netlib.org/lapack/lapack.tgz" rel="nofollow">http://www.netlib.org/lapack/lapack.tgz</a>&#0160;</code><br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ tar -xzf lapack.tgz</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd lapack-3.4.2/</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cp INSTALL/make.inc.gfortran make.inc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ make lapacklib</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ make clean</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd ..</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ mv lapack-3.4.2/ LAPACK</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ export LAPACK=~/builds/LAPACK/liblapack.a</code>&#0160;<br /><br />2- Build the numpy module:<br />&#0160;&#0160;&#0160; - Download numpy-1.7.1.tar.gz and unpack.<br />&#0160;&#0160;&#0160; - Remove any code that appends -mno-cygwin to any compiler tool in the following files:<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; numpy/distutils/fcompiler/gnu.py<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; numpy/distutils/mingw32ccompiler.py<br />&#0160;&#0160; &#0160;c:\Python27\Lib\distutils\cygwincompiler.py<br />&#0160;&#0160;&#0160; - Replace the following line in numpy/distutils/fcompiler/gnu.py<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160; &#0160;raise NotImplementedError(&quot;Only MS compiler supported with gfortran on win64&quot;)</code>&#0160;<br />&#0160;&#0160; &#0160;&#0160;&#0160;&#0160; with<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160; &#0160;pass</code>&#0160;<br />&#0160;&#0160;&#0160; - Add this code at the top of numpy/__init__.py to augment the PATH to find the mingw-w64 DLLs:<br /><code>&#0160;&#0160; &#0160;# Numpy-Mingw-w64: prepend the path of the Mingw DLLs to os.environ[&#39;PATH&#39;]</code>&#0160;<br /><code>&#0160;&#0160; &#0160;def _add2path():</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160;&#0160; import os</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160;&#0160; if os.name != &#39;nt&#39;:</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160; &#0160;return</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160;&#0160; try:</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160; &#0160;path = os.path.join(os.path.abspath(os.path.dirname(__file__)), &#39;core&#39;)</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160; &#0160;if path not in os.environ.get(&#39;PATH&#39;, &#39;&#39;):</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160; &#0160;&#0160;&#0160;&#0160; os.environ[&#39;PATH&#39;] = os.pathsep.join((path, os.environ.get(&#39;PATH&#39;, &#39;&#39;)))</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160;&#0160; except Exception:</code>&#0160;<br /><code>&#0160;&#0160; &#0160;&#0160;&#0160; &#0160;pass</code>&#0160;<br /><br /><code>&#0160;&#0160; &#0160;_add2path()</code>&#0160;<br /><code>&#0160;&#0160; &#0160;del _add2path</code>&#0160;<br />&#0160;&#0160;&#0160; - Build the module with:&#0160;&#0160; &#0160;<br /><code>&#0160;&#0160;&#0160; $ python setup.py build</code>&#0160;<br /><br />3a - Install the numpy module:<br />&#0160;&#0160;&#0160; In the numpy build folder:<br /><code>&#0160;&#0160;&#0160; $ python setup.py install --prefix %MAYA_PATH%/Python</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp /mingw/bin/libgfortran-3.dll&#0160;<code>%MAYA_PATH%/Python/Lib/site-packages/numpy/core</code><br />&#0160;&#0160;&#0160; $&#0160;<code>cp&#0160;</code>/mingw/bin/libquadmath-0.dll&#0160;<code>%MAYA_PATH%/Python/Lib/site-packages/numpy/core</code>&#0160;<br />&#0160;&#0160;&#0160; $&#0160;<code>cp&#0160;</code>/mingw/bin/libgcc_s_sjlj-1.dll&#0160;<code>%MAYA_PATH%/Python/Lib/site-packages/numpy/core</code>&#0160;<br />&#0160;&#0160;&#0160; $&#0160;<code>cp&#0160;</code>/mingw/bin/libwinpthread-1.dll %MAYA_PATH%/Python/Lib/site-packages/numpy/core</code>&#0160;<br /><br />3b - Produce a package to install (containing all extra DLLs)<br />&#0160;&#0160;&#0160; In the numpy build folder:<br /><code>&#0160;&#0160;&#0160; $ python setup.py bdist</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cd dist</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ unzip numpy-1.7.1.win-amd64.zip</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp /mingw/bin/libgfortran-3.dll&#0160;<code><code>Python27/Lib/site-packages/numpy/core</code></code><br />&#0160;&#0160;&#0160; $&#0160;<code>cp&#0160;</code>/mingw/bin/libquadmath-0.dll&#0160;<code><code>Python27/Lib/site-packages/numpy/core</code></code><br />&#0160;&#0160;&#0160; $&#0160;<code>cp&#0160;</code>/mingw/bin/libgcc_s_sjlj-1.dll<code>&#0160;Python27/Lib/site-packages/numpy/core</code><br />&#0160;&#0160;&#0160; $&#0160;<code>cp&#0160;</code>/mingw/bin/libwinpthread-1.dll Python27/Lib/site-packages/numpy/core</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ mv Python27 Python</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ zip -r9 numpy-1.7.1.Maya2014.win-amd64.zip Python</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ rm -rf Python</code>&#0160;<br />&#0160;&#0160;&#0160; This file can be directly extracted in %MAYA_PATH%&#0160;<br /><br />4- Test in Maya:<br />&#0160;&#0160;&#0160; Download&#0160;<a href="http://peak.telecommunity.com/dist/ez_setup.py" rel="nofollow">http://peak.telecommunity.com/dist/ez_setup.py</a>&#0160;<br />&#0160;&#0160;&#0160; Download&#0160;<a href="https://raw.github.com/pypa/pip/master/contrib/get-pip.py" rel="nofollow">https://raw.github.com/pypa/pip/master/contrib/get-pip.py</a>&#0160;<br />&#0160;&#0160;&#0160; In a regular command shell:<br /><code>&#0160;&#0160;&#0160; &gt; cd %MAYA_PATH%\bin</code>&#0160;<br /><code>&#0160;&#0160;&#0160; &gt; mayapy ez_setup.py</code>&#0160;<br /><code>&#0160;&#0160;&#0160; &gt; mayapy get-pip.py</code>&#0160;<br /><code>&#0160;&#0160;&#0160; &gt; ..\Python\Scripts\pip.exe install nose</code>&#0160;<br /><code>&#0160;&#0160;&#0160; &gt; mayapy</code>&#0160;<br /><code>&#0160;&#0160;&#0160; &gt;&gt;&gt; import numpy</code>&#0160;<br /><code>&#0160;&#0160;&#0160; &gt;&gt;&gt; numpy.test() # requires the nose package</code>&#0160;<br /><code>&#0160;&#0160;&#0160; &gt;&gt;&gt; numpy.show_config()</code></p>
<h2>Building the SciPy module:</h2>
<p>0- Build numpy<br /><br />1- Set the environment:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ export PATH=$PATH:/c/Python27</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ export BLAS=~/builds/BLAS/libfblas.a</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ export LAPACK=~/builds/LAPACK/liblapack.a</code>&#0160;<br /><br />2- Make the numpy module available either by installing it, or by adding it to PYTHONPATH<br /><br />3- Fix mingw-w64 issues in the SciPy package:<br />&#0160;&#0160;&#0160;&#0160;&#0160; - Patch scipy/spatial/qhull/src/mem.h to have a proper 64 bit int64 typedef for ptr_intT:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #if defined(__MINGW64__)<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; typedef __int64 ptr_intT;<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #else<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #if _MSC_VER &amp;&amp; defined(_WIN64)<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; typedef long long ptr_intT;<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #else<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; typedef long ptr_intT;<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #endif<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #endif<br /></code>- Add this code at the top of scipy/__init__.py to augment the PATH to find the mingw-w64 DLLs:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160; # Scipy-Mingw-w64: prepend the path of the Mingw DLLs to os.environ[&#39;PATH&#39;]</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160; def _add2path():</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160;&#0160;&#0160;&#0160;&#0160; import os</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;</code>if os.name != &#39;nt&#39;:</code>&#0160;<br /><code><code>&#0160;&#0160;&#0160;&#0160;</code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;</code>return</code>&#0160;<br /><code><code>&#0160;&#0160;&#0160;&#0160;</code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160; try:</code>&#0160;<br /><code><code>&#0160;&#0160;&#0160;&#0160;</code>&#0160;&#0160;&#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;</code>&#0160; &#0160;&#0160; path = os.path.join(os.path.abspath(os.path.dirname(__file__)), &#39;misc&#39;)</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;</code>&#0160; &#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;&#0160;</code>if path not in os.environ.get(&#39;PATH&#39;, &#39;&#39;):</code>&#0160;<br /><code><code>&#0160;&#0160;&#0160;&#0160;</code>&#0160;&#0160;&#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;</code><code>&#0160;&#0160;&#0160;&#0160;</code>&#0160; &#0160;&#0160; os.environ[&#39;PATH&#39;] = os.pathsep.join((path, os.environ.get(&#39;PATH&#39;, &#39;&#39;)))</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;</code>&#0160; &#0160;&#0160; except Exception:</code>&#0160;<br /><code><code>&#0160;&#0160;&#0160;&#0160;</code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160;<code>&#0160;&#0160;&#0160;&#0160;&#0160;</code>pass</code>&#0160;<br /><br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160; _add2path()</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;&#0160; del _add2path</code>&#0160;<br /><br />4- Build:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ python setup.py bdist</code>&#0160;<br /><br />5a - Install the scipy module:<br />&#0160;&#0160;&#0160;&#0160;&#0160; In the scipy build folder:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ python setup.py install --prefix %MAYA_PATH%/Python</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libgfortran-3.dll %MAYA_PATH%/Python/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libquadmath-0.dll %MAYA_PATH%/Python/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libgcc_s_sjlj-1.dll %MAYA_PATH%/Python/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libwinpthread-1.dll %MAYA_PATH%/Python/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libstdc++-6.dll %MAYA_PATH%/Python/Lib/site-packages/scipy/misc</code>&#0160;<br /><br />5b - Produce a package to install (containing all extra DLLs)<br />&#0160;&#0160;&#0160;&#0160;&#0160; In the scipy build folder:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ python setup.py bdist</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cd dist</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ unzip scipy-0.12.0.win-amd64.zip</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libgfortran-3.dll Python27/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libquadmath-0.dll Python27/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libgcc_s_sjlj-1.dll Python27/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libwinpthread-1.dll Python27/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ cp /mingw/bin/libstdc++-6.dll Python27/Lib/site-packages/scipy/misc</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ mv Python27 Python</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ zip -r9 scipy-0.12.0.Maya2014.win-amd64.zip Python</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160; $ rm -rf Python</code>&#0160;<br />&#0160;&#0160;&#0160;&#0160;&#0160; This file can be directly extracted in %MAYA_PATH%</p>
<h2 id="CompilingNumPyandSciPyformaya-Buildingamingw-w64toolchainthatlinkstoproperMSruntimelibraries:">Building a mingw-w64 toolchain that links to proper MS runtime libraries:</h2>
<p>1- Download the&#0160;<a href="http://sourceforge.net/projects/mingwbuilds/files/external-binary-packages/msys%2B7za%2Bwget%2Bsvn%2Bgit%2Bmercurial%2Bcvs-rev13.7z/download" rel="nofollow">heavyweight MSYS</a>&#0160;package with Git and Subversion support and extract it to you toolchain folder (C:\mingw_tc).<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; This is the a unixish environnmet that allows configure scripts to run<br /><br />2- Install the niXman build scripts:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd ~</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ git clone&#0160;<a href="https://github.com/niXman/mingw-builds.git" rel="nofollow">https://github.com/niXman/mingw-builds.git</a>&#0160;</code><br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd ~/mingw-builds</code>&#0160;<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;<br />3- Create mingw environment that links exclusively to msvcr100.dll:<br />&#0160;&#0160;&#0160;&#0160; This&#0160;<a href="http://sourceforge.net/mailarchive/message.php?msg_id=30556805" rel="nofollow">post&#0160;</a>is where I got the starting point for this project.<br />&#0160;&#0160;&#0160;&#0160; We need to build a mingw-w64 environment that runs from the ground up with msvcr100.dll. If you are building<br />&#0160;&#0160;&#0160;&#0160; from a pristine Win7 environment, you will need to at least download the &quot;Windows 7 Platform SDK&quot; to get this<br />&#0160;&#0160;&#0160;&#0160; DLL installed.<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd ~</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ git clone</code>&#0160;<a href="https://github.com/niXman/mingw-builds.git" rel="nofollow">https://github.com/niXman/mingw-builds.git</a>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ cd ~/mingw-builds</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; $ ./build gcc-4.8.1 x64 --download --no-multilib</code>&#0160;<br />&#0160;&#0160;&#0160;&#0160; This will download the required tools and sources to build the compiler. There were a few stale URL last time I tried, but they were easy to fix in mingw-build/scripts<br />&#0160;<br />&#0160;&#0160;&#0160; You will need then to apply the&#0160;<a href="https://wiki.autodesk.com/download/attachments/135930422/VS2010.patch?version=1&amp;modificationDate=1380054444000&amp;api=v2">provided patch</a>&#0160;that makes sure the new compiler is tied to msvcr100.dll<br />&#0160;&#0160;<br />&#0160;&#0160;&#0160; Then you need to generate temporary versions of libmoldname100.a for the build to succeed:<br /><code>&#0160;&#0160;&#0160; $ cd ~/mingw-builds/toolchains/mingw64/x86_64-w64-mingw32/lib</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ ../../bin/dlltool.exe -d ~/src/mingw-w64-crt/lib64/moldname-msvcrt.def -U --dllname msvcr100.dll -l libmoldname100.a -k --as=/home/jgamache/mingw-builds/toolchains/mingw64/bin/as.exe --as-flags=--64 -m</code>&#0160;<a href="http://i386x86-64/" rel="nofollow">i386:x86-64</a>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cd ../lib32</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ ../../bin/dlltool.exe -d ~/src/mingw-w64-crt/lib64/moldname-msvcrt.def -U --dllname msvcr100.dll -l libmoldname100.a -k --as=/home/jgamache/mingw-builds/toolchains/mingw64/bin/as.exe --as-flags=--32 -m i386</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cd ~/mingw-builds</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ ./build gcc-4.8.1 x64 --no-multilib</code>&#0160;<br />&#0160;<br />&#0160;&#0160;&#0160; Build&#0160;<strong>until the mingw-w64-crt steps completes</strong>&#0160;and then interrupt the build. You will need to copy the updated libmsvcr100.a to the bootstrapping toolchain to be sure everything was properly linked.<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-runtime/x64-mingw-w64-nomulti/lib/libmsvcr100.a ~/mingw-builds/toolchains/mingw32/i686-w64-mingw32/lib/libmsvcr100.a</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-runtime/x64-mingw-w64-nomulti/lib/libmsvcr100.a ~/mingw-builds/toolchains/mingw32/i686-w64-mingw32/lib64/libmsvcr100.a</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-runtime/x64-mingw-w64-nomulti/lib/libmsvcr100.a ~/mingw-builds/toolchains/mingw64/x86_64-w64-mingw32/lib/libmsvcr100.a</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-runtime/x64-mingw-w64-nomulti/lib/libmsvcr100.a ~/mingw-builds/toolchains/mingw64/x86_64-w64-mingw32/lib32/libmsvcr100.a</code>&#0160;<br /><br />&#0160;&#0160;&#0160; Restart the build with the updated toolchain:<br /><code>&#0160;&#0160;&#0160; $ rm -rf prereq-* mingw-prereq mingw-runtime x64-481-posix-sjlj</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cd ~/mingw-builds</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ ./build gcc-4.8.1 x64 --no-multilib</code>&#0160;<br /><br />&#0160;&#0160;&#0160; The build will stop itself with an error in the middle of building GCC with a missing libmoldname100.a error. Copy the previously generated lib:<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-builds/toolchains/mingw64/x86_64-w64-mingw32/lib/libmoldname100.a ~/mingw-runtime/x64-mingw-w64-nomulti/lib</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-builds/toolchains/mingw64/x86_64-w64-mingw32/lib/libmoldname100.a ~/prereq-build/x64-mingw-w64-crt-nomulti/lib64/</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-builds/toolchains/mingw64/x86_64-w64-mingw32/lib/libmoldname100.a ~/x64-481-posix-sjlj/mingw64/mingw/lib/</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ cp ~/mingw-builds/toolchains/mingw64/x86_64-w64-mingw32/lib/libmoldname100.a ~/x64-481-posix-sjlj/mingw64/x86_64-w64-mingw32/lib/</code>&#0160;<br /><code>&#0160;&#0160;&#0160; $ ./build gcc-4.8.1 x64 --no-multilib</code>&#0160;<br /><br />&#0160;&#0160;&#0160; Sit back and let the toolchain build complete. The results will be in ~/x64-481-posix-sjlj/mingw64.&#0160;<br /><br />&#0160;&#0160;&#0160; modify headers that breaks in multiple compilations:<br />&#0160;&#0160;&#0160; - in ~/x64-481-posix-sjlj/mingw64/x86_64-w64-mingw32/include/basetsd.h the typedefs for INT8/UINT8 up to INT64/UINT64 need to be protected against macros of the same names:<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #if !defined(INT8)</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; typedef signed char INT8,*PINT8;</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #endif</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #if !defined(INT16)</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; typedef signed short INT16,*PINT16;</code>&#0160;<br /><code>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; #endif</code>&#0160;<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ... and so on for the whole block where the integer types are defined.<br />&#0160;&#0160;&#0160; - in ~/x64-481-posix-sjlj/mingw64/x86_64-w64-mingw32/include/getopt.h<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Remove the &quot;#ifdef _BSD_SOURCE&quot; that prevents the &quot;extern int optreset&quot; from being visible when compiling xz<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; &#0160;<br />&#0160;&#0160;&#0160; You can now take the whole contents of ~/x64-481-posix-sjlj/mingw64 and package that as a toolchain to be used for building Python libraries.<br />&#0160;&#0160; &#0160;<br />If you encounter any issues, I strongly recommend having an unmodified build as reference to diff the log files. This will catch any cases where the modified compiler behaves differently from the reference one.</p>
<p>&#0160;</p>
