---
layout: "post"
title: "Improve performance with MPxNode::preEvaluation &amp; MPxNode::postEvaluation"
date: "2017-05-01 11:43:00"
author: "Zhong Wu"
categories:
  - "Animation"
  - "Autodesk"
  - "C++"
  - "Maya"
  - "Zhong Wu"
original_url: "https://around-the-corner.typepad.com/adn/2017/05/improve-performance-with-mpxnodepreevaluation-mpxnodepostevaluation.html "
typepad_basename: "improve-performance-with-mpxnodepreevaluation-mpxnodepostevaluation"
typepad_status: "Publish"
---

<p>With last <a href="http://around-the-corner.typepad.com/adn/2017/03/suggestions-best-practices-while-migrating-your-plugin-to-parallel-evaluation.html">post </a>we talked about the Best practices while migrating your plugin to Parallel Evaluation, in this post, we will talk about the following 2 new methods, and how to make use of them to improve the performance:  </p> <ul> <strong> <li>MPxNode::preEvaluation </li>     <li>MPxNode::postEvaluation </li></strong> </ul> <p> Within the old DG system, because MPxNode::setDependentsDirty function is called during dirty propagation, it can be used to manage attribute dirtying, and sometimes, we can cache the computed data in this method to avoid expensive calculations in MPxNode::compute. Letâ€™s take the sample plugin simpleEvaluationNode as an example:  </p>   <p>Every time when the input and aTimeInput got dirty, set cachedValueIsValid to false to make it be re-calculated.   </p>  <div style="font-size: 10pt; border-top: #000080 1px solid; font-family: verdana, tahoma, arial, sans-serif; border-right: #000080 1px solid; background: #000080; border-bottom: #000080 1px solid; font-weight: bold; color: #fff; padding-bottom: 2px; padding-top: 2px; padding-left: 5px; border-left: #000080 1px solid; padding-right: 5px">Code Snippet</div>  <div style="font-size: 10pt; border-top: #000080 1px solid; font-family: &#39;Courier New&#39;, courier, monospace; border-right: #000080 1px solid; border-bottom: #000080 1px solid; color: #000; border-left: #000080 1px solid">   <div style="overflow: auto; background: #ddd; max-height: 300px">     <ol style="background: #ffffff; padding-bottom: 0px; padding-top: 0px; padding-left: 5px; margin: 0px 0px 0px 2em; padding-right: 0px">       <li><span style="background: #ffffff; color: #000000">MStatus simpleEvaluationNode::setDependentsDirty( </span><span style="background: #ffffff; color: #0000ff">const</span><span style="background: #ffffff; color: #000000"> MPlug&amp;</span><span style="background: #ffffff; color: #0000ff">amp</span><span style="background: #ffffff; color: #000000">; plug, MPlugArray&amp;</span><span style="background: #ffffff; color: #0000ff">amp</span><span style="background: #ffffff; color: #000000">; plugArray)</span> </li>        <li style="background: #f3f3f3"><span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000"> (plug == input || plug == aTimeInput )</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">cachedValueIsValid = </span><span style="background: #ffffff; color: #0000ff">false</span><span style="background: #ffffff; color: #000000">;</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">return</span><span style="background: #ffffff; color: #000000"> MPxNode::setDependentsDirty(plug, plugArray);</span> </li>        <li style="background: #f3f3f3"><span style="background: #ffffff; color: #000000">}</span> </li>     </ol>   </div> </div>  <p>Within compute() method, only do the expensive calculation when cachedValueIsValid is false.  </p>  <div style="font-size: 10pt; border-top: #000080 1px solid; font-family: &#39;Courier New&#39;, courier, monospace; border-right: #000080 1px solid; border-bottom: #000080 1px solid; color: #000; border-left: #000080 1px solid">   <div style="font-family: verdana, tahoma, arial, sans-serif; background: #000080; font-weight: bold; color: #fff; padding-bottom: 2px; padding-top: 2px; padding-left: 5px; padding-right: 5px">Code Snippet</div>    <div style="overflow: auto; background: #ddd; max-height: 300px">     <ol style="background: #ffffff; padding-bottom: 0px; padding-top: 0px; padding-left: 5px; margin: 0px 0px 0px 2.5em; padding-right: 0px">       <li><span style="background: #ffffff; color: #000000">MStatus simpleEvaluationNode::compute( </span><span style="background: #ffffff; color: #0000ff">const</span><span style="background: #ffffff; color: #000000"> MPlug&amp;</span><span style="background: #ffffff; color: #0000ff">amp</span><span style="background: #ffffff; color: #000000">; plug, MDataBlock&amp;</span><span style="background: #ffffff; color: #0000ff">amp</span><span style="background: #ffffff; color: #000000">; data )</span> </li>        <li style="background: #f3f3f3"><span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160; </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000">( plug == output )</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{&#160; </span></li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">... ...</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000"> ( ! cachedValueIsValid )</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MTime time = inputTimeData.asTime();</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">cachedValue = doExpensiveCalculation( inputData.asFloat() , (</span><span style="background: #ffffff; color: #0000ff">float</span><span style="background: #ffffff; color: #000000">) time.value() );</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">cachedValueIsValid = </span><span style="background: #ffffff; color: #0000ff">true</span><span style="background: #ffffff; color: #000000">;</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MDataHandle outputHandle = data.outputValue( simpleEvaluationNode::output );</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">outputHandle.set( cachedValue );</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">data.setClean(plug);</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li>&#160; </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">return</span><span style="background: #ffffff; color: #000000"> MS::kSuccess;</span> </li>        <li><span style="background: #ffffff; color: #000000">}</span> </li>     </ol>   </div> </div>  <p>This works well within old DG, but the EM evaluation does not propagate dirty messages, the cached data in MPxNode::setDependentsDirty will no longer applies during EM evaluating. So how to do the same thing with EM? One of the solution is MPxNode::preEvaluation.  </p> <p>As discussed previously, once the EG has been built, dirty propagation is disabled and the EG is re-used. Therefore, any custom logic in your plug-in that depends on setDependentsDirty no longer applies. MPxNode::preEvaluation allows your plug-in to determine which plugs/attributes are dirty and if any action is needed, you can use the new MEvaluationNode class to determine what has been dirtied.   </p>  <div style="font-size: 10pt; border-top: #000080 1px solid; font-family: &#39;Courier New&#39;, courier, monospace; border-right: #000080 1px solid; border-bottom: #000080 1px solid; color: #000; border-left: #000080 1px solid">   <div style="font-family: verdana, tahoma, arial, sans-serif; background: #000080; font-weight: bold; color: #fff; padding-bottom: 2px; padding-top: 2px; padding-left: 5px; padding-right: 5px">Code Snippet</div>    <div style="overflow: auto; background: #ddd; max-height: 300px">     <ol style="background: #ffffff; padding-bottom: 0px; padding-top: 0px; padding-left: 5px; margin: 0px 0px 0px 2.5em; padding-right: 0px">       <li>&#160; <span style="background: #ffffff; color: #000000">MStatus simpleEvaluationNode::preEvaluation( </span><span style="background: #ffffff; color: #0000ff">const</span><span style="background: #ffffff; color: #000000">MDGContext&amp; context, </span><span style="background: #ffffff; color: #0000ff">const</span><span style="background: #ffffff; color: #000000"> MEvaluationNode&amp; evaluationNode )</span> </li>        <li style="background: #f3f3f3"><span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MStatus status;</span> </li>        <li style="background: #f3f3f3">&#160; </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #008000">// we use m_CachedValueIsValid only for normal context</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000">( !context.isNormal() ) </span></li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">return</span><span style="background: #ffffff; color: #000000"> MStatus::kFailure;</span> </li>        <li style="background: #f3f3f3">&#160; </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000">( ( evaluationNode.dirtyPlugExists(input, &amp;status) &amp;&amp; status ) || </span></li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">( evaluationNode.dirtyPlugExists(aTimeInput, &amp;status) &amp;&amp; status ) )</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">cachedValueIsValid = </span><span style="background: #ffffff; color: #0000ff">false</span><span style="background: #ffffff; color: #000000">;</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">return</span><span style="background: #ffffff; color: #000000"> MS::kSuccess;</span> </li>        <li><span style="background: #ffffff; color: #000000">}</span> </li>     </ol>   </div> </div>  <br />If you want to check the whole project, please look at <strong>simpleEvaluationNode</strong> sample under devkit.   <p>Another new method, MPxNode::postEvaluation, is called once all computations have been performed on a specific node instance. Since this method is called from a worker thread, it performs calculations for downstream graph operations without blocking other Maya processing tasks of non-dependent nodes.  </p> <p>Within the <a href="http://help.autodesk.com/view/MAYAUL/2017/ENU/?guid=__cpp_ref_simple_evaluation_draw_2simple_evaluation_draw_8cpp_example_html">simpleEvaluationDraw</a> devkit example, we can use postEvaluation method to performance heavy calculations for rendering, if this plugin is running in regular evaluation, Maya will slow down because evaluation is blocked whenever expensive calculations in postEvaluation are performed. But if you run it in Parallel Evaluation Mode, a worker thread calls the postEvaluation method and prepares data for subsequent drawing operations, so it will be much faster than in regular DG evaluation, and when testing, you will see higher frame rates in Parallel evaluation versus regular or serial evaluation. But please make sure that code in postEvaluation should be thread-safe.   </p>  <div style="font-size: 10pt; border-top: #000080 1px solid; font-family: &#39;Courier New&#39;, courier, monospace; border-right: #000080 1px solid; border-bottom: #000080 1px solid; color: #000; border-left: #000080 1px solid">   <div style="font-family: verdana, tahoma, arial, sans-serif; background: #000080; font-weight: bold; color: #fff; padding-bottom: 2px; padding-top: 2px; padding-left: 5px; padding-right: 5px">Code Snippet</div>    <div style="overflow: auto; background: #ddd; max-height: 300px">     <ol style="background: #ffffff; padding-bottom: 0px; padding-top: 0px; padding-left: 5px; margin: 0px 0px 0px 2.5em; padding-right: 0px">       <li>&#160; <span style="background: #ffffff; color: #000000">MStatus simpleEvaluationDraw::postEvaluation( </span><span style="background: #ffffff; color: #0000ff">const</span><span style="background: #ffffff; color: #000000">MDGContext&amp; context, </span><span style="background: #ffffff; color: #0000ff">const</span><span style="background: #ffffff; color: #000000"> MEvaluationNode&amp; evaluationNode, PostEvaluationType evalType )</span> </li>        <li style="background: #f3f3f3"><span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000">( !context.isNormal() ) </span></li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">return</span><span style="background: #ffffff; color: #000000"> MStatus::kFailure;</span> </li>        <li>&#160; </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MStatus status;</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000">(evalType == kLeaveDirty)</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">scaleUpToDate = </span><span style="background: #ffffff; color: #0000ff">false</span><span style="background: #ffffff; color: #000000">;</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">else</span><span style="background: #ffffff; color: #000000"> </span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000"> ( (evaluationNode.dirtyPlugExists(aCopies, &amp;status) &amp;&amp; status ) || </span></li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">( evaluationNode.dirtyPlugExists(aTimeInput, &amp;status) &amp;&amp; status ) )</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MDataBlock block = forceCache();</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MDataHandle inputTimeData = block.inputValue( aTimeInput, &amp;status );</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000"> ( status )</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MDataHandle copiesData = block.inputValue( aCopies, &amp;status );</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000"> ( status )</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #008000">// A made up calculation to slow down processing</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #008000">//</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">MTime time = inputTimeData.asTime();</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">int</span><span style="background: #ffffff; color: #000000"> copies = copiesData.asInt();</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">double</span><span style="background: #ffffff; color: #000000"> t = time.value();</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">if</span><span style="background: #ffffff; color: #000000"> ( ! scaleUpToDate )</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">{</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">scaleXBy = doExpensiveCalculation( copies, t );</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #008000">// Mark the scale as up to date so that draw does not</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #008000">// have to recompute it</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">scaleUpToDate = </span><span style="background: #ffffff; color: #0000ff">true</span><span style="background: #ffffff; color: #000000">;</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li>&#160;&#160;&#160; <span style="background: #ffffff; color: #000000">}</span> </li>        <li style="background: #f3f3f3">&#160;&#160;&#160; <span style="background: #ffffff; color: #000000"></span><span style="background: #ffffff; color: #0000ff">return</span><span style="background: #ffffff; color: #000000"> MStatus::kSuccess;</span> </li>        <li><span style="background: #ffffff; color: #000000">}</span> </li>     </ol>   </div> </div>  <p>Please also check the <a href="http://help.autodesk.com/view/MAYAUL/2017/ENU/?guid=__cpp_ref_simple_evaluation_draw_2simple_evaluation_draw_8cpp_example_html">simpleEvaluationDraw</a> devkit example for the whole project.   </p>
