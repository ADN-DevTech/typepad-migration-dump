---
layout: "post"
title: "Visual Basic 6 Add-Ins and 64-Bit"
date: "2009-10-01 19:39:05"
author: "Adam Nagy"
categories:
  - "Add-In Creation"
  - "Brian"
original_url: "https://modthemachine.typepad.com/my_weblog/2009/10/visual-basic-6-add-ins-and-64-bit.html "
typepad_basename: "visual-basic-6-add-ins-and-64-bit"
typepad_status: "Publish"
---

<p>I saw a question in the customization newsgroup where someone has an Add-In written using Visual Basic 6 and wants to use that add-in with the 64-bit version of Inventor.&#160; In doing this there are some issues to be aware of:</p>  <ul>   <li>64-bit Windows can run both 32-bit and 64-bit applications (exe’s and dll’s). </li>    <li>Visual Basic 6 can only create 32-bit applications (exe’s and dll’s). </li>    <li>A 64-bit exe can only load 64-bit dll’s.&#160; It cannot use 32-bit dll’s. </li> </ul>  <p>In this case, Inventor is a 64-bit exe and the Add-In is a dll.&#160; A VB 6 Add-In will be a 32-bit dll.&#160; Based on the statements above, this means that it can’t be used by 64-bit Inventor since that results in a 64-bit exe trying to load a 32-bit dll.&#160; There are two possible solutions; change the add-in to be an exe instead of a dll or convert the add-in to .Net where you have the ability to create a 64-bit dll.</p>  <p>&#160;</p>  <p><strong>Changing a VB 6 Add-In from a DLL to an EXE</strong>     <br />Changing an existing VB 6 Add-In from a dll to an exe is very easy.&#160; Open the project and use the <strong>Properties</strong> command in the <strong>Project</strong> menu to display the dialog shown below.&#160; Change the project type from “AcitveX DLL” to “ActiveX EXE”.&#160; Recompile and now you have an exe Add-in.&#160; However, continue reading…</p>  <p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc688340120a63d0d93970c-pi"><img title="VB6_DLLtoEXE" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="321" alt="VB6_DLLtoEXE" src="/assets/image_465029.jpg" width="354" border="0" /></a> </p>  <p>There are two things to be aware of when converting a dll Add-In to an exe Add-In.&#160; The first is that the performance of the exe Add-In won’t be as good as the dll Add-In.&#160; A dll Add-In is loaded into Inventor’s process space and API calls are made directly.&#160; An exe Add-In runs in its own process space and is separate from Inventor.&#160; This requires API calls to be <em>marshaled</em> between the two processes which is not as efficient.&#160; How much slower it is will differ from Add-In to Add-In because it depends on what kind of API calls you’re making.</p>  <p>The second issue is more of a problem and is a side-effect of the fact that data has to be marshaled between the two processes.&#160; Inventor’s API relies on Microsoft technology to do the marshaling between the two processes.&#160; Unfortunately, this technology doesn’t support the marshaling of bitmap data.&#160; This means that any Inventor API calls you make where an IPictureDisp object is passed as an argument won’t work with an exe Add-In.&#160; </p>  <p>Their are only a few calls in Inventor’s API that work with bitmaps but one of these is a function that most Add-Ins use.&#160; That’s the AddButtonDefinition method that’s used to create a button for the user-interface.&#160; An exe Add-In won’t be able to have icons on its buttons because of this limitation.&#160; Icons are optional so you can remove those arguments from the AddButtonDefinition call and then the Add-In should function correctly but you’ll only have text on the button instead of an icon.</p>  <p>Another area of the API where a bitmap is used is when getting or setting the thumbnail image for a document.&#160; This will fail for an exe Add-In.</p>  <p>Using the VB6 version of the SimpleAddIn sample that’s delivered as part of Inventor’s SDK, here are the changes that are required to make it work on 64-bit Windows.</p>  <ol>   <li>Change the project type to ActiveX EXE, as explained above.      <br /></li>    <li>Comment out the lines that load the bitmaps for the icons.      <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">       <p>Dim oIcon1 As IPictureDisp          <br /><font color="#0000ff"><strong>'&#160;&#160;&#160; Dim oIcon2 As IPictureDisp              <br />'&#160;&#160;&#160; Dim oIcon3 As IPictureDisp               <br />'&#160;&#160;&#160; Set oIcon1 = LoadPicture(App.Path &amp; &quot;\AddSlotOption.ico&quot;)               <br />'&#160;&#160;&#160; Set oIcon2 = LoadPicture(App.Path &amp; &quot;\Slot.ico&quot;)               <br />'&#160;&#160;&#160; Set oIcon3 = LoadPicture(App.Path &amp; &quot;\Toggle.ico&quot;)               <br /></strong></font></p>     </div>      <p><font color="#0000ff"><strong></strong></font></p>   </li>    <li>Edit the lines where the buttons are created to remove the icons.&#160; The following three lines (please pay attention to the line wrapping) are changed from this:      <p></p>      <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">Set oButtonDefAddOption = ..., &quot;Add slot option&quot;, oIcon1, oIcon1)        <br />Set oButtonDefDrawSlot = ... , &quot;Draw Slot&quot;, oIcon2, oIcon2)         <br />Set oButtonDefToggleSlotState = ..., &quot;Toggle Slot State&quot;, oIcon3, oIcon3) </div>      <p></p>      <p>to this:</p>      <p></p>      <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">Set oButtonDefAddOption = ..., &quot;Add slot option&quot;)&#160;&#160; <br />Set oButtonDefDrawSlot = ... , &quot;Draw Slot&quot;)&#160; <br />Set oButtonDefToggleSlotState = ..., &quot;Toggle Slot State&quot;)</div>      <p></p>      <p>This is possible because the icon arguments are optional.</p>   </li>    <li>Compile the Add-In to create the EXE version of it and run the the registration file to register it, (AddInSample.reg in the case of the example Add-In).      <br /></li>    <li>Run Inventor to make sure the Add-In is loading and working correctly on a 32-bit system.      <br />      <br />The tricky part now is getting this Add-In to register correctly on a 64-bit system.&#160; Since it’s a 32-bit application, by default it will register itself in the 32-bit section of the registry on a 64-bit system, but Inventor will only look for Add-Ins in the main section of the registry, which is the 64-bit section in this case.&#160; The following steps illustrate one way to get the registration in the correct area on the 64-bit system.       <br /></li>    <li>Find out the CLSID for your Add-In.&#160; There are two ways to find this out.&#160; If you’re already using a .reg file to register your Add-In, it will be in that.&#160; Here’s the second line from the AddInSample.reg file that’s part of the sample.      <p><font face="Arial Narrow">[HKEY_CLASSES_ROOT\CLSID\{DB59D9A7-EE4C-434A-BB5A-F93E8866E872}]</font></p>      <p>The “{DB59D9A7-EE4C-434A-BB5A-F93E8866E872}” portion of the line is the CLSID of the Add-In.&#160; Just remembering the first 3 or 4 characters is enough for what you need to do in the subsequent steps.</p>      <p>The other way to find out the CLSID is to look it up in the registry.&#160; First, you need to know what to look up.&#160; You can use the ProgID of your Add-In.&#160; This is determined by the name of your project and the name of the class that supports the Add-In interface.&#160; You can see these in the Properties window inside Visual Basic.&#160; In this case the ProgID of the Add-In will be “AddInSample.clsSampleAddIn”.</p>      <p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc688340120a5e697fb970b-pi"><img title="AddInName" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="137" alt="AddInName" src="/assets/image_45942.jpg" width="290" border="0" /></a> </p>      <p>Run RegEdit and look in the HKEY_CLASSES_ROOT section for the ProgID of your Add-In.&#160; This is shown below for the sample Add-In.</p>      <p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc688340120a63d0d9a970c-pi"><img title="CLSID_Lookup" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="173" alt="CLSID_Lookup" src="/assets/image_64243.jpg" width="404" border="0" /></a></p>      <p>Once you’ve found the ProgID for the Add-In, expand the key in the registry and then expand the Clsid key and select “Clsid”.&#160; In the right-hand portion of the Registry Editor you’ll see the CLSID of your Add-in.</p>   </li>    <li>Now using the Registry Editor, find the HKEY_CLASSES_ROOT\CLSID section of the registry.&#160; Within this key, find the CLSID for your Add-In.&#160; The picture below shows this key selected in the browser and expanded so you can see its subkeys.&#160; You can verify that you have the correct registry key by checking on the right-hand side of the Registry Editor to see if the ProgID matches the one for your Add-In.<a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc688340120a5e69807970b-pi">        <br />        <br /><img title="Add-InRegKey" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="187" alt="Add-InRegKey" src="/assets/image_923502.jpg" width="404" border="0" /></a>       <br /></li>    <li>Right-click on the CLSID key of your Add-In and choose Export, as shown below.&#160; Specify a name and save the .reg file.      <br /><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc688340120a5e69811970b-pi"><img title="RegistryExport" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="315" alt="RegistryExport" src="/assets/image_906074.jpg" width="346" border="0" /></a>       <br /></li>    <li>Copy the Add-In to the 64-bit system by copying the EXE, the reg file you just created in the previous step, and any other files your Add-in might require.&#160; The SimpleAddIn sample doesn’t need anything except these two files but your Add-In may need some other files.      <br /></li>    <li>Edit the .reg file so that it contains the correct path for your Add-In as it exists on the 64-bit system.&#160; You’ll need to edit one line in the .reg file to correct the path.&#160; The edited portion is highlighted below.&#160; Notice how the backslashes of the actual path are replaced with double back slashes.      <p><font face="Arial Narrow">[HKEY_CLASSES_ROOT\CLSID\{DB59D9A7-…-F93E8866E872}\LocalServer32]          <br />@=&quot;<font color="#0000ff"><strong>C:\\Users\\ekins\\Documents</strong></font>\\AddInSample.exe&quot;</font></p>   </li>    <li>Run the .reg file to register your Add-In.&#160; When you run Inventor, your Add-In should be running and work.&#160; If it isn’t working, check the Add-In Manager to see if your Add-In is in the list.&#160; If it is in the list but isn’t listed as being loaded, then the Add-In is likely failing in the Activate method.&#160; Make sure you removed the icons as instructed above and double-check that you’re not trying to access something that’s not available on the 64-bit machine.      <br />      <br />If your Add-In doesn’t show up at all in the Add-In Manager then go through the directions above and double-check that you didn’t leave out anything.&#160; For your Add-In to not show up at all indicates that it’s not being registered correctly.</li> </ol>  <p><strong>Converting a Visual Basic 6 Add-In to 64-Bit      <br /></strong>Visual Basic 6 is only capable of creating 32-bit applications.&#160; To convert an existing project to a 64-bit application will require porting the application to VB.Net, which does support the creation of a 64-bit application.&#160; VB.Net has a VB 6 conversion tool but I would suggest that you NOT use it.&#160; Instead, I would use the Add-In Wizard that’s delivered as part of Inventor’s SDK to create a new Add-In and copy the code manually from VB 6 into the VB.Net project.&#160; There are too many differences between VB 6 and VB.Net and my experience is that cleaning up the resulting code from the conversion is harder than copying over smaller portions of code at a time an manually converting it.</p>  <p>You’ll also need to recreate your dialogs.&#160; The dialogs are much more powerful in VB.Net so this lets you take advantage of those new features.&#160; The basics of converting your code is covered in this post: <a href="http://modthemachine.typepad.com/my_weblog/2008/10/converting-vba-auto-macros-to-an-add-in.html">Converting VBA Auto Macros to an Add-In</a>.</p>
