---
layout: "post"
title: "Document Thumbnails and Button Icons"
date: "2010-03-04 22:16:46"
author: "Adam Nagy"
categories:
  - "Brian"
original_url: "https://modthemachine.typepad.com/my_weblog/2010/03/document-thumbnails-and-button-icons.html "
typepad_basename: "document-thumbnails-and-button-icons"
typepad_status: "Publish"
---

<p>I had a hard time deciding what to title this post since what I’m actually discussing here isn’t something that someone would likely be searching for.&#0160; The real topic is “Issues When Using the Inventor API Out-of-Process”.&#0160; The typical problems people run into because of out-of-process issues are when working with thumbnail or button images.</p>
<p>First, let’s define what it means to be running in-process versus out-of-process.&#0160; For our purposes, a process is an executable that’s running.&#0160; Inventor is an example of a process.&#0160; A windows executable that you write is also an example of a process.</p>
<p>When Inventor is running there is an Inventor process.&#0160; Add-ins, which are dll’s and not exe’s, are loaded within the Inventor process and are referred to as running in-process.&#0160; VBA is only available from Microsoft as a 32-bit component, so with 32-bit Inventor VBA also runs in-process.&#0160; This is illustrated in the picture below with both VBA and the Add-In running within Inventor’s process.</p>
<p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc6883401310f633990970c-pi"><img alt="InOutProc01" border="0" height="198" src="/assets/image_24504.jpg" style="BORDER-TOP-WIDTH: 0px; DISPLAY: inline; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" title="InOutProc01" width="362" /></a></p>
<p>With 64-bit Inventor, VBA can’t be loaded since a 32-bit component can’t load within a 64-bit process.&#0160; To still allow customers the use of VBA on 64-bit machines, Inventor runs a separate 32-bit process which hosts VBA.&#0160; VBA then talks to Inventor through the API but is running out-of-process with respect to Inventor, as illustrated below.</p>
<p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc6883401310f6339a3970c-pi"><img alt="InOutProc02" border="0" height="148" src="/assets/image_287967.jpg" style="BORDER-TOP-WIDTH: 0px; DISPLAY: inline; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" title="InOutProc02" width="450" /></a> </p>
<p>So what does it matter if VBA is running in or out of Inventor’s process?&#0160; There are a couple of things this affects.&#0160; First, running out-of-process will be slower than in-process.&#0160; There’s more overhead in passing data back and forth between processes.&#0160; Second, is that bitmap data can’t be passed between two processes.&#0160; Inventor uses the Microsoft IPictureDisp object to represent bitmap data and it doesn’t support being passed between processes.</p>
<p>The VBA programs below both get the thumbnail image from the active document.&#0160; One uses the Document.Thumbnail property and the other uses the Thumbnail iProperty.&#0160; Both of them will work in 32-bit Inventor since VBA runs in-process but they will fail for 64-bit Inventor.&#0160; In the SaveThumbnail macro the failure happens when calling the Thumbnail property of the document because that is when the bitmap would be passed.&#0160; For the iProperty example, the failure occurs when calling the Value property of the Property object.&#0160; Any call that passes an IPictureDisp object won’t work when running out-of-process, including getting or setting icons for buttons. </p>
<div style="FONT-SIZE: 8pt; BACKGROUND: #eeeeee; COLOR: black; LINE-HEIGHT: 140%; FONT-FAMILY: courier new">
<p>Public Sub SaveThumbnail() <br /><strong><span style="COLOR: #0000ff; FONT-FAMILY: ">&#0160;&#0160;&#0160; &#39; Get the active document. <br /></span></strong>&#0160;&#0160;&#0160; Dim doc As Document <br />&#0160;&#0160;&#0160; Set doc = ThisApplication.ActiveDocument </p>
<p><strong><span style="COLOR: #0000ff; FONT-FAMILY: ">&#0160;&#0160;&#0160; &#39; Get the thumbnail from the document. <br /></span></strong>&#0160;&#0160;&#0160; Dim thumb As IPictureDisp <br />&#0160;&#0160;&#0160; Set thumb = doc.Thumbnail </p>
<p><span style="COLOR: #0000ff; FONT-FAMILY: "><strong>&#0160;&#0160;&#0160; &#39; Create the filename for the bmp file so it is the same <br />&#0160;&#0160;&#0160; &#39; as the document name but with a &quot;bmp&quot; extension. <br /></strong></span>&#0160;&#0160;&#0160; Dim filename As String <br />&#0160;&#0160;&#0160; filename = Left$(doc.FullFileName, Len(doc.FullFileName)-3)&amp;&quot;bmp&quot; </p>
<p><strong><span style="COLOR: #0000ff; FONT-FAMILY: ">&#0160;&#0160;&#0160; &#39; Save the thumbnail. <br /></span></strong>&#0160;&#0160;&#0160; Call SavePicture(thumb, filename) <br />End Sub </p></div>
<p><br /></p>
<div style="FONT-SIZE: 8pt; BACKGROUND: #eeeeee; COLOR: black; LINE-HEIGHT: 140%; FONT-FAMILY: courier new">
<p>Public Sub SaveThumbnailUsingiProperty() <br /><span style="COLOR: #0000ff; FONT-FAMILY: "><strong>&#0160;&#0160;&#0160; &#39; Get the active document. <br /></strong></span>&#0160;&#0160;&#0160; Dim doc As Document <br />&#0160;&#0160;&#0160; Set doc = ThisApplication.ActiveDocument </p>
<p><span style="COLOR: #0000ff; FONT-FAMILY: "><strong>&#0160;&#0160;&#0160; &#39; Get the thumbnail from the document&#39;s iProperty. <br /></strong></span>&#0160;&#0160;&#0160; Dim oPropSet As PropertySet <br />&#0160;&#0160;&#0160; Set oPropSet = doc.PropertySets.Item( _ <br />									 &quot;Inventor Summary Information&quot;) <br />&#0160;&#0160;&#0160; Dim thumb As IPictureDisp <br />&#0160;&#0160;&#0160; Set thumb = oPropSet.Item(&quot;Thumbnail&quot;).Value </p>
<p><span style="COLOR: #0000ff; FONT-FAMILY: "><strong>&#0160;&#0160;&#0160; &#39; Create the filename for the bmp file so it is the same <br />&#0160;&#0160;&#0160; &#39; as the document name but with a &quot;bmp&quot; extension. <br /></strong></span>&#0160;&#0160;&#0160; Dim filename As String <br />&#0160;&#0160;&#0160; filename = Left$(doc.FullFileName, Len(doc.FullFileName)-3)&amp;&quot;bmp&quot; </p>
<p>&#0160;&#0160;&#0160; &#39; Save the thumbnail. <br />&#0160;&#0160;&#0160; Call SavePicture(thumb, filename) <br />End Sub</p></div>
<br />
<p>Here are some other examples where you can encounter out-of-process issues.&#0160; If you’ve written a windows application it will be a separate exe and will run as a separate process.&#0160; It can still use the Inventor API, but it will be out-of-process and because of this will not be able to access any bitmaps through the API.</p>
<p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc6883401310f6339af970c-pi"><img alt="InOutProc05" border="0" height="150" src="/assets/image_432873.jpg" style="BORDER-TOP-WIDTH: 0px; DISPLAY: inline; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" title="InOutProc05" width="450" /></a>&#0160;</p>
<br />
<p>Another example is using another product’s VBA.&#0160; For example, Excel is illustrated in the picture below.&#0160; Excel is it’s own process and it’s version of VBA is running in-process to Excel.&#0160; If Excel’s VBA is using Inventor’s API it will be accessing it out-of-process and will not have any access to bitmaps through the API.</p>
<p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc688340120a8fc64ec970b-pi"><img alt="InOutProc06" border="0" height="148" src="/assets/image_3906.jpg" style="BORDER-TOP-WIDTH: 0px; DISPLAY: inline; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" title="InOutProc06" width="450" /></a></p>
<br />
<p>Another way to access Inventor data is using Apprentice.&#0160; Apprentice is a programming only component and doesn’t have a user-interface and can’t run on its own but will always run in-process to its host application, (which is what you write).&#0160; In the example below, the primary application, Your.exe, has loaded Apprentice and Apprentice has opened a part document.&#0160; When using the Apprentice API (which is a subset of the Inventor API) you can successfully get the thumbnail because Apprentice is running in-process to your application and the IPictureDisp can be passed.</p>
<p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc6883401310f6339cf970c-pi"><img alt="InOutProc03" border="0" height="199" src="/assets/image_61636.jpg" style="BORDER-TOP-WIDTH: 0px; DISPLAY: inline; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" title="InOutProc03" width="362" /></a></p>
<br />
<p>If you’ve seen the program from a <a href="http://modthemachine.typepad.com/my_weblog/2010/02/parts-list-with-thumbnail-image.html">previous post</a> that creates a parts list with thumbnail images you might think that it’s breaking some of these rules.&#0160; It doesn’t, but these limitations did affect the choices I made as I arrived at the final design.&#0160; In that program, the code is an Inventor Add-in that reads the part list data from Inventor.&#0160; For each row in the parts list it accesses the associated document and gets the thumbnail.&#0160; Since the add-in is running in-process to Inventor there’s no problem to read the thumbnail.&#0160; As it processes each row and gets the thumbnail, it writes the thumbnail to disk.&#0160; It then accesses Word through it’s API.&#0160; This communication is out-of-process.&#0160; Using Word’s API it has Word insert the thumbnail into the table.&#0160; The Word API function to insert a bitmap into a table takes a filename as input.&#0160; Word uses this to read the bitmap from disk and insert it into the table.&#0160; The bitmap was never directly passed between Inventor and Word but went through the intermediate step of going to the disk.&#0160; If the Word function to place the bitmap into a table had taken an iPictureDisp as input the program would not have worked and I would have had to come up with some other solution.</p>
<p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc688340120a8fc650b970b-pi"><img alt="InOutProc07" border="0" height="230" src="/assets/image_745614.jpg" style="BORDER-TOP-WIDTH: 0px; DISPLAY: inline; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" title="InOutProc07" width="450" /></a></p>
