---
layout: "post"
title: "Comparing Floating Point Numbers"
date: "2013-08-12 22:26:00"
author: "Adam Nagy"
categories:
  - "Brian"
  - "Visual Basic for Applications (VBA)"
original_url: "https://modthemachine.typepad.com/my_weblog/2013/08/comparing-floating-point-numbers.html "
typepad_basename: "comparing-floating-point-numbers"
typepad_status: "Publish"
---

<p>What I’m going to discuss isn’t anything specific to Inventor but is a general issue to be aware of when working with computers and floating point numbers. The thing you need to understand is that floating point numbers are not always exact.&#0160; They’re very very close to the expected number and close enough for computations but you can run into problems when comparing numbers.&#0160; Below is a VBA sample that illustrates the problem.&#0160; I want to emphasize that the issue is not limited to VBA but can be seen with any programming language.</p>
<p style="font-size: 8pt; font-family: courier new; background: #eeeeee; color: black; line-height: 140%;">Public Sub CompareNumbers()&#0160; <br />&#0160;&#0160;&#0160; Dim val1 As Double&#0160; <br />&#0160;&#0160;&#0160; val1 = 0.1 + 0.1 + 0.1 <br /> <br />&#0160;&#0160;&#0160; Dim val2 As Double&#0160; <br />&#0160;&#0160;&#0160; val2 = 0.3 <br /> <br />&#0160;&#0160;&#0160; Debug.Print &quot;val1 = &quot; &amp; CStr(val1) &amp; &quot;, val2 = &quot; &amp; CStr(val2) <br /> <br />&#0160;&#0160;&#0160; If val1 = val2 Then&#0160; <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Debug.Print &quot;Values match&quot; <br />&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Debug.Print &quot;Values do not match&quot; <br />&#0160;&#0160;&#0160; End If <br /> <br />&#0160;&#0160;&#0160; Debug.Print &quot;Difference = &quot; &amp; val1 – val2 <br />End Sub</p>
<p>When I run the program above I get the following results in the Immediate window.</p>
<blockquote>
<p><span style="font-family: &#39;Courier New&#39;;">val1 = 0.3, val2 = 0.3 <br />Values do not match <br />Difference = 5.55111512312578E-17</span></p>
</blockquote>
<p>The first line is what you would expect but the second and third lines are a bit of a surprise.&#0160; You would expect the two variables to have the same value but the comparison shows that they are not equal and the last line shows by how much they are different; 0.0000000000000000555111512.&#0160; That value is close enough to being equal that in almost all cases you don’t need to care about the difference but when using the “=” comparison they must match exactly.</p>
<p>More than you ever wanted to know about why this happens can be found at <a href="http://en.wikipedia.org/wiki/Floating_point">http://en.wikipedia.org/wiki/Floating_point</a>.&#0160; A simpler explanation can be found here: <a href="http://floating-point-gui.de/" title="http://floating-point-gui.de/">http://floating-point-gui.de/</a>&#0160;</p>
<p><strong>The Solution</strong> <br />The solution to this problem is to not ever expect floating point numbers to be exactly equal but instead allow for them to be equal within a tolerance.&#0160; This is described in one of the links I provided above (<a href="http://floating-point-gui.de/errors/comparison/" title="http://floating-point-gui.de/errors/comparison/">http://floating-point-gui.de/errors/comparison/</a>).&#0160; Here’s my simple solution which according to the link is not the right way to do it, but I think in my case it works because I know the range of values that I’m working with.&#0160; Anyone working with Inventor is limited to sizes and tolerances that Inventor can handle so we know we’re not working with sizes in light years or nanometers.&#0160; When comparing two points, Inventor considers them to be the same if they’re within 0.0000000001 centimeters.</p>
<p>The code below is a modified version of the previous Sub that uses a function to do the value comparison.</p>
<p style="font-size: 8pt; font-family: courier new; background: #eeeeee; color: black; line-height: 140%;">Public Sub CompareNumbers2() <br />&#0160;&#0160;&#0160; Dim val1 As Double <br />&#0160;&#0160;&#0160; val1 = 0.1 + 0.1 + 0.1 <br /> <br />&#0160;&#0160;&#0160; Dim val2 As Double <br />&#0160;&#0160;&#0160; val2 = 0.3 <br /> <br />&#0160;&#0160;&#0160; Debug.Print &quot;val1 = &quot; &amp; CStr(val1) &amp; &quot;, val2 = &quot; &amp; CStr(val2) <br /> <br />&#0160;&#0160;&#0160; If <span style="background-color: #ffff00;">IsEqual(val1, val2)</span> Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Debug.Print &quot;Values match&quot; <br />&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Debug.Print &quot;Values do not match&quot; <br />&#0160;&#0160;&#0160; End If <br />End Sub</p>
<p>Below is the IsEqual function that compares to the two values within the specified tolerance.</p>
<p style="font-size: 8pt; font-family: courier new; background: #eeeeee; color: black; line-height: 140%;">Public Function IsEqual(Value1 As Double, Value2 As Double, _ <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Optional Tolerance As Double = 0.000000000001) As Boolean <br />&#0160;&#0160;&#0160; If Abs(Value1 - Value2) &lt; Tolerance Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; IsEqual = True <br />&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; IsEqual = False <br />&#0160;&#0160;&#0160; End If <br />End Function</p>
<p>Below is a more elaborate version of the IsEqual function that supports various types of comparisons.</p>
<p style="font-size: 8pt; font-family: courier new; background: #eeeeee; color: black; line-height: 140%;"><span style="color: #0000ff;">&#39; Compares two numbers to see if they meet the comparison condition </span> <br /><span style="color: #0000ff;">&#39; within the specified tolerance. </span> <br /><span style="color: #0000ff;">&#39; Valid comparison operators are, &quot;=&quot; &quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&lt;=&quot;, and &quot;&gt;=&quot;. </span> <br />Public Function NumbersCompare(Value1 As Double, Value2 As Double, _ <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; operator As String, _ <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Optional Tolerance As Double = 0.000000000001) As Boolean <br />&#0160;&#0160;&#0160; Dim difference As Double <br />&#0160;&#0160;&#0160; difference = Abs(Value1 - Value2) <br />&#0160;&#0160;&#0160; <br />&#0160;&#0160;&#0160; Dim comparison As String <br />&#0160;&#0160;&#0160; comparison = &quot;&quot; <br />&#0160;&#0160;&#0160; Dim equals As Boolean <br />&#0160;&#0160;&#0160; equals = False <br />&#0160;&#0160;&#0160; If Len(operator) = 2 Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; Determine if the operator is greater or less than. </span> <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; If Mid(operator, 1, 1) = &quot;&gt;&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; comparison = &quot;&gt;&quot; <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ElseIf Mid(operator, 1, 1) = &quot;&lt;&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; comparison = &quot;&lt;&quot; <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; MsgBox &quot;Bad comparison operator: &quot; &amp; operator <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = False <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Exit Function <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; End If <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; Determine if equals to is specified. </span> <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; If Mid(operator, 2, 1) = &quot;=&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; equals = True <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; MsgBox &quot;Bad comparison operator: &quot; &amp; operator <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = False <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Exit Function <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; End If <br />&#0160;&#0160;&#0160; ElseIf Len(operator) = 1 Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; Determine if the operator is greater than, </span> <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; less than, or equals to. </span> <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; If operator = &quot;&gt;&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; comparison = &quot;&gt;&quot; <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ElseIf operator = &quot;&lt;&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; comparison = &quot;&lt;&quot; <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; ElseIf operator = &quot;=&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; equals = True <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; MsgBox &quot;Bad comparison operator: &quot; &amp; operator <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = False <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Exit Function <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; End If <br />&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; MsgBox &quot;Bad comparison operator: &quot; &amp; comparison <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = False <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Exit Function <br />&#0160;&#0160;&#0160; End If <br />&#0160;&#0160;&#0160; <br />&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; Do the actual comparisons. </span> <br />&#0160;&#0160;&#0160; If operator = &quot;&gt;&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; Check if the value is greater than, using the tolerance. </span> <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; If Value1 + Tolerance &gt; Value2 Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = True <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Exit Function <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = False <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; End If <br />&#0160;&#0160;&#0160; ElseIf operator = &quot;&lt;&quot; Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; Check if the value is less than, using the tolerance. </span> <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; If Value1 - Tolerance &lt; Value2 Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = True <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Exit Function <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = False <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; End If <br />&#0160;&#0160;&#0160; End If <br /> <br />&#0160;&#0160;&#0160; <span style="color: #0000ff;">&#39; Check if the numbers are equal, within the tolerance. </span> <br />&#0160;&#0160;&#0160; If equals Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; If difference &lt;= Tolerance Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = True <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Exit Function <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; NumbersCompare = False <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; End If <br />&#0160;&#0160;&#0160; End If <br />End Function</p>
<p>Here’s an example of the function above in use.</p>
<p style="font-size: 8pt; font-family: courier new; background: #eeeeee; color: black; line-height: 140%;">Public Sub CompareNumbers3() <br />&#0160;&#0160;&#0160; Dim val1 As Double <br />&#0160;&#0160;&#0160; val1 = 0.1 + 0.1 + 0.1 <br /> <br />&#0160;&#0160;&#0160; Dim val2 As Double <br />&#0160;&#0160;&#0160; val2 = 0.3 <br /> <br />&#0160;&#0160;&#0160; Debug.Print &quot;val1 = &quot; &amp; CStr(val1) &amp; &quot;, val2 = &quot; &amp; CStr(val2) <br /> <br />&#0160;&#0160;&#0160; If <span style="background-color: #ffff00;">NumbersCompare(val1, val2, &quot;&lt;=&quot;)</span> Then <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Debug.Print &quot;Values compare&quot; <br />&#0160;&#0160;&#0160; Else <br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Debug.Print &quot;Values do not compare&quot; <br />&#0160;&#0160;&#0160; End If <br />End Sub</p>
<p>This is only a problem when working with floating point numbers.&#0160; Integers and strings are always exact and exact comparisons will work as expected.</p>
<p>-Brian</p>
