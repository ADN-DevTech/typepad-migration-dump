---
layout: "post"
title: "How to Time an Operation and Optimizing Code"
date: "2010-06-22 01:41:59"
author: "Adam Nagy"
categories:
  - "Brian"
original_url: "https://modthemachine.typepad.com/my_weblog/2010/06/how-to-time-an-operation.html "
typepad_basename: "how-to-time-an-operation"
typepad_status: "Publish"
---

<p>I’ve found it beneficial to time how long it takes portions of my programs to run and in particular when a program takes longer to run than I initially expected.&#160; Timing the different portions of a program tells you where the program is taking the most time and sometimes will help you find issues with your logic or how you’re using the API so you can make improvements to the execution time of your program.&#160; Determining where your program spends time processing is referred to as <em>profiling</em>.&#160; Some development environments provide profiling utilities and there are also 3rd party profilers available.&#160; There’s no profiling functionality built-in to VBA so you’ll have to do something on your own.&#160; Here’s the process I’ve used for several years to profile my VBA code.</p>  <p>First, I’ve created a small timer class.&#160; I’ve found this easier to use and much more accurate than trying to use built-in VBA functions to get the current time.&#160; Here’s the code for my timer class.</p>  <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">   <p>Private Declare Function QueryPerformanceFrequency _      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Lib &quot;kernel32&quot; (lpFrequency As Currency) As Long       <br />Private Declare Function QueryPerformanceCounter _       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Lib &quot;kernel32&quot; (lpPerformanceCount As Currency) As Long       <br />      <br />Private ConversionFactor As Currency       <br />Private CurrentStartTime As Currency       <br />      <br />      <br />Public Sub Start()       <br />&#160;&#160;&#160; Dim iReturn As Long       <br />&#160;&#160;&#160; iReturn = QueryPerformanceCounter(CurrentStartTime)       <br />End Sub       <br />      <br />      <br />Private Sub Class_Initialize()       <br />&#160;&#160;&#160; Dim iReturn As Long       <br />&#160;&#160;&#160; iReturn = QueryPerformanceFrequency(ConversionFactor)       <br />End Sub       <br />      <br />      <br />Public Property Get CurrentTime() As Double       <br />&#160;&#160;&#160; Dim NewTime As Currency       <br />&#160;&#160;&#160; Dim iReturn As Long       <br />&#160;&#160;&#160; iReturn = QueryPerformanceCounter(NewTime)       <br />&#160;&#160;&#160; Dim TotalTime As Currency       <br />&#160;&#160;&#160; TotalTime = NewTime - CurrentStartTime       <br />&#160;&#160;&#160; CurrentTime = TotalTime / ConversionFactor       <br />End Property</p> </div>  <p>To add the code above to your VBA project, run the <strong>Class Module</strong> command from the <strong>Insert</strong> menu.&#160; This will create a new, empty class module.&#160; Copy and paste the code above into the new module.</p>  <p>Rename the class module to “clsTimer”&#160; Do this by selecting the class module in the Project Explorer tree and then editing the name in the Properties window, as shown below.</p>  <p><a href="http://modthemachine.typepad.com/.a/6a00e553fcbfc68834013484b6179a970c-pi"><img title="NameTimerClass" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="247" alt="NameTimerClass" src="/assets/image_278050.jpg" width="212" border="0" /></a> </p>  <p>Now you can use this class to time portions of your code.&#160; Here’s a simple example.&#160; This creates two instances of the timer class.&#160; One that will be used to time small portions of the program and another that will be used to time the overall execution.&#160; After creating a timer you call the Start method to begin timing.&#160; At any time you can use the timer’s CurrentTime property to get the elapsed time.&#160; You can also call the Start method again to restart the timer.&#160; The value returned is the number of seconds that have elapsed since the timer started.&#160; I use the VBA Format function to control the number of decimal places displayed.</p>  <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">   <p>Public Sub TimerExample()&#160; <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Create and start a timer for the total time.         <br /></strong></font>&#160;&#160;&#160; Dim timerAll As New clsTimer       <br />&#160;&#160;&#160; timerAll.Start      <br />      <br /></p>   <font color="#0000ff"><strong>&#160;&#160;&#160; ' Create and start a timer for individual times.       <br /></strong></font>&#160;&#160;&#160; Dim timer As New clsTimer     <br />&#160;&#160;&#160; timer.Start    <br />    <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Time creating an assembly document.&#160; <br /></strong></font>&#160;&#160;&#160; Dim doc As Document     <br />&#160;&#160;&#160; Set doc = ThisApplication.Documents.Add(kAssemblyDocumentObject)     <br />&#160;&#160;&#160; Debug.Print &quot;Assembly: &quot; &amp; Format(timer.CurrentTime, &quot;0.000000&quot;)     <br />    <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Restart the timer.       <br /></strong></font>&#160;&#160;&#160; timer.Start     <br />    <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Time creating a drawing document.       <br /></strong></font>&#160;&#160;&#160; Set doc = ThisApplication.Documents.Add(kDrawingDocumentObject)     <br />&#160;&#160;&#160; Debug.Print &quot;Drawing: &quot; &amp; Format(timer.CurrentTime, &quot;0.000000&quot;)     <br />    <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Restart the timer.       <br /></strong></font>&#160;&#160;&#160; timer.Start    <br />    <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Time creating a part document.       <br /></strong></font>&#160;&#160;&#160; Set doc = ThisApplication.Documents.Add(kPartDocumentObject)     <br />&#160;&#160;&#160; Debug.Print &quot;Part: &quot; &amp; Format(timer.CurrentTime, &quot;0.000000&quot;)    <br />    <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Display the total time.&#160; <br /></strong></font>&#160;&#160;&#160; Debug.Print &quot;Total: &quot; &amp; Format(timerAll.CurrentTime, &quot;0.000000&quot;)     <br />End Sub</div>  <p>Here’s another example that puts this into practice to try and optimize a program.&#160; It gets all of the faces from the active part.</p>  <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">   <p>Public Sub GetFaces1()      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Get the first body from the active part.&#160; <br /></strong></font>&#160;&#160;&#160; Dim partDoc As PartDocument       <br />&#160;&#160;&#160; Set partDoc = ThisApplication.ActiveDocument       <br />&#160;&#160;&#160; Dim body As SurfaceBody       <br />&#160;&#160;&#160; Set body = partDoc.ComponentDefinition.SurfaceBodies.Item(1)       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Create a timer          <br /></strong></font>&#160;&#160;&#160; Dim timer As New clsTimer       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Start the timer.          <br /></strong></font>&#160;&#160;&#160; timer.Start       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Iterate through the faces using the Item property.          <br /></strong></font>&#160;&#160;&#160; Dim oFace As Face       <br />&#160;&#160;&#160; Dim i As Integer&#160; <br />&#160;&#160;&#160; For i = 1 To body.Faces.Count       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; Set oFace = body.Faces.Item(i)&#160; <br />&#160;&#160;&#160; Next       <br />      <br />&#160;&#160;&#160; Debug.Print &quot;Time for &quot; &amp; body.Faces.Count &amp; &quot; faces: &quot; &amp; _       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Format(timer.CurrentTime, &quot;0.000000&quot;)       <br />End Sub</p> </div>  <p>This results in the following being printed to my Immediate window:</p>  <blockquote>   <p>Time for 1264 faces: 41.421942</p> </blockquote>  <p>It takes forty-one seconds to iterate over the faces in the body.&#160; Let’s look at some things that can be done to improve the performance.&#160; </p>  <p>A common coding method, particularly in VB/VBA, is to string multiple calls together in a single line.&#160; This is done in the code above in a few places.&#160; The first is where it gets the SurfaceBody object.&#160; It does this by calling the ComponentDefinition property of the PartDocument object, and then calls the SurfaceBodies property on the PartComponentDefinition object that’s returned, and finally calls the Item property on the returned SurfaceBodies object.&#160; There are three API calls within that single line.&#160; It’s ok in this case since it’s only executed once, but sometimes you can do excessive processing when these are within loops.</p>  <p>Another line where there are multiple calls being made is the one within the For loop where it’s getting the Face.&#160; In this case, this line is being call 1264 times.&#160; Here’s a modified version where the SurfaceBodies object is obtained once, outside the loop and then used within the loop to get each face.&#160; The new and modifies lines are highlighted in red.</p>  <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">   <p>Public Sub GetFaces2()&#160; <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Get the first body from the active part.&#160; <br /></strong></font>&#160;&#160;&#160; Dim partDoc As PartDocument       <br />&#160;&#160;&#160; Set partDoc = ThisApplication.ActiveDocument       <br />&#160;&#160;&#160; Dim body As SurfaceBody       <br />&#160;&#160;&#160; Set body = partDoc.ComponentDefinition.SurfaceBodies.Item(1)       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Create a timer          <br /></strong></font>&#160;&#160;&#160; Dim timer As New clsTimer       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Start the timer.          <br /></strong></font>&#160;&#160;&#160; timer.Start       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Iterate through the faces using the Item property.          <br /></strong></font>&#160;&#160;&#160; Dim oFace As Face       <br />&#160;&#160;&#160; Dim i As Integer&#160;&#160; <br /><font color="#ff0000">&#160;&#160;&#160; Dim oFaces As Faces        <br />&#160;&#160;&#160; Set oFaces = body.Faces</font>       <br />&#160;&#160;&#160; For i = 1 To body.Faces.Count&#160; <br /><font color="#ff0000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Set oFace = oFaces.Item(i)&#160; <br /></font>&#160;&#160;&#160; Next       <br />      <br />&#160;&#160;&#160; Debug.Print &quot;Time for &quot; &amp; body.Faces.Count &amp; &quot; faces: &quot; &amp; _       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Format(timer.CurrentTime, &quot;0.000000&quot;)       <br />End Sub</p> </div>  <p>This results in the following being printed to my Immediate window:</p>  <blockquote>   <p>Time for 1264 faces: 0.217899</p> </blockquote>  <p>We went from over 40 seconds down to less than one second.&#160; This is over 190 times faster than the previous code, and a huge improvement.&#160; Don’t always expect improvements like this, but taking the time to do a little profiling can often result in some time improvements.</p>  <p>There’s one more thing that can be done that might help with performance.&#160; Instead of using the For statement to go from 1 to Count we can use the For Each statement.&#160; This can result in better performance and also creates cleaner, easier to read code.</p>  <div style="font-size: 8pt; background: #eeeeee; color: black; line-height: 140%; font-family: courier new">   <p>Public Sub GetFaces3()&#160; <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Get the first body from the active part.&#160; <br /></strong></font>&#160;&#160;&#160; Dim partDoc As PartDocument       <br />&#160;&#160;&#160; Set partDoc = ThisApplication.ActiveDocument       <br />&#160;&#160;&#160; Dim body As SurfaceBody       <br />&#160;&#160;&#160; Set body = partDoc.ComponentDefinition.SurfaceBodies.Item(1)       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Create a timer          <br /></strong></font>&#160;&#160;&#160; Dim timer As New clsTimer       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Start the timer.          <br /></strong></font>&#160;&#160;&#160; timer.Start       <br />      <br /><font color="#0000ff"><strong>&#160;&#160;&#160; ' Iterate through the faces using the Item property.          <br /></strong></font>&#160;&#160;&#160; Dim oFace As Face&#160; <br /><font color="#ff0000">&#160;&#160;&#160; For Each oFace in body.Faces        <br /></font>&#160;&#160;&#160; Next       <br />      <br />&#160;&#160;&#160; Debug.Print &quot;Time for &quot; &amp; body.Faces.Count &amp; &quot; faces: &quot; &amp; _       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Format(timer.CurrentTime, &quot;0.000000&quot;)       <br />End Sub</p> </div>  <p>This results in the following being printed to my Immediate window:</p>  <blockquote>   <p>Time for 1264 faces: 0.060036</p> </blockquote>  <p>This is an improvement of about 3.5 times over the earlier time.</p>
