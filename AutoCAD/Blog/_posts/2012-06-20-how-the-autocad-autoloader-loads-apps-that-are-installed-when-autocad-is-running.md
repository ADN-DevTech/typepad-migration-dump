---
layout: "post"
title: "How the AutoCAD Autoloader loads Apps that are installed when AutoCAD is running"
date: "2012-06-20 11:15:17"
author: "Fenton Webb"
categories:
  - "2012"
  - "AutoCAD"
  - "Fenton Webb"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2012/06/how-the-autocad-autoloader-loads-apps-that-are-installed-when-autocad-is-running.html "
typepad_basename: "how-the-autocad-autoloader-loads-apps-that-are-installed-when-autocad-is-running"
typepad_status: "Publish"
---

<p>by <a href="http://adndevblog.typepad.com/autocad/fenton-webb.html">Fenton Webb</a></p>
<p>By now, I’m sure, all of you people out there have taken a look at the <a href="http://apps.exchange.autodesk.com">Autodesk Exchange App Store</a>… If not I highly recommend that you do so.</p>
<p>What you will notice when you install an App off of the AppStore is that AutoCAD (and soon all Autodesk products) “autoload” the installed applications via an Autoloader module built into the host product. The idea is that all of the App registration is done entirely by the Autodesk product’s Autoloader module and not repeated through thousands of developer’s installer routines around the world, thus allowing for a much easier, more professional and standardized deployment model across all Apps on our store. Another point, because the installers are standardized, we can easily create tools to manage the Apps and even to automatically generate the App installers – indeed, that’s what we do today using the not yet public “Autodesk AppPacker” (APP) tool, 1 minute to create an AutoCAD App installer instead of 1-3 weeks!!!!!</p>
<p>Anyway, back to the the AutoCAD implementation of the Autoloader – the Autoloader module initializes Apps for two specific User scenarios:</p>
<ol>
<li>OnStartup – Apps are initialized on startup</li>
<li>OnAppearance – Apps are initialized while the host product (AutoCAD say) is already running.</li>
</ol>
<p>User scenario number two, is fairly interesting, so I want to tell you about it.</p>
<p>In order for a running application to be efficiently notified of a new file or folder appearing on the system you need some sort of notification system. For something like this to work well, you have to be very careful about how you implement it because, without some care, you will either make the host application slow down and/or crash.</p>
<p>So as not to impact the host application performance, it’s best to run those types of folder checks on a separate thread, away from the main thread. The problem with running on a separate (or worker) thread is that when your worker thread eventually needs to carry out work inside the host application (main thread) you have to take extreme care to make sure that the main thread is indeed ready for you, otherwise it will go horribly wrong. As we all know, AutoCAD is not multithreaded so adding multithreaded features takes extreme care, otherwise AutoCAD will quickly crash.</p>
<p>The solution is as follows, and this is indeed a fairly accurate interpretation&#0160;of how the AutoCAD Autoloader works for the OnAppearance context, taken from my original prototype.</p>
<p><strong>1) Utilize the Microsoft Folder Notification API</strong></p>
<p>Microsoft have there own Folder Notification API, so we may as well use that! AutoCAD implements an interface called IAdComFolderWatchReactor hosted inside of AdComFolderWatch.dll which wraps the Folder Notification API calls for you. This interface runs on a separate worker thread and receives the notifications away from the main thread, it’s very clean and nice to use - and ultimately handles all major multithreaded work for you, we like!</p>
<p>Here’s how the interface is implemented…</p>
<p>e.g.</p>
<div style="background: white;">
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">//////////////////////////////////////////////////////////////////////////////</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">#import</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #a31515;">&lt;AdComFolderWatch18.tlb&gt;</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">raw_interfaces_only</span></span><span style="color: #000000;">, </span><span><span style="color: #020002;">raw_native_types</span></span><span style="color: #000000;">, </span><span><span style="color: #020002;">no_namespace</span></span><span style="color: #000000;">, </span></span><span><span style="color: #020002; font-size: 8pt;">named_guids</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">class</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;"> : </span><span><span style="color: #0000ff;">public</span></span><span style="color: #000000;"> </span></span><span><span style="color: #020002; font-size: 8pt;">IAdComFolderWatchReactor</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">{</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">CComPtr</span></span><span style="color: #000000;">&lt;</span><span><span style="color: #020002;">IAdComFolderWatchManager</span></span><span style="color: #000000;">&gt; </span><span><span style="color: #020002;">mFolderWatchManager</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// AutoCAD main window, so we don&#39;t have to risk calling it on another thread</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">HWND</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">mAutoCADHWnd</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// folder watcher unique ids</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">AcArray</span></span><span style="color: #000000;">&lt;</span><span><span style="color: #0000ff;">long</span></span><span style="color: #000000;">&gt; </span><span><span style="color: #020002;">mKeys</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// singleton</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">static</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;"> *</span><span><span style="color: #020002;">mInstance</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">(</span><span><span style="color: #0000ff;">const</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">&amp; </span><span><span style="color: #020002;">other</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">&amp; </span><span><span style="color: #0000ff;">operator</span></span><span style="color: #000000;">=(</span><span><span style="color: #0000ff;">const</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">&amp; </span><span><span style="color: #020002;">other</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">public</span></span></span><span style="color: #000000; font-size: 8pt;">:</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// unique Windows message ID</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">AcArray</span></span><span style="color: #000000;">&lt;</span><span><span style="color: #020002;">UINT</span></span><span style="color: #000000;">&gt; </span><span><span style="color: #020002;">mMessageIds</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// array of folders</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">AcArray</span></span><span style="color: #000000;">&lt;</span><span><span style="color: #020002;">CString</span></span><span style="color: #000000;">&gt; </span><span><span style="color: #020002;">mFolders</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">();</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">virtual</span></span><span style="color: #000000;"> ~</span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">();</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// IUnknown</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">virtual</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">HRESULT</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">STDMETHODCALLTYPE</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">QueryInterface</span></span><span style="color: #000000;">(</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #008000;">/* [in] */</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">REFIID</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">riid</span></span><span style="color: #000000;">,</span><span><span style="color: #008000;">/* [iid_is][out] */</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">__RPC__deref_out</span></span><span style="color: #000000;">&#0160; </span><span><span style="color: #0000ff;">void</span></span><span style="color: #000000;"> **</span><span><span style="color: #020002;">ppvObject</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">virtual</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">ULONG</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">STDMETHODCALLTYPE</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">AddRef</span></span><span style="color: #000000;">( </span><span><span style="color: #0000ff;">void</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">virtual</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">ULONG</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">STDMETHODCALLTYPE</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">Release</span></span><span style="color: #000000;">( </span><span><span style="color: #0000ff;">void</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// IAdComFolderWatchReactor</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">virtual</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">HRESULT</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">__stdcall</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">OnFolderChange</span></span><span style="color: #000000;"> (</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">BSTR</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">foldername</span></span><span style="color: #000000;">,</span><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">SAFEARRAY</span></span><span style="color: #000000;"> * * </span><span><span style="color: #020002;">names</span></span><span style="color: #000000;">,</span><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">SAFEARRAY</span></span><span style="color: #000000;"> * * </span><span><span style="color: #020002;">actions</span></span><span style="color: #000000;"> );</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">virtual</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">HRESULT</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">__stdcall</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">OnError</span></span><span style="color: #000000;"> (</span><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">long</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">num</span></span><span style="color: #000000;">,</span><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">BSTR</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">description</span></span><span style="color: #000000;"> );</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// records a folder to watch</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">long</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">watchFolder</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">CString</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">folder</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// gets the singleton instance</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">static</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">* </span><span><span style="color: #020002;">GetInstance</span></span><span style="color: #000000;">();</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">};</span></span></p>
</div>
<p><strong>2) How to switch from a worker thread to the main thread</strong></p>
<p>The safest way to switch between a worker thread and the main thread in AutoCAD is to send a custom Windows message from the worker thread to the main thread, and then catch that message in the main thread for processing... That is demonstrated in step 5’s PostMessage() code.</p>
<p>You can create your own custom Windows message, using RegisterWindowMessage()…</p>
<p>e.g.</p>
<div style="background: white;">
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// generate a unique message handler id string</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #020002;"><span style="font-size: 8pt;">CString</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #020002;">uniqueMessageString</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #020002;"><span style="font-size: 8pt;">uniqueMessageString</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;">.</span><span><span style="color: #020002;">Format</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">_T</span></span><span style="color: #000000;">(</span><span><span style="color: #a31515;">&quot;WM_AutoloaderOnAppearanceMsg%d&quot;</span></span><span style="color: #000000;">), </span><span><span style="color: #020002;">mKeys</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">length</span></span><span style="color: #000000;">());</span></span></span></p>
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// now generate the id from the string</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #020002;"><span style="font-size: 8pt;">UINT</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #020002;">messageId</span></span><span style="color: #000000;"> = ::</span><span><span style="color: #020002;">RegisterWindowMessage</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">uniqueMessageString</span></span><span style="color: #000000;">);</span></span></span></p>
</div>
<p><strong>3) Register the folders you want to watch using <span><span style="color: #020002; font-size: 8pt;">IAdComFolderWatchReactor</span></span></strong></p>
<p><span><span style="color: #020002;">The implementation of the watchFolder() function is as follows, simply call it passing the folder path you want to watch. </span></span></p>
<p><span><span style="color: #020002;">e.g.</span></span></p>
<div style="background: white;">
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">long</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">::</span><span><span style="color: #020002;">watchFolder</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">CString</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">folder</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">{</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">long</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">key</span></span><span style="color: #000000;"> = 0;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// now register the callbacks</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;"> (</span><span><span style="color: #020002;">SUCCEEDED</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">mFolderWatchManager</span></span><span style="color: #000000;">-&gt;</span><span><span style="color: #020002;">AttachReactor</span></span><span style="color: #000000;">(</span><span><span style="color: #0000ff;">this</span></span><span style="color: #000000;">, </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="font-size: 8pt;"><span><span style="color: #020002;">CComBSTR</span></span><span style="color: #000000;">((</span><span><span style="color: #020002;">LPCTSTR</span></span><span style="color: #000000;">)</span><span><span style="color: #020002;">folder</span></span><span style="color: #000000;">), </span><span><span style="color: #020002;">VARIANT_TRUE</span></span><span style="color: #000000;">, (</span><span><span style="color: #020002;">FileNotifyFlags</span></span><span style="color: #000000;">)511, &amp;</span><span><span style="color: #020002;">key</span></span><span style="color: #000000;">)))</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// remember the key</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">mKeys</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">append</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">key</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// and the path</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">mFolders</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">append</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">folder</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// generate a unique message handler id string</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">CString</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">uniqueMessageString</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">uniqueMessageString</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">Format</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">_T</span></span><span style="color: #000000;">(</span><span><span style="color: #a31515;">&quot;WM_AutoloaderOnAppearanceMsg%d&quot;</span></span><span style="color: #000000;">), </span><span><span style="color: #020002;">mKeys</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">length</span></span><span style="color: #000000;">());</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// now generate the id from the string</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">UINT</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">messageId</span></span><span style="color: #000000;"> = ::</span><span><span style="color: #020002;">RegisterWindowMessage</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">uniqueMessageString</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// now add it to our recorded list</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">mMessageIds</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">append</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">messageId</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">return</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">key</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">}</span></span></p>
</div>
<p><strong>4) Register our own Message Filter using acedRegisterWatchWinMsg() which watches for the unique Window Message from Step 2</strong></p>
<p>Here’s the constructor of CFolderWatcher(), as you can see it registers a MessageProc() which will receive all AutoCAD Windows messages…</p>
<div style="background: white;">
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #020002;"><span style="font-size: 8pt;">CFolderWatcher</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;">::</span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">()</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">{</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// if mInstance is NULL</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;"> (</span><span><span style="color: #020002;">mInstance</span></span><span style="color: #000000;"> == </span><span><span style="color: #020002;">NULL</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// create the folder watcher manager, if it fails no need to do the rest</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">SUCCEEDED</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">mFolderWatchManager</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">CoCreateInstance</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">CLSID_AdComFolderWatchManager</span></span><span style="color: #000000;">)))</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// record the AutoCAD main window, so we don&#39;t have to risk calling it on anotheer thread</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">mAutoCADHWnd</span></span><span style="color: #000000;"> = </span><span><span style="color: #020002;">adsw_acadMainWnd</span></span><span style="color: #000000;">();</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// register message hook to receive worker thread notification that a change has occurred</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">acedRegisterWatchWinMsg</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">MessageProc</span></span><span style="color: #000000;">);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">mInstance</span></span><span style="color: #000000;"> = </span><span><span style="color: #0000ff;">this</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">}</span></span></p>
<p style="margin: 0px;">&#0160;</p>
</div>
<p><strong>5) What to do when you get a notification from the OnFolderChange()</strong></p>
<p>When the OnFolderChange() is fired from the IAdComFolderWatchReactor, you are being called from the worker thread. The Autoloader mechanism does not work on the worker thread, only on the main thread – plus, we just don’t know if AutoCAD is ready to do what we want, we need to check isQuiescent() == true first…</p>
<p>From our own implementation of the OnFolderChange(), post our custom message to AutoCAD…</p>
<p>e.g.</p>
<div style="background: white;">
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">//////////////////////////////////////////////////////////////////////////////</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #020002;"><span style="font-size: 8pt;">HRESULT</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">::</span><span><span style="color: #020002;">OnFolderChange</span></span><span style="color: #000000;"> (</span><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">BSTR</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">foldername</span></span><span style="color: #000000;">, </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">SAFEARRAY</span></span><span style="color: #000000;"> * * </span><span><span style="color: #020002;">names</span></span><span style="color: #000000;">,</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #008000;">/*[in]*/</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">SAFEARRAY</span></span><span style="color: #000000;"> * * </span><span><span style="color: #020002;">actions</span></span><span style="color: #000000;"> )</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">{</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// find the folder in our list of folders that are being watched</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">for</span></span><span style="color: #000000;"> (</span><span><span style="color: #0000ff;">int</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">=0; </span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">&lt;</span><span><span style="color: #020002;">mFolders</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">length</span></span><span style="color: #000000;">(); ++</span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// if this is the one we are looking for</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;"> (</span><span><span style="color: #020002;">foldername</span></span><span style="color: #000000;"> == </span><span><span style="color: #020002;">mFolders</span></span><span style="color: #000000;">[</span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">])</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// post to the main thread we need a review of the loaded apps</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; ::</span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">PostMessage</span></span><span style="color: #000000;">(</span><span><span style="color: #020002;">mAutoCADHWnd</span></span><span style="color: #000000;">, </span><span><span style="color: #020002;">mMessageIds</span></span><span style="color: #000000;">[</span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">], 0, 0);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">return</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">S_OK</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">}</span></span></p>
</div>
<p>now in our MessageProc we need to do something like this (sorry, I cannot post the whole function for legal reasons)</p>
<div style="background: white;">
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">void</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #020002;">MessageProc</span></span><span style="color: #000000;">(</span><span><span style="color: #0000ff;">const</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">MSG</span></span><span style="color: #000000;"> *</span><span><span style="color: #020002;">pMsg</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">{</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// get the single folder watcher instance</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;"> *</span><span><span style="color: #020002;">watcher</span></span><span style="color: #000000;"> = </span><span><span style="color: #020002;">CFolderWatcher</span></span><span style="color: #000000;">::</span><span><span style="color: #020002;">GetInstance</span></span><span style="color: #000000;">();</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// if ok</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;"> (</span><span><span style="color: #020002;">watcher</span></span><span style="color: #000000;"> != </span><span><span style="color: #020002;">NULL</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// now loop through the message Id&#39;s and compare them</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">for</span></span><span style="color: #000000;"> (</span><span><span style="color: #0000ff;">int</span></span><span style="color: #000000;"> </span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">=0; </span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">&lt;</span><span><span style="color: #020002;">watcher</span></span><span style="color: #000000;">-&gt;</span><span><span style="color: #020002;">mMessageIds</span></span><span style="color: #000000;">.</span><span><span style="color: #020002;">length</span></span><span style="color: #000000;">(); ++</span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// if this message is the same</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;"> (</span><span><span style="color: #020002;">watcher</span></span><span style="color: #000000;">-&gt;</span><span><span style="color: #020002;">mMessageIds</span></span><span style="color: #000000;">[</span><span><span style="color: #020002;">i</span></span><span style="color: #000000;">] == </span><span><span style="color: #020002;">pMsg</span></span><span style="color: #000000;">-&gt;</span><span><span style="color: #020002;">message</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span><span style="color: #008000; font-size: 8pt;">// AutoCAD is busy</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;"> (</span><span><span style="color: #020002;">curDoc</span></span><span style="color: #000000;">()-&gt;</span><span><span style="color: #020002;">isQuiescent</span></span><span style="color: #000000;">() == </span><span><span style="color: #0000ff;">false</span></span><span style="color: #000000;">)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; {</span></span></p>
<div style="background: white;">
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// setup sleep timer, on different thread, to wait 6 seconds</span></span></span></p>
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// once the timer has passed, repost the custom message</span></span></span></p>
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// and try this code again</span></span></span></p>
</div>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #008000; font-size: 8pt;">&#0160;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160;&#0160;&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&#0160; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">}</span></span></p>
</div>
