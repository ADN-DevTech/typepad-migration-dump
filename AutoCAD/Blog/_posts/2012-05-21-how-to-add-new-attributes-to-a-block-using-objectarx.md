---
layout: "post"
title: "Add new attributes to a block using ObjectARX"
date: "2012-05-21 02:51:41"
author: "Xiaodong Liang"
categories:
  - "AutoCAD"
  - "ObjectARX"
  - "Xiaodong Liang"
original_url: "https://adndevblog.typepad.com/autocad/2012/05/how-to-add-new-attributes-to-a-block-using-objectarx.html "
typepad_basename: "how-to-add-new-attributes-to-a-block-using-objectarx"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/xiaodong-liang.html" target="_self">Xiaodong Liang</a></p>  <p>The first you need to know is: in AutoCAD, block definitions are AcDbBlockTableRecords, just as are &quot;*MODEL_SPACE&quot; and &quot;*PAPER_SPACE&quot; AcDbBlockTableRecords. The Block definition(AcDbBlockTableRecord), as the ACDB_MODEL_SPACE/ACDB_PAPER_SPACE records, have entities associated with them. A Block definition typically has entities and AcDbAttributeDefinition's associated with it. To add a new attribute to the block definition, it is a matter of adding another AcDbAttributeDefinition to the AcDbBlockTableRecord in which you are interested. </p>  <p>The first code below adds one AcDbAttributeDefinition to one AcDbBlockTableRecord. It assumes a drawing is opened and there is one block named “Test” in the drawing. </p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue"></span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue"></span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> AddNewAtt(</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbDatabase *pCurDb;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbBlockTable* pBlkTbl;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbBlockTableRecord* pBlkRec;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbObjectId attId;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Acad::ErrorStatus es;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbAttributeDefinition* pAttDef;</span></p>    <div style="font-family: courier new; background: white; color: black; font-size: 8pt">     <p style="margin: 0px"><span style="line-height: 140%; color: green">&#160;&#160; // location of the AttributeDefinition in the </span></p>      <p style="margin: 0px"><span style="line-height: 140%; color: green">&#160;&#160; // block definition </span></p>   </div>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcGePoint3d attLoc(1.2, -0.5, 0);</span></p>    <p style="margin: 0px">&#160;</p>    <div style="font-family: courier new; background: white; color: black; font-size: 8pt">     <p style="margin: 0px"><span style="line-height: 140%; color: green">&#160;&#160; // specify the text,tag and prompt</span></p>   </div>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ACHAR text[] = {L</span><span style="line-height: 140%; color: #a31515">&quot;NEW VALUE ADDED&quot;</span><span style="line-height: 140%">};</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ACHAR tag[] = {L</span><span style="line-height: 140%; color: #a31515">&quot;MYTAG&quot;</span><span style="line-height: 140%">};</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ACHAR prompt[] = {L</span><span style="line-height: 140%; color: #a31515">&quot;Enter a new value&quot;</span><span style="line-height: 140%">};</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; </span><span style="line-height: 140%">&#160;</span>&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pCurDb = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; acdbHostApplicationServices()-&gt;workingDatabase();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; es = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; pCurDb-&gt;getBlockTable(pBlkTbl, AcDb::kForRead);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(!pBlkTbl-&gt;has(L</span><span style="line-height: 140%; color: #a31515">&quot;TEST&quot;</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acutPrintf(L</span><span style="line-height: 140%; color: #a31515">&quot;\nBlock definition TEST does not </span></p>    <p style="margin: 0px"><span style="line-height: 140%; color: #a31515">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; exist&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBlkTbl-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; es = pBlkTbl-&gt;getAt(L</span><span style="line-height: 140%; color: #a31515">&quot;TEST&quot;</span><span style="line-height: 140%">, pBlkRec, AcDb::kForWrite);</span></p>    <div style="font-family: courier new; background: white; color: black; font-size: 8pt">     <p style="margin: 0px"><span style="line-height: 140%; color: green">&#160;&#160;&#160; // create a AttributeDefinition</span></p>   </div>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pAttDef = </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> AcDbAttributeDefinition(attLoc, text,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tag, prompt);</span></p>    <p style="margin: 0px">&#160;</p>    <div style="font-family: courier new; background: white; color: black; font-size: 8pt">     <p style="margin: 0px"><span style="line-height: 140%; color: green">&#160;&#160;&#160; // append the AttributeDefinition to the definition </span></p>   </div>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; es = pBlkRec-&gt;appendAcDbEntity(attId, pAttDef);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pAttDef-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBlkRec-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBlkTbl-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p>    <p style="margin: 0px"><span style="line-height: 140%"></span></p>    <p style="margin: 0px"><span style="line-height: 140%"></span></p> </div>  <p style="margin: 0px"><span style="line-height: 140%">&#160;</span></p> Now, the block definition is modified. If you insert a new block (block reference), you will be asked to provide the value for the attribute. But the previous blocks have not attribute values, yet. To set their values, you could get all blocks which are defined by the block definition, open the them and update the attributes.   <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> UpdateATT()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; AcDbDatabase *pCurDb = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; acdbHostApplicationServices()-&gt;workingDatabase();</span>&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; AcDbBlockTable* pBlkTbl;</span>&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; Acad::ErrorStatus es =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pCurDb-&gt;getBlockTable(pBlkTbl, AcDb::kForRead);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; </span><span style="line-height: 140%; color: green">// if the block definition exists</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(!pBlkTbl-&gt;has(L</span><span style="line-height: 140%; color: #a31515">&quot;TEST&quot;</span><span style="line-height: 140%">))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; acutPrintf(L</span><span style="line-height: 140%; color: #a31515">&quot;\nBlock definition TEST does not exist&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBlkTbl-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; }</span></p>    <p style="margin: 0px">&#160; </p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; AcDbBlockTableRecord *pBlkRec;</span>&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; </span><span style="line-height: 140%; color: green">// open the block definition</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; es = pBlkTbl-&gt;getAt(L</span><span style="line-height: 140%; color: #a31515">&quot;TEST&quot;</span><span style="line-height: 140%">, pBlkRec, AcDb::kForWrite);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(es != Acad::eOk)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; acutPrintf(L</span><span style="line-height: 140%; color: #a31515">&quot;\nBlock definition TEST does not exist&quot;</span><span style="line-height: 140%">);&#160;&#160;&#160;&#160;&#160;&#160; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBlkTbl-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; </span><span style="line-height: 140%; color: green">// get the blocks (block references)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160; </span><span style="line-height: 140%; color: green">// which use the block definition</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbObjectIdArray ids;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBlkRec-&gt;getBlockReferenceIds(ids);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBlkRec-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBlkTbl-&gt;close();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// iterate each block</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> i=0;i&lt;ids.length();i++)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDbObject *pObj;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDbObjectId id = ids[i];</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; es = acdbOpenObject(pObj,id,AcDb::</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; OpenMode::kForWrite);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(es != Acad::eOk)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">continue</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDbBlockReference *pBlkRef =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDbBlockReference::cast(pObj);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(pBlkRef == NULL)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">continue</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// get attributes Iterator </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDbObjectIterator *pAttribIter;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Step through the attributes and check to see</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// if the attribute 'TAG3' already exists</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pAttribIter = pBlkRef-&gt;attributeIterator();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%">(pAttribIter-&gt;start(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; !pAttribIter-&gt;done(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pAttribIter-&gt;step())</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDbObjectId blkRefAttId =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pAttribIter-&gt;objectId();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDbAttribute *pBlkRefAtt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; es = pBlkRef-&gt;openAttribute(pBlkRefAtt,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; blkRefAttId,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDb::kForWrite);</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ACHAR&#160; *pAttTag = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBlkRefAtt-&gt;tag();</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(_tcscmp(pAttTag, L</span><span style="line-height: 140%; color: #a31515">&quot;MYTAG&quot;</span><span style="line-height: 140%">) == 0)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// update the attribute value</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBlkRefAtt-&gt;setTextString(L</span><span style="line-height: 140%; color: #a31515">&quot;My Value&quot;</span><span style="line-height: 140%">);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; free(pAttTag);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBlkRefAtt-&gt;close();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">delete</span><span style="line-height: 140%"> pAttribIter;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBlkRef-&gt;close();&#160; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>
