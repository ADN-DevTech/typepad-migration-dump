---
layout: "post"
title: "Clear the UNDO stack programmatically to prevent UNDO-ing of a command &ndash; Part 2"
date: "2012-06-22 11:14:13"
author: "Fenton Webb"
categories:
  - ".NET"
  - "2012"
  - "2013"
  - "AutoCAD"
  - "Fenton Webb"
original_url: "https://adndevblog.typepad.com/autocad/2012/06/clear-the-undo-stack-programmatically-to-prevent-undo-ing-of-a-command-part-2.html "
typepad_basename: "clear-the-undo-stack-programmatically-to-prevent-undo-ing-of-a-command-part-2"
typepad_status: "Publish"
---

<p>by <a href="http://adndevblog.typepad.com/autocad/fenton-webb.html">Fenton Webb</a></p>  <p>Leading on from Adam’s really cool <a href="http://adndevblog.typepad.com/autocad/2012/05/clear-the-undo-stack-programmatically-to-prevent-undo-ing-of-a-command.html">post</a> on the same subject, someone just pointed out that the CMDECHO=0 is not observed using UNDO via SendStringToExecute(). The initial command pumped is omitted but the command options are not…</p>  <p>The solution is to use my favorite function acedCmd() instead…</p>  <div style="font-family: ; background: white; color: ">   <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">#if</font></font></span><font style="font-size: 8pt" color="#000000"> AC2013</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; [</font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">DllImport</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;accore.dll&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">CallingConvention</font></span><font color="#000000"> = </font><span style="color: "><font color="#2b91af">CallingConvention</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Cdecl</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">EntryPoint</font></span><font color="#000000"> = </font><span style="color: "><font color="#a31515">&quot;acedCmd&quot;</font></span><font color="#000000">)]</font></font></font></p>    <p style="margin: 0px"><span style="color: "><font face="Consolas"><font style="font-size: 8pt" color="#0000ff">#else</font></font></span></p>    <p style="margin: 0px"><span style="color: "><font face="Consolas"><font style="font-size: 8pt" color="#808080">&#160;&#160;&#160; [DllImport(&quot;acad.exe&quot;, CallingConvention = CallingConvention.Cdecl, EntryPoint = &quot;acedCmd&quot;)]</font></font></span></p>    <p style="margin: 0px"><span style="color: "><font face="Consolas"><font style="font-size: 8pt" color="#0000ff">#endif</font></font></span></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">private</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">extern</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">acedCmd</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">System</font></span><font color="#000000">.</font><span style="color: "><font color="#2b91af">IntPtr</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">vlist</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; [</font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">CommandMethod</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;ClearUndoStack&quot;</font></span><font color="#000000">)]</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">ClearUndoStack</font></span><font color="#000000">()</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// remember the cmdecho</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">short</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">cmdecho</font></span><font color="#000000"> = (</font><span style="color: "><font color="#0000ff">short</font></span><font color="#000000">)</font><span style="color: "><font color="#2b91af">Application</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">GetSystemVariable</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;CMDECHO&quot;</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// turn it off</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">Application</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">SetSystemVariable</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;CMDECHO&quot;</font></span><font color="#000000">, 0);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">short</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">undoCtl</font></span><font color="#000000"> = (</font><span style="color: "><font color="#0000ff">short</font></span><font color="#000000">)</font><span style="color: "><font color="#2b91af">Application</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">GetSystemVariable</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;UNDOCTL&quot;</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">isOn</font></span><font color="#000000"> = (</font><span style="color: "><font color="#010001">undoCtl</font></span><font color="#000000"> &amp; 1) == 1;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (!</font><span style="color: "><font color="#010001">isOn</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">isOneCmd</font></span><font color="#000000"> = (</font><span style="color: "><font color="#010001">undoCtl</font></span><font color="#000000"> &amp; 2) == 2;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">isAuto</font></span><font color="#000000"> = (</font><span style="color: "><font color="#010001">undoCtl</font></span><font color="#000000"> &amp; 4) == 4;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">ResultBuffer</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">rb</font></span><font color="#000000"> = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ResultBuffer</font></span><font color="#000000">();</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// RTSTR = 5005</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_.UNDO&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_Control&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_None&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_.UNDO&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">isOneCmd</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_One&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#0000ff">else</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_All&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (!</font><span style="color: "><font color="#010001">isAuto</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_.UNDO&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_Auto&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">TypedValue</font></span><font color="#000000">(5005, </font><span style="color: "><font color="#a31515">&quot;_Off&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// start the insert command</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acedCmd</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">rb</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">UnmanagedObject</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// now restore cmdecho</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">Application</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">SetSystemVariable</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;CMDECHO&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">cmdecho</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; }</font></font></p> </div>
