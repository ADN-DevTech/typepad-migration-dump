---
layout: "post"
title: "Determine product of AutoCAD family"
date: "2012-09-06 03:45:36"
author: "Xiaodong Liang"
categories: []
original_url: "https://adndevblog.typepad.com/autocad/2012/09/determine-product-of-autocad-family.html "
typepad_basename: "determine-product-of-autocad-family"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/xiaodong-liang.html" target="_self">Xiaodong Liang</a></p>  <p><b>Issue</b></p>  <p>When I use an ActiveX client application on a computer that has AutoCAD based products installed, I don't know which 'AutoCAD' I am accessing. Is there a way of determining this?</p>  <p><b>Solution</b></p>  <p>The following code obtains the running (or creates a new instance if none exists) of AutoCAD. Its version is determined by the registry key.</p>  <p>HKEY_CLASSES_ROOT\AutoCAD.Application</p>  <div style="font-family: courier new; background: white; color: black; font-size: 9pt">   <p style="margin: 0px"><span style="line-height: 140%">CComQIPtr&lt;IAcadApplication, &amp;IID_IAcadApplication&gt; gpApp;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">HRESULT startAcad()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; HRESULT hr = S_OK;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; CLSID clsid;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">//get the current version's CLSID</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; hr = CLSIDFromProgID(L</span><span style="line-height: 140%; color: #a31515">&quot;AutoCAD.Application&quot;</span><span style="line-height: 140%">, &amp;clsid);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(FAILED(hr))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> hr;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; CComPtr&lt;IUnknown&gt; pIUnk;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; hr = GetActiveObject(clsid, NULL, &amp;pIUnk);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(!pIUnk)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; hr = CoCreateInstance(clsid, NULL, CLSCTX_LOCAL_SERVER,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; IID_IAcadApplication, (</span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%">**)&amp;gpApp);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">else</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; gpApp = pIUnk;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(FAILED(hr) || !gpApp)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> hr;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; gpApp-&gt;put_Visible(VARIANT_TRUE);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%"> hr;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>&#160;</p>  <p>Therefore, if CoCreateInstance() on the CLSID we got from CLSIDFromProgID() of &quot;AutoCAD.Application&quot; succeeded, we know AutoCAD is running.</p>  <p>The problem is that all the other family products that have an    <br />AutoCAD engine use the same ProID, &quot;AutoCAD.Application&quot; thus one can't tell which family member receives the client's request.     <br />However, each family product has its own Automation Extension with specific interface progID, and it's this information that determines which AutoCAD based program is running.</p>  <p>For example, once you have the IAcadApplication object, you can call its GetInterfaceObject() method.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 9pt">   <p style="margin: 0px"><span style="line-height: 140%">IAcadApplication.GetInterfaceObject(</span><span style="line-height: 140%; color: #a31515">&quot;AutoCADMap.Application&quot;</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%"></span></p>    <p style="margin: 0px"><span style="line-height: 140%"></span></p> </div>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">&#160;</span></p> </div> If it succeeded, the application is AutoCAD Map. if GetInterfaceObject(&quot;Aecc.Application&quot;) succeeded, the application is Architectrual Desktop or Land Development Desktop. if GetInterfaceObject(&quot;Mcad.Application&quot;) succeeded, the application is Mechanical Desktop.
