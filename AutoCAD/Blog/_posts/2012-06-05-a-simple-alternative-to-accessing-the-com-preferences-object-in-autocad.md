---
layout: "post"
title: "A simple alternative to accessing the COM Preferences object in AutoCAD"
date: "2012-06-05 11:57:27"
author: "Fenton Webb"
categories:
  - ".NET"
  - "2010"
  - "2011"
  - "2012"
  - "2013"
  - "AutoCAD"
  - "Fenton Webb"
  - "LISP"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2012/06/a-simple-alternative-to-accessing-the-com-preferences-object-in-autocad.html "
typepad_basename: "a-simple-alternative-to-accessing-the-com-preferences-object-in-autocad"
typepad_status: "Publish"
---

<p>by <a href="http://adndevblog.typepad.com/autocad/fenton-webb.html">Fenton Webb</a></p>  <p>Recently, a developer ran into an issue with some LISP code where he was trying to add multiple paths to the <strong>PrinterStyleSheetPath</strong> property… The code looked something like this:</p>  <p><strong>(defun c:xx()     <br />&#160; (vl-load-com)      <br />&#160; (setq      <br />&#160;&#160;&#160; acad (vlax-get-acad-object)      <br />&#160;&#160;&#160; prefs (vla-get-preferences *acad)      <br />&#160;&#160;&#160; files (vla-get-files prefs)      <br />&#160; )</strong></p>  <p><strong>&#160; (vla-put-PrinterStyleSheetPath files &quot;c:\\fenny;c:\\temp&quot;)     <br />)      <br /></strong></p>  <p>The problem is that behind the scenes, as with other Preference variables, the put-PrinterStyleSheetPath does not handle the semi colon’s and just fails because the path is invalid.</p>  <p>The solution is simply to use getenv and/or setenv. </p>  <p>If you are not familiar with these functions, basically they have a two stage process… First, check the FixedProfile in the registry for the required system setting, and second, if an entry is not found then the Windows System environment is searched.</p>  <p>Here’s the code to set the PrinterStyleSheetPath to multiple paths in LISP…</p>  <p><strong><font face="Consolas">(setenv &quot;PrinterStyleSheetDir&quot; &quot;c:\\fenton;c:\\temp&quot;)</font> </strong></p>  <p>Here’s the code to set the PrinterStyleSheetPath to multiple paths in ARX…</p>  <div style="font-family: ; background: white; color: ">   <p style="margin: 0px"><font face="Consolas"><strong><span style="color: "><font color="#010001"><font style="font-size: 8pt">acedSetEnv</font></font></span><font style="font-size: 8pt"><font color="#000000">(</font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;PrinterStyleSheetDir&quot;</font></span><font color="#000000">), </font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;c:\\fenton;c:\\temp&quot;</font></span><font color="#000000">));</font></font></strong></font></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">Now for .NET, it seems there is no native way to call acedSetEnv()… I can see why that is actually (it’s because the ObjectARX API’s, which .NET is built around, AcDbHostApplicationServices class only exposes a GetEnvironmentVariable(), not a Set) so you will have to PInvoke acedSetEnv… Not difficult, here’s how…</p>    <p style="margin: 0px">&#160;</p>    <div style="font-family: ; background: white; color: ">     <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">[</font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">DllImport</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;acad.exe&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">CallingConvention</font></span><font color="#000000"> = </font><span style="color: "><font color="#2b91af">CallingConvention</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Cdecl</font></span><font color="#000000">, </font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">CharSet</font></span><font color="#000000"> = </font><span style="color: "><font color="#2b91af">CharSet</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Auto</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">EntryPoint</font></span><font color="#000000"> = </font><span style="color: "><font color="#a31515">&quot;acedGetEnv&quot;</font></span><font color="#000000">)]</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">extern</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">private</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Int32</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">acedGetEnv</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">var</font></span><font color="#000000">, </font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [</font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">Out</font></span><font color="#000000">] </font><span style="color: "><font color="#010001">System</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Text</font></span><font color="#000000">.</font><span style="color: "><font color="#2b91af">StringBuilder</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">val</font></span><font color="#000000">);</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">[</font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">DllImport</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;acad.exe&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">CallingConvention</font></span><font color="#000000"> = </font><span style="color: "><font color="#2b91af">CallingConvention</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Cdecl</font></span><font color="#000000">, </font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">CharSet</font></span><font color="#000000"> = </font><span style="color: "><font color="#2b91af">CharSet</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Auto</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">EntryPoint</font></span><font color="#000000"> = </font><span style="color: "><font color="#a31515">&quot;acedSetEnv&quot;</font></span><font color="#000000">)]</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">extern</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">private</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Int32</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">acedSetEnv</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">var</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">val</font></span><font color="#000000">);</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000"><strong>&#160;</strong></font></font></p>   </div>    <div style="font-family: ; background: white; color: ">     <p style="margin: 0px"><span style="color: "><font face="Consolas"><font style="font-size: 8pt" color="#008000"><strong>// test acedGet and acedSetEnv by Fenton Webb, DevTech, 05/06/2012</strong></font></font></span></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">[</font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">CommandMethod</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;testenv&quot;</font></span><font color="#000000">)]</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">static</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">testenv</font></span><font color="#000000">()</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000"><strong>{</strong></font></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">System</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Text</font></span><font color="#000000">.</font><span style="color: "><font color="#2b91af">StringBuilder</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">buf</font></span><font color="#000000"> = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">System</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Text</font></span><font color="#000000">.</font><span style="color: "><font color="#2b91af">StringBuilder</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;&quot;</font></span><font color="#000000">, 1024);</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acedGetEnv</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;PATH&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">buf</font></span><font color="#000000">);</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">buf</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Append</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;;&quot;</font></span><font color="#000000">); </font><span style="color: "><font color="#010001">buf</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Append</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">@&quot;c:\temp&quot;</font></span><font color="#000000">);</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><strong><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acedSetEnv</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;PATH&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">buf</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">ToString</font></span><font color="#000000">());</font></font></strong></font></p>      <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000"><strong>}</strong></font></font></p>   </div> </div>    <p>To finish off, I personally think that one other great advantage of using getenv/acedGetEnv() and setenv/acedSetEnv() instead of the COM Preferences in .NET is that you reduce the need to bring in the COM Interop reference DLLs into your project references – namely <strong>Autodesk.AutoCAD.Interop.dll</strong> and/or <strong>Autodesk.AutoCAD.Interop.Common.dll</strong>. To explain why I’m bringing this up; so when you bring in these DLL’s as references you can no longer rely on the “<strong>Any CPU</strong>” setting in your project build settings working universally across 32bit and 64bit AutoCAD, thus possibly making you have to consider creating separate 32bit and 64bit versions of your application. Don’t worry too much though, it really all depends on which parts of the COM Interop libraries you are using; my advise is, if you are using these COM Interop libs, and you are compiling as “Any CPU” make sure you test your application on both 32bit and 64bit… If it fails, you know you have to create separate 32bit and 64bit versions. If it works, then great!! Actually, a good first test is to simply set your CPU build type to Win32 and recompile, do the same for x64 – if you get any compiler errors, you know you definitely have a problem…</p>
