---
layout: "post"
title: "Clear the UNDO stack programmatically to prevent UNDO-ing of a command"
date: "2012-05-28 04:27:11"
author: "Adam Nagy"
categories:
  - ".NET"
  - "Adam Nagy"
  - "AutoCAD"
original_url: "https://adndevblog.typepad.com/autocad/2012/05/clear-the-undo-stack-programmatically-to-prevent-undo-ing-of-a-command.html "
typepad_basename: "clear-the-undo-stack-programmatically-to-prevent-undo-ing-of-a-command"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/adam-nagy.html" target="_self">Adam Nagy</a></p>  <p>I would like to make sure that the user cannot UNDO beyond a certain command. How could I do that?</p>  <p><a name="section2"></a></p>  <p><b>Solution</b></p>  <p>Although there is no direct UNDO API, you could use the UNDO command to achieve what you need. You could call UNDO with Control &gt; None option to switch UNDO recording off, which will also clear the UNDO stack. Then you can switch it back afterwards, so consecutive commands can be undone.</p>  <p>Since UNDO operates on command borders, it should not really be changed inside a command. Therefore, although UNDO can be called synchronously using acedCommand/acedCmd, it's better to call it through sendStringToExecute which will run it asychronously. In case of the latter, do not forget that the UNDO stack will only be cleared after the command you called it from finished, so that will not be UNDO-able either.</p>  <p>Here is a .NET sample code that implements the above:</p>  <div style="font-family: Courier New; font-size: 8pt; color: black; background: white;"> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> System;</span></p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> Autodesk.AutoCAD.Runtime;</span></p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">using</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">acApp</span><span style="line-height: 140%;"> = Autodesk.AutoCAD.ApplicationServices.</span><span style="color: #2b91af; line-height: 140%;">Application</span><span style="line-height: 140%;">;</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">[</span><span style="color: blue; line-height: 140%;">assembly</span><span style="line-height: 140%;">: </span><span style="color: #2b91af; line-height: 140%;">CommandClass</span><span style="line-height: 140%;">(</span><span style="color: blue; line-height: 140%;">typeof</span><span style="line-height: 140%;">(CsMgdAcad1.</span><span style="color: #2b91af; line-height: 140%;">AEN1Commands</span><span style="line-height: 140%;">))]</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">namespace</span><span style="line-height: 140%;"> CsMgdAcad1</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">{</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">class</span><span style="line-height: 140%;"> </span><span style="color: #2b91af; line-height: 140%;">AEN1Commands</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; {</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: gray; line-height: 140%;">///</span><span style="color: green; line-height: 140%;"> </span><span style="color: gray; line-height: 140%;">&lt;summary&gt;</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: gray; line-height: 140%;">///</span><span style="color: green; line-height: 140%;"> To clear the UNDO stack we need to turn the undo off, then </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: gray; line-height: 140%;">///</span><span style="color: green; line-height: 140%;"> turn it back on. We also make sure that the settings will be </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: gray; line-height: 140%;">///</span><span style="color: green; line-height: 140%;"> changed back to the way they were</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: gray; line-height: 140%;">///</span><span style="color: green; line-height: 140%;"> </span><span style="color: gray; line-height: 140%;">&lt;/summary&gt;</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; [</span><span style="color: #2b91af; line-height: 140%;">CommandMethod</span><span style="line-height: 140%;">(</span><span style="color: #a31515; line-height: 140%;">&quot;Aen1ClearUndo&quot;</span><span style="line-height: 140%;">)]</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> Aen1ClearUndo()</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; {</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">short</span><span style="line-height: 140%;"> undoCtl = (</span><span style="color: blue; line-height: 140%;">short</span><span style="line-height: 140%;">)</span><span style="color: #2b91af; line-height: 140%;">acApp</span><span style="line-height: 140%;">.GetSystemVariable(</span><span style="color: #a31515; line-height: 140%;">&quot;UNDOCTL&quot;</span><span style="line-height: 140%;">);</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> isOn = (undoCtl &amp; 1) == 1;</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (!isOn)</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">return</span><span style="line-height: 140%;">;</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> isOneCmd = (undoCtl &amp; 2) == 2;</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> isAuto = (undoCtl &amp; 4) == 4;</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> cmdString = </span><span style="color: #a31515; line-height: 140%;">&quot;._UNDO _Control _None ._UNDO &quot;</span><span style="line-height: 140%;">;</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (isOneCmd)</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; cmdString += </span><span style="color: #a31515; line-height: 140%;">&quot;_One &quot;</span><span style="line-height: 140%;">;</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">else</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; cmdString += </span><span style="color: #a31515; line-height: 140%;">&quot;_All &quot;</span><span style="line-height: 140%;">;</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (!isAuto)</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmdString += </span><span style="color: #a31515; line-height: 140%;">&quot;._UNDO _Auto _Off &quot;</span><span style="line-height: 140%;">;</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: #2b91af; line-height: 140%;">acApp</span><span style="line-height: 140%;">.DocumentManager.MdiActiveDocument.SendStringToExecute(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; cmdString, </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">, </span><span style="color: blue; line-height: 140%;">false</span><span style="line-height: 140%;">, </span><span style="color: blue; line-height: 140%;">true</span><span style="line-height: 140%;">);</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; }</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; }</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">}</span></p> </div>
