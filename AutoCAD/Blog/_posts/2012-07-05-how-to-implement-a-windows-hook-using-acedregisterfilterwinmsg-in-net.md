---
layout: "post"
title: "How to implement a Windows Hook using acedRegisterFilterWinMsg in .NET"
date: "2012-07-05 06:24:50"
author: "Augusto Goncalves"
categories:
  - ".NET"
  - "Augusto Goncalves"
  - "AutoCAD"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2012/07/how-to-implement-a-windows-hook-using-acedregisterfilterwinmsg-in-net.html "
typepad_basename: "how-to-implement-a-windows-hook-using-acedregisterfilterwinmsg-in-net"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/augusto-goncalves.html">Augusto Goncalves</a></p>
<p>It is possible setup a hook for <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms632590.aspx" target="_blank">Windows Messages</a>, which is a low level event to capture when the system is performing almost any task, such as mouse movement or opening a dialog.</p>
<p>Inside AutoCAD there is a special method to do so, which do not interfere with its built-in behavior, but have the same features: <strong>acedRegisterFilterWinMsg</strong></p>
<p>This method still implemented only on C++, so we need to use the <a href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.dllimportattribute.aspx" target="_blank">DllImport</a> attribute, which you might be familiar. For this specific case, it is also required the decorated name of this <em>aced</em> method, which can be obtained using the <a href="http://adndevblog.typepad.com/autocad/2012/07/decorated-names-with-dependency-walker-tool.html">Dependency Walker tool</a>.</p>
<div style="background: white;">
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// For AutoCAD 2013 64 bit</span></span></span></p>
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// On previous versions, import from acad.exe (instead accore.dll)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">[</span></span><span style="font-size: 8pt;"><span><span style="color: #2b91af;">DllImport</span></span><span style="color: #000000;">(</span><span><span style="color: #a31515;">"accore.dll"</span></span><span style="color: #000000;">, </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; CharSet = </span></span><span style="font-size: 8pt;"><span><span style="color: #2b91af;">CharSet</span></span><span style="color: #000000;">.Unicode, </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; CallingConvention = </span></span><span style="font-size: 8pt;"><span><span style="color: #2b91af;">CallingConvention</span></span><span style="color: #000000;">.Cdecl,</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; EntryPoint = </span></span><span style="font-size: 8pt;"><span><span style="color: #a31515;">"?acedRegisterFilterWinMsg@@YAHQ6AHPEAUtagMSG@@@Z@Z"</span></span><span style="color: #000000;">)]</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">private</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #0000ff;">static</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">extern</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">int</span></span><span style="color: #000000;"> acedRegisterFilterWinMsg(</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; </span></span><span style="font-size: 8pt;"><span><span style="color: #2b91af;">WindowHookProc</span></span><span style="color: #000000;"> callBackFunc);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&nbsp;</span></span></p>
<p style="margin: 0px;"><span><span style="font-family: Courier New;"><span style="color: #008000; font-size: 8pt;">// hook message filter callback function</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">[</span></span><span style="font-size: 8pt;"><span><span style="color: #2b91af;">UnmanagedFunctionPointer</span></span><span style="color: #000000;">(</span><span><span style="color: #2b91af;">CallingConvention</span></span><span style="color: #000000;">.Cdecl)]</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">public</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #0000ff;">delegate</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">int</span></span><span style="color: #000000;"> </span><span><span style="color: #2b91af;">WindowHookProc</span></span><span style="color: #000000;">(</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">ref</span></span><span style="color: #000000;"> System.Windows.Forms.</span><span><span style="color: #2b91af;">Message</span></span><span style="color: #000000;"> msg);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&nbsp;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">private</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #0000ff;">static</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">int</span></span><span style="color: #000000;"> WindowsHook(</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">ref</span></span><span style="color: #000000;"> System.Windows.Forms.</span><span><span style="color: #2b91af;">Message</span></span><span style="color: #000000;"> msg)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">{</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; </span></span><span><span style="color: #008000; font-size: 8pt;">// check the msg struct for whatever we want, </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; </span></span><span><span style="color: #008000; font-size: 8pt;">// like keys, paint messages etc</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">if</span></span><span style="color: #000000;"> (msg.Msg == ???)</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&nbsp; {</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp;&nbsp;&nbsp; </span></span><span><span style="color: #008000; font-size: 8pt;">// do something</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&nbsp; }</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">return</span></span><span style="color: #000000;"> 0;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">}</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&nbsp;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">private</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #0000ff;">static</span></span><span style="color: #000000;"> </span><span><span style="color: #2b91af;">WindowHookProc</span></span><span style="color: #000000;"> callBackFunc = </span><span><span style="color: #0000ff;">null</span></span><span style="color: #000000;">;</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&nbsp;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">[</span></span><span style="font-size: 8pt;"><span><span style="color: #2b91af;">CommandMethod</span></span><span style="color: #000000;">(</span><span><span style="color: #a31515;">"registerHook"</span></span><span style="color: #000000;">)]</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span><span style="color: #0000ff;"><span style="font-size: 8pt;">public</span></span></span><span style="font-size: 8pt;"><span style="color: #000000;"> </span><span><span style="color: #0000ff;">static</span></span><span style="color: #000000;"> </span><span><span style="color: #0000ff;">void</span></span><span style="color: #000000;"> CmdRegisterHook()</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">{</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000;"><span style="font-size: 8pt;">&nbsp; callBackFunc = </span></span><span style="font-size: 8pt;"><span><span style="color: #0000ff;">new</span></span><span style="color: #000000;"> </span><span><span style="color: #2b91af;">WindowHookProc</span></span><span style="color: #000000;">(WindowsHook);</span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">&nbsp; acedRegisterFilterWinMsg(callBackFunc);</span></span></p>
<p style="margin: 0px;"><span style="font-family: Courier New;"><span style="color: #000000; font-size: 8pt;">}</span></span></p>
</div>
