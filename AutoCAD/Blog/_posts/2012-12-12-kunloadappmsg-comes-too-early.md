---
layout: "post"
title: "kUnloadAppMsg comes too early"
date: "2012-12-12 04:48:15"
author: "Augusto Goncalves"
categories:
  - "Augusto Goncalves"
  - "AutoCAD"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2012/12/kunloadappmsg-comes-too-early.html "
typepad_basename: "kunloadappmsg-comes-too-early"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>How do we do some cleanup when my application is unloaded, such as closing database connections? The <strong>kUnloadAppMsg</strong> comes too early: my custom entities need this connection during <strong>dwgOutFields</strong> and <strong>kUnloadAppMsg</strong> is sent before the custom entities are saved.</p>  <p>Actually the application is not unloaded before the custom objects are all saved - it is only the <strong>kUnloadAppMsg</strong> that comes too early. The solution is to use some other code that can be executed when the ARX is being unloaded. The easiest place is the destructor of a global object. DLL files written in C++ construct their global class variables as the first thing when the DLL is loaded and destruct these variables just before the DLL is unloaded from memory.</p>  <p>Therefore, one solution is to have something like the following code in your ARX application:</p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">class</font></font></span><font style="font-size: 8pt" color="#000000"> CLoadUnload         <br /></font></font><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; CLoadUnload()</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//this will be called during loading</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; ~CLoadUnload()</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//this will be called just before unloading</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//long after kUnloadAppMsg - add any clean-up code here</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">//declare a global instance of this class in your ARX</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">CLoadUnload gTheWatcher;</font></font></p> </div>
