---
layout: "post"
title: "Using ReadDwgFile with .NET AttachXRef or ObjectARX acdbAttachXRef"
date: "2012-07-16 16:02:31"
author: "Fenton Webb"
categories:
  - ".NET"
  - "2010"
  - "2011"
  - "2012"
  - "2013"
  - "AutoCAD"
  - "Fenton Webb"
  - "ObjectARX"
  - "RealDWG"
original_url: "https://adndevblog.typepad.com/autocad/2012/07/using-readdwgfile-with-net-attachxref-or-objectarx-acdbattachxref.html "
typepad_basename: "using-readdwgfile-with-net-attachxref-or-objectarx-acdbattachxref"
typepad_status: "Publish"
---

<p>by <a href="http://adndevblog.typepad.com/autocad/fenton-webb.html">Fenton Webb</a></p>  <p>Some tips when using Database.ReadDwgFile() or AcDbDatabase::readDwgFile() in order to add an XRef to a side Database/AcDbDatabase…</p>  <p>1) Whenever you use Database.ReadDwgFile() with AttachXref, never set the Database constructor with (buildDefaultDWG=True, noDocument=False) Database(True, False)</p>  <p>For a start, building a default DWG file when the next thing you do is read one that already exists is of course very inefficient, but when using AttachXref, you will probably get an ePermanentlyErased error (due to the incorrect use of the Database constructor) stopping the the AttachXref from working. </p>  <p>The noDocument parameter is intended to indicate that the Database DWG file has no associated Document window (like it would in AutoCAD) – so when reading a side database with ReadDwgFile it’s a good idea to set this to True so that the document handlers know to exclude this DWG Database, making it very quick to process. The downside to setting noDocument=True is that it bypasses the setup internal document functionality, like document locking and UNDO filing – this means that Transactions won’t work, so you will have to use Open/Close or StartOpenCloseTransaction instead of StartTransaction.</p>  <p>2) Always call Database.CloseInput() after a call to ReadDwgFile(). Calling CloseInput() ensures that the whole DWG file is read, and that no caching happens. It also releases the input file so that you can SaveAs() over the existing file.</p>  <p>3) When dealing with side databases, you may receive a eWrongDatabase error or AutoCAD may crash when disposing/freeing your Database/AcDbDatabase. This happens when AutoCAD is not expecting to be dealing with a database that is not associated with its current database list, or when AutoCAD wrongly decides that your side database is actually associated with its database list thus keeping a reference to the database. If this happens, you can set the working database yourself, but be *very careful* – make sure you set and reset the working database only where you need to do it, keep the redirection short and sweet and never forget to set it back. </p>  <p>Here’s a VB.NET example which shows what I am talking about</p>  <div style="font-family: ; background: white; color: ">   <p style="margin: 0px"><span style="color: "><font face="Consolas"><font style="font-size: 8pt" color="#008000">' test code to show how to use AttachXref with Database.ReadDwgFile</font></font></span></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&lt;</font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">Autodesk</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">AutoCAD</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Runtime</font></span><font color="#000000">.</font><span style="color: "><font color="#2b91af">CommandMethod</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;testXref&quot;</font></span><font color="#000000">)&gt; _</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">Public</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span style="color: "><font color="#0000ff">Sub</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">testXref</font></span><font color="#000000">()</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">' save old database</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">Dim</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">oldDb</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">As</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Database</font></span><font color="#000000"> = </font><span style="color: "><font color="#2b91af">HostApplicationServices</font></span><font color="#000000">.</font></font><span style="color: "><font style="font-size: 8pt" color="#010001">WorkingDatabase</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">' when using ReadDwgFile, never specify True to buildDefaultDwg </font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">' also, set noDocument=True because this drawing has no </font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">' AutoCAD Document associated with it </font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">Using</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">db</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">As</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">New</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Database</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">False</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">True</font></span><font color="#000000">)</font></font></font><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">db</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">ReadDwgFile</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;c:\temp\fenton.dwt&quot;</font></span><font color="#000000">,</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">FileOpenMode</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">OpenForReadAndWriteNoShare</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">True</font></span><font color="#000000">, </font><span style="color: "><font color="#a31515">&quot;&quot;</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">' closing the input makes sure the whole dwg is read from disk</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">' it also closes the file so you can SaveAs the same name</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">db</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">CloseInput</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">True</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">' now attach my xref</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">Dim</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">XrefObject</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">As</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">ObjectId</font></span><font color="#000000"> = </font><span style="color: "><font color="#2b91af">db</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">AttachXref</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;c:\temp\test.dwg&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#a31515">&quot;test&quot;</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>   <font face="Consolas"><font color="#000000"><font style="font-size: 8pt">         <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt"></font></font><span style="color: "><font style="font-size: 8pt" color="#008000">&#160;&#160;&#160; ' ok time to set the working database</font></span></font></p>          <p style="margin: 0px">&#160;&#160;&#160; </p>       </font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">HostApplicationServices</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">WorkingDatabase</font></span><font color="#000000"> = </font></font><span style="color: "><font style="font-size: 8pt" color="#010001">db</font></span></font></font>     <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">Using</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">br</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">As</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">New</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">BlockReference</font></span><font color="#000000">(</font><span style="color: "><font color="#0000ff">New</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">Point3d</font></span><font color="#000000">(0, 0, 0), </font><span style="color: "><font color="#010001">XrefObject</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">br</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">SetDatabaseDefaults</font></span><font color="#000000">()</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">br</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Layer</font></span><font color="#000000"> = </font></font><span style="color: "><font style="font-size: 8pt" color="#a31515">&quot;0&quot;</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">Using</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">bt</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">As</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">BlockTable</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">db</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">BlockTableId</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Open</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">OpenMode</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">ForRead</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">Using</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">ModelSpace</font></span><font color="#000000"> </font><span style="color: "><font color="#0000ff">As</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">BlockTableRecord</font></span><font color="#000000"> =</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">bt</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">BlockTableRecord</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">ModelSpace</font></span><font color="#000000">).</font><span style="color: "><font color="#010001">Open</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">OpenMode</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">ForWrite</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">ModelSpace</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">AppendEntity</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">br</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">End</font></span><font color="#000000"> </font></font><span style="color: "><font style="font-size: 8pt" color="#0000ff">Using</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">End</font></span><font color="#000000"> </font></font><span style="color: "><font style="font-size: 8pt" color="#0000ff">Using</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">End</font></span><font color="#000000"> </font></font><span style="color: "><font style="font-size: 8pt" color="#0000ff">Using</font></span></font></p>   <font face="Consolas"><font color="#000000"><font style="font-size: 8pt">         <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt"></font></font><span style="color: "><font style="font-size: 8pt" color="#008000">&#160;&#160;&#160; ' reset it back ASAP</font></span></font></p>          <p style="margin: 0px"><font face="Consolas"><span style="color: "></span></font>&#160;&#160;&#160; </p>       </font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">HostApplicationServices</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">WorkingDatabase</font></span><font color="#000000"> = </font></font><span style="color: "><font style="font-size: 8pt" color="#010001">oldDb</font></span></font><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></font>     <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#2b91af">db</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">SaveAs</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;c:\temp\dwgs\XrefTest.dwg&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#2b91af">DwgVersion</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">Current</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">End</font></span><font color="#000000"> </font></font><span style="color: "><font style="font-size: 8pt" color="#0000ff">Using</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">End</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font></font><span style="color: "><font style="font-size: 8pt" color="#0000ff">Sub</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p> </div>
