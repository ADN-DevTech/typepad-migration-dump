---
layout: "post"
title: "Adding Field to Text Programmatically"
date: "2015-03-09 22:55:00"
author: "Madhukar Moogala"
categories:
  - "2015"
  - "AutoCAD"
  - "Madhukar Moogala"
original_url: "https://adndevblog.typepad.com/autocad/2015/03/adding-field-to-text-programmatically.html "
typepad_basename: "adding-field-to-text-programmatically"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/Madhukar-Moogala.html" target="_self">Madhukar Moogala</a></p>  <p>We will see in this blog how can we set the contents of a AcDbText entity to a field linking to contents of another AcDbText.</p>  <p>Two APIs to be noted here,</p>  <ol>   <li>AcFdMakeFieldCode, formats an object property field code using the specified components. </li>    <li>acdbEvaluateFields,evaluates all the fields in the objects in the database, similar to UpdateFields in the UI. </li> </ol>  <div style="font-size: 9pt; font-family: consolas; background: white; color: black">   <p style="margin: 0px"><span style="color: #2b91af">CString</span> sPrompt(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;\nSelect entity: &quot;</span>));</p>    <p style="margin: 0px"><span style="color: #2b91af">ads_name</span>&#160; an;</p>    <p style="margin: 0px"><span style="color: #2b91af">ads_point</span> ap;</p>    <p style="margin: 0px"><span style="color: blue">int</span> nReturn = acedEntSel(sPrompt, an, ap);</p>    <p style="margin: 0px"><span style="color: green">// Canceled or nothing selected</span></p>    <p style="margin: 0px"><span style="color: blue">if</span> (nReturn == <span style="color: #6f008a">RTCAN</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">// Convert ads name to object id</span></p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbObjectId</span> id;</p>    <p style="margin: 0px">acdbGetObjectId(id, an);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcTransaction</span>* pTrans = <span style="color: #6f008a">acdbTransactionManager</span>-&gt;startTransaction();</p>    <p style="margin: 0px"><span style="color: blue">if</span> (<span style="color: #6f008a">NULL</span> == pTrans)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbText</span>* pExistingText = <span style="color: #6f008a">NULL</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">Acad</span>::<span style="color: #2b91af">ErrorStatus</span> es = <span style="color: #6f008a">acdbTransactionManager</span>-&gt;getObject((<span style="color: #2b91af">AcDbObject</span>*&amp;)pExistingText, id, <span style="color: #2b91af">AcDb</span>::<span style="color: #2f4f4f">kForRead</span>);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!<span style="color: #6f008a">eOkVerify</span>(es))</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #6f008a">acdbTransactionManager</span>-&gt;abortTransaction();</p>    <p style="margin: 0px">acedPrompt(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;\nNot a text&quot;</span>));</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbText</span>* pText = <span style="color: blue">new</span> <span style="color: #2b91af">AcDbText</span>();</p>    <p style="margin: 0px">pText-&gt;setPosition(</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGePoint3d</span>(pExistingText-&gt;position().x,</p>    <p style="margin: 0px">pExistingText-&gt;position().y+20.00,</p>    <p style="margin: 0px">pExistingText-&gt;position().z));</p>    <p style="margin: 0px"><span style="color: #2b91af">ads_name</span> objName;</p>    <p style="margin: 0px">acdbGetAdsName(objName, id);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">ACHAR</span>* strField;</p>    <p style="margin: 0px">AcFdMakeFieldCode(id,(<span style="color: #2b91af">AcDbEvalNodeId</span>)0,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;TextString&quot;</span>),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcFdEval::<span style="color: #2f4f4f">kObjFieldNone</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;&quot;</span>),</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">AcHyperlink</span>*)<span style="color: #6f008a">NULL</span>,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: #2b91af">ACHAR</span>*&amp;)strField); </p>    <p style="margin: 0px">pText-&gt;setTextString(strField); </p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbBlockTableRecord</span>* pModelSpace = <span style="color: #6f008a">NULL</span>;</p>    <p style="margin: 0px">es = <span style="color: #6f008a">acdbTransactionManager</span>-&gt;getObject((<span style="color: #2b91af">AcDbObject</span>*&amp;)pModelSpace,</p>    <p style="margin: 0px">acdbSymUtil()-&gt;blockModelSpaceId(</p>    <p style="margin: 0px">acdbHostApplicationServices()-&gt;workingDatabase()),</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDb</span>::<span style="color: #2f4f4f">kForWrite</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!<span style="color: #6f008a">eOkVerify</span>(es))</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #6f008a">acdbTransactionManager</span>-&gt;abortTransaction();</p>    <p style="margin: 0px">acedPrompt(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;\nCannot open model space.&quot;</span>));</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbObjectId</span> outId;</p>    <p style="margin: 0px">es = pModelSpace-&gt;appendAcDbEntity(outId, pText);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!<span style="color: #6f008a">eOkVerify</span>(es))</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #6f008a">acdbTransactionManager</span>-&gt;abortTransaction();</p>    <p style="margin: 0px">acedPrompt(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;\nCannot append new entity.&quot;</span>));</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">pText-&gt;close();</p>    <p style="margin: 0px"><span style="color: green">/*Update Fields*/</span></p>    <p style="margin: 0px">es = acdbEvaluateFields(outId,</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbField</span>::<span style="color: #2f4f4f">kRegen</span>,</p>    <p style="margin: 0px"><span style="color: #6f008a">NULL</span>,</p>    <p style="margin: 0px">acdbHostApplicationServices()-&gt;workingDatabase(),</p>    <p style="margin: 0px"><span style="color: #2b91af">AcFd</span>::<span style="color: #2f4f4f">kEvalRecursive</span>);</p>    <p style="margin: 0px"><span style="color: blue">if</span>(!<span style="color: #6f008a">eOkVerify</span>(es))</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #2b91af">CString</span> esText = acadErrorStatusText(es);</p>    <p style="margin: 0px">esText = esText + <span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;: Failed to Evalute&quot;</span>);</p>    <p style="margin: 0px">acedAlert(esText);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: green">/*Clean Up*/</span></p>    <p style="margin: 0px">acutDelString(strField);</p>    <p style="margin: 0px"><span style="color: #6f008a">acdbTransactionManager</span>-&gt;endTransaction();</p> </div>
