---
layout: "post"
title: "Decomposing Material Mapper Transform Matrix"
date: "2014-08-20 10:28:47"
author: "Madhukar Moogala"
categories: []
original_url: "https://adndevblog.typepad.com/autocad/2014/08/decomposing-material-mapper-transform-matrix.html "
typepad_basename: "decomposing-material-mapper-transform-matrix"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/Madhukar-Moogala.html" target="_self">Madhukar Moogala</a></p>  <p><strong>Question</strong>: Is it possible to return origin, rotation, the x-y- scale factors and offset values from the Matrix3d of&#0160; MaterialMapper.Transform ?</p>  <p><strong>Answer</strong>: Yes ,it is possible to retrieve details from&#0160; transform matrix of an Entity&#39;s material mapper , I have demonstrate below assuming user has selected a 3DFace entity on which Material is applied using MaterialMap command iteractively and adjusted rotation ,offset and scale as per user needs.</p>  <p>Somethink like this as shown in below screenshot.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a73e055851970d-pi"><img alt="3DFACE_MAP" border="0" height="244" src="/assets/image_371101.jpg" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" title="3DFACE_MAP" width="131" /></a></p>  <p>Note : If AcGiMapper::autoTransform() is set to kObject or kModel, then you will not be able to recover the scale/translation/rotation, as the GS will dynamically compute it based on whatever entity/selection the mapper is applied to.</p>  <p>C++ Code :</p>  <div style="font-size: 9pt; font-family: consolas; background: white; color: black">   <p style="margin: 0px"><span style="color: blue">static</span> <span style="color: blue">void</span> ASDKMyGroupTestMapper()</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #2b91af">Acad</span>::<span style="color: #2b91af">ErrorStatus</span> es;</p>    <p style="margin: 0px"><span style="color: #2b91af">ads_name</span> entres;</p>    <p style="margin: 0px"><span style="color: #2b91af">ads_point</span> ptres;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGeVector3d</span> scale;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGeVector3d</span> rotation;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGeVector3d</span> translate;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGeMatrix3d</span> mat;</p>    <p style="margin: 0px"><span style="color: green">/*Select Entity*/</span></p>    <p style="margin: 0px"><span style="color: blue">if</span>(<span style="color: #6f008a">RTNORM</span> != acedEntSel(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;Select 3DFace entity&quot;</span>),entres,ptres))</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbObjectId</span> objId = <span style="color: #2b91af">AcDbObjectId</span>::kNull;</p>    <p style="margin: 0px"><span style="color: blue">if</span>((es = acdbGetObjectId(objId,entres) ) != <span style="color: #2b91af">Acad</span>::<span style="color: #2f4f4f">eOk</span>)</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbEntity</span>* pFaceEntity = <span style="color: #6f008a">NULL</span>;</p>    <p style="margin: 0px"><span style="color: blue">if</span> ((es = acdbOpenAcDbEntity(pFaceEntity,objId,<span style="color: #2b91af">AcDb</span>::<span style="color: #2f4f4f">kForRead</span>) )</p>    <p style="margin: 0px">!= <span style="color: #2b91af">Acad</span>::<span style="color: #2f4f4f">eOk</span>) <span style="color: blue">return</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">if</span>(pFaceEntity-&gt;isA() == <span style="color: #2b91af">AcDbFace</span>::desc())</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbFace</span>* pFace =&#0160; <span style="color: #2b91af">AcDbFace</span>::cast(pFaceEntity);</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGiMapper</span> mapper;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDbMaterial</span>* material = <span style="color: #6f008a">NULL</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGiMaterialMap</span> materialMap;</p>    <p style="margin: 0px"><span style="color: blue">if</span>((es = acdbOpenObject((<span style="color: #2b91af">AcDbObject</span>*&amp;)material,pFace-&gt;materialId(),</p>    <p style="margin: 0px"><span style="color: #2b91af">AcDb</span>::<span style="color: #2f4f4f">kForRead</span>))!= <span style="color: #2b91af">Acad</span>::<span style="color: #2f4f4f">eOk</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">pFaceEntity-&gt;close();</p>    <p style="margin: 0px"><span style="color: blue">return</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">double</span> strength=0.0;</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGiMaterialColor</span> color;</p>    <p style="margin: 0px"><span style="color: green">/*Get diffuse gives details about Texture in general,</span></p>    <p style="margin: 0px"><span style="color: green">and what component to be used to retrieve materialmap</span></p>    <p style="margin: 0px"><span style="color: green">can be found from AcDbMaterial::channelFlags*/</span>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </p>    <p style="margin: 0px">material-&gt;diffuse(color,materialMap);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">mat = materialMap.mapper().transform();</p>    <p style="margin: 0px"><span style="color: blue">if</span>(materialMap.mapper().autoTransform() &lt; 2)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">decomposeMatrix(mat,scale,rotation,translate);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">pFaceEntity-&gt;close();</p>    <p style="margin: 0px">material-&gt;close();</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">acutPrintf(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;\n Rotation Angle : %2f \n&quot;</span>),rotation.z*(180/<span style="color: #6f008a">M_PI</span>));</p>    <p style="margin: 0px">acutPrintf(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;\n Scale X : %2f , Scale Y : %2f \n&quot;</span>),scale.x,scale.y);</p>    <p style="margin: 0px"><span style="color: green">/*You may have to negate offset values of Translate vector for correct sign*/</span></p>    <p style="margin: 0px">acutPrintf(<span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;\n Translation Vector: %2f,%2f \n&quot;</span>),-translate.x,-translate.y);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">static</span> <span style="color: blue">void</span> decomposeMatrix (<span style="color: blue">const</span> <span style="color: #2b91af">AcGeMatrix3d</span> &amp;<span style="color: gray">mat</span>,</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGeVector3d</span> &amp;<span style="color: gray">scale</span>,</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGeVector3d</span> &amp;<span style="color: gray">rotate</span>,</p>    <p style="margin: 0px"><span style="color: #2b91af">AcGeVector3d</span> &amp;<span style="color: gray">translate</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: green">// Scale - assume always positive, and must be non-zero</span></p>    <p style="margin: 0px"><span style="color: gray">scale</span>.x = 1.0/<span style="color: #2b91af">AcGeVector3d</span>(<span style="color: gray">mat</span>(0,0), <span style="color: gray">mat</span>(0,1), <span style="color: gray">mat</span>(0,2)).length();</p>    <p style="margin: 0px"><span style="color: gray">scale</span>.y = 1.0/<span style="color: #2b91af">AcGeVector3d</span>(<span style="color: gray">mat</span>(1,0), <span style="color: gray">mat</span>(1,1), <span style="color: gray">mat</span>(1,2)).length();</p>    <p style="margin: 0px"><span style="color: gray">scale</span>.z = 1.0/<span style="color: #2b91af">AcGeVector3d</span>(<span style="color: gray">mat</span>(2,0), <span style="color: gray">mat</span>(2,1), <span style="color: gray">mat</span>(2,2)).length();</p>    <p style="margin: 0px"><span style="color: blue">if</span> (<span style="color: gray">scale</span>.x == 0.0)</p>    <p style="margin: 0px"><span style="color: gray">scale</span>.x = 1.0;</p>    <p style="margin: 0px"><span style="color: blue">if</span> (<span style="color: gray">scale</span>.y == 0.0)</p>    <p style="margin: 0px"><span style="color: gray">scale</span>.y = 1.0;</p>    <p style="margin: 0px"><span style="color: blue">if</span> (<span style="color: gray">scale</span>.z == 0.0)</p>    <p style="margin: 0px"><span style="color: gray">scale</span>.z = 1.0;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// Translation</span></p>    <p style="margin: 0px"><span style="color: gray">translate</span> =&#0160; <span style="color: gray">mat</span>.translation();</p>    <p style="margin: 0px"><span style="color: gray">translate</span>.x *= <span style="color: gray">scale</span>.x;</p>    <p style="margin: 0px"><span style="color: gray">translate</span>.y *= <span style="color: gray">scale</span>.y;</p>    <p style="margin: 0px"><span style="color: gray">translate</span>.z *= <span style="color: gray">scale</span>.z;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">// Rotation – assume only rotation about the Z axis</span></p>    <p style="margin: 0px"><span style="color: blue">double</span> acosVal = <span style="color: gray">mat</span>(0,0) / <span style="color: gray">scale</span>.x;</p>    <p style="margin: 0px"><span style="color: blue">if</span> (acosVal &gt; 1.0)</p>    <p style="margin: 0px">acosVal = 1.0;</p>    <p style="margin: 0px"><span style="color: blue">else</span> <span style="color: blue">if</span> (acosVal &lt; -1.0)</p>    <p style="margin: 0px">acosVal = -1.0;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">double</span> zAngle = acos(acosVal);</p>    <p style="margin: 0px"><span style="color: #6f008a">assert</span>(0.0 &lt;= zAngle &amp;&amp; zAngle &lt;= <span style="color: #6f008a">M_PI</span>);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (<span style="color: gray">mat</span>(0, 1) &gt; 0.0)</p>    <p style="margin: 0px">zAngle = 2.0 * <span style="color: #6f008a">M_PI</span> - zAngle;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: gray">rotate</span>.x = 0.0;</p>    <p style="margin: 0px"><span style="color: gray">rotate</span>.y = 0.0;</p>    <p style="margin: 0px"><span style="color: gray">rotate</span>.z = zAngle;</p>    <p style="margin: 0px">}</p> </div>  <p>C# .NET code :</p>  <div style="font-size: 9pt; font-family: consolas; background: white; color: black">   <p style="margin: 0px">[<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;TestMapper&quot;</span>)]</p>    <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> Mappertest()</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #2b91af">Document</span> activeDoc = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument;</p>    <p style="margin: 0px"><span style="color: #2b91af">Database</span> db = activeDoc.Database;</p>    <p style="margin: 0px"><span style="color: #2b91af">Editor</span> ed = activeDoc.Editor;</p>    <p style="margin: 0px"><span style="color: #2b91af">PromptEntityResult</span> oRes = ed.GetEntity(<span style="color: #a31515">&quot;Select 3dFace&quot;</span>);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (oRes.Status != <span style="color: #2b91af">PromptStatus</span>.OK) <span style="color: blue">return</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">Vector3d</span> scale = <span style="color: blue">default</span>(<span style="color: #2b91af">Vector3d</span>);</p>    <p style="margin: 0px"><span style="color: #2b91af">Vector3d</span> rotate = <span style="color: blue">default</span>(<span style="color: #2b91af">Vector3d</span>);</p>    <p style="margin: 0px"><span style="color: #2b91af">Vector3d</span> translate = <span style="color: blue">default</span>(<span style="color: #2b91af">Vector3d</span>);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">using</span> (<span style="color: #2b91af">Transaction</span> oTrans = db.TransactionManager.StartTransaction())</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #2b91af">Face</span> oFace = oTrans.GetObject(oRes.ObjectId, <span style="color: #2b91af">OpenMode</span>.ForRead) <span style="color: blue">as</span> <span style="color: #2b91af">Face</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">if</span> (oFace != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">string</span> strMat = oFace.Material;</p>    <p style="margin: 0px"><span style="color: #2b91af">ObjectId</span> nMat = oFace.MaterialId;</p>    <p style="margin: 0px"><span style="color: #2b91af">Material</span> material = oTrans.GetObject(nMat,<span style="color: #2b91af">OpenMode</span>.ForRead) <span style="color: blue">as</span> <span style="color: #2b91af">Material</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">ChannelFlags</span> cFlasg = material.ChannelFlags;</p>    <p style="margin: 0px"><span style="color: #2b91af">MaterialDiffuseComponent</span> mDC = material.Diffuse;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </p>    <p style="margin: 0px"><span style="color: #2b91af">MaterialMap</span> materialMap = mDC.Map;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </p>    <p style="margin: 0px"><span style="color: #2b91af">Matrix3d</span> tranform = materialMap.Mapper.Transform;</p>    <p style="margin: 0px"><span style="color: blue">double</span> scaleD = tranform.GetScale();&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; </p>    <p style="margin: 0px"><span style="color: blue">if</span> (materialMap.Mapper.AutoTransform == <span style="color: #2b91af">AutoTransform</span>.InheritAutoTransform ||</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; materialMap.Mapper.AutoTransform == <span style="color: #2b91af">AutoTransform</span>.None)</p>    <p style="margin: 0px">DecomposeMatrix(tranform , <span style="color: blue">ref</span> scale, <span style="color: blue">ref</span> rotate, <span style="color: blue">ref</span> translate);</p>    <p style="margin: 0px"><span style="color: green">/*You have negate offset value to reflect correct sign*/</span></p>    <p style="margin: 0px">ed.WriteMessage(<span style="color: #a31515">&quot;Rotation Angle : &quot;</span> + rotate.Z * (180 / <span style="color: #2b91af">Math</span>.PI) + <span style="color: #a31515">&quot;\n&quot;</span></p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; + <span style="color: #a31515">&quot;Scale X :&quot;</span> + <span style="color: #2b91af">Math</span>.Round(scale.X) + <span style="color: #a31515">&quot; Scale Y : &quot;</span> + <span style="color: #2b91af">Math</span>.Round(scale.Y) + <span style="color: #a31515">&quot;\n&quot;</span> +</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #a31515">&quot;Translation Vector offset Values :&quot;</span> + -translate.X + <span style="color: #a31515">&quot;,&quot;</span> + -translate.Y);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">oTrans.Commit();</p>    <p style="margin: 0px">} </p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> DecomposeMatrix( <span style="color: #2b91af">Matrix3d</span> mat, <span style="color: blue">ref</span> <span style="color: #2b91af">Vector3d</span> scale, <span style="color: blue">ref</span> <span style="color: #2b91af">Vector3d</span> rotate, <span style="color: blue">ref</span> <span style="color: #2b91af">Vector3d</span> translate)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: green">// Scale - assume always positive, and must be non-zero</span></p>    <p style="margin: 0px"><span style="color: #2b91af">Vector3d</span> v3dOne= <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(mat[0, 0], mat[0, 1], mat[0, 2]);</p>    <p style="margin: 0px"><span style="color: #2b91af">Vector3d</span> v3dTwo = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(mat[1, 0], mat[1, 1], mat[1, 2]);</p>    <p style="margin: 0px"><span style="color: #2b91af">Vector3d</span> v3dThree = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(mat[2, 0], mat[2, 1], mat[2, 2]);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: green">//&#0160;&#0160;&#0160; scale = new Vector3d(v3dOne.Length, v3dTwo.Length, v3dThree.Length);</span></p>    <p style="margin: 0px">scale = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(1/v3dOne.Length, 1/v3dTwo.Length, 1/v3dThree.Length);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (scale.X == 0)</p>    <p style="margin: 0px">scale = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(1.0, scale.Y, scale.Z);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (scale.Y == 0)</p>    <p style="margin: 0px">scale = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(scale.X, 1.0, scale.Z);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (scale.Z == 0)</p>    <p style="margin: 0px">scale = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(scale.X, scale.Y, 1.0);</p>    <p style="margin: 0px"><span style="color: green">// Translation</span></p>    <p style="margin: 0px">translate = mat.Translation;</p>    <p style="margin: 0px">translate = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(translate.X * <span style="color: #2b91af">Math</span>.Round(scale.X), translate.Y*<span style="color: #2b91af">Math</span>.Round(scale.Y), translate.Z*<span style="color: #2b91af">Math</span>.Round(scale.Z));</p>    <p style="margin: 0px"><span style="color: green">// Rotation – assume only rotation about the Z axis</span></p>    <p style="margin: 0px"><span style="color: blue">double</span> acosValue = mat[0, 0] / scale.X;</p>    <p style="margin: 0px"><span style="color: blue">if</span> (acosValue &gt; 1.0)</p>    <p style="margin: 0px">acosValue = 1.0;</p>    <p style="margin: 0px"><span style="color: blue">else</span> <span style="color: blue">if</span> (acosValue &lt; -1.0)</p>    <p style="margin: 0px">acosValue = -1.0;</p>    <p style="margin: 0px"><span style="color: blue">double</span> zAngle = <span style="color: #2b91af">Math</span>.Acos(acosValue);</p>    <p style="margin: 0px"><span style="color: #2b91af">Debug</span>.Assert(0.0 &lt;= zAngle &amp;&amp; zAngle &lt;= <span style="color: #2b91af">Math</span>.PI);</p>    <p style="margin: 0px"><span style="color: blue">if</span>(mat[0,1] &gt; 0.0)</p>    <p style="margin: 0px">zAngle = 2.0 * <span style="color: #2b91af">Math</span>.PI - zAngle;</p>    <p style="margin: 0px">rotate = <span style="color: blue">new</span> <span style="color: #2b91af">Vector3d</span>(0.0, 0.0, zAngle);</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px">}</p> </div>  <p>Output :</p>  <p>Rotation Angle : 60.0000016696521</p>  <p>Scale X :1 Scale Y : 2</p>  <p>Translation Vector offset Values :12,15</p>
