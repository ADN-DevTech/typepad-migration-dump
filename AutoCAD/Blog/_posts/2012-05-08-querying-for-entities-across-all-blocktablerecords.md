---
layout: "post"
title: "Querying for entities across all BlockTableRecords"
date: "2012-05-08 13:34:55"
author: "Madhukar Moogala"
categories:
  - ".NET"
  - "2013"
  - "AutoCAD"
  - "Stephen Preston"
original_url: "https://adndevblog.typepad.com/autocad/2012/05/querying-for-entities-across-all-blocktablerecords.html "
typepad_basename: "querying-for-entities-across-all-blocktablerecords"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/stephen-preston.html">Stephen Preston</a></p>  <p>In a comment to a <a href="http://adndevblog.typepad.com/autocad/2012/05/redefining-a-block.html">previous post of mine</a>, Viktor K asked:</p>  <blockquote>   <p>Is there a method in .net api to search for a text string in the entire file and return values from dbtext, mtext, attributes, cells, etc... Basically how &quot;find&quot; command searches. I would imagine that you'd get objectids back of all the entities found with that text string. Or even better a find/replace functionality?</p> </blockquote>  <p>Doing that isn’t particularly easy, because the text entity could be in any BlockTableRecord in the drawing. Whatever approach you use, it ultimately results in AutoCAD iterating through every entity in every BlockTableRecord in the BlockTable. This will always be a slow process, which is why the AutoCAD <a href="http://blog.jtbworld.com/2011/04/autocad-content-explorer.html">Content Explorer</a> feature (for example) indexes drawings in the background for speedy searching.</p>  <p>Last night, I took Viktor’s question as an excuse to go back and play with some of my experimental LINQ samples that <a href="http://through-the-interface.typepad.com/through_the_interface/2012/02/dynamic-net-in-autocad-2013.html">Kean posted on his blog</a>. As a result, here is a simple C# routine that returns all the DBText, Mtext, and AttributeDefinitions in a drawing that contain a particular string. This is only a partial answer to Viktor’s question, but a nice start:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; [</span><span style="line-height: 140%; color: #2b91af">CommandMethod</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #a31515">&quot;FINDTEXT&quot;</span><span style="line-height: 140%">)]</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">public</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> FindText()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Database</span><span style="line-height: 140%"> db = </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument.Database;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: #2b91af">Editor</span><span style="line-height: 140%"> ed = </span><span style="line-height: 140%; color: #2b91af">Application</span><span style="line-height: 140%">.DocumentManager.MdiActiveDocument.Editor;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">dynamic</span><span style="line-height: 140%"> bt = db.BlockTableId;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">string</span><span style="line-height: 140%"> str = </span><span style="line-height: 140%; color: #a31515">&quot;ABC&quot;</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">var</span><span style="line-height: 140%"> textEnts = </span><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> btrs </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">IEnumerable</span><span style="line-height: 140%">&lt;</span><span style="line-height: 140%; color: blue">dynamic</span><span style="line-height: 140%">&gt;)bt</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">from</span><span style="line-height: 140%"> ent </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">IEnumerable</span><span style="line-height: 140%">&lt;</span><span style="line-height: 140%; color: blue">dynamic</span><span style="line-height: 140%">&gt;)btrs</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">where</span><span style="line-height: 140%"> </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ((ent.IsKindOf(</span><span style="line-height: 140%; color: blue">typeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">DBText</span><span style="line-height: 140%">)) &amp;&amp; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (ent.TextString.Contains(str))) || </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (ent.IsKindOf(</span><span style="line-height: 140%; color: blue">typeof</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: #2b91af">MText</span><span style="line-height: 140%">)) &amp;&amp; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (ent.Contents.Contains(str))))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">select</span><span style="line-height: 140%"> ent;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">foreach</span><span style="line-height: 140%"> (</span><span style="line-height: 140%; color: #2b91af">ObjectId</span><span style="line-height: 140%"> qEnt </span><span style="line-height: 140%; color: blue">in</span><span style="line-height: 140%"> textEnts)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ed.WriteMessage(</span><span style="line-height: 140%; color: #a31515">&quot;\n&quot;</span><span style="line-height: 140%"> + qEnt.ToString());</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p> </div>  <p>And now I’ve shown you the code, here are some health warnings:</p>  <ul>   <li>This code uses <a href="http://adndevblog.typepad.com/autocad/2012/04/dynamicnet-api-for-autocad-2013.html">Dynamic .NET – new in AutoCAD 2013</a>. Don’t waste your time trying it if you’re using an earlier AutoCAD version.</li>    <li>A significant omission is that the above LINQ query doesn’t return AttributeReferences, even though they are derived from DbText. That is because AttributeReferences are accessed through the BlockReference.AttributeCollection property.</li>    <li>I’m a LINQ newbie, so I make no claims that the above query is optimized in any way. I’d be very happy to receive comments with suggestions for improvements to make this post more complete. </li> </ul>
