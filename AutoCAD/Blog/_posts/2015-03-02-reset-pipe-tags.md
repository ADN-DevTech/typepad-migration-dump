---
layout: "post"
title: "Reset Pipe tags"
date: "2015-03-02 08:54:30"
author: "Augusto Goncalves"
categories:
  - ".NET"
  - "Augusto Goncalves"
  - "Plant3D"
original_url: "https://adndevblog.typepad.com/autocad/2015/03/reset-pipe-tags.html "
typepad_basename: "reset-pipe-tags"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>On the UI itâ€™s possible to select Pipes, erase the Tag (set as unassigned) and then set it back. In some cases, this is a workflow to fix tag problems on Pipes, that can reflect on ISO generation.</p>  <p>The idea of this code is: on the database level (DataLinksManager), get all the PipeRunComponents, Fasteners and P3dConnector, then finally Unrelate and Relate again. The purpose is to force Plant 3D to rebuild its structure and restore.</p>  <p>Thanks to Jorge Lopez (big) help on this!</p>  <p>Important: if you plan to use this, ensure you have a backup of your project.</p>  <pre style="font-size: 13px; font-family: consolas; background: white; color: black">[<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;tryFixPipeTag&quot;</span>)]<br /><span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> CmdTryFixLineTag()<br />{<br />&#160; <span style="color: #2b91af">Editor</span> ed = <span style="color: #2b91af">Application</span>.DocumentManager.<br />&#160;&#160;&#160; MdiActiveDocument.Editor;<br /> <br />&#160; <span style="color: #2b91af">PlantProject</span> currentProj = <br />&#160;&#160;&#160; <span style="color: #2b91af">PlantApplication</span>.CurrentProject;<br />&#160; <span style="color: #2b91af">PipingProject</span> pipeProj = <br />&#160;&#160;&#160; (<span style="color: #2b91af">PipingProject</span>)currentProj.ProjectParts[<span style="color: #a31515">&quot;Piping&quot;</span>];<br />&#160; <span style="color: #2b91af">DataLinksManager</span> dlm = <br />&#160;&#160;&#160; pipeProj.DataLinksManager;<br /> <br />&#160; <span style="color: #2b91af">PnPDatabase</span> db = dlm.GetPnPDatabase();<br /> <br />&#160; db.StartTransaction();<br /> <br />&#160; <span style="color: blue">int</span> dwgRowId = dlm.GetDrawingId(<br />&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument.Database);<br />&#160; <span style="color: #2b91af">PnPRowIdArray</span> groupIds = dlm.GetRelatedRowIds(<br />&#160;&#160;&#160; <span style="color: #a31515">&quot;P3dDrawingLineGroupRelationship&quot;</span>, <span style="color: #a31515">&quot;Drawing&quot;</span>,<br />&#160;&#160;&#160; dwgRowId, <span style="color: #a31515">&quot;LineGroup&quot;</span>);<br /> <br />&#160; <span style="color: blue">foreach</span> (<span style="color: blue">int</span> groupId <span style="color: blue">in</span> groupIds)<br />&#160; {<br />&#160;&#160;&#160; <span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">PnPRow</span>&gt; rowsToFix = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">PnPRow</span>&gt;();<br />&#160;&#160;&#160; <span style="color: #2b91af">PnPRow</span> rowLineGroup = db.GetRow(groupId);<br /> <br />&#160;&#160;&#160; <span style="color: blue">string</span> tag = rowLineGroup[<span style="color: #a31515">&quot;Tag&quot;</span>] <span style="color: blue">as</span>&#160;<span style="color: blue">string</span>;<br />&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrWhiteSpace(tag)) <span style="color: blue">continue</span>;<br /> <br />&#160;&#160;&#160; ed.WriteMessage(<span style="color: #a31515">&quot;\n{0}&quot;</span>, tag);<br />&#160;&#160;&#160; System.Diagnostics.<span style="color: #2b91af">Debug</span>.WriteLine(<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;\n{0}&quot;</span>, tag));<br /> <br />&#160;&#160;&#160; <span style="color: green">// Get pipe run components</span><br />&#160;&#160;&#160; <span style="color: green">//</span><br />&#160;&#160;&#160; <span style="color: #2b91af">PnPTable</span> tblPipes = db.Tables[<span style="color: #a31515">&quot;PipeRunComponent&quot;</span>];<br />&#160;&#160;&#160; <span style="color: #2b91af">PnPRow</span>[] rowsPipes = tblPipes.Select(<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;LineNumberTag='{0}'&quot;</span>, tag));<br /> <br />&#160;&#160;&#160; AddRowsToUniqueList(rowsToFix, rowsPipes);<br /> <br />&#160;&#160;&#160; <span style="color: green">// Get fasteners</span><br />&#160;&#160;&#160; <span style="color: green">//</span><br />&#160;&#160;&#160; <span style="color: #2b91af">PnPTable</span> tblFastener = db.Tables[<span style="color: #a31515">&quot;Fasteners&quot;</span>];<br />&#160;&#160;&#160; <span style="color: #2b91af">PnPRow</span>[] rowsFastener = tblFastener.Select(<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;LineNumberTag='{0}'&quot;</span>, tag));<br /> <br />&#160;&#160;&#160; AddRowsToUniqueList(rowsToFix, rowsFastener);<br /> <br />&#160;&#160;&#160; <span style="color: green">// Get P3dConnectors</span><br />&#160;&#160;&#160; <span style="color: green">//</span><br />&#160;&#160;&#160; <span style="color: #2b91af">PnPTable</span> tblConnector = db.Tables[<span style="color: #a31515">&quot;P3dConnector&quot;</span>];<br />&#160;&#160;&#160; <span style="color: green">// just in case, make sure all rows are loaded in</span><br />&#160;&#160;&#160; tblConnector.Select();&#160; <br /> <br />&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">PnPRow</span> rowFastener <span style="color: blue">in</span> rowsFastener)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PpObjectIdArray</span> arr = dlm.FindAcPpObjectIds(rowFastener.RowId);<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">PpObjectId</span> ppId <span style="color: blue">in</span> arr)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PpObjectId</span> ppConnectorId = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">PpObjectId</span>(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ppId.DwgId, ppId.dbHandle, 0);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">int</span> rowIdConnector = dlm.FindAcPpRowId(ppConnectorId);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PnPRow</span> jointRow = db.GetRow(rowIdConnector);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; AddRowToUniqueList(rowsToFix, jointRow);<br />&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; <span style="color: green">// Fix: Catches the following situations:</span><br />&#160;&#160;&#160; <span style="color: green">//</span><br />&#160;&#160;&#160; <span style="color: green">// 1. where tag does not match actual group</span><br />&#160;&#160;&#160; <span style="color: green">// 2. when there is more than one group per part</span><br />&#160;&#160;&#160; <span style="color: green">// 3. when the relationship is missing</span><br />&#160;&#160;&#160; <span style="color: green">//</span><br />&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">PnPRow</span> row <span style="color: blue">in</span> rowsToFix)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PnPRowIdArray</span> priorGroupIds = <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; dlm.GetRelatedRowIds(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;P3dLineGroupPartRelationship&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;Part&quot;</span>, row.RowId, <span style="color: #a31515">&quot;LineGroup&quot;</span>);<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (priorGroupIds.Count == 1 &amp;&amp;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; priorGroupIds.First.Value == rowLineGroup.RowId)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">continue</span>;<br />&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">int</span> id <span style="color: blue">in</span> priorGroupIds)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; dlm.Unrelate(<span style="color: #a31515">&quot;P3dLineGroupPartRelationship&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;LineGroup&quot;</span>, id, <span style="color: #a31515">&quot;Part&quot;</span>, row.RowId);<br />&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160; dlm.Relate(<span style="color: #a31515">&quot;P3dLineGroupPartRelationship&quot;</span>, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;LineGroup&quot;</span>, rowLineGroup.RowId, <span style="color: #a31515">&quot;Part&quot;</span>, row.RowId);<br />&#160;&#160;&#160; }<br />&#160; }<br /> <br />&#160; db.CommitTransaction();<br />}<br /> <br /><span style="color: blue">private</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> AddRowToUniqueList(<br />&#160; <span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">PnPRow</span>&gt; rowsToFix, <span style="color: #2b91af">PnPRow</span> jointRow)<br />{<br />&#160; AddRowsToUniqueList(rowsToFix, <span style="color: blue">new</span>&#160;<span style="color: #2b91af">PnPRow</span>[] { jointRow });<br />}<br /> <br /><span style="color: blue">private</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> AddRowsToUniqueList(<br />&#160; <span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">PnPRow</span>&gt; rowsToFix, <span style="color: #2b91af">PnPRow</span>[] rowsPipes)<br />{<br />&#160; rowsToFix.AddRange(rowsPipes);<br />}</pre>
