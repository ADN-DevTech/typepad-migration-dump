---
layout: "post"
title: "Cast from .NET to COM using Managed C++?"
date: "2013-01-21 10:14:18"
author: "Augusto Goncalves"
categories:
  - ".NET"
  - "ActiveX"
  - "Augusto Goncalves"
  - "AutoCAD"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2013/01/cast-from-net-to-com-using-managed-c.html "
typepad_basename: "cast-from-net-to-com-using-managed-c"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>After select an object using .NET (Managed C++), how cast to a COM object? First you need to get the IUnknow pointer from AcadObject property, then cast it to a COM object. This procedure will ensure you maintain COM reference count.</p>  <p>The following code show how do it, also show how get its type name. Keep in mind that this project should be created in Mixed mode.</p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">//get the collection of documents (MDI)</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">Autodesk::AutoCAD::ApplicationServices::DocumentCollection ^docMgr = </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; Autodesk::AutoCAD::ApplicationServices::</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; Application::DocumentManager;</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">//get the active document</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">Autodesk::AutoCAD::ApplicationServices::Document ^acadDoc =</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; </font></font><font face="Courier New"><font style="font-size: 8pt" color="#000000">docMgr-&gt;MdiActiveDocument;</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#008000">//get the editor</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">Autodesk::AutoCAD::EditorInput::Editor ^ed = acadDoc-&gt;Editor;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">Autodesk::AutoCAD::DatabaseServices::Transaction ^trans;</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#0000ff">try</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//start a transaction</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; trans = acadDoc-&gt;Database-&gt;TransactionManager-&gt;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; StartTransaction();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//select an entity using .NET</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; Autodesk::AutoCAD::EditorInput::PromptEntityResult</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; ^promptEntRes = ed-&gt;GetEntity(_T(</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;Select an entity: &quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (promptEntRes-&gt;Status != Autodesk::AutoCAD::</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; EditorInput::PromptStatus::OK) </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//open the entity for read</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; Autodesk::AutoCAD::DatabaseServices::Entity ^mgdEntity = </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; (Autodesk::AutoCAD::DatabaseServices::Entity^)</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; trans-&gt;GetObject(promptEntRes-&gt;ObjectId, </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; Autodesk::AutoCAD::DatabaseServices::OpenMode::ForRead);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//get the COM object from the .NET object</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; System::Object ^acadObj = mgdEntity-&gt;AcadObject;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; System::IntPtr ptr = System::Runtime::</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; InteropServices::Marshal::GetIUnknownForObject(acadObj);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; IUnknown* iunk = </font></font><font style="font-size: 8pt"><span><font color="#0000ff">static_cast</font></span><font color="#000000">(ptr.ToPointer());</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; CComQIPtr acadEntity = iunk;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; iunk-&gt;Release();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//get the entity name using the COM object</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//it will return something line AcDbLine, AcDbCircle, etc</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; CComBSTR entityName;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; acadEntity-&gt;get_EntityName(&amp;entityName);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//if you made the proper cast, such as for IAcadLine,</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//then you can call any other method of this COM object</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//now get the COM interface name of the object</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//it will return something line IAcadLine, IAcadCircle, etc</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; CComPtr typeInfo;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; acadEntity-&gt;GetTypeInfo(0,LOCALE_SYSTEM_DEFAULT,&amp;typeInfo);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; CComBSTR interfaceName;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; typeInfo-&gt;GetDocumentation(-1,&amp;interfaceName, 0,0,0);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//and print using .NET</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; ed-&gt;WriteMessage(_T(</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;\nEntity selected: {0} ({1})&quot;</font></span><font color="#000000">), </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">gcnew</font></span><font color="#000000"> System::String(entityName), </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">gcnew</font></span><font color="#000000"> System::String(interfaceName));</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">catch</font></font></span><font style="font-size: 8pt" color="#000000">(System::Exception^ e)</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//something went wrong</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; ed-&gt;WriteMessage(e-&gt;Message);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></p>    <p style="margin: 0px"><span><font face="Courier New"><font style="font-size: 8pt" color="#0000ff">__finally</font></font></span></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//dispose the transaction</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; trans-&gt;~Transaction();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></p> </div>
