---
layout: "post"
title: "Adding an Attribute to a Block Definition using C++ COM/ActiveX Automation in ObjectARX"
date: "2012-12-10 16:05:53"
author: "Fenton Webb"
categories:
  - "2010"
  - "2011"
  - "2012"
  - "2013"
  - "ActiveX"
  - "AutoCAD"
  - "Fenton Webb"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2012/12/adding-an-attribute-to-a-block-definition-using-c-comactivex-automation-in-objectarx.html "
typepad_basename: "adding-an-attribute-to-a-block-definition-using-c-comactivex-automation-in-objectarx"
typepad_status: "Publish"
---

<p>by <a href="http://adndevblog.typepad.com/autocad/fenton-webb.html">Fenton Webb</a></p>  <p>The trick to doing this is to use the I*Ptr interfaces (e.g. IAcadDocumentPtr) so that COM reference counting is handled automatically. </p>  <p>Also, another trick is to stay away from VARIANT’s as much as possible, we have various AcAx* classes which help you do this… Here’s the code…</p>  <div style="font-family: ; background: white; color: ">   <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">#import</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span style="color: "><font color="#a31515">&quot;acax19ENU.tlb&quot;</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">no_namespace</font></span><font color="#000000"> </font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">#include</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font></font><span style="color: "><font style="font-size: 8pt" color="#a31515">&lt;rxmfcapi.h&gt;</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">#include</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font></font><span style="color: "><font style="font-size: 8pt" color="#a31515">&lt;axpnt3d.h&gt;</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">void</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span style="color: "><font color="#010001">fAddAttribute</font></span><font color="#000000">()</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#0000ff">try</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// get the ActiveX application object from AutoCAD, inc ref count</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">IAcadApplicationPtr</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">pAcadApp</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">acedGetAcadWinApp</font></span><font color="#000000">()-&gt;</font><span style="color: "><font color="#010001">GetIDispatch</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">TRUE</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// now get the active doc</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">IAcadDocumentPtr</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">pActiveDoc</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">pAcadApp</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">ActiveDocument</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">IAcadBlockPtr</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">pBlock</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">NULL</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">TCHAR</font></span><font color="#000000"> *</font><span style="color: "><font color="#010001">pBlkName</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;some_block_name&quot;</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// create an activex compatible insertion point3d</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcAxPoint3d</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">axInsPnt</font></span><font color="#000000">(0,0,0);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// now add the block name</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">pBlock</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">pActiveDoc</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">Blocks</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">Add</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">axInsPnt</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">asVariantPtr</font></span><font color="#000000">(),</font><span style="color: "><font color="#010001">_bstr_t</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">pBlkName</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// now add an Attribute to the block</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">IAcadAttributePtr</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">pAttDef</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">pAttDef</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">pBlock</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">AddAttribute</font></span><font color="#000000">(1.0, (</font><span style="color: "><font color="#010001">AcAttributeMode</font></span><font color="#000000">)0 ,</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">_bstr_t</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;Type the employee name&quot;</font></span><font color="#000000">), </font><span style="color: "><font color="#010001">axInsPnt</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">asVariantPtr</font></span><font color="#000000">(),</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">_bstr_t</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;empname&quot;</font></span><font color="#000000">),</font><span style="color: "><font color="#010001">_bstr_t</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;&quot;</font></span><font color="#000000">));</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">//attribute added</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">catch</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">_com_error</font></span><font color="#000000"> &amp;</font><span style="color: "><font color="#010001">es</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acutPrintf</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">L</font></span><span style="color: "><font color="#a31515">&quot;\nError : %s&quot;</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">es</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">ErrorMessage</font></span><font color="#000000">());</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">}</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p> </div>
