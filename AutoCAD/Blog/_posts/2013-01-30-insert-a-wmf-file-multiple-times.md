---
layout: "post"
title: "Insert A WMF File Multiple Times"
date: "2013-01-30 04:15:53"
author: "Augusto Goncalves"
categories:
  - "Augusto Goncalves"
  - "AutoCAD"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2013/01/insert-a-wmf-file-multiple-times.html "
typepad_basename: "insert-a-wmf-file-multiple-times"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>Unfortunately the only way to insert a metafile is by using acedCommand( RTSTR,&quot;_wmfin&quot; .... ) </p>  <p>This means that for the first time you have to create the block definition and the first insert of the metafile using acedCommand() and after this you can insert additional references which point to the previously inserted block definition.</p>  <p>In order to do this after calling acedCommand( RTSTR, &quot;_wmfin&quot; .... ) you have to get the last entity using acdbEntlast(). This will return the AcDbBlockReference which points to the AcDbBlockTableRecord containing the newly inserted WMF file.</p>  <p>You can get the ObjectId of this block table record by calling AcDbBlockReference::blockTableRecord().</p>  <p>Now you can add more AcDbBlockReferences to your drawing and set them to point to the inserted WMF by calling AcDbBlockReferences::setBlockTableRecord.</p>  <p>You can get the size of the inserted metafile using the getGeomExtents() function of the block reference. The sample below demonstrates this.</p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">void</font></font></span><font style="font-size: 8pt" color="#000000"> InsertWMF()</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">struct</font></span><font color="#000000"> resbuf buf,oldbuf;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; acedGetVar(_T(</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;filedia&quot;</font></span><font color="#000000">), &amp;oldbuf );</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; buf.restype = RTSHORT;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; buf.resval.rint = 0;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; buf.rbnext = NULL;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; acedSetVar(_T(</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;filedia&quot;</font></span><font color="#000000">), &amp;buf );</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; ACHAR A_WmfFile[] = _T(</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;c:\\temp\\t.wmf&quot;</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; ads_point point1 = { 0,0,0 };</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; acedCommand(RTSTR,_T(</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;_wmfin&quot;</font></span><font color="#000000">),RTSTR,A_WmfFile,</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; RT3DPOINT,point1,RTSTR,</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;&quot;</font></span><font color="#000000">,RTSTR,</font><span><font color="#a31515">&quot;&quot;</font></span><font color="#000000">, RTREAL, 0,0,RTNONE);</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; acedSetVar (_T(</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;filedia&quot;</font></span><font color="#000000">), &amp;oldbuf );</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; ads_name name;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; AcDbObjectId objId;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; acdbEntLast( name );</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; acdbGetObjectId ( objId, name );</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; AcDbBlockReference *pRef;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; AcDbExtents extents;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; acdbOpenObject ( pRef, objId, AcDb::kForRead );</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; objId = pRef-&gt;blockTableRecord();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pRef-&gt;close();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//Get the size of the insert&#160; </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pRef-&gt;getGeomExtents (extents);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pRef-&gt;close();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//Use AcDbExtents member functions to get bounding box corners</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; AcGePoint3d pt;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pt = extents.maxPoint();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pt = extents.minPoint();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//Create a new insert</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; pRef =</font></font><font style="font-size: 8pt"><span><font color="#0000ff">new</font></span><font color="#000000"> AcDbBlockReference ;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pRef-&gt;setBlockTableRecord ( objId );</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pRef-&gt;setPosition ( AcGePoint3d ( 1.0, 1.0, 0.0) ) ;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; postToDb ( pRef, objId );</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></p> </div>  <p>NOTE: In the case that the wmf insert is rotated, getGeomExtents() will NOT return an accurate size. Please check also <a href="http://adndevblog.typepad.com/autocad/2013/01/calculating-tight-bounding-box-around-a-solid.html">this post</a> which describes a way to make a good approximation of a &quot;tight&quot; bounding box for such cases.</p>  <p>Below is the commonly used postToDb method.</p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">Acad::ErrorStatus postToDb(AcDbEntity* ent, AcDbObjectId&amp; objId) </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; Acad::ErrorStatus es;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; AcDbBlockTable* pBlockTable;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; AcDbBlockTableRecord* pSpaceRecord;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (ent==NULL)</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000"> Acad::eNullObjectPointer;&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> ((es = acdbHostApplicationServices()-&gt;workingDatabase()-&gt;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; getBlockTable(pBlockTable, AcDb::kForRead))!=</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; Acad::eOk)</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000"> es;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> ((es =</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; pBlockTable-&gt;getAt(ACDB_MODEL_SPACE,pSpaceRecord,</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; AcDb::kForWrite)) != Acad::eOk)</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; {&#160;&#160;&#160;&#160;&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; pBlockTable-&gt;close();&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000"> es;&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; }&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pBlockTable-&gt;close(); </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> ((es = pSpaceRecord-&gt;appendAcDbEntity(objId, ent))</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; != Acad::eOk) {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; pSpaceRecord-&gt;close();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000"> es;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; pSpaceRecord-&gt;close();</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000"> ent-&gt;close();&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">} </font></font></p> </div>
