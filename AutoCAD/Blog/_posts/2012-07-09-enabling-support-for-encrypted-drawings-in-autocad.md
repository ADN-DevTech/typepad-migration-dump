---
layout: "post"
title: "Enabling Support For Encrypted Drawings In AutoCAD"
date: "2012-07-09 06:27:10"
author: "Philippe Leefsma"
categories:
  - "AutoCAD"
  - "ObjectARX"
  - "Philippe Leefsma"
original_url: "https://adndevblog.typepad.com/autocad/2012/07/enabling-support-for-encrypted-drawings-in-autocad.html "
typepad_basename: "enabling-support-for-encrypted-drawings-in-autocad"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/philippe-leefsma.html" target="_self">Philippe Leefsma</a></p>  <div style="line-height: 16px; widows: 2; text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: ; white-space: normal; orphans: 2; color: ; clear: both; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px" class="clear">   <div><font style="font-size: 9pt"></font><strong><font color="#000000">Q:</font></strong> </div>    <div>&#160;</div>    <p style="line-height: 16px; margin: 0px 0px 15px"><font face="Arial"><font style="font-size: 9pt" color="#000000">How can I access drawing encryption feature with the ObjectARX API ?</font></font></p> </div>  <div style="line-height: 16px; widows: 2; text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: ; white-space: normal; orphans: 2; color: ; clear: both; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px" class="clear"><a name="section2"></a>    <div><font style="font-size: 9pt"></font><strong><font color="#000000">A:</font></strong>       <br /></div>   <font face="Arial">     <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">ObjectARX&#160; API support for drawing encryption is provided with optional password arguments to the following functions:</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">AcDbDatabase::readDwgFile()</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">AcDbDatabase::saveAs()</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">acedSyncFileOpen()</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">acedXrefAttach()</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><font style="font-size: 9pt">For access to drawings that already contain encryption, readDwgFile, acedSyncFileOpen and acedXrefAttach provide an optional password argument, which is passed as a wide character wchar_t.</font><span><font style="font-size: 9pt">&#160;</font></span></font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">To explicitly create encrypted drawings, AcDbDatabase::saveAs() provides an optional SecurityParams struct argument (defined by ObjectARX) which can be used to define the details of the encryption scheme such as encryption provider, encryption type, key length and the access password.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>If this argument is NULL, saveAs() will use any default security settings specified with the AcDbDatabase::setSecurityParams() method (which is also defined with the SecurityParams structure).</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">The documentation for SecurityParams has information for each item in the struct, but here is an example showing how it might be filled:</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">SecurityParams* SetSecurityParams(</font><span style="color: "><font color="#0000ff">wchar_t</font></span><font color="#000000"><span class="Apple-converted-space">&#160;</span>*wszPassword)</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">{</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>SecurityParams *pSecParams=</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"><span class="Apple-converted-space">&#160;</span>SecurityParams;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;cbSize=</font><span style="color: "><font color="#0000ff">sizeof</font></span><font color="#000000">(SecurityParams);</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;ulFlags=SECURITYPARAMS_ENCRYPT_DATA;</font></span></p>      <blockquote>       <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="color: "><font color="#008000">&#160; // Must always be this value.</font></span></p>     </blockquote>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;ulAlgId=SECURITYPARAMS_ALGID_RC4;<span class="Apple-converted-space">&#160;</span></font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span class="Apple-converted-space"></span></font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: ; color: "><font color="#008000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;wszProvName=</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; L&quot;Microsoft Base Cryptographic Provider v1.0&quot;;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"></font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;ulKeyLength=40;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;ulProvType=PROV_RSA_FULL;</font><span style="color: "><font color="#008000">// Defined in wincrypt.h</font></span></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;wszCertIssuer=NULL;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;wszCertSerialNum=NULL;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;wszComment=NULL;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></span>pSecParams-&gt;wszPassword=wszPassword;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><span><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></span></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><span><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span></font></span><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"><span class="Apple-converted-space">&#160;</span>pSecParams;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">}</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">Important Note:</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">When passwords are specified from within the AutoCAD user interface, they are always converted to upper case.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>For the ObjectARX API methods, this is also the case though there is currently a limitation with saveAs() which does<span class="Apple-converted-space">&#160;</span><i>NOT</i><span class="Apple-converted-space">&#160;</span>convert to an upper-case password.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>Therefore it is<span class="Apple-converted-space">&#160;</span><i>VERY IMPORTANT</i>that you convert all passwords to upper-case when passed into AcDbDatabase::saveAs().<span>&#160;<span class="Apple-converted-space">&#160;</span></span>If you do not, drawings can be effectively destroyed since they are unopenable with any software.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>While this limitation exists, it is generally a good idea to convert all passwords to upper-case before passing them to any ObjectARX APIs.</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">It should also be noted that a blank (zero length) password can be passed into AcDbDatabase::saveAs(), however AutoCAD password dialogs and all decryption APIs (readDwgFile,acedSyncFileOpen and acedXrefAttach) will fail when passed a blank password.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>This is primarily to allow scripts or batch processes to fail silently when encountering a drawing which is encrypted (see Drawing Security Considerations in the ObjectARX Developers Guide for details).</font></span><span style="font-family: "></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000" face="Courier New">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><font color="#000000"><span style="font-family: "><font style="font-size: 9pt">Two other basic APIs support password protection.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>acedSyncFileOpen() and acedXrefAttach().<span>&#160;<span class="Apple-converted-space">&#160;</span></span>These two APIs simply take a wide password string, and return an error status reflecting their success.<span>&#160;</span>acedSyncFileOpen() is used to synchronously open a document in AutoCAD, but only works in SDI mode.<span>&#160;<span class="Apple-converted-space">&#160;</span></span></font></span><span style="font-family: "><font style="font-size: 9pt">The MDI equivalent appContextOpenDocument() method doesnt take a password parameter, so another approach must be taken.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>Normally opening any encrypted drawing with this API would invoke the password prompt in AutoCAD.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>We can avoid this by caching our password first with a call to readDwgFile().<span>&#160;<span class="Apple-converted-space">&#160;</span></span>Example:</font></span></font></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#00c600">// cache szPassword within ObjectDBX to avoid the automatic password</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#00c600">// dialog after the call to appContextOpenDocument().</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">AcDbDatabase *pDb=</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"><span class="Apple-converted-space">&#160;</span>AcDbDatabase(</font><span style="color: "><font color="#0000ff">false</font></span><font color="#000000">,</font><span style="color: "><font color="#0000ff">true</font></span><font color="#000000">);</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">Acad::ErrorStatus es=pDb-&gt;readDwgFile(</font></span></p>      <p style="line-height: 16px; text-indent: 0.5in; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">res.resval.rstring,</font></span></p>      <p style="line-height: 16px; text-indent: 0.5in; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">_SH_DENYWR,</font></span></p>      <p style="line-height: 16px; text-indent: 0.5in; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: ; color: "><font color="#0000ff">false</font></span><span style="font-family: "><font color="#000000">,</font></span></p>      <p style="line-height: 16px; text-indent: 0.5in; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">convertToWide(szPassword)</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">);</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: ; color: "><font color="#0000ff">delete</font></span><span style="font-family: "><font color="#000000"><span class="Apple-converted-space">&#160;</span>pDb;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: ; color: "><font color="#0000ff">if</font></span><span style="font-family: "><font color="#000000">(Acad::eOk!=acDocManager-&gt;appContextOpenDocument(res.resval.rstring))</font></span></p>      <p style="line-height: 16px; text-indent: 0.5in; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">AfxMessageBox(L&quot;MDI Open Failed&quot;);</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">For all the encryption enabled APIs an error status is returned which represents the success of the call.<span>&#160;</span>For encryption support, there are a few error status values that have been added.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>They are defined starting at 1001 in the Acad::ErrorStatus enum defined in acadstrc.h, and all begin with eSec </font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">For APIs used to access files that already contain encryption, an eSecErrorDecryptingData error status is returned for a blank or incorrect password.<span>&#160;<span class="Apple-converted-space">&#160;</span></span>For the saveAs(), errors within the SecurityParams structure passed will cause an eSecErrorEncryptingData return value.</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><span style="font-family: "><font style="font-size: 9pt" color="#000000">&#160;</font></span></p>      <p style="line-height: 16px; margin: 0in 0in 0pt" class="MsoNormal"><font color="#000000"><span style="font-family: "><font style="font-size: 9pt">The attached cpp file contains some ARX code which demonstrates many of the encryption topics.&#160; It defines three commands; READDWG, SAVEDWG and OPENDWG.&#160; READDWG will use the AcDbDatabase::readDwgFile() to read an encrypted file. SAVEDWG shows how to populate a SecurityParams structure to create an encrypted drawing file. OPENDWG uses either acedSyncFileOpen or appContextOpenDocument() depending on the SDI setting to open a drawing in the AutoCAD editor.&#160; Each of these commands use the custom function acedGetPassword() which prompts the user for a password on the commandline, blanking the password characters with '*' for privacy.&#160; </font></span><font style="font-size: 9pt">&#160;</font></font></p>   </font></div>  <p style="line-height: normal; margin: 0in 0in 0pt" class="MsoNormal"><font face="Calibri"><font style="font-size: 11pt" color="#000000">&#160;</font></font></p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:fb3a1972-4489-4e52-abe7-25a00bb07fdf:c0fdccfb-12bc-494c-8986-583879ec31b2" class="wlWriterEditableSmartContent"><p> <a href="http://adndevblog.typepad.com/dwgsecurityapi.cpp" target="_blank">DwgSecurityApi.cpp</a></p></div>
