---
layout: "post"
title: "Overriding the SetUnhandledExceptionFilter for AutoCAD"
date: "2013-02-11 15:38:59"
author: "Fenton Webb"
categories:
  - "2010"
  - "2011"
  - "2012"
  - "2013"
  - "AutoCAD"
  - "Fenton Webb"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2013/02/overriding-the-setunhandledexceptionfilter-for-autocad.html "
typepad_basename: "overriding-the-setunhandledexceptionfilter-for-autocad"
typepad_status: "Draft"
---

<p>by <a href="http://adndevblog.typepad.com/autocad/fenton-webb.html">Fenton Webb</a></p>
<p>If you have tried overriding AutoCAD’s Exception filter (the one that catches all unhandled exceptions and sends the Mini Crash Dump file to Autodesk for analysis) you are in for a hard time.</p>
<p>We prevent people from overriding our exception filter because, well, it makes no sense for us not to receive the crash dumps, even if it is caused by another application.</p>
<p>That said, sometimes you may *need* to override it… I get it… So here’s some code which shows how to override it. Basically, once we hook our AutoCAD unhandled exception filter using SetUnhandledExceptionFilter() we then disable the SetUnhandledExceptionFilter() function by directly patching a return instruction into the asm. So here’s what you need to do to get round it:</p>
<div style="background: white;">
<pre><span style="color: #007f40;">// Patch for SetUnhandledExceptionFilter</span> <br /><span style="color: #0060bf;">const</span> BYTE PatchBytes[5] = { 0x33, 0xC0, 0xC2, 0x04, 0x00 };<br /><br /><span style="color: #007f40;">// Original bytes at the beginning of SetUnhandledExceptionFilter</span> <br />BYTE OriginalBytes[5] = {0};</pre>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #0000ff;"><span style="font-size: 8pt;">bool</span></span><span style="font-size: 8pt;"> <span style="color: #020002;">EnforceFilter</span><span style="color: #000000;">( </span><span style="color: #0000ff;">bool</span> <span style="color: #020002;">bEnforce</span><span style="color: #000000;"> ) </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">{ </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">DWORD</span> <span style="color: #020002;">ErrCode</span><span style="color: #000000;"> = 0; </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt; color: #008000;">// Obtain the address of SetUnhandledExceptionFilter </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">HMODULE</span> <span style="color: #020002;">hLib</span><span style="color: #000000;"> = </span><span style="color: #020002;">GetModuleHandle</span><span style="color: #000000;">( </span><span style="color: #020002;">_T</span><span style="color: #000000;">(</span><span style="color: #a31515;">&quot;kernel32.dll&quot;</span><span style="color: #000000;">) ); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">if</span><span style="color: #000000;">( </span><span style="color: #020002;">hLib</span><span style="color: #000000;"> == </span><span style="color: #020002;">NULL</span><span style="color: #000000;"> ) </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; { </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">ErrCode</span><span style="color: #000000;"> = </span><span style="color: #020002;">GetLastError</span><span style="color: #000000;">(); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">_ASSERTE</span><span style="color: #000000;">( !</span><span style="color: #020002;">_T</span><span style="color: #000000;">(</span><span style="color: #a31515;">&quot;GetModuleHandle(kernel32.dll) failed.&quot;</span><span style="color: #000000;">) ); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">; </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; } </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">BYTE</span><span style="color: #000000;">* </span><span style="color: #020002;">pTarget</span><span style="color: #000000;"> = (</span><span style="color: #020002;">BYTE</span><span style="color: #000000;">*)</span><span style="color: #020002;">GetProcAddress</span><span style="color: #000000;">( </span><span style="color: #020002;">hLib</span><span style="color: #000000;">, </span><span style="color: #a31515;">&quot;SetUnhandledExceptionFilter&quot;</span><span style="color: #000000;"> ); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">if</span><span style="color: #000000;">( </span><span style="color: #020002;">pTarget</span><span style="color: #000000;"> == 0 ) </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; { </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">ErrCode</span><span style="color: #000000;"> = </span><span style="color: #020002;">GetLastError</span><span style="color: #000000;">(); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">_ASSERTE</span><span style="color: #000000;">( !</span><span style="color: #020002;">_T</span><span style="color: #000000;">(</span><span style="color: #a31515;">&quot;GetProcAddress(SetUnhandledExceptionFilter) failed.&quot;</span><span style="color: #000000;">) ); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">; </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; } </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">if</span><span style="color: #000000;">( </span><span style="color: #020002;">IsBadReadPtr</span><span style="color: #000000;">( </span><span style="color: #020002;">pTarget</span><span style="color: #000000;">, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(</span><span style="color: #020002;">OriginalBytes</span><span style="color: #000000;">) ) ) </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; { </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">_ASSERTE</span><span style="color: #000000;">( !</span><span style="color: #020002;">_T</span><span style="color: #000000;">(</span><span style="color: #a31515;">&quot;Target is unreadable.&quot;</span><span style="color: #000000;">) ); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">; </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; } </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">if</span><span style="color: #000000;">( </span><span style="color: #020002;">bEnforce</span><span style="color: #000000;"> ) </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; { </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt; color: #008000;">// Save the original contents of SetUnhandledExceptionFilter </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #020002;">memcpy</span><span style="color: #000000;">( </span><span style="color: #020002;">OriginalBytes</span><span style="color: #000000;">, </span><span style="color: #020002;">pTarget</span><span style="color: #000000;">, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(</span><span style="color: #020002;">OriginalBytes</span><span style="color: #000000;">) ); </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt; color: #008000;">// Patch SetUnhandledExceptionFilter </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">if</span><span style="color: #000000;">( !</span><span style="color: #020002;">WriteMemory</span><span style="color: #000000;">( </span><span style="color: #020002;">pTarget</span><span style="color: #000000;">, </span><span style="color: #020002;">PatchBytes</span><span style="color: #000000;">, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(</span><span style="color: #020002;">PatchBytes</span><span style="color: #000000;">) ) ) </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">; </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; } </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">else</span> </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; { </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt; color: #008000;">// Restore the original behavior of SetUnhandledExceptionFilter </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">if</span><span style="color: #000000;">( !</span><span style="color: #020002;">WriteMemory</span><span style="color: #000000;">( </span><span style="color: #020002;">pTarget</span><span style="color: #000000;">, </span><span style="color: #020002;">OriginalBytes</span><span style="color: #000000;">, </span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(</span><span style="color: #020002;">OriginalBytes</span><span style="color: #000000;">) ) ) </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160;&#0160;&#0160;&#0160;&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">; </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160; } </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">&#0160;</span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt; color: #008000;">// Success </span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="color: #000000;"><span style="font-size: 8pt;">&#0160; </span></span><span style="font-size: 8pt;"><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">; </span></span></span></p>
<p style="margin: 0px;"><span style="font-family: Consolas;"><span style="font-size: 8pt; color: #000000;">} </span></span></p>
</div>
