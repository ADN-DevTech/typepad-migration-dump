---
layout: "post"
title: "determine if xref, block and images are nested?"
date: "2012-12-20 01:10:28"
author: "Xiaodong Liang"
categories:
  - "AutoCAD"
  - "ObjectARX"
  - "Xiaodong Liang"
original_url: "https://adndevblog.typepad.com/autocad/2012/12/determine-if-xref-block-and-images-are-nested.html "
typepad_basename: "determine-if-xref-block-and-images-are-nested"
typepad_status: "Draft"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/xiaodong-liang.html" target="_self">Xiaodong Liang</a></p>  <p><b>Issue</b></p>  <p>I'm trying to determine if an attached xref, block, and image are nested in a block. I can use AcDbXrefGraph for the xref to get the number of nodes. I can then iterate the nodes to get the block table record, but when I use AcDbBlockTableRecord::isAnonymous(), why doesn't it work?</p>  <p><a name="section2"></a></p>  <p><b>Solution</b></p>  <p>Calling AcDbBlockTableRecord::isAnonymous() is incorrect because it doesn't indicate whether an xref is nested; it tells whether the BTR is anonymous. Additionally, you cannot nest a BTR because that creates multiple ownership, which is not allowed in ObjectARX and AutoCAD. You can only nest a block   <br />reference (AcDbBlockReference, also known as an insert). Therefore, you should use AcDbBlockTableRecord::getBlockReferenceIds() function.</p>  <p>The code below is a small demo that access one block, open its definition, add one text and transform each block references within it.</p>  <div style="font-family: courier new; background: white; color: black; font-size: 9pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> test()</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// select a block</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; TCHAR nameBuf[150]; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (acedGetString(Adesk::kTrue, </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; _T(</span><span style="line-height: 140%; color: #a31515">&quot;\nEnter block name to modify : &quot;</span><span style="line-height: 140%">),</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; nameBuf) != RTNORM) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">; </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Modify the block definition </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; Acad::ErrorStatus es; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbDatabase * pDb =</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; acdbHostApplicationServices()-&gt;workingDatabase(); </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbBlockTable *pBlockTable = NULL; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; es = pDb-&gt;getBlockTable(pBlockTable, </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDb::kForRead); </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbBlockTableRecord* pBTR = NULL; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; es = pBlockTable-&gt;getAt(nameBuf, </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pBTR,</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDb::kForWrite); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%">(es != Acad::eOk) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; acutPrintf(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ACRX_T(</span><span style="line-height: 140%; color: #a31515">&quot;No such block name exists !&quot;</span><span style="line-height: 140%">)); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; pBlockTable-&gt;close(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; } </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// add a text to the block definition</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbText* pText = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">new</span><span style="line-height: 140%"> AcDbText(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pText-&gt;setDatabaseDefaults(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pText-&gt;setTextString(ACRX_T(</span><span style="line-height: 140%; color: #a31515">&quot;Autodesk&quot;</span><span style="line-height: 140%">)); </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBTR-&gt;appendAcDbEntity(pText); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pText-&gt;close(); </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Get all the references for </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">//this BlockTableRecord </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; AcDbObjectIdArray ids; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBTR-&gt;getBlockReferenceIds(ids); </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBTR-&gt;close(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; pBlockTable-&gt;close(); </span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// Update the references </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">for</span><span style="line-height: 140%">(</span><span style="line-height: 140%; color: blue">int</span><span style="line-height: 140%"> cnt = 0; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; cnt &lt; ids.length(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; cnt++) </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; { </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; AcDbBlockReference *pRef; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; acdbOpenObject(pRef,ids[cnt], </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcDb::kForWrite); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; AcGeMatrix3d mat = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcGeMatrix3d::kIdentity; </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; pRef-&gt;transformBy(mat); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160; pRef-&gt;close(); </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; } </span></p> </div>  <p>Once you have the block reference ids, you can check each one for its owner by calling AcDbEntity::blockId() (AcDbBlockReference is derived from AcDbEntity).   <br />If the owner ID matches either model space block table record's ID or a paper space block table record's ID, it is not nested. Otherwise it is.</p>  <p>An image has to &quot;live&quot; in a BTR to be displayed, which means you willl need to iterate through a BTR to find an image that compares to the use of AcDbXrefGraph. </p>
