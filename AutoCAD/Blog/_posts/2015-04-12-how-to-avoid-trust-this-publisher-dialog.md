---
layout: "post"
title: "How to avoid &lsquo;Trust This Publisher&rsquo; Dialog"
date: "2015-04-12 23:21:35"
author: "Madhukar Moogala"
categories:
  - ".NET"
  - "2016"
  - "Madhukar Moogala"
original_url: "https://adndevblog.typepad.com/autocad/2015/04/how-to-avoid-trust-this-publisher-dialog.html "
typepad_basename: "how-to-avoid-trust-this-publisher-dialog"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/Madhukar-Moogala.html" target="_self">Madhukar Moogala</a></p>  <p>From 2016, if modules are signed and the certificate [.cer] file used to sign the modules&#0160; is not registered in store, or modules are not located in any of the trusted location, a window will pop-up asking user to trust the publisher, to avoid this pesky window dialog, you can follow any of these steps.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d101a761970c-pi"><img alt="Trust-This-Publisher" border="0" height="198" src="/assets/image_260800.jpg" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" title="Trust-This-Publisher" width="244" /></a></p>  <h3>1. Adding certificate to trusted store during installation:</h3>  <p>There is no inherent support in msi to add certificate to the certificate store. This has to be accomplished using a custom action. There are two ways to accomplish it using the custom action.</p>  <ol>   <li>Use certutil.exe, a command line tool from Microsoft to install the certificate.      <br />Usage: certutil -addstore &lt;storename&gt; &lt;yourcertfile.cer&gt;       <br />Example: certutil.exe -addstore TrustedPublisher mycertfile.cer </li>    <li>     <p>Use the Microsoft crypto API to install the certificate to the store.</p>      <p>Sample code is given below, please do the appropriate error checking.</p>   </li> </ol>  <p>.NET:</p>  <p><span style="color: #2b91af">X509Certificate2</span> certificate =</p>  <div style="font-size: 9pt; font-family: consolas; background: white; color: black">   <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">new</span> <span style="color: #2b91af">X509Certificate2</span>(<span style="color: #a31515">@&quot;c:\temp\mycertfile.cer&quot;</span>);</p>    <p style="margin: 0px">&#0160;</p>    <div style="font-size: 9pt; font-family: consolas; background: white; color: black">     <p style="margin: 0px"><span style="color: green">/*To load Pfx file to store*/</span></p>   </div>    <p style="margin: 0px"><span style="color: green">//&#0160; X509Certificate2 certificate = new X509Certificate2(@&quot;C:\temp\mycert.pfx&quot;, &quot;pwd123&quot;, X509KeyStorageFlags.PersistKeySet);</span></p>    <p style="margin: 0px"><span style="color: #2b91af">X509Store</span> store =</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: blue">new</span> <span style="color: #2b91af">X509Store</span>(<span style="color: #2b91af">StoreName</span>.TrustedPublisher,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #2b91af">StoreLocation</span>.LocalMachine);</p>    <p style="margin: 0px">store.Open(<span style="color: #2b91af">OpenFlags</span>.ReadWrite);</p>    <p style="margin: 0px">store.Add(certificate);</p>    <p style="margin: 0px">store.Close();</p> </div>  <p>&#0160;</p>  <p>C++:</p>  <div style="font-size: 9pt; font-family: consolas; background: white; color: black">   <p style="margin: 0px"><span style="color: blue">#include</span> <span style="color: #a31515">&lt;wincrypt.h&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">#include</span> <span style="color: #a31515">&lt;windows.h&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">#include</span> <span style="color: #a31515">&lt;wintrust.h&gt;</span></p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">#pragma</span> <span style="color: blue">comment</span>(<span style="color: blue">lib</span>, <span style="color: #a31515">&quot;crypt32.lib&quot;</span>)</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">#define</span> <span style="color: #6f008a">ENCODING</span> (<span style="color: #6f008a">X509_ASN_ENCODING</span> | <span style="color: #6f008a">PKCS_7_ASN_ENCODING</span>)</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">typedef</span> <span style="color: blue">struct</span> {</p>    <p style="margin: 0px"><span style="color: #2b91af">LPWSTR</span> lpszProgramName;</p>    <p style="margin: 0px"><span style="color: #2b91af">LPWSTR</span> lpszPublisherLink;</p>    <p style="margin: 0px"><span style="color: #2b91af">LPWSTR</span> lpszMoreInfoLink;</p>    <p style="margin: 0px">} <span style="color: #2b91af">SPROG_PUBLISHERINFO</span>, *<span style="color: #2b91af">PSPROG_PUBLISHERINFO</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">class</span> <span style="color: #2b91af">X509Certificate</span></p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">public</span>:</p>    <p style="margin: 0px">X509Certificate();</p>    <p style="margin: 0px">~X509Certificate(<span style="color: blue">void</span>);</p>    <p style="margin: 0px"><span style="color: blue">bool</span> initialize(<span style="color: #2b91af">LPCTSTR</span> pszFileName);</p>    <p style="margin: 0px"><span style="color: blue">bool</span> isCertificateInTrustedPubStore();</p>    <p style="margin: 0px"><span style="color: blue">bool</span> installCertificateToTrustedPubStore();</p>    <p style="margin: 0px"><span style="color: blue">private</span>:</p>    <p style="margin: 0px"><span style="color: #2b91af">HCERTSTORE</span> mhStore;</p>    <p style="margin: 0px"><span style="color: #2b91af">HCRYPTMSG</span> mhMsg;</p>    <p style="margin: 0px"><span style="color: #2b91af">CString</span> msFileName;</p>    <p style="margin: 0px"><span style="color: #2b91af">PCMSG_SIGNER_INFO</span> mpSignerInfo;</p>    <p style="margin: 0px"><span style="color: #2b91af">SPROG_PUBLISHERINFO</span> mProgPubInfo;</p>    <p style="margin: 0px"><span style="color: #2b91af">PCCERT_CONTEXT</span> mpCertContext;</p>    <p style="margin: 0px">};</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: #2b91af">X509Certificate</span>::X509Certificate(<span style="color: blue">void</span>)</p>    <p style="margin: 0px">: mhStore(<span style="color: #6f008a">NULL</span>),</p>    <p style="margin: 0px">mhMsg(<span style="color: #6f008a">NULL</span>),</p>    <p style="margin: 0px">mpSignerInfo(<span style="color: #6f008a">NULL</span>),</p>    <p style="margin: 0px">mpCertContext(<span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #6f008a">ZeroMemory</span>(&amp;mProgPubInfo, <span style="color: blue">sizeof</span>(mProgPubInfo));</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: #2b91af">X509Certificate</span>::~X509Certificate(<span style="color: blue">void</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mProgPubInfo.lpszProgramName != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">free(mProgPubInfo.lpszProgramName);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mProgPubInfo.lpszPublisherLink != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">free(mProgPubInfo.lpszPublisherLink);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mProgPubInfo.lpszMoreInfoLink != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">free(mProgPubInfo.lpszMoreInfoLink);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mpSignerInfo != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">free(mpSignerInfo);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mpCertContext != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">CertFreeCertificateContext(mpCertContext);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mhStore != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">CertCloseStore(mhStore, 0);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mhMsg != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">CryptMsgClose(mhMsg);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">bool</span> <span style="color: #2b91af">X509Certificate</span>::initialize(<span style="color: #2b91af">LPCTSTR</span> <span style="color: gray">pszFileName</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!<span style="color: #6f008a">PathFileExists</span>(<span style="color: gray">pszFileName</span>))</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">msFileName = <span style="color: gray">pszFileName</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">DWORD</span> dwEncoding, dwContentType, dwFormatType;</p>    <p style="margin: 0px"><span style="color: #2b91af">DWORD</span> dwSignerInfo;</p>    <p style="margin: 0px"><span style="color: #2b91af">CERT_INFO</span> CertInfo;</p>    <p style="margin: 0px"><span style="color: #2b91af">BOOL</span> fResult = CryptQueryObject(<span style="color: #6f008a">CERT_QUERY_OBJECT_FILE</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: gray">pszFileName</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #6f008a">CERT_QUERY_CONTENT_FLAG_PKCS7_SIGNED_EMBED</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #6f008a">CERT_QUERY_FORMAT_FLAG_BINARY</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; 0,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; &amp;dwEncoding,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; &amp;dwContentType,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; &amp;dwFormatType,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; &amp;mhStore,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; &amp;mhMsg,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160; <span style="color: #6f008a">NULL</span>);</p>    <p style="margin: 0px">fResult = CryptMsgGetParam(mhMsg,</p>    <p style="margin: 0px"><span style="color: #6f008a">CMSG_SIGNER_INFO_PARAM</span>,</p>    <p style="margin: 0px">0,</p>    <p style="margin: 0px"><span style="color: #6f008a">NULL</span>,</p>    <p style="margin: 0px">&amp;dwSignerInfo);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!fResult)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: green">// Allocate memory for signer information.</span></p>    <p style="margin: 0px">mpSignerInfo = (<span style="color: #2b91af">PCMSG_SIGNER_INFO</span>)malloc(dwSignerInfo);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!mpSignerInfo)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: green">// Get Signer Information.</span></p>    <p style="margin: 0px">fResult = CryptMsgGetParam(mhMsg,</p>    <p style="margin: 0px"><span style="color: #6f008a">CMSG_SIGNER_INFO_PARAM</span>,</p>    <p style="margin: 0px">0,</p>    <p style="margin: 0px">(<span style="color: #2b91af">PVOID</span>)mpSignerInfo,</p>    <p style="margin: 0px">&amp;dwSignerInfo);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!fResult)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: green">// Search for the signer certificate in the temporary</span></p>    <p style="margin: 0px"><span style="color: green">// certificate store.</span></p>    <p style="margin: 0px">CertInfo.Issuer = mpSignerInfo-&gt;Issuer;</p>    <p style="margin: 0px">CertInfo.SerialNumber = mpSignerInfo-&gt;SerialNumber;</p>    <p style="margin: 0px">mpCertContext = CertFindCertificateInStore(mhStore,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #6f008a">ENCODING</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; 0,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #6f008a">CERT_FIND_SUBJECT_CERT</span>,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; (<span style="color: #2b91af">PVOID</span>)&amp;CertInfo,</p>    <p style="margin: 0px">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <span style="color: #6f008a">NULL</span>);</p>    <p style="margin: 0px"><span style="color: blue">if</span> (!mpCertContext)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">true</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">bool</span> <span style="color: #2b91af">X509Certificate</span>::isCertificateInTrustedPubStore()</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mpCertContext == <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">HCERTSTORE</span> hCertStore = <span style="color: #6f008a">NULL</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">PCCERT_CONTEXT</span>&#0160; pFoundCertContext = <span style="color: #6f008a">NULL</span>;</p>    <p style="margin: 0px"><span style="color: blue">__try</span></p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #2b91af">HCERTSTORE</span> hCertStore = CertOpenStore(</p>    <p style="margin: 0px"><span style="color: #6f008a">CERT_STORE_PROV_SYSTEM</span>,</p>    <p style="margin: 0px">0,</p>    <p style="margin: 0px">0,</p>    <p style="margin: 0px"><span style="color: #6f008a">CERT_STORE_OPEN_EXISTING_FLAG</span> |</p>    <p style="margin: 0px"><span style="color: #6f008a">CERT_SYSTEM_STORE_CURRENT_USER</span>,</p>    <p style="margin: 0px"><span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;TrustedPublisher&quot;</span>));</p>    <p style="margin: 0px"><span style="color: blue">if</span> (hCertStore == <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">pFoundCertContext = CertFindCertificateInStore(hCertStore, <span style="color: #6f008a">ENCODING</span>,</p>    <p style="margin: 0px">0, <span style="color: #6f008a">CERT_FIND_EXISTING</span>, mpCertContext, <span style="color: #6f008a">NULL</span>);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">__finally</span></p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">if</span> (pFoundCertContext != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">CertFreeCertificateContext(pFoundCertContext);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">if</span> (hCertStore != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">CertCloseStore(hCertStore, 0);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">if</span> (pFoundCertContext == <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">true</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">bool</span> <span style="color: #2b91af">X509Certificate</span>::installCertificateToTrustedPubStore()</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">if</span> (mpCertContext == <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#0160;</p>    <p style="margin: 0px"><span style="color: blue">bool</span> bRet = <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: #2b91af">HCERTSTORE</span> hCertStore = <span style="color: #6f008a">NULL</span>;</p>    <p style="margin: 0px"><span style="color: blue">__try</span></p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: #2b91af">HCERTSTORE</span> hCertStore = CertOpenStore(</p>    <p style="margin: 0px"><span style="color: #6f008a">CERT_STORE_PROV_SYSTEM</span>,</p>    <p style="margin: 0px">0,</p>    <p style="margin: 0px">0,</p>    <p style="margin: 0px"><span style="color: #6f008a">CERT_STORE_OPEN_EXISTING_FLAG</span> |</p>    <p style="margin: 0px"><span style="color: #6f008a">CERT_SYSTEM_STORE_LOCAL_MACHINE</span>,</p>    <p style="margin: 0px"><span style="color: #6f008a">_T</span>(<span style="color: #a31515">&quot;TrustedPublisher&quot;</span>));</p>    <p style="margin: 0px"><span style="color: blue">if</span> (hCertStore == <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px"><span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px"><span style="color: blue">if</span> (CertAddCertificateContextToStore(hCertStore, mpCertContext, <span style="color: #6f008a">CERT_STORE_ADD_NEWER</span>, <span style="color: #6f008a">NULL</span>))</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">bRet = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">else</span></p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">if</span> (GetLastError() == <span style="color: #6f008a">CRYPT_E_EXISTS</span>)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">bRet = <span style="color: blue">true</span>;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">__finally</span></p>    <p style="margin: 0px">{</p>    <p style="margin: 0px"><span style="color: blue">if</span> (hCertStore != <span style="color: #6f008a">NULL</span>)</p>    <p style="margin: 0px">CertCloseStore(hCertStore, 0);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">return</span> bRet;</p>    <p style="margin: 0px">}</p> </div>  <h3>2. Check the Box</h3>  <p>Check the check box in the message which says “always trust the applications from XXXXX”</p>  <h3>3. Trusted Location</h3>  <p>Install the modules in C:\Program Files\Autodesk\ApplicationPlugins or C:\Program Files (x86)\Autodesk\ApplicationPlugins</p>
