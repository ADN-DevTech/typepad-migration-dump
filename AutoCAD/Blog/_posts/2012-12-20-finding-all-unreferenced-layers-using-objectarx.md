---
layout: "post"
title: "Finding all unreferenced Layers using ObjectARX"
date: "2012-12-20 16:36:58"
author: "Fenton Webb"
categories:
  - "2010"
  - "2011"
  - "2012"
  - "2013"
  - "AutoCAD"
  - "Fenton Webb"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2012/12/finding-all-unreferenced-layers-using-objectarx.html "
typepad_basename: "finding-all-unreferenced-layers-using-objectarx"
typepad_status: "Publish"
---

<p>by <a href="http://adndevblog.typepad.com/autocad/fenton-webb.html"><font color="#0066cc">Fenton Webb</font></a></p>  <p><b>Issue</b></p>  <p>How do I find the unreferenced layers in my database?</p>  <p><a name="section2"></a></p>  <p><b>Solution</b></p>  <p>The AcDbDatabase::purge() function does this for youâ€¦</p>  <p>Simply add all the AcDbObjectId's of AcDbLayerTableRecord's to a AcDbObjectIdArray and then call the AcDbDatabase::purge() function. </p>  <p>The following code segment demonstrates how to do this:</p>  <div style="font-family: ; background: white; color: ">   <p style="margin: 0px"><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 8pt">static</font></font></span><font style="font-size: 8pt"><font color="#000000"> </font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">layersReferenced</font></span><font color="#000000"> () </font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// get the working database</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbDatabase</font></span><font color="#000000"> *</font><span style="color: "><font color="#010001">db</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">acdbHostApplicationServices</font></span><font color="#000000">()-&gt;</font><span style="color: "><font color="#010001">workingDatabase</font></span><font color="#000000">();</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// now open the layer table for read</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbLayerTablePointer</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">layerTable</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">db</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">AcDb</font></span><font color="#000000">::</font><span style="color: "><font color="#010001">kForRead</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// create a new iterator to loop through all the layers</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbLayerTableIterator</font></span><font color="#000000"> *</font><span style="color: "><font color="#010001">layerTableIterator</font></span><font color="#000000"> ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">layerTable</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">newIterator</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">layerTableIterator</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbObjectId</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">id</font></span><font color="#000000"> ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbObjectIdArray</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbObjectIdArray</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">layersReferenced</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// iterate through the all layers and collect their ids</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (; !</font><span style="color: "><font color="#010001">layerTableIterator</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">done</font></span><font color="#000000"> (); </font><span style="color: "><font color="#010001">layerTableIterator</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">step</font></span><font color="#000000">()) </font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">layerTableIterator</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">getRecordId</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">id</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">append</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">id</font></span><font color="#000000">) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">layersReferenced</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">append</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">id</font></span><font color="#000000">) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">delete</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">layerTableIterator</font></span><font color="#000000"> ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// this will remove ids with have hard references on them </font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// what remains is the ids of the unused layers</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">db</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">purge</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000">) != </font><span style="color: "><font color="#010001">Acad</font></span><font color="#000000">::</font><span style="color: "><font color="#010001">eOk</font></span><font color="#000000"> ) </font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acutPrintf</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;\nPurge failed!&quot;</font></span><font color="#000000">)) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// print unused layers</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acutPrintf</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;\nLayers not used&quot;</font></span><font color="#000000">)) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">i</font></span><font color="#000000">=0 ; </font><span style="color: "><font color="#010001">i</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">length</font></span><font color="#000000">(); ++</font><span style="color: "><font color="#010001">i</font></span><font color="#000000">) </font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">id</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000">[</font><span style="color: "><font color="#010001">i</font></span><font color="#000000">];</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// open the layer for read</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbLayerTableRecordPointer</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">layerTableRecord</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">id</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">AcDb</font></span><font color="#000000">::</font><span style="color: "><font color="#010001">kForRead</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// if ok</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">layerTableRecord</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">openStatus</font></span><font color="#000000">() == </font><span style="color: "><font color="#010001">Acad</font></span><font color="#000000">::</font><span style="color: "><font color="#010001">eOk</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">TCHAR</font></span><font color="#000000"> *</font><span style="color: "><font color="#010001">name</font></span><font color="#000000"> ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// get and dump the layer name</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">layerTableRecord</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">getName</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">name</font></span><font color="#000000">) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acutPrintf</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;\nLayername : %s&quot;</font></span><font color="#000000">), </font><span style="color: "><font color="#010001">name</font></span><font color="#000000">) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// take the unused layers out from the array of all layers</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">i</font></span><font color="#000000">=0; </font><span style="color: "><font color="#010001">i</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">length</font></span><font color="#000000"> (); ++</font><span style="color: "><font color="#010001">i</font></span><font color="#000000">) </font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">layersReferenced</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">remove</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000"> [</font><span style="color: "><font color="#010001">i</font></span><font color="#000000">]) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// print used layers</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acutPrintf</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;\nLayers used&quot;</font></span><font color="#000000">)) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">i</font></span><font color="#000000">=0; </font><span style="color: "><font color="#010001">i</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#010001">layersReferenced</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">length</font></span><font color="#000000">(); ++</font><span style="color: "><font color="#010001">i</font></span><font color="#000000">) </font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">id</font></span><font color="#000000"> = </font><span style="color: "><font color="#010001">layersNotReferenced</font></span><font color="#000000">[</font><span style="color: "><font color="#010001">i</font></span><font color="#000000">];</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// open the layer for read</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">AcDbLayerTableRecordPointer</font></span><font color="#000000"> </font><span style="color: "><font color="#010001">layerTableRecord</font></span><font color="#000000">(</font><span style="color: "><font color="#010001">id</font></span><font color="#000000">, </font><span style="color: "><font color="#010001">AcDb</font></span><font color="#000000">::</font><span style="color: "><font color="#010001">kForRead</font></span><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// if ok</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">layerTableRecord</font></span><font color="#000000">.</font><span style="color: "><font color="#010001">openStatus</font></span><font color="#000000">() == </font><span style="color: "><font color="#010001">Acad</font></span><font color="#000000">::</font><span style="color: "><font color="#010001">eOk</font></span><font color="#000000">)</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">TCHAR</font></span><font color="#000000"> *</font><span style="color: "><font color="#010001">name</font></span><font color="#000000"> ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 8pt" color="#008000">// get and dump the layer name</font></span></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">layerTableRecord</font></span><font color="#000000">-&gt;</font><span style="color: "><font color="#010001">getName</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">name</font></span><font color="#000000">) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span style="color: "><font color="#010001">acutPrintf</font></span><font color="#000000"> (</font><span style="color: "><font color="#010001">_T</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;\nLayername : %s&quot;</font></span><font color="#000000">), </font><span style="color: "><font color="#010001">name</font></span><font color="#000000">) ;</font></font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">}</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Consolas"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p> </div>
