---
layout: "post"
title: "Add block reference to a tool palette"
date: "2012-05-28 08:10:09"
author: "Adam Nagy"
categories:
  - ".NET"
  - "Adam Nagy"
  - "AutoCAD"
  - "ObjectARX"
original_url: "https://adndevblog.typepad.com/autocad/2012/05/add-block-reference-to-a-tool-palette.html "
typepad_basename: "add-block-reference-to-a-tool-palette"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/adam-nagy.html" target="_self">Adam Nagy</a></p>  <p>In the user interface you can select a block reference in the drawing and simply drag &amp; drop it onto a tool palette. I would like to do the same programmatically: add a new item to the tool palette that references a given block and create a preview image for it.</p>  <p><a name="section2"></a></p>  <p><b>Solution</b></p>  <p>You can not only drag &amp; drop a block reference onto a tool palette, but you can also copy-paste it onto the tool palette. And this is what the following solution takes advantage of. We COPYCLIP the block reference and then call the Paste() function of the tool palette.</p>  <p>Here is the ObjectARX solution:</p>  <div style="font-family: courier new; background: white; color: black; font-size: 8pt">   <p style="margin: 0px"><span style="line-height: 140%; color: blue">static</span><span style="line-height: 140%"> </span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%"> BlockRefToToolPalette(</span><span style="line-height: 140%; color: blue">void</span><span style="line-height: 140%">)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">{</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// select block reference</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ads_name name;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; ads_point pt;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (acedEntSel(L</span><span style="line-height: 140%; color: #a31515">&quot;Select block reference&quot;</span><span style="line-height: 140%">, name, pt) != RTNORM)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// get the tool palette where we want to add an item</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CAcTcUiToolPaletteSet* ps = AcTcUiGetToolPaletteWindow();</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; CAcTcUiToolPalette* pal = </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; ps-&gt;FindPalette(L</span><span style="line-height: 140%; color: #a31515">&quot;Architectural&quot;</span><span style="line-height: 140%">, NULL, FALSE);</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pal == NULL)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// copyclip the block reference</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (acedCommand(</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; RTSTR, L</span><span style="line-height: 140%; color: #a31515">&quot;_COPYCLIP&quot;</span><span style="line-height: 140%">, RTENAME, </span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160;&#160;&#160; name, RTSTR, L</span><span style="line-height: 140%; color: #a31515">&quot;&quot;</span><span style="line-height: 140%">, RTNONE) != RTNORM)</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">return</span><span style="line-height: 140%">;</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: green">// paste the clipboard onto the palette</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; IDataObject* pdo;</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (SUCCEEDED(::OleGetClipboard(&amp;pdo)))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; </span><span style="line-height: 140%; color: blue">if</span><span style="line-height: 140%"> (pal-&gt;Paste(pdo, 0, NULL))</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; {</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 140%; color: green">// success</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160;&#160;&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">&#160; }</span></p>    <p style="margin: 0px"><span style="line-height: 140%">}</span></p> </div>  <p>Since the above ARX functions do not have corresponding .NET wrappers, we need to P/Invoke those functions.   <br />Note that the DllImport.EntryPoints are specific to AutoCAD 2010. In case of other AutoCAD versions you would need to use a tool like e.g. Dependency Walker (depends.exe) to check the correct entry point. </p>  <div style="font-family: Courier New; font-size: 8pt; color: black; background: white;"> <p style="margin: 0px;"><span style="line-height: 140%;">[DllImport(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;acad.exe&quot;</span><span style="line-height: 140%;">,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CallingConvention = CallingConvention.Cdecl,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CharSet = CharSet.Unicode,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; EntryPoint = </span><span style="color: #a31515; line-height: 140%;">&quot;acedCmd&quot;</span><span style="line-height: 140%;">)]</span></p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">extern</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;"> acedCmd(System.IntPtr resBuf);</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">[DllImport(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;AcTcUi.dll&quot;</span><span style="line-height: 140%;">,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CallingConvention = CallingConvention.Cdecl,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CharSet = CharSet.Unicode,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; EntryPoint = </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;?AcTcUiGetToolPaletteWindow@@YAPAVCAcTcUiToolPaletteSet@@XZ&quot;</span><span style="line-height: 140%;">)]</span></p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">extern</span><span style="line-height: 140%;"> System.IntPtr AcTcUiGetToolPaletteWindow();</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">[DllImport(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;AcTcUi.dll&quot;</span><span style="line-height: 140%;">,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CallingConvention = CallingConvention.ThisCall,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CharSet = CharSet.Unicode,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; EntryPoint = </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;?FindPalette@CAcTcUiToolPaletteSet@@QBEPAVCAcTcUiToolPalette&quot;</span><span style="line-height: 140%;"> +</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;@@PB_WPAPAVCAcTcUiToolPaletteGroup@@H@Z&quot;</span><span style="line-height: 140%;">)]</span></p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">extern</span><span style="line-height: 140%;"> System.IntPtr CAcTcUiToolPaletteSet_FindPalette(&nbsp; </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; System.IntPtr paletteSet, </span><span style="color: blue; line-height: 140%;">string</span><span style="line-height: 140%;"> name, System.IntPtr group,&nbsp;&nbsp; </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> searchOnlyCurrentGroup);</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">[DllImport(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;AcTcUi.dll&quot;</span><span style="line-height: 140%;">,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CallingConvention = CallingConvention.ThisCall,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; CharSet = CharSet.Unicode,</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; EntryPoint = </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;?Paste@CAcTcUiToolPalette@@UAEHPAUIDataObject@@HPAV?$&quot;</span><span style="line-height: 140%;"> +</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: #a31515; line-height: 140%;">&quot;CTypedPtrArray@VCPtrArray@@PAVAcTcCatalogItem@@@@@Z&quot;</span><span style="line-height: 140%;">)]</span></p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">static</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">extern</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">bool</span><span style="line-height: 140%;"> CAcTcUiToolPalette_Paste( </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; System.IntPtr palette, </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; System.Runtime.InteropServices.ComTypes.IDataObject data,&nbsp;&nbsp; </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;"> index, System.IntPtr resultList);</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">[CommandMethod(</span><span style="color: #a31515; line-height: 140%;">&quot;BlockRefToToolPalette&quot;</span><span style="line-height: 140%;">)]</span></p> <p style="margin: 0px;"><span style="color: blue; line-height: 140%;">public</span><span style="line-height: 140%;"> </span><span style="color: blue; line-height: 140%;">void</span><span style="line-height: 140%;"> BlockRefToToolPalette()</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">{</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; Editor ed = Application.DocumentManager.MdiActiveDocument.Editor;</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; PromptEntityResult per = </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; ed.GetEntity(</span><span style="color: #a31515; line-height: 140%;">&quot;Select block reference to add to tool palette&quot;</span><span style="line-height: 140%;">);</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (per.Status == PromptStatus.OK)</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; {</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// find tool palette you need</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; System.IntPtr ps = AcTcUiGetToolPaletteWindow();</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; System.IntPtr pal = </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; CAcTcUiToolPaletteSet_FindPalette(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; ps, </span><span style="color: #a31515; line-height: 140%;">&quot;Architectural&quot;</span><span style="line-height: 140%;">, System.IntPtr.Zero, </span><span style="color: blue; line-height: 140%;">false</span><span style="line-height: 140%;">);</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (pal != System.IntPtr.Zero)</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; {</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// copyclip the block reference</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; ResultBuffer rb = </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> ResultBuffer();</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; rb.Add(</span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> TypedValue((</span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;">)LispDataType.Text, </span><span style="color: #a31515; line-height: 140%;">&quot;_COPYCLIP&quot;</span><span style="line-height: 140%;">));</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; rb.Add(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> TypedValue((</span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;">)LispDataType.ObjectId, per.ObjectId));</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; rb.Add(</span><span style="color: blue; line-height: 140%;">new</span><span style="line-height: 140%;"> TypedValue((</span><span style="color: blue; line-height: 140%;">int</span><span style="line-height: 140%;">)LispDataType.Text));</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: green; line-height: 140%;">// if copyclip was OK</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; </span><span style="color: blue; line-height: 140%;">if</span><span style="line-height: 140%;"> (acedCmd(rb.UnmanagedObject) == 5100</span><span style="color: green; line-height: 140%;">/*RTNORM*/</span><span style="line-height: 140%;">)</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; {</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; System.Runtime.InteropServices.ComTypes.IDataObject </span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; comDataObject =</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (System.Runtime.InteropServices.ComTypes.IDataObject)</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.Windows.Forms.Clipboard.GetDataObject();</span></p> <p style="margin: 0px;">&nbsp;</p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; CAcTcUiToolPalette_Paste(</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pal, comDataObject, 0, System.IntPtr.Zero);</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; &nbsp; }</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; &nbsp; }</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">&nbsp; }</span></p> <p style="margin: 0px;"><span style="line-height: 140%;">}</span></p> <p style="margin: 0px;">&nbsp;</p> </div>
