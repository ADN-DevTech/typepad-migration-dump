---
layout: "post"
title: "ReadDwgFile fail on files open in another AutoCAD"
date: "2013-01-22 10:55:43"
author: "Augusto Goncalves"
categories: []
original_url: "https://adndevblog.typepad.com/autocad/2013/01/readdwgfile-fail-on-files-open-in-another-autocad.html "
typepad_basename: "readdwgfile-fail-on-files-open-in-another-autocad"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>When we want to open a DWG file that h is already open in another session of AutoCAD, any call to AcDbDatabase::readDwgFile() fails with the error eFileAccessErr. </p>  <p>Basically we cannot open a DWG files in read-only state. </p>  <p>The problem is that readDwgFile() reads not the whole DWG file into memory. readDwgFile() opens the file and reads only some header information. Every time when we access an entity/object/symboltable... in the drawing file, AutoCAD reads another part of the DWG file. When an other instance of AutoCAD saves during your read process the drawing, it can happen that your application/AutoCAD gets an invalid file pointer. </p>  <p>The workaround is to copy the DWG file to a temporary location if you get eFileAccessErr on readDwgFile() and to try again to open the temporary DWG file. The following code does this.</p>  <p><strong><u>NOTE</u></strong>: Don't forget that you are working on a temporary copy of the drawing. Any changes you are doing on the drawing will be lost because you have to delete the temp file.</p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 8pt">void</font></font></span><font style="font-size: 8pt" color="#000000"> loadDwgReadOnly()</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// TODO: add your code here </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; BOOL isReadOnly = FALSE; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; ACHAR dwgFileName[MAX_PATH];</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; resbuf *rb = acutNewRb(RTSTR);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (RTNORM != acedGetFileD(L</font><span><font color="#a31515">&quot;Select File to read&quot;</font></span><font color="#000000">,</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; NULL, L</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;dwg&quot;</font></span><font color="#000000">, 0, rb)) </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; {&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; acutRelRb(rb);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000">; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; } </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; _tcscpy(dwgFileName, rb-&gt;resval.rstring); </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; acutRelRb(rb); </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; Acad::ErrorStatus es;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; AcDbDatabase db(Adesk::kFalse);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> ((Acad::eOk != (es = db.readDwgFile(dwgFileName)))) </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; {&#160;&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (Acad::eFileAccessErr == es)&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; {&#160;&#160;&#160;&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//&#160;&#160;&#160; </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// Copy the file and try again&#160;&#160;&#160;&#160; </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">//&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; ACHAR tempPath[MAX_PATH], tempName[MAX_PATH];&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// Get a temporary file name&#160;&#160;&#160; </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; GetTempPath(MAX_PATH, tempPath); </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; GetTempFileNameW(tempPath, L</font></font><font style="font-size: 8pt"><span><font color="#a31515">&quot;dwg&quot;</font></span><font color="#000000">, 0, tempName); </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (!CopyFile(dwgFileName, tempName, FALSE))&#160;&#160;&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000">;&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> ((Acad::eOk != (es = db.readDwgFile(tempName))))&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">return</font></span><font color="#000000">;&#160;&#160;&#160;&#160; </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; isReadOnly = TRUE;&#160;&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160;&#160;&#160; _tcscpy(dwgFileName, tempName);&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; } </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; } </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// Now you can query information from the readed dwg file </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// ****</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// ****</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// ****</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><span><font style="font-size: 8pt" color="#008000">// Delete the temp file </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 8pt">&#160; </font></font><font style="font-size: 8pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (isReadOnly) </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; {&#160;&#160; </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; DeleteFile(dwgFileName);</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">&#160; } </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 8pt" color="#000000">}</font></font></p> </div>
