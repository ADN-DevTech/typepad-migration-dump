---
layout: "post"
title: "Mimic Line Number &gt; New feature on Plant 3D &ndash; 2.0"
date: "2015-07-23 10:09:33"
author: "Augusto Goncalves"
categories:
  - ".NET"
  - "Augusto Goncalves"
  - "Plant3D"
original_url: "https://adndevblog.typepad.com/autocad/2015/07/mimic-line-number-new-feature-on-plant-3d-20.html "
typepad_basename: "mimic-line-number-new-feature-on-plant-3d-20"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>This is an expanded version of what as previously <a href="http://adndevblog.typepad.com/autocad/2015/04/mimic-line-number-new-feature-on-plant-3d.html">posted here</a>, hence the 2.0</p>  <p>But what was missing on version 1.0?</p>  <p>Actually it considered just one element at a time. Also, it ignored the related elements, like connectors, for instance. Now the sample below get a selection of entities, then find related elements (like P3dConnector and Universal) and add them all to the newly create group.</p>  <p>Thanks to Jens Dorstewitz (ADN Partner) for helping improve it.</p>  <pre style="font-size: 13px; font-family: consolas; background: white; color: black">[<span style="color: #2b91af">CommandMethod</span>(<span style="color: #a31515">&quot;customNewTag&quot;</span>)]<br /><span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> CmdCustomNewTag()<br />{<br />&#160; <span style="color: #2b91af">Editor</span> ed = <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument.Editor;<br /> <br />&#160; <span style="color: #2b91af">PromptSelectionResult</span>&#160; per = ed.GetSelection();<br />&#160; <span style="color: blue">if</span> (per.Status != <span style="color: #2b91af">PromptStatus</span>.OK) <span style="color: blue">return</span>;<br /> <br />&#160; <span style="color: #2b91af">PromptResult</span> pr = ed.GetString(<span style="color: #a31515">&quot;\nEnter new tag: &quot;</span>);<br />&#160; <span style="color: blue">if</span> (pr.Status != <span style="color: #2b91af">PromptStatus</span>.OK) <span style="color: blue">return</span>;<br /> <br />&#160; <span style="color: #2b91af">ObjectIdCollection</span> ids = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">ObjectIdCollection</span>();<br />&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">SelectedObject</span> selObj <span style="color: blue">in</span> per.Value)<br />&#160;&#160;&#160; ids.Add(selObj.ObjectId);<br /> <br />&#160; CreateNewTag(ids, pr.StringResult);<br />}<br /> <br /><span style="color: blue">private</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">void</span> CreateNewTag(<span style="color: #2b91af">ObjectIdCollection</span> itemIds, <span style="color: blue">string</span> newTagValue)<br />{<br />&#160; <span style="color: #2b91af">PlantProject</span> currentProj = <span style="color: #2b91af">PlantApplication</span>.CurrentProject;<br />&#160; <span style="color: #2b91af">PipingProject</span> pipeProj = (<span style="color: #2b91af">PipingProject</span>)currentProj.ProjectParts[<span style="color: #a31515">&quot;Piping&quot;</span>];<br />&#160; <span style="color: #2b91af">DataLinksManager</span> dlm = pipeProj.DataLinksManager;<br />&#160; <span style="color: #2b91af">PnPDatabase</span> db = dlm.GetPnPDatabase();<br /> <br />&#160; <span style="color: green">// create new line group</span><br />&#160; <span style="color: #2b91af">PnPTable</span> p3dLineGroupTable = db.Tables[<span style="color: #a31515">&quot;P3dLineGroup&quot;</span>];<br />&#160; <span style="color: #2b91af">PnPRow</span> lgRow = p3dLineGroupTable.NewRow();<br />&#160; lgRow[<span style="color: #a31515">&quot;Tag&quot;</span>] = newTagValue;<br />&#160; p3dLineGroupTable.Rows.Add(lgRow);<br />&#160; <span style="color: blue">int</span> newLineGroupId = lgRow.RowId;<br /> <br />&#160; <span style="color: green">// rowIds of the selected items</span><br />&#160; <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; rowIds = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();<br />&#160; <span style="color: blue">foreach</span> (<span style="color: #2b91af">ObjectId</span> itemId <span style="color: blue">in</span> itemIds)<br />&#160;&#160;&#160; rowIds.Add(dlm.FindAcPpRowId(itemId));<br /> <br />&#160; <span style="color: green">// now the rowIds list contain only the </span><br />&#160; <span style="color: green">// items selected on screen, but we need more</span><br />&#160; <span style="color: green">// elements related to those</span><br />&#160; <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; relateRowIds = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();<br />&#160; <span style="color: blue">foreach</span> (<span style="color: blue">int</span> itemRowId <span style="color: blue">in</span> rowIds)<br />&#160; {<br />&#160;&#160;&#160; <span style="color: green">// only Olet, skip others.</span><br />&#160;&#160;&#160; <span style="color: blue">if</span> (db.GetRowTableName(itemRowId) != <span style="color: #a31515">&quot;Olet&quot;</span>) <span style="color: blue">continue</span>;<br /> <br />&#160;&#160;&#160; <span style="color: green">// get the P3dConnectors</span><br />&#160;&#160;&#160; <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; p3dConnectorIds = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();<br />&#160;&#160;&#160; p3dConnectorIds.AddRange(<br />&#160;&#160;&#160;&#160;&#160; dlm.GetRelatedRowIds(<span style="color: #a31515">&quot;P3dPartConnection&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;Part1&quot;</span>, itemRowId, <span style="color: #a31515">&quot;Part2&quot;</span>));<br />&#160;&#160;&#160; p3dConnectorIds.AddRange(<br />&#160;&#160;&#160;&#160;&#160; dlm.GetRelatedRowIds(<span style="color: #a31515">&quot;P3dPartConnection&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;Part2&quot;</span>, itemRowId, <span style="color: #a31515">&quot;Part1&quot;</span>));<br /> <br />&#160;&#160;&#160; <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; universals = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();<br />&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">int</span> connectorId <span style="color: blue">in</span> p3dConnectorIds)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; <span style="color: green">// now the Universal:</span><br />&#160;&#160;&#160;&#160;&#160; <span style="color: green">// the PnPDataLinks table should contain both</span><br />&#160;&#160;&#160;&#160;&#160; <span style="color: green">// P3dConnector and Universal, and both share the </span><br />&#160;&#160;&#160;&#160;&#160; <span style="color: green">// same DwgHandleLow value, so find the first and</span><br />&#160;&#160;&#160;&#160;&#160; <span style="color: green">// use this value to find the second</span><br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PnPTable</span> datalinksTable = db.Tables[<span style="color: #a31515">&quot;PnPDataLinks&quot;</span>];<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PnPRow</span>[] rows = datalinksTable.Select(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;\&quot;RowId\&quot;={0}&quot;</span>, connectorId));<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span>(<span style="color: #2b91af">PnPRow</span> row <span style="color: blue">in</span> rows)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">PnPRow</span>[] universalRow = datalinksTable.Select(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;\&quot;DwgHandleLow\&quot;={0} AND \&quot;DwgSubIndex\&quot;=1&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; row[<span style="color: #a31515">&quot;DwgHandleLow&quot;</span>]));<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; universals.Add(<span style="color: blue">int</span>.Parse(universalRow[0][<span style="color: #a31515">&quot;RowId&quot;</span>].ToString()));<br />&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; <span style="color: green">// add what we found to the main list</span><br />&#160;&#160;&#160; relateRowIds.AddRange(p3dConnectorIds);<br />&#160;&#160;&#160; relateRowIds.AddRange(universals);<br />&#160; }<br /> <br />&#160; <span style="color: green">// finally a list with the selected elements</span><br />&#160; <span style="color: green">// plus all related elements</span><br />&#160; <span style="color: green">// now the rowIds should contain everything</span><br />&#160; <span style="color: green">// that needs to be added to the new line group</span><br />&#160; rowIds.AddRange(relateRowIds);<br /> <br />&#160; <span style="color: green">// .Distinct avoid duplicated</span><br />&#160; <span style="color: blue">foreach</span> (<span style="color: blue">int</span> itemRowId <span style="color: blue">in</span> rowIds.Distinct&lt;<span style="color: blue">int</span>&gt;().ToList&lt;<span style="color: blue">int</span>&gt;()) <br />&#160; {<br />&#160;&#160;&#160; <span style="color: green">// get all line groups related to the items we found</span><br />&#160;&#160;&#160; <span style="color: #2b91af">PnPRowIdArray</span> priorGroupIds = dlm.GetRelatedRowIds(<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;P3dLineGroupPartRelationship&quot;</span>, <span style="color: #a31515">&quot;Part&quot;</span>, itemRowId, <span style="color: #a31515">&quot;LineGroup&quot;</span>);<br /> <br />&#160;&#160;&#160; <span style="color: green">// remove them from any previous group</span><br />&#160;&#160;&#160; <span style="color: blue">if</span> (priorGroupIds.Count != 1)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">int</span> id <span style="color: blue">in</span> priorGroupIds)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; dlm.Unrelate(<span style="color: #a31515">&quot;P3dLineGroupPartRelationship&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;LineGroup&quot;</span>, id, <span style="color: #a31515">&quot;Part&quot;</span>, itemRowId);<br />&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; <span style="color: green">// make the new relation</span><br />&#160;&#160;&#160; <span style="color: blue">if</span> (newLineGroupId != -1 &amp;&amp; itemRowId != -1)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; dlm.Relate(<span style="color: #a31515">&quot;P3dLineGroupPartRelationship&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;LineGroup&quot;</span>, newLineGroupId, <span style="color: #a31515">&quot;Part&quot;</span>, itemRowId);<br />&#160;&#160;&#160; }<br />&#160; }<br /> <br />&#160; <span style="color: green">// relate the drawing to the line group</span><br />&#160; <span style="color: blue">int</span> dwgId = dlm.GetDrawingId(<br />&#160;&#160;&#160; <span style="color: #2b91af">Application</span>.DocumentManager.MdiActiveDocument.Database);<br />&#160; <span style="color: blue">if</span> (dwgId != -1)<br />&#160; {<br />&#160;&#160;&#160; dlm.Relate(<span style="color: #a31515">&quot;P3dDrawingLineGroupRelationship&quot;</span>,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;Drawing&quot;</span>, dwgId,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #a31515">&quot;LineGroup&quot;</span>, newLineGroupId);<br />&#160; }<br />}</pre>
