---
layout: "post"
title: "Vault Performance tip &ndash; don&rsquo;t access the server in a loop"
date: "2014-10-30 18:34:54"
author: "Wayne Brill"
categories:
  - "Vault"
  - "Wayne Brill"
original_url: "https://adndevblog.typepad.com/manufacturing/2014/10/vault-performance-tip-dont-access-the-server-in-a-loop.html "
typepad_basename: "vault-performance-tip-dont-access-the-server-in-a-loop"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/manufacturing/wayne-brill.html" target="_self">Wayne Brill</a></p>  <p>When using the Vault API to access the server you can improve performance by not having server calls inside a loop. Below is a code snippet that is using GetPropertyValue and GetFoldersByIds in a loop. (highlighted lines). In this example if there are 1,000 files in myResults, there will be 1,000 server calls. With network latency, there is just not a good way to make 1,000 server calls very quickly. </p>  <p>foreach (File myFile in myResults)    <br />{     <br />VDF.Vault.Currency.Entities.FileIteration fileIter = new VDF.Vault.Currency.Entities.FileIteration(base.VaultConnection, myFile); </p>  <p>   <br /><font style="background-color: #ffffff">EntityStatusImageInfo statusInfo = base.VaultConnection.PropertyManager.<font style="background-color: #00ff00">GetPropertyValue</font>(fileIter, statusProp, null) as EntityStatusImageInfo;       <br />MYVaultFileStatus myVltFileStatus = new MYVaultFileStatus(</font>myFile.Name<font style="background-color: #ffffff">); </font></p> <font style="background-color: #ffffff">   <p>&#160;</p> myVltFileStatus.VaultStatusText = statusInfo.Description;     <br />myVltFileStatus.VaultStatusImage = statusInfo.GetImage();     <br />long folderID = myFile.FolderId;     <br /><font style="background-color: #ffff00"><font style="background-color: #ffffff"></font></font></font>  <p><font style="background-color: #ffff00"><font style="background-color: #ffffff">var folderFoundIn = base.VaultConnection.FolderManager.<font style="background-color: #00ff00">GetFoldersByIds</font>(new long[] { folderID }</font><font style="background-color: #ffffff">); </font></font></p> <font style="background-color: #ffff00"><font style="background-color: #ffffff"></font>    <p>&#160;</p> </font><font style="background-color: #ffffff">VDF.Vault.Currency.Entities.Folder folderOfFile;    <br /></font>  <p>folderFoundIn.TryGetValue(folderID, out folderOfFile);    <br />myVltFileStatus.VaultPath = folderOfFile.FolderPath;     <br />myVltFileStatus.VaultFileID = myFile.Id;     <br />listDocumentStatus.Add(myVltFileStatus);     <br />}     <br /></p>  <p>A better approach is to use web service calls that allow you to retrieve properties for a group or batch of files with a single call to the server. These methods typically accept an array of IDs or proxy objects so that you can retrieve a large collection of values with a single call. </p>  <p>The PropertyManager GetPropertyValues is nearly identical to&#160; GetPropertyValue except that it takes an array of entities and property definitions and retrieves all the property values at once with a single server call. This is what “using batch API methods as a best practice” means.</p>  <p>Here is an update to the example code with just two calls to the server:</p>  <p>&#160; <br />// batch up entities to retrieve properties for     <br />List&lt;VDF.Vault.Currency.Entities.FileIteration&gt; fileIterations =     <br />new List&lt;VDF.Vault.Currency.Entities.FileIteration&gt;(myResults.Select(result =&gt; new VDF.Vault.Currency.Entities.FileIteration(base.VaultConnection, result))); </p>  <p>   <br />// make a single call to get property values     <br />VDF.Vault.Currency.Properties.PropertyValues propValues = base.VaultConnection.PropertyManager.GetPropertyValues(fileIterations, new VDF.Vault.Currency.Properties.PropertyDefinition[] { statusProp }, null);     <br /></p>  <p>// make a single call to get parent folders    <br />IDictionary&lt;long, VDF.Vault.Currency.Entities.Folder&gt; folderIdsToFolderEntities = base.VaultConnection.FolderManager.GetFoldersByIds(fileIterations.Select(file =&gt; myFile.FolderId));     <br /></p>  <p>// individually process results returned from the server    <br />foreach (VDF.Vault.Currency.Entities.IEntity fileIteration in fileIterations)     <br />{     <br />VDF.Vault.Currency.Properties.EntityStatusImageInfo statusInfo = propValues.GetValue(fileIteration, statusProp) as VDF.Vault.Currency.Properties.EntityStatusImageInfo;     <br />MYVaultFileStatus myVltFileStatus = new MYVaultFileStatus(fileIteration.EntityName);     <br /></p>  <p>stVltFileStatus.VaultStatusText = statusInfo.Description;    <br />stVltFileStatus.VaultStatusImage = statusInfo.GetImage();     <br />VDF.Vault.Currency.Entities.Folder folderOfFile;     <br /></p>  <p>if (folderIdsToFolderEntities.TryGetValue(fileIteration.FolderId, out folderOfFile))    <br />{     <br />stVltFileStatus.VaultPath = folderOfFile.FolderPath;     <br />}     <br />stVltFileStatus.VaultFileID = fileIteration.EntityIterationId;     <br />listDocumentStatus.Add(stVltFileStatus);     <br />}     <br /></p>  <p>The key is that the calls to the server have been moved outside the loop. </p>
