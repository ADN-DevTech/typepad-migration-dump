---
layout: "post"
title: "Apprentice leaves lockfile.lck files behind"
date: "2016-02-24 06:17:48"
author: "Adam Nagy"
categories:
  - "Adam Nagy"
  - "Inventor"
original_url: "https://adndevblog.typepad.com/manufacturing/2016/02/apprentice-leaves-lockfilelck-files-behind.html "
typepad_basename: "apprentice-leaves-lockfilelck-files-behind"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/manufacturing/adam-nagy.html" target="_self">Adam Nagy</a></p>
<p>When using <strong>Apprentice</strong>, it creates <strong>lockfile.lck</strong> files in the folders where the files you open with it reside. These only disappear once the process using&#0160;<strong>Apprentice</strong> exited. <br />However, as soon as you close the document the related lock file becomes deletable, so nothing&#0160;prevents you from deleting them or the folders they are in.</p>
<p>If you want to get rid of them as soon as possible then you could create a class that removes them automatically once you closed the <strong>Apprentice</strong> document. In<strong> .NET</strong> you could do something like this:</p>
<div style="line-height: 120%; color: #000; font-family: &#39;Courier New&#39;, Courier, Monospace; font-size: 10pt;">
<div style="background-color: #ffffff; overflow: auto; padding: 2px 5px; white-space: nowrap;"><span style="background: #ffffff; color: #0000ff;">using</span><span style="background: #ffffff; color: #000000;"> System;</span><br /> <span style="background: #ffffff; color: #0000ff;">using</span><span style="background: #ffffff; color: #000000;"> Inv = Inventor;</span><br /> <span style="background: #ffffff; color: #0000ff;">using</span><span style="background: #ffffff; color: #000000;"> SysIO = System.IO;</span><br /> <span style="background: #ffffff; color: #0000ff;">using</span><span style="background: #ffffff; color: #000000;"> Inventor;</span><br /> <span style="background: #ffffff; color: #0000ff;">using</span><span style="background: #ffffff; color: #000000;"> System.Collections.Generic; </span><br /> <br /> <span style="background: #ffffff; color: #0000ff;">namespace</span><span style="background: #ffffff; color: #000000;"> ApprenticeConsoleCS</span><br /> <span style="background: #ffffff; color: #000000;">{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">class</span> <span style="background: #ffffff; color: #2b91af;">Program</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;{</span><br /><span style="background: #ffffff; color: #000000;">&#0160; &#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">class</span> <span style="background: #ffffff; color: #2b91af;">LckMonitor</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #2b91af;">ApprenticeServerComponent</span><span style="background: #ffffff; color: #000000;"> asc;</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #2b91af;">Dictionary</span><span style="background: #ffffff; color: #000000;">&lt;</span><span style="background: #ffffff; color: #0000ff;">string</span><span style="background: #ffffff; color: #000000;">, </span><span style="background: #ffffff; color: #0000ff;">int</span><span style="background: #ffffff; color: #000000;">&gt; map; </span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">public</span><span style="background: #ffffff; color: #000000;"> LckMonitor(</span><span style="background: #ffffff; color: #2b91af;">ApprenticeServerComponent</span><span style="background: #ffffff; color: #000000;"> asc)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">this</span><span style="background: #ffffff; color: #000000;">.asc = asc;</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;map = </span><span style="background: #ffffff; color: #0000ff;">new</span> <span style="background: #ffffff; color: #2b91af;">Dictionary</span><span style="background: #ffffff; color: #000000;">&lt;</span><span style="background: #ffffff; color: #0000ff;">string</span><span style="background: #ffffff; color: #000000;">, </span><span style="background: #ffffff; color: #0000ff;">int</span><span style="background: #ffffff; color: #000000;">&gt;();</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;}</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">public</span> <span style="background: #ffffff; color: #2b91af;">ApprenticeServerDocument</span><span style="background: #ffffff; color: #000000;"> Open(</span><span style="background: #ffffff; color: #0000ff;">string</span><span style="background: #ffffff; color: #000000;"> fileName)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">var</span><span style="background: #ffffff; color: #000000;"> folder = System.IO.</span><span style="background: #ffffff; color: #2b91af;">Path</span><span style="background: #ffffff; color: #000000;">.GetDirectoryName(fileName);</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// Keep track of it</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">if</span><span style="background: #ffffff; color: #000000;"> (map.ContainsKey(folder))</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;map[folder]++;</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">else</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;map[folder] = 1;</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// Open it</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">return</span><span style="background: #ffffff; color: #000000;"> asc.Open(fileName); </span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;}</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">public</span> <span style="background: #ffffff; color: #0000ff;">void</span><span style="background: #ffffff; color: #000000;"> Close(</span><span style="background: #ffffff; color: #2b91af;">ApprenticeServerDocument</span><span style="background: #ffffff; color: #000000;"> doc)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">var</span><span style="background: #ffffff; color: #000000;"> folder = System.IO.</span><span style="background: #ffffff; color: #2b91af;">Path</span><span style="background: #ffffff; color: #000000;">.GetDirectoryName(doc.FullFileName);</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// Close it</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;doc.Close();</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// The folder should be in here already</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;System.Diagnostics.</span><span style="background: #ffffff; color: #2b91af;">Debug</span><span style="background: #ffffff; color: #000000;">.Assert(map.ContainsKey(folder));</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;map[folder]--;</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// If no one is referencing it now</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// then let&#39;s try to clean it up</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// It could be that another application will hold </span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// on to it though</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">if</span><span style="background: #ffffff; color: #000000;"> (map[folder] &lt; 1)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;map.Remove(folder);</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">try</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;System.IO.</span><span style="background: #ffffff; color: #2b91af;">File</span><span style="background: #ffffff; color: #000000;">.Delete(folder + </span><span style="background: #ffffff; color: #a31515;">&quot;\\lockfile.lck&quot;</span><span style="background: #ffffff; color: #000000;">);</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;}</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">catch</span><span style="background: #ffffff; color: #000000;"> { }</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;}</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;}</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;}</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;[</span><span style="background: #ffffff; color: #2b91af;">STAThread</span><span style="background: #ffffff; color: #000000;">]</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">static</span> <span style="background: #ffffff; color: #0000ff;">void</span><span style="background: #ffffff; color: #000000;"> Main(</span><span style="background: #ffffff; color: #0000ff;">string</span><span style="background: #ffffff; color: #000000;">[] args)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">string</span><span style="background: #ffffff; color: #000000;"> filename = </span><span style="background: #ffffff; color: #a31515;">@&quot;C:\temp\test.ipt&quot;</span><span style="background: #ffffff; color: #000000;">;</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #2b91af;">ApprenticeServerComponent</span><span style="background: #ffffff; color: #000000;"> asc = </span><span style="background: #ffffff; color: #0000ff;">new</span> <span style="background: #ffffff; color: #2b91af;">ApprenticeServerComponent</span><span style="background: #ffffff; color: #000000;">();</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #2b91af;">LckMonitor</span><span style="background: #ffffff; color: #000000;"> lckMonitor = </span><span style="background: #ffffff; color: #0000ff;">new</span> <span style="background: #ffffff; color: #2b91af;">LckMonitor</span><span style="background: #ffffff; color: #000000;">(asc);</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #2b91af;">ApprenticeServerDocument</span><span style="background: #ffffff; color: #000000;"> asd = lckMonitor.Open(filename);</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #008000;">// Interact with the apprentice document</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;lckMonitor.Close(asd); </span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;}</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;}</span><br /> <span style="background: #ffffff; color: #000000;">}</span></div>
</div>
<p>Another thing you could do is migrate&#0160;the <strong>Apprentice</strong> related functionality into a separate app. That way when the side process finishes the <strong>Apprentice</strong> component in it will finish too and will clean up those lock files. <a href="http://adndevblog.typepad.com/manufacturing/2016/02/use-apprentice-from-multi-threaded-application.html">This blog post</a>&#39;s solution includes that option as well.&#0160;&#0160;</p>
