---
layout: "post"
title: "IPictureDisp.Handle might be negative"
date: "2016-02-25 10:50:31"
author: "Adam Nagy"
categories:
  - "Adam Nagy"
  - "Inventor"
original_url: "https://adndevblog.typepad.com/manufacturing/2016/02/ipicturedisphandle-might-be-negative.html "
typepad_basename: "ipicturedisphandle-might-be-negative"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/manufacturing/adam-nagy.html" target="_self">Adam Nagy</a></p>
<p>As mentioned in <a href="http://modthemachine.typepad.com/my_weblog/2012/05/thumbnail-viewer-component-on-a-64-bit-system.html">this blog post</a> as well, for some reason&#0160;the <strong>Handle</strong> of the <strong>IPictureDisp</strong> returned by the <strong>Thumbnail</strong> property of <strong>ApprenticeServerDocument </strong>can&#0160;sometimes be negative.</p>
<p>I tested this with my own app as well - the one referenced&#0160;in <a href="http://adndevblog.typepad.com/manufacturing/2014/09/apprentice-in-side-thread.html">this blog post</a>.</p>
<p>Strangely, when my <strong>.NET</strong> app is compiled to <strong>32 bit</strong>, it seems to cause no issue for the&#0160;<strong><span class="s1">AxHostConverter</span></strong>.<strong>PictureDispToImage</strong>()&#0160;converter method (see below) to turn the&#0160;<strong>IPictureDisp</strong>&#0160;into a <strong>System.Drawing.Image</strong>:</p>
<div style="line-height: 120%; color: #000; font-family: &#39;Courier New&#39;, Courier, Monospace; font-size: 10pt;">
<div style="background-color: #ffffff; overflow: auto; padding: 2px 5px; white-space: nowrap;"><span style="background: #ffffff; color: #0000ff;">internal</span> <span style="background: #ffffff; color: #0000ff;">class</span> <span style="background: #ffffff; color: #2b91af;">AxHostConverter</span><span style="background: #ffffff; color: #000000;"> : </span><span style="background: #ffffff; color: #2b91af;">AxHost</span><br /> <span style="background: #ffffff; color: #000000;">{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">private</span><span style="background: #ffffff; color: #000000;"> AxHostConverter() : </span><span style="background: #ffffff; color: #0000ff;">base</span><span style="background: #ffffff; color: #000000;">(</span><span style="background: #ffffff; color: #a31515;">&quot;&quot;</span><span style="background: #ffffff; color: #000000;">) { }</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">static</span> <span style="background: #ffffff; color: #0000ff;">public</span><span style="background: #ffffff; color: #000000;"> stdole.</span><span style="background: #ffffff; color: #2b91af;">IPictureDisp</span><span style="background: #ffffff; color: #000000;"> ImageToPictureDisp(</span><span style="background: #ffffff; color: #2b91af;">Image</span><span style="background: #ffffff; color: #000000;"> image)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">return</span><span style="background: #ffffff; color: #000000;"> (stdole.</span><span style="background: #ffffff; color: #2b91af;">IPictureDisp</span><span style="background: #ffffff; color: #000000;">)GetIPictureDispFromPicture(image);</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;}</span><br /> <br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">static</span> <span style="background: #ffffff; color: #0000ff;">public</span> <span style="background: #ffffff; color: #2b91af;">Image</span><span style="background: #ffffff; color: #000000;"> PictureDispToImage(stdole.</span><span style="background: #ffffff; color: #2b91af;">IPictureDisp</span><span style="background: #ffffff; color: #000000;"> pictureDisp)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">return</span><span style="background: #ffffff; color: #000000;"> GetPictureFromIPicture(pictureDisp);</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;}</span><br /> <span style="background: #ffffff; color: #000000;">}</span></div>
</div>
<p>However, when my .<strong>NET</strong> app is <strong>64 bit</strong> then it is a problem and causes an exception. In that case the solution pointed out in the other blog post, i.e. accessing the <strong>Thumbnail</strong> multiple times, until the <strong>Handle</strong> of &#0160;<strong>IPictureDisp&#0160;</strong>is positive&#0160;solves the problem:</p>
<div style="line-height: 120%; color: #000; font-family: &#39;Courier New&#39;, Courier, Monospace; font-size: 10pt;">
<div style="background-color: #ffffff; overflow: auto; padding: 2px 5px; white-space: nowrap;"><span style="background: #ffffff; color: #000000;">stdole.</span><span style="background: #ffffff; color: #2b91af;">IPictureDisp</span><span style="background: #ffffff; color: #000000;"> pic = </span><span style="background: #ffffff; color: #0000ff;">null</span><span style="background: #ffffff; color: #000000;">;</span><br /> <span style="background: #ffffff; color: #0000ff;">bool</span><span style="background: #ffffff; color: #000000;"> retry;</span><br /> <span style="background: #ffffff; color: #0000ff;">int</span><span style="background: #ffffff; color: #000000;"> retryCounter = 0;</span><br /> <span style="background: #ffffff; color: #0000ff;">do</span><br /> <span style="background: #ffffff; color: #000000;">{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;retry = </span><span style="background: #ffffff; color: #0000ff;">false</span><span style="background: #ffffff; color: #000000;">;</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;pic = doc.Thumbnail;</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;System.Diagnostics.</span><span style="background: #ffffff; color: #2b91af;">Debug</span><span style="background: #ffffff; color: #000000;">.WriteLine(</span><span style="background: #ffffff; color: #a31515;">&quot;Handle = {0}&quot;</span><span style="background: #ffffff; color: #000000;">, pic.Handle);</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">if</span><span style="background: #ffffff; color: #000000;"> (pic.Handle &lt;= 0)</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;{</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;retry = </span><span style="background: #ffffff; color: #0000ff;">true</span><span style="background: #ffffff; color: #000000;">;</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;retryCounter++;</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;}</span><br /> <span style="background: #ffffff; color: #000000;">} </span><span style="background: #ffffff; color: #0000ff;">while</span><span style="background: #ffffff; color: #000000;"> (retry);</span><br /> <br /> <span style="background: #ffffff; color: #000000;">System.Diagnostics.</span><span style="background: #ffffff; color: #2b91af;">Debug</span><span style="background: #ffffff; color: #000000;">.WriteLine(</span><span style="background: #ffffff; color: #a31515;">&quot;retryCounter = {0}&quot;</span><span style="background: #ffffff; color: #000000;">, retryCounter);</span><br /> <br /> <span style="background: #ffffff; color: #000000;">System.Diagnostics.</span><span style="background: #ffffff; color: #2b91af;">Debug</span><span style="background: #ffffff; color: #000000;">.WriteLine(</span><span style="background: #ffffff; color: #a31515;">&quot;Got Thumbnail&quot;</span><span style="background: #ffffff; color: #000000;">);</span></div>
</div>
<p>There is another way which seems even more reliable since it does not require accessing the <strong>Thumbnail</strong> multiple times. It&#39;s used in <a href="http://adndevblog.typepad.com/manufacturing/2012/07/get-thumbnail-image-by-metafile.html">this blog post</a> and inside my app it could be used like this:</p>
<div style="line-height: 120%; color: #000; font-family: &#39;Courier New&#39;, Courier, Monospace; font-size: 10pt;">
<div style="background-color: #ffffff; overflow: auto; padding: 2px 5px; white-space: nowrap;"><span style="background: #ffffff; color: #000000;">stdole.</span><span style="background: #ffffff; color: #2b91af;">IPictureDisp</span><span style="background: #ffffff; color: #000000;"> pic = doc.Thumbnail;</span><br /> <span style="background: #ffffff; color: #2b91af;">Metafile</span><span style="background: #ffffff; color: #000000;"> mf = </span><span style="background: #ffffff; color: #0000ff;">new</span> <span style="background: #ffffff; color: #2b91af;">Metafile</span><span style="background: #ffffff; color: #000000;">(</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">new</span> <span style="background: #ffffff; color: #2b91af;">IntPtr</span><span style="background: #ffffff; color: #000000;">(pic.Handle),</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">new</span> <span style="background: #ffffff; color: #2b91af;">WmfPlaceableFileHeader</span><span style="background: #ffffff; color: #000000;">());</span><br /> <br /> <span style="background: #ffffff; color: #2b91af;">Image</span><span style="background: #ffffff; color: #000000;">.</span><span style="background: #ffffff; color: #2b91af;">GetThumbnailImageAbort</span><span style="background: #ffffff; color: #000000;"> callback =</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">new</span> <span style="background: #ffffff; color: #2b91af;">Image</span><span style="background: #ffffff; color: #000000;">.</span><span style="background: #ffffff; color: #2b91af;">GetThumbnailImageAbort</span><span style="background: #ffffff; color: #000000;">(</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;&#0160;&#0160;</span><span style="background: #ffffff; color: #0000ff;">delegate</span><span style="background: #ffffff; color: #000000;"> (){ </span><span style="background: #ffffff; color: #0000ff;">return</span> <span style="background: #ffffff; color: #0000ff;">false</span><span style="background: #ffffff; color: #000000;">; });</span><br /> <br /> <span style="background: #ffffff; color: #2b91af;">Image</span><span style="background: #ffffff; color: #000000;"> img = mf.GetThumbnailImage(</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;form1.pictureBox.Width,</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;form1.pictureBox.Height,</span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;callback, </span><br /> <span style="background: #ffffff; color: #000000;">&#0160;&#0160;</span><span style="background: #ffffff; color: #2b91af;">IntPtr</span><span style="background: #ffffff; color: #000000;">.Zero);</span></div>
</div>
