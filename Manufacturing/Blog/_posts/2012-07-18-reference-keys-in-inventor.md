---
layout: "post"
title: "Reference Keys in Inventor"
date: "2012-07-18 06:37:08"
author: "Vladimir Ananyev"
categories:
  - "Inventor"
  - "Vladimir Ananyev"
original_url: "https://adndevblog.typepad.com/manufacturing/2012/07/reference-keys-in-inventor.html "
typepad_basename: "reference-keys-in-inventor"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/manufacturing/vladimir-ananyev.html" target="_self">Vladimir Ananyev</a></p>  <p><b>Issue</b></p>  <p>How to get the reference key from an occurrence in an assembly and later get back the occurrence from the reference key?</p>  <p><a name="section2"></a><b>Solution</b></p>  <p>Each object e.g. face, edge, surface body etc., has unique persistent id (just like handles in AutoCAD) and is referred to as 'Reference Key'. Reference keys can be obtained using the 'GetReferenceKey' method and you can also trace back to the object with just the reference key using 'BindKeyToObject'.</p>  <p>The sample VBA macro shown below creates a reference key from an occurrence in an assembly, print its name and again from the reference key get back the occurrence and print its name. You will observe that both point to the same occurrence.</p>  <p>&#160;</p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">Sub testRefKeys()</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160; </font></span><font style="font-size: 8pt">Dim oDoc As Document</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160; </font></span><font style="font-size: 8pt">Set oDoc = ThisApplication.ActiveDocument</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160; </font></span><font style="font-size: 8pt">Dim nKeyCont As Long</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160; </font></span><font style="font-size: 8pt">If oDoc.DocumentType = kAssemblyDocumentObject Then</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Dim oAssDoc As AssemblyDocument</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Set oAssDoc = oDoc</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Dim oCompDef As AssemblyComponentDefinition</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Set oCompDef = oAssDoc.ComponentDefinition</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">' Get the key context</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">' Calling this method is a must</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">nKeyCont = oAssDoc.ReferenceKeyManager.CreateKeyContext</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Dim oOcc As ComponentOccurrence</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Set oOcc = oCompDef.Occurrences.Item(1)</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">'Display the occurrence display name</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Debug.Print oOcc.Name</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">'Get the reference Key from occurrence</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Dim oOccRef() As Byte</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Call oOcc.GetReferenceKey(oOccRef, nKeyCont)</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">'Now get the occurrence from Reference Key</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Dim oOccnew As ComponentOccurrence</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Set oOccnew = oAssDoc.ReferenceKeyManager.BindKeyToObject(oOccRef, nKeyCont)</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160;&#160;&#160; </font></span><font style="font-size: 8pt">Debug.Print oOccnew.Name</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font color="#000000"><span style="mso-spacerun: yes"><font style="font-size: 8pt">&#160; </font></span><font style="font-size: 8pt">End If</font></font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><span style="mso-spacerun: yes"><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160; </font></font></span></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">End Sub</font></font></span><span style="font-family: "></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><font face="Calibri"><font style="font-size: 11pt" color="#000000">&#160;</font></font></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><font face="Calibri"><font style="font-size: 11pt" color="#000000">&#160;</font></font></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">void _Run()          <br />{</font></font>       <br style="mso-special-character: line-break" />      <br style="mso-special-character: line-break" /></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">HRESULT Result=NOERROR;          <br />CLSID AppClsid;           <br />CComPtr&lt;IUnknown&gt; pAppUnk;           <br />CComPtr&lt;Application&gt; App;           <br />&#160; <br />&#160; <br />Result = ::CLSIDFromProgID (L&quot;Inventor.Application&quot;, &amp;AppClsid);           <br />&#160; <br />// Latch on to the currently active Inventor session.           <br />Result = ::GetActiveObject (AppClsid, NULL, &amp;pAppUnk);           <br />if (FAILED (Result)){           <br />&#160; printf (&quot;*** Could not get hold of an active Inventor application ***\n&quot;);           <br />&#160; return ;           <br />}           <br />&#160; <br />Result = pAppUnk-&gt;QueryInterface (DIID_Application, (void **) &amp;App);           <br />if (FAILED (Result)) return ;           <br />&#160; <br />//open a document           <br />CComBSTR fname = (&quot;C:\\Temp\\MyAssembly.iam&quot;);</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">CComPtr&lt;Documents&gt; pDocs;          <br />Result = App-&gt;get_Documents(&amp;pDocs);           <br />&#160; <br />CComPtr&lt;Document&gt; pDoc;           <br />Result = pDocs-&gt;Open(fname, VARIANT_TRUE, &amp;pDoc);           <br />&#160; <br />CComQIPtr&lt;AssemblyDocument&gt; pAssemDoc(pDoc);           <br />CComPtr&lt;AssemblyComponentDefinition&gt; pAssemCompDef;           <br />Result = pAssemDoc-&gt;get_ComponentDefinition(&amp;pAssemCompDef);           <br />&#160; <br />CComPtr&lt;ReferenceKeyManager&gt; pDispRefMgr;           <br />Result = pAssemDoc-&gt;get_ReferenceKeyManager(&amp;pDispRefMgr);           <br />&#160; <br />long m_dwKeyContext;           <br />Result = pDispRefMgr-&gt;CreateKeyContext(&amp;m_dwKeyContext);           <br />&#160; <br />CComPtr&lt;ComponentOccurrences&gt; pCompOccs;           <br />Result = pAssemCompDef-&gt;get_Occurrences(&amp;pCompOccs);           <br />&#160; <br />CComPtr&lt;ComponentOccurrence&gt; pCompOcc;           <br />Result = pCompOccs-&gt;get_Item(1, &amp;pCompOcc);</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">SAFEARRAY *pRefKey =NULL ;          <br />Result = pCompOcc-&gt;GetReferenceKey(&amp;pRefKey,m_dwKeyContext);           <br />&#160; <br />CComBSTR name;           <br />Result = pCompOcc-&gt;get_Name(&amp;name);           <br />MessageBox(NULL, name, L&quot;Before binding&quot;, 0);</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">CComVariant mtype;          <br />CComPtr&lt;IDispatch&gt; pDispatch;           <br />Result = pDispRefMgr-&gt;BindKeyToObject(&amp;pRefKey, m_dwKeyContext, &amp;mtype, &amp;pDispatch); </font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">CComQIPtr&lt;ComponentOccurrence&gt; pCompOcc1(pDispatch);          <br />Result = pCompOcc1-&gt;get_Name(&amp;name);           <br />MessageBox(NULL, name, L&quot;After binding&quot;, 0);           <br />&#160; <br />}</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal"><span style="font-family: "><font face="Lucida Console"><font style="font-size: 8pt" color="#000000">int main(int argc, char* argv[])          <br />{           <br />CoInitialize(NULL);           <br />&#160; <br />_Run();           <br />&#160; <br />CoUninitialize();           <br />return 0;           <br />}</font></font></span></p>
