---
layout: "post"
title: "GDI Exception converting IPictureDisp to System.Drawing.Image &amp; Image stretched"
date: "2014-11-12 14:10:14"
author: "Wayne Brill"
categories:
  - "Inventor"
  - "Wayne Brill"
original_url: "https://adndevblog.typepad.com/manufacturing/2014/11/gdi-exception-converting-ipicturedisp-to-systemdrawingimage-image-stretched.html "
typepad_basename: "gdi-exception-converting-ipicturedisp-to-systemdrawingimage-image-stretched"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/manufacturing/wayne-brill.html" target="_self">Wayne Brill</a></p>  <p>You can get the thumbnail of a document using the ThumbNail property of a Document. This property returns an IPictureDisp. To show the Thumbnail you may need to convert it to a System.Drawing.Image. When using GetPictureFromIPicture to do this you may get GDI Exceptions. This issue is discussed on this post: </p>  <p><a href="https://connect.microsoft.com/VisualStudio/feedback/details/451051/axhost-getpicturefromipicture-does-not-work-correctly-on-x64-systems" target="_blank">AxHost.GetPictureFromIPicture does not work correctly on x64 systems</a></p>  <p>Here is the workaround from that page. (Resolved the error in my tests)</p>  <p><strong>&gt;&gt; &gt;&gt;&gt;</strong></p>  <p><em>Posted by Stefan Cuypers on 5/15/2009 at 4:34 AM</em></p>  <p><em>Here's code that does work correctly all the time (you'll need to set a reference to stdole): </em></p>  <div style="font-size: 10pt; font-family: consolas; background: #eeeeee; color: black">   <p style="margin: 0px"><span style="color: blue">using</span> System.Drawing.Imaging;</p> </div>  <p>... </p>  <div style="font-size: 10pt; font-family: consolas; background: #eeeeee; color: black">   <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: #2b91af">Image</span> GetPictureFromIPicture</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (stdole.<span style="color: #2b91af">IPictureDisp</span> picture)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (picture == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #2b91af">IntPtr</span> hpal = <span style="color: #2b91af">IntPtr</span>.Zero;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (picture.Type == 1) <span style="color: green">// bitmap</span></p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">try</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; hpal = <span style="color: blue">new</span> <span style="color: #2b91af">IntPtr</span>(picture.hPal);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">catch</span> (<span style="color: #2b91af">COMException</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #2b91af">Image</span> retval = GetPictureFromParams</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span style="color: blue">new</span> <span style="color: #2b91af">IntPtr</span>(picture.Handle), picture.Type, </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; hpal, picture.Width, picture.Height);</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: #2b91af">GC</span>.KeepAlive(picture); <span style="color: green">// Be sure we keep this&#160;&#160; picture alive </span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160; <span style="color: green">// until we copied it safely into our image.</span></p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">return</span> retval;</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: #2b91af">Image</span> GetPictureFromParams</p>    <p style="margin: 0px">&#160;&#160;&#160; (<span style="color: #2b91af">IntPtr</span> handle, <span style="color: blue">int</span> type, <span style="color: #2b91af">IntPtr</span> paletteHandle,</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">int</span> width, <span style="color: blue">int</span> height)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">switch</span> (type)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> -1:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> 0:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">null</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> 1:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: #2b91af">Image</span>.FromHbitmap(handle, </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; paletteHandle);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> 2:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">WmfPlaceableFileHeader</span> wmfHeader = </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">WmfPlaceableFileHeader</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; wmfHeader.BboxRight = (<span style="color: blue">short</span>)width;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; wmfHeader.BboxBottom = (<span style="color: blue">short</span>)height;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> (<span style="color: #2b91af">Image</span>)<span style="color: blue">new</span> <span style="color: #2b91af">Metafile</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (handle, wmfHeader, <span style="color: blue">false</span>).Clone();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> 3:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> (<span style="color: #2b91af">Image</span>)<span style="color: #2b91af">Icon</span>.FromHandle(handle).Clone();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> 4:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> (<span style="color: #2b91af">Image</span>)<span style="color: blue">new</span> <span style="color: #2b91af">Metafile</span>(handle, <span style="color: blue">false</span>).Clone();</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentException</span>(<span style="color: #a31515">&quot;AXUnknownImage&quot;</span>, <span style="color: #a31515">&quot;type&quot;</span>);</p>    <p style="margin: 0px">}</p> </div>  <p><strong></strong></p>  <p><strong>&lt;&lt; &lt;&lt;&lt;</strong></p>  <p><strong></strong></p>  <p><strong></strong></p>  <p><strong>PictureBox â€“ Thumbnail stretched</strong>     <br />When using the Thumbnail of a drawing converted from iPictureDisp to Drawing.System.Image in a PictureBox, it may look stretched. A solution is to set the SizeMode property to StretchImage. This forces the image to be the size of the picture box. The picture box should be square and then the image will look correct.</p>
