---
layout: "post"
title: "iLogic: ActiveDocument.ComponentDefinition throws exception for specific document"
date: "2016-11-17 18:17:10"
author: "Xiaodong Liang"
categories:
  - "iLogic"
  - "Inventor"
  - "Xiaodong Liang"
original_url: "https://adndevblog.typepad.com/manufacturing/2016/11/ilogic-activedocumentcomponentdefinition-throws-exception-for-specific-document.html "
typepad_basename: "ilogic-activedocumentcomponentdefinition-throws-exception-for-specific-document"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/manufacturing/xiaodong-liang.html" target="_self">Xiaodong Liang</a></p>  <p>Recently, we got a strange issue. With a specific dataset, we opened all files in cascade views, then activated each document and ran an external rule. The rule is quite simple. It just gets the document ComponentDefinition and access parameters. </p>  <p><font face="Courier New"><b><span style="font-family: " lang="EN-US"><font color="#ff0000"><font style="font-size: 10pt">Dim</font></font></span></b><font style="font-size: 10pt"><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">compDef</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> <b>=</b> </font></span><b><span style="font-family: " lang="EN-US"><font color="#800080">ThisApplication</font></span></b><span style="font-family: " lang="EN-US"><font color="#000000">.</font></span><span style="font-family: " lang="EN-US"><font color="#800000">ActiveDocument</font></span><span style="font-family: " lang="EN-US"><font color="#000000">.</font></span></font><span style="font-family: " lang="EN-US"><font style="font-size: 10pt" color="#800000">ComponentDefinition</font></span></font><span style="font-family: " lang="EN-US"></span></p>  <p>For most documents, it works well. but for specific assembly document, it throws an exception that says: Member not found.</p>  <p>We doubted ComponentDefinition / Parameters have been broken when activating the document at his side, so we tested with a VBA code. But the code tells the ComponentDefinition / Parameters are always valid. While the issue seems not always reproducible. </p>  <p>Finally, our expert of iLogic Mike Deck shared the insights:</p>  <p>It is caused by internal .NET behavior to do with COM interop. Here’s a simplified rule that will reproduce it: </p>  <p>- Create a new part</p>  <p>- Run the rule in the part</p>  <p>- Create a new assembly</p>  <p>- Run the rule in the assembly</p>  <p>The order matters: it won’t break if you run it in the assembly first.</p>  <p>Here’s what’s happening: ActiveDocument returns a Document object. There is no ComponentDefinition property on the Document object. So VB.NET tries to do late binding. When you run the rule on a Document that is also a PartDocument, it will find a ComponentDefinition property with a DispId on that object. Then later you run the rule on a Document that is also an AssemblyDocument. It also has a ComponentDefinition property, but with another DispId.</p>  <p>For some reason, VB.NET will fail to find that property. it might probably cache the first DispId (from PartDocument), and associates it with the Document interface. Then it thinks that it can always use that DispId to access ComponentDefinition on a Document. But that DispId will fail if the object is an AssemblyDocument.</p>  <p>It seems like an issue of Microsoft .NET. So in such case, there is a workaround. In VB.NET code, never try to access the ComponentDefinition on a Document object. Instead, always cast it to a PartDocument or AssemblyDocument first. Here’s sample code to get the UserParameters:</p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><b><span style="font-family: " lang="EN-US"><font color="#ff0000"><font style="font-size: 10pt">Dim</font></font></span></b><font style="font-size: 10pt"><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">doc</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> <b>=</b> </font></span><b><span style="font-family: " lang="EN-US"><font color="#800080">ThisApplication</font></span></b><span style="font-family: " lang="EN-US"><font color="#000000">.</font></span></font><span style="font-family: " lang="EN-US"><font style="font-size: 10pt" color="#800000">ActiveDocument</font></span></font><span style="font-family: " lang="EN-US"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><b><span style="font-family: " lang="EN-US"><font color="#ff0000"><font style="font-size: 10pt">Dim</font></font></span></b><font style="font-size: 10pt"><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">params</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><b><span style="font-family: " lang="EN-US"><font color="#ff0000">As</font></span></b><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">Parameters</font></span></font><span style="font-family: " lang="EN-US"><font style="font-size: 10pt" color="#000000"> <b>=</b> Nothing</font></span></font></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#ff0000"><font style="font-size: 10pt">If</font></font></span></b><font style="font-size: 10pt"><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> </font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">doc</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000">.</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">DocumentType</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> <b>=</b> </font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">DocumentTypeEnum</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000">.</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">kAssemblyDocumentObject</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> </font></span></font><b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font style="font-size: 10pt" color="#ff0000">Then</font></span></b></font><span style="font-family: ; mso-ansi-language: fr" lang="FR"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font></span><font style="font-size: 10pt"><b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#ff0000">Dim</font></span></b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> </font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">assemDoc</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> </font></span><b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#ff0000">As</font></span></b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> </font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">AssemblyDocument</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> <b>=</b> </font></span></font><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font style="font-size: 10pt" color="#800000">doc</font></span></font><span style="font-family: ; mso-ansi-language: fr" lang="FR"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font></span><font style="font-size: 10pt"><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">params</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> <b>=</b> </font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">assemDoc</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000">.</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">ComponentDefinition</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000">.</font></span></font><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font style="font-size: 10pt" color="#800000">Parameters</font></span></font><span style="font-family: ; mso-ansi-language: fr" lang="FR"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#ff0000"><font style="font-size: 10pt">ElseIf</font></font></span></b><font style="font-size: 10pt"><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> </font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">doc</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000">.</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">DocumentType</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> <b>=</b> </font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">DocumentTypeEnum</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000">.</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#800000">kPartDocumentObject</font></span><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"> </font></span></font><b><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font style="font-size: 10pt" color="#ff0000">Then</font></span></b></font><span style="font-family: ; mso-ansi-language: fr" lang="FR"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><span style="font-family: ; mso-ansi-language: fr" lang="FR"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font></span><font style="font-size: 10pt"><b><span style="font-family: " lang="EN-US"><font color="#ff0000">Dim</font></span></b><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">partDoc</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><b><span style="font-family: " lang="EN-US"><font color="#ff0000">As</font></span></b><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">PartDocument</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> <b>=</b> </font></span></font><span style="font-family: " lang="EN-US"><font style="font-size: 10pt" color="#800000">doc</font></span></font><span style="font-family: " lang="EN-US"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><span style="font-family: " lang="EN-US"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font></span><font style="font-size: 10pt"><span style="font-family: " lang="EN-US"><font color="#800000">params</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> <b>=</b> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">partDoc</font></span><span style="font-family: " lang="EN-US"><font color="#000000">.</font></span><span style="font-family: " lang="EN-US"><font color="#800000">ComponentDefinition</font></span><span style="font-family: " lang="EN-US"><font color="#000000">.</font></span></font><span style="font-family: " lang="EN-US"><font style="font-size: 10pt" color="#800000">Parameters</font></span></font><span style="font-family: " lang="EN-US"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><b><span style="font-family: " lang="EN-US"><font color="#ff0000"><font style="font-size: 10pt">End</font></font></span></b><font style="font-size: 10pt"><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span></font><b><span style="font-family: " lang="EN-US"><font style="font-size: 10pt" color="#ff0000">If</font></span></b></font><span style="font-family: " lang="EN-US"></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><span style="font-family: " lang="EN-US"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;</font></font></span></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font face="Courier New"><b><span style="font-family: " lang="EN-US"><font color="#ff0000"><font style="font-size: 10pt">Dim</font></font></span></b><font style="font-size: 10pt"><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">userparams</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><b><span style="font-family: " lang="EN-US"><font color="#ff0000">As</font></span></b><span style="font-family: " lang="EN-US"><font color="#000000"> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">UserParameters</font></span><span style="font-family: " lang="EN-US"><font color="#000000"> <b>=</b> </font></span><span style="font-family: " lang="EN-US"><font color="#800000">params</font></span><span style="font-family: " lang="EN-US"><font color="#000000">.</font></span></font><span style="font-family: " lang="EN-US"><font style="font-size: 10pt" color="#800000">UserParameters</font></span></font></p>  <p style="line-height: normal; margin: 0cm 0cm 0pt" class="MsoNormal" align="left"><font color="#800000" face="Courier New"><span style="font-family: " lang="EN-US"></span></font></p>  <p>It requires a lot more than a single line of code, but it avoids the problem.</p>
