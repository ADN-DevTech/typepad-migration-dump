---
layout: "post"
title: "Visual Studio Node.js プロジェクトでの Forge SDK の利用 "
date: "2019-06-05 00:04:08"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2019/06/use-of-forge-sdk-to-nodejs-project-on-visual-studio.html "
typepad_basename: "use-of-forge-sdk-to-nodejs-project-on-visual-studio"
typepad_status: "Publish"
---

<p><strong><a href="https://adndevblog.typepad.com/technology_perspective/2019/05/deploy-web-app-from-visual-studio.html" rel="noopener" target="_blank">Visual Studio からの Web アプリのデプロイ</a></strong> では Visual Studio で作成したスケルトン プロジェクトを使って、「<strong>空の Azure Node.js Web アプリケーション</strong>」テンプレートが生成した簡単な Web アプリを Azure にデプロイする手順をご案内しました。</p>
<p>今回は、同じ手順で作成したプロジェクトに、<strong><a href="https://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part1.html" rel="noopener" target="_blank">Forge Node.js クイックスタート ～ その1</a></strong> や&#0160; <strong><a href="https://adndevblog.typepad.com/technology_perspective/2017/08/getting-3-legged-oauth-access-token-using-forge-sdk.html" rel="noopener" target="_blank">Forge SDK を使用した 3-legged OAuth Access Token 取得</a></strong> で使った&#0160; <strong><a href="https://github.com/Autodesk-Forge/forge-api-nodejs-client#readme" rel="noopener" target="_blank">Forge Node.js SDK</a></strong> を組み込み、<strong><a href="https://forge.autodesk.com/en/docs/viewer/v6/tutorials/basic-application/" rel="noopener" target="_blank">Basic Application</a></strong> &#0160;相当のコードを Web アプリに実装してデプロイします。なお、表示する 3D モデルは、あらかじめ変換済の URN があることを前提とします。</p>
<hr />
<ol>
<li><strong><a href="https://adndevblog.typepad.com/technology_perspective/2019/05/deploy-web-app-from-visual-studio.html" rel="noopener" target="_blank">Visual Studio からの Web アプリのデプロイ</a></strong> でご案内した手順で「<strong>空の Azure Node.js Web アプリケーション</strong>」テンプレートを使ったスケルトン プロジェクトを作成します。ここでは、プロジェクト名を <strong>NodejsWebApp3</strong> とします。</li>
<li>スケルトン プロジェクトに Forge Node.js SDK パッケージを追加します。[ソリューション エクスプローラ] 上の <strong>npm</strong> を見つけてマウスの右ボタンでクリックしたら、[<strong>新しい npm パッケージをインストールする(N)...</strong>] を選択してください。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a4586401200c-pi" style="display: inline;"><img alt="Install_new_nodejs_package" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a4586401200c image-full img-responsive" src="/assets/image_468204.jpg" title="Install_new_nodejs_package" /></a></li>
<li>[新しい npm パッケージのインストール] ダイアログが表示されたら、左上の検索ボックスに <em><strong>Autodesk Forge</strong></em> を入力して（①）、リストアップされてくる中から「<strong>forge-apis</strong> x.x.x <span style="color: #bc6f95;">Autodesk Inc.<span style="color: #111111;">」</span></span> を見つけて選択し（②）、 [パッケージのインストール(I)] ボタンをクリックします（③）。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a4a64047200b-pi" style="display: inline;"><img alt="Install_new_nodejs_package2" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a4a64047200b image-full img-responsive" src="/assets/image_600483.jpg" title="Install_new_nodejs_package2" /></a></li>
<li>[ソリューション エクスプローラ] 上の <strong>npm</strong> 下に「<strong>forge-apis@x.x.x</strong>」が追加されたのを確認したら、[新しい npm パッケージのインストール] ダイアログを閉じてください。<strong><br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a481987c200d-pi" style="display: inline;"><img alt="Installed_forge_nodejs_package" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a481987c200d image-full img-responsive" src="/assets/image_476282.jpg" title="Installed_forge_nodejs_package" /></a><br /></strong></li>
<li>続いて、生成されたスケルトン プロジェクトで、Node.js の組み込み済パッケージ（別名 ミドルウェア、モジュール）である http パッケージの <strong><a href="https://www.w3schools.com/nodejs/met_http_createserver.asp" rel="noopener" target="_blank">createServer メソッド</a></strong>を流用して、クライアントからの要求で Viewer を表示する HTML ページに変更します。server,js を開いて、内容を次のようになるようにすべて書き換えてください。<strong><span style="color: #0000ff;"><span style="color: #111111;">&#39;</span>&lt;YOU CLIENT ID&gt;</span><span style="color: #111111; background-color: #ffffff;">&#39;</span></strong><span style="color: #111111; background-color: #ffffff;">、</span><strong><span style="color: #111111; background-color: #ffffff;">&#39;</span></strong>&lt;YOUR CLIENT SECRET&gt;<strong>&#39;</strong> には、Forge ポータル取得しのた Client ID と Client Secret を、<strong>&#39;<span style="color: #0000ff;">&lt;YOUR BASE64 ENCODED URN&gt;</span>&#39;</strong> には、Model Derivative API で変換した 3D モデルの URN（Base64 エンコードされたドキュメントの ID）を、それぞれ入力してください。<br />
<pre>&#39;use strict&#39;;<br />var http = require(&#39;http&#39;);<br />var ForgeSDK = require(&#39;forge-apis&#39;);<br />var port = process.env.PORT || 1337;<br />var CLIENT_ID = &#39;<span style="color: #0000ff;"><strong>&lt;YOUR CLIENT ID&gt;</strong></span>&#39;,<br />    CLIENT_SECRET = &#39;<span style="color: #0000ff;"><strong>&lt;YOUR CLIENT SECRET&gt;</strong></span>&#39;,<br />    ENCODED_URN = &#39;<span style="color: #0000ff;"><strong>&lt;YOUR BASE64 ENCODED URN&gt;</strong></span>&#39;;<br /><br />http.createServer(function (req, res) {<br />    var oAuth2TwoLegged = new ForgeSDK.AuthClientTwoLegged(CLIENT_ID, CLIENT_SECRET, [&#39;viewables:read&#39;], true);<br />    oAuth2TwoLegged.authenticate().then(function (credentials) {<br />        console.log(&quot;**** Got Credentials&quot;, credentials);<br /><br />        var token = credentials[&quot;access_token&quot;];<br />        var data = [<br />          &#39;&lt;head&gt;&#39;,<br />          &#39;  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no&quot; /&gt;&#39;,<br />          &#39;  &lt;meta charset=&quot;utf-8&quot;&gt;&#39;,<br />          &#39;&#39;,<br />          &#39;  &lt;!-- The Viewer CSS --&gt;&#39;,<br />          &#39;  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://developer.api.autodesk.com/modelderivative/v2/viewers/6.*/style.min.css&quot; type=&quot;text/css&quot;&gt;&#39;,<br />          &#39;&#39;,<br />          &#39;  &lt;!-- Developer CSS --&gt;&#39;,<br />          &#39;  &lt;style&gt;&#39;,<br />          &#39;    body {&#39;,<br />          &#39;      margin: 0;&#39;,<br />          &#39;    }&#39;,<br />          &#39;    #MyViewerDiv {&#39;,<br />          &#39;      width: 100%;&#39;,<br />          &#39;      height: 100%;&#39;,<br />          &#39;      margin: 0;&#39;,<br />          &#39;      background-color: #F0F8FF;&#39;,<br />          &#39;    }&#39;,<br />          &#39;   &lt;/style&gt;&#39;,<br />          &#39;&lt;/head&gt;&#39;,<br />          &#39;&lt;body&gt;&#39;,<br />          &#39;&#39;,<br />          &#39;  &lt;!-- The Viewer will be instantiated here --&gt;&#39;,<br />          &#39;  &lt;div id=&quot;MyViewerDiv&quot;&gt;&lt;/div&gt;&#39;,<br />          &#39;&#39;,<br />          &#39;  &lt;!-- The Viewer JS --&gt;&#39;,<br />          &#39;  &lt;script src=&quot;https://developer.api.autodesk.com/modelderivative/v2/viewers/6.*/viewer3D.min.js&quot;&gt;&lt;/script&gt;&#39;,<br />          &#39;&#39;,<br />          &#39;  &lt;!-- Developer JS --&gt;&#39;,<br />          &#39;  &lt;script&gt;&#39;,<br />          &quot;    var token = &#39;&quot; + token + &quot;&#39;;&quot;,<br />          &quot;    var urn = &#39;&quot; + ENCODED_URN + &quot;&#39;;&quot;,<br />          &#39;&#39;,<br />          &#39;    var viewerApp;&#39;,<br />          &#39;    var options = {&#39;,<br />          &quot;      env: &#39;AutodeskProduction&#39;,&quot;,<br />          &#39;      getAccessToken: function(onGetAccessToken) {&#39;,<br />          &#39;        //&#39;,<br />          &#39;        // TODO: Replace static access token string below with call to fetch new token from your backend&#39;,<br />          &quot;        // Both values are provided by Forge&#39;s Authentication (OAuth) API.&quot;,<br />          &#39;        //&#39;,<br />          &quot;        // Example Forge&#39;s Authentication (OAuth) API return value:&quot;,<br />          &#39;        // {&#39;,<br />          &#39;        // &quot;access_token&quot;: &quot;&lt;YOUR_APPLICATION_TOKEN&gt;&quot;,&#39;,<br />          &#39;        // &quot;token_type&quot;: &quot;Bearer&quot;,&#39;,<br />          &#39;        // &quot;expires_in&quot;: 86400&#39;,<br />          &#39;        // }&#39;,<br />          &#39;        //&#39;,<br />          &#39;        var accessToken = token;&#39;,<br />          &#39;        var expireTimeSeconds = 60 * 30;&#39;,<br />          &#39;        onGetAccessToken(accessToken, expireTimeSeconds);&#39;,<br />          &#39;      }&#39;,<br />          &#39;&#39;,<br />          &#39;    };&#39;,<br />          &#39;&#39;,<br />          &quot;    var documentId = &#39;urn:&#39; + urn;&quot;,<br />          &#39;    Autodesk.Viewing.Initializer(options, function onInitialized(){&#39;,<br />          &#39;    var avp = Autodesk.Viewing.Private;&#39;,<br />          &#39;    avp.logger.setLevel( avp.LogLevels.Debug );&#39;,<br />          &#39;    var config3d = {&#39;,<br />          &quot;      extensions: [&#39;Autodesk.Viewing.Collaboration&#39;]&quot;,<br />          &#39;    };&#39;,<br />          &quot;    viewerApp = new Autodesk.Viewing.ViewingApplication(&#39;MyViewerDiv&#39;);&quot;,<br />          &#39;    viewerApp.registerViewer(viewerApp.k3D, Autodesk.Viewing.Private.GuiViewer3D, config3d);&#39;,<br />          &#39;    viewerApp.loadDocument(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);&#39;,<br />          &#39;  });&#39;,<br />          &#39;&#39;,<br />          &#39;  function onDocumentLoadSuccess(doc) {&#39;,<br />          &#39;&#39;,<br />          &#39;    // We could still make use of Document.getSubItemsWithProperties()&#39;,<br />          &#39;    // However, when using a ViewingApplication, we have access to the **bubble** attribute,&#39;,<br />          &#39;    // which references the root node of a graph that wraps each object from the Manifest JSON.&#39;,<br />          &quot;    var viewables = viewerApp.bubble.search({&#39;type&#39;:&#39;geometry&#39;});&quot;,<br />          &#39;    if (viewables.length === 0) {&#39;,<br />          &quot;      console.error(&#39;Document contains no viewables.&#39;);&quot;,<br />          &#39;      return;&#39;,<br />          &#39;    }&#39;,<br />          &#39;&#39;,<br />          &#39;    // Choose any of the avialble viewables&#39;,<br />          &#39;    viewerApp.selectItem(viewables[0].data, onItemLoadSuccess, onItemLoadFail);&#39;,<br />          &#39;  }&#39;,<br />          &#39;&#39;,<br />          &#39;  function onDocumentLoadFailure(viewerErrorCode) {&#39;,<br />          &quot;    console.error(&#39;onDocumentLoadFailure() - errorCode:&#39; + viewerErrorCode);&quot;,<br />          &#39;  }&#39;,<br />          &#39;&#39;,<br />          &#39;  function onItemLoadSuccess(viewer, item) {&#39;,<br />          &quot;    console.log(&#39;onItemLoadSuccess()!&#39;);&quot;,<br />          &#39;    console.log(viewer);&#39;,<br />          &#39;    console.log(item);&#39;,<br />          &#39;&#39;,<br />          &#39;    // Congratulations! The viewer is now ready to be used.&#39;,<br />          &quot;    console.log(&#39;Viewers are equal: &#39; + (viewer === viewerApp.getCurrentViewer()));&quot;,<br />          &#39;  }&#39;,<br />          &#39;&#39;,<br />          &#39;  function onItemLoadFail(errorCode) {&#39;,<br />          &quot;    console.error(&#39;onItemLoadFail() - errorCode:&#39; + errorCode);&quot;,<br />          &#39;  }&#39;,<br />          &#39;&#39;,<br />          &#39;  &lt;/script&gt;&#39;,<br />          &#39;&lt;/body&gt;&#39;<br />        ].join(&#39;\n&#39;);<br />        res.writeHead(200, { &#39;Content-Type&#39;: &#39;text/html&#39; });<br />        res.write(data);<br />        res.end();<br />    }, function (err) {<br />        res.writeHead(200, { &#39;Content-Type&#39;: &#39;text/html&#39; });<br />        res.write(&#39;ERROR: &#39; + err.errorCode);<br />        res.end();<br />        console.error(&#39;\x1b[31m Error:&#39;, err, &#39;\x1b[0m&#39;);<br />    });<br />}).listen(port);</pre>
</li>
<li>server.js を修正したプロジェクト（<strong>NodejsWebApp3 プロジェクト</strong>）の実行をテストしてみます。[デバッグ(D)] メニューから [▶ デバッグッグの開始(S)] を選択して、Web ブラウザが起動後に server.js で指定した URN を持つ 3D モデルが表示されることを確認してください。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a458c71f200c-pi" style="display: inline;"><img alt="Run_app_om_local" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a458c71f200c image-full img-responsive" src="/assets/image_869871.jpg" title="Run_app_om_local" /></a></li>
<li>プロジェクトのローカルでの実行が正常なら、<strong><a href="https://adndevblog.typepad.com/technology_perspective/2019/05/deploy-web-app-from-visual-studio.html" rel="noopener" target="_blank">Visual Studio からの Web アプリのデプロイ</a></strong> で の手順に沿って Azure へのデプロイをおこないます。ここでは、[App Service の作成] ダイアログで、Visual Studio が自動設定したアプリ名を書き換え、<strong>NodejsWebApp3-app</strong> に書き換えることにします。リソース グループも&#0160;<strong>NodejsWebApp3-app</strong> 名で新規作成することにします。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a4587027200c-pi" style="display: inline;"><img alt="App_service_creation_dialog" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a4587027200c image-full img-responsive" src="/assets/image_1848.jpg" title="App_service_creation_dialog" /></a></li>
<li>[発行] ダイアログでは、各項目を既定値のまま [発行(P)] ボタンをクリックします。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a481a26e200d-pi" style="display: inline;"><img alt="Publish" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a481a26e200d image-full img-responsive" src="/assets/image_712325.jpg" title="Publish" /></a></li>
<li>発行が正常に完了すると、Azure 上の URL（ここでは <strong><a href="https://nodejswebapp3-app.azurewebsites.net/" rel="noopener" target="_blank">https://nodejswebapp3-app.azurewebsites.net/</a></strong>）で指定した 3D モデルを表示されるはずです。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a458c8fb200c-pi" style="display: inline;"><img alt="Run_app_on_azure" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a458c8fb200c image-full img-responsive" src="/assets/image_662785.jpg" title="Run_app_on_azure" /></a><br />もちろん、WebGL 対応の Web ブラウザさえあれば、デプロイされた Web アプリはデバイスを問わず参照出来るはずです。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a458ca00200c-pi" style="display: inline;"><img alt="App_on_mobile" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a458ca00200c image-full img-responsive" src="/assets/image_57180.jpg" title="App_on_mobile" /></a></li>
</ol>
<hr />
<p>今回の例では、Node.js で構築した Web サーバー実装で Forge Node.js SDK を使った Authentication（Forge Web アプリ認証）を経て Access Token を取得し、クライアントからのWeb サーバー リクエスト（URL 入力）に対するレスポンスとして、Basic_Application の内容となる HTML と内包する JavaScript コードを返す（表示させる）コードを作成してみました。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a4594f3a200c-pi" style="display: inline;"><img alt="名称未設定" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a4594f3a200c image-full img-responsive" src="/assets/image_465044.jpg" title="名称未設定" /></a></p>
<p>この他にも、多様な Web サーバーを実装することが出来るはずです。</p>
<p>By Toshiaki Isezaki</p>
