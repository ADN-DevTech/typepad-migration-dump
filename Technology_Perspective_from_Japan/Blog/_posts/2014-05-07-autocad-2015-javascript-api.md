---
layout: "post"
title: "AutoCAD 2015 JavaScript API"
date: "2014-05-07 00:11:57"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "その他カスタマイズ"
  - "クラウドサービス"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2014/05/autocad-2015-javascript-api.html "
typepad_basename: "autocad-2015-javascript-api"
typepad_status: "Publish"
---

<p>プレビュー扱いだった AutoCAD 2014 の JavaScript API が、AutoCAD 2015 で JavaScript API が一新され、このバージョンから正式な API となりました。新しい API という意味では、Version 1 ですが、昨年からの通し番号を継承して、一応 Version 2 扱いとなっています。</p>
<p>今回、最も分かり易い更新点は、AutoCAD 内から HTML にホストされた（HTML ファイル内に埋め込まれた） JavaScript コードをデバッグできるようになった点です。AutoCAD はHTML ファイルをレンダリング（表示）するために&#0160;<a href="http://ja.wikipedia.org/wiki/WebKit" target="_blank"><strong>WebKit</strong></a>&#0160;を利用していますが、AutoCAD 2015 で利用できるようになったデバッグツールは、WebKit に含まれる&#0160;<a href="http://trac.webkit.org/wiki/WebInspector" target="_blank">WebInspector</a>&#0160;というツールです。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fd020452970b-pi" style="display: inline;"><img alt="WebInspector" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a3fd020452970b image-full img-responsive" src="/assets/image_790153.jpg" title="WebInspector" /></a></p>
<p>WebInspector は英語のユーザ インタフェースのみの提供ですが、AutoCAD プロセスで動作する JavaScript コードを直接デバッグできる環境を提供することで、AutoCAD 2014 よりも JavaScript プログラム作成の生産性を向上することが出来るはずです。具体的な操作方法は、この記事の後半でご紹介します。</p>
<p>ここからは、AutoCAD 2014 からの変更点を紹介していきましょう。AutoCAD の JavaScript API の概要や、AutoCAD 2014 時に紹介したサンプル コードを参照する場合には、次のブログ記事を参照してみてください。AutoCAD 2015 との違いを把握していただくためにも、簡単に目を通していただくことをお勧めします。</p>
<p style="padding-left: 30px;"><a href="http://adndevblog.typepad.com/technology_perspective/2013/05/autocad-javascript-api-part1.html" target="_blank">AutoCAD JavaScript API の使い方 ～ その 1</a><br /><a href="http://adndevblog.typepad.com/technology_perspective/2013/05/autocad-javascript-api-part2.html" target="_blank">AutoCAD JavaScript API の使い方 ～ その 2</a><br /><a href="http://adndevblog.typepad.com/technology_perspective/2013/06/autocad-javascript-api-part3.html" target="_blank">AutoCAD JavaScript API の使い方 ～ その 3</a></p>
<p><strong>ドキュメント関連</strong></p>
<p>こちらも英語版のみの提供ですが、このバージョンでは、リファレンス マニュアルに加えて、Getting Startted（はじめましょう） ドキュメントが加わりました。初めて AutoCAD の JavaScript API に挑戦する場合には、このドキュメントが参考になるはずです。</p>
<p style="padding-left: 30px;"><a href="http://app.autocad360.com/jsapi/v2/GettingStart/index.html" target="_blank">AutoCAD 2015 JavaScript API ガイド</a>（英語）</p>
<p style="padding-left: 30px;"><a href="http://app.autocad360.com/jsapi/v2/docs/index.html" target="_blank">AutoCAD 2015 JavaScript API リファレンス</a>（英語）</p>
<p><strong>ライブラリ</strong>&#0160;</p>
<p>ライブラリという表現が正しいのかわかりませんが、HTML にホスティングする場合に &lt;script&gt; タグに記述する参照は、AutoCAD 2014 時の <a href="http://www.autocadws.com/jsapi/v1/Autodesk.AutoCAD.js" target="_blank">http://www.autocadws.com/jsapi/v1/Autodesk.AutoCAD.js</a>&#0160;&#0160;から、<a href="http://app.autocad360.com/jsapi/v2/Autodesk.AutoCAD.js" target="_blank">http://app.autocad360.com/jsapi/v2/Autodesk.AutoCAD.js</a>&#0160;に変更されています。AutoCAD 2014 で作成した JavaScript API を埋め込んだ HTML は、参照先を新しいものに置き換える必要があります。</p>
<p>また、このブログでは詳細をご案内していませんでしたが、<a href="http://app.autocad360.com/jsapi/v2/XMLSchema/index.html" target="_blank">http://app.autocad360.com/jsapi/v2/XMLSchema/index.html</a> でスキーマも用意されています。</p>
<p><strong>内部動作の仕組み</strong></p>
<p>AutoCAD 2014 時には、AutoCAD プロセス内で&#0160;1 つの Web ブラウザ インスタンスを使って JavaScript コードをで実行させていました。その結果、実行中の JavaScript コードがハングしてしまうと、すべてのコードがフリーズしてしまう問題が存在していました。</p>
<p>AutoCAD 2015 では、JavaScript コードの実行に異なる&#0160;Web ブラウザ インスタンスを利用するようになったため、ロード中の JavaScript コードの干渉を低減して安定性が向上しています。この手法にために、オープン ソースの&#0160;<a href="http://en.wikipedia.org/wiki/Chromium_Embedded_Framework" target="_blank">Chromium Embedded Framework (CEF)</a> を利用しています。</p>
<p><strong>コード上の仕様変更&#0160;</strong></p>
<p>AutoCAD 2014 で作成した JavaScript コードを AutoCAD 2015 で実行させようとすると、コードが正しく動作しない問題に直面するはずです。具体的には、ユーザ入力を促す GetXXX 系の関数が返す JSON 形式の戻り値をライブラリ側で parse するようになったため、クライアント側で parse する必要がなくなりました。例えば、下記は、AutoCAD 2014 で動作していた getPoint() の <a href="http://app.autocad360.com/jsapi/v2/docs/Acad_Promise_then@success@error.html" target="_blank">Promise Pattern</a>&#0160;を利用したコード抜粋です。</p>
<p style="padding-left: 30px;"><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">function myCircle() {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; try {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; var ppo = new Acad.PromptPointOptions();</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; ppo.useBasePoint = false;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; ppo.allowNone = false;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; ppo.setMessageAndKeywords(&quot;\n中心点を入力&quot;, &quot;&quot;);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; Acad.Editor.getPoint(ppo).then(onCompleteCpt, onError);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; catch(ex) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; write(ex.message);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">}</span></p>
<p style="padding-left: 30px;"><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">function onCompleteCpt(jsonPromptResult) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; try { </span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; <span style="color: #0000ff;"><strong>var resultObj = JSON.parse(jsonPromptResult);</strong></span></span><br /><span style="font-family: arial, helvetica, sans-serif; color: #0000ff; font-size: 10pt;"><strong>&#0160; &#0160; if (resultObj &amp;&amp; resultObj.status == 5100) {</strong> </span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; try {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; m_cpt = resultObj.value;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; var pdo = new Acad.PromptDistanceOptions(&quot;\n半径を入力&quot;);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; pdo.useBasePoint = true;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; pdo.allowNone = false;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; pdo.basePoint = new Acad.Point3d(m_cpt.x, m_cpt.y, m_cpt.z);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; Acad.Editor.getDistance(pdo).then(onCompleteRad, onError);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; catch(ex) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; write(ex.message);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; catch(ex) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; write(ex.message);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">}</span></p>
<p>AutoCAD 2014 で動作するこのコードは AutoCAD 2015 では青字の部分で例外エラーが発生してしまいます。 AutoCAD 2015 で動作させるためには、次のようなコードを変更する必要があります。</p>
<p style="padding-left: 30px;"><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">function myCircle() {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; try {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; var ppo = new Acad.PromptPointOptions();</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; ppo.useBasePoint = false;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; ppo.allowNone = false;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; ppo.setMessageAndKeywords(&quot;\n中心点を入力&quot;, &quot;&quot;);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; Acad.Editor.getPoint(ppo).then(onCompleteCpt, onError);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; catch(ex) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; write(ex.message);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">}</span></p>
<p style="padding-left: 30px;"><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">function onCompleteCpt(jsonPromptResult) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; try { </span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; <span style="color: #0000ff;"><strong>var resultObj =jsonPromptResult;</strong></span></span><br /><span style="font-family: arial, helvetica, sans-serif; color: #0000ff; font-size: 10pt;"><strong>&#0160; &#0160; if (resultObj) {</strong> </span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; try {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; m_cpt = resultObj.value;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; var pdo = new Acad.PromptDistanceOptions(&quot;\n半径を入力&quot;);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; pdo.useBasePoint = true;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; pdo.allowNone = false;</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; pdo.basePoint = new Acad.Point3d(m_cpt.x, m_cpt.y, m_cpt.z);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; Acad.Editor.getDistance(pdo).then(onCompleteRad, onError);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; catch(ex) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; &#0160; write(ex.message);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; &#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; catch(ex) {</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; &#0160; write(ex.message);</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">&#0160; }</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;">}</span></p>
<p><a href="http://adndevblog.typepad.com/technology_perspective/2013/06/autocad-javascript-api-part3.html" target="_blank">AutoCAD JavaScript API の使い方 ～ その 3</a>&#0160;で紹介した円の作図コマンド MyCircle について、この仕様変更を反映した&#0160;.js ファイルを次のリンクからダウンロードで出来るようにしました。AutoCAD へ WEBLOAD コマンドでロードする方法と実行方法は、従来と変更ありません。もちろん、Web サーバーにホストした場合には、事前に TRUSTEDPATHS システム変数にドメインを<a href="http://help.autodesk.com/cloudhelp/2015/JPN/AutoCAD-Core/files/GUID-CFDF041A-ABED-47D7-AC86-50F0419E5474.htm" target="_blank">指定する必要</a>があります。</p>
<p style="padding-left: 30px;"><span class="asset  asset-generic at-xid-6a0167607c2431970b01a3fd01e57a970b img-responsive"><a href="http://adndevblog.typepad.com/files/mycircle-2015.js">Mycircle-2015.js をダウンロード</a></span></p>
<p>円の作図処理に HTML のユーザ インタフェースを実装したファイル（JavaScript を HTML に埋め込み）は、下記からダウンロードできます。</p>
<p style="padding-left: 30px;"><span class="asset  asset-generic at-xid-6a0167607c2431970b01a511b18f1d970c img-responsive"><a href="http://adndevblog.typepad.com/files/createcircle-2015.html">Createcircle-2015.html をダウンロード</a></span></p>
<p>この HTML を Web サーバー上からロードしてパレットに表示する機能を、次の Visual Studio 2012 プロジェクトで AutoCAD .NET API で実装しています。</p>
<p style="padding-left: 30px;"><span class="asset  asset-generic at-xid-6a0167607c2431970b01a3fd0310c7970b img-responsive"><a href="http://adndevblog.typepad.com/files/jspalette-2.zip">JSPalette プロジェクトをダウンロード</a></span></p>
<p style="padding-left: 30px;"><strong><span style="background-color: #ffff00;">注意：</span><br /></strong>このプロジェクトをダウンロードして、bin フォルダ直下の JSPalette.dll アセンブリを直接、NETLOAD コマンドでロードしようとすると、「<span style="color: #5b5b5b;">アセンブリをロードできません。エラーの詳細: System.IO.FileLoadException: ファイルまたはアセンブリ &#39;file:///C:\Users\isezakt\Desktop\JSPalette\JSPalette\bin\Debug\JSPalette.dll&#39;、またはその依存関係の 1 つが読み込めませんでした。操作はサポートされません。 (HRESULT からの例外: 0x80131515)</span>」エラーが発生する場合があります。この場合には、Windows エクスプローラから&#0160;JSPalette.dll アセンブリを右クリックして、[ブロックの解除(K)] ボタンをクリックしてセキュリティ ブロックを解除してください。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fd031270970b-pi" style="display: inline;"><img alt="ブロック解除" class="asset  asset-image at-xid-6a0167607c2431970b01a3fd031270970b img-responsive" src="/assets/image_367863.jpg" style="width: 350px; display: block; margin-left: auto; margin-right: auto;" title="ブロック解除" /></a></p>
<p><strong>WebInspector を使ったデバッグ</strong></p>
<p>MyCircle コマンドを実装した Mycircle-2015.js のロードと実行、また、JsPalette.dll&#0160;を NETLOAD コマンドでロードしてから、JSPALETTE コマンドを呼び出して利用する方法、さらに、Webinspector を使った簡単なデバッグ方法を、次の動画でご案内しましょう。</p>
<p style="text-align: center;"><iframe allowfullscreen="" frameborder="0" height="281" src="http://www.youtube.com/embed/xDlfikSa7GQ?feature=oembed" width="500"></iframe>&#0160;</p>
<p>WebInspector は、HTML コンテンツがアクティブなときに、[F12] キーを押すことでいつでも表示させることが出来ます。上記の例のように、HTML コンテンツをパレット インタフェース上に表示した場合だけでなく、モーダル/モードレス ダイアログボックスや、AutoCAD 2015 で登場した <a href="http://help.autodesk.com/cloudhelp/2015/JPN/AutoCAD-Core/files/GUID-53EC6386-50E6-4983-A2BE-33BFB46F495B.htm" target="_blank">[新しいタブ]</a> をアクティブにしている場合でも表示させることが出来ます。</p>
<p>JavaScript でカスタマイズした内容は、サーバー上で一括管理することで、常に最新の状態をユーザに配信することが出来ます。別の言い方をするなら、サーバーから直接最新の JavaScript コードを直接ロードすることが出来るので、カスタマイズしたファイルをクライアント コンピュータに個別にインストールするインストーラの作成も必要ありません。クラウド上に Web サーバーをホストすることも容易な時代です。そろそろ、クラウドを利用した新しいカスタマイズを試す時期なのかも知れません。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a511b1b052970c-pi" style="display: inline;"><img alt="JavaScriptの利点" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a511b1b052970c image-full img-responsive" src="/assets/image_177462.jpg" title="JavaScriptの利点" /></a></p>
<p>By Toshiaki Isezaki</p>
<p>&#0160;</p>
