---
layout: "post"
title: "PNG ファイルを使ったリソース DLL"
date: "2016-07-27 17:28:48"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2016/07/resource-only-dll-with-png-files.html "
typepad_basename: "resource-only-dll-with-png-files"
typepad_status: "Publish"
---

<p><strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/05/autocad-2017-interoperability-for-customization.html" rel="noopener" target="_blank">AutoCAD 2017 のカスタマイズ互換性</a></strong> でご案内したとおり、AutoCAD 2017 では、RGB 値 192,192,192 の色指定でボタン背景を透明にして、ユーザ インタフェースの配色パターン（ダークテーマとライトテーマ）の差を吸収する機能が削除されています。代替方法として、透明色/透過性を指定できる PNG ファイルすることが推奨されています。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb0923efbf970d-pi" style="display: inline;"><img alt="Menu" class="asset  asset-image at-xid-6a0167607c2431970b01bb0923efbf970d img-responsive" src="/assets/image_506207.jpg" style="width: 420px;" title="Menu" /></a></p>
<p>古くから AutoCAD をカスタマイズされている方の中には、カスタム ボタンで利用するビットマップ ファイルを 1 つの DLL ファイルにまとめてメニューファイル（.cuix）と一緒に使用されている方もいらっしゃると思います。ボタン イメージだけをまとめた DLL ファイルを、AutoCAD では<strong> <a href="http://help.autodesk.com/view/ACD/2017/JPN/?guid=GUID-9AA3EEC1-031C-4E88-A966-4CBC07AD112C" rel="noopener" target="_blank">リソース DLL</a></strong>&#0160;(英語名：Resource Only DLL)&#0160;と呼んでいますが、AutoCAD 2017 での仕様変更によって、リソース DLL 内のRGB 値 192,192,192 を持つ BMP イメージ ファイルを PNG ファイルに置き換えた場合、AutoCAD 2017 は透明色をカスタム ボタンに反映することが出来ません。今回は、PNG ファイルでリソース DLL を作成する際の手順と注意点について、簡単にまとめておきたいと思います。</p>
<p><strong>リソース DLL の作成手順</strong></p>
<p style="padding-left: 30px;">ここでの作成手順では Visual Studio 2015 を利用しますが、AutoCAD が参照するリソース DLL を作成することが目的なので、Visual Studio のバージョンは問いません。また、32 ビット、64 ビットのターゲット プラットフォームの差も意識する必要はありません。32 ビット版のリソース DLL 内のイメージ リソースを 64 ビット版 AutoCAD 2017 は認識します。</p>
<ol>
<li>ボタンイメージに透過性を持たせる目的に作成した&#0160;RGB 値 192,192,192 の背景色を持つ BMP ファイルを画像編集ツールで編集して透過性を持つ PNG ファイルとして保存します。大きいボタン イメージは 32 x 32 ピクセル、小さいボタン イメージは 16 x 16 ピクセルで、それぞれ、32 ビット深度でアルファ チャネルを持つ PNG 画像です。</li>
<li>Visual Studio 2015 を起動して、[ファイル] &gt;&gt; [新規作成] &gt;&gt; [プロジェクト] を選択します。</li>
<li>[新しいプロジェクト] ダイアログが表示されたら&#0160;<strong>Visual C++</strong> テンプレートを選択して、<strong>win32 プロジェクト</strong> をクリック後に &#0160;[OK] ボタンをクリックします。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d209e3aa970c-pi" style="display: inline;"><img alt="Create_project" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d209e3aa970c image-full img-responsive" src="/assets/image_78895.jpg" title="Create_project" /><br /><br /></a>なお、ここではプロジェクト名を <strong>MyMenu</strong> とすることにします。このプロジェクトで生成されるリソース DLL ファイル名は、既定では <strong>MyMenu.dll</strong> になるため、AutoCAD で MyMenu.dll を利用する際には、<strong>MyMenu.cuix</strong> の名前でメニュー定義ファイルを作成する必要があることを意味します。このルールを守れば、ファイル名は任意でかまいません。<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d209e3aa970c-pi" style="display: inline;"><br /></a></li>
<li>ウィザードが起動して [win32 アプリケーション ウィザードへようこそ] 画面に遷移します。この画面は、[次へ] ボタンでスキップします。</li>
<li>[ アプリケーション 設定] 画面が表示されたら、[アプリケーションの種類] に&#0160;<strong>DLL(D)&#0160;</strong>として、他のオプションは既定のまま、[完了] ボタンをクリックします。</li>
<li>DLL ファイルのスケルトン プロジェクトが作成されて、Visual Studio 上にスケルトン プロジェクトがロードされます。</li>
<li>[リソース ビュー] タブをアクティブにしたら、[プロジェクト] メニューの [リソースの追加] メニューを選択します。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb092388ae970d-pi" style="display: inline;"><img alt="Add_resource" class="asset  asset-image at-xid-6a0167607c2431970b01bb092388ae970d img-responsive" src="/assets/image_71527.jpg" title="Add_resource" /></a><br /><br /></li>
<li>[リソースの追加] ダイアログが表示されたら [インポート] ボタンをクリックして、1. で作成済みの PNG ファイルをインポートします。</li>
<li>[リソース ビュー] タブにインポートした PNG ファイルがリソース ID と共に PNG カテゴリ配下に表示されています。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d209e55a970c-pi" style="display: inline;"><img alt="PNG" class="asset  asset-image at-xid-6a0167607c2431970b01b8d209e55a970c img-responsive" src="/assets/image_322698.jpg" title="PNG" /></a><br /><br /></li>
<li><span style="background-color: #ffff00;">&lt;重要&gt;</span>このままでは AutoCAD からの参照が正しく出来ないため、リソースの種類を書き換えます。インポート時に表示された画像をすべて閉じてから、[ソリューション エクスプローラ] 上で」の MyMenu.rc を右クリックして [コードの表示] メニューを選択します。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d209e5bf970c-pi" style="display: inline;"><img alt="Show_resource_code" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d209e5bf970c image-full img-responsive" src="/assets/image_327994.jpg" title="Show_resource_code" /></a><br /><br /></li>
<li>MyMenu.rc がエディタ上に表示されたら、インポートされた PNG ファイルの種類を PNG から RCDATA に変更します。次のように PNG とあるコメント行下の PNG を<strong> RCDATA</strong> に書き換えて上書き保存してください（青字箇所）。<br />
<pre><code>// Microsoft Visual C++ generated resource script.<br />//<br />#include &quot;resource.h&quot;<br /><br />#define APSTUDIO_READONLY_SYMBOLS<br />/////////////////////////////////////////////////////////////////////////////<br />//<br />// Generated from the TEXTINCLUDE 2 resource.<br />//<br />#include &quot;winres.h&quot;<br /><br />/////////////////////////////////////////////////////////////////////////////<br />#undef APSTUDIO_READONLY_SYMBOLS<br /><br />/////////////////////////////////////////////////////////////////////////////<br />// 日本語 (日本) resources<br /><br />#if !defined(AFX_RESOURCE_DLL) || defined(AFX_TARG_JPN)<br />LANGUAGE LANG_JAPANESE, SUBLANG_DEFAULT<br /><br />#ifdef APSTUDIO_INVOKED<br />/////////////////////////////////////////////////////////////////////////////<br />//<br />// TEXTINCLUDE<br />//<br /><br />1 TEXTINCLUDE <br />BEGIN<br /> &quot;resource.h\0&quot;<br />END<br /><br />2 TEXTINCLUDE <br />BEGIN<br /> &quot;#include &quot;&quot;winres.h&quot;&quot;\r\n&quot;<br /> &quot;\0&quot;<br />END<br /><br />3 TEXTINCLUDE <br />BEGIN<br /> &quot;\r\n&quot;<br /> &quot;\0&quot;<br />END<br /><br />#endif // APSTUDIO_INVOKED<br /><br /><br />/////////////////////////////////////////////////////////////////////////////<br />//<br />// PNG<br />//<br /><br />IDB_PNG1   <span style="color: #0000ff;"><strong>RCDATA   </strong></span> &quot;Button_Image1.png&quot;<br />IDB_PNG2   <span style="color: #0000ff;"><strong>RCDATA</strong></span>    &quot;Button_Image2.png&quot;<br />IDB_PNG3   <span style="color: #0000ff;"><strong>RCDATA</strong></span>    &quot;Button_Image3.png&quot;<br />IDB_PNG4   <span style="color: #0000ff;"><strong>RCDATA</strong></span>    &quot;Button_Image4.png&quot;<br />IDB_PNG5   <span style="color: #0000ff;"><strong>RCDATA</strong></span>    &quot;Button_Image5.png&quot;<br />IDB_PNG6   <span style="color: #0000ff;"><strong>RCDATA</strong></span>    &quot;Button_Image6.png&quot;<br />#endif // 日本語 (日本) resources<br />/////////////////////////////////////////////////////////////////////////////<br /><br /><br /><br />#ifndef APSTUDIO_INVOKED<br />/////////////////////////////////////////////////////////////////////////////<br />//<br />// Generated from the TEXTINCLUDE 3 resource.<br />//<br /><br /><br />/////////////////////////////////////////////////////////////////////////////<br />#endif // not APSTUDIO_INVOKED<br /></code></pre>
</li>
<li>MyMenu.rc の上書き保存が完了したら、表示中の MyMenu.rc を閉じます。</li>
<li>[ソリューション エクスプローラ] &#0160;から <strong>resource.h</strong> を開いて、PNG ファイルのインポート時に自動的に振り当てられたリソース ID の記述を削除します（青字箇所）。<br />
<pre><code>//{{NO_DEPENDENCIES}}<br />// Microsoft Visual C++ で生成されたインクルード ファイル。<br />// MyMenu.rc で使用<br />//<br /><span style="text-decoration: line-through;"><span style="color: #0000ff; text-decoration: line-through;"><strong>#define IDB_PNG1 101</strong></span></span><br /><span style="text-decoration: line-through;"><span style="color: #0000ff; text-decoration: line-through;"><strong>#define IDB_PNG2 102</strong></span></span><br /><span style="text-decoration: line-through;"><span style="color: #0000ff; text-decoration: line-through;"><strong>#define IDB_PNG3 103</strong></span></span><br /><span style="text-decoration: line-through;"><span style="color: #0000ff; text-decoration: line-through;"><strong>#define IDB_PNG4 104</strong></span></span><br /><span style="text-decoration: line-through;"><span style="color: #0000ff; text-decoration: line-through;"><strong>#define IDB_PNG5 105</strong></span></span><br /><span style="text-decoration: line-through;"><span style="color: #0000ff; text-decoration: line-through;"><strong>#define IDB_PNG6 106</strong></span></span><br /><br />// Next default values for new objects<br />// <br />#ifdef APSTUDIO_INVOKED<br />#ifndef APSTUDIO_READONLY_SYMBOLS<br />#define _APS_NEXT_RESOURCE_VALUE 107<br />#define _APS_NEXT_COMMAND_VALUE 40001<br />#define _APS_NEXT_CONTROL_VALUE 1001<br />#define _APS_NEXT_SYMED_VALUE 101<br />#endif<br />#endif</code></pre>
</li>
<li><strong>resource.h</strong> を上書き保存します。</li>
<li>[リソース ビュー] に表示されるPNG 画像のリソースが、RCDATA カテゴリ配下に表示されていることを確認してください。</li>
<li>個々のリソース ID がダブルクォーテーションで囲まれていなければ、[プロパティ] 画面に表示を切り替えなからダブルクォーテーションで囲みます、例えば、IDB＿PNG1 &#0160;は ”IDB＿PNG1” となるように書き換えます。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d209e6fe970c-pi" style="display: inline;"><img alt="RCDATA" class="asset  asset-image at-xid-6a0167607c2431970b01b8d209e6fe970c img-responsive" src="/assets/image_591864.jpg" title="RCDATA" /></a></li>
<li>Visual Studio でプロジェクトをビルドして、MyMenu.dll が作成されることを確認してください。</li>
</ol>
<p><strong>&#0160;CUIx ファイル作成とボタン指定：</strong></p>
<p style="padding-left: 30px;">拡張子を除く リソース DLL のファイル名とカスタマイズ ファイル名（.cuix）は、一致させる必要があります。ここでは、MyMenu.cuix を部分メニューとして作成することとします。新規にカスタマイズ ファイルを作成する際には、<strong><a href="http://help.autodesk.com/view/ACD/2017/JPN/?guid=GUID-7F8F4B26-EFAF-4033-B7B7-CA39FC4E104A" rel="noopener" target="_blank">CUI[ユーザ インタフェースをカスタマイズ] コマンド</a></strong>で呼び出すことが出来る [ユーザ インタフェースをカスタマイズ] ダイアログの [転送] タブを利用します。</p>
<ol>
<li>&#0160;AutoCAD 2017 の<strong><a href="http://help.autodesk.com/view/ACD/2017/JPN/?guid=GUID-8EF0EF11-D9F8-45F2-8870-48F0CC82BCD7" rel="noopener" target="_blank">オンライン ヘルプ</a></strong>にある手順に沿って、リソース DLL 内の PNG イメージをボタンに参照させます。この際、<strong>小さいイメージ&#0160;</strong>と <strong>大きいイメージ</strong>&#0160;には、上記 18. にある ID をダブルクォーテーションを外して記入します。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb09238b0c970d-pi" style="display: inline;"><img alt="Cui" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb09238b0c970d image-full img-responsive" src="/assets/image_278127.jpg" title="Cui" /></a><br /><br /></li>
<li>1. で定義したカスタム コマンドをリボンやツールバーなどに割り当てます。</li>
</ol>
<p><strong>サンプル</strong></p>
<p style="padding-left: 30px;">上記でご紹介した Visual Studio 2015 プロジェクトとカスタマイズ ファイル MyMenu.cuix ファイルは、こちらからダウンローﾄﾞすることが来ます。</p>
<p style="padding-left: 30px;"><span class="asset  asset-generic at-xid-6a0167607c2431970b01bb0924ebb5970d img-responsive"><a href="http://adndevblog.typepad.com/files/mymenu.zip">MyMenuをダウンロード</a></span></p>
<p><strong>運用：</strong></p>
<ol>
<li>&#0160;他のカスタマイズ ファイルがインストールされているローミング フォルダ（C:\Users\&lt;ログイン ユーザ名&gt;\AppData\Roaming\Autodesk\AutoCAD 2017\R21.0\jpn\Support）などに、リソース DLL ファイルとメニュー定義ファイルを配置します。ここでは、MyMenu.dll と MyMenu.cuix を同じフォルダに保存しておきます。</li>
<li>[ユーザ インタフェースをカスタマイズ] ダイアログの [カスタマイズ] タブを使って、MyMenu.cuix ファイルを部分カスタマイズ ファイルをロードします。もちろん、メイン カスタマイズ ファイルとして利用することも出来ますが、AutoCAD が既定で持っている acad.cuix としては利用できませんのでご注意ください。</li>
</ol>
<p style="padding-left: 30px;">この方法で作成したカスタム ボタンは、<strong><a href="http://help.autodesk.com/view/ACD/2017/JPN/?guid=GUID-0504CE1C-7B56-4094-B90B-C8000E680EF9" rel="noopener" target="_blank">OPTIONS[オプション] コマンド</a></strong>&#0160;の [表示] タブで配色パターンを変更しても、透過性を持つ PNG ファイルの参照によって、配色パターン毎に異なる PNG ファイルを用意する必要がありません。</p>
<p style="padding-left: 30px;"><iframe allowfullscreen="" frameborder="0" height="344" src="https://www.youtube.com/embed/jMkq5OHbAi8?feature=oembed" width="459"></iframe>&#0160;</p>
<p><strong>制限事項と回避策：</strong></p>
<p style="padding-left: 30px;">カスタマイズ ファイル内のカスタム ボタンに リソース DLL &#0160;内のボタン イメージを割り当て、かつ、カスタム ボタンを<strong><a href="http://help.autodesk.com/view/ACD/2017/JPN/?guid=GUID-AC84784E-DF12-4FC9-B318-CAB2B92D8ACB" rel="noopener" target="_blank">ドロップダウン ボタン</a></strong>で使用していると 、AutoCAD 2017 がクラッシュしてしまうことがあります。この現象は、2016年3月出荷当初の AutoCAD 2017 FCS（Final Customer Shipment)バージョン、いわゆる、出荷版で発生し、2016年7月にリリースされた <strong><a href="https://knowledge.autodesk.com/ja/support/autocad/downloads/caas/downloads/downloads/JPN/content/autocad-2017-service-pack-1.html?v=2017" rel="noopener" target="_blank">AutoCAD 2017 Service Pack 1 </a></strong>で修正されていますので、リソース DLL をドロップダウン ボタンで利用している場合には、運用前に Service Pack 1 &#0160;を適用することをお勧めします。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c880973e970b-pi" style="display: inline;"><img alt="Dropdown" class="asset  asset-image at-xid-6a0167607c2431970b01b7c880973e970b img-responsive" src="/assets/image_758851.jpg" style="width: 268px;" title="Dropdown" /></a></p>
<p style="padding-left: 30px;">AutoCAD 2017 が RTM 版のものか、Service Pack 1 が適用されているかはビルド番号で確認することが出来ます。ビルド番号は、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/02/hidden-system-variable-on-autocad.html" rel="noopener" target="_blank">AutoCAD の隠しシステム変数</a></strong>&#0160;でご紹介した&#0160;<strong>_VERNUM</strong> システム変数で参照することが出来ます。AutoCAD 2017 &#0160;FCS のビルド番号は&#0160;&quot;<strong>N.52.0.0 (UNICODE)</strong>&quot;、Service Pack 1 適用後のビルド番号は &quot;<strong>N.104.0.0 (UNICODE)</strong>&quot;&#0160;となるはずです。</p>
<p style="padding-left: 30px;">なお、PNG ファイルを利用したリソース DLL は、AutoCAD 2016 以前のバージョンではサポートされません。上記ソリューションは、AutoCAD 2017 以降のバージョンでのみ利用出来ます。</p>
<p><strong>注意：</strong>&#0160;</p>
<p style="padding-left: 30px;">AutoCAD 2010 以降、イメージ ファイルは、それらが割り当てられたコマンドを含むカスタマイズ ファイル（.cuix）に読み込まれます。一度、カスタマイズ ファイル（.cuix）でカスタム コマンドにイメージを割り当てれば、外部に個別のイメージ ファイルやリソース DLL を保持する必要はありません。過去のカスタマイズ資産を移植するなどの明示的な理由がない限り、リソース DLL を利用し続ける必要はありません。</p>
<p>By Toshiaki Isezaki</p>
