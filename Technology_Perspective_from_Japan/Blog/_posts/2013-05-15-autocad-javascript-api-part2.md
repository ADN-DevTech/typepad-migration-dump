---
layout: "post"
title: "AutoCAD JavaScript API の使い方 ～ その 2"
date: "2013-05-15 00:53:59"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "その他カスタマイズ"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2013/05/autocad-javascript-api-part2.html "
typepad_basename: "autocad-javascript-api-part2"
typepad_status: "Publish"
---

<p><strong><a href="http://adndevblog.typepad.com/technology_perspective/2013/05/autocad-javascript-api-part1.html" target="_blank">前回</a></strong> の続きで AutoCAD JavaScript API をご紹介していきます。まずは、AutoCAD らしく、新しいコマンドを作成してみましょう。<strong><a href="http://www.autocadws.com/jsapi/v1/docs/index.html" target="_blank">http://www.autocadws.com/jsapi/v1/docs/index.html</a> </strong>でリファレンス マニュアル（英語）を見てみると、Acad 名前空間の Editor に <a href="http://www.autocadws.com/jsapi/v1/docs/Acad_Editor_addCommand@groupName@globalName@localName@flags@jsFunc.html" target="_blank">addCommand()</a>&#0160;という関数が用意されています。この関数は、ちょうど ObjectARX や .NET API と同じように、コマンド グループと共にグローバルコマンド名とローカルコマンド名、また、コマンドが入力された際に呼び出されて、実際のコマンドの振る舞いを実装するコールバック関数を指定するようになっています。この addCommand() を利用して、次のように HELLO コマンドを定義して MyCommand.js というファイル名で保存したとします。&#0160;HELLO コマンドを入力すると hello() 関数が呼び出されて、Alert() 関数が &quot;Hello World !&quot; の内容を持つ警告ダイアログを表示する、いった具合の実装です。</p>
<table align="left" border="0" cellpadding="0" cellspacing="0" class="auto-style3" style="margin-left: 4.85pt; margin-right: 4.85pt; width: 100%; background: #f2f2f2;">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="width: 435.1pt; padding: 0mm 5.4pt 0mm 5.4pt;" valign="top" width="580">
<p class="auto-style2" style="mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; text-align: left; mso-pagination: widow-orphan; layout-grid-mode: char; mso-element: frame; mso-element-frame-hspace: 7.1pt; mso-element-wrap: around; mso-element-anchor-horizontal: margin; mso-element-top: 26.3pt; mso-height-rule: exactly;"><span class="auto-style3" style="font-size: 10pt;">function hello() {</span><br class="auto-style3" /><span class="auto-style3" style="font-size: 10pt;"> &#0160;&#0160;&#0160; alert(&quot;Hello World !&quot;);<br />}<br /><br /> Acad.Editor.addCommand(<br />&#0160; &quot;MyGroup&quot;,<br />&#0160;&#0160;&quot;HELLO&quot;,<br />&#0160;&#0160;&quot;HELLO&quot;,<br /> &#0160; Acad.CommandFlag.MODAL,<br />&#0160; hello<br />);</span></p>
</td>
</tr>
</tbody>
</table>
<p>&#0160;</p>
<p>このコマンドを AutoCAD で実行するには、AutoCAD 2014 から登場した <a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-CFDF041A-ABED-47D7-AC86-50F0419E5474.htm" target="_blank"> WEBLOAD コマンド</a>&#0160;を利用します。ローカルに保存した MyCommand.js ファイルを指定してロードしようとすると、セキュリティ警告ダイアログが表示されます。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01901c0d322d970b-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><img alt="WEBLOAD" class="asset  asset-image at-xid-6a0167607c2431970b01901c0d322d970b" src="/assets/image_397070.jpg" style="margin-right: auto; margin-left: auto; display: block;" title="WEBLOAD" /></a></p>
<p>この警告ダイアログは、<a href="http://adndevblog.typepad.com/technology_perspective/2013/04/autocad-2014-%E3%81%AE%E6%96%B0%E6%A9%9F%E8%83%BD-%E3%81%9D%E3%81%AE-3.html" target="_blank">AutoCAD 2014 の新機能 ～ その 3</a>&#0160;で触れたセキュア ロードメカニズムによるものです。この警告ダイアログの表示を抑止するには、システム変数 <a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-BA2AE331-A1EB-4617-B321-697D77746545.htm" target="_blank">TRUSTEDDMAINS</a> にロード先のドメインを指定する必要があります。なお、この値は、OPTIONS コマンドで表示される [オプション] ダイアログの [ファイル] タブで指定可能な <a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-2FB4611D-F141-48D5-9B6E-460EB59351AF.htm" target="_blank">TRUSTEDPATHS</a> とは異なり、ユーザ インタフェースを使って指定をすることが出来ない点に注意してください。もし、TRUSTEDDOMAINS にローカル コンピュータで開発中の JavaScript コードのパスを指定する際には、&quot;C:\Users\Toshiaki Isezaki\Desktop&quot; のような形ではなく、&quot;file:///C:/Users/Toshiaki%20 <a target="_self"></a>Isezaki/Desktop&quot; のような <a href="http://ja.wikipedia.org/wiki/Uniform_Resource_Locator" target="_blank">URL</a> 形式で指定してください。</p>
<p>それでは、警告ダイアログの[ロード] ボタンでロードしてみます。この状態で、HELLO コマンドを実行することができるはずです。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01901c0d4949970b-pi" style="display: inline;"><img alt="Hello" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01901c0d4949970b" src="/assets/image_160251.jpg" title="Hello" /></a></p>
<p><a href="http://adndevblog.typepad.com/technology_perspective/2013/05/command_and_system_variable.html" target="_blank">コマンドとシステム変数</a> でもご紹介しましたが、コマンド定義時にコマンド フラグを指定すれば、アプリケーション実行コンテキストで動作するコマンドを定義することも可能です。もちろん、AutoCAD の標準コマンドを呼び出すこともできます。</p>
<p>JavaScript なのでクラスと呼ぶと語弊がありますが、リファレンス上で Editor.XXX を見てみると、ObjectARX の AcEd クラス、.NET API の Editor クラスに相当する機能を持つ関数が用意されていることがわかると思います。</p>
<p>ここで紹介した HELLO コマンドを実装した MyCommand.js をこのブログ ポストにアップロードしておきます。</p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b0191021ce207970c"><a href="http://adndevblog.typepad.com/files/mycommand.js">MyCommandをダウンロード</a></span></p>
<p>WEBLOAD コマンドで <a href="http://adndevblog.typepad.com/files/mycommand.js">http://adndevblog.typepad.com/files/mycommand.js</a>&#0160;をロードしてから、HELLO コマンドを実行してみてください。</p>
<p>次にオブジェクトを選択してズームする処理を実装を見てみましょう。AutoCAD JavaScript API でも、その他の AutoCAD API と比較して、ある程度、類推可能な名前の関数が多数用意されていることがわかります。ここでは、もちろん、オブジェクトの選択に getEntity() 関数を利用することになります。また、選択したオブジェクトの識別子となるオブジェクト ID の取得など、その後処理はコールバック関数を利用します。</p>
<p>コールバック関数の指定には、他の多くの Editor 関数と同じように <a href="http://www.autocadws.com/jsapi/v1/docs/Acad_Promise_then@success@error.html" target="_blank">Promise Pattern</a> と呼ばれる方法を使用します。具体的には、<strong>Acad.Editor.実行関数名.then(成功時のコールバック関数名, 失敗時のコールバック関数名)</strong> の形で指定します。次の例では、zoomEntity() 関数内で使われている getEntity() 関数が、Promise Pattern で 2 つのコールバック関数を関連付けていることがわかります。オブジェクトの選択が終了した場合には、OnComplete() が、失敗した場合には OnError() が呼び出されることになります。いずれの関数も、引数に JSON が渡されていて、内容を <a href="http://msdn.microsoft.com/ja-jp/library/ie/cc836466(v=vs.94).aspx" target="_blank">JSON.parse()</a> でオブジェクト化することで getEntity() の戻り値である PromptEntityResult オブジェクトを取り出しています。PromptEntityOptions や PromptEntityResult など、AutoCAD .NET API をご存じの方にはお馴染みの動作をします。</p>
<table align="left" border="0" cellpadding="0" cellspacing="0" class="auto-style3" style="margin-left: 4.85pt; margin-right: 4.85pt; width: 100%; background: #f2f2f2;">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="width: 435.1pt; padding: 0mm 5.4pt 0mm 5.4pt;" valign="top" width="580">
<p class="auto-style2" style="mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; text-align: left; mso-pagination: widow-orphan; layout-grid-mode: char; mso-element: frame; mso-element-frame-hspace: 7.1pt; mso-element-wrap: around; mso-element-anchor-horizontal: margin; mso-element-top: 26.3pt; mso-height-rule: exactly;"><span style="font-size: 10pt;">function zoomEntity() {</span><br /><span style="font-size: 10pt;">&#0160; try {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; var peo = new Acad.PromptEntityOptions();</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; peo.setMessageAndKeywords(&quot;\nSelect an entity&quot;, &quot;&quot;);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; peo.allowObjectOnLockedLayer = true;</span><br /><strong><span style="font-size: 10pt;">&#0160;&#0160;&#0160; Acad.Editor.getEntity(peo).then(onComplete, onError);</span></strong><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; catch(e) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; write(e.message);</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;">function onComplete(jsonPromptResult) {</span><br /><span style="font-size: 10pt;">&#0160; try {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; var resultObj = JSON.parse(jsonPromptResult);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; if (resultObj &amp;&amp; resultObj.status == 5100) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; var entity = new Acad.DBEntity(resultObj.objectId);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; var ext = entity.getExtents();</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; Acad.Editor.CurrentViewport.zoomExtents(</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; ext.minPoint3d, ext.maxPoint3d, true);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; catch(e) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; write(e.message);</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;">function onError(jsonPromptResult) {</span><br /><span style="font-size: 10pt;">&#0160; write(&quot;\nProblem encountered.&quot;);</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;">Acad.Editor.addCommand(</span><br /><span style="font-size: 10pt;">&#0160; &quot;MyGroup&quot;,</span><br /><span style="font-size: 10pt;">&#0160; &quot;MYZOOM&quot;,</span><br /><span style="font-size: 10pt;">&#0160; &quot;MYZOOM&quot;,</span><br /><span style="font-size: 10pt;">&#0160; Acad.CommandFlag.TRANSPARENT,</span><br /><span style="font-size: 10pt;">&#0160; zoomEntity</span><br /><span style="font-size: 10pt;">);</span></p>
</td>
</tr>
</tbody>
</table>
<p>&#0160;</p>
<p>この例は、選択したオブジェクトの境界ボックスとなる対角座標を取得して、その範囲にアニメーション付きでズームします。このプログラムを改修して選択したオブジェクトの色を変更するなど、簡単な編集を想定される方もいるでしょう。ところが、この他の関数は、まだ Acad.DBEntity には実装されていません。これが、JavaScript API&#0160;が、AutoCAD 2014 で初めて提供開始されたばかりであることの査証になっています。もちろん、今後のバージョンで他の関数を拡張していく予定です。現段階では、ObjectARX のacjsDefun() 関数や、.NET API のDefunJS メソッドで、JavaScript API&#0160;にない機能をエクスポーズすることも出来るようになっています。</p>
<p>先に紹介した MYZOOM コマンドを実装した MyZoom.js をこのブログ ポストにアップロードしておきます。</p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b01901c26ec5f970b"><a href="http://adndevblog.typepad.com/files/myzoom.js">MyZoomをダウンロード</a></span></p>
<p>WEBLOAD コマンドで <a href="http://adndevblog.typepad.com/files/myzoom.js">http://adndevblog.typepad.com/files/myzoom.js</a>&#0160;をロードしてから、MYZOOM コマンドを実行してみてください。</p>
<p>次に、ユーザ入力が連続するような処理を考えてみます。例えば、中心点と半径を入力して円を作図する MYCIRCLE コマンドを考えてみます。この場合、下記の myCircle() 関数の内容のように、実行される順番にプログラムしていくのが、いままでの AutoCAD API の一般的な考え方かと思います。</p>
<table align="left" border="0" cellpadding="0" cellspacing="0" class="auto-style3" style="margin-left: 4.85pt; margin-right: 4.85pt; width: 100%; background: #f2f2f2;">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="width: 435.1pt; padding: 0mm 5.4pt 0mm 5.4pt;" valign="top" width="580">
<p class="auto-style6" style="mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; text-align: left; mso-pagination: widow-orphan; layout-grid-mode: char; mso-element: frame; mso-element-frame-hspace: 7.1pt; mso-element-wrap: around; mso-element-anchor-horizontal: margin; mso-element-top: 26.3pt; mso-height-rule: exactly;"><span style="font-size: 10pt;"><span class="auto-style3">var m_rad = 0.0;<br />var m_cpt = new Acad.Point3d(0.0, 0.0, 0.0);<br /><br />function pointToString(pt) {<br />&#0160; var ret =<br />&#0160;&#0160;&#0160; pt.x.toString() + &quot;,&quot; +<br />&#0160;&#0160;&#0160; pt.y.toString() + &quot;,&quot; +<br />&#0160;&#0160;&#0160; pt.z.toString();<br />&#0160; return ret;<br />}<br /><br />function doubleToString(value) {<br />&#0160; return value.toString();<br />}<br /><br />function onCompleteCpt(jsonPromptResult) {<br />&#0160; try { <br />&#0160;&#0160;&#0160; var resultObj = JSON.parse(jsonPromptResult);<br />&#0160;&#0160;&#0160; if (resultObj &amp;&amp; resultObj.status == 5100) { <br />&#0160;&#0160;&#0160;&#0160;&#0160; m_cpt = resultObj.point;<br />&#0160;&#0160;&#0160; }<br />&#0160; }<br />&#0160; catch(ex) {<br />&#0160;&#0160;&#0160; write(ex.message);<br />&#0160; }<br />}<br /><br />function onCompleteRad(jsonPromptResult) {<br />&#0160; try { <br />&#0160;&#0160;&#0160; var resultObj = JSON.parse(jsonPromptResult);<br />&#0160;&#0160;&#0160;&#0160;&#0160; if (resultObj &amp;&amp; resultObj.status == 5100) {<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m_rad = resultObj.value;<br />&#0160;&#0160;&#0160;&#0160;&#0160; }<br />&#0160; }<br />&#0160; catch(ex) {<br />&#0160;&#0160;&#0160; write(ex.message);<br />&#0160; }<br />}<br /><br />function onError(jsonPromptResult) {<br />&#0160; write(&quot;\nエラーが発生&quot;);<br />}<br /><br /><strong>function myCircle() {</strong><br />&#0160; try {<br />&#0160;&#0160;&#0160; var ppo = new Acad.PromptPointOptions();<br />&#0160;&#0160;&#0160; ppo.useBasePoint = false;<br />&#0160;&#0160;&#0160; ppo.allowNone = false;<br />&#0160;&#0160;&#0160; ppo.setMessageAndKeywords(&quot;\n中心点を入力&quot;, &quot;&quot;);<br />&#0160;&#0160;&#0160; Acad.Editor.getPoint(ppo).then(onCompleteCpt, onError);<br />&#0160; }<br />&#0160; catch(ex) {<br />&#0160;&#0160;&#0160; write(ex.message);<br />&#0160; }<br /><br />&#0160; try {<br />&#0160;&#0160;&#0160; var pdo = new Acad.PromptDistanceOptions(&quot;\n半径を入力&quot;);<br />&#0160;&#0160;&#0160; pdo.useBasePoint = true;<br />&#0160;&#0160;&#0160; pdo.allowNone = false;<br />&#0160;&#0160;&#0160; pdo.basePoint = new Acad.Point3d(m_cpt.x, m_cpt.y, m_cpt.z);<br />&#0160;&#0160;&#0160; Acad.Editor.getDistance(pdo).then(onCompleteRad, onError);<br />&#0160; }<br />&#0160; catch(ex) {<br />&#0160;&#0160;&#0160; write(ex.message);<br />&#0160; }<br /><br />&#0160; Acad.Editor.executeCommand(&quot;CIRCLE&quot;,<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pointToString(m_cpt),<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; doubleToString(m_rad));<br /></span><strong>}</strong></span><br /><br /><span class="auto-style3" style="font-size: 10pt;"> Acad.Editor.addCommand(<br />&#0160; &quot;MyGroup&quot;,<br />&#0160; &quot;MYCIRCLE&quot;,<br />&#0160; &quot;MYCIRCLE&quot;,<br />&#0160; Acad.CommandFlag.TRANSPARENT,<br />&#0160; myCircle<br />);</span></p>
</td>
</tr>
</tbody>
</table>
<p>&#0160;</p>
<p>このプログラムを実行するときには、当然、getPoint() → getDistance() の順番でユーザ入力を待って値を取得し、&#0160;円が作図されることを期待します。ところが、実際には、コマンドはユーザの入力を待たずに勝手に終了してしまいます。また、日本語で記入したプロンプト メッセージが文字化けしていることもわかります。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b0191021c64ae970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><img alt="MyCircleErr" class="asset  asset-image at-xid-6a0167607c2431970b0191021c64ae970c" src="/assets/image_763408.jpg" title="MyCircleErr" /></a></p>
<p>最初に、文字化けの問題から解決していきましょう。最初にご紹介した&#0160; MYZOOM&#0160;コマンドでは、表示するメッセージをすべて英語にしていたので気が付かないのですが、JavaScript を記述した&#0160;.js ファイルは、ASCII テキスト形式ではなく、URF-8 形式で保存する必要があります。特に、日本語を表示するような場面では、必ず、UTF-8 形式で保存するようにしてください。</p>
<p>次に、ユーザ入力を待たない問題の解決です。先のご紹介した Promise Pattern は、JavaScript API で一般的な<a href="http://blogs.msdn.com/b/ie_jp/archive/2011/10/05/10220180.aspx" target="_blank">非同期プログラミングの手法</a>です。複数のWeb ブラウザで表示された異なるコンテンツに対して、インターネットを介して情報を送信した場合、必ずしも送信した順番に結果が表示されるわけではない経験をお持ちと思います。応答速度がネットワークのトラフィック量やサーバーの負荷などに左右されるのはよくある話ですし、インターネットでは一般的な問題です。このインターネットを前提とした JavaScript では、必ずしも同期的な処理が期待できませｎ。そこで、このような非同期処理に対応する必要あるため、Promise Pattern のような非同期に対応する仕組みが導入されています。いわゆる非同期プログラミングです。これが故に、MYCIRCLE コマンドユーザ入力を待たずに、勝手に終了してしまった訳です。</p>
<p>AutoCAD JavaScript API 以外の AutoCAD API のように、同期させた入力を用いて、作図をおこないたい場面は、コールバック関数内で次のアクションを記述することで、期待した振る舞いを得ることができます。</p>
<table align="left" border="0" cellpadding="0" cellspacing="0" class="auto-style3" style="margin-left: 4.85pt; margin-right: 4.85pt; width: 100%; background: #f2f2f2;">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="width: 435.1pt; padding: 0mm 5.4pt 0mm 5.4pt;" valign="top" width="580">
<p class="auto-style2" style="mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; text-align: left; mso-pagination: widow-orphan; layout-grid-mode: char; mso-element: frame; mso-element-frame-hspace: 7.1pt; mso-element-wrap: around; mso-element-anchor-horizontal: margin; mso-element-top: 26.3pt; mso-height-rule: exactly;"><span style="font-size: 10pt;">var m_rad = 0.0;</span><br /><span style="font-size: 10pt;">var m_cpt = new Acad.Point3d(0.0, 0.0, 0.0);</span><br /> <br /><span style="font-size: 10pt;">function pointToString(pt) {</span><br /><span style="font-size: 10pt;">&#0160; var ret =</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; pt.x.toString() + &quot;,&quot; +</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; pt.y.toString() + &quot;,&quot; +</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; pt.z.toString();</span><br /><span style="font-size: 10pt;">&#0160; return ret;</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;"> function doubleToString(value) {</span><br /><span style="font-size: 10pt;">&#0160; return value.toString();</span><br /><span style="font-size: 10pt;">}</span><br /> <br /><span style="font-size: 10pt;">function myCircle() {</span><br /><span style="font-size: 10pt;">&#0160; try {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; var ppo = new Acad.PromptPointOptions();</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; ppo.useBasePoint = false;</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; ppo.allowNone = false;</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; ppo.setMessageAndKeywords(&quot;\n中心点を入力&quot;, &quot;&quot;);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; Acad.Editor.getPoint(ppo).then(onCompleteCpt, onError);</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; catch(ex) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; write(ex.message);</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;">function onCompleteCpt(jsonPromptResult) {</span><br /><span style="font-size: 10pt;">&#0160; try { </span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; var resultObj = JSON.parse(jsonPromptResult);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; if (resultObj &amp;&amp; resultObj.status == 5100) { </span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; try {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m_cpt = resultObj.value;</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; var pdo = new Acad.PromptDistanceOptions(&quot;\n半径を入力&quot;);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pdo.useBasePoint = true;</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pdo.allowNone = false;</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pdo.basePoint = new Acad.Point3d(m_cpt.x, m_cpt.y, m_cpt.z);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Acad.Editor.getDistance(pdo).then(onCompleteRad, onError);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; catch(ex) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; write(ex.message);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; }</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; catch(ex) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; write(ex.message);</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;">function onCompleteRad(jsonPromptResult) {</span><br /><span style="font-size: 10pt;">&#0160; try { </span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; var resultObj = JSON.parse(jsonPromptResult);</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; if (resultObj &amp;&amp; resultObj.status == 5100) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; m_rad = resultObj.value;</span><br /><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160; Acad.Editor.executeCommand(&quot;CIRCLE&quot;,</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pointToString(m_cpt),</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; doubleToString(m_rad));</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">&#0160; catch(ex) {</span><br /><span style="font-size: 10pt;">&#0160;&#0160;&#0160; write(ex.message);</span><br /><span style="font-size: 10pt;">&#0160; }</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;">function onError(jsonPromptResult) {</span><br /><span style="font-size: 10pt;">&#0160; write(&quot;\nエラーが発生&quot;);</span><br /><span style="font-size: 10pt;">}</span><br /><br /><span style="font-size: 10pt;">Acad.Editor.addCommand(</span><br /><span style="font-size: 10pt;">&#0160; &quot;MyGroup&quot;,</span><br /><span style="font-size: 10pt;">&#0160; &quot;MYCIRCLE&quot;,</span><br /><span style="font-size: 10pt;">&#0160; &quot;MYCIRCLE&quot;,</span><br /><span style="font-size: 10pt;">&#0160; Acad.CommandFlag.TRANSPARENT,</span><br /><span style="font-size: 10pt;">&#0160; myCircle);</span></p>
</td>
</tr>
</tbody>
</table>
<p>&#0160;</p>
<p>このコードを UTF-8 形式で保存後に WEBLOAD コマンドでロードして、MYCIRCLE コマンドを実行すると、中心点からラバーバンドを表示しながら半径を指定して、CIRCLE コマンドで円を作図することができるはずです。CIRCLE コマンドを実行する <a href="http://www.autocadws.com/jsapi/v1/docs/Acad_Editor_executeCommand.html" target="_blank">Acad.Editor.executeCommand()</a> 関数が、すべて文字列の引数だけを要求する点も他の AutoCAD API と異なる点です。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017eeb23e862970d-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><img alt="MyCircleScss" class="asset  asset-image at-xid-6a0167607c2431970b017eeb23e862970d" src="/assets/image_738609.jpg" title="MyCircleScss" /></a></p>
<p>紹介した MYCIRCLE コマンドを実装した MyCircle.js をこのブログ ポストにアップロードしておきます。</p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b01901c26f017970b"><a href="http://adndevblog.typepad.com/files/mycircle.js">MyCircleをダウンロード</a></span></p>
<p>WEBLOAD コマンドで <a href="http://adndevblog.typepad.com/files/mycircle.js">http://adndevblog.typepad.com/files/mycircle.js</a> を AutoCAD 2014 にロードしてから、MYCIRCLE コマンドを実行してみてください。</p>
<p>AutoCAD JavaScript API は、やはり、HTML&#0160;に埋め込んで、Web コンテンツをユーザ インタフェースとして利用したほうが把握しやすいように思います。</p>
<p>少し時間が空いてしまいますが、「AutoCAD JavaScript API の使い方 ～ その 3」では、AutoCAD JavaScript API を HTML と共に利用する方法をご紹介します。</p>
<p>By Toshiaki Isezaki</p>
<p>&#0160;</p>
