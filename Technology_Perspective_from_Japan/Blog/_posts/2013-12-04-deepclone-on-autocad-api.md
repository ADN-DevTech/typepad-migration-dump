---
layout: "post"
title: "AutoCAD API が持つディープクローン メカニズム"
date: "2013-12-04 00:08:46"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2013/12/deepclone-on-autocad-api.html "
typepad_basename: "deepclone-on-autocad-api"
typepad_status: "Publish"
---

<p>今日は AutoCAD の内部で処理されている最も基本的な複写機能について、少し「ディープ」なメカニズムをご紹介します。地味な話題ですが、ObjectARX や AutoCAD .NET API を利用している方には重要です。また、VBA マクロを AutoCAD .NET API に移植された方にも、API による考え方の違いを理解するうえで有効な話題と言えます。</p>
<p>複写と言って、まず思い浮かぶのはコマンド レベルの操作と思います。図面上でオブジェクトの複写を実行できるのは、<a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-1CF9287F-06E8-4D03-8377-2E130862FE02.htm" rel="noopener" target="_blank">COPY[複写]</a> コマンド、<a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-E23F6125-E5E9-4645-9615-23717902C33B.htm" rel="noopener" target="_blank">ARRAY[配列複写]</a> コマンドが代表的です。形状が反転してしまうものの、複写されたオブジェクトが生成されるという意味では、<a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-595277C8-9B87-4CFB-A3AF-769537A22F3D.htm" rel="noopener" target="_blank">MIRROR[鏡像]</a> コマンドも該当します。また、オブジェクトを選択してコピー&amp;ペーストした際にも、<a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-8C693775-7BB2-48D6-9A6B-770F8A870707.htm" rel="noopener" target="_blank">COPYCLIP[コピー] </a>コマンドと <a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-F7A49705-42BC-46AC-922A-862EE6836CCF.htm" rel="noopener" target="_blank">PASTECLIP[貼り付け]</a> コマンドが実行されています。</p>
<p>さて、AutoCAD API を説明する際には、思い出していただきたい話題が1つあります。API 上でオブジェクトを識別するための <a href="http://adndevblog.typepad.com/technology_perspective/2013/10/object-identifer-of-dautocad-api.html" rel="noopener" target="_blank"><strong>オブジェクト識別子</strong></a> についてです。ObjectARX や .NET API で用いる オブジェクト識別子 は、<strong>オブジェクトID</strong>（AcDbObjectId クラス、または ObjectId クラス）です。図面上のオブジェクトは、すべて、このオブジェクト ID が割り当てられていて、AutoCAD セッション内で必ず一意となるため、個別にオブジェクトを識別することが出来るようになっています。</p>
<p>ここで、オブジェクトを複写した際に何が起こっているか、ということを考えていきます。まず、COPY コマンドでモデル空間に作図された円を選択して、同じモデル空間上に複写したとします。ここでは、オブジェクトIDは図面セッション内で重複してはいけない仕様なので、複写された円のオブジェクトIDは、複写元の円オブジェクトとは異なるオブジェクト ID を持つように処理されます。メモリ上に展開された図面データベースを図で考えてみると、下図のようになります。ピンクで示されるのが複写元の円、黄色で示されるのは複写された円となり、異なるオブジェクト ID を持ちます。また、複写元と複写されたオブジェクトが、同じモデル空間であるという点も再認識できます。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b019b01edf37d970d-pi" style="display: inline;"><img alt="Clone_on_MS" border="0" class="asset  asset-image at-xid-6a0167607c2431970b019b01edf37d970d image-full img-responsive" src="/assets/image_637796.jpg" title="Clone_on_MS" /></a></p>
<p>次に、先の例を発展させて、COPY コマンドでモデル空間の円を選択し、ペーパー空間（レイアウト）に複写することを考えてみます。この場合も、オブジェクトを一意に識別する機能を保つために、複写元と複写先の円が持つオブジェクトIDは、重複しないように処理されます。先ほどとの違いは、複写された空間がモデル空間ではなく、ペーパー空間である、という点です。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b019b01ed88af970b-pi" style="display: inline;"><img alt="Clone_on_MS_PS" border="0" class="asset  asset-image at-xid-6a0167607c2431970b019b01ed88af970b image-full img-responsive" src="/assets/image_260623.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Clone_on_MS_PS" /></a></p>
<p>この場合、円を作図している空間、つまり、図面データベース上の BlockTableRecord インスタンスは、円の <strong>オーナー</strong> と位置づけられます。 また、上図の青い細線で表現されている図面データベース内のすべての「つながり」を、<strong>オーナーシップ接続&#0160;</strong>と呼んでいます。オーナーである BlockTableRecord もオブジェクト ID で一意に識別されている点に注意してください。前述の2つの円は、複写元の円と複写先の円のオーナーが異なりますが、オーナーの識別には、オーナーである BlockTableRecord インスタンスのオブジェク トID を参照することで、その関係を維持しているのです。</p>
<p>ここで、AutoCAD 上に図面A と図面B の2つの図面が開かれていると想定します。図面A のメモリ上の状態を、便宜上、<strong>図面データベースA</strong>、図面B を&#0160;<strong>図面データベースB&#0160;</strong>と呼ぶことにします。</p>
<p>次に、図面データベースA のモデル空間から 図面データベースB のモデル空間へ、円を複写する例を考えてみます。この場合の実際の操作は、コピー&amp;ペーストや <a href="http://docs.autodesk.com/ACD/2014/JPN/files/GUID-297ED4C5-DADC-4C3B-B4FA-94C56A04721B.htm" rel="noopener" target="_blank">WBLOCK コマンド</a>が想定されます。複写元と複写先の円と、そのオーナーは、当然、AutoCAD セッション内でオブジェクト ID は重複することは許されないため、すべて異なるオブジェク トID を持つことになります。</p>
<p><img alt="Clone_on_DBs" border="0" class="asset  asset-image at-xid-6a0167607c2431970b019b01efdbae970c image-full img-responsive" src="/assets/image_7791.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Clone_on_DBs" /></p>
<p>ここまで、3つの例を紹介してきましたが、複写処理では、複写されたオブジェクトのオブジェクト ID が新しく割り当てられる点、また、複写されたオブジェクトのオーナーのオブジェクト ID も変換されている点をご理解いただけたかとお思います。複写処理では、複写したいオブジェクトだけでなく、そのオブジェクトが図面データベース内のどのオーナーを参照しているのかまで、正確に認識しておく必要があるのです。</p>
<p>同じような考え方は、オーナー以外のオブジェクト参照にも当てはまります。例えば、グラフィカル オブジェクトの場合、必ず、画層（LayerTableRecord）を参照しています。同様に線種（LinetypeTableRecord）への参照も必須です。もし、複写元のオブジェクトが、&quot;補助線&quot; と名前の付いた LayerTableRecord と、&quot;Dashdot2&quot; と名前の付いた LinetypeTableRecord を参照していて、そのオブジェクトを複写したとします。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b019b01f02304970c-pi" style="display: inline;"><img alt="DeepClone_on_DBs" border="0" class="asset  asset-image at-xid-6a0167607c2431970b019b01f02304970c image-full img-responsive" src="/assets/image_644113.jpg" title="DeepClone_on_DBs" /></a></p>
<p>もうご理解いただけると思いますが、このような場面では、複写しようとしたオブジェクト（ここでは円）が参照している&#0160;LayerTableRecord と LinetypeTableRecord も、複写先の図面データベースに存在させる必要があるのです。もし、円だけを複写してしまい、<strong>複写元の図面データベースで参照していたオブジェクトが複写先の図面データベースに存在しないと、AutoCAD は図面が破損していると判断</strong>してしまいます。</p>
<p>このような処理を自動的におこなう仕組みを、AutoCAD では <strong>ディープクローン&#0160;</strong>と呼んでいます。もちろん、先の3つ目の例では、LayerTableRecord も LinetypeTableRecord も自動的に複写先の図面データベースに複写され、同時に新しいオブジェクト ID が割り当てられます。また、複写された円が持つ参照先の情報も、複写された &#0160;LayerTableRecord と LinetypeTableRecord に割り当てられた新しいオブジェクト ID をに置き換えられます。</p>
<p>AutoCAD .NET API や ObjectARX で複写処理を自動化する実装をする場合には、このディープクローンを理解した上で正しく処理する必要があります。ディープクローンを自動的におこなう Database.DeepCloneObjects メソッドや Database.WblockCloneObjects メソッドの利用方法は、下記のドキュメントで紹介しています。</p>
<p style="padding-left: 30px;"><strong><span class="asset  asset-generic at-xid-6a0167607c2431970b01b7c80ff77b970b img-responsive"><a href="https://www.autodesk.co.jp/support/technical/article/caas/tsarticles/ts/3AaTtTxjxkTRrTEh3iVgNp.html" rel="noopener" target="_blank">AutoCAD .NET API ：同一図面データベース内でオブジェクトを複写するには？</a></span></strong></p>
<p style="padding-left: 30px;"><strong><span class="asset  asset-generic at-xid-6a0167607c2431970b01bb08b4b664970d img-responsive"><a href="https://www.autodesk.co.jp/support/technical/article/caas/tsarticles/ts/5gB45Tjb0lFcguRSqBGiKw.html" rel="noopener" target="_blank">AutoCAD .NET API ：外部図面データベースにオブジェクトを書き出したい</a></span></strong></p>
<p style="padding-left: 30px;"><strong><span class="asset  asset-generic at-xid-6a0167607c2431970b01bb08b4b672970d img-responsive"><a href="https://www.autodesk.co.jp/support/technical/article/caas/tsarticles/ts/6nsSl3nIOInBQWhLEx60q8.html" rel="noopener" target="_blank">AutoCAD .NET API ：外部図面ファイル内のブロック定義の情報を現在の図面にコピーしたい</a></span></strong></p>
<p>ここまでの説明で、ディープクローンは同じ図面データベース内でオブジェクトを複写する際には必要ないのでは、との考えをお持ちの方もいらっしゃると思います。なぜなら、複写元と複写先が同じ図面データベースであるので、参照中のオーナーや他のオブジェクトがすべて存在しているからです。</p>
<p>確かにそのとおりですが、ディープクローンが必要な場合も存在します。例えば、3Dポリライン（Polyline3d クラス）や旧2Dポリライン（Polyline2d クラス）です。これらは、主エンティティと従属エンティティに分かれてデータが保持されているため、主エンティティだけを複写しても、頂点情報（vertex2d クラスまたはPolylineVertex3d クラス）は複写されません。正確な複写をするためには、同時に頂点情報も複写して、かつ、複写された頂点に割り当てられた新しいオブジェクトIDを参照するよう、処理しなければならないためです。</p>
<p>複写機能は CAD の最も簡単な機能の 1 つですが、内部で面倒な処理がおこなわれていることをご理解いただけたと思います。AutoCAD だけでなく、一般的な CAD も同様です。AutoCAD COM API や AutoLISP では、<strong>オブジェクト</strong>、<strong>インスタンス</strong>、<strong>クラス</strong> という言葉やその違いも含めて、このような考えを意識することは、ほとんどないはずです。逆に、ObjectARX や .NET API では、これを意識する必要がありますが、複写処理に介入して特殊な処理を実装できる「ディープ」な API であるとも言えるのです。</p>
<p>By Toshiaki Isezaki</p>
