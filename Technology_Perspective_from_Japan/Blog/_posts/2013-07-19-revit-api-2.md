---
layout: "post"
title: "Revit ファミリAPI - その2"
date: "2013-07-19 11:00:00"
author: "Mikako Harada"
categories:
  - "API カスタマイズ"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2013/07/revit-%E3%83%95%E3%82%A1%E3%83%9F%E3%83%AAapi-%E3%81%9D%E3%81%AE2.html "
typepad_basename: "revit-ファミリapi-その2"
typepad_status: "Publish"
---

<p><a href="http://adndevblog.typepad.com/technology_perspective/2013/07/revit-ファミリapi.html" target="_self" title="Revit ファミリAPI その１">前回「Revit ファミリAPI - その１」</a>では、Revit APIをもちいてファミリを作成する方法の前半をお話しました。</p>
<p style="padding-left: 30px;">1．計画</p>
<p style="padding-left: 30px;">２．参照面の設定</p>
<p style="padding-left: 30px;">３．パラメータの追加</p>
<p style="padding-left: 30px;">４．タイプの追加</p>
<p style="padding-left: 30px;">５．パラメトリックな動作のテスト - フレックス（Flex）</p>
<p style="padding-left: 30px;">&#0160;</p>
<p>今回は、その続きにあたる、「６．ジェオメトリの追加」からのお話をしたいと思います。</p>
<p style="padding-left: 30px;">６．ジェオメトリの追加</p>
<p style="padding-left: 30px;">7. 拘束（alignment）の追加</p>
<p style="padding-left: 30px;">８．ステップ５～８を繰り返す</p>
<p>&#0160;</p>
<p>６．ジェオメトリの追加</p>
<p>参照面が定義され、パラメータを追加し、意図する動きが定義されたら、ここでようやくジェオメトリを追加します。繰り返しになりますが、パラメトリックのモデルでは、ジェオメトリは骨格(参照面)・筋肉（パラメータ）に追従するスキンにすぎません。</p>
<p>まずは、以下のようなソリッドを追加します。作成には、FamilyCreate.NewExtrusion()
メソッドを使用し、断面形状を下限と上限の参照面間で押し出しする方法を用います。</p>
<p>&#0160;
<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01901e2700d3970b-pi" style="display: inline;"><img alt="10 geometry" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01901e2700d3970b image-full" src="/assets/image_162577.jpg" title="10 geometry" /></a></p>
<p>手順としては、</p>
<p>（１）最初にL字型のプロファイル（断面形状）を定義します。</p>
<p>（２）スケッチ面を作成します。</p>
<p>（３）押し出しの高さを定義します。高さは下限と上限の参照間の距離にあたります。</p>
<p>（４）押し出しソリッドの作成。</p>
<p>&#0160;</p>
<p>ここで、注意していただきたいのは、この時点では、あくまで初期値の値を持ったソリッドです。実際にはソリッドは参照面に拘束されていません。拘束のついか追加は後ほどおこないます。</p>
<div>
<p>Function CreateSolid() As Extrusion</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; (1)
L字型のプロファイル（断面形状）を定義</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pProfile As CurveArrArray = CreateProfileLShape()　&#39; 以下で定義</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39;
(2) スケッチ面を作成</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pRefPlane
As
ReferencePlane = _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Utils.FindElement(m_rvtDoc, </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; GetType(ReferencePlane), &quot;Reference
Plane&quot;) &#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pSketchPlane As SketchPlane = _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; <strong>SketchPlane.Create</strong>(m_rvtDoc,
pRefPlane.Plane) </p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39;
(3) 押し出しの高さは下限と上限の参照間の距離にあたります。</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim
dHeight As Double = Utils.mmToFeet(4000)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39;
(4) 押し出しを作成。</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim bIsSolid As Boolean = True &#39;&#39; Falseにすると負のソリッド</p>
<p>&#0160;&#0160;&#0160; Dim pSolid As Extrusion = _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m_rvtDoc.<strong>FamilyCreate.NewExtrusion</strong>(
_ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; bIsSolid, pProfile, pSketchPlane,
dHeight)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Return pSolid</p>
<p>&#0160;</p>
<p>End Function</p>
</div>
<p>&#0160;</p>
<p>以下のような断面形状を定義します。</p>
<p>
<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b0192abe63bee970d-pi" style="display: inline;"><img alt="11profile" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0192abe63bee970d" src="/assets/image_606256.jpg" title="11profile" /></a><br /><br /></p>
<p>以下がコードです。何をしたいのかがわかると、これは簡単だと思います。</p>
<div>
<p>Function CreateProfileLShape() As CurveArrArray</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim w As Double = Utils.mmToFeet(600)&#0160; &#0160;</p>
<p>&#0160;&#0160;&#0160; Dim d As Double = Utils.mmToFeet(600)</p>
<p>&#0160;&#0160;&#0160; Dim tw As Double = Utils.mmToFeet(150)</p>
<p>&#0160;&#0160;&#0160; Dim td As Double = Utils.mmToFeet(150)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; 頂点を定義します（最後頂点はループを簡単にするために用いています。）</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Const nVerts As Integer =
6 &#39; 頂点の数</p>
<p>&#0160;&#0160;&#0160; Dim pts() As XYZ = { _</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New XYZ(-w / 2, -d / 2, 0), _</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New XYZ(w / 2, -d / 2, 0), _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New XYZ(w / 2, -d / 2 + td, 0), _</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New XYZ(-w / 2 + tw, -d / 2 + td, 0), _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New XYZ(-w / 2 + tw, d / 2, 0), _</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New XYZ(-w / 2, d / 2, 0), _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New XYZ(-w / 2, -d / 2, 0)} </p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; ループを定義。個々のエッジを定義し、curveArrayに追加します。</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pLoop As CurveArray = <strong>m_rvtApp</strong>.<strong>Create</strong>.<strong>NewCurveArray</strong></p>
<p>&#0160;&#0160;&#0160; Dim lines(nVerts - 1) As Line</p>
<p>&#0160;&#0160;&#0160; For i As Integer = 0 To nVerts - 1</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; lines(i) = <strong>Line.CreateBound</strong>(pts(i),
pts(i + 1))</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pLoop.Append(lines(i))</p>
<p>&#0160;&#0160;&#0160; Next</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; さらにcurveArrArrayにループを追加し、プロファイルを定義</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pProfile As CurveArrArray = m_rvtApp.Create.<strong>NewCurveArrArray</strong></p>
<p>&#0160;&#0160;&#0160; pProfile.Append(pLoop)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Return
pProfile</p>
<p>&#0160;</p>
<p>End Function</p>
</div>
<p>&#0160;</p>
<p>7. 拘束（alignment）の追加</p>
<p>上記までのプロセスで、ソリッドを単に追加しただけでは、実はソリッドは参照面には追従しません。ソリッドはとんでもないところにおかれてしまったり、また、別のタイプを選んでも意図した形状には変更してくれません。そういった、「賢い」振る舞いをさせるには、ソリッドの面を参照面に拘束させる必要があります。と同時に、ソリッドから該当する面を見つけるのも少々数学の知識を知識を必要とするところです。</p>
<p>以下ようなOffesetVの参照面にソリッド面を拘束する例を見てみましょう。</p>
<p>
<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b0192abe63d38970d-pi" style="display: inline;"><img alt="12 alignment" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0192abe63d38970d" src="/assets/image_147578.jpg" title="12 alignment" /></a><br /><br /></p>
<p>以下がコードのサンプルです。参照面とソリッドの面をFamilyCreate.NewAlignment()メソッドで拘束します。</p>
<p>コードに出てくるUtilsといったヘルパークラスは、<a href="http://www.autodesk.com/developrevit" target="_self" title="Revit ADNサイト">Labs</a>のコードにあります。FindElementはエレメントフィルタを用いたコードを一般化したもので、難しくないと思いますが、FindFaceに関しては、少々高校での数学の授業を思い出させるかと思いますが&#0160;:-)
、必要に応じて<a href="http://www.autodesk.com/developrevit" target="_self" title="Revit ADNサイト">Labs</a>のコードを参考にしてください。</p>
<div>
<p>Sub AddAlignment_ReferencePlane(ByVal pSolid As Extrusion, _ <br />
&#0160;&#0160;&#0160; ByVal normal As XYZ, ByVal
nameRefPlane As String)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; 拘束するビューを取得します</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pViewPlan As View = _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Utils.FindElement( _</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m_rvtDoc, GetType(ViewPlan), &quot;Lower Ref. Level&quot;)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; 参照面を取得します</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim refPlane As ReferencePlane = _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; Utils.FindElement( _</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m_rvtDoc, GetType(ReferencePlane),
nameRefPlane)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; ソリッドの面の取得。</p>
<p>　　&#39;&#0160; ここでは、面の法線を照らし合わせることでチェックしています。</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pFace As PlanarFace = Utils.FindFace(pSolid, normal, refPlane)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; ロックされた位置合わせの拘束を定義します。</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; m_rvtDoc.<strong>FamilyCreate</strong>.<strong>NewAlignment</strong>(
_ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pViewPlan, refPlane.Reference,
pFace.Reference)</p>
<p>&#0160;</p>
<p>End Sub</p>
</div>
<p>&#0160;</p>
<p>以下がレベルの位置合わせの例です。</p>
<div>
<p>Sub AddAlignment_Level( _ </p>
<p>&#0160;&#0160;&#0160; ByVal
pSolid As
Extrusion, _</p>
<p>&#0160;&#0160;&#0160; ByVal normal As XYZ, _</p>
<p>&#0160;&#0160;&#0160; ByVal nameLevel As String)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; どの方向に見ているのか。<br />
<br />
</p>
<p>&#0160;&#0160;&#0160; Dim pView As View = Utils.FindElement( _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m_rvtDoc, GetType(View), &quot;Front&quot;)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; 上部の基準レベルを見つける。 FindElement（）はヘルパー関数です。</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pLevel As Level = Utils.FindElement( _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; m_rvtDoc, GetType(Level), nameLevel)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; ソリッドの面を見つける。 FindFace（）はヘルパー関数です。</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim pFace As PlanarFace = Utils.FindFace(pSolid, normal)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; 位置合わせの拘束を作成</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; m_rvtDoc.<strong>FamilyCreate.NewAlignment</strong>(
_</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pView, pLevel.PlaneReference,
pFace.Reference)</p>
<p>&#0160;</p>
<p>End Sub</p>
</div>
<p>上記で定義したAddAlignment_Level()とAddAlignment_ReferencePlane()を用いることにより、すべての面を拘束することができます。</p>
<div>
<p>Sub AddAlignments(ByVal pSolid As Extrusion)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; AddAlignment_Level( _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(0.0, 0.0, 1.0), &quot;Upper Ref
Level&quot;)</p>
<p>&#0160;&#0160;&#0160; AddAlignment_Level( _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(0.0, 0.0, -1.0), &quot;Lower Ref. Level&quot;)</p>
<p>&#0160;&#0160;&#0160; AddAlignment_ReferencePlane( _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(1.0, 0.0, 0.0), &quot;Right&quot;)</p>
<p>&#0160;&#0160;&#0160; AddAlignment_ReferencePlane(_ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(-1.0, 0.0, 0.0), &quot;Left&quot;)</p>
<p>&#0160;&#0160;&#0160; AddAlignment_ReferencePlane( _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(0.0, -1.0, 0.0), &quot;Front&quot;)</p>
<p>&#0160;&#0160;&#0160; AddAlignment_ReferencePlane( _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(0.0, 1.0, 0.0), &quot;Back&quot;)</p>
<p>&#0160;&#0160;&#0160; AddAlignment_ReferencePlane( _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(1.0, 0.0, 0.0), &quot;OffsetV&quot;)</p>
<p>&#0160;&#0160;&#0160; AddAlignment_ReferencePlane( _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; pSolid, New XYZ(0.0, 1.0, 0.0), &quot;OffsetH&quot;)</p>
<p>&#0160;</p>
<p>End Sub</p>
</div>
<p>&#0160;</p>
<p>８．ステップ５～８を繰り返す</p>
<p>これで、基本的なジェオメトリの追加でできました。フレックス(Flex)テストを行います。</p>
<p>さらに必要であればジェオメトリを追加し、テスト・追加を繰り返します。</p>
<p>プロジェクトファイルにロードして、テストします。</p>
<p>&#0160;</p>
<p>これで、APIを用いたファミリーの作成の基本をご理解いただけたかと思います。APIでのファミリの作成に興味をお持ちの方、ぜひ試してみてください。</p>
<p>（コードは、<a href="http://www.autodesk.com/developrevit" target="_self" title="Revit ADN サイト">Revit ADN Open のサイトにポストしてあるRevit 2013/2014 API Labs</a>&#0160;にあります。必要に応じて参考にしてください。）</p>
<p>原田</p>
