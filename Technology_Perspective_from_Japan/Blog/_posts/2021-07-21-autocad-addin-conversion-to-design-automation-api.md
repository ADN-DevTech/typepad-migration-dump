---
layout: "post"
title: "AutoCAD アドインの Design Automation API 化"
date: "2021-07-21 00:02:58"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2021/07/autocad-addin-conversion-to-design-automation-api.html "
typepad_basename: "autocad-addin-conversion-to-design-automation-api"
typepad_status: "Publish"
---

<p><strong><a href="https://adndevblog.typepad.com/technology_perspective/2020/07/forge-online-design-automation-api-for-autocad.html" rel="noopener" target="_blank">Forge Online - Design Automation：AutoCAD タスクの自動化</a>&#0160;</strong>でご紹介のとおり、Design Automation API for AutoCAD（略称：DA4A）を利用する上で、AppBundle（コアエンジンでロードさせるアドイン アプリ パッケージ）は必須ではありません。</p>
<p>ただ、カスタマイズされたワークフローの自動化には、やはり、アドイン アプリによる細かいコントロールは必要です。ここでは、<strong>Design Automation API for AutoCAD の効果</strong>&#0160;の <strong>例１）図面の作成・編集&#0160;</strong>でご案内したアドイン アプリをどのように DA4A に適用していくのか、具体的な差と移植に必要な情報をお届けします。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0278802b1756200d-pi" style="display: inline;"><img alt="Addin_migration" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0278802b1756200d image-full img-responsive" src="/assets/image_260718.jpg" title="Addin_migration" /></a></p>
<hr />
<p><strong>AutoCAD アドイン実装：</strong></p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0282e103abfc200b-pi" style="float: right;"><img alt="Vs_acad" class="asset  asset-image at-xid-6a0167607c2431970b0282e103abfc200b img-responsive" src="/assets/image_403734.jpg" style="width: 200px; margin: 0px 0px 5px 5px;" title="Vs_acad" /></a>このアドイン（CreateCoil.dll）は、 AutoCAD .NET API の <strong>AcCoreMgd.dll</strong>、<strong>AcDbMgd.dll</strong>、<strong>AcMgd.dll</strong> アセンブリを参照設定する Visual Studio の C# プロジェクトで実装されています。</p>
<p>プロジェクトでは CreateCoil カスタム コマンドを定義していて、<a href="https://knowledge.autodesk.com/ja/community/article/366346" rel="noopener" target="_blank"><strong>AutoCAD .NET API：パレット ダイアログを作成する方法</strong></a>&#0160;に準じたパレット ダイアログを表示します。パレット ダイアログの実装には <strong>AcMgd.dll</strong> アセンブリが使われている点に注意してください。</p>
<p>ダイアログ内に配置した [Create(作成)] ボタンをクリックすると、同じくダイアログ内の turn(旋回数)、radius(半径)、height(高さ) の入力値で らせん オブジェクトを作成、らせんに沿って円を押し出したスイープソリッドを作図します。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026bded323c6200c-pi" style="display: inline;"><img alt="Coil_creation_autocad" border="0" class="asset  asset-image at-xid-6a0167607c2431970b026bded323c6200c image-full img-responsive" src="/assets/image_852162.jpg" title="Coil_creation_autocad" /></a></p>
<p>[Create(作成)] ボタンの Click プロシージャのコードは次のとおりです。<span style="color: #4040ff;"><strong>青字部分</strong></span>が、パレット ダイアログからの入力値の取得箇所です。</p>
<blockquote>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">private void button1_Click(object sender, EventArgs e)</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">{</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; Database acCurDb = HostApplicationServices.WorkingDatabase;</span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; DocumentLock docLock = </span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; Application.DocumentManager.MdiActiveDocument.LockDocument();</span></p>
<p><span style="color: #4040ff;"><strong><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; Int16 intTurns = short.Parse(textBox1.Text);</span></strong></span><br /><span style="color: #4040ff;"><strong><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; Double dblRadius = double.Parse(textBox2.Text);</span></strong></span><br /><span style="color: #4040ff;"><strong><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; Double dblHeight = double.Parse(textBox3.Text);</span></strong></span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; // Start a transaction</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; using (Transaction acTrans = acCurDb.TransactionManager.StartTransaction())</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; {</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; // Open the Block table for read</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; BlockTable acBlkTbl;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acBlkTbl = acTrans.GetObject(acCurDb.BlockTableId,</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; OpenMode.ForRead) as BlockTable;</span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; // Open the Block table record Model space for write</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; BlockTableRecord acBlkTblRec;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acBlkTblRec = acTrans.GetObject(acBlkTbl[BlockTableRecord.ModelSpace],</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; OpenMode.ForWrite) as BlockTableRecord;</span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; // Create a helix</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; Helix acHelix = new Helix();</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.SetDatabaseDefaults();</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.Constrain = ConstrainType.Turns;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.StartPoint = Point3d.Origin;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.BaseRadius = dblRadius;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.TopRadius = dblRadius;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.Height = dblHeight;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.Turns = intTurns;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.Twist = false;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acHelix.CreateHelix();</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acBlkTblRec.AppendEntity((Entity)acHelix);</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acTrans.AddNewlyCreatedDBObject(acHelix, true);</span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; // Create Circle</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; Circle acCircle = new Circle();</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acCircle.Center = acHelix.StartPoint;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acCircle.Normal = new Vector3d(0.0, 0.0, 1.0);</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acCircle.Radius = 2.5;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acBlkTblRec.AppendEntity((Entity)acCircle);</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acTrans.AddNewlyCreatedDBObject(acCircle, true);</span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; // Creat Sweep Solid</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; SweepOptionsBuilder acSwOption = new SweepOptionsBuilder();</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acSwOption.Align = SweepOptionsAlignOption.AlignSweepEntityToPath;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acSwOption.BasePoint = acHelix.StartPoint;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acSwOption.Bank = true;</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; Solid3d acSweep = new Solid3d();</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acSweep.CreateSweptSolid(acCircle, acHelix, acSwOption.ToSweepOptions());</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acBlkTblRec.AppendEntity((Entity)acSweep);</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acTrans.AddNewlyCreatedDBObject(acSweep, true);</span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; // Save the new object to the database</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; acTrans.Commit();</span></p>
<p><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; &#0160; &#0160; docLock.Dispose();</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 8pt;">&#0160; &#0160; }</span><br /><span style="font-family: &#39;courier new&#39;, courier; font-size: 10pt;"><span style="font-size: 8pt;">}</span><br /></span></p>
</blockquote>
<p>AutoCAD には、<a href="https://adndevblog.typepad.com/technology_perspective/2013/09/auto-loading-for-autocad-addon-apps.html" rel="noopener" target="_blank"><strong>AutoCAD アドオンの自動ロードの方法あれこれ</strong></a> のように複数の自動ロード方法がありますが、このアドインは <strong>バンドル パッケージを使った自動ロード </strong>を採用しています。バンドル パッケージのフォルダ構成（右図）と PackageContents.xml の内容は次のとおりです。</p>
<blockquote>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;"> <a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0278802b4438200d-pi" style="float: right;"><img alt="Folder_structure" class="asset  asset-image at-xid-6a0167607c2431970b0278802b4438200d img-responsive" src="/assets/image_281711.jpg" style="width: 200px; margin: 0px 0px 5px 5px;" title="Folder_structure" /></a>&lt;ApplicationPackage</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; SchemaVersion=&quot;1.0&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; AppVersion=&quot;1.0&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; ProductCode=&quot;&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; Name=&quot;CreateCoil Package&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; ProductType=&quot;Application&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; Description=&quot;Create a Coil&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; Author=&quot;Toshiaki Isezaki&quot; &gt;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &lt;CompanyDetails</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; Name=&quot;Autodesk Ltd,. Japan&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; Url=&quot;https://www.autodesk.co.jp&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; Email=&quot;xxxxx.yyyyy@autodesk.com&quot; /&gt;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &lt;Components&gt;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &lt;RuntimeRequirements</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; OS=&quot;Win64&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; Platform=&quot;AutoCAD&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; SeriesMin=&quot;R23.0&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; SeriesMax=&quot;R24.1&quot; /&gt;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &lt;ComponentEntry</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; AppName=&quot;CreateCoil&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; ModuleName=&quot;./Contents/CreateCoil.dll&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; AppDescription=&quot;Create a Coil&quot;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; LoadOnAutoCADStartup=&quot;True&quot; /&gt;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &lt;/Components&gt;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&lt;/ApplicationPackage&gt;</span></p>
</blockquote>
<ul>
<li>Autodesk.AutoCAD+24 コアエンジン バージョン以降、AppBundle でアドイン ファイルの自動ロード定義に使用する PackageContents.xml において、ロード タイミングを起動時ロードを指定する LoadOnAutoCADStartup にしていると、パフォーマンス低下抑止のため、コアエンジンへのロードが実行されません。代替として、コマンド呼び出し時にアドインをロードさせる LoadOnCommandInvocation を指定してください。</li>
</ul>
<hr />
<p><strong>Design Automation API for AutoCAD アドイン（AppBundle）実装：</strong></p>
<p>AutoCAD アドインを Design Automation API for AutoCAD で利用出来るようにしていきます。ローカル環境の AutoCAD でロードして運用する前述のアドインでは、ユーザ インタフェースの実装とコイル状スイープ ソリッドの作図実装が、すべて アドイン内に実装されていて、処理もローカル環境の AutoCAD 内で完結します。</p>
<p>一方、DA4A の場合には、ユーザ インタフェースの実装とコイル状スイープ ソリッドの作図実装が、Web 配信する HTML ページとコアエンジンにロードするアドインに分離されて実装されることになります。</p>
<p>なお。DA4A では、コアエンジンへのアドイン ロードには <strong>バンドル パッケージを使った自動ロード</strong> <span style="text-decoration: underline;">のみがサポート</span>されます。また、<strong>WorkItem</strong> と呼ぶ実際の処理を実行する前に、バンドル パッケージを ZIP 圧縮して<a href="https://forge.autodesk.com/en/docs/design-automation/v3/reference/http/appbundles-POST/" rel="noopener" target="_blank"><strong>登録</strong></a>しておく必要があります。これを <strong>AppBundle</strong> と呼称していて、フォルダ構成に PackageContents.xml とアドイン ファイルを含めて UTF-8 形式で ZIP 圧縮しています。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0282e1037615200b-pi" style="display: inline;"><img alt="Coil_creation" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0282e1037615200b image-full img-responsive" src="/assets/image_433981.jpg" title="Coil_creation" /></a></p>
<p>ここではアドインの DA4A 化に焦点を当てているので詳細は割愛しますが、HTML ページで入力された turn(旋回数)、radius(半径)、height(高さ) の値は、実際の処理（WorkItem で指定する CreateCoil コマンド処理）時に、JSON ファイルとしてコアエンジンが実行される作業領域に AppBundle と一緒に保存されることになります。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026bded354d9200c-pi" style="display: inline;"><img alt="Fry_params_to_cloud" border="0" class="asset  asset-image at-xid-6a0167607c2431970b026bded354d9200c image-full img-responsive" src="/assets/image_904123.jpg" title="Fry_params_to_cloud" /></a></p>
<p>この場合、AppBundle によってコアエンジンにロードされるアドインは、実行時に同じ作業領域（フォルダ）ある JSON ファイルを読み込み、スイープ ソリッドに必要なパラメータ値を取得、作図に利用する必要があります。</p>
<p>.NET API アドインで JSON ファイルを読み込み（デシリアライズ）、内容をパース、turn(線回数)、radius(半径)、height(高さ) の各値を取得するには、<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.text.json" rel="noopener" target="_blank"><strong>System.Text.Json</strong></a> 名前空間を利用するか、Newtonsoft 社がオープンソースとして公開している <strong><a href="https://www.newtonsoft.com/json" rel="noopener" target="_blank">Json.NET</a> </strong>パッケージ（ライブラリ）を利用が一般的です。</p>
<p>このアドイン（CreateCoil.dll）では、使用事例が豊富な Json.NET パッケージを利用します。Json.NET パッケージは、Visual Studio の <strong><a href="https://docs.microsoft.com/ja-jp/nuget/quickstart/install-and-use-a-package-in-visual-studio" rel="noopener" target="_blank">NuGet パッケージ マネージャ</a></strong>を使って Visual Studio プロジェクトに簡単に導入することが出来ます。</p>
<p>次のコードは、DA4A 上で実行されることになる CrrateCoil コマンドの実装内容です。<span style="color: #4040ff;"><strong>青字部分</strong></span>が、JSON ファイルからの入力値の取得箇所です</p>
<blockquote>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">public class MyCommands</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">{</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; // Modal Command with localized name</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; [CommandMethod(&quot;CreateCoil&quot;, CommandFlags.Modal)]</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; public void MyCommand() // This method can have any name</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; {</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Log(&quot;\nStart Addin process ...&quot;);</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Database acCurDb = HostApplicationServices.WorkingDatabase;</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Log(&quot;\nGot database ...&quot; );</span></p>
<p><span style="color: #4040ff;"><strong><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; InputParams inputParams = <br />&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; JsonConvert.DeserializeObject&lt;InputParams&gt;(File.ReadAllText(&quot;.\\params.json&quot;));</span></strong></span><br /><span style="color: #4040ff;"><strong><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Double intTurns = inputParams.Turn;</span></strong></span><br /><span style="color: #4040ff;"><strong><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Double dblRadius = inputParams.Radius;</span></strong></span><br /><span style="color: #4040ff;"><strong><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Double dblHeight = inputParams.Height;</span></strong></span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Log(&quot;\nAddin retrieves Turn:{0}, Radius{1}, Height:{2}&quot;, intTurns, dblRadius, dblHeight);</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; // Start a transaction</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; using (Transaction acTrans = acCurDb.TransactionManager.StartTransaction())</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; {</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; // Open the Block table for read</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; BlockTable acBlkTbl;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acBlkTbl = acTrans.GetObject(acCurDb.BlockTableId,</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; &#0160; OpenMode.ForRead) as BlockTable;</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; // Open the Block table record Model space for write</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; BlockTableRecord acBlkTblRec;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acBlkTblRec = acTrans.GetObject(acBlkTbl[BlockTableRecord.ModelSpace],</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; OpenMode.ForWrite) as BlockTableRecord;</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; // Create a helix</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; Helix acHelix = new Helix();</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.SetDatabaseDefaults();</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.Constrain = ConstrainType.Turns;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.StartPoint = Point3d.Origin;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.BaseRadius = dblRadius;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.TopRadius = dblRadius;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.Height = dblHeight;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.Turns = intTurns;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.Twist = false;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acHelix.CreateHelix();</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acBlkTblRec.AppendEntity((Entity)acHelix);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acTrans.AddNewlyCreatedDBObject(acHelix, true);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; Log(&quot;\nHelix path created ...&quot;);</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; // Create Circle</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; Circle acCircle = new Circle();</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acCircle.Center = acHelix.StartPoint;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acCircle.Normal = new Vector3d(0.0, 0.0, 1.0);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acCircle.Radius = 2.5;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acBlkTblRec.AppendEntity((Entity)acCircle);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acTrans.AddNewlyCreatedDBObject(acCircle, true);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; Log(&quot;\nCircle section created ...&quot;);</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; // Creat Sweep Solid</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; SweepOptionsBuilder acSwOption = new SweepOptionsBuilder();</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acSwOption.Align = SweepOptionsAlignOption.AlignSweepEntityToPath;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acSwOption.BasePoint = acHelix.StartPoint;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acSwOption.Bank = true;</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; Solid3d acSweep = new Solid3d();</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acSweep.CreateSweptSolid(acCircle,acHelix, acSwOption.ToSweepOptions());</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acSweep.ColorIndex = 1; </span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acBlkTblRec.AppendEntity((Entity)acSweep);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acTrans.AddNewlyCreatedDBObject(acSweep, true);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; Log(&quot;\nSweep coil created ...&quot;);</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; // Save the new object to the database</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; acTrans.Commit();</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; }</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; acCurDb.SaveAs(&quot;.\\result.dwg&quot;, DwgVersion.Current);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; &#0160; &#0160; Log(&quot;\nresult.dwg was saved ...&quot;);</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; }</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; private static void Log(string format, params object[] args) {<br />&#0160; &#0160; &#0160; &#0160; &#0160; &#0160; Application.DocumentManager.MdiActiveDocument.Editor.WriteMessage(format, args); }</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">}</span></p>
<p><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">public class InputParams</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">{</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; public Int16 Turn { get; set; }</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; public double Radius { get; set; }</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">&#0160; &#0160; public double Height { get; set; }</span><br /><span style="font-size: 8pt; font-family: &#39;courier new&#39;, courier;">}</span></p>
</blockquote>
<p>Json.NET パッケージを導入した Visual Studio プロジェクトには、Newtonsoft.Json.dll アセンブリが含まれるようになります。<strong>Newtonsoft.Json.dll</strong> と <strong>Newtonsoft.Json.xml</strong> は DA4A の作業環境にも必要になるので、AppBundle のフォルダ構成に含めておく必要があります。</p>
<p>また、DA4A コアエンジンにはユーザ インターフェースはありませんので、同環境で稼働するアドインにはダイアログ ボックスなどのユーザ インタフェース実装時に必要な <strong>AcMgd.dll</strong> アセンブリを参照設定しておくことも出来ません。もはや、パレット ダイアログはアドインには不要です。DA4A のアドイン用 Visual Studio プロジェクトに参照設定する AutoCAD アセンブリは、<strong>A</strong><strong>cCoreMgd.dll</strong>、<strong>AcDbMgd.dll</strong> になります。</p>
<p>このため、Visual Studio プロジェクトの参照設定（左図と、AppBundle のバンドル パッケージのフォルダ構成（右図）は次のようになります。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026bded356c8200c-pi" style="float: left;"> </a><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026bded356d3200c-pi" style="float: right;"><img alt="Folder_structure2" class="asset  asset-image at-xid-6a0167607c2431970b026bded356d3200c img-responsive" src="/assets/image_365043.jpg" style="width: 200px; margin: 0px 0px 5px 5px;" title="Folder_structure2" /></a><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026bded356c8200c-pi" style="float: left;"><img alt="Vs_da4a" class="asset  asset-image at-xid-6a0167607c2431970b026bded356c8200c img-responsive" src="/assets/image_928450.jpg" style="width: 200px; margin: 0px 5px 5px 0px;" title="Vs_da4a" /></a></p>
<p>&#0160;</p>
<p>&#0160;</p>
<p>&#0160;</p>
<p>&#0160;</p>
<p>&#0160;</p>
<p>&#0160;</p>
<p>&#0160;</p>
<p>バンドル パッケージの PackageContents.xml の内容は、ローカル環境と同じものを流用することが出来ます。</p>
<hr />
<p>ここでご紹介していない部分、HTML ページのどの入力値を JSON ファイル化するのか、その際のファイル名はどうするのか、コアエンジンで実行するカスタム コマンドを何か、などは、Design Automation API for AutoCAD の Activity とWorkItem で指定することになります。</p>
<p>実際の使用時には <a href="https://adndevblog.typepad.com/technology_perspective/2020/12/notes-on-using-da4a.html" rel="noopener" target="_blank"><strong>Design Automation API for AutoCAD 利用の注意点</strong></a> もご確認ください。</p>
<p>By Toshiaki Isezaki</p>
