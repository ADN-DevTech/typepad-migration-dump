---
layout: "post"
title: "Forge Viewer でのモデル表示コードの進化"
date: "2017-02-08 00:27:40"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2017/02/code-evolution-to-show-models-on-forge-viewer.html "
typepad_basename: "code-evolution-to-show-models-on-forge-viewer"
typepad_status: "Publish"
---

<p>Autodesk Forge では、2-legged 認証を利用した場合でも、3-legged 認証を利用した場合でも、多くの場合、最終的に JavaScript で記述したクライアントコードを実装して、Web ブラウザ上に 3D モデルや 2D 図面を表示することになるはずです。もちろん、2-legged 認証での場合には、Data Management API でデザイン ファイルをアップロードしたり、Model Derivative API で表示用の変換処理をする場合もあります。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d25d6444970c-pi" style="display: inline;"><img alt="2legged-3legged-steps" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d25d6444970c image-full img-responsive" src="/assets/image_415164.jpg" title="2legged-3legged-steps" /></a></p>
<p>実は、3D モデルや 2D 図面を表示する JavaScript コードには、何パターンかプログラムの書き方が存在します。View and Data API 時代からの遷移も含め、Forge Viewer の &#0160;JavaScript ライブラリを提供するオートデスク自体が、JavaScript ライブラリを拡張すると同時にラッパーを作成して簡素化しているのが要因です。</p>
<p>例えば、<strong>デベロッパ ポータル（<a href="http://developer.autodesk.com" rel="noopener noreferrer" target="_blank">http://developer.autodesk.com</a>）</strong>&#0160;に記載されている Viewer の Step by Step Tutorial には、<strong>Basic Viewer</strong> と <strong>Basic Application</strong> という 2 パターンが説明されています。&#0160;また、過去のブログ記事 Postman による <strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/09/understanding-steps-to-use-viewer-on-postman.html" rel="noopener noreferrer" target="_blank">Viewer 利用手順の理解 - 2 legged 認証</a>&#0160;</strong>や <strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/01/forge-viewer-tutorial-part1-implement-nodejs-server.html" rel="noopener noreferrer" target="_blank">Forge Viewer チュートリアル ～ その1 ～ Node.js サーバーの実装</a></strong>&#0160;では、最後の部分で <strong><a href="https://rawgit.com/Developer-Autodesk/library-javascript-view.and.data.api/master/js/Autodesk.ADN.Toolkit.Viewer.js" rel="noopener noreferrer" target="_blank">Autodesk.ADN.Toolkit.Viewer.js</a></strong>&#0160;という ADN チームが作成した JavaScript ライブラリでラップし、RESTful API や Viewer 表示用のコードを隠蔽しています。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d25d62a1970c-pi" style="display: inline;"><img alt="Lmv_code_evolution" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d25d62a1970c image-full img-responsive" src="/assets/image_956336.jpg" title="Lmv_code_evolution" /></a></p>
<p>この中で、現在、推奨されているのは、新しい <strong><a href="https://developer.autodesk.com/en/docs/viewer/v2/reference/javascript/viewingapplication/" rel="noopener noreferrer" target="_blank">Autodesk.Viewing.ViewingApplication オブジェクト</a></strong>を利用する&#0160;<strong>Basic Application</strong>&#0160;で紹介されるコードです。<strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/01/specifying-version-to-forge-viewer.html" rel="noopener noreferrer" target="_blank">Forge Viewer のバージョン指定</a>&#0160;</strong>でも触れていますが、Forge Viewer は数ヶ月毎にバージョンアップしているほか、オートデスクが用意した<strong> <a href="http://adndevblog.typepad.com/technology_perspective/2016/12/extensions-abailable-on-forge-viewer.html" rel="noopener noreferrer" target="_blank">Extension</a></strong>&#0160;も増加傾向にあります。このため、変換されたデザイン ファイルが 2D &#0160;View（図面/シート）や 3D View（3D モデル）の判定を含む表示処理や、Extension のロード方法をラップして提供するようになっているのです。</p>
<p>どの方法を使っても表示される結果は同じになりますが、今後の拡張も考慮すると、<strong>Basic Application</strong> 方式を採用するのが適切です。</p>
<p>下記に、デベロッパ ポータルにある Basic Viewer と Basic Application の方法で表示処理を実装した HTML ファイルを用意しました。 Access Token と表示する URN（ドキュメントID）を URL パラメータで渡せるように、両パラメータの値を取得する JavaScript コードを追記したものを用意しましたので、それぞれ、内容を確認してみてください。</p>
<pre>&#0160; var token = Autodesk.Viewing.Private.getParameterByName(&quot;accessToken&quot;);<br />  var urn = Autodesk.Viewing.Private.getParameterByName(&quot;urn&quot;);</pre>
<p><strong>Basic Viewer</strong></p>
<p style="padding-left: 30px;"><strong> <span class="asset  asset-generic at-xid-6a0167607c2431970b01b7c8d32202970b img-responsive"><a href="http://adndevblog.typepad.com/files/basic_viewer.html">Basic_Viewer.html をダウンロード</a></span></strong></p>
<p><strong>Basic Application</strong></p>
<p style="padding-left: 30px;"><strong> <span class="asset  asset-generic at-xid-6a0167607c2431970b01b8d25d672e970c img-responsive"><a href="http://adndevblog.typepad.com/files/basic_application.html">Basic_Application.html をダウンロード</a></span></strong></p>
<p>利用方法は、&#0160;<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/09/understanding-steps-to-use-viewer-on-postman.html" rel="noopener noreferrer" target="_blank">Viewer 利用手順の理解 - 2 legged 認証</a></strong>&#0160;の <strong>6.</strong> と同様、ダウンロードした HTML のファイル名<span class="asset  asset-generic at-xid-6a0167607c2431970b01b8d222c3e4970c img-responsive">の後に ? でパラメータを接続して、パラメータ間は &amp; で統合して、ブラウザで開くだけです。例えば、Access Token が <span style="background-color: #fcfae1;">YTXTGxSkNUOpztepIsgHbZTUWtUX</span> で、ドキュメント ID（URN）が <span style="background-color: #bfffff;">dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6MGZia3Yxc2hicnR1aWRpdDUxa2VjdjQ1dXVqdnNobi10cmFuc2llbnQvTFJUX1N0YXRpb24ubndk</span> の場合、デスクトップにダウンロード済みの basic_application.html には、次のように表示するドキュメントを引き渡して表示することが出来ます。ここでは、Windows に isezakt のユーザ名でサインインしたユーザのデスクトップを仮定しています。ご自身の環境にあわせて、適宜、パスを変更してください。</span></p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b01b8d222c3e4970c img-responsive">file:///C:/Users/isezakt/Desktop/basic_application.html?accessToken=<span style="background-color: #fcfae1;">YTXTGxSkNUOpztepIsgHbZTUWtUX</span>&amp;urn=<span style="background-color: #bfffff;">dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6MGZia3Yxc2hicnR1aWRpdDUxa2VjdjQ1dXVqdnNobi10cmFuc2llbnQvTFJUX1N0YXRpb24ubndk</span></span></p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb09764435970d-pi" style="display: inline;"><img alt="Basic_application_example" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb09764435970d image-full img-responsive" src="/assets/image_560481.jpg" title="Basic_application_example" /></a></p>
<p>なお、 Autodesk.Viewing.ViewingApplication オブジェクトを利用する <strong>Basic Application</strong> 方式では、Extension のロード方法も最適化されています。<a href="https://rawgit.com/Developer-Autodesk/library-javascript-view.and.data.api/master/js/Autodesk.ADN.Toolkit.Viewer.js" rel="noopener noreferrer" target="_blank">Autodesk.ADN.Toolkit.Viewer.js</a>&#0160;や Basic Viewer 方式では、Extension のロードに&#0160;Autodesk.Viewing.Viewer3D.<strong>loadExtension</strong> メソッド を利用していました。Basic Application では、Autodesk.Viewing.ViewingApplication オブジェクトの初期化時に、config パラメータとして Extension 名を渡すことで、適切にロードさせることが出来ます。下記は、Viewing.Extension.MyExtension 名の Extension をロードさせる場合の記述です。</p>
<pre>&#0160; var documentId = &#39;urn:&#39; + urn;<br />  Autodesk.Viewing.Initializer(options, function onInitialized(){<br /><strong>      var config3d = {</strong><br /><strong>          extensions: [&#39;Viewing.Extension.MyExtension&#39;]</strong><br /><strong>      };</strong><br />      viewerApp = new Autodesk.Viewing.ViewingApplication(&#39;MyViewerDiv&#39;);<br />      viewerApp.registerViewer(viewerApp.k3D, Autodesk.Viewing.Private.GuiViewer3D, <strong>config3d</strong>);<br />      viewerApp.loadDocument(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);<br />  });</pre>
<p>一度、この <strong>Basic Application</strong> 方式もお試しください。&#0160;</p>
<p>By Toshiaki Isezaki</p>
