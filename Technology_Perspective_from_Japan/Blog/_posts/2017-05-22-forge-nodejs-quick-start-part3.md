---
layout: "post"
title: "Forge Node.js クイックスタート ～ 付録"
date: "2017-05-22 00:35:29"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part3.html "
typepad_basename: "forge-nodejs-quick-start-part3"
typepad_status: "Publish"
---

<p><span style="background-color: #ffff00;">&lt;本記事は2019年12月10日に Forge SDK 更新と Forge Viewer v7 にあわせて一部改定しています。&gt;</span></p>
<p>Forge Node.js クイックスタートについて記したブログ記事では、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part1.html" rel="noopener noreferrer" target="_blank">その１</a></strong>、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part2.html" rel="noopener noreferrer" target="_blank">その 2</a></strong> の 2 回にわたって、Forge SDK を用いたアプリ認証、ファイルのアップロード・変換までバッチ処理的に実装し、最後に手動で URL パラメータを用いた方法で <strong><a href="https://adndevblog.typepad.com/files/viewer.htm">Viewer.htm </a></strong>を利用してデザイン ファイルの表示しました。</p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b01b8d25d672e970c img-responsive">ここでは、付録として Node.js 標準のミドルウェア（別名：パッケージ、あるいは、モジュール）である <strong><a href="http://nodejs.jp/nodejs.org_ja/api/http.html" rel="noopener noreferrer" target="_blank">http</a></strong> を利用して 、Viewer 表示処理の部分を自動化してみたいと思います。</span></p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b01b8d25d672e970c img-responsive">まず、前回作成した dmSample.js の冒頭の箇所で、http モジュールを読み込む処理を 1 行（青字箇所）追記します。</span></p>
<pre>var fs = require(&#39;fs&#39;);<br /><br /><span style="color: #0000ff;"><strong>var http = require(&#39;http&#39;);</strong></span><br /><br />var ForgeSDK = require(&#39;./../src/index&#39;);</pre>
<p>次に、同じく dmSample.js の manifestFile() 関数の後に、次の青字箇所を追記してください。</p>
<pre><span style="color: #0000ff;"><strong>var server = http.createServer();</strong></span><br /><span style="color: #0000ff;"><strong>server.listen(3000, &quot;localhost&quot;);</strong></span><br /><span style="color: #0000ff;"><strong>console.log(&quot;Server is listening port 3000&quot;);</strong></span><br /><br /><span style="color: #0000ff;"><strong>var showViewer = function (credentials, encodedURN) {</strong></span><br /><br /><span style="color: #0000ff;"><strong>  server.on(&#39;request&#39;, function(req,res){</strong></span><br /><span style="color: #0000ff;"><strong>    var access_token = credentials[&quot;access_token&quot;];</strong></span><br /><span style="color: #0000ff;"><strong>    res.writeHead(200, {&#39;Content-Type&#39;: &#39;text/html&#39;});</strong></span><br /><span style="color: #0000ff;"><strong>    var data = [<br /></strong></span><span style="color: #0000ff;"><strong>      &#39;&lt;html&gt;&#39;,<br />      &#39;  &lt;head&gt;&#39;,<br />      &#39;    &lt;title&gt;Forge Viewer&lt;/title&gt;&#39;,<br />      &#39;    &lt;meta charset=&quot;utf-8&quot;&gt;&#39;,<br />      &#39;    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css&quot; type=&quot;text/css&quot;&gt;&#39;,<br />      &#39;    &lt;script src=&quot;https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;&#39;,<br />      &#39;    &lt;script src=&quot;https://code.jquery.com/jquery-2.1.2.min.js&quot;&gt;&lt;/script&gt;&#39;,<br />      &#39;    &lt;script&gt;&#39;,<br />      &#39;      $(document).ready(function () {&#39;,<br />      &#39;&#39;,<br />      &#39;        var options = {&#39;,<br />      &quot;          env: &#39;AutodeskProduction&#39;,&quot;,<br />      &quot;          api: &#39;derivativeV2&#39;,&quot;,<br />      &quot;          language: &#39;ja&#39;,&quot;,<br />      &#39;          getAccessToken: function (onTokenReady) {&#39;,<br />      &quot;            var token = &#39;&quot; + access_token +&quot;&#39;;&quot;,<br />      &#39;            var timeInSeconds = 3600;&#39;,<br />      &#39;            onTokenReady(token, timeInSeconds);&#39;,<br />      &#39;          }&#39;,<br />      &#39;        };&#39;,<br />      &#39;&#39;,<br />      &#39;        Autodesk.Viewing.Initializer(options, function () {&#39;,<br />      &quot;          _viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById(&#39;viewer3d&#39;), options);&quot;,<br />      &#39;&#39;,<br />      &#39;          var startedCode = _viewer.start();&#39;,<br />      &#39;          if (startedCode &gt; 0) {&#39;,<br />      &quot;            console.error(&#39;Failed to create a Viewer: WebGL not supported.&#39;);&quot;,<br />      &#39;            return;&#39;,<br />      &#39;          }&#39;,<br />      &#39;&#39;,<br />      &quot;          console.log(&#39;Initialization complete, loading a model next...&#39;);&quot;,<br />      &#39;&#39;,<br />      &quot;          var documentId = &#39;&quot; + &quot;urn:&quot; + encodedURN + &quot;&#39;;&quot;,<br />      &#39;          Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);&#39;,<br />      &#39;        });&#39;,<br />      &#39;&#39;,<br />      &#39;        function onDocumentLoadSuccess(viewerDocument) {&#39;,<br />      &#39;          var viewables = viewerDocument.getRoot().search({&#39;,<br />      &quot;            &#39;type&#39;: &#39;geometry&#39;,&quot;,<br />      &quot;            &#39;role&#39;: &#39;3d&#39;&quot;,<br />      &#39;          });&#39;,<br />      &#39;          _viewer.loadDocumentNode(viewerDocument, viewables[0]).then(i =&gt; {&#39;,<br />      &#39;          });&#39;,<br />      &#39;        }&#39;,<br />      &#39;&#39;,<br />      &#39;        function onDocumentLoadFailure() {&#39;,<br />      &quot;          console.error(&#39;Failed fetching Forge manifest&#39;);&quot;,<br />      &#39;        }&#39;,<br />      &#39;&#39;,<br />      &#39;      });&#39;,<br />      &#39;    &lt;/script&gt;&#39;,<br />      &#39;  &lt;/head&gt;&#39;,<br />      &#39;  &lt;body&gt;&#39;,<br />      &#39;    &lt;div id=&quot;viewer3d&quot;&gt;&lt;/div&gt;&#39;,<br />      &#39;  &lt;/body&gt;&#39;,<br />      &#39;&lt;/html&gt;&#39;<br />    ].join(&#39;\n&#39;);</strong></span><strong style="color: #0000ff; font-family: Georgia;"><br /></strong><span style="color: #0000ff;"><strong>    res.write(data);</strong></span><br /><span style="color: #0000ff;"><strong>    res.end();</strong></span><br /><span style="color: #0000ff;"><strong>  });</strong></span><br /><span style="color: #0000ff;"><strong>}</strong></span><br /><br />/**<br /> * Create an access token and run the API calls.<br /> */<br />oAuth2TwoLegged.authenticate().then(function(credentials){<br /><br />  console.log(&quot;**** Got Credentials&quot;,credentials);<br /><br />  createBucketIfNotExist(BUCKET_KEY).then(<br /><br />    function(createBucketRes){<br />      console.log(&quot;**** Create bucket if not exist response:&quot;, createBucketRes.body);<br /><br />      getBuckets().then(function(getBucketsRes){<br />        console.log(&quot;**** Get all buckets response:&quot;);<br />        var bucketsArray = getBucketsRes.body.items;<br />        bucketsArray.map(function(currentBucket){<br />          console.log(currentBucket.bucketKey);<br />        })<br />      },function(err){<br />        console.error(err);<br />      });<br /><br />      uploadFile(BUCKET_KEY, FILE_PATH, FILE_NAME).then(function(uploadRes){<br />        console.log(&quot;**** Upload file response:&quot;, uploadRes.body);<strong><br /><br /></strong>        deleteFile(BUCKET_KEY, FILE_NAME).then(function(deleteRes) {<br />          console.log(&quot;**** Delete file response status code:&quot;, deleteRes.statusCode);<br />        },defaultHandleError);<br /><br />        var objectId = uploadRes.body.objectId;<br />        console.log(&quot;objectId:&quot;, objectId);<br />        var urn = base64encode(objectId);<br />        console.log(&quot;urn:&quot;, urn);<br /><br />        translateFile(urn).then(function(translateRes){<br /> <br />          manifestFile(urn).then(function(){<br />            console.log(&quot;**** Your File is ready for viewing&quot;); <br />            <span style="color: #0000ff;"><strong>showViewer(credentials,urn);</strong></span><br />          }, defaultHandleError) <br /><br />        }, defaultHandleError);<br /><br />      }, defaultHandleError);<br /><br />    }, defaultHandleError);<br /><br />}, defaultHandleError);</pre>
<p>これで実装は終了です。前回と同様に Node.js command prompt から dmSample.js を指定すると、一連の処理が始まります。**** Your File is ready for viewing のメッセージが表示されたら、Web ブラウザを起動して localhost:3000 を URL 欄に入力してください。変換されたデザイン ファイルが表示されるはずです。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb099d02d9970d-pi" style="display: inline;"><img alt="Localhost" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb099d02d9970d image-full img-responsive" src="/assets/image_749825.jpg" title="Localhost" /></a></p>
<p>あまり美しい実装ではありませんが、Web ブラウザからリクエストによって、Node.js のローカル環境で動的に <strong><a href="https://adndevblog.typepad.com/files/viewer.htm">Viewer.htm </a></strong> 相当の内容をレンダリングするものです。<strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part2.html" rel="noopener noreferrer" target="_blank">Forge Node.js クイックスタート ～&#0160;</a><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part2.html" rel="noopener noreferrer" target="_blank">その 2</a>&#0160;</strong> で URL パラメータとして渡していた Access Token と ドキュメント ID を、直接代入文として生成しています。</p>
<p>Web ページの生成は、showViewer() 関数内の server.on() で定義したコールバック関数が担当しています。このような処理は、ここまでのクイックスタートの実装を拡張することを前提としているので、あくまでテスト用です。実用向きではありませんので、その点はご注意ください。</p>
<p>By Toshiaki Isezaki</p>
