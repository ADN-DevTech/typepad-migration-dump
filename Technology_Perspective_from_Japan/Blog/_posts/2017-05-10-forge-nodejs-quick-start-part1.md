---
layout: "post"
title: "Forge Node.js クイックスタート ～ その1"
date: "2017-05-10 00:23:25"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part1.html "
typepad_basename: "forge-nodejs-quick-start-part1"
typepad_status: "Publish"
---

<p><span style="background-color: #ffff00;">&lt;本記事は2019年12月10日に Forge SDK 更新にあわせて一部改定しています。&gt;</span></p>
<p><a href="https://forge.autodesk.com/" rel="noopener noreferrer" target="_blank"><strong>Forge ポータル（https://forge.autodesk.com/）</strong></a>の <span style="font-family: tahoma, arial, helvetica, sans-serif;"><a class=" adskf__footer-menu-item" href="https://forge.autodesk.com/code-samples" rel="noopener" target="_blank">Code Samples</a></span> から入手可能な Forge SDK があります。サンプルとして主要な開発環境/フレームワーク別に手早く開発環境を構築する手助けとなる Quickstarts コンテンツを入手することが可能です。<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d27911d4970c-pi" rel="noopener noreferrer" style="float: right;" target="_blank" title="https://developer.autodesk.com/en/docs/quickstarts/v1/nodejs/"><img alt="Nodejs_quickstarts" class="asset  asset-image at-xid-6a0167607c2431970b01b8d27911d4970c img-responsive" src="/assets/image_546923.jpg" style="width: 200px; margin: 0px 0px 5px 5px;" title="Nodejs_quickstarts" /></a>今回は、Forge サンプルで多用されている Node,js の Quickstarts の内容を日本語化してご紹介したいと思います。</p>
<p>使用する Forge SDK は&#0160;<strong><a href="https://github.com/Autodesk-Forge/forge-api-nodejs-client" rel="noopener noreferrer" target="_blank">forge-api-nodejs-client</a></strong>&#0160;で、Authentication API(OAuth API）、Data Management API、Model Derivative API、Design Automation API をまとめて 1 つにまとめた Node.js パッケージ（ミドルウェア）で、クイックスタートでは、この SDK を利用して次の処理をサーバー側に実装しています。</p>
<ol>
<li>2-legged 認証による Access Token の取得</li>
<li>Bucket の作成</li>
<li>Bucket へのファイル アップロード</li>
<li>Bucket の一覧表示</li>
<li>アップロードしたファイルの削除</li>
</ol>
<p>残念ながら、Model Derivative API によるデザイン ファイルの変換や Forge Viewer への表示処理は実装されませんが、後日、本記事の内容に追記するかたちで別の機会にご紹介します。なお、Quickstarts も GitHub からソースコードをクローンしていくため、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/01/development-environment-for-forge.html" rel="noopener noreferrer" target="_blank">Forge の開発環境</a></strong>&#0160;でご案内している環境がセットアップされていることを前提とします。</p>
<hr />
<ol>
<li><strong>コマンド プロンプト&#0160;</strong>を起動後、CD コマンドでカレント フォルダをドキュメント ディレクトリ（C:\Users\&lt;Windowsログインユーザ名&gt;\Documents）に移動してから、git clone コマンドで確認した&#0160;URL をパラメータに指定して、<strong><a href="https://github.com/yochiyochirb/meetups/wiki/clone-a-repository" rel="noopener noreferrer" target="_blank">リポジトリ</a>&#0160;</strong>の内容をクライアント コンピュータにコピーします。<strong>git clone https://github.com/Autodesk-Forge/forge-api-nodejs-client.git</strong>&#0160;と入力してください。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d2e589de970c-pi" style="display: inline;"><img alt="Command_prompt" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d2e589de970c image-full img-responsive" src="/assets/image_442304.jpg" title="Command_prompt" /></a></li>
<li>コピーされたリポジトリが、<strong>C:\Users\&lt;<em>Windows ユーザ名</em>&gt;\Documents</strong>&#0160;フォルダ直下の<strong> forge-api-nodejs-client フォルダ</strong>配下にコピーされていることを確認してください。確認後、CD コマンドでカレント フォルダを&#0160;forge-api-nodejs-client フォルダに移動します。</li>
<li>続いて、コピーした Forge SDK が内包するサンプル コードが利用する Node Package を、npm コマンド（Node Package Manager）を使ってインストールしていきます。Node.js command prompt を起動後に <strong>forge-api-nodejs-client&#0160;</strong>にディレクトリに移動したら、<strong>npm install</strong> と入力してください。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d2e58a1f970c-pi" style="display: inline;"><img alt="Npm_install" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d2e58a1f970c image-full img-responsive" src="/assets/image_123417.jpg" title="Npm_install" /></a><strong><br /></strong></li>
<li><strong><a href="https://forge.autodesk.com/" rel="noopener noreferrer" target="_blank">Forge ポータル</a></strong>&#0160;でアプリを登録して、Client ID（Consumer Key）と Client Secret（Conumer Secret）を取得してください。アプリの登録方法については、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/07/app-registration-and-getting-keys-for-forge-api.html" rel="noopener noreferrer" target="_blank">Forge API を利用するアプリの登録とキーの取得</a>&#0160;</strong>のブログ記事でご紹介しています。</li>
<li><strong>forge-api-nodejs-client </strong>フォルダ直下にある <strong>samples</strong> フォルダにあるサンプル ファイル&#0160;<strong>dmSample.js</strong> を Adobe Brackets ないし、他のテキスト エディタで開きます。</li>
<li>dmSample.js ファイル内のから下記で示す変数代入箇所を見つけて、それぞれ右辺にある&#0160;<strong>&#39;&#39;</strong> 内に適切な値を挿入してください。
<ul>
<li><strong>FORGE_CLIENT_ID </strong>の右辺にある&#0160;<strong>&#39;&#39;</strong> 内に 4. で取得した Client ID 値と、<strong>FORGE_CLIENT_SECRET</strong>&#0160;の右辺にある&#0160;<strong>&#39; &#39;</strong> 内に同じく Client Secret 値を代入します。</li>
<li>必要に応じて&#0160;<strong>BUCKET_KEY</strong> に一意な Bucket 名を指定します。既定では、&#39;forge_sample_&#39; + FORGE_CLIENT_ID.toLowerCase() になっているため、この状態でも一意な Bucket 名が生成されることになります。</li>
<li><strong>FILE_NAME</strong>&#0160;にアップロードするデザイン ファイルのファイル名を拡張子付きで指定してください。（例：Chair.f3d）</li>
<li><strong>FILE_PATH</strong> &#0160;にアップロードするデザイン ファイルのローカル コンピュータ上のパスをフルパスで指定してください。（例：C:/Users/iseza/Desktop/Chair.f3d）<br />
<pre>var fs = require(&#39;fs&#39;);<br /><br />var ForgeSDK = require(&#39;./../src/index&#39;);<br /><br />// TODO - insert your CLIENT_ID and CLIENT_SECRET<br />var <span style="color: #0000ff;"><strong>FORGE_</strong><strong>CLIENT_ID = &#39;&#39;</strong></span>,<br />    <span style="color: #0000ff;"><strong>FORGE_</strong></span><span style="color: #0000ff;"><strong>CLIENT_SECRET = &#39;&#39;</strong></span>;<br /><br />// TODO - Choose a bucket key - a unique name to assign to a bucket. It must be globally unique across all applications and<br />// regions, otherwise the call will fail. Possible values: -_.a-z0-9 (between 3-128 characters in<br />// length). Note that you cannot change a bucket key.<br /><strong><span style="color: #0000ff;">var BUCKET_KEY = &#39;forge_sample_&#39; + FORGE_CLIENT_ID.toLowerCase()</span>;</strong><br /><br />// TODO - Choose a filename - a key for the uploaded object<br /><span style="color: #0000ff;"><strong>var FILE_NAME = &#39;my-file.extension&#39;;</strong></span><br /><br />// TODO - specify the full filename and path<br /><span style="color: #0000ff;"><strong>var FILE_PATH = &#39;/path/to/your/file.extension&#39;;</strong></span><br /><br />var bucketsApi = new ForgeSDK.BucketsApi(), // Buckets Client<br />    objectsApi = new ForgeSDK.ObjectsApi(); // Objects Client<br /><br />// Initialize the 2-legged oauth2 client<br />var oAuth2TwoLegged = new ForgeSDK.AuthClientTwoLegged(FORGE_CLIENT_ID, FORGE_CLIENT_SECRET,<br /> [&#39;data:write&#39;, &#39;data:read&#39;, &#39;bucket:read&#39;,&#39;bucket:update&#39;,&#39;bucket:create&#39;], true);<br />&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;:</pre>
</li>
</ul>
</li>
<li>Node.js command prompt を使ってカレント ディレクトリを <strong>samples</strong> に変更後、<strong>node dmSample.js</strong>&#0160;と入力して処理を実行します。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d2e58a8d970c-pi" style="display: inline;"><img alt="Node_dmsample" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d2e58a8d970c image-full img-responsive" src="/assets/image_591560.jpg" title="Node_dmsample" /></a></li>
</ol>
<hr />
<p>ここまでの内容が <strong><a href="https://developer.autodesk.com/en/docs/quickstarts/v1/nodejs/" rel="noopener noreferrer" target="_blank">Forge Node.js Quickstart</a></strong>&#0160;に記載されている処理です。前述のとおり、このサンプルは Forge SDK を利用しているので直接 Authentication API（OAuth API）や Data Management API の endpoint を明示的に呼び出すことはしていません。その代わり、 次の代入文で、それぞれの endpoint 呼び出しをラップする Forge SDK を参照して利用しています。</p>
<pre>var bucketsApi = new ForgeSDK.BucketsApi(), // Buckets Client<br />    objectsApi = new ForgeSDK.ObjectsApi(); // Objects Client</pre>
<p>例えば、Bucket の作成には上記で代入した bucketsApi オブジェクトの Forge SDK 内に定義された <strong><a href="https://github.com/Autodesk-Forge/forge-api-nodejs-client/blob/master/docs/BucketsApi.md#createBucket" rel="noopener noreferrer" target="_blank">createBucket</a></strong>&#0160;endpoint を呼び出しています。 もちろん、この endpoint は Data Management API の <strong><a href="https://developer.autodesk.com/en/docs/data/v2/reference/http/buckets-POST/" rel="noopener noreferrer" target="_blank">https://developer.api.autodesk.com/oss/v2/buckets endpoint</a></strong><span class="break-word">&#0160;をラップしています。このような運用で Forge の RESTful API を Node.js で構築した Web サーバー側で実行出来る点に注意してください。クライアント コンピュータ上の Web ブラウザ内で実行される JavaScript コードからは、独自に作成した endpoint を介して Web サーバー側の処理を呼び出すよう工夫すれば、ある程度処理を隠蔽することが出来ます。</span></p>
<p>なお、実際に処理されるメイン ルーチンは dbSample.js の最後にある Promise Pattern と呼ばれる非同期処理になっています。</p>
<pre>/**<br /> * Create an access token and run the API calls.<br /> */<br />oAuth2TwoLegged.authenticate().then(function(credentials){<br /><br />  console.log(&quot;**** Got Credentials&quot;,credentials);<br /><br />  createBucketIfNotExist(BUCKET_KEY).then(<br /><br />    function(createBucketRes){<br />      console.log(&quot;**** Create bucket if not exist response:&quot;, createBucketRes.body);<br /><br />      getBuckets().then(function(getBucketsRes){<br />        console.log(&quot;**** Get all buckets response:&quot;);<br />        var bucketsArray = getBucketsRes.body.items;<br />        bucketsArray.map(function(currentBucket){<br />          console.log(currentBucket.bucketKey);<br />        })<br />      },function(err){<br />        console.error(err);<br />      });<br /><br />      uploadFile(BUCKET_KEY, FILE_PATH, FILE_NAME).then(function(uploadRes){<br />        console.log(&quot;**** Upload file response:&quot;, uploadRes.body);<br /><br />        deleteFile(BUCKET_KEY, FILE_NAME).then(function(deleteRes) {<br />          console.log(&quot;**** Delete file response status code:&quot;, deleteRes.statusCode);<br />        },defaultHandleError);<br /><br />      }, defaultHandleError);<br /><br />    }, defaultHandleError);<br /><br />}, defaultHandleError);</pre>
<p>ただ、Access Token を取得して Bucket を作成、指定したデザイン ファイルをアップロードした後にそのファイルを削除しているので、サンプルとしては若干不完全です。<strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part2.html" rel="noopener noreferrer" target="_blank">次回</a></strong>、アップロードしたデザインファイルを Model Derivative API で変換して、Forge Viewer に表示する部分を追記していきたいと思います。</p>
<p><strong>補足：</strong></p>
<ul style="list-style-type: circle;">
<li>dmSample.js 内に定義した uploadFile() 関数は、本 Forge SDK の&#0160;&#0160;ObjectsApi に定義される&#0160;uploadObject endpoint を利用してデザイン ファイルをアップロードしています。アップロードするファイル サイズが大きいと、ESOCKETTIMEDOUT エラー（タイムアウト）で処理が中断してしまう場合があります。そのような場合は、Forge SDK が内部で HTTP 通信に利用する request パッケージの既定のタイムアウト値を大きな値に変更してみてください。<br />Adobe Brackets などのテキスト エディタで&#0160;forge-api-nodejs-client\src\ApiClient.js ファイルを開いて、下記の青字部分の this.timeout の値を既定値の 60000 ミリ秒（1 分）から 120000 ミリ秒（2 分）などに変更してみてください。<br />
<pre>/**<br /> * Forge SDK<br /> * The Forge Platform contains an expanding collection of web service components that can be used with Autodesk cloud-based products or your own technologies. Take advantage of Autodesk’s expertise in design and engineering.<br /> *<br /> * OpenAPI spec version: 0.1.0<br /> * Contact: forge.help@autodesk.com<br /> *<br /> * NOTE: This class is auto generated by the swagger code generator program.<br /> * https://github.com/swagger-api/swagger-codegen.git<br /> * Do not edit the class manually.<br /> *<br /> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);<br /> * you may not use this file except in compliance with the License.<br /> * You may obtain a copy of the License at<br /> *<br /> * http://www.apache.org/licenses/LICENSE-2.0<br /> *<br /> * Unless required by applicable law or agreed to in writing, software<br /> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,<br /> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br /> * See the License for the specific language governing permissions and<br /> * limitations under the License.<br /> */<br /><br />module.exports = (function() {<br /> &#39;use strict&#39;;<br /><br /> var request = require(&#39;request&#39;);<br /><br /> /**<br /> * @module ApiClient<br /> * @version 0.3.0<br /> */<br /><br /> /**<br /> * Manages low level client-server communications, parameter marshalling, etc. There should not be any need for an<br /> * application to use this class directly - the *Api and model classes provide the public API for the service. The<br /> * contents of this file should be regarded as internal but are documented for completeness.<br /> * @alias module:ApiClient<br /> * @class<br /> */<br /> var exports = function() {<br /> /**<br /> * The base URL against which to resolve every API call&#39;s (relative) path.<br /> * @type {String}<br /> * @default https://developer.api.autodesk.com<br /> */<br /> this.basePath = &#39;https://developer.api.autodesk.com&#39;.replace(/\/+$/, &#39;&#39;);<br /> /**<br /> * The default HTTP headers to be included for all API calls.<br /> * @type {Array.&lt;String&gt;}<br /> * @default {}<br /> */<br /> this.defaultHeaders = {};<br /><br /> /**<br /> * The default HTTP timeout for all API calls.<br /> * @type {Number}<br /> * @default 60000<br /> */<br /> <span style="color: #0000ff;"><strong>this.timeout = 60000;</strong></span><br /><br /> this.basePath = &#39;https://developer.api.autodesk.com&#39;;<br /> };</pre>
</li>
</ul>
<p>&#0160;By Toshiaki Isezaki</p>
