---
layout: "post"
title: "Design Automation API サンプル"
date: "2022-08-17 00:41:01"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2022/08/design-automation-api-sample.html "
typepad_basename: "design-automation-api-sample"
typepad_status: "Publish"
---

<p>Forge の学習サイト、<strong><a href="http://learnforge.autodesk.io/" rel="noopener" target="_blank">Learn Autodesk Forge</a></strong> には、Design Automation API の各コアエンジン（AutoCAD、Revit、Inventor、3ds Max）を説明する<a href="https://learnforge.autodesk.io/#/tutorials/modifymodels" rel="noopener" target="_blank"> Modify your models</a> があります。手順に沿って実装していくことが出来ますが、GitHub リポジトリにも、ほぼ同じサンプルが記載されています。<a href="https://github.com/Autodesk-Forge/learn.forge.designautomation/tree/nodejs" rel="noopener" target="_blank"><strong>learn.forge.designautomation</strong></a> サンプルです。ここでは、このサンプルをローカル Node.js 開発環境にクローンし、セットアップ、テストしていく手順をご案内します。</p>
<p>リポジトリの内容をローカルでテストするには、事前に Git for Windows や Node.js をセットアップしておく必要があります。また、実行時には Forge で利用する Client ID と Client Secret（Consumer Key と Consumer Secret）を事前に&#0160;<strong><a href="https://forge.autodesk.com/" rel="noopener noreferrer" target="_blank">Forge ポータル</a></strong>&#0160;から取得しておく必要があります。これらの手順は、それぞれ、次のブログ記事でご案内しています。</p>
<p style="padding-left: 40px;"><strong><a href="https://adndevblog.typepad.com/technology_perspective/2017/01/development-environment-for-forge.html" rel="noopener noreferrer" target="_blank">Forge の開発環境</a></strong></p>
<p style="padding-left: 40px;"><strong><a href="https://adndevblog.typepad.com/technology_perspective/2016/07/app-registration-and-getting-keys-for-forge-api.html" rel="noopener noreferrer" target="_blank">Forge API を利用するアプリの登録とキーの取得</a></strong></p>
<p>Client ID と Client Secret の取得時には、作成するアプリに Design Automation API&#0160; と Data Management API を指定するようにしてください。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed13e4c200d-pi" style="display: inline;"><img alt="App_settings" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed13e4c200d image-full img-responsive" src="/assets/image_589756.jpg" title="App_settings" /></a></p>
<hr />
<ol>
<li>Web ブラウザで GitHub 上の <a href="https://github.com/Autodesk-Forge/learn.forge.designautomation/tree/nodejs" rel="noopener" target="_blank"><strong>learn.forge.designautomation</strong></a> リポジトリ ページを開きます。</li>
<li>画面右側の [Clone or download] ボタンをクリックして、表示される URL <strong>https://github.com/Autodesk-Forge/learn.forge.designautomation.git&#0160;</strong>を<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89" rel="noopener noreferrer" target="_blank">クリップボード</a>にコピーしておきます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a30d4890ca200b-pi" style="display: inline;"><img alt="Copy_url" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a30d4890ca200b image-full img-responsive" src="/assets/image_888833.jpg" title="Copy_url" /></a></li>
<li>GitHub 上のプロジェクトを 、リポジトリから開発に使用するローカル コンピュータにコピーします。コマンド プロンプトを起動して、リポジトリ内容をコピーしたいフォルダ（ディレクトリ）に CD コマンドで移動し、<strong>git clone -b nodejs https://github.com/Autodesk-Forge/learn.forge.designautomation.git</strong>（クリップボード内の URL）と入力します。例えば、C:\repo フォルダに移動して <strong>git clone -b nodejs https://github.com/Autodesk-Forge/learn.forge.designautomation.git</strong> を実行すると、C:\repo フォルダ下に&#0160; learn.forge.designautomation フォルダが作成され、GitHub リポジトリからプロジェクト一式がコピーされます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a308db2a16200c-pi" style="display: inline;"><img alt="Clone_repo" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a308db2a16200c image-full img-responsive" src="/assets/image_314218.jpg" title="Clone_repo" /></a></li>
<li>クローン（コピー）されたプロジェクトに Node.js の実行で必要となるパッケージ（ミドルウェア）をインストールします。CD コマンドで現在のフォルダを learn.forge.designautomation フォルダへ移動してから、<strong>npm install</strong>&#0160;と入力します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a30d48915e200b-pi" style="display: inline;"><img alt="Npm_install" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a30d48915e200b image-full img-responsive" src="/assets/image_876618.jpg" title="Npm_install" /></a></li>
<li>この Design Automation API サンプルでは、ジョブ（WorkItem）の終了通知を得るために <a href="https://forge.autodesk.com/en/docs/design-automation/v3/developers_guide/callbacks/#oncomplete-callback" rel="noopener" target="_blank"><strong>OnComplete コールバック URL</strong></a> を利用します。ただ、ローカル環境では、URL が外部から認識されないため、<a href="https://adndevblog.typepad.com/technology_perspective/2018/12/local-development-environment-for-forge-webhooks-api.html" rel="noopener" target="_blank"><strong>ngrook ツール</strong></a> を利用してローカル ⇔ パブリックの橋渡し（トンネル化）効果を利用する必要があります。コマンドプロンプトを起動して ngrok のあるパスに移動したら、<strong>ngrok http 3000</strong>&#0160;を実行します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a30d48ccda200b-pi" style="display: inline;"><img alt="Ngrok" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a30d48ccda200b image-full img-responsive" src="/assets/image_417007.jpg" title="Ngrok" /></a><br />上記の例では、<strong>http://localhost:3000</strong> が <strong>https://f44f-115-162-81-167.jp.ngrok.io&#0160;</strong>に置き換えられて外部から通知を得られるようになります。この処理は ngrok の実行中のみ有効です。また、置き換えられる URL は ngrok の実行毎に変化してしまうので、サンプルの評価中は実行を停止しないよう注意してください。なお、<span style="background-color: #ffff00;">ngrok のセッション有効期限が起動後 2 時間です。<br /><span style="background-color: #ffffff;"><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed16e73200d-pi" style="display: inline; background-color: #ffffff;"><img alt="Ngrok_expiration" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed16e73200d image-full img-responsive" src="/assets/image_651709.jpg" title="Ngrok_expiration" /></a></span><br /></span></li>
<li>このサンプルでは、実行時にシステム環境変数から Client ID と Client Secret、CallBack URL を取得します。コマンド プロンプト上で SET コマンドをシステム環境変数、FORGE_CLIENT_ID、FORGE_CLIENT_SECRET、FORGE_WEBHOOK_URL 環境変数を、それぞれ設定します。クリップボードとメモ帳などを利用してコピー＆ペーストしながら SET コマンドを実行してください。&lt;&lt;YOUR NGROK URL&gt;&gt; は、上記 5. で得られた URL を指します。<br />
<pre class="notranslate"><code>set FORGE_CLIENT_ID=&lt;&lt;YOUR CLIENT ID FROM DEVELOPER PORTAL&gt;&gt;
set FORGE_CLIENT_SECRET=&lt;&lt;YOUR CLIENT SECRET&gt;&gt;
set FORGE_WEBHOOK_URL=&lt;&lt;YOUR NGROK URL&gt;&gt;</code></pre>
<a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a30d48cd46200b-pi" style="display: inline;"><img alt="System_environment_values" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a30d48cd46200b image-full img-responsive" src="/assets/image_28596.jpg" title="System_environment_values" /></a></li>
<li>ここまでの手順で実行の準備は完了です。カレント フォルダが learn.forge.designautomation フォルダであることを確認したら、<strong>npm start</strong>&#0160;と入力、リターンキーを押して Node.js サーバーを起動します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a308db2be5200c-pi" style="display: inline;"><img alt="Npm_start" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a308db2be5200c image-full img-responsive" src="/assets/image_896739.jpg" title="Npm_start" /></a></li>
<li>Web ブラウザを起動して、URL の&#0160;<strong>localhost:3000</strong> と入力してリターンすると、次のページが表示されるはずです。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed130e2200d-pi" style="display: inline;"><img alt="App_main" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed130e2200d image-full img-responsive" src="/assets/image_988622.jpg" title="App_main" /></a></li>
<li>ページ右上の「Configure」リンクをクリックして AppBundle と Activity を登録します。ここでは、Design Automation API for AutoCAD コアエンジンを使って、DWG ファイルの内容を書き換える WorkItem を実行することにします。<br />次のページが表示されたら、「Select a local AppBundle:」にクローンしたリポジトリに含まれる AppBundle 名（ここでは C:\repo\learn.forge.designautomation\bundles フォルダ）が 4 つ表示されるので、AutoCAD アドインを含むバンドル パッケージである「<strong>UpdateDWGParam</strong>」を選択します。<br />この UpdateDWGParam.zip には、AutoCAD 2020 用の .NET アドインが含まるので、「Select engine:」には対応するコアエンジン名である「<strong>Autodesk.AutoCAD+23_1</strong>」を選択します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed1b7b4200d-pi" style="display: inline;"><img alt="Appbundle" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed1b7b4200d image-full img-responsive" src="/assets/image_122340.jpg" title="Appbundle" /></a></li>
<li>「Select a local AppBundle:」と「Select engine:」を選択したら、ページ右下の [Create/Update] ボタンをクリックすると、AppBundle をアップロードされて登録、同時に Activity も登録されます。登録が正常に終了すると、ページ左下の「Existing activities」に「<strong>UpdateDWGParamActivity+dev</strong>」が表示されるようになります。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a30d491643200b-pi" style="display: inline;"><img alt="Register_appbundle" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a30d491643200b image-full img-responsive" src="/assets/image_165783.jpg" title="Register_appbundle" /></a></li>
<li>learn.forge.designautomation サンプルには、編集対象とするデザイン ファイルも提供されています。ここでは、インチ単位の Width （幅）と Height（高さ）パラメータを持つダイナミックブロックを含む <strong>autocad_sample_file.dwg</strong> を編集対象とします。ローカル リポジトリ内の sample files フォルダ（ここでは C:\repo\learn.forge.designautomation\sample files フォルダ）に <strong>autocad_sample_file.dwg</strong> があることを確認してください。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a308db315a200c-pi" style="display: inline;"><img alt="Sample_files" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a308db315a200c image-full img-responsive" src="/assets/image_367855.jpg" title="Sample_files" /></a></li>
<li>アプリ ページの「Width:」と「Height:」に適当な値を入力して、「Input file」の [ファイルの選択] ボタンで <strong>autocad_sample_file.dwg</strong> を選択したら、「<strong>UpdateDWGParamActivity+dev</strong>」Activity が選択されていることを確認して [Start workitem] ボタンをクリックしてください。<br />ページ上にログデータが表示されて、WorkItem が正常終了すると、ログ メッセージ下部の &quot;status&quot; 値に ”success” と表示されます。&quot;reportUrl&quot; 値に記された長めの URL をブラウザで開けば、ログファイルをダウンロードすることも出来ます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a30d48ccfe200b-pi" style="display: inline;"><img alt="Success" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a30d48ccfe200b image-full img-responsive" src="/assets/image_532371.jpg" title="Success" /></a><br />ngtok を起動したコマンド プロンプトには、OnComplete コールバック URL が呼び出されたことが表示されます。（ここでは <strong>https://f44f-115-162-81-167.jp.ngrok.io/api/forge/callback/designautomation</strong>）<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed139e1200d-pi" style="display: inline;"><img alt="Oncomplete_on_ngrok" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed139e1200d image-full img-responsive" src="/assets/image_22233.jpg" title="Oncomplete_on_ngrok" /></a></li>
<li>&#0160;&quot;status&quot; 値が ”success” で WorkItem が終了している場合、ログを上部にスクロールすると。ハイパーリンクが埋め込まれた「Download result file here」が表示されます。このリンクをクリックすると、WorkItem が処理した成果ファイルをダウンロードすることが出来ます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed16e9a200d-pi" style="display: inline;"><img alt="Result_download" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed16e9a200d image-full img-responsive" src="/assets/image_25560.jpg" title="Result_download" /></a><br />あとは、ダウンロードした DWG ファイルを AutoCAD、または、AutoCAD LT で開けば、処理された内容を確認することが出来ます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a308db3606200c-pi" style="display: inline;"><img alt="Check_on_autocad" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a308db3606200c image-full img-responsive" src="/assets/image_386211.jpg" title="Check_on_autocad" /></a></li>
<li>（オプション） learn.forge.designautomation サンプルは WorkItem が処理した成果ファイルを Forge Viewer に表示する機能は実装されていません。ただし、新たなコード実装なしに成果ファイルをチェックする方法もあります。
<ol>
<li>learn.forge.designautomation サンプルで使った Client ID と Client Secret で VS Code <strong><a href="https://adndevblog.typepad.com/technology_perspective/2020/06/forge-development-using-vs-code.html" rel="noopener" target="_blank">Forge エクステンション</a> </strong>を利用すると、 <strong>&lt;&lt;Client ID&gt;&gt;-designautomation</strong> の名前で Bucket が作成されていることがわかります。<br />Bucket 内の <strong>&lt;&lt;date_time&gt;&gt;_output_autocad_sample_file.dwg</strong>（例：20220816063911_output_autocad_sample_file.dwg）を右クリックして「Translate Object」から&#0160; Model Derivative API で変換すると、「Preview Derivative」で Forge Viewer 上で確認することが出来ます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed13b2a200d-pi" style="display: inline;"><img alt="Check_on_vs_code" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed13b2a200d image-full img-responsive" src="/assets/image_941608.jpg" title="Check_on_vs_code" /></a></li>
<li>同様に&#0160;<strong>&lt;&lt;Client ID&gt;&gt;-designautomation</strong> 名の Bucket に&#0160;<strong>&lt;&lt;date_time&gt;&gt;_output_autocad_sample_file.dwg&#0160;</strong>を見つけて右クリックすると、「Downoad Object」で成果ファイルをダウンロードすることも出来ます。</li>
</ol>
</li>
</ol>
<hr />
<p>ここでは AutoCAD コアエンジン（Design Automation API for AutoCAD）でリポジトリ内に用意された AppBundle を含むバンドル パッケージを使った内容をご紹介しましたが、Revit、Inventor、3ds Max のコアエンジンも評価することも出来ます。リポジトリ内の AppBundle を利用する場合、登録する AppBundle とエンジン、実行時に指定する Activity とサンプル デザイン ファイルの組み合わせは、次のとおりです。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a30d491249200b-pi" style="display: inline;"><img alt="Combinations" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a30d491249200b image-full img-responsive" src="/assets/image_390471.jpg" title="Combinations" /></a></p>
<p>※revit_sample_file.rvt はフィート/インチ単位であるため、パラメータ値はフィートでお試しください。（例：Width: 5、Height: 3）<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02a2eed17165200d-pi" style="display: inline;"><img alt="Revit_result" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02a2eed17165200d image-full img-responsive" src="/assets/image_420394.jpg" title="Revit_result" /></a></p>
<p>By Toshiaki Isezaki</p>
