---
layout: "post"
title: "Forge SDK を使用した 3-legged OAuth Access Token 取得"
date: "2017-08-02 00:50:32"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2017/08/getting-3-legged-oauth-access-token-using-forge-sdk.html "
typepad_basename: "getting-3-legged-oauth-access-token-using-forge-sdk"
typepad_status: "Publish"
---

<p><strong><a href="https://developer.autodesk.com/" rel="noopener" target="_blank"> </a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d29b384a970c-pi" style="float: right;"><img alt="Icon - oAuthen" class="asset  asset-image at-xid-6a0167607c2431970b01b8d29b384a970c img-responsive" src="/assets/image_713119.jpg" style="margin: 0px 0px 5px 5px;" title="Icon - oAuthen" /></a><a href="https://forge.autodesk.com/" rel="noopener" target="_blank">Forge&#0160; ポータル </a></strong>の <strong><a href="https://forge.autodesk.com/code-samples" rel="noopener" target="_blank">Code Samples</a></strong> 記載されている <strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/01/forge-sdk.html" rel="noopener" target="_blank">Forge SDK</a></strong>&#0160;を利用すると、3-legged OAuth を利用した Access Token を簡単に取得することが出来ます。ここで取得した Access Token を Data Management API の各種 endpoint を利用すれば、オートデスクのクラウド &#0160;サービスである A360（A360 Personal）、A360 Team、BIM 360 Team、Fusion Team、BIM 360 Docs のユーザ ストレージ領域にアクセスすることが可能になります。</p>
<p>今回は、Forge Platform API のうち、Authentication API(OAuth API）、Data Management API、Model Derivative API、Design Automation API をまとめて 1 つにまとめた Forge SDK である&#0160;<strong><a href="https://github.com/Autodesk-Forge/forge-api-nodejs-client" rel="noopener noreferrer" target="_blank">forge-api-nodejs-client</a></strong>&#0160;を使って、3-legged OAuth で Access Token を取得してみましょう。以前ご案内した <strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part1.html" rel="noopener" target="_blank">Forge Node.js クイックスタート </a></strong>と同じ方法をとっていきます。&#0160;</p>
<hr />
<ol>
<li>Forge の開発環境 でご案内した Git Shell コマンドでローカル環境に Forge SDK を組み込みます。GitHub 上の&#0160;<strong>forge-api-nodejs-client リポジトリ</strong>(<a href="https://github.com/Autodesk-Forge/forge-api-nodejs-client" rel="noopener" target="_blank">https://github.com/Autodesk-Forge/forge-api-nodejs-client</a>) にアクセスして、クローンに必要な URL をクリップボードにコピーします。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d29b012b970c-pi" style="display: inline;"><img alt="Git_repository_url" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d29b012b970c image-full img-responsive" src="/assets/image_171283.jpg" title="Git_repository_url" /></a></li>
<li>Git Shell（ないしは Node.js command prompt、または、コマンド プロンプト）を起動したら、C:\Users\<em>&lt;user name&gt;</em>\Documents\GitHub フォルダに移動して、<strong>git clone&#0160;https://github.com/Autodesk-Forge/forge-api-nodejs-client.git</strong> と入力してクローン処理を実行します。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c910b49b970b-pi" style="display: inline;"><img alt="Git-clone" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c910b49b970b image-full img-responsive" src="/assets/image_365402.jpg" title="Git-clone" /></a></li>
<li>forge-api-nodejs-client の実行に必要な Node パッケージ（ミドルウェア）をインストールします。C:\Users\<em>&lt;user name&gt;</em>\Documents\GitHub フォルダ下に作成された&#0160;C:\Users\<em>&lt;user name&gt;</em>\Documents\GitHub フォルダに cd コマンドで移動したら、<strong>npm install</strong> と入力してインストールします。package.json ファイルの内容が参照されて、Node パッケージのインストールが始まります。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d29b01bd970c-pi" style="display: inline;"><img alt="Npm_install" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d29b01bd970c image-full img-responsive" src="/assets/image_409773.jpg" title="Npm_install" /></a></li>
<li>今回は Web サーバーのルート処理実装するのに <strong><a href="https://www.npmjs.com/package/express" rel="noopener" target="_blank">express パッケージ</a>&#0160;</strong>を利用します。同様に、<strong>npm install express</strong> と入力して express パッケージをインストールします。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb09b3f06a970d-pi" style="display: inline;"><img alt="Npm_install_express" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb09b3f06a970d image-full img-responsive" src="/assets/image_691297.jpg" title="Npm_install_express" /></a></li>
<li>Adobe Brackets などのテキスト エディタを利用して新規にファイルを作成し、Samples フォルダの下に token.js の名前で保存します。<br />
<pre>var express = require(&quot;express&quot;);<br />var ForgeSDK = require(&#39;./../src/index&#39;);<br />var app = express();<br /><br />// TODO - insert your CLIENT_ID and CLIENT_SECRET<br />var CLIENT_ID = &#39;<span style="color: #0000ff;"><strong>&lt;Your Client ID&gt;</strong></span>&#39;,<br />    CLIENT_SECRET = &#39;<span style="color: #0000ff;"><strong>&lt;Your Client Secret&gt;</strong></span>&#39;;<br />var REDIRECT_URL = &#39;<span style="color: #0000ff;"><strong>&lt;Your Callback URL&gt;</strong></span>&#39;;<br /><br />/**<br />&#0160;* General error handling method<br />&#0160;* @param err<br />&#0160;*/<br />function defaultHandleError(err) {<br /> console.error(&#39;\x1b[31m Error:&#39;, err, &#39;\x1b[0m&#39; ) ;<br />}<br /><br />// Initialize the 3-legged oauth2 client<br />var autoRefresh = false;<br />var oAuth2ThreeLegged = new ForgeSDK.AuthClientThreeLegged(CLIENT_ID, CLIENT_SECRET, REDIRECT_URL, <strong><span style="color: #ff0000;">[&#39;data:write&#39;, &#39;data:read&#39;]</span></strong>, autoRefresh);<br /><br />// default page<br />app.get(&#39;/&#39;, function (req, res) {<br />&#0160; &#0160; var url = oAuth2ThreeLegged.generateAuthUrl();<br />&#0160; &#0160; res.redirect(url);<br />});<br /><br />// Get 3-legged access token<br />// callback from Forge Auth page<br />app.get(&#39;/callback&#39;, function (req, res) {<br />&#0160; &#0160; var code = req.query.code;<br />&#0160; &#0160; oAuth2ThreeLegged.getToken(code).then(function (credentials) {<br />&#0160; &#0160; &#0160; &#0160; console.log(&quot;**** Got Credentials&quot;,credentials);<br />&#0160; &#0160; &#0160; &#0160; res.header({&#39;Content-Type&#39;: &#39;text/html; charset=utf-8&#39;});<br />&#0160; &#0160; &#0160; &#0160; res.header({&#39;Access-Control-Allow-Origin&#39;: &#39;*&#39;});<br />&#0160; &#0160; &#0160; &#0160; res.send(JSON.stringify(credentials));<br />&#0160; &#0160; }, defaultHandleError);<br />});<br /><br />app.listen(3000);<br />console.log(&quot;Server is listening port 3000&quot;);</pre>
</li>
<li>作成した token.js 内にデベロッパ ポータルで作成したアプリの <span style="color: #111111;"><strong>Client ID</strong> と <strong>Client Secret</strong>、また、<strong>Callback URL</strong></span> を設定します。5. のコードで青字部分 <span style="color: #0000ff;"><strong>&lt;Your Client ID&gt;</strong></span>、<strong><span style="color: #0000ff;">&lt;Your Client Secret</span>&gt;</strong>、<span style="color: #0000ff;"><strong>&lt;Your Callback URL&gt;</strong></span>&#0160;をそれぞれ置き換えてください。デベロッパ ポータルのアプリの手順は、ブログ記事&#0160;<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/07/app-registration-and-getting-keys-for-forge-api.html" rel="noopener" target="_blank">Forge API を利用するアプリの登録とキーの取得</a></strong> でご紹介しています。必要に応じてご参照ください。<br />なお、ここではローカル環境を考慮して、アプリの CallBack URL を&#0160;<span style="color: #0000ff;"><strong>http://localhost:3000/callback</strong></span>&#0160;に設定しておく必要があります。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c910b754970b-pi" style="display: inline;"><img alt="App_settings" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c910b754970b image-full img-responsive" src="/assets/image_757702.jpg" title="App_settings" /></a></li>
<li>ここまでの手順で設定は完了しました。それでは、テストをしていきます。Git Shell（ないしは Node.js command prompt、または、コマンド プロンプト）上で cd コマンドを使って Samples フォルダに移動したら、<strong>node token.js</strong> と入力して Web サーバーを起動します。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c910b7a2970b-pi" style="display: inline;"><img alt="Run_node" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c910b7a2970b image-full img-responsive" src="/assets/image_238445.jpg" title="Run_node" /></a></li>
<li>Web ブラウザを起動したら、URL 欄に <strong>localhost:3000</strong> と入力します。</li>
<li>Autodesk ID の入力を求める画面に遷移するはずです。お手持ちの Autodesk ID を入力して [次へ] をクリックします。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d29b371e970c-pi" style="display: inline;"><img alt="Sign_in" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d29b371e970c image-full img-responsive" src="/assets/image_562673.jpg" title="Sign_in" /></a></li>
<li>9. で入力した Autodesk ID のパスワードを入力したら、[サインイン] をクリックしてください。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb09b425fd970d-pi" style="display: inline;"><img alt="Enter_password" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb09b425fd970d image-full img-responsive" src="/assets/image_768353.jpg" title="Enter_password" /></a></li>
<li>サインインしたユーザに対して、アプリがユーザ ストレージにアクセスしてもよいか認可を求める画面が表示されます。ここでは、[許可] をクリックしてください。なお、ここで一覧表示される権限は、5. で作成したコードの赤字部分で指定した <a href="https://developer.autodesk.com/en/docs/oauth/v2/overview/scopes/" rel="noopener" target="_blank"><strong>Scope</strong></a> の内容に対応します。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c910eb45970b-pi" style="display: inline;"><img alt="Authorize_access_right" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c910eb45970b image-full img-responsive" src="/assets/image_375474.jpg" title="Authorize_access_right" /></a></li>
<li>すべてが正しく処理されると Access Token を含んだ JSON レスポンスが返されます。JSON レスポンスは、Node を起動した Git Shell（ないしは Node.js command prompt、または、コマンド プロンプト）上と Web ブラウザ上に表示されるはずです。Web ブラウザでは、URL 欄が更新されて 6. で指定した CallBack URL が Authorization コードをパラメータにして呼び出されている点に注意してください。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d29b3779970c-pi" style="display: inline;"><img alt="Json_response" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d29b3779970c image-full img-responsive" src="/assets/image_988179.jpg" title="Json_response" /></a>&#0160;&#0160;</li>
</ol>
<hr />
<p>上記内容では Refresh Token の取得部分を割愛していますが、 3-legged 認証の具体的なシナリオをブログ記事&#0160;<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/08/oauth-authentication-scenario-on-forge.html" rel="noopener" target="_blank">Forge での OAuth 認証シナリオ</a></strong> でご案内していますので、前述の内容ともに再度ご確認いただくことをお勧めします。</p>
<p>&#0160;By Toshiaki Isezaki</p>
