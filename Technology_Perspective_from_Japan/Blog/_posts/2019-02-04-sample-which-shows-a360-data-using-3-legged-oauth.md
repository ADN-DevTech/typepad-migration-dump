---
layout: "post"
title: "3-Legged OAuth で A360 データを表示するサンプル"
date: "2019-02-04 00:11:12"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2019/02/sample-which-shows-a360-data-using-3-legged-oauth.html "
typepad_basename: "sample-which-shows-a360-data-using-3-legged-oauth"
typepad_status: "Publish"
---

<p>Forge を包括的に習得いただける Tutorial ページに、<strong><a href="http://learnforge.autodesk.io/" rel="noopener" target="_blank">Learn Autodesk Forge</a></strong>&#0160;があります。この中に、3-Legged OAuth を利用して A360 などのオートデスク ストレージにアクセスし、ストレージ内に保存されているデザイン データを表示する <strong><a data-pjax="#js-repo-pjax-container" href="https://github.com/Autodesk-Forge/learn.forge.viewhubmodels" rel="noopener" target="_blank">learn.forge.viewhubmodels</a> </strong>サンプルがあります。ちょうど、<strong><a href="https://adndevblog.typepad.com/technology_perspective/2016/12/understanding-steps-to-use-viewer-on-postman2.html" rel="noopener" target="_blank">Postman による Viewer 利用手順の理解 - 3 legged 認証</a></strong> に相当する内容を <strong><a href="https://adndevblog.typepad.com/technology_perspective/2017/01/forge-sdk.html" rel="noopener" target="_blank">Forge SDK</a></strong> を使ってトレースすることになります。ここでは、Windows で&#0160;<strong><a data-pjax="#js-repo-pjax-container" href="https://github.com/Autodesk-Forge/learn.forge.viewhubmodels" rel="noopener" target="_blank">learn.forge.viewhubmodels</a> </strong>サンプルをローカル Node.js 開発環境にクローンし、セットアップ、テストしていく手順をご案内します。</p>
<p>リポジトリの内容からローカルでテストするには、事前に Git for Windows や Node.js をセットアップしておく必要があります。また、実行時には Forge で利用する Client ID と Client Secret（Consumer Key と Consumer Secret）を事前に <strong><a href="https://forge.autodesk.com/" rel="noopener noreferrer" target="_blank">Forge ポータル</a></strong>&#0160;から取得しておく必要があります。これらの手順は、それぞれ、次のブログ記事でご案内しています。</p>
<p style="padding-left: 40px;"><strong><a href="https://adndevblog.typepad.com/technology_perspective/2017/01/development-environment-for-forge.html" rel="noopener noreferrer" target="_blank">Forge の開発環境</a></strong></p>
<p style="padding-left: 40px;"><strong><a href="https://adndevblog.typepad.com/technology_perspective/2016/07/app-registration-and-getting-keys-for-forge-api.html" rel="noopener noreferrer" target="_blank">Forge API を利用するアプリの登録とキーの取得</a></strong></p>
<p><strong><span style="background-color: #ffff00;">※</span></strong> このサンプルをローカル環境で実行するには、Forge ポータルでのアプリ作成時に、あらかじめ <strong>&#0160;CallBack URL</strong> に<strong> http://localhost:3000/api/forge/callback/oauth</strong> を設定しておく必要があります。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3971a2c200c-pi" style="display: inline;"><img alt="App_settings" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3971a2c200c image-full img-responsive" src="/assets/image_588169.jpg" title="App_settings" /></a></p>
<hr />
<ol>
<li>Web ブラウザで GitHub 上の <strong><a data-pjax="#js-repo-pjax-container" href="https://github.com/Autodesk-Forge/learn.forge.viewhubmodels" rel="noopener" target="_blank">learn.forge.viewhubmodels</a> </strong>リポジトリ ページを開きます。</li>
<li>画面右側の [Clone or download] ボタンをクリックして、表示される URL <strong>https://github.com/Autodesk-Forge/learn.forge.viewhubmodels.git</strong>&#0160;を<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89" rel="noopener noreferrer" target="_blank">クリップボード</a>にコピーしておきます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3dcc993200b-pi" style="display: inline;"><img alt="Copy_url" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3dcc993200b image-full img-responsive" src="/assets/image_932326.jpg" title="Copy_url" /></a></li>
<li>GitHub 上のプロジェクトを 、リポジトリから開発に使用するクライアント コンピュータにコピーします。コマンド プロンプトを起動して、リポジトリ内容をコピーしたいフォルダ（ディレクトリ）に CD コマンドで移動し、<strong>git clone -b nodejs https://github.com/Autodesk-Forge/learn.forge.viewhubmodels.git</strong>&#0160;（クリップボード内の URL）と入力します。例えば、C:\Users\&lt;Windows ログイン ユーザ名&gt;\Documents\GitHub フォルダに移動して <strong>git clone -b nodejs https://github.com/Autodesk-Forge/learn.forge.viewhubmodels.git</strong>&#0160;を実行すると、C:\Users\&lt;Windows ログイン ユーザ名&gt;\Documents\GitHub フォルダ下に&#0160; learn.forge.viewhubmodels フォルダが作成され、GitHub リポジトリからソースコードがコピーされます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3dccbcc200b-pi" style="display: inline;"><img alt="Clone_repositry" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3dccbcc200b image-full img-responsive" src="/assets/image_992687.jpg" title="Clone_repositry" /></a></li>
<li>クローン（コピー）されたプロジェクトに Node.js の実行で必要となるパッケージ（ミドルウェア）をインストールします。CD コマンドで現在のフォルダを learn.forge.viewhubmodels フォルダへ移動してから、<strong>npm install</strong>&#0160;と入力します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3dccc41200b-pi" style="display: inline;"><img alt="Npm_install" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3dccc41200b image-full img-responsive" src="/assets/image_270560.jpg" title="Npm_install" /></a><br /><br /></li>
<li>このサンプルでは、実行時にシステム環境変数から Client ID と Client Secret、CallBack URL を取得します。コマンド プロンプト上で SET コマンドを使って、環境変数を指定します。上記、<strong><span style="background-color: #ffff00;">※</span></strong> で作成したアプリから Client ID、Client Secret、CallBack URL を読み取り、それぞれ、システム環境変数、FORGE_CLIENT_ID、FORGE_CLIENT_SECRET、FORGE_CALLBACK_URL を設定します。クリップボードとメモ帳などを利用してコピー＆ペーストしながら SET コマンドを実行してみてください。<br />
<pre><code>set FORGE_CLIENT_ID=&lt;&lt;YOUR CLIENT ID FROM DEVELOPER PORTAL&gt;&gt;
set FORGE_CLIENT_SECRET=&lt;&lt;YOUR CLIENT SECRET&gt;&gt;
set FORGE_CALLBACK_URL=&lt;&lt;YOUR CALLBACK URL&gt;&gt;</code></pre>
<a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3bd2ad2200d-pi" style="display: inline;"><img alt="Set_system_environment_variables" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3bd2ad2200d image-full img-responsive" src="/assets/image_494386.jpg" title="Set_system_environment_variables" /></a></li>
<li>ここまでの手順で実行の準備は完了です。カレント フォルダが learn.forge.viewhubmodels フォルダであることを確認したら、<strong>npm start</strong> と入力、リターンキーを押して Node.js サーバーを起動します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3bd2b98200d-pi" style="display: inline;"><img alt="Npm_start" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3bd2b98200d image-full img-responsive" src="/assets/image_471362.jpg" title="Npm_start" /></a></li>
<li>Web ブラウザを起動して、URL の <strong>localhost:3000</strong> と入力してリターンすると、ページ左側に [Autodesk Sign In] ボタンが表示されるはずです。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3bd2c68200d-pi" style="display: inline;"><img alt="Localhost_3000" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3bd2c68200d image-full img-responsive" src="/assets/image_48458.jpg" title="Localhost_3000" /></a></li>
<li>[Autodesk Sign In] ボタンをクリックして、アクセスしたい A360 ストレージのオーナーの Autodesk ID（ユーザ名とパスワード）でサインインを試みます。このページを表示している Forge アプリは、本来。当該オーナーの A360 ストレージにはアクセス出来ないことに注意してください。このため、ユーザ名、パスワードを入力してサインインが完了すると、Forge アプリのストレージ アクセスを許可（認可）するか、サインインしたオーナーに確認するための画面を表示します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3dcda56200b-pi" style="display: inline;"><img alt="Authorize" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3dcda56200b image-full img-responsive" src="/assets/image_536597.jpg" title="Authorize" /></a><br />ここで表示されるアクセス権の種別（データ書き込みや表示など）は、Forge アプリが Access Token を取得する処理で指定した Scope の内容が反映されたものとなります。 [許可] をクリックすると、A360 ストレージ データのオーナーが Forge アプリにアクセス許可を与えることになります。</li>
<li>Hub &gt;&gt; Project &gt;&gt; Folder &gt;&gt; Item &gt;&gt; Version の順で当該 A360 のストレージ構造をナビゲートし、任意の Version をクリックすると、デザイン（モデル）が Viewer 領域に表示されます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3bd345b200d-pi" style="display: inline;"><img alt="Forge_app_run" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3bd345b200d image-full img-responsive" src="/assets/image_54577.jpg" title="Forge_app_run" /></a><br />もちろん、A360 内でナビゲートした内容と同じ構造で、同じデザイン バージョンを表示出来ているはずです。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3bd34ad200d-pi" style="display: inline;"><img alt="A360_appearance" border="0" class="asset  asset-image at-xid-6a0167607c2431970b022ad3bd34ad200d image-full img-responsive" src="/assets/image_4207.jpg" title="A360_appearance" /></a><br />A360 側で一度表示したデザイン データは、既に SVF 変換されていて、マニフェストを取得出来る点に注意してください。つまり、Forge アプリ側で Model Derivative API を使った明示的な SVF 変換は不要です。</li>
</ol>
<hr />
<p>BIM 360 Docs ストレージにも同様の 3-Legged OAuth を介して取得した Access Token を使って Data Management API でアクセスすることが出きます。ただし、そのような BIM 360 統合アプリには、事前に BIM 360 側でストレージにアクセスすることになる Forge アプリの Client ID を登録する必要があります。詳しくは、過去のブログ記事&#0160;<strong><a href="https://adndevblog.typepad.com/technology_perspective/2017/06/bim-360-docs-and-data-management-api-access.html" rel="noopener" target="_blank">BIM 360 Docs と Data Management API アクセス</a></strong> をご参照ください。</p>
<p>By Toshiaki Isezaki</p>
