---
layout: "post"
title: "GraphQL"
date: "2023-06-05 00:09:21"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2023/06/graphql.html "
typepad_basename: "graphql"
typepad_status: "Publish"
---

<p>GraphQL は、既存の Autodesk Platform Services（旧 Forge）でも多く使われいる RESTful API（REST API）に比べて複雑なクエリを定義出来る機能を持つ Facebook が開発したテクノロジです。2015 年にオープンソース プロジェクトとして公開され、Linux Foundation が <a href="https://graphql.org/" rel="noopener" target="_blank">GraphQL.org</a> で公開しています。</p>
<p>GraphQL は、API のためにデータを要求するクエリ言語（Query）と考えることができます。また、ミューテーション（Mutation）と呼ばれる動作では、データを作成、更新、および削除することも出来ます。クエリとミューテーションは同じ構文に従います。以下の例は GraphQL.org から引用したもので、Star Wars に関する情報をホストする GraphQL サーバーに送信されるクエリとミューテーションの例です。</p>
<section id="example-1-query">
<h3>例 1</h3>
<p><strong>クエリ（Query）</strong></p>
<div class="highlight-shell notranslate x-snippet-block x-snippet-block--height-200 margin-bottom-3">
<div class="highlight snippet-container">
<pre><code>query HeroNameAndFriends <span class="o">{</span>
  hero <span class="o">{</span>
    name
    friends <span class="o">{</span>
      name
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
<div class="snippet-toggle js-snippet-toggle"><strong>結果</strong></div>
</div>
</div>
<div class="highlight-json notranslate x-snippet-block x-snippet-block--height-200 margin-bottom-3">
<div class="highlight snippet-container">
<pre><code><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;hero&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;R2-D2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;friends&quot;</span><span class="p">:[</span>
        <span class="p">{</span>
          <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Luke Skywalker&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Han Solo&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Leia Organa&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="snippet-toggle js-snippet-toggle">クエリの詳細については、<a class="reference external" href="https://www.tutorialspoint.com/graphql/graphql_query.htm" rel="noopener" target="_blank">Tutorial on GraphQL queries</a>&#0160; を参照してみてください。</div>
</div>
</div>
</section>
<section id="example-2-mutation">
<h3>例 2</h3>
<p><strong>ミューテーション（Mutation）</strong></p>
<div class="highlight-shell notranslate x-snippet-block x-snippet-block--height-200 margin-bottom-3">
<div class="highlight snippet-container">
<pre><code>mutation CreateReviewForEpisode<span class="o">(</span><span class="nv">$ep</span>: Episode!, <span class="nv">$review</span>: ReviewInput!<span class="o">)</span> <span class="o">{</span>
  createReview<span class="o">(</span>episode: <span class="nv">$ep</span>, review: <span class="nv">$review</span><span class="o">)</span> <span class="o">{</span>
    stars
    commentary
  <span class="o">}</span>
<span class="o">}</span>

Variables:
<span class="o">{</span>
  <span class="s2">&quot;ep&quot;</span>:<span class="s2">&quot;JEDI&quot;</span>,
  <span class="s2">&quot;review&quot;</span>:<span class="o">{</span>
    <span class="s2">&quot;stars&quot;</span>:5,
    <span class="s2">&quot;commentary&quot;</span>:<span class="s2">&quot;This is a great movie!&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
<div class="snippet-toggle js-snippet-toggle"><strong>結果</strong></div>
</div>
</div>
<div class="highlight-json notranslate x-snippet-block x-snippet-block--height-200 margin-bottom-3">
<div class="highlight snippet-container">
<pre><code><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;createReview&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;stars&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
      <span class="nt">&quot;commentary&quot;</span><span class="p">:</span><span class="s2">&quot;This is a great movie!&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="snippet-toggle js-snippet-toggle">ミューテーションの詳細については、<a class="reference external" href="https://www.tutorialspoint.com/graphql/graphql_mutation.htm" rel="noopener" target="_blank">Tutorial on GraphQL mutations</a>&#0160;を参照してみてください。</div>
<div class="snippet-toggle js-snippet-toggle">&#0160;</div>
<div class="snippet-toggle js-snippet-toggle">GraphGL で扱うデータは、スキーマ（Schema Definition Language による定義）で定義されています。スキーマがわかっていれば、特定のデータを照会（クエリ）したり、変更（ミューテーション）したりすることが出来ます。これらは、必要とするデータだけをフェッチ（fetch）する動作をします。これに対して、RESTful API の場合には、必要かどうかに関係なく、すべての情報を事前定義されたペイロードを使って返す動作をします。</div>
</div>
</div>
<p>GraphQL の詳細については、次の内容をご確認ください：</p>
<ul class="simple">
<li><a class="reference external" href="https://www.howtographql.com/basics/0-introduction/" rel="noopener" target="_blank">How to GraphQL</a></li>
<li><a class="reference external" href="https://graphql.org/learn/" rel="noopener" target="_blank">Introduction to GraphQL</a></li>
</ul>
<p>オートデスクがプラットフォームに位置付けているインダストリー クラウドへの GraphQL の導入が進められている状況です。これは、<a href="https://aps.autodesk.com/en/docs/fdxgraph/v1/developers_guide/overview/" rel="noopener" target="_blank">Data Exchange</a>（データ交換）でも同様です。</p>
<p>現時点では、一部の APS API が用意されている限定された状態ですが、Data Exporter の名前がつけられたツールを使って、製造業向けに公開されている Fusion Data とデータ交換用の Data Exchange の GraphQL クエリを試すことが出来るようになっています。</p>
<ul>
<li><a href="https://fusion-data-explorer.autodesk.io/" rel="noopener" target="_blank">Fusion Data Explorer (autodesk.io)</a></li>
<li><a href="https://data-exchange-explorer.autodesk.io/" rel="noopener" target="_blank">Data Exchange Data Explorer (autodesk.io)</a></li>
</ul>
<p>Fusion Data Explorer で簡単な例を見てみます。Fusion Data Explorer 起動時には、3-legged OAuth を使って Fusion 360 や Fusion Team にアクセスする認可のプロセスを経て、ストレージ内のデータにアクセスします。通常、このアクセスには Data Management API の <a href="https://aps.autodesk.com/en/docs/data/v2/reference/http/hubs-GET/">GET hubs</a> エンドポイントを用いてアカウントに関連付けられたハブ（Hub）の ID をリストするところから情報を収集していきます。</p>
<p>Fusion Data Explorer の初期画面左側には、ハブ一覧を得るクエリが事前設定されています。この状態で、画面左上の再生（▶）ボタンをクリックすると、クエリが実行されて画面右側にクエリ結果（レスポンス）が表示されます。ここでは、クエリに name のみを指定しているので、ハブ名のみが一覧に表示されています。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02b75181ef10200b-pi" style="display: inline;"><img alt="Data_exporter1" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02b75181ef10200b image-full img-responsive" src="/assets/image_174034.jpg" title="Data_exporter1" /></a></p>
<p>次に、クエリに&#0160; API でハブを識別する ID（hubId）を含めるため、id を追記して（▶）ボタンをクリックすると、レスポンスに hubId が含まれるようになります。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02b68538dc72200d-pi" style="display: inline;"><img alt="Data_exporter2" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02b68538dc72200d image-full img-responsive" src="/assets/image_218371.jpg" title="Data_exporter2" /></a></p>
<p><a href="https://aps.autodesk.com/en/docs/data/v2/reference/http/hubs-GET/">GET hubs</a> エンドポイントでは、アプリで使用しないケースでも定義されたデータすべてが返されるので、場合によっては冗長になってしまう場面でも、必要なデータのみを得ることが出来る訳です。ここでクエリ可能な name や id は、オートデスクがあらかじめスキーマ（schema）で定義したものある点に注意してください。</p>
<p>Fusion Data Explorer で GraphQL クエリを実行する際に、<a href="https://adndevblog.typepad.com/technology_perspective/2018/10/about-developer-tool-on-web-browser.html" rel="noopener" target="_blank">デベロッパーツール</a>の「ネットワーク」タブで リクエストを監視してみると、クエリ内容が変わっても、呼び出されるエンドポイントが https://developer.api.autodesk.com/manufacturing/graphql/v1 で変わらないことがわかります。また、リクエストの「種類/タイプ」の値が、RESTful API 実行時によく見られる <a href="https://ja.wikipedia.org/wiki/Ajax" rel="noopener" target="_blank">Ajax</a> を使った XMLHTTPRequest 「xdr」ではなく、「fetch」になっていることも分かります（fetch ＝ GraphQL という訳ではありませんが）。</p>
</section>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02b751a6636b200c-pi" style="display: inline;"><img alt="F12" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02b751a6636b200c image-full img-responsive" src="/assets/image_511688.jpg" title="F12" /></a></p>
<p>お気づきのとおり、GraphQL が持つ柔軟性によって、いままでの RESTful API で実現していた、目的に応じて異なるエンドポイントを使い分ける手間を大幅に低減させることが出来ます。言い換えれば、１つ、あるいは、少ないエンドポイント呼び出しで目的が達成出来るようになるので、トラフィックを低下させることが出来ます。キャッシュがサポートされないなどの短所もありますが、大規模で多様なデータを扱う<a href="https://adndevblog.typepad.com/technology_perspective/2022/12/graph-database.html" rel="noopener" target="_blank">グラフ データベース</a>との協調にはマッチしています。</p>
<p>インダストリークラウドで利用することになる GraphQL のスキーマ定義は、最終的に多くの方にお使いいただけるよう、少し時間をかけています。もちろん、扱うデータはファイルではなく、ファイルに含まれる個々のデータ、つまり、粒状データということになります。すべてのデザイン データにアクセス出来るようになるまで、少しお待ちいただければと思います。</p>
<p>なお、前述の Data Data Explorer&#0160; は、<a href="https://github.com/autodesk-platform-services/aps-data-explorer" rel="noopener" target="_blank">GitHub - autodesk-platform-services/aps-data-explorer: Data Explorer:</a>&#0160;でソースコードが公開されています。</p>
<p>By Toshiaki Isezaki</p>
