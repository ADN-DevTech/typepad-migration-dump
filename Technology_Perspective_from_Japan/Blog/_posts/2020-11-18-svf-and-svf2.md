---
layout: "post"
title: "Model Derivative API：SVF と SVF2"
date: "2020-11-18 06:17:51"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2020/11/svf-and-svf2.html "
typepad_basename: "svf-and-svf2"
typepad_status: "Publish"
---

<p>SVF2 は、従前、OTG のコードネームでご紹介してきたファイル形式で、SVF 同様、デザイン ファイルを Forge Viewer で表示する目的で Model Derivative API によって生成されるものです。SVF が苦手としていた大規模モデルの表示を改善する目的で、導入が決定した経緯があります。</p>
<p>SVF2 を利用すると、ドアや窓、階段など、モデル内で形状が同じで反復するジオメトリ要素を共有して、個別にインスタンス化されることを抑止、さらにキャッシュを利用することで、少メモリでのモデルを表示が出来るようになっています。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026be41d7350200d-pi" style="display: inline;"><img alt="Comparison1" border="0" class="asset  asset-image at-xid-6a0167607c2431970b026be41d7350200d image-full img-responsive" src="/assets/image_263752.jpg" title="Comparison1" /></a></p>
<p>SVF2 は従来の SVF（Streaming Vector Format）の正常進化版で、<strong><a href="https://forge.autodesk.com/en/docs/model-derivative/v2/reference/http/job-POST/" rel="noopener" target="_blank">POST job</a></strong> endpoint を使った変換時に、リクエストボディで SVF2 を指定して、新規に SVF2 ファイルと<a href="https://adndevblog.typepad.com/technology_perspective/2017/05/translatable-file-format-with-model-derivative-api-and-role.html" rel="noopener" target="_blank">その派生物（Derivatives）</a>を生成することができます。</p>
<pre class="code-snippet more-toggle--slide snippet-container js-more-toggle more-toggle" data-toggle-end-color="rgba(250, 250, 250, 1)" data-toggle-height="400" data-toggle-less="Hide Code" data-toggle-more="Show Code"><code class="language-javascript code-overflow-x hljs " id="snippet-4">{
   &quot;input&quot;: {
     &quot;urn&quot;: &quot;<em>&lt;Your Encoded URN&gt;</em>&quot;
   },
   &quot;output&quot;: {
     &quot;formats&quot;: [
       {
<span style="color: #0000ff;">         &quot;type&quot;: &quot;<strong>svf2</strong>&quot;,</span>
         &quot;views&quot;: [
           &quot;2d&quot;,
           &quot;3d&quot;
         ]
       }
     ]
   }
 }
</code><code class="language-javascript code-overflow-x hljs "></code></pre>
<p>SVF2 の生成で生成されるマニフェストには、SVF2 であることを意味する <strong>outputType</strong> <strong>値</strong>が示されます。</p>
<pre class="code-snippet more-toggle--slide snippet-container js-more-toggle more-toggle" data-toggle-end-color="rgba(250, 250, 250, 1)" data-toggle-height="400" data-toggle-less="Hide Code" data-toggle-more="Show Code"><code class="language-javascript code-overflow-x hljs ">{
    &quot;urn&quot;: &quot;<em>&lt;Your Encoded URN&gt;</em>&quot;,
    &quot;derivatives&quot;: [
        {
            &quot;hasThumbnail&quot;: &quot;true&quot;,
            &quot;children&quot;: [
					:
            &quot;progress&quot;: &quot;complete&quot;,
<span style="color: #0000ff;"><strong>            &quot;outputType&quot;: &quot;svf2&quot;,</strong></span>
            &quot;status&quot;: &quot;success&quot;
        },
					:
        }
    ],
    &quot;hasThumbnail&quot;: &quot;true&quot;,
    &quot;progress&quot;: &quot;complete&quot;,
    &quot;type&quot;: &quot;manifest&quot;,
    &quot;region&quot;: &quot;US&quot;,
    &quot;version&quot;: &quot;1.0&quot;,
    &quot;status&quot;: &quot;success&quot;
}
</code><code class="language-javascript code-overflow-x hljs "></code></pre>
<p>一度、SVF ファイル変換を完了しているデザイン ファイルに対して SVF2 ファイル変換を実行することも出来ます。この場合、<strong><a href="https://forge.autodesk.com/en/docs/model-derivative/v2/reference/http/job-POST/" rel="noopener" target="_blank">POST job</a></strong> endpoint 呼び出し時のリクエスト ヘッダーに <span class="name">x-ads-force パラメータを指定せずに、または、false を指定する必要があります。この方法を利用すると、比較的短い時間で SVF2 を得ることが可能です。この方法をとった場合、マニフェストには overrideOutputType: svf2 が現れます。</span></p>
<p>。</p>
<pre class="code-snippet more-toggle--slide snippet-container js-more-toggle more-toggle" data-toggle-end-color="rgba(250, 250, 250, 1)" data-toggle-height="400" data-toggle-less="Hide Code" data-toggle-more="Show Code"><code class="language-javascript code-overflow-x hljs ">{
    &quot;urn&quot;: &quot;<em>&lt;Your Encoded URN&gt;</em>&quot;,
    &quot;derivatives&quot;: [
        {
            &quot;hasThumbnail&quot;: &quot;true&quot;,
            <span style="color: #0000ff;"><strong>&quot;overrideOutputType&quot;: &quot;svf2&quot;,</strong></span>
            &quot;children&quot;: [
					:
            &quot;progress&quot;: &quot;complete&quot;,
<span style="color: #0000ff;"><strong>            &quot;outputType&quot;: &quot;svf&quot;,</strong></span>
            &quot;status&quot;: &quot;success&quot;
        },
					:
        }
    ],
    &quot;hasThumbnail&quot;: &quot;true&quot;,
    &quot;progress&quot;: &quot;complete&quot;,
    &quot;type&quot;: &quot;manifest&quot;,
    &quot;region&quot;: &quot;US&quot;,
    &quot;version&quot;: &quot;1.0&quot;,
    &quot;status&quot;: &quot;success&quot;
}
</code><code class="language-javascript code-overflow-x hljs "></code></pre>
<p>一</p>
<p>生成された SVF2 viewable を Forge Viewer で表示するには、従来と同じく Base64 エンコードされた URN を指定することになります。ただ、現在の Beta ステージでは、Viewer の初期化では env と api を、それぞれ、<strong>MD20ProdUS</strong>（米国）あるいは <strong>MD20ProdEU</strong>（EMEA）に、api を <strong>D3S</strong> に変更する必要があります。</p>
<p style="text-align: left;"><span style="background-color: #ffff00;">（ご注意：2021 年 7 月の <strong><a href="https://adndevblog.typepad.com/technology_perspective/2021/07/start-svf2-operation.html" rel="noopener" target="_blank">SVF2 正式サポート</a></strong>に際して、JavaScipt ライブラリ バージョン 7.28 以降、SVF2 を利用するアプリは、Forge Viewer の初期化オプションで指定する従来の env 値&#0160; MD20ProdUS（または MD20ProdEU）、 api 値 D3S に代わって、env 値 <strong>AutodeskProduction2</strong>（または&#0160;<strong data-stringify-type="bold">AutodeskStaging2&#0160;</strong>/&#0160;<strong data-stringify-type="bold">AutodeskProduction2</strong>&#0160;）、api 値&#0160;<strong>streamingV2</strong>（または&#0160;<strong>streamingV2_EU</strong>）への置き換えが推奨されています。従来値は将来廃止される予定ですので、お早めに上記置き換えをお願いします。- 2021 年 8 月追記）</span></p>
<pre class="code-snippet more-toggle--slide snippet-container js-more-toggle more-toggle" data-toggle-end-color="rgba(250, 250, 250, 1)" data-toggle-height="400" data-toggle-less="Hide Code" data-toggle-more="Show Code"><code class="language-javascript code-overflow-x hljs " id="snippet-4">    // Intialize Viewer
    var options = {
<span style="color: #0000ff;"><strong>        env: <span style="text-decoration: line-through;">&#39;MD20ProdUS&#39;</span><span style="background-color: #ffff00;">&#39;AutodeskProduction2&#39;</span>,
        api: <span style="text-decoration: line-through;">&#39;D3S&#39;</span><span style="background-color: #ffff00;">&#39;streamingV2&#39;</span>,
</strong></span>        language: &#39;ja&#39;,
        getAccessToken: getCredentials
    };

    Autodesk.Viewing.Initializer(options, function () {

        _viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById(&#39;viewer3d-1&#39;));
        var startedCode = _viewer.start();
        if (startedCode &gt; 0) {
            console.error(&#39;Failed to create a 3D Viewer: WebGL not supported.&#39;);
            return;
        }

        // Load viewable
        var documentId = &#39;urn:&#39; + urn_svf;
        Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);

    });

</code><code class="language-javascript code-overflow-x hljs "></code></pre>
<p>なお、モデルの内容によっては、デザインファイル形式に関係なく、期待した使用メモリの低減が得られない場合もあります。地形モデルのように、前述した形状の一致と反復がみられない場合、ジオメトリをキャッシュしてモデル全体で共有利用することが出来ないためです。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026be41d73b9200d-pi" style="display: inline;"><img alt="Comparison2" border="0" class="asset  asset-image at-xid-6a0167607c2431970b026be41d73b9200d image-full img-responsive" src="/assets/image_504507.jpg" title="Comparison2" /></a></p>
<p>ただし、SVF2 のストリーミングには <strong><a href="https://ja.wikipedia.org/wiki/WebSocket" rel="noopener" target="_blank">WebSocket</a></strong> が使用されているため、消費メモリに差がみられない場合でも、ロードが高速になるものも存在します。</p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b026bde9e94f2200c-pi" style="display: inline;"><img alt="Comparison3" border="0" class="asset  asset-image at-xid-6a0167607c2431970b026bde9e94f2200c image-full img-responsive" src="/assets/image_516233.jpg" title="Comparison3" /></a></p>
<p>その他、現状の注意点には、次のようなものがあります。SVF2 が正式にリリースされる時点で、これらの内容、あるいは、方向性が変更される可能性がありますので、ご注意ください。</p>
<ul>
<li>SVF2 は SVF を完全に置き換えるものではありません。用途によって、SVF と SVF2 を使い分ける必要が出る場合があります。いまのところ、SVF の運用を中止するような計画はありません。</li>
<li>SVF2 のオフライン運用は、現在サポートされていません。</li>
<li>SVF2 変換された URN を使って、従来の Viewer 初期化オプション api と env 属性の変更（env: &#39; AutodeskProduction’ ）、api: ‘derivativeV2‘（または&#0160; api: ‘derivativeV2_EU‘）を指定した場合は、SVF がロードされます。</li>
</ul>
<p><iframe allowfullscreen="" frameborder="0" height="270" src="//www.youtube.com/embed/TFYYyT4HTLk" width="480"></iframe></p>
<p>By Toshiaki Isezaki</p>
