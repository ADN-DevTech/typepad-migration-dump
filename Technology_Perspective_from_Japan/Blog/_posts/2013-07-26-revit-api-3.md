---
layout: "post"
title: "Revit ファミリAPI - その3"
date: "2013-07-26 11:00:00"
author: "Mikako Harada"
categories: []
original_url: "https://adndevblog.typepad.com/technology_perspective/2013/07/revit-%E3%83%95%E3%82%A1%E3%83%9F%E3%83%AAapi-%E3%81%9D%E3%81%AE3.html "
typepad_basename: "revit-ファミリapi-その3"
typepad_status: "Publish"
---

<p>「RevitファミリAPI」と称して、<a href="http://adndevblog.typepad.com/technology_perspective/2013/07/revit-ファミリapi-その2.html%20" target="_self" title="RevitファミリAPI その２">前回</a>と<a href="http://adndevblog.typepad.com/technology_perspective/2013/07/revit-ファミリapi.html" target="_self" title="RevitファミリAPI その１">前々回</a>では、ファミリの作成方法をベストプラクティスに沿った、RevitファミリAPIの使用方法の基本を説明しました。今回は、その最終編として、表示レベルによって異なる細部のモデルの調整とマテリアルの追加についてお話します。そして最後に、参考になるSDKサンプルを紹介します。</p>
<p>&#0160;</p>
<p><span style="text-decoration: underline;">ファミリ作成に関連するその他のクラスとメソッド</span></p>
<p>Revitの表示には簡易、普通、詳細の３種類の表示レベルがありますが、ファミリを作成する場合それらを考慮する必要がある場合があります。それらを指定するには、<strong>FamilyElementVisibility</strong>クラスをもちいます。FamilyElementVisibilityクラスのインスタンスを作成し、表示のレベルの設定をし、それを関連するエレメントにElement.SetVisibility()メソッドを用いて指定します。以下が、ソリッドを簡易表示の際には、表示しないようにする例です。</p>
<p>Sub SetVisibility(ByVal
pSolid As Extrusion)</p>
<div>
<p>&#0160;&#0160;&#0160; &#39; モデルの可視状態を簡易モードでは表示しないように設定します。<br /><br /></p>
<p>&#0160;&#0160;&#0160; Dim
pVis As FamilyElementVisibility = _ <br />
&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160; New <strong>FamilyElementVisibility</strong>(FamilyElementVisibilityType.Model)</p>
<p>&#0160;&#0160;&#0160;
pVis.IsShownInCoarse = False</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160;
pSolid.SetVisibility(pVis)</p>
<p>&#0160;</p>
<p>End Sub</p>
</div>
<p>&#0160;</p>
<p>また、場合によっては、ファミリの定義の中でも、インスタンスレベルのパラメータとしてソリッドという固有のジェオメトリに個別に定義したい場合があるかと思います。マテリアルがそういった例にあたります。その場合は、インスタンスパラメータをファミリパラメータに関連付けるひつようがあります。これを行うには、<strong>FamilyManager.AssociateElementParameterToFamilyParameter</strong>を使用します。以下がコードの使用例です。</p>
<p><strong>&#0160;</strong></p>
<div>
<p>Sub addMaterials(ByVal
pSolid As Extrusion)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160;
&#39; マテリアルIDの取得。（例えば、&quot;ガラス&quot;など）</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim
pMat As Material = _</p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;
Utils.FindElement(m_rvtDoc, GetType(Material), &quot;Glass&quot;)</p>
<p>&#0160;&#0160;&#0160;
Dim idMat As ElementId = pMat.Id</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160;
&#39; 素材仕上げのパラメータを取得</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160;
Dim paramFamilyMaterial As FamilyParameter = _ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;
m_familyMgr.Parameter(&quot;Column Finish&quot;)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; 先ほど取得したファミリのパラメータにマテリアルパラメータを関連付ける</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; Dim
paramSolidMaterial As Parameter = pSolid.Parameter(&quot;Material&quot;)</p>
<p>&#0160;&#0160; &#0160;m_familyMgr.<strong>AssociateElementParameterToFamilyParameter</strong>(
_ </p>
<p>&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;&#0160;
paramSolidMaterial, paramFamilyMaterial)</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160; &#39; ガラス仕上げで別のタイプを追加</p>
<p>&#0160;</p>
<p>&#0160;&#0160;&#0160;
AddType(&quot;Glass&quot;, 600.0, 600.0)</p>
<p>&#0160;&#0160;&#0160;
m_familyMgr.Set(paramFamilyMaterial, idMat)</p>
<p>&#0160;</p>
<p>End Sub</p>
</div>
<p>&#0160;（コードは、<a href="http://www.autodesk.com/developrevit" target="_self" title="Revit ADN サイト">Revit ADN Open のサイトにポストしてあるRevit 2013/2014 API Labs</a>&#0160;にあります。必要に応じて参考にしてください。）</p>
<p>&#0160;</p>
<p><span style="text-decoration: underline;">ファミリ関連のSDK </span><span style="text-decoration: underline;">サンプル</span></p>
<p>最後に、SDKに含まれるファミリに関するサンプルを示します。ファミリのサンプルは、&lt;SDKフォルダ&gt;\Samples\ FamilyCreation　にまとまっていますので、必要に応じて参考にしてください。</p>
<p>AutoJoin</p>
<ul>
<li>自動的にファミリモデルやマスで使用する複数の汎用フォームのジオメトリを自動的に結合します。</li>
<li>フォームが重なっている部分をDocument.CombineElements()メソッドを使用して結合させます。</li>
<li>ジオメトリオブジェクトが重なっているかどうかを、Face.Intersect(Curve)
メソッドを用いてチェックします。</li>
</ul>
<p>&#0160;</p>
<p>AutoParameter</p>
<ul>
<li>１つまたは複数のファミリのドキュメントへ、共有または非共有パラメータをバッチ·モードで自動追加します。</li>
<li>アクティブなファミリドキュメント、あるいは、フォルダ内のすべてのファミリドキュメントを処理します。</li>
<li>FamilyManagerクラスのAddParameterメソッドを使用します。</li>
<li>Revitの共有パラメータ形式で書かれたパラメータのテキストファイルから入力データを読み込みます。</li>
</ul>
<p>&#0160;</p>
<p>DWGFamilyCreation</p>
<ul>
<li>DWGファイルをファミリドキュメントにインポートし、インポートされたインスタンスにタイプパラメータを追加します。（WGFileName
とImportTime）</li>
</ul>
<p>&#0160;</p>
<p>GenericModelCreation</p>
<ul>
<li>押し出し、ブレンド、回転、スイープとスイープブレンド要素を使用して一般的なモデルを作成します。</li>
<li>開いているドキュメントは、ファミリドキュメントであるかをチェック、あるいは、新しいファミリのドキュメントを作成します。</li>
<li>プロファイルと図形を作成するためCreateSketchPlane、NewLineBound、およびFamilyItemFactoryの使用方法の例を示します。</li>
</ul>
<p>&#0160;</p>
<p>&#0160;
<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b0192abe77080970d-pi" style="display: inline;"><img alt="13 generic model creation " border="0" class="asset  asset-image at-xid-6a0167607c2431970b0192abe77080970d" src="/assets/image_562553.jpg" title="13 generic model creation " /></a><br /><br /></p>
<p>TypeRegeneration</p>
<ul>
<li>定義されているすべてのタイプを決定するためにFamilyManager.Typesプロパティを使用します。CurrentTypeで、現在のタイプを決定します。</li>
<li>すべてのタイプが正常に再生されたかどうかを報告し、ファイルにエラーがログします。</li>
</ul>
<p>&#0160;</p>
<p>ValidateParameters</p>
<ul>
<li>すべてのタイプが、特定のパラメータに有効な値を持っているかどうかをチェックし、結果をファイルにログします。</li>
<li>外部アプリケーションがDocumentSavingとDocumentSavingAsイベントに登録し、保存の際、自動的にチ正しい値が持ちられているかをチェックします。</li>
<li>外部コマンドで、手動で起動することも可能です。</li>
</ul>
<p>&#0160;</p>
<p>WindowWizard</p>
<ul>
<li>窓ファミリを作成する、ウィザード形式のサンプルです。ユーザインタフェースを提供し、それを介して作成します。</li>
<li>窓ファミリテンプレート、例えば、Metric
Window.rtfを持ちいてスタートします。</li>
<li>ユーザは、窓の寸法パラメータ、および材料の入力を行います。</li>
<li>押し出し、位置合わせの拘束、寸法線、参照面、およびファミリタイプを作成します。</li>
</ul>
<p>&#0160;</p>
<p>&#0160;
<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b0192abe76fc9970d-pi" style="display: inline;"><img alt="14 window wizard" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0192abe76fc9970d image-full" src="/assets/image_722239.jpg" title="14 window wizard" /></a></p>
<p>CreateAirHandler – Revit MEP独特の機能</p>
<ul>
<li>パイプとダクトコネクタ付き空気ハンドラを作成します。</li>
<li>テンプレートの有効性を確認するために、テンプレートのファミリカテゴリをチェックします。</li>
<li>FamilyItemFactoryクラスのNewExtrusion、NewPipeConnector、NewDuctConnectorメソッドを使用します。</li>
<li>適切な​​コネクタパラメータを設定し、押し出し要素に設定するために、Document.CombineElementsを使用します。</li>
</ul>
<p>&#0160;
<a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b0192abe77159970d-pi" style="display: inline;"><img alt="15 RME connecter sample" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0192abe77159970d" src="/assets/image_83642.jpg" title="15 RME connecter sample" /></a><br /><br /><br /></p>
<p>CreateTruss – Revit Structure独特の機能</p>
<ul>
<li>トラスファミリのドキュメントのモノトラスを作成します。</li>
<li>NewModelCurveを使用してトラス曲線を作成し、ModelCurve
TrussCurveTypeプロパティを通じてトラスタイプをセットします。</li>
<li>NewAlignmentをもちて、トラス曲線に拘束を追加します。</li>
</ul>
<p><strong>&#0160;</strong></p>
<p>以上三回に分けてAPIを用いたファミリの作成方法のお話をしました。Revitを真に使いこなすのは、ファミリを理解することが大切です。ぜひチャレンジしてみてください。</p>
<p>原田</p>
