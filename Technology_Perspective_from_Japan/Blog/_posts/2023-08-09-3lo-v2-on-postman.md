---
layout: "post"
title: "Postman を使った 3-legged 認証・認可(OAuth v2)"
date: "2023-08-09 00:07:55"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2023/08/3lo-v2-on-postman.html "
typepad_basename: "3lo-v2-on-postman"
typepad_status: "Publish"
---

<p>Authentication API（OAuth API）が v2 に移行にともなって、<a href="https://adndevblog.typepad.com/technology_perspective/2016/12/understanding-steps-to-use-viewer-on-postman2.html" rel="noopener" target="_blank">Postman による Viewer 利用手順の理解 - 3 legged 認証</a> のようなワークフローでも使用するエンドポイントを変更する必要が生じます。</p>
<p>具体的には、従来の&#0160;<a href="https://aps.autodesk.com/en/docs/oauth/v1/reference/http/authorize-GET/">GET authorize </a>&#0160;エンドポイントと <a href="https://aps.autodesk.com/en/docs/oauth/v1/reference/http/gettoken-POST/">POST gettoken</a>エンドポイントから <a href="https://aps.autodesk.com/en/docs/oauth/v2/reference/http/authorize-GET/">GET authorize</a>エンドポイントと <a href="https://aps.autodesk.com/en/docs/oauth/v2/reference/http/gettoken-POST/">POST token</a> エンドポイントに変更します。ここでは、新しいエンドポイントを使ったユーザ認可を経て、アクセストークンを取得する方法をご紹介しておきます。</p>
<hr />
<ol>
<li>Postman 上で 3 Legged 認証で使用する Callback URL は、<strong><a href="https://www.getpostman.com/oauth2/callback">https://www.getpostman.com/oauth2/callback</a></strong>&#0160;に設定する必要があります。まず、<strong><a href="https://aps.autodesk.com/" rel="noopener noreferrer" target="_blank">APS ポータル（https://aps.autodesk.com）</a></strong>に新規にアプリを作成するか登録済のアプリを編集して、Callback URL を、この値に変更してください。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02c1a6cfab00200b-pi" style="display: inline;"><img alt="Callback" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02c1a6cfab00200b image-full img-responsive" src="/assets/image_915717.jpg" title="Callback" /></a></li>
<li>続いて、Postman 側で OAuth2 の 3 legged 認証の設定をしていきます。 Postman を起動して、新しいタブ（New Request）上で&#0160;<strong>Authorization</strong> タブを選択します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02b751ad0d0d200c-pi" style="display: inline;"><img alt="Authoriza_tab" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02b751ad0d0d200c image-full img-responsive" src="/assets/image_780357.jpg" title="Authoriza_tab" /></a>&#0160;</li>
<li><strong>Authorization</strong>タブ名の下にある Type には、ドロップダウン リストから「<strong>OAuth 2.0</strong>」を選択します。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02c1b25b63eb200d-pi" style="display: inline;"><img alt="Oauth2.0" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02c1b25b63eb200d image-full img-responsive" src="/assets/image_387377.jpg" title="Oauth2.0" /></a></li>
<li><strong>Authorization</strong>タブを下方向にスクロールして <strong>Configure New Token&#0160;</strong>欄の各値を入力していきます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02c1b25b63f2200d-pi" style="display: inline;"><img alt="Configure_new_token" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02c1b25b63f2200d image-full img-responsive" src="/assets/image_847527.jpg" title="Configure_new_token" /></a></li>
<li><strong>Configure New Token&#0160;</strong>欄の各項目に、次の値を入力していきます。<br />-&#0160;<strong>Token Name</strong>&#0160;= Postman 上の保存名です。他の Postman コレクション名と同じく任意で結構です。<br />-&#0160;<strong>Grant Type</strong>&#0160;= <strong>Authorization Code</strong><br />-&#0160;<strong>Callback URL</strong>&#0160;= <strong>https://www.getpostman.com/oauth2/callback</strong>（1. で指定）<br />-<strong>&#0160;Auth URL</strong> = <strong>https://developer.api.autodesk.com/authentication/v2/authorize</strong><br />-&#0160;<strong>Access Token URL</strong> = <strong>https://developer.api.autodesk.com/authentication/v2/token</strong><br />-&#0160;<strong>Client ID</strong> = APS ポータルで作成したアプリ設定の <strong>Client ID</strong><br />-&#0160;<strong>Client Secret</strong> = APS ポータルで作成したアプリ設定の <strong>Client Secret</strong><br />-&#0160;<strong>Scope</strong> = APS アプリで必要となる<strong>&#0160;Scope</strong>&#0160;の値（例：data:read data:write data:create）<br />-&#0160;<strong>State</strong>&#0160;= 未指定<br />-&#0160;<strong>Client Authentication</strong> = <strong>Send as Basic Auth header</strong><br /><span style="color: #ffffff;"><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0282e1538907200b-pi" style="color: #ffffff;"><img alt="Get_new_access_token" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0282e1538907200b image-full img-responsive" src="/assets/image_57900.jpg" title="Get_new_access_token" /></a></span></li>
<li>ここまでの設定で、3 legged 認証の準備が整いました。<span style="background-color: #ff7f00;"><span style="color: #ffffff; font-family: verdana, geneva;">[Get New Access Token]</span></span><span style="color: #ffffff;">&#0160;&#0160;</span>ボタンをクリックしてみてください。オートデスク アカウントのユーザ名（Autodesk ID）の入力を促す画面が表示されるはずです。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02c1a6cfab7c200b-pi" style="display: inline;"><img alt="User_name" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02c1a6cfab7c200b image-full img-responsive" src="/assets/image_397856.jpg" title="User_name" /></a></li>
<li>Autodesk ID を入力して&#0160;<span style="background-color: #8080ff; color: #ffffff;">[&#0160; &#0160; 次へ &#0160; ]</span>&#0160;&#0160;をクリックすると、パスワードの入力画面に遷移します。 パスワードの入力後、 <span style="background-color: #8080ff; color: #ffffff;">[ &#0160; &#0160; サイン &#0160;イン &#0160; ]</span>&#0160;をクリックしてサインインを完了してください。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b022ad3e0c260200b-pi"> </a><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02b751ad0d5e200c-pi" style="display: inline;"><img alt="Password" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02b751ad0d5e200c image-full img-responsive" src="/assets/image_145561.jpg" title="Password" /></a></li>
<li>入力した Autodesk ID とパスワードで認証が完了すると、この Autodesk ID を持つユーザのストレージに APS アプリがアクセスする許可を求められます。画面中央に表示されているアクセス権限は、5. で指定した Scope の内容に沿ったものとなります。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02c1a6cfab68200b-pi" style="display: inline;"><img alt="Authorize" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02c1a6cfab68200b image-full img-responsive" src="/assets/image_688319.jpg" title="Authorize" /></a></li>
<li><span style="background-color: #ffffff;">&#0160;</span><span style="background-color: #8080ff; color: #ffffff;"><span style="background-color: #8080ff;">[ &#0160; &#0160;許可 &#0160; &#0160;]<span style="background-color: #ffffff;">&#0160;</span></span></span>をクリックすると、APS アプリがユーザ ストレージにアクセスすることを許可（認可）したことになります。</li>
<li>取得出来た Access Token を含むダイアログが表示されます。<span style="background-color: #ff7f00;"><span style="background-color: #ffffff;">&#0160;</span><span style="color: #ffffff; font-family: verdana, geneva;">[Use Token]</span><span style="background-color: #ffffff;">&#0160;&#0160;</span></span>をクリックします。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02942fa8b509200c-pi"><img alt="Manage_access_token" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02942fa8b509200c image-full img-responsive" src="/assets/image_141354.jpg" title="Manage_access_token" /></a></li>
<li>ここまでの処理で、「Access Token」欄に取得した Access Token の値が追加されているはずです。この値を利用して、RESTful 呼び出しで他のエンドポイントのテストをおこなうことが出来ます。<br /><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b02c1a6cfab90200b-pi" style="display: inline;"><img alt="Token" border="0" class="asset  asset-image at-xid-6a0167607c2431970b02c1a6cfab90200b image-full img-responsive" src="/assets/image_725204.jpg" title="Token" /></a></li>
</ol>
<hr />
<p>一度、使用した認証プロセスは、<strong>Token Name&#0160;</strong>名で再利用することが出来ます（ここでは APS Access Token）。A360 などのストレージ アクセスを Postman でテストする場合は、ここまでの手順で Callback URL をした&#0160;<strong><a href="https://adndevblog.typepad.com/technology_perspective/2016/08/oauth-authentication-scenario-on-forge.html#_3-legged" rel="noopener noreferrer" target="_blank">3-legged 認証</a></strong><strong>&#0160;</strong>をシミュレーションすることが出来ます。&#0160;</p>
<p>By Toshiaki Isezaki</p>
