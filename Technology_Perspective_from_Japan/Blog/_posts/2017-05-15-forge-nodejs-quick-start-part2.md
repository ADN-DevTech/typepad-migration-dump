---
layout: "post"
title: "Forge Node.js クイックスタート ～ その2"
date: "2017-05-15 00:34:06"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part2.html "
typepad_basename: "forge-nodejs-quick-start-part2"
typepad_status: "Publish"
---

<p><span style="background-color: #ffff00;">&lt;本記事は2019年12月10日に Forge SDK 更新にあわせて一部改定しています。&gt;</span></p>
<p><strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part1.html" rel="noopener noreferrer" target="_blank">前回</a></strong>、<a href="https://forge.autodesk.com/en/docs/quickstarts/v1/nodejs/" rel="noopener noreferrer" target="_blank">https://forge.autodesk.com/en/docs/quickstarts/v1/nodejs/</a>&#0160;に記載されている <strong>Forge Node.js SDK </strong>のサンプル（Quickstart） の内容に沿って、GitHub に記載されている Forge SDK をローカルコンピュータにコピーして、サンプルの実装を完了させる手順をご紹介しました。</p>
<p>実装した dmSample.js のメインルーチンでは、Access Token を取得して Bucket を作成、指定したデザイン ファイルをアップロードした後にそのファイルを削除しまうので、ここでは、アップロードしたデザインファイルを Model Derivative API で変換して、Forge Viewer に表示する部分を追記していきます。</p>
<hr />
<ol>
<li>アップロードしたデザイン ファイルを Forge Viewer で表示するには、Model Derivative API を使用する必要があります。Forge SDK にも Model Derivative API をラップしているので、Node.js で機能を利用出来るように変数代入します。前回 GitHub リポジトリからクローンした &#0160;forge-api-nodejs-client\samples フォルダから&#0160; dmSample.js ファイルを見つけて Adobe Brackets で開きます。</li>
<li>dmSample.js 内で BucketsApi と objectsApi をインスタンス化して変数に代入している箇所を見つけて、下記の青字部分を追記してください。&#0160;new ForgeSDK.ObjectsApi() の後に <strong>,</strong> （カンマ）を挿入する点に注意してください。<br />
<pre>var fs = require(&#39;fs&#39;);<br /><br />var ForgeSDK = require(&#39;./../src/index&#39;);<br /><br />// TODO - insert your CLIENT_ID and CLIENT_SECRET<br />var FORGE_CLIENT_ID = &#39;0FbkV1SHBrTuIdIT51KECv45uUuJvsHN&#39;,<br />    FORGE_CLIENT_SECRET = &#39;J8JsGASgIXszdrIu&#39;;<br /><br />// TODO - Choose a bucket key - a unique name to assign to a bucket. It must be globally unique across all applications and<br />// regions, otherwise the call will fail. Possible values: -_.a-z0-9 (between 3-128 characters in<br />// length). Note that you cannot change a bucket key.<br />var BUCKET_KEY = &#39;forge_sample_&#39; + CLIENT_ID.toLowerCase();<br /><br />// TODO - Choose a filename - a key for the uploaded object<br />var FILE_NAME = &#39;Chair.f3d&#39;;<br /><br />// TODO - specify the full filename and path<br />var FILE_PATH = &#39;C:/Users/isezakt/Desktop/Chair.f3d&#39;;<br /><br />var bucketsApi = new ForgeSDK.BucketsApi(), // Buckets Client<br />    objectsApi = new ForgeSDK.ObjectsApi()<span style="color: #0000ff;"><strong>,</strong></span> // Objects Client<br />    <strong><span style="color: #0000ff;">derivativesApi = new ForgeSDK.DerivativesApi(); // Derivatives Client</span></strong><br /><br />// Initialize the 2-legged oauth2 client<br />var oAuth2TwoLegged = new ForgeSDK.AuthClientTwoLegged(FORGE_CLIENT_ID, CLIENT_SECRET,<br /> [&#39;data:write&#39;, &#39;data:read&#39;, &#39;bucket:read&#39;,&#39;bucket:update&#39;,&#39;bucket:create&#39;], true);</pre>
</li>
<li>dmSample.js 内にアップロードしたデザイン ファイルのドキュメント ID（objectId）を Base64 でエンコードする&#0160;base64encode() 関数を getBuckets() 関数の後に追記します。<br />
<pre>/**<br /> * Get the buckets owned by an application.<br /> * Uses the oAuth2TwoLegged object that you retrieved previously.<br /> */<br />var getBuckets = function(){<br />  console.log(&quot;**** Getting all buckets&quot;);<br />  return bucketsApi.getBuckets({},oAuth2TwoLegged, oAuth2TwoLegged.getCredentials());<br />};<br /><br /><strong><span style="color: #0000ff;">function base64encode(str) {</span></strong><br /><strong><span style="color: #0000ff;">  return new Buffer(str).toString(&#39;base64&#39;);</span></strong><br /><strong><span style="color: #0000ff;">}</span></strong></pre>
</li>
<li>次に dmSample.js 内に 変換を指示する <strong><a href="https://github.com/Autodesk-Forge/forge-api-nodejs-client/blob/master/docs/DerivativesApi.md#translate" rel="noopener noreferrer" target="_blank">translate</a></strong> endpoint を呼び出す&#0160;translateFile() 関数を base64encode() 関数の後に追記します。<br />
<pre><strong><span style="color: #0000ff;">var translateFile = function(encodedURN){</span></strong><br /><strong><span style="color: #0000ff;">  console.log(&quot;**** Translating file derivative&quot;);</span></strong><br /><strong><span style="color: #0000ff;">  var postJob =</span></strong><br /><strong><span style="color: #0000ff;">  {</span></strong><br /><strong><span style="color: #0000ff;">    input: {</span></strong><br /><strong><span style="color: #0000ff;">      urn: encodedURN</span></strong><br /><strong><span style="color: #0000ff;">    },</span></strong><br /><strong><span style="color: #0000ff;">    output: {</span></strong><br /><strong><span style="color: #0000ff;">      formats: [</span></strong><br /><strong><span style="color: #0000ff;">        {</span></strong><br /><strong><span style="color: #0000ff;">          type: &quot;svf&quot;,</span></strong><br /><strong><span style="color: #0000ff;">          views: [&quot;2d&quot;, &quot;3d&quot;]</span></strong><br /><strong><span style="color: #0000ff;">        }</span></strong><br /><strong><span style="color: #0000ff;">      ]</span></strong><br /><strong><span style="color: #0000ff;">    }</span></strong><br /><strong><span style="color: #0000ff;">  };</span></strong><br /><br /><strong><span style="color: #0000ff;">  return new Promise(function(resolve, reject) {</span></strong><br /><strong><span style="color: #0000ff;">    derivativesApi.translate(postJob, {}, oAuth2TwoLegged, oAuth2TwoLegged.getCredentials()).then(</span></strong><br /><strong><span style="color: #0000ff;">      function(res){</span></strong><br /><strong><span style="color: #0000ff;">        resolve(res);</span></strong><br /><strong><span style="color: #0000ff;">      },function(err){</span></strong><br /><strong><span style="color: #0000ff;">        reject(err);</span></strong><br /><strong><span style="color: #0000ff;">      }</span></strong><br /><strong><span style="color: #0000ff;">    ) </span></strong><br /><strong><span style="color: #0000ff;">  });</span></strong><br /><strong><span style="color: #0000ff;">};</span></strong></pre>
</li>
<li>同様に、dmSample.js 内に 変換状態をチェックする <strong><a href="https://github.com/Autodesk-Forge/forge-api-nodejs-client/blob/master/docs/DerivativesApi.md#getManifest" rel="noopener noreferrer" target="_blank">getManifest</a></strong>&#0160;endpoint を呼び出す manifestFile() 関数を translateFile() 関数の後に追記します。<br />
<pre><span style="color: #0000ff;"><strong>var manifestFile = function (encodedURN) {</strong></span><br /><span style="color: #0000ff;"><strong>  console.log(&quot;**** Getting File Manifest Status&quot;);</strong></span><br /><span style="color: #0000ff;"><strong>&#0160; </strong></span><br /><span style="color: #0000ff;"><strong>  return new Promise(function(resolve, reject) {</strong></span><br /><span style="color: #0000ff;"><strong>    derivativesApi.getManifest(encodedURN, {}, oAuth2TwoLegged, oAuth2TwoLegged.getCredentials()).then(</strong></span><br /><span style="color: #0000ff;"><strong>      function(res){</strong></span><br /><span style="color: #0000ff;"><strong>        if (res.body.progress != &quot;complete&quot;){</strong></span><br /><span style="color: #0000ff;"><strong>          console.log(&quot;The status of your file is &quot; + res.body.status);</strong></span><br /><span style="color: #0000ff;"><strong>          console.log(&quot; Please wait while we finish Translating your file&quot;);</strong></span><br /><span style="color: #0000ff;"><strong>        }else{</strong></span><br /><span style="color: #0000ff;"><strong>          console.log(&quot;****&quot; + res.body.status);</strong></span><br /><span style="color: #0000ff;"><strong>          console.log(&quot;****&quot; + res.body.progress);</strong></span><br /><span style="color: #0000ff;"><strong>          resolve(res);</strong></span><br /><span style="color: #0000ff;"><strong>        }</strong></span><br /><span style="color: #0000ff;"><strong>      },function(err){</strong></span><br /><span style="color: #0000ff;"><strong>        reject(err);</strong></span><br /><span style="color: #0000ff;"><strong>      }</strong></span><br /><span style="color: #0000ff;"><strong>    ) </strong></span><br /><span style="color: #0000ff;"><strong>  });</strong></span><br /><span style="color: #0000ff;"><strong>}</strong></span></pre>
</li>
<li>dmSample.js の最後にあるメインルーチンに変換処理と変換終了を検出するマニフェストの取得する青字部分の処理を追記します。もともと記述されている deleteFile() の呼び出しは削除します。<br />
<pre>/**<br /> * Create an access token and run the API calls.<br /> */<br />oAuth2TwoLegged.authenticate().then(function(credentials){<br /><br />  console.log(&quot;**** Got Credentials&quot;,credentials);<br /><br />  createBucketIfNotExist(BUCKET_KEY).then(<br /><br />    function(createBucketRes){<br />      console.log(&quot;**** Create bucket if not exist response:&quot;, createBucketRes.body);<br /><br />      getBuckets().then(function(getBucketsRes){<br />        console.log(&quot;**** Get all buckets response:&quot;);<br />        var bucketsArray = getBucketsRes.body.items;<br />        bucketsArray.map(function(currentBucket){<br />          console.log(currentBucket.bucketKey);<br />        })<br />      },function(err){<br />        console.error(err);<br />      });<br /><br />      uploadFile(BUCKET_KEY, FILE_PATH, FILE_NAME).then(function(uploadRes){<br />        console.log(&quot;**** Upload file response:&quot;, uploadRes.body);<span style="color: #0000ff;"><strong><br /><br /></strong></span>        <span style="text-decoration: line-through;">deleteFile(BUCKET_KEY, FILE_NAME).then(function(deleteRes) {</span><br />          <span style="text-decoration: line-through;">console.log(&quot;**** Delete file response status code:&quot;, deleteRes.statusCode);</span><br />        <span style="text-decoration: line-through;">},defaultHandleError);</span><br /><span style="color: #0000ff;"><strong><br />        var objectId = uploadRes.body.objectId;</strong></span><br /><span style="color: #0000ff;"><strong>        console.log(&quot;objectId:&quot;, objectId);</strong></span><br /><span style="color: #0000ff;"><strong>        var urn = base64encode(objectId);</strong></span><br /><span style="color: #0000ff;"><strong>        console.log(&quot;urn:&quot;, urn);</strong></span><br /><br /><span style="color: #0000ff;"><strong>        translateFile(urn).then(function(translateRes){</strong></span><br /> <br /><span style="color: #0000ff;"><strong>          manifestFile(urn).then(function(){</strong></span><br /><span style="color: #0000ff;"><strong>            console.log(&quot;**** Your File is ready for viewing&quot;); </strong></span><br /><span style="color: #0000ff;"><strong>          }, defaultHandleError) </strong></span><br /><br /><span style="color: #0000ff;"><strong>        }, defaultHandleError);</strong></span><br /><br />      }, defaultHandleError);<br /><br />    }, defaultHandleError);<br /><br />}, defaultHandleError);</pre>
</li>
<li>Node.js command prompt 上で samples ディレクトリに移動して、node dmSample.js と入力して処理を実行します。コード中の console.log() で指定した情報が表示されるはずなので、この中に Access Token とエンコードされた URN（ドキュメント ID）が含まれることを確認してください。<br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d2e58afe970c-pi" style="display: inline;"><img alt="Execution_result" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d2e58afe970c image-full img-responsive" src="/assets/image_773644.jpg" title="Execution_result" /></a></li>
<li>
<p>次の HTML ファイルをダウンロードして、accessToken パラメータに Access Token を、urn パラメータに SVF ファイル変換が終了したデザイン ファイルの URN を与えてみてください。</p>
<p><strong><span class="asset  asset-generic at-xid-6a0167607c2431970b0240a4cf4776200d img-responsive"><a href="https://adndevblog.typepad.com/files/viewer.htm">Viewer.htm をダウンロード</a></span></strong></p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b01b8d222c3e4970c img-responsive">Viewer.htmの後に ? でパラメータを接続して、パラメータ間は &amp; で統合します。例えば、Access Token が&#0160;<span style="background-color: #ffff80;">eyJhbGciOiJIUzI1NiIsImtpZCI6Imp3dF9zeW1tZXRyaWNfa2V5In0.eyJjbGllbnRfaWQiOiJWMlpQcmNaR242eWVqTXRSNzZHM2lMR2pxRng</span>、ドキュメント ID（URN）が&#0160;<span style="background-color: #80ffff;">dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6ZnBkLWphcGFuLXNhbXBsZS1idWNrZXQvQmlrZSUyMGZyYW1lLmYzZA==</span>&#0160;の場合、C:\Forge-Workshop フォルダにダウンロード済みの Viewer.htm で表示するには、次のような指定で表示するドキュメントを引き渡すことが出来ます。</span></p>
<p><span class="asset  asset-generic at-xid-6a0167607c2431970b01b8d222c3e4970c img-responsive">file:///C:/Forge-Workshop/viewer.htm?accessToken=<span style="background-color: #ffff80;">eyJhbGciOiJIUzI1NiIsImtpZCI6Imp3dF9zeW1tZXRyaWNfa2V5In0.eyJjbGllbnRfaWQiOiJWMlpQcmNaR242eWVqTXRSNzZHM2lMR2pxRng</span>&amp;urn=<span style="background-color: #80ffff;">dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6ZnBkLWphcGFuLXNhbXBsZS1idWNrZXQvQmlrZSUyMGZyYW1lLmYzZA==</span></span></p>
<p><a class="asset-img-link" href="https://adndevblog.typepad.com/.a/6a0167607c2431970b0240a4a62728200c-pi"><img alt="Viewer" border="0" class="asset  asset-image at-xid-6a0167607c2431970b0240a4a62728200c image-full img-responsive" src="/assets/image_982240.jpg" title="Viewer" /></a></p>
URL パラメータとして Access Token を渡した場合、Web ブラウザが持つ&#0160;<strong><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/HTTP_access_control" rel="noopener noreferrer" target="_blank">CORS(Cross-Origin Resource Sharing)</a></strong>&#0160; を抑止するセキュリティ上の制限によって、表示が出来ない場合があります（ブラウザ依存）。Google Chrome の場合には、No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource. 等のエラーが発生してしまいますので、Chrome の起動ショートカットにパラメータ、<strong>--disable-web-security --user-data-dir</strong>、または、<strong>--allow-file-access-from-files --allow-file-access --allow-cross-origin-auth-prompt</strong> を指定することで、このセキュリティ機能を無効化して開発時のテストをおこなうことが出来ます。もちろん、一般利用時には、この設定での Chrome 起動はお勧めしません。ご注意ください。
<p><br /><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d2e545d9970c-pi" style="display: inline;"><img alt="Chrome_disable_web_security" class="asset  asset-image at-xid-6a0167607c2431970b01b8d2e545d9970c img-responsive" src="/assets/image_67814.jpg" title="Chrome_disable_web_security" /></a></p>
</li>
</ol>
<hr />
<p>ここまでの実装で、アップロードしたデザインファイルを変換して Forge Viewer に表示することが出来るはずです。このコードを拡張することで、実際の運用で利用する処理を実装してみてください。現実には dmSample.js と連携する HTML ファイルを定義して、ボタンなどを配置し、ユーザ アクションをトリガに処理をすすめるのが一般的と思います。</p>
<p>Viewer 表示の自動化を書いたブログ記事も&#0160;<strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/05/forge-nodejs-quick-start-part3.html" rel="noopener noreferrer" target="_blank">付録</a></strong> として記載していますので、必要に応じてご確認ください。</p>
<p>By Toshiaki Isezaki&#0160;</p>
