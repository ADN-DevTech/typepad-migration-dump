---
layout: "post"
title: "AutoCAD アドオン開発者のための Revit API 入門 ～ マクロ"
date: "2014-01-31 00:12:29"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2014/01/understanding-revit-api-for-autocad-addon-developers-part3.html "
typepad_basename: "understanding-revit-api-for-autocad-addon-developers-part3"
typepad_status: "Publish"
---

<p>今回は、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2014/01/understanding-revit-api-for-autocad-addon-developers-part2.html" target="_blank">アドイン</a>&#0160;</strong>に続いて、Revit API を使うもう一つのカスタマイズ形態である <strong>マクロ</strong> についてご紹介します。マクロは Revit 製品に組み込まれてインストールされる &#0160;<a href="http://www.icsharpcode.net/OpenSource/SD/" target="_blank"><strong>SharpDevelop</strong></a>&#0160;を開発環境として利用します。マクロの開発環境は、Revit 2012 まで Microsoft 社の&#0160;<a href="http://msdn.microsoft.com/ja-jp/magazine/ee517435.aspx" target="_blank">VSTA（Visual Studio Tools For Applications）</a>を利用していましたが、Revit 自身が利用する .NET Framework に追従するために、Revit 2013 から SharpDevelop に変更されました。どちらの開発環境も、.NET Framework をベースにした開発プラットフォームで、アプリケーション埋め込みのマクロを作成する機能を提供します。</p>
<p>マクロを開発するには、Revit の [管理] タブにある &#0160;[マクロ] リボンパネル にある [マクロ マネージャ] ボタンから SharpDevelop にアクセスします。[マクロ] リボンパネルには、この他にも [マクロ セキュリティ] ボタンが用意されています。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b019b03d672a1970d-pi" style="display: inline;"><img alt="Macro" border="0" class="asset  asset-image at-xid-6a0167607c2431970b019b03d672a1970d image-full img-responsive" src="/assets/image_530935.jpg" title="Macro" /></a></p>
<p>SharpDevelop の開発画面を表示するには、作成しようとするマクロを、どのレベルで利用するものとするか決定しなければなりません。選択肢は、<strong>アプリケーション レベル マクロ</strong> と <strong>ドキュメント レベル マクロ</strong> の 2 つです。マクロ タイプについては、後で説明することにします。SharpDevelop の画面ですが、残念ながら英語版での提供になります。SharpDevelop 自体はオープン ソースであるため、有志の方々によって<a href="http://sourceforge.jp/projects/sharpdevelop-jp/" target="_blank">日本語化</a>されていますが、Revit 上での使用は製品と一緒にインストールされた英語版のみとなりますので、注意が必要です。</p>
<p>SharpDevelop の画面構成は Visual Studio に似ているので、Visual Studio の使用経験をお持ちであれば、さほど迷うことはないように思えます。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b019b03db9748970d-pi" style="display: inline;"><img alt="SharpDevelop" border="0" class="asset  asset-image at-xid-6a0167607c2431970b019b03db9748970d image-full img-responsive" src="/assets/image_378840.jpg" title="SharpDevelop" /></a></p>
<p>さて、マクロというと VBA と勘違いされる方もいらっしゃると思いますので、念のため違いもご紹介しておきましょう。VBA は Microsoft &#0160;社がオートデスクにライセンスて提供して、AutoCAD や Inventor に組み込んで提供しています。VBA が利用するテクノロジは COM なので、Revit API がベースとしている .NET Framework とは自ずと異なります。簡単にまとめると、次のようになります。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a50fff0c8c970c-pi" style="display: inline;"><img alt="VBA_SharpDevelop" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a50fff0c8c970c image-full img-responsive" src="/assets/image_960879.jpg" title="VBA_SharpDevelop" /></a></p>
<p style="text-align: left;">最も大きな違いは、SharpDevelop で作成したマクロの実行前には、事前にプログラムをビルド（コンパイル）しておく必要がある、という点です。Revit API が .NET Framework ベースであることに起因するものですが、ビルド時に表示されるエラーはすべて修正しておく必要があるので、VBA に比べるとあまり「気軽」ではないかも知れません。&#0160;VBA の場合には、インタプリタ言語の特性から、実行時にプログラムを解釈するため、事前ビルドの必要性がありません。</p>
<p><strong>ドキュメント レベル マクロ</strong></p>
<p>ドキュメント レベル マクロは、Revit プロジェクト（.rvt）ファイルや ファミリ ドキュメント ファイル（.rfa）ファイル内でのみ利用できるマクロで、保存場所は各ドキュメント ファイルとなります。つまり、作成したマクロは、ドキュメントに埋め込まれるようになります。マクロが実行できるのは、マクロが埋め込まれたドキュメントを Revit で開いているときのみです。逆に、ドキュメントを関連業者などに渡すことで、相手先の Revit でドキュメントを開いて、埋め込まれたマクロを実行することが出来ます。&#0160;</p>
<p>Revit 上でマクロが埋め込まれたドキュメント ファイルを 開こうとすると、次のような警告メッセージが表示されます。悪意のある不正なマクロ プログラムが実行されないように、マクロの存在を事前に把握していない場合には、マクロを無効にすることも出来ます。</p>
<p style="text-align: center;">&#0160; <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b019b03e3b17d970d-pi" style="display: inline;"><img alt="Warning" class="asset  asset-image at-xid-6a0167607c2431970b019b03e3b17d970d" src="/assets/image_506680.jpg" title="Warning" /></a></p>
<p>ドキュメント レベル マクロを作成すると、次のようなスケルトン コードが自動的に生成されます。あとは、指定したマクロ箇所に、処理したい内容のプログラムを書き込んでデバッグ、ビルドをしていくことになります。</p>
<table align="left" border="0" cellpadding="0" cellspacing="0" class="auto-style3" style="mso-cellspacing: 0mm; background: #F2F2F2; mso-shading: windowtext; mso-pattern: gray-5 auto; mso-yfti-tbllook: 1184; mso-table-lspace: 7.1pt; margin-left: 4.85pt; mso-table-rspace: 7.1pt; margin-right: 4.85pt; mso-table-anchor-vertical: margin; mso-table-anchor-horizontal: margin; mso-table-left: left; mso-table-top: 26.3pt; mso-padding-alt: 0mm 5.4pt 0mm 5.4pt; width: 100%;">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="width: 435.1pt; padding: 0mm 5.4pt 0mm 5.4pt;" valign="top" width="580">
<p style="text-align: left; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; mso-pagination: widow-orphan; layout-grid-mode: char; mso-element: frame; mso-element-frame-hspace: 7.1pt; mso-element-wrap: around; mso-element-anchor-horizontal: margin; mso-element-top: 26.3pt; mso-height-rule: exactly; font-family: &#39;Courier New&#39;; font-size: small; overflow: auto;"><span style="color: #111111;"><span style="font-weight: bold;">namespace</span>&#0160;CSharp_Doc_Macro</span><br /><span style="color: #111111;"> {</span><br /><span style="color: #111111;"> &#0160;&#0160;[Autodesk.Revit.Attributes.Transaction(</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160; Autodesk.Revit.Attributes.TransactionMode.Manual)]</span><br /><span style="color: #111111;"> &#0160;&#0160;[Autodesk.Revit.DB.Macros.AddInId(<br /> &#0160;&#0160;&#0160; &quot;D0796EDE-E8E4-493B-9157-A8C639F045CF&quot;)]</span><br /><span style="color: #111111;"> &#0160;&#0160;public&#0160;partial&#0160;class&#0160;<span style="color: #0000ff;"><strong>ThisDocument</strong></span></span><br /><span style="color: #111111;"> &#0160;&#0160;{</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;private&#0160;void&#0160;Module_Startup(object&#0160;sender,&#0160;EventArgs e)</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;{</span><br /> <br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;}</span><br /> <br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;private&#0160;void&#0160;Module_Shutdown(object&#0160;sender,&#0160;EventArgs e)</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;{</span><br /> <br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;}</span><br /> <br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;#region&#0160;Revit Macros generated code</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;private&#0160;void&#0160;InternalStartup()</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;{</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;&#0160;&#0160;this.Startup&#0160;+=</span><br /><span style="color: #111111;">&#0160; &#0160; &#0160; &#0160;&#0160;new&#0160;System.EventHandler(Module_Startup);</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;&#0160;&#0160;this.Shutdown&#0160;+=</span><br /><span style="color: #111111;">&#0160; &#0160; &#0160; &#0160;&#0160;new&#0160;System.EventHandler(Module_Shutdown);</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;}</span><br /><span style="color: #111111;"> &#0160;&#0160;&#0160;&#0160;#endregion<span style="font-weight: bold;"><br /> <span style="font-family: &#39;Courier New&#39;; font-size: small; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #f2f2f2; float: none; display: inline !important;"> <br /> &#0160;&#0160;&#0160; public void<span class="Apple-converted-space">&#0160;</span></span><strong style="color: #000000; font-family: &#39;Courier New&#39;; font-size: small; font-style: normal; font-variant: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #f2f2f2;">HelloWorld()</strong><br style="color: #000000; font-family: &#39;Courier New&#39;; font-size: small; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #f2f2f2;" /> <span style="font-family: &#39;Courier New&#39;; font-size: small; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #f2f2f2; float: none; display: inline !important;"> &#0160;&#0160;&#0160; {</span><br style="color: #000000; font-family: &#39;Courier New&#39;; font-size: small; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #f2f2f2;" /> <span style="font-family: &#39;Courier New&#39;; font-size: small; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: #f2f2f2; float: none; display: inline !important;"> &#0160;&#0160;&#0160; }</span></span></span><br /><span style="color: #111111;"> &#0160;&#0160;}</span><br /><span style="color: #111111;"> }</span></p>
</td>
</tr>
</tbody>
</table>
<p>&#0160;</p>
<p><strong>アプリケーション レベル マクロ</strong></p>
<p>アプリケーション レベル マクロは、Revit がインストールされたコンピュータでドキュメントに依存せるに利用できるマクロです。作成したマクロは、C:\ProgramData\Autodesk\Revit\Macros\2014\Revit\AppHookup フォルダ直下に、作成したマクロ モジュール名ごとにフォルダが用意されて保存されています。&#0160;この場所にマクロが保存されていれば、Revit がマクロを認識して [マクロ マネージャ] ダイアログに表示されます。</p>
<p>アプリケーション レベル&#0160;マクロを作成した場合も、ドキュメント レベル マクロようなにスケルトン コードが自動的に生成されます。 &#0160;次の例は、HelloWorld マクロ名を指定して生成されたスケルトン コードです。</p>
<table align="left" border="0" cellpadding="0" cellspacing="0" class="auto-style3" style="margin-left: 4.85pt; margin-right: 4.85pt; width: 100%; height: 482px; background-color: #f2f2f2;">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="width: 435.1pt; padding: 0mm 5.4pt 0mm 5.4pt;" valign="top" width="580">
<p style="text-align: left; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; mso-pagination: widow-orphan; layout-grid-mode: char; mso-element: frame; mso-element-frame-hspace: 7.1pt; mso-element-wrap: around; mso-element-anchor-horizontal: margin; mso-element-top: 26.3pt; mso-height-rule: exactly; font-family: &#39;Courier New&#39;; font-size: small;">namespace CSharp_App_Macro<br /> {<br />&#0160; [Autodesk.Revit.Attributes.Transaction(<br />&#0160; &#0160; Autodesk.Revit.Attributes.TransactionMode.Manual)]<br /> &#0160; [Autodesk.Revit.DB.Macros.AddInId(<br />&#0160; &#0160; &quot;72F8ED34-B252-449B-A725-8B8FA9F32BAF&quot;)]<br /> &#0160; public partial class <span style="color: #0000ff;"><strong>ThisApplication</strong></span><br /> &#0160; {<br /> &#0160;&#0160;&#0160; private void Module_Startup(object sender, EventArgs e)<br /> &#0160;&#0160;&#0160; {<br /> <br /> &#0160;&#0160;&#0160; }<br /> <br /> &#0160;&#0160;&#0160; private void Module_Shutdown(object sender, EventArgs e)<br /> &#0160;&#0160;&#0160; {<br /> <br /> &#0160;&#0160;&#0160; }<br /> <br /> &#0160;&#0160;&#0160; #region Revit Macros generated code<br /> &#0160;&#0160;&#0160; private void InternalStartup()<br /> &#0160;&#0160;&#0160; {<br /> &#0160;&#0160;&#0160;&#0160;&#0160; this.Startup += <br />&#0160; &#0160; &#0160; &#0160; new System.EventHandler(Module_Startup);<br /> &#0160;&#0160;&#0160;&#0160;&#0160; this.Shutdown +=<br />&#0160; &#0160; &#0160; &#0160; new System.EventHandler(Module_Shutdown);<br /> &#0160;&#0160;&#0160; }<br /> &#0160;&#0160;&#0160; #endregion<br /> <br />&#0160;&#0160;&#0160; public void <strong>HelloWorld()</strong><br /> &#0160;&#0160;&#0160; {<br /> &#0160;&#0160;&#0160; }<br /> &#0160; }<br /> }</p>
</td>
</tr>
</tbody>
</table>
<p>&#0160;</p>
<p style="text-align: left;"><strong>開発手順</strong></p>
<p style="text-align: left;">具体的な開発の手順と画面遷移は、次のとおりです。</p>
<p style="padding-left: 30px;">1. [管理] タブの [マクロ マネージャ] を起動します。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fb5625dd970b-pi" style="display: inline;"><img alt="Step1" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a3fb5625dd970b img-responsive" src="/assets/image_418785.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Step1" /></a></p>
<p style="padding-left: 30px;">2. アプリケーション レベル マクロ&#0160;と&#0160;ドキュメント レベル マクロのいずれかを選択します。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fb5626c5970b-pi" style="display: inline;"><img alt="Step2" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a3fb5626c5970b image-full img-responsive" src="/assets/image_644051.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Step2" /></a></p>
<p style="padding-left: 30px;">3. [マクロ マネージャ] ダイアログ上で開発言語を選択してモジュールを作成します。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fb5629b3970b-pi" style="display: inline;"><img alt="Step3" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a3fb5629b3970b image-full img-responsive" src="/assets/image_843513.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Step3" /></a><br />4. [マクロ マネージャ] ダイアログ上でモジュール内にマクロを定義します。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a5100606f9970c-pi" style="display: inline;"><img alt="Step4" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a5100606f9970c image-full img-responsive" src="/assets/image_349511.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Step4" /></a><br />5. プログラム コードの編集画面へ移動します（SharpDevelop 画面の表示）。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a5100607d5970c-pi" style="display: inline;"><img alt="Step5" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a5100607d5970c image-full img-responsive" src="/assets/image_48082.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Step5" /></a><br />6. プログラム コードを編集画面へ入力します。</p>
<p style="padding-left: 30px;">7. プログラムをビルドして、表示されるエラーを順次修正していきます。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b019b03e2b1c9970d-pi" style="display: inline;"><img alt="Step7" border="0" class="asset  asset-image at-xid-6a0167607c2431970b019b03e2b1c9970d image-full img-responsive" src="/assets/image_198724.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Step7" /></a><br />8. Revit 画面に戻り、[マクロ マネージャ] ダイアログ上で [実行] ボタンからマクロを実行します。</p>
<p style="text-align: left; padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fb562d93970b-pi" style="display: inline;"><img alt="Step8" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a3fb562d93970b img-responsive" src="/assets/image_227686.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Step8" /></a></p>
<p style="text-align: left;"><strong>マクロ タイプの違いによる留意点</strong></p>
<p>ドキュメント レベル マクロやアプリケーション レベル マクロには、物理的なプログラム上にも留意すべき差があります。クラス定義された主体となるオブジェクトの違いで、Revit API を利用する際に重要となる Application、UIApplication、Document、UIDocument オブジェクトの取得方法が変わってくる点です。コード上では、ThisDocument クラス名と ThisApplication のクラス名で、クラスが表しているオブジェクトを判断できます。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fb5a1441970b-pi" style="display: inline;"><img alt="AddIn_Macro_differences" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a3fb5a1441970b image-full img-responsive" src="/assets/image_844263.jpg" title="AddIn_Macro_differences" /></a></p>
<p style="text-align: left;"><strong>マクロ セキュリティ</strong></p>
<p style="text-align: left;">ドキュメント レベル マクロやアプリケーション レベル マクロも、Revit のセキュリティ設定で振る舞いを指定しておくことが出来ます。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fb5b3262970b-pi" style="display: inline;"><img alt="Security_options" class="asset  asset-image at-xid-6a0167607c2431970b01a3fb5b3262970b" src="/assets/image_203758.jpg" style="width: 430px;" title="Security_options" /></a>&#0160;</p>
<p style="text-align: left;"><strong>マクロとアドインの違い</strong></p>
<p style="text-align: left;">アドインもマクロも .NET Framework ベース の Revit API を利用するので、プログラム上の内容差はあまりありません。ただ、差別化はされています。次の図は、それらを比較して説明するものです。&#0160;</p>
<p style="text-align: left;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fb4f31e2970b-pi" style="display: inline;"><img alt="Macro_AddIn" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01a3fb4f31e2970b image-full img-responsive" src="/assets/image_925914.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="Macro_AddIn" /></a></p>
<p style="text-align: left;">アドイン マニフェストを作成する手間が省けるので、マクロは簡単に Revit API を評価したり、設計上の反復操作を自動化するのには適していると言えます。ただし、リボン インタフェースへのボタン登録には対応できないので、毎回、マクロ マネージャを起動して実行する必要があります。</p>
<p style="text-align: left;">また、マクロで有用なツールを作成しても、Autodesk Exchange Apps ストアへのアプリケーション提出・公開が出来ません。</p>
<p style="text-align: left;">By Toshiaki Isezaki&#0160;</p>
<p style="text-align: left;">&#0160;</p>
