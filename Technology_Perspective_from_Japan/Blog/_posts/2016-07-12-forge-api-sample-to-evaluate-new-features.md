---
layout: "post"
title: "新しい機能を評価する Forge API サンプル"
date: "2016-07-12 01:03:13"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2016/07/forge-api-sample-to-evaluate-new-features.html "
typepad_basename: "forge-api-sample-to-evaluate-new-features"
typepad_status: "Publish"
---

<p>Forge DevCon で登場した API に Model Derivative API と &#0160;があります。以前、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/06/about-changes-of-forge-platform-api.html" target="_blank">ご紹介</a></strong>したとおり、両者の一部の機能は、もともと、View and Data API に実装されていたものですが、新しく導入された機能も存在します。</p>
<p>Model Derivative API では、アップロードしたデザイン ファイルを別のデザイン ファイルに変換する機能が該当します。また、Data Management API では、A360 や Fusion 360 で利用するユーザ ストレージ領域にアクセスする機能が新規に提供されています。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d202c310970c-pi" style="display: inline;"><img alt="New_apis" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d202c310970c image-full img-responsive" src="/assets/image_801568.jpg" title="New_apis" /></a></p>
<p><strong><a href="https://developer.autodesk.com/" target="_blank">デベロッパ ポータル</a></strong>&#0160;からアクセス可能な GitHub 上の <a href="https://github.com/Developer-Autodesk" target="_blank"><strong>Forge サイト（https://github.com/Developer-Autodesk）</strong></a>には、これら API を利用して新しい機能を評価するためのサンプル<strong> <a href="https://github.com/Developer-Autodesk/model.derivative.api-nodejs-sample" target="_blank">model.derivative.api-nodejs-sample</a></strong>&#0160;が公開されています。</p>
<p>もちろん、このサンプルを試すには、Consumer Key や Consumer Secret の置き換えなどのセットアップが必要です。また、Data Management API で A360 ストレージのユーザ領域にアクセスするには、3-legged 認証によって、ユーザからアクセスに必要な許可を得る必要があります。この手順の中では、Consumer Key と Consumer Secret を取得するために登録したアプリ情報にあった Callback URL を正しく設定しておく必要があります。</p>
<p>今回は、サンプル&#0160;model.derivative.api-nodejs-sample のセットアップについて、ご案内したいと思います。なお、<span style="background-color: #ffff00;">ここでは、以前ご紹介した&#0160;Windows を利用した&#0160;<strong><a href="http://adndevblog.typepad.com/technology_perspective/2015/08/setup-development-environment-view-and-data-api.html" style="background-color: #ffff00;" target="_blank">開発環境</a></strong>&#0160;を前提に説明を進めていくことにします。<br /><br /><strong><span style="background-color: #ffffff;">セットアップ</span></strong></span></p>
<ol>
<li>&#0160;Autodesk ID を使ってデベロッパ ポータル（<strong><a href="https://developer.autodesk.com/" target="_blank">https://developer.autodesk.com/</a></strong>）にサインインして、My Apps にアプリを登録します。Autodesk ID をお持ちでない方のサインアップの方法も含め、登録の手順を、過去のブログ記事 <a href="http://adndevblog.typepad.com/technology_perspective/2016/07/app-registration-and-getting-keys-for-forge-api.html" target="_blank">F<strong>orge API を利用するアプリの登録とキーの取得</strong></a>&#0160;でご案内していますのでご参照ください。<br /><br />アプリ登録の際には、Select the APIs you want to use in your app 欄から Model Derivative API と Data Management API にチェックを入れてください。また、Callback URL には、このサンプルをクライアント コンピュータでローカルに使用する <strong>http://dev.example.com:8000/api/autodesk/callback</strong>&#0160;を指定します。<br /><br />既にアプリが登録されている場合には、個々のアプリ ページ下部にある [EDIT &gt; ] リンクから、使用する API や Callback URL を編集することが出来ます。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb091c8b29970d-pi" style="display: inline;"><img alt="1.register_app" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb091c8b29970d image-full img-responsive" src="/assets/image_446536.jpg" title="1.register_app" /></a><br /><br /></li>
<li>お使いになるクライアント コンピュータの Node.js で Callback URL が正しく認識されるよう、Windows の Hosts ファイルにホスト名を追記します（参考：<a href="https://support.microsoft.com/ja-jp/kb/972034" target="_blank">https://support.microsoft.com/ja-jp/kb/972034</a>）。<span style="text-decoration: underline;">管理者権限</span>で起動したメモ帳で C:\Windows\System32\drivers\etc フォルダ直下 \hosts &#0160;を開いて、最後に次の太字の 1 行&#0160;<strong>127.0.0.1 dev.example.com&#0160;</strong>&#0160;を追加して上書き保存します。<br />
<pre># Copyright (c) 1993-2009 Microsoft Corp.<br />#<br /># This is a sample HOSTS file used by Microsoft TCP/IP for Windows.<br />#<br /># This file contains the mappings of IP addresses to host names. Each<br /># entry should be kept on an individual line. The IP address should<br /># be placed in the first column followed by the corresponding host name.<br /># The IP address and the host name should be separated by at least one<br /># space.<br />#<br /># Additionally, comments (such as these) may be inserted on individual<br /># lines or following the machine name denoted by a &#39;#&#39; symbol.<br />#<br /># For example:<br />#<br /># 102.54.94.97 rhino.acme.com # source server<br /># 38.25.63.10 x.acme.com # x client host<br /><br /># localhost name resolution is handled within DNS itself.<br /># 127.0.0.1 localhost<br /># ::1 localhost<br /><strong>127.0.0.1 dev.example.com</strong></pre>
</li>
<li>Web ブラウザで GitHub 上の&#0160;<strong><a href="https://github.com/Developer-Autodesk/model.derivative.api-nodejs-sample" target="_blank">model.derivative.api-nodejs-sample</a></strong>&#0160;リポジトリ ページを開きます。<br /><br /></li>
<li>画面右側の [Clone or download] ボタンをクリックして、表示される URL &#0160;<strong>https://github.com/Developer-Autodesk/model.derivative.api-nodejs-sample.git</strong> を<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89" target="_blank">クリップボード</a>にコピーておきます。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d202ceee970c-pi" style="display: inline;"><img alt="2.clone_git_repository" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d202ceee970c image-full img-responsive" src="/assets/image_69841.jpg" title="2.clone_git_repository" /></a><br /><br /></li>
<li>GitHub リポジトリから開発で使用するクライアント コンピュータにコピーします。Git Shell を起動して、<strong>git clone&#0160;https://github.com/Developer-Autodesk/model.derivative.api-nodejs-sample.git</strong> と入力します。この処理が完了すると、C:\Users\&lt;Windows ログイン ユーザ名&gt;\Documents\GitHub フォルダ下に &#0160;model.derivative.api-nodejs-sample フォルダが作成され、GitHub リポジトリからソースコードがコピーされます。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d202cfa7970c-pi" style="display: inline;"><img alt="3.clone_git_repository" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d202cfa7970c image-full img-responsive" src="/assets/image_669438.jpg" title="3.clone_git_repository" /></a><br /><br /></li>
<li>コピーされたプロジェクトに Node で必要となるパッケージをインストールします。Node.js command prompt を起動して、現在のフォルダを C:\Users\&lt;Windows ログイン ユーザ名&gt;\Documents\GitHub\model.derivative.api-nodejs-sample フォルダに移動後に、<strong>npm install</strong> と入力します。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb091c82c7970d-pi" style="display: inline;"><img alt="4.install_node_package" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb091c82c7970d image-full img-responsive" src="/assets/image_67308.jpg" title="4.install_node_package" /></a><br /><br /></li>
<li>model.derivative.api-nodejs-sample は、<a href="https://github.com/Developer-Autodesk/view-and-data-npm" target="_blank">view-and-data-npm</a>&#0160;として公開されている Node パッケージを使用しています。6. でインストールした Node パッケージの中から、view-and-data-npm パッケージの一部に変更を加えます。model.derivative.api-nodejs-sample フォルダ下の node_modules/view-and-data/view-and-data.js ファイルを Adobe Brackets で開いたら、127 行目の params 変数定義を見つけて次の太字の Scope を追記してください。grant_type: &#39;client_credentials&#39; 行の最後に <strong>,</strong> （カンマ）を忘れずに入力してください。<br />
<pre><code>var params = {
    client_secret: config.credentials.ConsumerSecret,
    client_id: config.credentials.ConsumerKey,
    grant_type: &#39;client_credentials&#39;<strong>,</strong>
    <strong>scope: &#39;data:read data:create data:write bucket:read bucket:create&#39;</strong>
  };<br /></code></pre>
</li>
<li>認証で使用する &#0160;Consumer Key と Consumer Secret を 1. で登録したものと置き換えます。GitHub リポジトリ ページで説明されているな内容ではシステム環境変数での指定も可能になっていますが、ここでは、ファイル ベースで直接書き換えをしてしまうことにします。<br /><br />Adobe Brackets で &#0160;model.derivative.api-nodejs-sample\routes フォルダの&#0160;<strong>config-prod.js</strong> を開いて、process.env.PROD_CONSUMERKEY の部分を Cosumer Key に、process.env.PROD_CONSUMERSECRET の部分を Consumer Secret に、それぞれ &#39; （シングル クォーテーション）で囲み、ファイルを上書き保存してください。この書き換えが終了したら、同じフォルダにある&#0160;<strong>config-dev.js</strong> と&#0160;<strong>config-stg.js</strong> の内容も同じように書き換えます。なお、下記の Consumer Key と Consumer Secret はダミーです。<br />
<pre>module.exports = {<br /> baseUrl: &#39;https://developer.api.autodesk.com&#39;,<br /> credentials: {<br /> consumerKey:<strong> &#39;4aJuQKN71yflFcQNMrO42ypAYSkySFrX&#39;,</strong><br /> consumerSecret: <strong>&#39;vzEHpJelEkW0yRI2&#39;</strong><br /> }<br />}</pre>
</li>
<li>続いて、このサンプルが使用する Callback URL と Bucket 名を指定します。Adobe Brackets で &#0160;model.derivative.api-nodejs-sample\routes フォルダの&#0160;<strong>config.js</strong> を開いて、redirectUrl の値で指定されている&#0160;process.env.CALLBACK_URL を<strong>&#0160;&#39;http://dev.example.com:8000/api/autodesk/callback&#39;</strong> で置き換えてください。<br /><br />また、ここには、このサンプル作者がテストで利用した既定値の Bucket 名が指定されていますが、この Bucket は第3者がアクセスすることは出来ません。お使いになるユニークな Bucket 名を指定してください。なお、下記の Bucket 名はダミーです。<br />
<pre>var OAUTH_VERSION = &#39;v1&#39;; // Authentication<br />var OSS_VERSION = &#39;v2&#39;; // OSS storage system<br />var DM_PROJECT_VERSION = &#39;v1&#39;; // Data Management<br />var MD_PROJECT_VERSION = &#39;v2&#39;; // Model Derivative<br /><br />module.exports = {<br /> redirectUrl: <strong>&#39;http://dev.example.com:8000/api/autodesk/callback&#39;,</strong><br /><br /> defaultBucketKey: <strong>&quot;adn-japan-isezaki1&quot;,</strong><br /><br /> authenticationUrl: &#39;/authentication/&#39; + OAUTH_VERSION + &#39;/authorize&#39;,<br /> accessTokenUrl: &#39;/authentication/&#39; + OAUTH_VERSION + &#39;/gettoken&#39;,<br /> usersMe: &#39;/userprofile/&#39; + OAUTH_VERSION + &#39;/users/@me&#39;,</pre>
</li>
<li>ここまでの手順で、<strong><a href="https://github.com/Developer-Autodesk/model.derivative.api-nodejs-sample" target="_blank">model.derivative.api-nodejs-sample</a>&#0160;</strong>のセットアップが完了です。Node.js command &#0160;prompt を起動して、現在のフォルダが&#0160;model.derivative.api-nodejs-sample フォルダになっていることを確認したら、<strong>node index.js</strong> と入力して Web サーバーを起動してください。その後、WebGL 対応の Web ブラウザで&#0160;<strong>http://dev.example.com:8000/</strong>&#0160;を開いてください。</li>
</ol>
<p><strong>動作テスト</strong></p>
<p style="padding-left: 30px;">画面上の [Log In] ボタン隣のコンボボックスで <strong>Production</strong>&#0160; を選択してから、[Log In] ボタンをクリックすると、Callback URL &#0160;にリダイレクトされてオートデスクのクラウド サービスにアクセスするためのサインイン画面に遷移します。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb091c91e1970d-pi" style="display: inline;"><img alt="Signin" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb091c91e1970d image-full img-responsive" src="/assets/image_178968.jpg" title="Signin" /></a></p>
<p style="padding-left: 30px;">サインインの際に A360 上にプロジェクトを持つ Autodesk ID を使用すると、A360 プロジェクトとファイルにアクセスすることが出来るはずです。これが、Data Management API の機能です。</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c8790d54970b-pi" style="display: inline;"><img alt="10.completion" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c8790d54970b image-full img-responsive" src="/assets/image_609468.jpg" style="display: block; margin-left: auto; margin-right: auto;" title="10.completion" /></a></p>
<p style="padding-left: 30px;">なお、このサイトで初めて使用する Autodesk ID でサインインした場合には、A360 のユーザ ストレージ領域にアクセスする許可を求めるページが表示されるはずです。OAuth の 3-legged 認証の作用でもあります。</p>
<p style="text-align: center;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d202dd9a970c-pi" style="display: inline;"><img alt="Signin_permisson" class="asset  asset-image at-xid-6a0167607c2431970b01b8d202dd9a970c img-responsive" src="/assets/image_691788.jpg" title="Signin_permisson" /></a></p>
<p style="padding-left: 30px;">もちろん、 プロジェクト内のツリーからデザイン ファイルをクリックすると、Viewer 上にデザインを表示させることが出来ます。A360 プロジェクト内の同一ファイルであっても、時計アイコンでバージョンが個別に示されていて、それぞれを表示したり、モデル内の属性を取得したりすることが出来ます。</p>
<p style="padding-left: 30px;">選択したデザイン ファイルは、ファイル形式毎にサポートされている他のファイル形式に変換、ダウンロードすることが出来ます。これは、Model Derivative API の新しい機能です。</p>
<p style="padding-left: 30px;">ここまでの手順を動画にしましたので、ご確認ください。A360 プロジェクトにアクセスして、Fusion 360 ファイル（.f3d）である腕時計のデータを表示、その属性を参照した後、STEP ファイルに変換してダウンロードしています。また、ダウンロードした STEP ファイルを AutoCAD にインポートしています。</p>
<p style="padding-left: 30px;"><iframe allowfullscreen="" frameborder="0" height="344" src="https://www.youtube.com/embed/xfZ2HAea_dE?feature=oembed" width="459"></iframe>&#0160;</p>
<p>By Toshiaki Isezaki</p>
