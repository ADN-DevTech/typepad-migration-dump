---
layout: "post"
title: "3-legged 認証 Forge API サンプル"
date: "2017-01-13 00:42:07"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "クラウドサービス"
original_url: "https://adndevblog.typepad.com/technology_perspective/2017/01/forge-api-sample-to-evaluate-3-legged-authentication.html "
typepad_basename: "forge-api-sample-to-evaluate-3-legged-authentication"
typepad_status: "Publish"
---

<p>Model Derivative API と Data Management API を評価出来るサンプルとして、以前、<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/07/forge-api-sample-to-evaluate-new-features.html" rel="noopener noreferrer" target="_blank">新しい機能を評価する Forge API サンプル</a></strong>&#0160;のブログ記事をご紹介したことがあります。その後、2016 年 11 月の&#0160;<strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/11/au-japan-and-forge-uodate-information-part1.html" rel="noopener noreferrer" target="_blank">新機能の追加</a></strong>&#0160;にともない、Callback URL などの一部の処理も含め、GitHub リポジトリの内容が変更されていて、従来のブログ記事の手順ではローカル コンピュータでのセットアップが出来なくなっています。今回は、新しく更新された <strong><a href="https://github.com/Autodesk-Forge/model.derivative-nodejs-sample" rel="noopener noreferrer" target="_blank">model.derivative-nodejs-sample</a></strong>&#0160;サンプルのローカルコンピュータへのセットアップについて、再度をまとめておきたいと思います。</p>
<p>リポジトリの内容からローカル ブランチを作成するには、事前に Git Shell や Node.js をセットアップしておく必要があります。また、ブランチ内のソースコードを編集していく過程では、Forge で利用する Client ID と Client Secret（Consumer Key と Consumer Secret）を事前に&#0160;<strong><a href="https://developer.autodesk.com/" rel="noopener noreferrer" target="_blank">デベロッパ ポータル</a></strong>&#0160;から取得しておく必要があります。これらの手順は、それぞれ、次のブログ記事でご案内しています。</p>
<p style="padding-left: 30px;"><strong><a href="http://adndevblog.typepad.com/technology_perspective/2017/1/development-environment-for-forge.html" rel="noopener noreferrer" target="_blank">Forge の開発環境</a></strong></p>
<p style="padding-left: 30px;"><strong><a href="http://adndevblog.typepad.com/technology_perspective/2016/07/app-registration-and-getting-keys-for-forge-api.html" rel="noopener noreferrer" target="_blank">Forge API を利用するアプリの登録とキーの取得</a></strong></p>
<hr />
<p><strong>セットアップ</strong></p>
<ol>
<li>&#0160;Autodesk ID でデベロッパ ポータルにサインインして、My Apps にアプリを登録します。アプリ登録の際には、Select the APIs you want to use in your app 欄から Model Derivative API と Data Management API にチェックを入れてください。また、Callback URL には、このサンプルをクライアント コンピュータでローカルに使用する <strong>http://localhost:3000/api/forge/callback/oauth</strong>&#0160;を指定します。<br />既にアプリが登録されている場合には、個々のアプリ ページ下部にある [EDIT &gt; ] リンクから、使用する API や Callback URL を編集することが出来ます。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb0966fd74970d-pi" style="display: inline;"><img alt="My_app" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb0966fd74970d image-full img-responsive" src="/assets/image_838104.jpg" title="My_app" /></a></li>
<li>Web ブラウザで GitHub 上の&#0160;<strong><a href="https://github.com/Autodesk-Forge/model.derivative-nodejs-sample" rel="noopener noreferrer" target="_blank">model.derivative-nodejs-sample</a></strong>&#0160;リポジトリ ページを開きます。</li>
<li>画面右側の [Clone or download] ボタンをクリックして、表示される URL &#0160;<strong>https://github.com/Autodesk-Forge/model.derivative-nodejs-sample.git</strong>&#0160;を<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89" rel="noopener noreferrer" target="_blank">クリップボード</a>にコピーておきます。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c8c41167970b-pi" style="display: inline;"><img alt="Copy_repository_url" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c8c41167970b image-full img-responsive" src="/assets/image_613889.jpg" title="Copy_repository_url" /></a></li>
<li>GitHub 上のプロジェクトを&#0160;、リポジトリから開発に使用するクライアント コンピュータにコピーします。Git Shell を起動して、<strong>git clone https://github.com/Autodesk-Forge/model.derivative-nodejs-sample.git&#0160;</strong>と入力します。この処理が完了すると、C:\Users\&lt;Windows ログイン ユーザ名&gt;\Documents\GitHub フォルダ下に &#0160;model.derivative-nodejs-sample フォルダが作成され、GitHub リポジトリからソースコードがコピーされます。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d24de40b970c-pi" style="display: inline;"><img alt="Clone_git_repository" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d24de40b970c image-full img-responsive" src="/assets/image_211480.jpg" title="Clone_git_repository" /></a></li>
<li>コピーされたプロジェクトに Node.js で必要となるミドルウェア パッケージをインストールします。Node.js command prompt を起動して、CD コマンドで現在のフォルダを C:\Users\&lt;Windows ログイン ユーザ名&gt;\Documents\GitHub\model.derivative-nodejs-sample フォルダへ移動してから、<strong>npm install</strong> と入力します。<br /> <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb0966fed8970d-pi" style="display: inline;"><img alt="Npm_install" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb0966fed8970d image-full img-responsive" src="/assets/image_356467.jpg" title="Npm_install" /></a></li>
<li>Node.js command prompt を使用して、1. で取得した Client ID と Clieent Secret を、環境変数 FORGE_CLIENT_ID と FORGE_CLIENT_SECRET に設定します。例えば、それぞれ、set FORGE_CLIENT_ID=Pj7SECpCP820kyYKa1wQKVAy04FK5oKn と set FORGE_CLIENT_SECRET=ZpAS0I4YuHyOEjbF を 1 行づつ入力します。<br /> <img alt="Set_developer_keys" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d24de4b0970c image-full img-responsive" src="/assets/image_470721.jpg" title="Set_developer_keys" /><br />この方法で環境変数を設定した場合は、コンピュータを再起動すると FORGE_CLIENT_ID と FORGE_CLIENT_SECRET は初期化されてしまうため、再設定が必要となります。<br />毎回、環境変数の設定をしたくない場合には、Windows の[環境変数] ダイアログを使って FORGE_CLIENT_ID と FORGE_CLIENT_SECRET を設定しておくか、model.derivative-nodejs-sample フォルダ直下の&#0160;server フォルダから config.js ファイルを見つけて、直接、Client ID と Client Secret を書き込むことも出来ます。<br />
<pre>module.exports = {<br /><br /> // this this callback URL when creating your client ID and secret<br /> callbackURL: process.env.FORGE_CALLBACK_URL || &#39;http://localhost:3000/api/forge/callback/oauth&#39;,<br /><br /> // set enviroment variables or hard-code here<br /> credentials: {<br /> client_id: process.env.FORGE_CLIENT_ID || &#39;<span style="background-color: #ffff00;"><strong>Pj7SECpCP820kyYKa1wQKVAy04FK5oKn</strong></span>&#39;,<br /> client_secret: process.env.FORGE_CLIENT_SECRET || &#39;<span style="background-color: #ffff00;"><strong>ZpAS0I4YuHyOEjbF</strong></span>&#39;<br /> },<br /><br /> // Required scopes for your application on server-side<br /> scopeInternal: &#39;data:read data:write data:create data:search bucket:create bucket:read bucket:update bucket:delete&#39;,<br /> // Required scope of the token sent to the client<br /> scopePublic: &#39;data:read&#39;<br />};</pre>
</li>
<li>Node.js command prompt 上で<strong> npm run dev</strong> と入力して、Web サーバーを起動します。<strong>node start.js</strong> と入力して Web サーバーを起動することも出来ます。</li>
<li>ここまでの手順でセットアップが完了です。WebGL 対応の Web ブラウザを開いて、<strong>http://localhost:3000/</strong>&#0160;の URL でページを開いてみてください。</li>
</ol>
<hr />
<p><strong>動作テスト</strong></p>
<p style="padding-left: 30px;">画面上の [Log In] ボタンをクリックすると、Callback URL &#0160;にリダイレクトされてオートデスクのクラウド サービスにアクセスするためのサインイン画面に遷移します。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d24de634970c-pi" style="display: inline;"><img alt="Login" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d24de634970c image-full img-responsive" src="/assets/image_125155.jpg" title="Login" /></a></p>
<p style="padding-left: 30px;">このサンプルは、ここでサインインしたユーザだけがアクセス出来るストレージ領域にアクセスしようとします。このため、初回アクセスの場合のみ、サインインしたユーザに対して、アプリにストレージへのアクセス権を与えるかの確認を求められます。</p>
<p style="padding-left: 30px;">ここで [許可] をすることで、model.derivative-nodejs-sample サンプル アプリがユーザのストレージ領域にアクセス出来るようになります。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb09670049970d-pi" style="display: inline;"><img alt="Authorize" class="asset  asset-image at-xid-6a0167607c2431970b01bb09670049970d img-responsive" src="/assets/image_659953.jpg" style="width: 400px;" title="Authorize" /></a></p>
<p style="padding-left: 30px;">アクセス許可が与えられると、A360など、サインインに使用した Autodesk ID に関連付けられた Hub と&#0160;配下の Project、その下の Folder、Item、Version の階層をツリー表示するはずです。</p>
<p style="padding-left: 30px;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c8c4147d970b-pi" style="display: inline;"><img alt="Example" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c8c4147d970b image-full img-responsive" src="/assets/image_507189.jpg" title="Example" /></a></p>
<p style="padding-left: 30px;">プロジェクト内のツリーからデザイン ファイルをクリックすると、Viewer 上にデザインを表示させることが出来ます。A360 プロジェクト内の同一ファイルであっても、時計アイコンでバージョンが個別に示されていて、それぞれを表示したり、モデル内の属性を取得したりすることが出来ます。</p>
<p style="padding-left: 30px;">選択したデザイン ファイルは、ファイル形式毎にサポートされている他のファイル形式に変換、ダウンロードすることが出来ます。これは、Model Derivative API の機能です。</p>
<p style="padding-left: 30px;">また、2016 年 11 月に追加された Data Management API のアタッチメント機能では、テキスト ファイルや画像ファイルなど を指定した Version に直接関連付けることも出来ます。</p>
<p>By Toshiaki Isezaki</p>
