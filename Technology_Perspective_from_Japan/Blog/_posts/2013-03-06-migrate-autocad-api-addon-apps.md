---
layout: "post"
title: "AutoCAD API を使ったアドオン アプリケーションの移植性"
date: "2013-03-06 01:08:24"
author: "Toshiaki Isezaki"
categories:
  - "API カスタマイズ"
  - "デスクトップ製品"
original_url: "https://adndevblog.typepad.com/technology_perspective/2013/03/migrate-autocad-api-addon-apps.html "
typepad_basename: "migrate-autocad-api-addon-apps"
typepad_status: "Publish"
---

<p><a href="http://adndevblog.typepad.com/technology_perspective/2013/02/autocad-api-helps-cutomizing-autocad.html" target="_blank"><strong>以前のポスト</strong></a>では、現在、4 種類用意されている AutoCAD API の概要をご紹介しました。今回は、AutoLISP、COM、ObjectARX、.NET API を使って作成したアドオン アプリケーションの移植性についてご紹介しましょう。</p>
<p>AutoCAD に限らず、最近のオートデスクのデスクトップ製品は、1 年に 1 回、新バージョンをリリースする製品サイクルを採用しています。もし、過去のバージョンの AutoCAD と API でアドオン アプリケーションを開発して運用している場合には、そのアドオン アプリケーションが新しいバージョンの AutoCAD でも動作するのか、事前にチェックしておく必要があります。場合によっては、新バージョンで動作させるための移植作業が必要になるものがあるためです。</p>
<p>それでは、まず最初に基本的な製品のリリース サイクルについて理解していただきましょう。AutoCAD 2002 以前の AutoCAD は、採用する DWG/DXF ファイル形式とアドオン アプリケーションの互換性が、バージョン毎に異なっていました。</p>
<p>DWG ファイル形式の場合は、どのバージョンでも旧バージョンの AutoCAD とデータ交換できるよう、旧バージョンの形式で保存することができるので、大きな問題にはなりませんでした。アドオン アプリケーションの場合には、少し事情が異なります。製品の機能とともに API も大きく変わってしまうため、バージョンごと移植作業を行なわなければいけなかったのです。ただし、AutoCAD 2002 以前のリリース サイクルが 2 年から 2.5 年あったため、頻繁に移植作業が発生するというわけではありませんでした。ところが、AutoCAD 2004 以降になって、<a href="http://www.autodesk.co.jp/subs" target="_self">サブスクリプション特典</a>の導入によって、リリース サイクルが&#0160;1 年に 1 度 リリースに変更され、新しい製品が手元に届くようになると、移植をある程度意識する必要がでてきたのです。</p>
<p>そこでオートデスクは、DWG ファイル形式の流通と開発者の負担を低減することを目的に、AutoCAD の DWG ファイル形式とアドオン アプリケーションの互換性を、3&#0160; 年に 1&#0160; 度変更する方向性を打ち出してました。このため、コンパイルを必要とする .NET API や ObjectARX を利用したアプリケーションであっても、再コンパイルなしに .dll ファイルや .arx&#0160;ファイルのまま、新しいバージョンで動作させることができるようになっています。逆に言えば、本格的な移植作業は、基本的に 3 年に 1 度実施すればいい、ということになります。ただし、アドオン アプリケーションが、AutoCAD の新バージョンが持つ新機能を追加実装しないことが前提になりますので、注意してください。&#0160;</p>
<p style="text-align: left;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41353f0e970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;">&#0160;</a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d19a1284970c-pi" style="display: inline;"><img alt="API_Compatibility" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d19a1284970c image-full img-responsive" src="/assets/image_39402.jpg" title="API_Compatibility" /></a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41353f0e970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><br /></a></p>
<p>基本的な移植のサイクルを意識していただいた上で、移植の際に重要になる「移植の壁」をご紹介しましょう。</p>
<p>まず、最も面倒な UNICODE です。AutoCAD 2007 から導入された <strong><a href="http://ja.wikipedia.org/wiki/Unicode" target="_self">UNICODE</a></strong> という文字コード体系は、コンパイルを必要とする ObjectARX 製アドオン アプリケーションに影響を与えます。AutoCAD 2006 以前の AutoCAD では、AutoCAD のユーザ インタフェースに表示する日本語文字や、図面に作図される日本語文字の内部表現に、Shift_JIS コードを利用してきました。Shift_JIS は日本の仕様であるので、日本語を記入した DWG 図面を中国や韓国に持ち出して、現地の言語の AutoCAD で開いて編集すると、いわゆる「文字化け」が発生してしまいます。この問題を解決するために、採用されたのが UNICODE です。UNICODE によって、どの国に DWG 図面を持ち込んで現地で編集しても日本語が文字化けしない利点を得ることができるようになりした。</p>
<p>その反面、日本語を扱う AutoCAD 2006 以前の ObjectARX アドオン アプリケーションは、最新のバージョンで動作させるために、Shift_JIS の日本語の文字入力や操作、表示といったプログラム部分を、UNICODE 操作の処理に変更する必要がでてきています。</p>
<p style="text-align: left;"><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8a9673d970d-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;">&#0160;</a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d19a1288970c-pi" style="display: inline;"><img alt="Unicode" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b8d19a1288970c image-full img-responsive" src="/assets/image_591360.jpg" title="Unicode" /></a><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8a9673d970d-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><br /></a></p>
<p>AutoCAD バージョン以外にも、移植作業に影響を与える問題があります。Windows プラットフォームの違いです。従来 32 ビット版が中心だった Windows OS は、最近のハードウェア（プロセッサ）の 64 ビット化に伴って、64 ビット化しているかと思います。AutoCAD も、AutoCAD 2008 からパッケージ内に 32 ビット版の AutoCAD と 64 ビット版の AutoCAD を同梱されるようになっています。インストール時には、インストーラが使っている Windows OS がどちらのビット数かを検出して、自動的に同じビット数版の製品をインストールするようになっています。</p>
<p>そして、AutoCAD に合わせて、ObjectARX 製のアドオン アプリケーションは、AutoCAD のビット数に合わせて生成する必要があります。</p>
<p style="text-align: left;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d40e5df5b970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;">&#0160;</a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01bb08b4b0bf970d-pi" style="display: inline;"><img alt="Platform_History" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01bb08b4b0bf970d image-full img-responsive" src="/assets/image_452778.jpg" title="Platform_History" /></a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d40e5df5b970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><br /></a></p>
<p>もう 1 点、現在では既に意識する必要もなくなってきているかと思いますが、AutoCAD R14 以前のアドオン アプリケーションは、AutoCAD ウィンドウ内に複数の図面子ウィンドウを表示できるようになった MDI (Multi Document Interface) に対応する必要もあります。AutoCAD R14 までは、AutoCAD ウィンドウに1つの図面しか表示することができない SDI (Single Document Interface) を採用していました。アドオン アプリケーションの移植作業も発生するのですが、おおよそ15年前の変更になるので、この記事では MDI 対応についての紹介は省くことにします。</p>
<p>まとめると、過去バージョンから利用しているアドオン アプリケーションには、いくつかの移植の壁が存在することが理解いただけたかと思います。</p>
<p style="text-align: left;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41575910970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;">&#0160;</a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c80ff232970b-pi" style="display: inline;"><img alt="Migration_Wall" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c80ff232970b image-full img-responsive" src="/assets/image_248291.jpg" title="Migration_Wall" /></a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41575910970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><br /></a></p>
<p>詳細までは紹介できませんが、ここで説明した代表的な移植の壁に対して、最新の AutoCAD 2013 に移植することを前提に、API 別にどの程度の移植作業が発生するかを見ていきます。</p>
<p><strong>AutoLISP</strong></p>
<p style="text-align: left; padding-left: 30px;">AutoLISP は AutoCAD の一機能として提供されているため、AutoLISP のプログラム自体をUNICODE 対応する必要なく、そのまま動作させることができます。また、64 ビット版のAutoCADであっても、同様にそのまま動作します。つまり、UNICODE 化と 64 ビット化は意識する必要はありません。</p>
<p style="text-align: left; padding-left: 30px;">ただし、移植元の AutoCAD バージョンによっては、AutoCAD 2013 でコマンド オプションが増減していたり、コマンドやシステム変数そのものが削除されているものもありますので、それらにアクセスしている場合には、プログラムの変更が必要になるものあります。また、(vl-XXXX) といった関数を用いていて、Visual LISP 環境でコンパイルした .vlx ファイルや .fas ファイルをお持ちの場合は、AutoCAD の COM(ActiveX オートメーション) のタイプライブラリが変更されていますので、.lsp から再コンパイルすることをお勧めします。</p>
<p style="text-align: left; padding-left: 30px;">コマンドやシステム変数と同様に、新バージョンに加わった DXF グループコードに対応する必要もあります。たとえば、</p>
<p style="text-align: left; padding-left: 30px;"><strong><a href="https://knowledge.autodesk.com/ja/support/autocad/troubleshooting/caas/sfdcarticles/sfdcarticles/kA230000000tzpR.html" target="_blank">AutoLISPプログラムを TrueColor対応 にするには？</a></strong></p>
<p style="text-align: left; padding-left: 30px;">で紹介しているような内容です。</p>
<p style="text-align: left; padding-left: 30px;">AutoLISP の特性であるインタプリタ実行環境を生かして、とりあえず、新しいバージョンの&#0160;AutoCAD にロードして実行してみるのも手段です。</p>
<p style="text-align: left;"><strong>COM(ActiveX オートメーション)</strong></p>
<p style="text-align: left; padding-left: 30px;">バージョン毎によってタイプ ライブラリが異なりますので、原則、新しいタイプ ライブラリを参照することが必要です。ただし、前述のとおり 3 バージョン範囲内であれば、そのまま動作します。もちろん、新機能に準ずるオブジェクトにアクセスする場合には、その環境でプログラムを変更する必要はあります。</p>
<p style="text-align: left; padding-left: 30px;"><a href="https://knowledge.autodesk.com/ja/support/autocad/troubleshooting/caas/sfdcarticles/sfdcarticles/kA230000000u0pS.html" target="_blank"><strong>Table オブジェクトを使った表の作成に時間がかかる</strong> </a></p>
<p style="text-align: left; padding-left: 30px;">で紹介しているような内容も存在します。まずは、AutoLISP と同様に、&#0160;新しいバージョンの AutoCAD で実行してみることをお勧めします。</p>
<p style="text-align: left; padding-left: 30px;">なお、AutoCAD 2009 以前で VBA プロジェクトを利用していた方は、AutoCAD 2010 以降の VBA 環境に注意してください。VBA コンポーネントは、AutoCAD 2010 から インストールメディア(DVD-ROM) には含まれず、<a href="http://www.autodesk.com/vba-download">http://www.autodesk.com/vba-download</a> からのダウンロード提供に切り替わっています。これは、Microsoft 社が提供する VBA コンポーネントが、32 ビット版でしか用意されていないためです。</p>
<p style="text-align: left; padding-left: 30px;">64 ビット版 Windows 上で動作する 64 ビット版 AutoCAD で、32 ビット版 VBA を動作させるには、プログラムの実行時に AutoCAD と VBA の内部的な通信が発生します。32 ビット版 Windows 上で動作する&#0160;32 ビット版 AutoCAD の場合には、同じ 32 ビット版 VBA は AutoCAD と同じメモリ空間で動作することが出来るので、この通信が発生しないのです。この結果、&#0160;64 ビット版 AutoCAD で VBA を実行すると、パフォーマンスが低下したり、一部の VBA プログラムの互換性が崩れることになってしまいました。</p>
<p style="padding-left: 30px; text-align: left;"><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d414edcc2970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;">&#0160;</a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c80ff23a970b-pi" style="display: inline;"><img alt="VBACompare" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c80ff23a970b image-full img-responsive" src="/assets/image_827717.jpg" title="VBACompare" /></a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d414edcc2970c-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><br /></a></p>
<p style="text-align: left; padding-left: 30px;">現在では、オートデスクは VBA プロジェクトのプログラムを、同じ Visual Basic 言語を利用できるAutoCAD .NET API に移植していただくことを推奨しています。詳細は、</p>
<p style="text-align: left; padding-left: 30px;"><strong><a href="https://knowledge.autodesk.com/ja/support/autocad/troubleshooting/caas/sfdcarticles/sfdcarticles/kA230000000u03U.html" target="_blank">VBA プログラムの .NET API への移行方法について</a></strong></p>
<p style="text-align: left; padding-left: 30px;">をご覧ください。</p>
<p style="text-align: left;"><strong>ObjectARX</strong></p>
<p style="text-align: left; padding-left: 30px;">ObjectARX アプリケーションは、コンパイルされたバイナリ（.arx ファイル、.dbx ファイル）であっても、3世代間であれば、そのままロードして実行することができます。ただし、3世代間をまたいで移植する場合や、移植の壁にあたってしまった場合には、特に大きな移植作業が発生します。正直に言えば、AutoCAD API 上、最も強力な API である ObjectARX&#0160;は、MDI 対応、UNICODE 対応、64 ビット プラットフォームに最も影響を受ける API です。</p>
<p style="text-align: left; padding-left: 30px;">移植の際には、<a href="http://www.autodesk.com/objectarx">http://www.autodesk.com/objectarx</a> から AutoCAD 2013 用の ObjectARX SDK をダウンロードして、 ObjectARX アプリケーションの Visual Studio 2010(SP1) でプロジェクトで参照するように変更します。また、プロジェクト設定の変更で最も重要なのは、「マルチバイト文字セットを使用する」から「Unicode 文字セットを使用する」に変更することです。</p>
<p style="text-align: left; padding-left: 30px;">加えて、ソースコード内の文字列処理は、すべて UNICODE 対応が必要です。たとえば、strcpy() 関数は_tcscpy() 関数に、strcmpi() 関数は_tcsicmp() 関数に置き換える必要があります。また、acutPrintf() 関数でメッセージを表示しているような場面では、acutPrintf(&quot;Hello World&quot;); のような記述を acutPrintf(_T(&quot;Hello World&quot;)); にすることになります。つまり、移植作業の多くは、関数の置き換えや文字列指定の書き換えに費やされることになってしまいます。このため、対象になる関数や文字列処理を見つけて、置換したり、操作内容を警告する Visual Teefy というツールが用意されています。Visual Studio 2010 用の Visual Teefy は、ブログ記事 <a href="http://adndevblog.typepad.com/autocad/2012/04/migrating-objectarx-and-net-plug-ins-to-autocad-2013.html">http://adndevblog.typepad.com/autocad/2012/04/migrating-objectarx-and-net-plug-ins-to-autocad-2013.html</a>&#0160;の <a href="http://adndevblog.typepad.com/autocad/Downloads/DevTV_AutoCAD_Jaws_ObjectARX_Migration.zip" target="_blank">ObjectARX Migration</a>&#0160;に、動画とともに Visual Teefy のインストーラを含む <strong>VisualTeefy for 2010 Multilang EULA.zip</strong> として提供されています。</p>
<p style="text-align: left; padding-left: 30px;">ObjectARX アプリケーションは、32 ビット版の AutoCAD 用と、64 ビット版の AutoCAD 用に生成するバイナリ（.arx、.dbx）を作り分けます。簡単に言えば、32 ビット版の ObjectARX アドオン アプリケーションは、64 ビット版の AutoCAD にロードすることが出来ません。その逆も然りです。プログラム内で扱うポインタ長などが異なることが理由です。実際にコンパイルやリンクをする際には、ObjectARX SDK 内に用意された 32 ビット用、64 ビット用のヘッダー ファイル、ライブラリ ファイルをプラットフォーム毎に参照し直す必要があります。&#0160;</p>
<p style="text-align: left;"><strong>.NET API</strong></p>
<p style="text-align: left; padding-left: 30px;">.NET API の Visual Studio プロジェクトで最初に行う必要があるのは、AutoCAD 2013 に合わせたアセンブリの参照設定です。AutoCAD 2013 では、最低でも acmdg.dll、acdbmgd.dll、accoremgd.dll の3つのアセンブリ参照が必要です。</p>
<p style="text-align: left; padding-left: 30px;">.NET Framework を利用する AutoCAD .NET API では、登場時から文字列操作を UNICODE で処理するようになっているので、プロジェクト設定では、UNICODE 以外の選択肢はありません（UNCODE と意識する設定がありません）。</p>
<p style="text-align: left; padding-left: 30px;">また、コンパイルされて生成されるアセンブリ ファイル（.dll）は、ObjectARXのような純粋なバイナリではなく、中間言語で構成されています。中間言語で構成された .dll ファイルは、AutoCAD にロードされて最初に実行されるタイミングで、プラットフォームにあわせてバイナリにコンパイルされることになります（実行時コンパイル）。</p>
<p style="text-align: left; padding-left: 30px;">つまり、UNICODE 対応、プラットフォーム対応を意識する必要はありません。</p>
<p style="text-align: left;">ここまで読んでいただくと、少々ぐったりかもしれません。結論を急ぎましょう。現時点での移植作業負荷は、おおよそ次のような傾向となるはずです。今後の移植作業の目安や、新しく API カスタマイズをする場合にはこの移植性を考慮して取り組んでいただいたほうが後々楽になります。「プログラム資産」という言葉があるように、時間とコストを費やして開発したプログラムを、簡単に切り捨てられるものではないはずです。</p>
<p style="text-align: left;">&#0160; <a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8cb9e85970d-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;">&#0160;</a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c80ff244970b-pi" style="display: inline;"><img alt="Migration_workload" border="0" class="asset  asset-image at-xid-6a0167607c2431970b01b7c80ff244970b image-full img-responsive" src="/assets/image_173518.jpg" title="Migration_workload" /></a><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8cb9e85970d-popup" onclick="window.open( this.href, &#39;_blank&#39;, &#39;width=640,height=480,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0&#39; ); return false" style="display: inline;"><br /></a></p>
<p style="text-align: left;">By Toshiaki Isezaki</p>
<p>&#0160;</p>
