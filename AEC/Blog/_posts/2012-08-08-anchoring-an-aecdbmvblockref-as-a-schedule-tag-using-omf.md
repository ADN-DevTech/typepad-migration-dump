---
layout: "post"
title: "Anchoring an AecDbMvBlockRef as a schedule tag using OMF"
date: "2012-08-08 19:05:34"
author: "Katsuaki Takamizawa"
categories:
  - "AutoCAD Architecture"
  - "Katsuaki Takamizawa"
  - "OMF"
original_url: "https://adndevblog.typepad.com/aec/2012/08/anchoring-an-aecdbmvblockref-as-a-schedule-tag-using-omf.html "
typepad_basename: "anchoring-an-aecdbmvblockref-as-a-schedule-tag-using-omf"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/aec/katsuaki-takamizawa.html" target="_self">Katsuaki Takamizawa</a></p>  <p>Issue:</p>  <p>I want to add an anchor onto AecDbMvBlockRef in order to programmatically make it a schedule tag for another ACA object. How can I do that in OMF?</p>  <p>Solution:</p>  <p>We can use AecDbAnchorTagToEnt to do the intended task. The following sample code inserts a metric window tag and anchors it to a window. This sample uses &quot;M_Aec6_Window_Tag&quot; multi view block definition. If it hasn't been imported yet, please drag and drop it from the Design Center before you run the sample. </p>  <p>Note that with this sample, the number in the tag will not be filled automatically. You need to add a property set to the window beforehand to have the tag retrieve the value. You can add a window property set manually. If you want to use OMF, please refer to a blog post <a href="http://adndevblog.typepad.com/aec/2012/08/adding-a-property-set-programmatically-using-omf.html">Adding a property set programmatically using OMF</a>. </p>  <p>&#160;</p>  <p><font face="Calibri"><font color="#000000">&#160; Acad::ErrorStatus es;        <br />&#160; </font><span><font color="#008000">// We use a multi view block definition M_Aec3_Window_Tag here.</font></span>       <br /><font color="#000000">&#160; </font><span><font color="#008000">// (If it hasn't been imported yet, please drag and drop it</font></span>       <br /><font color="#000000">&#160; </font><span><font color="#008000">// from Design Center.) </font></span>      <br /><font color="#000000">&#160; AecRmCString mvName = _T(</font><span><font color="#a31515">&quot;M_Aec6_Window_Tag&quot;</font></span></font><font face="Calibri"><font color="#000000">);        <br />&#160; AcDbObjectId mvBlkDefId;         <br />&#160; AcDbDatabase *pDb = acdbHostApplicationServices()-&gt;workingDatabase();         <br />        <br />&#160; AecDictMvBlockDef mvDict(pDb);         <br />&#160; </font><span><font color="#0000ff">if</font></span></font><font face="Calibri"><font color="#000000">( mvDict.isValid() != Adesk::kTrue )        <br />&#160;&#160;&#160; </font><span><font color="#0000ff">return</font></span></font><font face="Calibri"><font color="#000000">;        <br />&#160; </font><span><font color="#0000ff">if</font></span></font><font face="Calibri"><font color="#000000">( mvDict.has(mvName) )&#160; <br />&#160;&#160;&#160; mvDict.getAt(mvName, mvBlkDefId);&#160; <br />&#160; </font><span><font color="#0000ff">else</font></span>       <br /><font color="#000000">&#160;&#160;&#160; </font><span><font color="#0000ff">return</font></span></font><font face="Calibri"><font color="#000000">;        <br />        <br />&#160; AecDbMvBlockRef* mvBlkRef = </font><span><font color="#0000ff">new</font></span></font><font face="Calibri"><font color="#000000"> AecDbMvBlockRef;&#160; <br />&#160; AEC_ASSERT(mvBlkRef != NULL);         <br />&#160; mvBlkRef-&gt;subSetDatabaseDefaults( pDb );         <br />&#160; mvBlkRef-&gt;setToStandard( pDb );         <br />&#160; mvBlkRef-&gt;setBlockDefId(mvBlkDefId);&#160; <br />        <br />&#160; </font><span><font color="#008000">// Set the tag location as picked by the user</font></span>       <br /></font><font face="Calibri"><font color="#000000">&#160; ads_point pt1;        <br />&#160; acedGetPoint(NULL,_T(</font><span><font color="#a31515">&quot;\nInsertion point: &quot;</font></span></font><font face="Calibri"><font color="#000000">), pt1);        <br />&#160; mvBlkRef-&gt;setLocation(AcGePoint3d(pt1[0], pt1[1], pt1[2]));         <br />        <br />&#160; </font><span><font color="#008000">// Here, we hard code the rotation and scale factor for simplicity.</font></span>       <br /><font color="#000000">&#160; </font><span><font color="#008000">// It should work well on Metric template.</font></span>       <br /></font><font face="Calibri"><font color="#000000">&#160; mvBlkRef-&gt;setRotation(0);        <br />&#160; AcGeScale3d scale3d(350);         <br />&#160; mvBlkRef-&gt;setScale(scale3d);         <br />        <br />&#160; AecDbAnchorTagToEnt* pAnchor = </font><span><font color="#0000ff">new</font></span></font><font face="Calibri"><font color="#000000"> AecDbAnchorTagToEnt();        <br />        <br />&#160; </font><span><font color="#008000">// Select a window to anchor the tag to.</font></span>       <br /></font><font face="Calibri"><font color="#000000">&#160; AcDbObjectId winId;        <br />&#160; AecUiPrEntity promptEnt(_T(</font><span><font color="#a31515">&quot;Select a window&quot;</font></span></font><font face="Calibri"><font color="#000000">), NULL);        <br />&#160; promptEnt.addAllowedClass(AecDbWindow::desc());         <br />&#160; </font><span><font color="#0000ff">if</font></span></font><font face="Calibri"><font color="#000000">(promptEnt.go() != AecUiPr::kOk)        <br />&#160; {         <br />&#160;&#160;&#160; acutPrintf(_T(</font><span><font color="#a31515">&quot;\nNot a window.&quot;</font></span></font><font face="Calibri"><font color="#000000">));        <br />&#160;&#160;&#160; </font><span><font color="#0000ff">return</font></span></font><font face="Calibri"><font color="#000000">;        <br />&#160; }         <br />&#160; pAnchor-&gt;appendReferenceObject( promptEnt.objectId(), AecObjReferenceInfo::kOwnedBy );         <br />        <br />&#160; </font><span><font color="#008000">// Set the anchor to the tag.</font></span>       <br /><font color="#000000">&#160; es = mvBlkRef-&gt;setAnchor( pAnchor );        <br />&#160; AEC_ASSERT( Acad::eOk == es );         <br />&#160; pAnchor-&gt;close();         <br />        <br />&#160; Aec::transformToWcs(mvBlkRef, pDb);         <br />&#160; Aec::addToCurrentSpaceAndClose(mvBlkRef);</font></font></p>
