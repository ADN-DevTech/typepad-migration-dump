---
layout: "post"
title: "Reading ASHRAE Table information from elements"
date: "2015-05-29 05:12:59"
author: "Augusto Goncalves"
categories:
  - "Augusto Goncalves"
  - "Revit"
  - "Revit MEP"
original_url: "https://adndevblog.typepad.com/aec/2015/05/reading-ashrae-table-information-from-elements.html "
typepad_basename: "reading-ashrae-table-information-from-elements"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/aec/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>On Revit MEP projects (also available on Revit), we can read the Loss Method data, but the information about the ASHRAE Table is not directly hosted on the element. So the question is: how access this table information, in the image below, the name “SR4-2”?</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b7c7950b7d970b-pi"><img title="ASHRAE" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="ASHRAE" src="/assets/image_911256.jpg" width="442" height="177" /></a> </p>  <p>In fact this information is stored at the Extensible Storage and linked back to the element at the <strong>RBS_DUCT_FITTING_LOSS_METHOD_SERVER_PARAM</strong> parameter via a GUID value.</p>  <p>To get the table name we need to make this connection.</p>  <p>From a give element, the first step is read the parameter value. The following code show this</p>  <pre style="font-size: 13px; font-family: consolas; background: white; color: black"><span style="color: #2b91af">FamilyInstance</span> fitting = doc.GetElement(eleId) <span style="color: blue">as</span>&#160;<span style="color: #2b91af">FamilyInstance</span>;<br /><span style="color: blue">if</span> (fitting == <span style="color: blue">null</span>) <span style="color: blue">continue</span>;<br /><span style="color: #2b91af">Parameter</span> param = fitting.get_Parameter(<br />&#160; <span style="color: #2b91af">BuiltInParameter</span>.RBS_DUCT_FITTING_LOSS_METHOD_SERVER_PARAM);<br /><span style="color: blue">if</span> (param == <span style="color: blue">null</span>) <span style="color: blue">continue</span>;<br /><span style="color: blue">string</span> strValGUID = param.AsString();<br /><span style="color: blue">string</span> strValTemp = getTableNameByServerId(fitting,<br />&#160; strValGUID,<br />&#160; <span style="color: #2b91af">ExternalServices</span>.<span style="color: #2b91af">BuiltInExternalServices</span>.<br />&#160; DuctFittingAndAccessoryPressureDropService);</pre>

<p>Now the interesting part: the <strong>getTableNameByServerId</strong> method is not on the API. The following code show all the steps. Thanks to Shelley and Jill, on Autodesk Shanghai team, for this excellent sample.</p>

<pre style="font-size: 13px; font-family: consolas; background: white; color: black"><span style="color: green">//the field&#160; name of duct table</span><br /><span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">readonly</span>&#160;<span style="color: blue">string</span> fieldDuctTableName = <span style="color: #a31515">&quot;ASHRAETableName&quot;</span>;<br /><span style="color: green">//the field&#160; name of pipe table</span><br /><span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">readonly</span>&#160;<span style="color: blue">string</span> fieldPipeTableName = <span style="color: #a31515">&quot;PipeFittingKFactorTableName&quot;</span>;<br /> <br /><span style="color: green">//get the server, and then get entity from the server,</span><br /><span style="color: green">//get table name from the entity</span><br /><span style="color: blue">private</span>&#160;<span style="color: blue">string</span> getTableNameByServerId(<br />&#160; <span style="color: #2b91af">FamilyInstance</span> fitting,<br />&#160; <span style="color: blue">string</span> strGUID,<br />&#160; <span style="color: #2b91af">ExternalServiceId</span> serviceId)<br />{<br />&#160; <span style="color: blue">if</span> (fitting == <span style="color: blue">null</span> || strGUID == <span style="color: blue">null</span> || serviceId == <span style="color: blue">null</span>)<br />&#160;&#160;&#160; <span style="color: blue">return</span>&#160;<span style="color: blue">null</span>;<br /> <br />&#160; <span style="color: #2b91af">Guid</span> serverGUID;<br />&#160; <span style="color: blue">if</span> (!<span style="color: #2b91af">Guid</span>.TryParse(strGUID, <span style="color: blue">out</span> serverGUID))<br />&#160;&#160;&#160; <span style="color: blue">return</span>&#160;<span style="color: blue">null</span>;<br /> <br />&#160; <span style="color: green">// For Pipe, the loss method might be defined on type</span><br />&#160; <span style="color: blue">if</span> (serverGUID == <span style="color: #2b91af">MEPCalculationServerInfo</span>.PipeUseDefinitionOnTypeGUID) <br />&#160; {<br />&#160;&#160;&#160; <span style="color: green">//check if the loss method of type is &quot;table&quot;</span><br />&#160;&#160;&#160; <span style="color: blue">int</span> eLossMethod = fitting.Symbol.get_Parameter(<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">BuiltInParameter</span>.RBS_PIPE_TYPE_FITTING_LOSS_METHOD_PARAM).<br />&#160;&#160;&#160;&#160;&#160; AsInteger();<br /> <br />&#160;&#160;&#160; <span style="color: blue">if</span> (eLossMethod == (<span style="color: blue">int</span>)<span style="color: #2b91af">PipeLossMethodType</span>.Table)<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> fitting.Symbol.get_Parameter(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">BuiltInParameter</span>.RBS_PIPE_TYPE_FITTING_LOSS_TABLE_PARAM).<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; AsString();<br />&#160;&#160;&#160; <span style="color: blue">else</span><br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span>&#160;<span style="color: blue">null</span>;<br />&#160; }<br />&#160; <span style="color: #2b91af">IExternalServer</span> server = getServerById(strGUID, serviceId);<br />&#160; <span style="color: blue">if</span> (server != <span style="color: blue">null</span>)<br />&#160; {<br />&#160;&#160;&#160; <span style="color: #2b91af">Schema</span> schema = <span style="color: blue">null</span>;<br />&#160;&#160;&#160; <span style="color: blue">string</span> fieldTableName = <span style="color: #a31515">&quot;&quot;</span>;<br />&#160;&#160;&#160; <span style="color: blue">if</span> (serviceId == <span style="color: #2b91af">ExternalServices</span>.<span style="color: #2b91af">BuiltInExternalServices</span>.<br />&#160;&#160;&#160;&#160;&#160; DuctFittingAndAccessoryPressureDropService)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">IDuctFittingAndAccessoryPressureDropServer</span> ductServer =<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; server <span style="color: blue">as</span>&#160;<span style="color: #2b91af">IDuctFittingAndAccessoryPressureDropServer</span>;<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (ductServer != <span style="color: blue">null</span>)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; schema = ductServer.GetDataSchema();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; fieldTableName = fieldDuctTableName;<br />&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br />&#160;&#160;&#160; <span style="color: blue">else</span>&#160;<span style="color: blue">if</span> (serviceId == <span style="color: #2b91af">ExternalServices</span>.<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">BuiltInExternalServices</span>.<br />&#160;&#160;&#160;&#160;&#160; PipeFittingAndAccessoryPressureDropService)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">IPipeFittingAndAccessoryPressureDropServer</span> pipeServer =<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; server <span style="color: blue">as</span>&#160;<span style="color: #2b91af">IPipeFittingAndAccessoryPressureDropServer</span>;<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (pipeServer != <span style="color: blue">null</span>)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; schema = pipeServer.GetDataSchema();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; fieldTableName = fieldPipeTableName;<br />&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; <span style="color: blue">if</span> (schema != <span style="color: blue">null</span>)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Field</span> field = schema.GetField(fieldTableName);<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (field != <span style="color: blue">null</span>)<br />&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Entity</span> entity = fitting.GetEntity(schema);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (entity != <span style="color: blue">null</span> &amp;&amp; entity.IsValid())<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> entity.Get&lt;<span style="color: blue">string</span>&gt;(field);<br />&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br />&#160; }<br /> <br />&#160; <span style="color: blue">return</span>&#160;<span style="color: blue">null</span>;<br />}<br /> <br /><span style="color: blue">private</span>&#160;<span style="color: #2b91af">IExternalServer</span> getServerById(<br />&#160; <span style="color: blue">string</span> strGUID, <span style="color: #2b91af">ExternalServiceId</span> serviceId)<br />{<br />&#160; <span style="color: blue">if</span> (strGUID == <span style="color: blue">null</span> || serviceId == <span style="color: blue">null</span>)<br />&#160;&#160;&#160; <span style="color: blue">return</span>&#160;<span style="color: blue">null</span>;<br /> <br />&#160; <span style="color: #2b91af">Guid</span> serverGUID;<br />&#160; <span style="color: blue">if</span> (!<span style="color: #2b91af">Guid</span>.TryParse(strGUID, <span style="color: blue">out</span> serverGUID))<br />&#160;&#160;&#160; <span style="color: blue">return</span>&#160;<span style="color: blue">null</span>;<br /> <br />&#160; <span style="color: green">//get the service first, and then get the server</span><br />&#160; <span style="color: #2b91af">MultiServerService</span> service = <br />&#160;&#160;&#160; <span style="color: #2b91af">ExternalServiceRegistry</span>.GetService(serviceId) <br />&#160;&#160;&#160; <span style="color: blue">as</span>&#160;<span style="color: #2b91af">MultiServerService</span>;<br />&#160; <span style="color: blue">if</span> (service != <span style="color: blue">null</span> &amp;&amp; serverGUID != <span style="color: blue">null</span>)<br />&#160; {<br />&#160;&#160;&#160; <span style="color: #2b91af">IExternalServer</span> server = service.GetServer(serverGUID);<br />&#160;&#160;&#160; <span style="color: blue">if</span> (server != <span style="color: blue">null</span>)<br />&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> server;<br />&#160; }<br /> <br />&#160; <span style="color: blue">return</span>&#160;<span style="color: blue">null</span>;<br />}</pre>
