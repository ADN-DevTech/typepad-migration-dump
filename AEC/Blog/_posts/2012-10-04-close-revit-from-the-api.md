---
layout: "post"
title: "Close Revit from the API"
date: "2012-10-04 08:40:40"
author: "Augusto Goncalves"
categories:
  - ".NET"
  - "Augusto Goncalves"
  - "Revit"
original_url: "https://adndevblog.typepad.com/aec/2012/10/close-revit-from-the-api.html "
typepad_basename: "close-revit-from-the-api"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/aec/augusto-goncalves.html">Augusto Goncalves</a></p>  <p>This is possible using SendMessage with WM_CLOSE parameter. There are two tricks here: first, DLLImport the method from user32.dll, second get Revit windows handle.</p>  <p>For the first, there is a good source of those methods at <a href="http://www.pinvoke.net/">PInvike.NET</a> website. For this case, we need the <a href="http://www.pinvoke.net/default.aspx/user32/SendMessage.html">SendMessage</a> header. For the second, there is a good post at <a href="http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html">The Builder Coder blog</a>.</p>  <p>Finally, the code will look like:</p>  <div style="font-family: ; background: white">   <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">[</font></font><font style="font-size: 10pt"><span><font color="#2b91af">Transaction</font></span><font color="#000000">(</font><span><font color="#2b91af">TransactionMode</font></span><font color="#000000">.Manual)]</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><span><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#000000"> </font><span><font color="#0000ff">class</font></span><font color="#000000"> </font><span><font color="#2b91af">AdskCommand</font></span><font color="#000000"> : </font></font><span><font style="font-size: 10pt" color="#2b91af">IExternalCommand</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">{</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">public</font></span><font color="#000000"> </font><span><font color="#2b91af">Result</font></span><font color="#000000"> Execute(</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#2b91af">ExternalCommandData</font></span><font color="#000000"> commandData,</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">ref</font></span><font color="#000000"> </font><span><font color="#0000ff">string</font></span><font color="#000000"> message,</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#2b91af">ElementSet</font></span><font color="#000000"> elements)</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160; </font></font><span><font style="font-size: 10pt" color="#008000">// send the message to close</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160; SendMessage(RevitWndHandle, </font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160;&#160;&#160; WM_CLOSE,</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#2b91af">IntPtr</font></span><font color="#000000">.Zero, </font><span><font color="#2b91af">IntPtr</font></span><font color="#000000">.Zero);</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">return</font></span><font color="#000000"> </font><span><font color="#2b91af">Result</font></span><font color="#000000">.Succeeded;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><span><font style="font-size: 10pt" color="#008000">// the value for close</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">static</font></span><font color="#000000"> </font><span><font color="#0000ff">uint</font></span><font color="#000000"> WM_CLOSE = 0x10;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><span><font style="font-size: 10pt" color="#008000">// Use P/Invoke to DLLImport </font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; [</font></font><font style="font-size: 10pt"><span><font color="#2b91af">DllImport</font></span><font color="#000000">(</font><span><font color="#a31515">&quot;user32.dll&quot;</font></span><font color="#000000">, </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160; CharSet = </font></font><font style="font-size: 10pt"><span><font color="#2b91af">CharSet</font></span><font color="#000000">.Auto,</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160; SetLastError = </font></font><font style="font-size: 10pt"><span><font color="#0000ff">false</font></span><font color="#000000">)]</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">static</font></span><font color="#000000"> </font><span><font color="#0000ff">extern</font></span><font color="#000000"> </font><span><font color="#2b91af">IntPtr</font></span><font color="#000000"> SendMessage(</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#2b91af">IntPtr</font></span><font color="#000000"> hWnd, </font><span><font color="#2b91af">UInt32</font></span><font color="#000000"> Msg, </font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#2b91af">IntPtr</font></span><font color="#000000"> wParam, </font><span><font color="#2b91af">IntPtr</font></span><font color="#000000"> lParam);</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><span><font style="font-size: 10pt" color="#008000">// singleton to store Revit handle</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">static</font></span><font color="#000000"> </font><span><font color="#2b91af">IntPtr</font></span><font color="#000000"> _hWndRevit = </font><span><font color="#2b91af">IntPtr</font></span><font color="#000000">.Zero;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><span><font style="font-size: 10pt" color="#008000">// get Revit handle</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">private static</font></span><font color="#000000">&#160;</font><span><font color="#2b91af">IntPtr</font></span><font color="#000000"> RevitWndHandle</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160; {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160; </font></font><span><font style="font-size: 10pt" color="#0000ff">get</font></span></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (_hWndRevit == </font><span><font color="#2b91af">IntPtr</font></span><font color="#000000">.Zero)</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.Diagnostics.</font></font><font style="font-size: 10pt"><span><font color="#2b91af">Process</font></span><font color="#000000">[] processes</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = System.Diagnostics.</font></font><font style="font-size: 10pt"><span><font color="#2b91af">Process</font></span><font color="#000000">.</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetCurrentProcess(</font></font><font style="font-size: 10pt"><font color="#000000">);</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">if</font></span><font color="#000000"> (0 &lt; processes.Length)</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _hWndRevit = processes[0].MainWindowHandle;</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160;&#160;&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font color="#000000"><font style="font-size: 10pt">&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 10pt"><span><font color="#0000ff">return</font></span><font color="#000000"> _hWndRevit;</font></font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160;&#160;&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">&#160; }</font></font></p>    <p style="margin: 0px"><font face="Courier New"><font style="font-size: 10pt" color="#000000">}</font></font></p> </div>
