---
layout: "post"
title: "Landing your Forge OAuth authentication workflow"
date: "2016-07-18 08:24:18"
author: "Philippe Leefsma"
categories:
  - "Javascript"
  - "Philippe Leefsma"
  - "Security"
  - "View and Data API"
  - "Web Development"
  - "Web Server"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2016/07/landing-your-forge-oauth-authentication-workflow.html "
typepad_basename: "landing-your-forge-oauth-authentication-workflow"
typepad_status: "Publish"
---

<p><span style="font-family: arial, helvetica, sans-serif;">By&#0160;<a href="http://adndevblog.typepad.com/cloud_and_mobile/philippe-leefsma.html" target="_blank">Philippe Leefsma</a> <a href="https://twitter.com/F3lipek" target="_blank">(@F3lipek)</a></span></p>
<p>&#0160;&#0160;&#0160;&#0160;Now that our <a href="https://developer.autodesk.com">Forge APIs</a> are available it&#39;s time to play with them! But after the initial&#0160;euphoria is behind, you should think about implementing secure applications in order to protect your resources but also the ones of customers logging to your web application. This starts by getting your OAuth authentication workflow right.</p>
<p>&#0160;&#0160;&#0160;&#0160;Before we start I need to mention that I&#39;m far from being a security expert, the information exposed in that blog post is purely extracted from my own experience and the advice I could collect when writing my samples, this should be considered in no way as a recommended approach but rather a suggestion. With that being said, let&#39;s get started!</p>
<p>&#0160;&#0160;&#0160;&#0160;Our web APIs are using <a href="https://developer.autodesk.com/en/docs/oauth/v2/overview/">OAuth</a> as authentication mechanism, nothing really fancy here. There are two types of OAuth authentication contexts:</p>
<ul style="list-style-type: square;">
<li>2-legged: also called &quot;app-context&quot; where your application (a server, desktop or mobile app) directly request an access token from the Autodesk server and can invoke the APIs with no user intervention. This is the case for the <a href="https://developer.autodesk.com/en/docs/data/v2/reference/http/buckets-POST/">OSS API</a>. Your app can for example create a bucket and start uploading some design there</li>
</ul>
<ul style="list-style-type: square;">
<li>3-legged: also called &quot;user-context&quot; where your app will request explicitly through a web interface (could be a WebView on a mobile or desktop app) a set of permissions from a user in order to access and potentially manipulate his data</li>
</ul>
<p>&#0160;&#0160;&#0160;&#0160;Based on the kind of features you want to provide, you may want one or the other, or both, potentially mixing each approaches. There are however some subtleties in the way you have to request tokens and especially expose that to your client application.</p>
<p><em><strong>I &#0160;2-Legged Token</strong></em></p>
<p>&#0160;&#0160;&#0160;&#0160;Let&#39;s start with 2-legged because it&#39;s more straightforward: here your app has access to <em><strong>clientId</strong></em> and <strong><em>clientSecret</em></strong> credentials - requested through our dev portal - which have to remain protected on your server or secured within the App - understand some kind of encryption and/or some custom obfuscation. You can share the <strong><em>clientId</em></strong> but may the&#0160;<strong><em>clientSecret</em></strong>&#0160;be compromised, another developer would have full access to your data. In such a case you can regenerate a secret on our <a href="https://developer.autodesk.com">API portal</a>. Your app will use those credentials to issue a valid token, you also have to pass the <a href="https://developer.autodesk.com/en/docs/oauth/v2/overview/scopes/">scope</a> which can be a single value or a space-separated, url-encoded string in case you request multiple scopes, eg <strong><em>data:read data:write</em></strong> (see my method <strong><em>requestToken</em></strong>&#0160;in the sample below). Once a token is acquired, you may use it on your server to access the API or expose&#0160;your own API endpoints for your client app, so a user will be able for example to upload his file to a bucket. In that case it&#39;s important that this <em><strong>data:write</strong></em> token remains hidden on your server because otherwise you expose the possibility to a bad intentioned&#0160;user to mess up with all your data.</p>
<p>&#0160;&#0160;&#0160;&#0160;If you want to let a&#0160;user load his model in the viewer on a web page, you need to expose an endpoint that returns a <em><strong>data:read</strong></em> token, so in that case you can request a new token with only <strong><em>data:read</em></strong> scope and expose that as an endpoint, in the case of my sample this is <em><strong>/api/forge/token/2legged&#0160;</strong></em></p>
<p>&#0160;&#0160;&#0160;&#0160;A 2-legged token expires after a certain time - <em><strong>expires_in</strong></em> field of the response - you can either keep refreshing the token and always keep a valid token on your server, or request a fresh token for each new operation. Alternatively implement a retry mechanism that will request a token only if the current one is expired at&#0160;at the time of the call - if you get an &#39;Unauthorized&#39; error basically. All approaches are valid and depend on the kind of feature you are providing and how often your app is going to require tokens I would say.</p>
<p><em><strong>II &#0160;3-legged Token</strong></em></p>
<p>&#0160; &#0160; 3-legged is a bit more tricky because here issuing a valid token depends on user authentication so at some point you need to prompt the user for his Autodesk credentials in conjunction of the API keys that you have stored on the server. You also need to specify scopes and this will explicitly be shown to user on the login page so he knows the extends of the permissions granted to your app.&#0160;</p>
<p><a class="asset-img-link" href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01b8d206a00f970c-pi" style="display: inline;"><img alt="Screen Shot 2016-07-18 at 18.59.39" class="asset  asset-image at-xid-6a0167607c2431970b01b8d206a00f970c img-responsive" src="/assets/image_ab2e30.jpg" style="border: 1px solid black; border-radius: 4px;" title="Screen Shot 2016-07-18 at 18.59.39" /></a>&#0160;</p>
<p>&#0160;&#0160;&#0160;&#0160;A 3-legged token also has an expiry period, but unlike the 2-legged workflow where you can simply request a new token, in 3-legged you would need to request user credentials again to issue a brand new token. For that reason each token response contains a <strong><em>refresh_token</em></strong> field that is a code you can use with a specific endpoint to request a new valid 3-legged token without user interaction. For that reason it is very important that you keep that refresh code securely on your server and do not share it with the users or expose it in any way to the outside.&#0160;</p>
<p>&#0160;&#0160;&#0160;&#0160;Similarly to a 2-legged token, in case you want to use the viewer to load user models, you need to expose an endpoint that would let you client application obtain a <em><strong>data:read</strong></em> token, without exposing&#0160;a full-privilege token. You do not want to ask a user to log twice in order to obtain a second read-only token, so in that case you need to use the <em><strong>refresh_token</strong></em> field of the initial response in order to request what we can call a <em>&quot;downgraded token&quot; </em>that&#39;s a token that is requested from the refresh code but with a reduced set of scopes. The reduced scopes&#0160;can only be a subset of the initial token scopes. The downgraded token&#0160;response will also contain a new <strong><em>refresh_token</em></strong> code, you need to carefully store that because each refresh code can only be used once. You need to&#0160;use that refresh code also to refresh the full-privilege token.</p>
<p>&#0160;&#0160;&#0160;&#0160;Below is the implementation of my Forge sample relevant to OAuth workflow and tokens management. I am splitting the code into the implementation of the endpoints and a utility called ForgeSvc (Forge Service) which allows some decoupling and flexibility in case the service has to be used by other endpoints or other services within the App. I find the approach pretty convenient even if it requires more files and more code than direct implementation in the endpoints. It definitely scales better once the codebase grows and the app becomes more complex.</p>
<p>Here is the OAuth workflow and secure forge token endpoints:&#0160;</p>
<script src="https://gist.github.com/leefsmp/645ead055cad9a1e9ddefb836fe9a9d2.js"></script>
<p>&#0160;&#0160;&#0160;&#0160;And here is the implementation of the Forge Service which keeps tracks of 3-legged and 2-legged tokens. It worth mentioning that it is <span style="text-decoration: underline;">NOT</span> a good idea or secure approach to store tokens into the session properties (in your node.js code for example: <em>req.session.token = &#39;xxxxxxx&#39;</em>) because this can be hacked easily. At the moment my service is using a simple in-memory storage which can be replaced by a more sophisticated persistence mechanism later on without breaking the endpoints:</p>
<script src="https://gist.github.com/leefsmp/511368e811d6736c348642082cc6884c.js"></script>
<p>&#0160;&#0160;&#0160;&#0160;The complete source code of that sample is available there but keep in mind that, like our Forge API&#39;s, it is a work in progress... A live sample is available at <a href="https://forge.autodesk.io" target="_blank">https://forge.autodesk.io</a></p>
<p>Finally for more info and step-by-step tutorials on Forge OAuth, please refer to the <a href="https://developer.autodesk.com/en/docs/oauth/v2/overview/basics/" target="_blank">official documentation</a>.</p>
