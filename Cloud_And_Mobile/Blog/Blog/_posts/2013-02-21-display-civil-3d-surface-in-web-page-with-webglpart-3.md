---
layout: "post"
title: "Display Civil 3D Surface in Web Page with WebGL&ndash;part 3"
date: "2013-02-21 01:13:41"
author: "Daniel Du"
categories:
  - "ASP .NET"
  - "Azure"
  - "Cloud"
  - "Daniel Du"
  - "Storage"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2013/02/display-civil-3d-surface-in-web-page-with-webglpart-3.html "
typepad_basename: "display-civil-3d-surface-in-web-page-with-webglpart-3"
typepad_status: "Publish"
---

<h4>By <a href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a></h4>  <p>This is continuation of <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/02/display-civil-3d-surface-in-web-page-with-webgl-part2.html">Part 2</a>. In part 2, I create a simplest memory repository, in this part, I would like to create a database repository to make my data persistent. I am using Entity Framework code first programming, which makes it very easy to create the database, actually I do not need to write a single SQL clause to manipulate the database, all stuff can be done in C# with Entity Framework. It is also very flexible if I need to change/reflector my model someday.</p>  <p>Firstly I created a context class, named as SurfaceContext, inherited from DbContext: </p>  <pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Web;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Data.Entity;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> TransferDataModel;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">SurfaceContext</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">DbContext</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span></font><font face="新宋体"><font color="#000000"> SurfaceContext()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; : </font><span style="color: "><font color="#0000ff">base</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;name = SurfaceStoreServiceWebRoleContext&quot;</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">DbSet</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt; TinSurfaces<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">get</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">DbSet</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span></font><font face="新宋体"><font color="#000000">&gt; TriangleFace<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">get</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">set</font></span><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160; <br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>Please note that “SurfaceStoreServiceWebRoleContext”&#160; is my connection string, which is defined in web.config: </p>

<pre style="line-height: normal; font-family: ; background: white"><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 7.8pt"><span style="color: "><font color="#a31515">add</font></span><span style="color: "><font color="#0000ff">&#160;</font></span><span style="color: "><font color="#ff0000">name</font></span><span style="color: "><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">SurfaceStoreServiceWebRoleContext</font></span><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">&#160;</font></span><span style="color: "><font color="#ff0000">connectionString</font></span><span style="color: "><font color="#0000ff">=<br /></font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">Data Source=.\SQLEXPRESS; <br /></font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><span style="color: "><font color="#0000ff">Initial Catalog=SurfaceStoreServiceWebRoleContext; <br /></font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><span style="color: "><font color="#0000ff">Integrated Security=True; MultipleActiveResultSets=True</font></span><font color="#000000">&quot;</font><br /><span style="color: "><font color="#0000ff">&#160;&#160;&#160;&#160;&#160; </font></span><span style="color: "><font color="#ff0000">providerName</font></span><span style="color: "><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">System.Data.SqlClient</font></span><font color="#000000">&quot;</font></font><span style="color: "><font style="font-size: 7.8pt" color="#0000ff"> /&gt;</font></span></font></pre>

<p>Here I am using SQL Express, but it is easy to refer to a cloud based SQL Azure database latter.</p>

<p>Next I created my database repository, implementing the <span style="color: "><font color="#2b91af">ITinSurfaceRepository </font></span>interface: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Web;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Data.Entity.Infrastructure;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> TransferDataModel;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurfaceDatabaseRepository</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">ITinSurfaceRepository</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">private</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">SurfaceContext</font></span><font color="#000000"> db = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">SurfaceContext</font></span></font><font face="新宋体"><font color="#000000">();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span></font><font face="新宋体"><font color="#000000"> TinSurfaceDatabaseRepository()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt; GetAll()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> db.TinSurfaces.AsEnumerable&lt;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt;();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span><font color="#000000"> Get(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> db.TinSurfaces.Find(id);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span><font color="#000000"> Add(</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (surface == </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">throw</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">ArgumentNullException</font></span><font color="#000000">(</font><span style="color: "><font color="#a31515">&quot;surface is null&quot;</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.TinSurfaces.Add(surface);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.SaveChanges();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> surface;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span><font color="#000000"> Remove(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000"> surf = Get(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (surf == </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.TinSurfaces.Remove(surf);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">try</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.SaveChanges();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">catch</font></span><font color="#000000"> (</font><span style="color: "><font color="#2b91af">DbUpdateConcurrencyException</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> surf;<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000"> Update(</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000"> updatedSurface)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> surface = Get(updatedSurface.Id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (surface == </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surface.Name = updatedSurface.Name;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surface.Description = updatedSurface.Description;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surface.TriangleFaces = updatedSurface.TriangleFaces;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">try</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.SaveChanges();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">catch</font></span><font color="#000000"> (</font><span style="color: "><font color="#2b91af">DbUpdateConcurrencyException</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">false</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">true</font></span><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>For test purpose, I also need some initial data and populate them into database, so here is a sample data class: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Web;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> TransferDataModel;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">SampleData</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span><font color="#000000">[] triangleFacesOfSurface1 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span></font><font face="新宋体"><font color="#000000">[]<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span></font><font face="新宋体"><font color="#000000">{Id = 1,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P1 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = 10, Y = 0, Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P2 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = 0,&#160; Y=10, Z=0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P3 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X=-10, Y=0,Z=0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Color = </font><span style="color: "><font color="#a31515">&quot;0xff0000&quot;</font></span></font><font face="新宋体"><font color="#000000">},<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span></font><font face="新宋体"><font color="#000000">{Id = 2,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P1 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = -10, Y = 0,Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P2 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{ X = 0,Y = -10,Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P3 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = 10, Y = 0, Z = 0} , <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Color = </font><span style="color: "><font color="#a31515">&quot;0x00ff00&quot;</font></span></font><font face="新宋体"><font color="#000000">}<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span><font color="#000000">[] triangleFacesOfSurface2 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span></font><font face="新宋体"><font color="#000000">[]<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span></font><font face="新宋体"><font color="#000000">{Id = 1,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P1 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = 10, Y = 10,Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P2 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X=-10,Y= 0,Z= 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P3 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = 15,Y = 0,Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Color = </font><span style="color: "><font color="#a31515">&quot;0xff0000&quot;</font></span></font><font face="新宋体"><font color="#000000">},<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTriangleFace</font></span></font><font face="新宋体"><font color="#000000">{Id = 2,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P1 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = -10,Y = 0,Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P2 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{X = 0,Y = -15, Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P3 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferPoint</font></span></font><font face="新宋体"><font color="#000000">{ X = 15, Y = 0,Z = 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Color = </font><span style="color: "><font color="#a31515">&quot;0x00ff00&quot;</font></span></font><font face="新宋体"><font color="#000000">}<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span><font color="#000000">[] sampleTinSurfaces = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000">[]<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span><font color="#000000"> { Name = </font><span style="color: "><font color="#a31515">&quot;surface1&quot;</font></span></font><font face="新宋体"><font color="#000000">, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Description = </font><span style="color: "><font color="#a31515">&quot;This is the first surface&quot;</font></span></font><font face="新宋体"><font color="#000000">, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; TriangleFaces = triangleFacesOfSurface1 },<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span><font color="#000000"> { Name = </font><span style="color: "><font color="#a31515">&quot;DesignSurface&quot;</font></span></font><font face="新宋体"><font color="#000000">, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Description = </font><span style="color: "><font color="#a31515">&quot;This is a design surface&quot;</font></span></font><font face="新宋体"><font color="#000000">, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; TriangleFaces = triangleFacesOfSurface2 }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };<br /> <br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TransferTinSurface</font></span></font><font face="新宋体"><font color="#000000">[] TinSurfaces<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">get</font></span><br /></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> sampleTinSurfaces;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>&#160;</p>

<p>Now go to Tools menu—&gt; Library package Manager to open Package Manager Console:</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8a54d02970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_776119.jpg" width="592" height="313" /></a></p>

<p>And type command “Enable-Migrations”, please note the intelligence <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="/assets/image_e2fc85.jpg" /></p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8a54d4e970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_fdc16a.jpg" width="567" height="368" /></a></p>

<p>After enabling migration, a file named as “Configurations.cs” will added into a new folder “Migrations”</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8a54d5c970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_e7d40e.jpg" width="565" height="162" /></a></p>

<p>Seed method is called after migrating the the latest version by running “Update-Database” command in Package Manager, so I just add my simple code to add some initial data into database context from SampleData class: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><span style="color: "><font color="#0000ff" face="新宋体"><font style="font-size: 7.8pt">namespace</font></font></span><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Migrations<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System.Data.Entity;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System.Data.Entity.Migrations;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System.Linq;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models;<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">internal</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">sealed</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Configuration</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">DbMigrationsConfiguration</font></span></font><font face="新宋体"><font color="#000000">&lt;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SurfaceStoreServiceWebRole.Models.</font><span style="color: "><font color="#2b91af">SurfaceContext</font></span></font><font face="新宋体"><font color="#000000">&gt;<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span></font><font face="新宋体"><font color="#000000"> Configuration()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AutomaticMigrationsEnabled = </font><span style="color: "><font color="#0000ff">true</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">protected</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">override</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> Seed(SurfaceStoreServiceWebRole.Models.</font><span style="color: "><font color="#2b91af">SurfaceContext</font></span></font><font face="新宋体"><font color="#000000"> context)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160; This method will be called after migrating to the latest version.</font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160; You can use the DbSet&lt;T&gt;.AddOrUpdate() helper extension method </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160; to avoid creating duplicate seed data. E.g.</font></span><br /></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000"> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.TinSurfaces.AddOrUpdate(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; s =&gt; s.Name,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">SampleData</font></span><font color="#000000">.TinSurfaces);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.SaveChanges();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br />}</font></font></font><br /></pre>

<p>&#160;</p>

<p>If you have read part 2 of the serials, you will notice that my first version of data model is named as “TinSurface”, and latter I found it is confusing when I came to Civil 3D plugin programing, so I did some refactoring work. Fortunately, that is easy with Entity Framework Code First programing. I just rename the class name in Visual Studio, the refactor tool of VS2012 ensure to change all relevant code, and run a command in Package Manager: </p>

<p>PM&gt; <strong>Add-Migration</strong> RefactorClassName 

  <br />PM&gt; <strong>Update-Database</strong></p>

<p>That’s it, all stuffs are done automatically, fantastic! “RefactorClassName” is my migration name, you will noticed that a new class is generated in “Migrations” folder: </p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d413164f6970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_64547a.jpg" width="485" height="136" /></a></p>

<p>After that, I check my database to verify whether my seed data is generated or not. Go Server Explorer and add a Data Connection to .\SQLEXPRESS. Two tables are created and some test data are populated.</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41316514970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_2a92a0.jpg" width="521" height="325" /></a></p>

<p>&#160;</p>

<p>Next is to switch to the database repository in my TinSurfacesController. Note that calling new TinSurfaceDatabaseRepository() in the controller is not the best design, because it ties the controller to a particular implementation of ITinSurfaceRepository. For a better approach, see <a href="http://www.asp.net/web-api/overview/extensibility/using-the-web-api-dependency-resolver">Using the Web API Dependency Resolver</a>. I would let it be by now.</p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><font color="#000000"><font style="font-size: 7.8pt"></font></font></font></pre>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><font color="#000000"><font style="font-size: 7.8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font style="font-size: 7.8pt"><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">readonly</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">ITinSurfaceRepository</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> repository =<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurfaceDatabaseRepository</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//static readonly ITinSurfaceRepository repository = </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><span style="color: "><font style="font-size: 7.8pt" color="#008000">//&#160;&#160;&#160; new TinSurfaceMemoryRepository();</font></span></font></pre>

<p>&#160;</p>

<p>Okay, with that I am working with a database now. With test of fiddler like part 2, I can retrieve data from database, and save data into database as well. 
  </p>
