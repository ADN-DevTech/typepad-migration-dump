---
layout: "post"
title: "Asynchronous WCF service calls using .NET Framework 4.5"
date: "2012-09-26 17:44:45"
author: "Madhukar Moogala"
categories:
  - "Azure"
  - "Cloud"
  - "Stephen Preston"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2012/09/asynchronous-wcf-service-calls-using-net-framework-45.html "
typepad_basename: "asynchronous-wcf-service-calls-using-net-framework-45"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/autocad/stephen-preston.html">Stephen Preston</a></p>  <p>I’ve just been following <a href="http://adndevblog.typepad.com/cloud_and_mobile/2012/07/creating-a-cloud-based-viewer-part-i.html">Philippe’s tutorial on creating a cloud based WCF service and consuming it from a client application</a>. I happened to have just installed Visual Studio 2012 and the Azure SDK, so I decided to use that instead of my trusty old Visual Studio/.NET 4.0 installation.</p>  <p>Following Philippe’s tutorial, I noticed some extra buttons when configuring my client’s service reference:</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d3c5830bc970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_d66dc2.jpg" width="331" height="208" /></a></p>  <p>After doing a bit of digging, I realized that this could be used with the .NET Framework 4.5 <a href="http://msdn.microsoft.com/en-us/library/hh191443.aspx" target="_blank">async and await</a> keywords, which I’d read about recently. I implemented my WCF Service on Azure using the C# ‘Windows Azure Cloud Service’ project type, and selecting the ‘WCF Service Web Role’:</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017c322a0171970b-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="SNAGHTMLa3b05c0" border="0" alt="SNAGHTMLa3b05c0" src="/assets/image_4e29cd.jpg" width="318" height="200" /></a></p>  <p>I actually followed <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg651130.aspx" target="_blank">Microsoft’s tutorial</a> to create the service, rather than Philippe’s instructions because I was going straight to Azure and not AWS (sorry Philippe <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-sadsmile" alt="Sad smile" src="/assets/image_aa4bf5.jpg" />).</p>  <p>My service implementation looks like this:</p>  <div style="font-family: consolas; background: white; color: black; font-size: 14pt">   <p style="margin: 0px"><font size="2">&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Service1</span> : IService1</font></p>    <p style="margin: 0px"><font size="2">&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> GetHello1()</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: #a31515">&quot;Hi there!&quot;</span>;</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2"></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> GetHello2()</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Thread</span>.Sleep(5000);</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: #a31515">&quot;Yo!&quot;</span>;</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160; }</font></p> </div>  <p>Note the deliberate delay in GetHello2(). And my simple contract looks like this:</p>  <div style="font-family: consolas; background: white; color: black; font-size: 14pt">   <p style="margin: 0px"><font size="2">&#160; [ServiceContract]</font></p>    <p style="margin: 0px"><font size="2">&#160; <span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: #2b91af">IService1</span></font></p>    <p style="margin: 0px"><font size="2">&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; [OperationContract]</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">string</span> GetHello1();</font></p>    <p style="margin: 0px"><font size="2"></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; [OperationContract]</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">string</span> GetHello2();</font></p>    <p style="margin: 0px"><font size="2">&#160; }</font></p> </div>  <p>My test client was a simple Windows Forms application. I added two service references to it – one with the settings Philippe describes in his tutorial (and that the MS tutorial also uses), the other using the settings in the screenshot above.</p>  <p>The equivalent code to Philippe’s (the ‘old’ way) is:</p>  <div style="font-family: consolas; background: white; color: black; font-size: 14pt">   <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: green">//Asynchronous&#160; using callbacks</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> button2_Click(<span style="color: blue">object</span> sender, <span style="color: #2b91af">EventArgs</span> e)</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; client1 = <span style="color: blue">new</span> ServiceReference1.Service1Client();</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; client1.BeginGetHello1(<span style="color: blue">new</span> GetHello1Request(), </font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: #2b91af">AsyncCallback</span>(MyAsyncResponder),&#160; <span style="color: blue">null</span>);</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2"></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> MyAsyncResponder(<span style="color: #2b91af">IAsyncResult</span> result)</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">try</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetHello1Response response = client1.EndGetHello1(result);</font></p>    <p style="margin: 0px"><font size="2"></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (result.IsCompleted)</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//Have to make sure we access form from correct thread</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.Invoke(</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> UpdateFormDelegate(UpdateForm), </font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">new</span> <span style="color: blue">object</span>[] { response.GetHello1Result });</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">catch</span> (<span style="color: #2b91af">Exception</span> ex)</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; MessageBox.Show(ex.Message);</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">finally</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; client1.Close();</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2"></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">void</span> UpdateForm(<span style="color: blue">string</span> txt)</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; label1.Text = txt;</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2"></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">delegate</span> <span style="color: blue">void</span> UpdateFormDelegate(<span style="color: blue">string</span> txt);</font></p> </div>  <p>Those callbacks and delegates are a bit of a pain for me. They really break up the flow of the code when I’m reading it. Which is why I was so happy when I worked out how to do the same thing using async/await (the ‘new’ way):</p>  <div style="font-family: consolas; background: white; color: black; font-size: 14pt">   <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: green">//Asynchronous using await/async keywords</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; <span style="color: blue">private</span> async <span style="color: blue">void</span> button3_Click(<span style="color: blue">object</span> sender, <span style="color: #2b91af">EventArgs</span> e)</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">try</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; client2 = <span style="color: blue">new</span> ServiceReference2.Service1Client();</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> res = await client2.GetHello2Async();</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//Control now returns back to the form until above </span></font></p>    <p style="margin: 0px"><font size="2"><span style="color: green">&#160;&#160;&#160;&#160;&#160;&#160;&#160; // call returns</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//Clicking other buttons while you're waiting invokes their </span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// code handlers.</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//When call returns the next line is invoked</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; label1.Text = res;</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">catch</span> (<span style="color: #2b91af">Exception</span> ex)</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; MessageBox.Show(ex.Message);</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; <span style="color: blue">finally</span></font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; {</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160;&#160;&#160; client2.Close();</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160;&#160;&#160; }</font></p>    <p style="margin: 0px"><font size="2">&#160;&#160;&#160; }</font></p> </div>  <p>The comments explain what happens with the flow of the code. <a href="http://www.quotationspage.com/quote/776.html" target="_blank">It’s a kind of magic</a>!</p>  <p>[Health warning: This is my first time creating a WCF web service and client, and my first time using await/async – so don’t assume my coding is optimal. I was just so excited about async/await that I had to blog about it <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="/assets/image_1f9b71.jpg" />]</p>  <p>PS: Yes – I know my exception handling is incomplete.</p>
