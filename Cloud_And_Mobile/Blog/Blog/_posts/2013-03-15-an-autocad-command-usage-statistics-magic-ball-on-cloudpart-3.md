---
layout: "post"
title: "An AutoCAD Command Usage Statistics &ldquo;Magic Ball&rdquo; on Cloud&ndash;Part 3"
date: "2013-03-15 00:08:38"
author: "Daniel Du"
categories:
  - "Azure"
  - "Cloud"
  - "Daniel Du"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2013/03/an-autocad-command-usage-statistics-magic-ball-on-cloudpart-3.html "
typepad_basename: "an-autocad-command-usage-statistics-magic-ball-on-cloudpart-3"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a></p>  <p>In <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/03/an-autocad-command-usage-statistics-magic-ball-on-cloudpart-1.html">part 1</a> and <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/03/an-autocad-command-usage-statistics-magic-ball-on-cloudpart-2.html">part 2</a>, I created a RESTful service, and rendered command usage statistics into a magic ball with three.js. It runs fine on my laptop, the data is stored in SQL Express. In this post, I would like to move it up to cloud, migrate this local asp.net web application to Windows Azure.</p>  <p>Actually it is pretty easy to migrate an existing ASP.NET web application to windows azure cloud. If you are using sessions in asp.net to maintain states, then you need to be careful, you may want to save your session into database or AppFabric. Fortunately my service only handles stateless request in REST way, so I would omit this part. </p>  <p>Firstly add a project into the solution, select “Windows Azure Cloud Service” template:</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee956487c970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_4023e7.jpg" width="466" height="314" /></a></p>  <p>In following page just click “OK” without adding any new roles, as we are going to add the existing asp.net application as web role latter.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41e26aae970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_86758e.jpg" width="464" height="335" /></a></p>  <p>A new cloud service project will be added into solution. Now right click Roles, Add –&gt; Web Role Project in solution, and select the asp.net web application to add it to cloud project as web role.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee956497f970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_74a8eb.jpg" width="478" height="144" /></a></p>  <p>You can edit the properties of this role if you want to, for example, change the instance count or VM size. I did some test on Azure Emulator, everything works fine.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41e26b8f970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_9ee81d.jpg" width="467" height="321" /></a></p>  <p>&#160;</p>  <p>Currently our database is still on my laptop, now it is time to move it up to cloud. For simplicity, I use SQL Azure. Firstly I need to login to <a href="https://manage.windowsazure.com/">Windows Azure Management console</a> to create a SQL Azure. New –&gt; Data Services –&gt; SQL DATABASE –&gt; CUSTOM CREATE.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41e26be3970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_fe2bcd.jpg" width="484" height="192" /></a></p>  <p>Give a database name, you can also create a new SQL database server if you have not done this before.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41e26c33970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_527a07.jpg" width="490" height="403" /></a></p>  <p>Please specify the same region as your service( we will create the service latter), anyway, it is a good idea to select a region close to your customers to get better performance. I am using East Asia here.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee9564ad1970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_0fbee6.jpg" width="488" height="401" /></a></p>  <p>&#160;</p>  <p>Once the SQL database is created, we can migrate our database from SQL Express to SQL Azure. Actually I can connect to the SQL Azure using SQL Server 2008 management studio from my laptop. But wait, we need to set up Windows Azure firewall rule from our IP address first. Click the database name in Azure management console you will get a page like below, which makes it very simple to set the firewall rule just by a clicking.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41e26cc3970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_db1c44.jpg" width="523" height="149" /></a></p>  <p>&#160;</p>  <p>If you read <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/03/an-autocad-command-usage-statistics-magic-ball-on-cloudpart-1.html">part 1</a>, you will remember, we are connecting to the local SQL Express in web.config, now I would like to connect to SQL Azure directly. the connection string can by found by clicking “View SQL Database connection strings”: </p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017c37b3259a970b-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_546dfe.jpg" width="488" height="323" /></a></p>  <p>Copy this connection string to the web.config , input your password and compile: </p>  <pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">&#160; &lt;</font></font></span><font style="font-size: 7.8pt"><span style="color: "><font color="#a31515">connectionStrings</font></span></font></font><font style="font-size: 7.8pt"><font color="#0000ff"><font face="新宋体"><span style="color: ">&gt;</span><br /><span style="color: ">&#160;&#160;&#160; &lt;!--</span></font></font><font color="#008000"><font face="新宋体"><span style="color: ">&lt;add name=&quot;AcadCommandViewerContext&quot; connectionString=&quot;Data Source=.\SQLEXPRESS; <br />Initial Catalog=AcadCommandViewerContext; Integrated Security=True; <br />MultipleActiveResultSets=True&quot;</span><br /><span style="color: ">&#160;&#160;&#160;&#160;&#160; providerName=&quot;System.Data.SqlClient&quot; /&gt;</span></font></font><font face="新宋体"><font color="#0000ff"><span style="color: ">--&gt;</span><br /><span style="color: ">&#160;&#160;&#160; &lt;</span></font><span style="color: "><font color="#a31515">add</font></span><span style="color: "><font color="#0000ff">&#160;</font></span><span style="color: "><font color="#ff0000">name</font></span><span style="color: "><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">AcadCommandViewerContext</font></span><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">&#160;</font></span><span style="color: "><font color="#ff0000">connectionString</font></span><span style="color: "><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">Data Source=tcp:qmhqjrmav7.database.windows.net,1433;<br />Initial Catalog=acadcmdviewer;User <a href="mailto:Id=acvadmin@qmhqjrmav7;Password=&lt;input">Id=&lt;sql server user id&gt;;Password=&lt;input</a> your password&gt;;</font></span><font color="#000000">&quot;</font><br /><span style="color: "><font color="#0000ff">&#160; </font></span><span style="color: "><font color="#ff0000">providerName</font></span><span style="color: "><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span style="color: "><font color="#0000ff">System.Data.SqlClient</font></span><font color="#000000">&quot;</font></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#0000ff"><span style="color: "> /&gt;</span><br /><span style="color: ">&#160; &lt;/</span></font><span style="color: "><font color="#a31515">connectionStrings</font></span></font><span style="color: "><font style="font-size: 7.8pt" color="#0000ff">&gt;</font></span></font></pre>

<p>&#160;</p>

<p>With Entity Framework, I can populate the initial data in SQL Azure in the same way as I did on SQL Express. Go to Package Manager Console from Tools—&gt; Library Package Manager, run Update-Database command in package Manager Console to create the database and test data.</p>

<p>PM&gt; Update-Database</p>

<p>&#160;</p>

<p>Now I am ready to publish/deploy my service to cloud. A simple way is to use the wizard of Visual Studio. Right click the cloud project and select Publish: </p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee9564bf6970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_ff5a24.jpg" width="490" height="243" /></a></p>

<p>&#160;</p>

<p>I have imported my MSDN subscription credentials following the hyper-link on wizard.</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017c37b326bb970b-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_dffd27.jpg" width="498" height="338" /></a></p>

<p>Create a new cloud service, and select the same location as the SQL Azure.</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017c37b3272a970b-pi"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_5fb0e0.jpg" width="499" height="280" /></a></p>

<p>You can also check other settings in this wizard or just leave it as default. Click Publish when you are ready, a few minutes later, your service will be running on cloud!</p>

<p>OK, next post will talk about the implementation of AutoCAD plugin. Thanks you and have a good day! </p>
