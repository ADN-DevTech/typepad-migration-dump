---
layout: "post"
title: "An AutoCAD Command Usage Statistics &ldquo;Magic Ball&rdquo; on Cloud&ndash;Part 1"
date: "2013-03-11 19:21:31"
author: "Daniel Du"
categories:
  - "ASP .NET"
  - "Azure"
  - "Cloud"
  - "Daniel Du"
  - "HTML5"
  - "WebGL"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2013/03/an-autocad-command-usage-statistics-magic-ball-on-cloudpart-1.html "
typepad_basename: "an-autocad-command-usage-statistics-magic-ball-on-cloudpart-1"
typepad_status: "Publish"
---

<h6>By <a href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a></h6>  <p>This is my another practice with Windows Azure and WebGL, an <a href="http://acadcommandwebviewer.cloudapp.net/">AutoCAD Command Usage Statistics “Magic Ball”</a> on Cloud. The idea is to monitor user’s command usage while he is drafting and save it up to cloud, then view the statistics in web page with a rotatable ball, I call it “magic ball”, it does not look like a ball just because I am lazy not to draft much to use many AutoCAD commands. <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="/assets/image_e7e98f.jpg" />&#160;</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41c0843b970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_ccb31e.jpg" width="441" height="348" /></a></p>  <p>It contains three parts – an AutoCAD plugin to monitor command usage statistics, an web service on Windows Azure to receive and save the command statistics, and a Web page client to render the statistics as magic ball with HTML5/WebGL.&#160; In this solution, it contains 5 projects, AcadCommandViewer is the service and web site, which is an ASP.NET MVC website on windows Azure. AcadCommandViewerConsole is the AutoCAD plugin.</p>  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee93460e3970d-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_14716a.jpg" width="433" height="251" /></a></p>  <p>In this post, I will introduce how to implement the server side. You probably is thinking to create a Windows Azure project in Visual Studio with Azure SDK. Yes, you are correct, but I found that it is not efficient to launch the project to test when developing, even with Azure Emulator. As it is easy to migrate an ASP.net application to Azure latter, I’d rather start from a simple ASP.net MVC Application first. So I created an ASP.net MVC 4 Web Application in Visual Studio.</p>  <p>First step is to create the Model of ASP.net MVC, by adding a class in Models folder of web application, but considering that the data model will also be used in AutoCAD plugin project as well, so I did some refactoring work to make the model a separate project. It is a very simple one, just one class, code goes as below: </p>  <pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> System.Web;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> AcadCommandViewer.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> Id { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> UserName { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">virtual</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">ICollection</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">CommandHit</font></span><font color="#000000">&gt; CommandHits { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br /> <br />&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> Id { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> CommandName { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> HitNumber { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span><font color="#000000">; }<br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>Model is OK now, next step is to create controller. In Visual Studio Solution Explorer, right click “Controllers” folder, Add –&gt; Controller, I choose “API controller with read/write actions, using Entity Framework” template, which creates a controller automatically with ASP.NET web API and Entity Framework.<a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017d41c0847a970c-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_bf6e1d.jpg" width="485" height="355" /></a></p>

<p>Select a “&lt;New data context&gt;” to create a new data context automatically.</p>

<p>If the your model class does show up in “Model class” list, you need add reference to your model project “AcadCommandViewerModels”.</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017c37913342970b-pi"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_2aeda7.jpg" width="481" height="278" /></a></p>

<p>The automatically created controller is pretty good, but there are some minor problems with update action. Entity Framework does not update the children elements, so we need to do some changes to the code, please refer to the code and comments inline: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Data;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Data.Entity;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Data.Entity.Infrastructure;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Net;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Net.Http;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Web;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Web.Http;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> AcadCommandViewer.Models;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> AcadCommandViewer.Controllers<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">AcadCommandsController</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">ApiController</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">private</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">AcadCommandViewerContext</font></span><font color="#000000"> db = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">AcadCommandViewerContext</font></span></font><font face="新宋体"><font color="#000000">();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// GET api/AcadCommands</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span></font><font face="新宋体"><font color="#000000">&gt; GetCommandsDatas()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> db.UserCommandsHits.OrderBy(p =&gt; p.UserName)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .AsEnumerable();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// GET api/AcadCommands/5</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><font color="#000000"> GetCommandsData(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span></font><font face="新宋体"><font color="#000000"> commandsdata = db.UserCommandsHits.Find(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (commandsdata == </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">throw</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseException</font></span></font><font face="新宋体"><font color="#000000">(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.NotFound));<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> commandsdata;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// GET api/AcadCommands?username=Daniel</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><font color="#000000"> GetCommandsData(</font><span style="color: "><font color="#0000ff">string</font></span></font><font face="新宋体"><font color="#000000"> userName)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span></font><font face="新宋体"><font color="#000000"> commandsdata = db.UserCommandsHits<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .FirstOrDefault&lt;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span></font><font face="新宋体"><font color="#000000">&gt;(p =&gt; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; p.UserName.ToUpper() == userName.ToUpper());<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (commandsdata == </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">throw</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseException</font></span></font><font face="新宋体"><font color="#000000">(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.NotFound));<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> commandsdata;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// PUT api/AcadCommands/5</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseMessage</font></span><font color="#000000"> PutCommandsData(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span></font><font face="新宋体"><font color="#000000"> commandsdata)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000"> (ModelState.IsValid &amp;&amp; id == commandsdata.Id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> usrCmdHitInDb = db.UserCommandsHits.Find(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//http://stackoverflow.com/questions/7968598/entity-4-1-updating-an-existing-parent-entity-with-new-child-entities</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//SetValues never updates navigation properties.</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//EF doesn't have any magic to update the children </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// - which means: adding new children, deleting </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// removed children, updating existing children</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// this procedure forces you to delete the old </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// children also from the database and insert the new one</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.Entry(usrCmdHitInDb).CurrentValues.SetValues(commandsdata);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//workaroud is to remove </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">foreach</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> ch </font><span style="color: "><font color="#0000ff">in</font></span></font><font face="新宋体"><font color="#000000"> usrCmdHitInDb.CommandHits.ToList())<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; usrCmdHitInDb.CommandHits.Remove(ch);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; usrCmdHitInDb.CommandHits.Clear();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">foreach</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> item </font><span style="color: "><font color="#0000ff">in</font></span></font><font face="新宋体"><font color="#000000"> commandsdata.CommandHits)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; usrCmdHitInDb.CommandHits.Add(item);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">try</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.SaveChanges();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">catch</font></span><font color="#000000"> (</font><span style="color: "><font color="#2b91af">DbUpdateConcurrencyException</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.NotFound);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.OK);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">else</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.BadRequest);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// POST api/AcadCommands</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseMessage</font></span><font color="#000000"> PostCommandsData(</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span></font><font face="新宋体"><font color="#000000"> commandsdata)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000"> (ModelState.IsValid)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.UserCommandsHits.Add(commandsdata);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.SaveChanges();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">HttpResponseMessage</font></span></font><font face="新宋体"><font color="#000000"> response = Request<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.Created, commandsdata);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; response.Headers.Location = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Uri</font></span></font><font face="新宋体"><font color="#000000">(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Url.Link(</font><span style="color: "><font color="#a31515">&quot;DefaultApi&quot;</font></span></font><font face="新宋体"><font color="#000000">, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> { id = commandsdata.Id })<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> response;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">else</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.BadRequest);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">// DELETE api/AcadCommands/5</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseMessage</font></span><font color="#000000"> DeleteCommandsData(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span></font><font face="新宋体"><font color="#000000"> commandsdata = db.UserCommandsHits.Find(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (commandsdata == </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.NotFound);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.UserCommandsHits.Remove(commandsdata);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">try</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.SaveChanges();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">catch</font></span><font color="#000000"> (</font><span style="color: "><font color="#2b91af">DbUpdateConcurrencyException</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.NotFound);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> Request.CreateResponse(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.OK, commandsdata);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">protected</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">override</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> Dispose(</font><span style="color: "><font color="#0000ff">bool</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000"> disposing)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; db.Dispose();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">base</font></span><font color="#000000">.Dispose(disposing);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>&#160;</p>

<p>Please note that the context class is using SQL Express, it is easy to migrate to SQL Azure latter: </p>

<pre style="line-height: normal; font-family: ; background: white"><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">&#160; &lt;</font></font></span><font style="font-size: 7.8pt"><span style="color: "><font color="#a31515">connectionStrings</font></span></font></font><font style="font-size: 7.8pt"><font color="#0000ff"><font face="新宋体"><span style="color: ">&gt;</span><br /><span style="color: ">&#160;&#160;&#160; </span></font></font><font color="#008000"><font face="新宋体"><span style="color: ">&lt;add name=&quot;AcadCommandViewerContext&quot; connectionString=&quot;Data Source=.\SQLEXPRESS;<br /></span></font></font></font><font style="font-size: 7.8pt"><font color="#008000"><font face="新宋体"><span style="color: "> Initial Catalog=AcadCommandViewerContext; Integrated Security=True; <br />MultipleActiveResultSets=True&quot;</span><br /><span style="color: ">&#160;&#160;&#160;&#160;&#160; providerName=&quot;System.Data.SqlClient&quot; /&gt;</span></font></font><font face="新宋体"><font color="#0000ff"><br /><span style="color: ">&#160;&#160;&#160; </span></font></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#0000ff"><br /><span style="color: ">&#160; &lt;/</span></font><span style="color: "><font color="#a31515">connectionStrings</font></span></font><span style="color: "><font style="font-size: 7.8pt" color="#0000ff">&gt;</font></span></font></pre>

<p>Now make some sample data for testing, back to AcadCommandViewer project and add a class --SampleData.cs -- in Models folder: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> System.Web;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> AcadCommandViewer.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">SampleData</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><font color="#000000"> danielCmdHits = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Id = 1,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; UserName = </font><span style="color: "><font color="#a31515">&quot;Daniel&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandHits = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">[] {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">{<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandName = </font><span style="color: "><font color="#a31515">&quot;PLINE&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; HitNumber&#160; = 1<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">{<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandName = </font><span style="color: "><font color="#a31515">&quot;ZOOM&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; HitNumber&#160; = 2<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">{<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandName = </font><span style="color: "><font color="#a31515">&quot;LINE&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; HitNumber&#160; = 3<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">{<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandName = </font><span style="color: "><font color="#a31515">&quot;Save&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; HitNumber&#160; = 4<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><font color="#000000"> jerryCmdHits = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Id = 2,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; UserName = </font><span style="color: "><font color="#a31515">&quot;Jerry&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandHits = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">[]<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">{<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandName = </font><span style="color: "><font color="#a31515">&quot;CIRCLE&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; HitNumber&#160; = 2<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">CommandHit</font></span></font><font face="新宋体"><font color="#000000">{<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CommandName = </font><span style="color: "><font color="#a31515">&quot;Quit&quot;</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; HitNumber&#160; = 1<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; };<br /> <br /> <br /> <br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><font color="#000000">[] userCmdsHits = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">UserCommandsHit</font></span><font color="#000000">[]<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; danielCmdHits,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; jerryCmdHits<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };<br /> <br /> <br /> <br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>&#160;</p>

<p>To generate the test data in database automatically, I need to enable database migration. Open Package Manager Console from Tools—&gt; Library Package Manager, and type commands as below: </p>

<p>PM&gt; Enable-Migrations
  <br /></p>

<p>A class named as Configuration.cs and a folder ”Migrations” will to added into Visual Studio project.&#160; Open the class and implement the Seed method to populate the test data : </p>

<p>&#160;</p>

<pre style="line-height: normal; font-family: ; background: white; color: "><span style="color: "><font color="#0000ff" face="新宋体"><font style="font-size: 7.8pt">namespace</font></font></span><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> AcadCommandViewer.Migrations<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System.Data.Entity;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System.Data.Entity.Migrations;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> System.Linq;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">using</font></span></font><font face="新宋体"><font color="#000000"> AcadCommandViewer.Models;<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">internal</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">sealed</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Configuration</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">DbMigrationsConfiguration</font></span><font color="#000000">&lt;AcadCommandViewer.Models.</font><span style="color: "><font color="#2b91af">AcadCommandViewerContext</font></span></font><font face="新宋体"><font color="#000000">&gt;<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span></font><font face="新宋体"><font color="#000000"> Configuration()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; AutomaticMigrationsEnabled = </font><span style="color: "><font color="#0000ff">true</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">protected</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">override</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> Seed(AcadCommandViewer.Models.</font><span style="color: "><font color="#2b91af">AcadCommandViewerContext</font></span></font><font face="新宋体"><font color="#000000"> context)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160; This method will be called after migrating to the latest version.</font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160; You can use the DbSet&lt;T&gt;.AddOrUpdate() helper extension method </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160; to avoid creating duplicate seed data. E.g.</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160;&#160;&#160; context.People.AddOrUpdate(</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160;&#160;&#160;&#160;&#160; p =&gt; p.FullName,</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160;&#160;&#160;&#160;&#160; new Person { FullName = &quot;Andrew Peters&quot; },</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160;&#160;&#160;&#160;&#160; new Person { FullName = &quot;Brice Lambson&quot; },</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160;&#160;&#160;&#160;&#160; new Person { FullName = &quot;Rowan Miller&quot; }</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160;&#160;&#160; );</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//</font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//SampleData s = new SampleData();</font></span><br /></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.UserCommandsHits.AddOrUpdate(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; p =&gt; p.UserName,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">SampleData</font></span><font color="#000000">.userCmdsHits<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br />}</font></font></font><br /></pre>

<p>Then run Update-Database command in package Manager Console to create the database and test data.</p>

<p>PM&gt; Update-Database</p>

<p>&#160;</p>

<p>Okay, with that we are done the RESTful server side. I can use the tool fiddler to verify whether my Web Service works.&#160; The usage of Fiddler to test a RESTful service has been introduced in <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/02/display-civil-3d-surface-in-web-page-with-webgl-part2.html">this post</a>. </p>

<p>Next post will introduce how to implement the viewer side, to render the magic ball with WebGL.</p>
