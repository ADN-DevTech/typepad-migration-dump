---
layout: "post"
title: "How Autodesk Exchange IPN Listener works and how to create an IPN Listener"
date: "2014-02-16 21:44:28"
author: "Daniel Du"
categories:
  - "ASP .NET"
  - "Cloud"
  - "Daniel Du"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2014/02/how-autodesk-exchange-ipn-listener-works-and-how-to-create-an-ipn-listener.html "
typepad_basename: "how-autodesk-exchange-ipn-listener-works-and-how-to-create-an-ipn-listener"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a>  <p>I am going to sell my web services on Autodesk Exchange. As a web service publisher/seller, I would like to get a notification when someone buys my web service from Exchange, so that I can create an account and grant access to him. Instant Payment Notification (IPN) is a message service that automatically notifies merchants of events related to PayPal transactions. Merchants can use it to automate back-office and administrative functions, like fulfilling orders and providing customers with order status.&nbsp; Now Autodesk Exchange supports IPN notification. For priced web service, Autodesk Exchange relays the IPN notification to the publisher, adding some additional information, such as the buyer’s email address. For free web service, Autodesk Exchange sends an IPN notification to publisher including necessary information including buyer’s email address, etc.  <p>Firstly, let’s take a look at how to setup IPN listener. If you go to “My Upload” in Exchange by clicking the up-arrow button near your account name in up-right corner, you will see an new UI like below. You can input your IPN listener URL and activate IPNs so that you can receive IPN notification and handle them according to your business logic. If you do not know what IPN is, please refer to <a href="https://developer.paypal.com/webapps/developer/docs/classic/ipn/ht_ipn/">https://developer.paypal.com/webapps/developer/docs/classic/ipn/ht_ipn/</a>.  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a73d79b811970d-pi"><img title="clip_image002[1]" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image002[1]" src="/assets/image_78c678.jpg" width="534" height="103"></a>  <p>Now, you can go ahead to publish your web service to Autodesk Exchange. For web service, you can just specify your web service URL. For example, I have a web service – cloud rendering, allowing users uploading models and rendering them in cloud. For example, my web service URL is : <a href="http://www.mycompany.com/home/index">http://www.mycompany.com/home/index</a> (It is just for demo.)  <p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a3fcbeb066970b-pi"><img title="clip_image004[1]" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image004[1]" src="/assets/image_c2a4d4.jpg" width="532" height="308"></a>  <p>To use my service, users need to login to my website. When user buys my web service from Autodesk Exchange, I get an IPN notification from Exchange. My IPN listener receives this notification and creates an account for this buyer, and sends the account information to buyer so that he can use my service.  <p>Now I will create my IPN listener, it is an asp.net MVC application, for example, my IPN listener is : <a href="http://www.mycompany.com/home/IPNListener">http://www.mycompany.com/home/IPNListener</a>, here is the code:  <p>public void IPNListener()<br>{<br>string ipnNotification = Encoding.ASCII.GetString(Request.BinaryRead(Request.ContentLength));<br>if (ipnNotification.Trim() == string.Empty)<br>&nbsp;&nbsp;&nbsp; {<br>NetLog.WriteTextLog("No IPN notification received. ");<br>return;<br>&nbsp;&nbsp;&nbsp; }<br>NetLog.WriteTextLog(ipnNotification);<br>string validationMessage = HandleIPNNotification(ipnNotification);<br>NetLog.WriteTextLog(validationMessage);<br>}<pre></pre>
<p>For the format of IPN notification, you can refer to <a href="https://developer.paypal.com/webapps/developer/docs/classic/ipn/integration-guide/IPNandPDTVariables">https://developer.paypal.com/webapps/developer/docs/classic/ipn/integration-guide/IPNandPDTVariables</a> . Here is an example of priced IPN notification sent from Autodesk Exchange, please note that an additional parameter &amp;buyer_adsk_account is appended, you can use this parameter to get buyer’s email address. </p>
<p>transaction_subject=200703030249937</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;txn_type=web_accept</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;payment_date=23%3A36%3A36+Jan+11%2C+2014+PST</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;last_name=Balsom</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;residence_country=AU</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;item_name=RDBK_AutoNumber+Pro</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;payment_gross=5.50</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;mc_currency=USD</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="mailto:&amp;business=paypal@company.com.au">&amp;business=paypal@company.com.au</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;payment_type=instant</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;protection_eligibility=Ineligible</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;payer_status=verified</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;verify_sign=AFcWxV21C7fd0v3bYYYRCpSSRl31AsmAEVMnS38537K1tk5tZMnvtnW6</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;tax=0.50</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="mailto:&amp;payer_email=name@company.com">&amp;payer_email=name@company.com</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;txn_id=0AG18756HD086633A</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;quantity=1</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;receiver_email=paypal@company.com.au</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;first_name=MARK</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;payer_id=NEH6BJPL9LBYG</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;receiver_id=GDGRD3PAZBMD8</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&amp;item_number=appstore.exchange.autodesk.com%3Ardbk_autonumberpro_windows32and64%3Aen</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;handling_amount=0.00</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&amp;payment_status=Completed</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;payment_fee=0.43</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;mc_fee=0.43</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;shipping=0.00</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;mc_gross=5.50</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;custom=200703030249937</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;charset=windows-1252</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;notify_version=3.7</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;auth=A6P4OiUSwAL6901WUc3VK.fiUaYTR5AND5h.XpBaMqrI8gSmid.n0tFsfAMP6u3unDXUuiABwGtZWQlN.RFtDcA</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;form_charset=UTF-8</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="mailto:&amp;buyer_adsk_account=xxx@company.com.au">&amp;<b>buyer_adsk_account</b>=xxx@company.com.au</a>&nbsp;&nbsp; //this one is added by exchange store</p>
<p>For free web service, the IPN notification is simple, it is something like: <pre>txn_id={0}&amp;custom={1}&amp;payment_status={2}&amp;item_number={3}&amp;buyer_adsk_account={4}&amp;mc_gross=0.00</pre><pre>&nbsp;</pre><pre></pre>
<p>To handle the IPN notification, I need to verify whether the notification is a valid one, a valid IPN notification means it is sent from Autodesk Exchange, not anyone else, a hacker for instance. The way to validate IPN notification is to send it back to Autodesk Exchange with POST method, Autodesk Exchange will response “<strong>verified</strong>” if it is a valid one. The Autodesk Exchange IPN verification URL is : <a href="http://apps.exchange.autodesk.com/WebServices/ValidateIPN">http://apps.exchange.autodesk.com/WebServices/ValidateIPN</a>. Autodesk Exchange marks the IPN notification as “received” when it is verified, otherwise it will send out IPN again and again(10 time maximum) until listener call Exchange webservice to verify it.</p>
<p>Now I can go ahead to set up an account for the customer and inform him to use my web service with this account information. According to current Autodesk Exchange logic, the publisher should send an email to customer. Since I get buyer’s email address, as an example, I can create an account with his email address as username and a random string as initial password, and then sent the account to buyer through email. Please refer to the sample project for detailed information on github: <a href="https://github.com/ADN-DevTech/Exchange-IPNListener-Sample">https://github.com/ADN-DevTech/Exchange-IPNListener-Sample</a></p>
<p>&nbsp; <p>Another problem is how to debug my IPN listener before it goes online. For local test/debug, I cannot count on Autodesk Exchange to verify my temp notification, so I create a helper tool - <a name="OLE_LINK2"></a><a name="OLE_LINK1">ExchangeStoreEmulator </a>- to emulate the Autodesk Exchange on local machine, buying an app, send an IPN notification, and validate the IPN notification. It is also included the code samples. ExchangeStoreEmulator is just simplest asp.net webform application: 
<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b01a5116e6961970c-pi"><img title="clip_image006" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image006" src="/assets/image_2c80fa.jpg" width="419" height="315"></a> 
<p>The IPN Listener URL is the one I am trying to debugging, the AppId is the web service which I need to monitor when someone buys it. As a local test, I need to set the IPN validation URL to the local version, as indicated <a href="http://localhost:xxx/ValidatIPN.aspx">http://localhost:xxx/ValidatIPN.aspx</a>, which emulate the behavior of Autodesk Exchange, verify the validation of IPN notification. <a href="https://github.com/ADN-DevTech/Exchange-IPNListener-Sample/blob/master/Documents/HowToCreateAutodeskExchangeIPNListener/HowToCreateAutodeskExchangeIPNListener.mp4">This video</a> demos the whole process and how to debug. 
<p>&nbsp;</p>
<p>OK, now please go to github to download the sample IPN listener to have a try.</p><a title="https://github.com/ADN-DevTech/Exchange-IPNListener-Sample" href="https://github.com/ADN-DevTech/Exchange-IPNListener-Sample">https://github.com/ADN-DevTech/Exchange-IPNListener-Sample</a>
