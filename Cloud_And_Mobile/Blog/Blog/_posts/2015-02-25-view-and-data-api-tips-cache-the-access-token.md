---
layout: "post"
title: "View and Data API tips: Cache the access token"
date: "2015-02-25 02:06:38"
author: "Daniel Du"
categories:
  - "ASP .NET"
  - "Cloud"
  - "Daniel Du"
  - "View and Data API"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2015/02/view-and-data-api-tips-cache-the-access-token.html "
typepad_basename: "view-and-data-api-tips-cache-the-access-token"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a></p>  <p>In cloud service world, it is common for production cloud service to set some restrictions to avoid abuse usage, and it is common for cloud service metering the API calls as part of business model, for instance, charging by number of API calls. Although Autodesk do not have such business model yet, and it does not put API call restriction yet, it would be better to have such a mechanism to cache the access token and save the unnecessary API calls. If the access token is not expired, we do not need to access to authentication server to get a new one. I did a simple implementation in .net as below:</p>  <pre style="font-size: 13px; font-family: consolas; background: white; color: black;overflow: scroll;"><span style="color: blue">public</span>&#160;<span style="color: blue">class</span>&#160;<span style="color: #2b91af">Util</span><br />{<br />&#160;&#160;&#160; <span style="color: blue">private</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">readonly</span>&#160;<span style="color: #2b91af">ILog</span> logger = <span style="color: #2b91af">LogManager</span>.GetLogger(<span style="color: blue">typeof</span>(<span style="color: #2b91af">Util</span>));<br /> <br />&#160;&#160;&#160; <span style="color: blue">string</span> baseUrl = <span style="color: #a31515">&quot;&quot;</span>;<br />&#160;&#160;&#160; <span style="color: #2b91af">RestClient</span> m_client;<br /><br /> <br />&#160;&#160;&#160; <span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: #2b91af">AccessToken</span> token;<br />&#160;&#160;&#160; <span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: #2b91af">DateTime</span> issueDateTime;<br />&#160;&#160;&#160; <span style="color: green">//refresh token if the token is about to expire in 5 seconds</span><br />&#160;&#160;&#160; <span style="color: blue">public</span>&#160;<span style="color: blue">static</span>&#160;<span style="color: blue">int</span> ABOUT_EXPIRED_SECONDS = 5;<br /> <br /><br />&#160;&#160;&#160; <span style="color: blue">public</span> Util(<span style="color: blue">string</span> baseUrl)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.baseUrl = baseUrl;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; m_client = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">RestClient</span>(baseUrl);<br />&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; <span style="color: blue">public</span>&#160;<span style="color: #2b91af">AccessToken</span> GetAccessToken(<span style="color: blue">string</span> clientId, <span style="color: blue">string</span> clientSecret)<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//no token or token is going to be expired </span><br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// (less than ABOUT_EXPIRED_SECONDS)</span><br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (token == <span style="color: blue">null</span><br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; || (<span style="color: #2b91af">DateTime</span>.Now - issueDateTime).TotalSeconds<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &gt; (token.expires_in - ABOUT_EXPIRED_SECONDS))<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">RestRequest</span> req = <span style="color: blue">new</span>&#160;<span style="color: #2b91af">RestRequest</span>();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req.Resource = <span style="color: #a31515">&quot;authentication/v1/authenticate&quot;</span>;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req.Method = <span style="color: #2b91af">Method</span>.POST;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req.AddHeader(<span style="color: #a31515">&quot;Content-Type&quot;</span>, <span style="color: #a31515">&quot;application/x-www-form-urlencoded&quot;</span>);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req.AddParameter(<span style="color: #a31515">&quot;client_id&quot;</span>, clientId);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req.AddParameter(<span style="color: #a31515">&quot;client_secret&quot;</span>, clientSecret);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req.AddParameter(<span style="color: #a31515">&quot;grant_type&quot;</span>, <span style="color: #a31515">&quot;client_credentials&quot;</span>);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//avoid CORS issue, do not use this if you just need to get access token from same domain<br /></span><br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req.AddHeader(<span style="color: #a31515">&quot;Access-Control-Allow-Origin&quot;</span>, <span style="color: #a31515">&quot;*&quot;</span>);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">IRestResponse</span>&lt;<span style="color: #2b91af">AccessToken</span>&gt; resp = m_client.Execute&lt;<span style="color: #2b91af">AccessToken</span>&gt;(req);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; logger.Debug(resp.Content);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (resp.StatusCode == System.Net.<span style="color: #2b91af">HttpStatusCode</span>.OK)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">AccessToken</span> ar = resp.Data;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (ar != <span style="color: blue">null</span>)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; token = ar;<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">//update the token issue time</span><br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; issueDateTime = <span style="color: #2b91af">DateTime</span>.Now;<br /> <br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span><br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; logger.Fatal(<span style="color: #a31515">&quot;Authentication failed! clientId:&quot;</span> + clientId);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span><br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ;<span style="color: green">//Do nothing, use the saved access token in static var </span><br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> token;<br />&#160;&#160;&#160; }<br /> <br /> <br />&#160;&#160;&#160; }</pre>

<p>&#160;</p>

<p>In this sample, I just cache the access token in memory with a static variable, you may use other more reliable storages such as database, memecached, etc. </p>
