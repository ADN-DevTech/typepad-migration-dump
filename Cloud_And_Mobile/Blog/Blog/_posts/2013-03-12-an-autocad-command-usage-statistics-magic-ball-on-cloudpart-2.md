---
layout: "post"
title: "An AutoCAD Command Usage Statistics &ldquo;Magic Ball&rdquo; on Cloud&ndash;Part 2"
date: "2013-03-12 18:18:21"
author: "Daniel Du"
categories:
  - "Azure"
  - "Cloud"
  - "Daniel Du"
  - "HTML5"
  - "Javascript"
  - "WebGL"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2013/03/an-autocad-command-usage-statistics-magic-ball-on-cloudpart-2.html "
typepad_basename: "an-autocad-command-usage-statistics-magic-ball-on-cloudpart-2"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a></p>  <p>In <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/03/an-autocad-command-usage-statistics-magic-ball-on-cloudpart-1.html">part 1</a> I introduced how to create an ASP.NET MVC application with ASP.NET Web API and Entity Framework to provide RESTful service. In this post, I will implement the web viewer with WebGL.</p>  <p>Actually it is just a common web page, to make it simple, I will use the one in MVC - index.cshtml. Switch to index.cshtml file in View –&gt; Home folder, I will add some JavaScript here to retrieve data from server side and render it as my “magic ball”. JQuery is good option to communicate with server side, getting user’s command usage statistics, and JQuery is part of ASP.NET MVC application by default. For WebGL, I will use a popular library- Three.Js, which can be downloaded from <a href="http://mrdoob.github.com/three.js/">GitHub</a>. There are many examples about Three.Js, I found that they are very helpful to learn how to use Three.Js. </p>  <p>The UI is pretty simple, just a combobox to ask user to select a user, and container DIV tag. </p>  <pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">&lt;</font></font></span><font style="font-size: 7.8pt"><span style="color: "><font color="#800000">div</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">id</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;body&quot;</span><span style="color: ">&gt;</span></font><br /><font color="#000000">&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">section</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">class</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;featured&quot;</span><span style="color: ">&gt;</span></font><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">div</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">class</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;content-wrapper&quot;</span><span style="color: ">&gt;</span></font><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">div</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">select</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">id</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;sel_userName&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">&gt;</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">option</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">value</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;All_Users&quot;</span><span style="color: ">&gt;</span></font><font color="#000000">Select a User Name</font><span style="color: "><font color="#0000ff">&lt;/</font></span><span style="color: "><font color="#800000">option</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;/</font></span><span style="color: "><font color="#800000">select</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /></font><font color="#000000"><font face="新宋体">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font face="新宋体"><span style="color: "><font color="#0000ff">&lt;/</font></span><span style="color: "><font color="#800000">div</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;/</font></span><span style="color: "><font color="#800000">div</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;/</font></span><span style="color: "><font color="#800000">section</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /><font color="#000000">&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">section</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">class</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;content-wrapper main-content clear-fix&quot;</span><span style="color: ">&gt;</span></font></font><font face="新宋体"><font color="#000000">&#160;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&gt;</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">div</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">id</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;Containner&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">style</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;</span></font><span style="color: "><font color="#ff0000">height</font></span><font color="#0000ff"><span style="color: ">:</span><span style="color: ">500px</span><span style="color: ">; </span></font><span style="color: "><font color="#ff0000">width</font></span><font color="#0000ff"><span style="color: ">:</span><span style="color: ">800px</span><span style="color: ">;<br />&#160; </span></font><span style="color: "><font color="#ff0000">background-color</font></span><font color="#0000ff"><span style="color: ">:</span><span style="color: ">black</span><span style="color: ">;&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">&gt;&lt;/</font></span><span style="color: "><font color="#800000">div</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font></font><font face="新宋体"><font style="font-size: 7.8pt"><br /><font color="#000000">&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">&lt;/</font></span><span style="color: "><font color="#800000">section</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /><font color="#000000">&#160;&#160;&#160; </font><br /><span style="color: "><font color="#0000ff">&lt;/</font></span><span style="color: "><font color="#800000">div</font></span></font><span style="color: "><font style="font-size: 7.8pt" color="#0000ff">&gt;</font></span></font></pre>

<p>&#160;</p>

<p>Firstly I will ask the server for the user name list and populate the select tag when document is ready. Use JQuery to send Ajax&#160; request to “api/AcadCommands” to get all users commands statistics and get the user name. Actually it would be better to create an action in server side, just returning a list of available user name, I will leave it to you to complete this if you are interested. <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="/assets/image_7e3836.jpg" />&#160;</p>

<pre style="line-height: normal; font-family: ; background: white"><font face="新宋体"><font color="#000000"><font style="font-size: 7.8pt">&#160;&#160;&#160; $(document).ready(</font></font><font style="font-size: 7.8pt"><span style="color: "><font color="#0000ff">function</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> () {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#006400">// Send an AJAX request</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; $.getJSON(</font><span style="color: "><font color="#800000">&quot;api/AcadCommands/&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> (data) {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#006400">// On success, 'data' contains a list of UserCommandsHits.</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; $.each(data, </font><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> (key, val) {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; $(</font><span style="color: "><font color="#800000">&quot;select&quot;</font></span></font><font face="新宋体"><font color="#000000">).append(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#800000">'&lt;option value=&quot;'</font></span><font color="#000000"> + val.UserName + </font><span style="color: "><font color="#800000">'&quot;&gt;'</font></span><br /></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; + val.UserName +<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#800000">'&lt;/option&gt;'</font></span><font color="#000000">);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; });<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; });</font></font></font></pre>

<blockquote>
  <pre style="line-height: normal; font-family: ; background: white">&#160;</pre>
</blockquote>

<pre>        var container = document.getElementById('Containner');<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; initThree(container);<br />        animate();<br /><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000"><br /><br />   });</font></font></font></pre>

<p>Another stuff need to done in document.ready is initialize ThreeJS, I will cover this part latter. Next step is to get specified user’s command usage statistic by user name when select a user from dropdown list. I use another action:</p>

<pre>api/AcadCommands?username=&quot; + username<br /></pre>

<p>The code snippet as below: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><font color="#000000"><font style="font-size: 7.8pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; $(</font></font><font style="font-size: 7.8pt"><span style="color: "><font color="#800000">&quot;#sel_userName&quot;</font></span><font color="#000000">).change(</font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">function</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> () {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> username = $(</font><span style="color: "><font color="#0000ff">this</font></span><font color="#000000">).children(</font><span style="color: "><font color="#800000">'option:selected'</font></span></font><font face="新宋体"><font color="#000000">).val();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; $(</font><span style="color: "><font color="#800000">'#txt_userName'</font></span></font><font face="新宋体"><font color="#000000">).text = username;<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> commandHitDic = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> Array();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; $.getJSON(</font><span style="color: "><font color="#800000">&quot;api/AcadCommands?username=&quot;</font></span></font><font face="新宋体"><font color="#000000"> + username,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> (data) {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> str = data.UserName + </font><span style="color: "><font color="#800000">': $'</font></span></font><font face="新宋体"><font color="#000000"> + data.CommandHits;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cmdHits = data.CommandHits;<br />&#160;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//add 3D objects to WebGL scene</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; addObjectsToScene(cmdHits);<br /> <br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; })<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .fail(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> (jqXHR, textStatus, err) {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; alert(err);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; $(</font><span style="color: "><font color="#800000">'#txt_userName'</font></span><font color="#000000">).text(</font><span style="color: "><font color="#800000">'Error: '</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000"> + err);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; });<br /> <br /> <br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }); </font></font><span style="color: "><font style="font-size: 7.8pt" color="#006400">//$(&quot;#sel_userName&quot;).change</font></span></font></pre>

<p>&#160;</p>

<p>After getting the data, I will generate the magic ball with Three.Js. To make my code more organized, I put the three.Js related code into another ACV_MagicBall.js.: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><br /><span style="color: "><font color="#0000ff" face="新宋体"><font style="font-size: 7.8pt">var</font></font></span><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> mouseX = 0, mouseY = 0,<br /> <br /></font><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160; SEPARATION = 200,<br />&#160;&#160;&#160; AMOUNTX = 10,<br />&#160;&#160;&#160; AMOUNTY = 10,<br /> <br /> <br /> <br />&#160;&#160;&#160; camera, scene, renderer;<br /> </font><br /><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> magicBall = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.Object3D();<br />&#160;&#160;&#160; </font><br /><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> targetRotation = 0;</font><br /><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> targetRotationOnMouseDown = 0;<br /> </font><br /><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> mouseX = 0;</font><br /><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> mouseXOnMouseDown = 0;<br /> </font><br /><span style="color: "><font color="#006400">///////////////////////////////</font></span><br /><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> MIN_TEXT_FONT_SIZE = 10;</font><br /><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> MAX_TEXT_FONT_SIZE = 80;<br /> </font><br /><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> MIN_LINE_LENGTH = 50;</font><br /><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> MAX_LINE_LENGTH = 450;<br /> </font><br /><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> PARTICLE_BALL_RADIUS = 850;<br /> </font><br /><span style="color: "><font color="#006400">///////////////////////////////</font></span><br /><font color="#000000"> </font><br /></font><font face="新宋体"><font color="#006400"><span style="color: ">//initThree();</span><br /><span style="color: ">//animate();</span></font><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> minHitNumber = 0;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> maxHitNumber = 0;<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> computeMinMaxHitNum(cmdHits) {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//get min and max hit number</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> i </font><span style="color: "><font color="#0000ff">in</font></span></font><font face="新宋体"><font color="#000000"> cmdHits) {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> hitNum = cmdHits[i].HitNumber;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> cmd = cmdHits[i].CommandName;<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000"> (hitNum &gt; maxHitNumber) maxHitNumber = hitNum;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000"> (hitNum &lt; minHitNumber) minHitNumber = hitNum;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; }<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> getLineLength(hitNumber) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> ratio = (hitNumber - minHitNumber) / (maxHitNumber - minHitNumber);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> lineLength = MIN_LINE_LENGTH + ratio * (MAX_LINE_LENGTH - MIN_LINE_LENGTH);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> lineLength;<br /> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> getTextFontSize(hitNumber) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> ratio = (hitNumber - minHitNumber) / (maxHitNumber - minHitNumber);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> textSize = MIN_TEXT_FONT_SIZE + ratio * (MAX_TEXT_FONT_SIZE - MIN_TEXT_FONT_SIZE);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> textSize;<br /> <br />}<br /> <br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> initThree(container) {<br /> <br /> <br /> <br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> separation = 100, amountX = 50, amountY = 50,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; particles, particle;<br /> <br /> <br />&#160;&#160;&#160; camera = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.PerspectiveCamera(75, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; container.clientWidth / container.clientHeight, 1, 10000);<br />&#160;&#160;&#160; camera.position.z = 1000;<br /> <br />&#160;&#160;&#160; scene = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.Scene();<br /> <br />&#160;&#160;&#160; renderer = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.CanvasRenderer(); //WebGLRenderer()<br />&#160;&#160;&#160; renderer.setSize(container.clientWidth, container.clientHeight);<br />&#160;&#160;&#160; container.appendChild(renderer.domElement);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//add particles just for visual effect</font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> PI2 = Math.PI * 2;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> material = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.ParticleCanvasMaterial({<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; color: 0xffffff,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; program: </font><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> (context) {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.beginPath();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.arc(0, 0, 1, 0, PI2, </font><span style="color: "><font color="#0000ff">true</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.closePath();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.fill();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; });<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> i = 0; i &lt; 1000; i++) {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; particle = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.Particle(material);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; particle.position.x = Math.random() * 2 - 1;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; particle.position.y = Math.random() * 2 - 1;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; particle.position.z = Math.random() * 2 - 1;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; particle.position.normalize();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; particle.position.multiplyScalar(Math.random() * 10 + PARTICLE_BALL_RADIUS);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; scene.add(particle);<br /> <br />&#160;&#160;&#160; }<br /> <br /> <br /> <br /> <br /> <br /> <br />&#160;&#160;&#160; container.addEventListener(</font><span style="color: "><font color="#800000">'mousedown'</font></span><font color="#000000">, onContainerMouseDown, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.addEventListener(</font><span style="color: "><font color="#800000">'touchstart'</font></span><font color="#000000">, onContainerTouchStart, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.addEventListener(</font><span style="color: "><font color="#800000">'touchmove'</font></span><font color="#000000">, onContainerTouchMove, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br /> <br />&#160;&#160; </font><br /></font><font face="新宋体"><font color="#000000"> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> addObjectsToScene(cmdHits){<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//prepartion</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; computeMinMaxHitNum(cmdHits);<br />&#160;&#160;&#160; <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000">(magicBall.children.length &gt; 0){<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> obj, i;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">for</font></span></font><font face="新宋体"><font color="#000000"> ( i = magicBall.children.length - 1; i &gt;= 0 ; i -- ) {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; obj = magicBall.children[ i ];<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; magicBall.remove(obj);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; scene.remove(magicBall);<br />&#160;&#160;&#160; }<br />&#160;&#160;&#160; </font><span style="color: "><font color="#006400">// add line and text </font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> i </font><span style="color: "><font color="#0000ff">in</font></span></font><font face="新宋体"><font color="#000000"> cmdHits) {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> hitNum = cmdHits[i].HitNumber;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> cmdName = cmdHits[i].CommandName;<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//draw line and text 3d object</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> lineLength = getLineLength(hitNum);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> textSize = getTextFontSize(hitNum);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> lineAndText = creatLineAndText(lineLength, cmdName, textSize);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; magicBall.add(lineAndText);<br />&#160;&#160;&#160; }<br /> <br /> <br /> <br />&#160;&#160;&#160; magicBall.rotation.x = 0;<br />&#160;&#160;&#160; magicBall.rotation.y = Math.PI * 2;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160; scene.add(magicBall);<br />&#160;&#160;&#160; <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> creatLineAndText(lineLength, textString, textSize) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> lineAndText = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.Object3D();<br />&#160;&#160;&#160; <br />&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//draw line </font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> startVector = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> THREE.Vector3(0, 0, 0);</font><span style="color: "><font color="#006400">// always start from center of ball.</font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> endX = Math.random() * 2 - 1;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> endY = Math.random() * 2 - 1;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> endZ = Math.random() * 2 - 1;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> endVector = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.Vector3(endX, endY, endZ);<br />&#160;&#160;&#160; endVector = endVector.normalize();<br />&#160;&#160;&#160; endVector.multiplyScalar(lineLength);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> geomLine = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.Geometry();<br />&#160;&#160;&#160; geomLine.vertices.push(startVector);<br />&#160;&#160;&#160; geomLine.vertices.push(endVector);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> line = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> THREE.Line(geomLine, </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.LineBasicMaterial(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { color: Math.random() * 0xffffff, opacity: 0.5 }));<br /> <br />&#160;&#160;&#160; lineAndText.add(line);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//draw text</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//inline function</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> creatTextAt(textPosition, textString, textSize) {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> text3d = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.TextGeometry(textString, {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; size: textSize,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; height: 5, </font><span style="color: "><font color="#006400">//thickness of the text</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; curveSegments: 2,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; font: </font><span style="color: "><font color="#800000">&quot;helvetiker&quot;</font></span><br /></font><font face="新宋体"><font color="#000000"> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; });<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; text3d.computeBoundingBox();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> centerOffset = -0.5 * (text3d.boundingBox.max.x - text3d.boundingBox.min.x);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> textMaterial = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.MeshBasicMaterial(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { color: Math.random() * 0xffffff,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; overdraw: </font><span style="color: "><font color="#0000ff">true</font></span></font><font face="新宋体"><font color="#000000"> });<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; text = </font><span style="color: "><font color="#0000ff">new</font></span></font><font face="新宋体"><font color="#000000"> THREE.Mesh(text3d, textMaterial);<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; text.position.x = textPosition.x + centerOffset;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; text.position.y = textPosition.y;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; text.position.z = textPosition.z;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> text;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> text3D = creatTextAt(endVector, textString, textSize);<br />&#160;&#160;&#160; lineAndText.add(text3D);<br /> <br />&#160;&#160;&#160; <br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> lineAndText;<br />}<br /> <br /> <br /> </font><br /></font><font face="新宋体"><br /><font color="#000000"> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> onContainerMouseDown(event) {<br />&#160;&#160;&#160; <br />&#160;&#160;&#160; event.preventDefault();<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> container = event.srcElement;<br />&#160;&#160;&#160; <br />&#160;&#160;&#160; container.addEventListener(</font><span style="color: "><font color="#800000">'mousemove'</font></span><font color="#000000">, onContainerMouseMove, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.addEventListener(</font><span style="color: "><font color="#800000">'mouseup'</font></span><font color="#000000">, onContainerMouseUp, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.addEventListener(</font><span style="color: "><font color="#800000">'mouseout'</font></span><font color="#000000">, onContainerMouseOut, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> windowHalfX = container.clientWidth / 2;<br />&#160;&#160;&#160; <br />&#160;&#160;&#160; mouseXOnMouseDown = event.clientX - windowHalfX;<br />&#160;&#160;&#160; targetRotationOnMouseDown = targetRotation;<br /> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> onContainerMouseMove(event) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> container = event.srcElement;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> windowHalfX = container.clientWidth / 2;<br /> <br />&#160;&#160;&#160; mouseX = event.clientX - windowHalfX;<br /> <br />&#160;&#160;&#160; targetRotation = targetRotationOnMouseDown + (mouseX - mouseXOnMouseDown) * 0.02;<br /> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> onContainerMouseUp(event) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> container = event.srcElement;<br /> <br />&#160;&#160;&#160; container.removeEventListener(</font><span style="color: "><font color="#800000">'mousemove'</font></span><font color="#000000">, onContainerMouseMove, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.removeEventListener(</font><span style="color: "><font color="#800000">'mouseup'</font></span><font color="#000000">, onContainerMouseUp, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.removeEventListener(</font><span style="color: "><font color="#800000">'mouseout'</font></span><font color="#000000">, onContainerMouseOut, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br /> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> onContainerMouseOut(event) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> container = event.srcElement;<br /> <br />&#160;&#160;&#160; container.removeEventListener(</font><span style="color: "><font color="#800000">'mousemove'</font></span><font color="#000000">, onContainerMouseMove, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.removeEventListener(</font><span style="color: "><font color="#800000">'mouseup'</font></span><font color="#000000">, onContainerMouseUp, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br />&#160;&#160;&#160; container.removeEventListener(</font><span style="color: "><font color="#800000">'mouseout'</font></span><font color="#000000">, onContainerMouseOut, </font><span style="color: "><font color="#0000ff">false</font></span></font><font face="新宋体"><font color="#000000">);<br /> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> onContainerTouchStart(event) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000"> (event.touches.length == 1) {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; event.preventDefault();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> container = event.srcElement;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> windowHalfX = container.clientWidth / 2;<br />&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; mouseXOnMouseDown = event.touches[0].pageX - windowHalfX;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; targetRotationOnMouseDown = targetRotation;<br /> <br />&#160;&#160;&#160; }<br /> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> onContainerTouchMove(event) {<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000"> (event.touches.length == 1) {<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; event.preventDefault();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> container = event.srcElement;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span></font><font face="新宋体"><font color="#000000"> windowHalfX = container.clientWidth / 2;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; mouseX = event.touches[0].pageX - windowHalfX;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; targetRotation = targetRotationOnMouseDown + (mouseX - mouseXOnMouseDown) * 0.05;<br /> <br />&#160;&#160;&#160; }<br /> <br />}<br /> </font><br /><span style="color: "><font color="#006400">//</font></span><br /><font color="#000000"> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> animate() {<br /> <br />&#160;&#160;&#160; requestAnimationFrame(animate);<br /> <br />&#160;&#160;&#160; render();<br /> <br />}<br /> </font><br /><span style="color: "><font color="#0000ff">function</font></span></font><font face="新宋体"><font color="#000000"> render() {<br /> <br />&#160;&#160;&#160; camera.position.x += (mouseX - camera.position.x) * .05;<br />&#160;&#160;&#160; camera.position.y += (-mouseY + 200 - camera.position.y) * .05;<br />&#160;&#160;&#160; camera.lookAt(scene.position);<br /> <br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//self rotate</font></span><br /></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">&#160;&#160;&#160; magicBall.rotation.y += ( targetRotation - magicBall.rotation.y ) * 0.05;<br />&#160;&#160;&#160; </font><span style="color: "><font color="#006400">//magicBall.rotation.y += 0.05;</font></span><br /><font color="#000000">&#160;&#160;&#160; renderer.render(scene, camera);<br /> <br />}</font></font></font><br /></pre>

<p>&#160;</p>

<p>Finally let’s list the script files I am referring to in index.cshtml, please note the helvetiker_regular.typeface.js, as it is necessary to render the command name as text in helvetiker_regular font:</p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><font style="font-size: 7.8pt"><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">script</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">src</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;../../Scripts/jquery-1.7.1.min.js&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">type</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;text/javascript&quot;</span><span style="color: ">&gt;&lt;/</span></font><span style="color: "><font color="#800000">script</font></span><span style="color: "><font color="#0000ff">&gt;</font></span><br /></font></font><font style="font-size: 7.8pt"><font face="新宋体"><span style="color: "><font color="#0000ff">&lt;</font></span><span style="color: "><font color="#800000">script</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">type</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;text/javascript&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">src</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;../../Scripts/Three/three.js&quot;</span><span style="color: ">&gt;&lt;/</span></font><span style="color: "><font color="#800000">script</font></span></font><font face="新宋体"><font color="#0000ff"><span style="color: ">&gt;</span><br /><span style="color: ">&lt;</span></font><span style="color: "><font color="#800000">script</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">type</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;text/javascript&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">src</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;../../Scripts/Three/Detector.js&quot;</span><span style="color: ">&gt;&lt;/</span></font><span style="color: "><font color="#800000">script</font></span></font><font face="新宋体"><font color="#0000ff"><span style="color: ">&gt;</span><br /><span style="color: ">&lt;</span></font><span style="color: "><font color="#800000">script</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">type</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;text/javascript&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">src</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;../../Scripts/Three/fonts/helvetiker_regular.typeface.js&quot;</span><span style="color: ">&gt;&lt;/</span></font><span style="color: "><font color="#800000">script</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#0000ff"><span style="color: ">&gt;</span><br /><span style="color: ">&lt;</span></font><span style="color: "><font color="#800000">script</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">type</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;text/javascript&quot;</span></font><font color="#000000">&#160;</font><span style="color: "><font color="#ff0000">src</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">&quot;../../Scripts/ACV_MagicBall.js&quot;</span><span style="color: ">&gt;&lt;/</span></font><span style="color: "><font color="#800000">script</font></span></font><span style="color: "><font style="font-size: 7.8pt" color="#0000ff">&gt;</font></span></font></pre>

<p>&#160;</p>

<p>Okay, I am done with the rendering magic ball with Three.Js. But it still a simple ASP.NET web application running on my laptop, in next post, I will move it up to Windows Azure cloud. Stay tuned. </p>
