---
layout: "post"
title: "Practice of DevOps with AWS CodeDeploy - part 1"
date: "2015-04-22 01:43:42"
author: "Daniel Du"
categories:
  - "Amazon Web Services"
  - "Cloud"
  - "Daniel Du"
  - "Server"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2015/04/practice-of-devops-with-aws-codedeploy-part-1.html "
typepad_basename: "practice-of-devops-with-aws-codedeploy-part-1"
typepad_status: "Publish"
---

<p><span style="font-size: small; font-family: &#39;Lucida Grande&#39;, sans-serif; color: #000000; line-height: 19px; background-color: #ffffff">By</span> <a style="font-size: small; font-family: &#39;Lucida Grande&#39;, sans-serif; color: #003366; line-height: 19px; background-color: #ffffff" href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a>     <br /></p>  <p>As a practice of DevOps, I have been investigating the auto-deployment mechanism, and the AWS CodeDeploy service draws my attention, it supports deploying from GitHub repository as well. In this post and following I will sharing what I learned. </p>  <p>&#160;</p>  <h3>Create an IAM Role for CodeDeploy</h3>  <p>Firstly, I need to create an IAM role for CodeDeploy, and launch my EC2 instances as well. I am going to using AWS command line interface(AWS CLI) which is easy to track what I did and I can repeat the process easily. I installed AWS CLI on my local Mac, so I am doing following on my local MacBook.</p>  <p>To create an IAM role, I need to prepare a JSON file for assume-role-policy-document:</p>  <blockquote>   <p>{</p>    <p>&quot;Version&quot;: &quot;2012-10-17&quot;,</p>    <p>&quot;Statement&quot;: [</p>    <p>{</p>    <p>&quot;Sid&quot;: &quot;&quot;,</p>    <p>&quot;Effect&quot;: &quot;Allow&quot;,</p>    <p>&quot;Principal&quot;: {</p>    <p>&quot;Service&quot;: [</p>    <p>&quot;codedeploy.us-west-2.amazonaws.com&quot;,</p>    <p>&quot;codedeploy.us-east-1.amazonaws.com&quot;,</p>    <p>&quot;ec2.amazonaws.com&quot;,</p>    <p>&quot;s3.amazonaws.com&quot;</p>    <p>]</p>    <p>},</p>    <p>&quot;Action&quot;: &quot;sts:AssumeRole&quot;</p>    <p>}</p>    <p>]</p>    <p>}</p> </blockquote>  <p>Here I need this role can access to CodeDeploy service, EC2 service and S3 service. Although I just want to deploy from Github instead of S3, but I still need to access S3 to install the CodeDeploy Agent on my EC2 instance. Now I am going to create my role:</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ aws iam create-role \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --role-name ADN-Viewer-CodeDeploy-Role \    <br />&gt; --assume-role-policy-document file://ADN-Viewer-CodeDeploy-Trust.json</p>  <p>Once my role is created, I need to assign it a policy with another JSON file:</p>  <blockquote>   <p>{</p>    <p>&quot;Version&quot;: &quot;2012-10-17&quot;,</p>    <p>&quot;Statement&quot;: [</p>    <p>{</p>    <p>&quot;Action&quot;: [</p>    <p>&quot;autoscaling:PutLifecycleHook&quot;,</p>    <p>&quot;autoscaling:DeleteLifecycleHook&quot;,</p>    <p>&quot;autoscaling:RecordLifecycleActionHeartbeat&quot;,</p>    <p>&quot;autoscaling:CompleteLifecycleAction&quot;,</p>    <p>&quot;autoscaling:DescribeAutoscalingGroups&quot;,</p>    <p>&quot;autoscaling:PutInstanceInStandby&quot;,</p>    <p>&quot;autoscaling:PutInstanceInService&quot;,</p>    <p>&quot;ec2:Describe*&quot;,</p>    <p>&quot;s3:Get*&quot;,</p>    <p>&quot;s3:List*&quot;,</p>    <p>&quot;Tag:get*&quot;</p>    <p>],</p>    <p>&quot;Effect&quot;: &quot;Allow&quot;,</p>    <p>&quot;Resource&quot;: &quot;*&quot;</p>    <p>}</p>    <p>]</p>    <p>}</p> </blockquote>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ aws iam put-role-policy \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --role-name ADN-Viewer-CodeDeploy-Role \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --policy-name ADN-Viewer-CodeDeploy-Permissions \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000"></p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --policy-document file://ADN-Viewer-CodeDeploy-Permissions.json</p>  <p>Since I am creating IAM role with AWS CLI, I have to create an instance profile for EC2. here is the explanation about instance profile from <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html">AWS document</a>:</p>  <blockquote>   <p><span style="font-size: 12px; font-family: verdana, arial, sans-serif; color: #000000; widows: 1; line-height: normal">Amazon EC2 uses an</span> <span class="emphasis" style="font-size: 12px; font-family: verdana, arial, sans-serif; color: #000000; widows: 1; line-height: normal"><em>instance profile</em></span> <span style="font-size: 12px; font-family: verdana, arial, sans-serif; color: #000000; widows: 1; line-height: normal">as a container for an IAM role. When you create an IAM role using the console, the console creates an instance profile automatically and gives it the same name as the role it corresponds to. If you use the AWS CLI, API, or an AWS SDK to create a role, you create the role and instance profile as separate actions, and you might give them different names. To launch an instance with an IAM role, you specify the name of its instance profile. When you launch an instance using the Amazon EC2 console, you can select a role to associate with the instance; however, the list that's displayed is actually a list of instance profile names. For more information, see</span> <a class="ulink" style="font-size: 12px; font-family: verdana, arial, sans-serif; color: #996633; widows: 1; line-height: normal" href="http://docs.aws.amazon.com/IAM/latest/UserGuide/instance-profiles.html" target="_blank">Instance Profiles</a> <span style="font-size: 12px; font-family: verdana, arial, sans-serif; color: #000000; widows: 1; line-height: normal">in the</span> <span class="emphasis" style="font-size: 12px; font-family: verdana, arial, sans-serif; color: #000000; widows: 1; line-height: normal"><em>Using IAM</em></span><span style="font-size: 12px; font-family: verdana, arial, sans-serif; color: #000000; widows: 1; line-height: normal">.</span>       <br /></p> </blockquote>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ aws iam create-instance-profile \    <br />&gt; --instance-profile-name ADN-Viewer-CodeDeploy-Role-Profile</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ aws iam add-role-to-instance-profile \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --instance-profile-name ADN-Viewer-CodeDeploy-Role-Profile \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --role-name ADN-Viewer-CodeDeploy-Role</p>  <p>Now my role is created.   <br /></p>  <h3>Launch EC2 Instances</h3>  <p style="widows: 1">   <br /></p>  <p style="widows: 1">Now I am ready to create my EC2 instances, with AWS CLI, I can launch multiple instances at one time. With following command line, I am creating 2 Linux t2.micro instances from <span style="font-size: 15px; font-family: &#39;Helvetica Neue&#39;, roboto, arial, &#39;Droid Sans&#39;, sans-serif; font-weight: bold; color: #444444; widows: 1; line-height: 18px; background-color: #ffffff">Amazon Linux AMI 2015.03 (HVM), SSD Volume Type</span> <span style="widows: 1; background-color: #ffffff"><font color="#444444" face="Helvetica Neue, Roboto, Arial, Droid Sans, sans-serif"><span style="font-size: 15px; line-height: 18px">- ami-1ecae776. I</span><span style="font-size: 15px; line-height: 18px">’</span><span style="font-size: 15px; line-height: 18px">ve already created a security group named as</span> <span style="font-size: 15px; line-height: 18px">“web server”.</span></font></span></p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ aws ec2 run-instances \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --image-id ami-1ecae776 \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --count 2 \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --instance-type t2.micro \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --iam-instance-profile Name=&quot;ADN-Viewer-CodeDeploy-Role-Profile&quot; \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --key-name aws-devtech-us-east1 \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --security-groups &quot;web server&quot;</p>  <p>To find these instances easily when deploying the code with CodeDeploy service, I need to assign tags for these instances. Please note that I have to input the correct instance ID when creating tags.</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ aws ec2 create-tags \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --resources i-5f0e2fa3 \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --tags Key=Name,Value=Production</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">   <br /></p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ aws ec2 create-tags \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --resources i-47e3c2bb i-44e3c2b8 \</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">&gt; --tags Key=Name,Value=Staging</p>  <p>A better way is to create it automatically in one command, here is the <a href="https://forums.aws.amazon.com/message.jspa?messageID=585027">sample</a>, for your information.</p>  <p>&#160;</p>  <h3>Install AWS CodeDeploy Agent </h3>  <p>&#160;</p>  <p>To use AWS CodeDeploy service deploy application to these EC2 instances, AWS CodeDeploy Agent has to be running it them. How do I know whether CodeDeploy Agent is running or not? I will logon to the EC2 instance and check with following command:</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ sudo service codedeploy-agent stat</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">codedeploy-agent: unrecognized service</p> Seems CodeDeoply agent is not installed, now I logged in to one of EC2 instances with SSH from Mac, or Putty if you are using Windows. Please note that following commands are running from EC2 linux instance. AWS CodeDeploy Agent is not installed by default, so I will go ahead to install CodeDeploy Agent.   <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">yum update</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">yum install aws-cli</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">aws s3 cp s3://aws-codedeploy-us-east-1/latest/install . --region us-east-1</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">chmod +x ./install</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">./install auto</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">sudo service codedeploy-agent start</p>  <br />Please note that I am using AWS CLI from Linux instance to get the CodeDeploy installation file from S3, that why I need to assign S3 access permission to my IAM role in first step, otherwise, I will get error message like below:   <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">$ sudo aws s3 cp s3://aws-codedeploy-us-east-1/latest/install . --region us-east-1</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">A client error (403) occurred when calling the HeadObject operation: Forbidden</p>  <p style="margin-bottom: 0px; font-size: 18px; font-family: &#39;Andale Mono&#39;; color: #29f914; margin-top: 0px; line-height: normal; background-color: #000000">Completed 1 part(s) with ... file(s) remaining</p>  <p>OK, with that, I have one instance ready to deploy my application. But as you can see, I launched multiple instances but I only installed CodeDeploy agent on one instance, what about others? Do I have to repeat myself and login to them and install them separately? It is OK since I just have 2 or 3. But what if I have handers or even thousand of instances? Actually there are different solutions for this. One of them is, I setup all environment on one instances and create an AMI from it. When I launch my working instance, I will create instance from the one I’ve already configured instead of the AWS default ones. Some other solutions are available, for example to setup the environment with user data when the instance is launched. Anyway, a lot of solutions and a lot of fun. :)</p>  <p>Next, I will to to the deployment part soon. I will do it in another post.</p>
