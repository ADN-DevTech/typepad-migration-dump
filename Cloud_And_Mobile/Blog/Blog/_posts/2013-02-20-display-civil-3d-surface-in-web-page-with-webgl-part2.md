---
layout: "post"
title: "Display Civil 3D Surface in Web Page with WebGL - part2"
date: "2013-02-20 01:28:58"
author: "Daniel Du"
categories:
  - "ASP .NET"
  - "Azure"
  - "Cloud"
  - "Daniel Du"
  - "WebGL"
original_url: "https://adndevblog.typepad.com/cloud_and_mobile/2013/02/display-civil-3d-surface-in-web-page-with-webgl-part2.html "
typepad_basename: "display-civil-3d-surface-in-web-page-with-webgl-part2"
typepad_status: "Publish"
---

<p>By <a href="http://adndevblog.typepad.com/cloud_and_mobile/daniel-du.html">Daniel Du</a></p>  <p>In <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/02/dispaly-civil-3d-surface-in-web-page-with-webgl-part1.html">part 1</a> of this serials, I learned how to draw a basic triangular face in a web page with WebGL, and the coordinates of the triangular face are hardcoded.&#160; I would like to get them from a cloud service. I am planning to use Windows Azure to host this service and use SQL Azure to store my surface data. In this post, I will describe how I implement the web service. </p>  <p>With Visual Studio 2010 + Windows Azure SDK, I can create a Windows Azure Cloud Service easily. I selected a ASP.NET MVC 4 as web role. Windows Azure SDK helps me to setup the local emulation environment,&#160; so that I can develop and test my cloud service locally, even without knowing it actually is a cloud service. But debugging such a cloud project on a local cloud emulation environment is pretty slow, and it is not necessary for me at this stage, so I just removed the cloud project, and just work on the ASP.net MVC project. After all, I can add the cloud project and publish it to Windows Azure latter. So currently, I am just working on a ASP.NET MVC 4 web application. </p>  <p>If you have read the [<a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/02/creating-a-cloud-based-viewer-part-x.html">Creating a cloud based viewer</a>] serials of my colleague <a href="http://adndevblog.typepad.com/cloud_and_mobile/philippe-leefsma.html">Philippe Leefsma</a>, you will know that it is possible to create a RESTful web service with WCF. but I would like to try the new ASP.NET <a href="http://www.asp.net/web-api">Web API</a> in my project. I seems that Web API is much easier for me than WCF in this project, but Web API is not a replacement of WCF for everywhere, <a href="http://mattmilner.com/Milner/Blog/post/2012/02/28/WebAPI-or-WCF.aspx">this article</a> describe the difference and which one you should pick. </p>  <p>Firstly I will create my models. It is pretty straight forward, code snippet goes as below: </p>  <pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> System.Web;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">&#160;<br />&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> Id { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> Name { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> Description { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">virtual</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">ICollection</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TriangleFace</font></span></font><font face="新宋体"><font color="#000000">&gt; TriangleFaces <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br /> <br />&#160;&#160;&#160; }<br /> <br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TriangleFace</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> Id { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">virtual</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Point</font></span><font color="#000000"> P1 { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">virtual</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Point</font></span><font color="#000000"> P2 { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">virtual</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Point</font></span><font color="#000000"> P3 { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> Color { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br /> <br />&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Point</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">double</font></span><font color="#000000"> X { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font><font face="新宋体"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">double</font></span><font color="#000000"> Y { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">double</font></span><font color="#000000"> Z { </font><span style="color: "><font color="#0000ff">get</font></span><font color="#000000">; </font><span style="color: "><font color="#0000ff">set</font></span><font color="#000000">; }<br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>&#160;</p>

<p>Then add a repository interface and a class to implement this interface. The repository is used to handle the data from various data sources, it can be a database or a simple array in memory for testing, and the service only ask data from the repository, in this way, we can change the backing store without rewriting the service class.</p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> System.Text;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">interface</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">ITinSurfaceRepository</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt; GetAll();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> Get(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> Add(</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> Remove(</font><span style="color: "><font color="#0000ff">int</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000"> id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000"> Update(</font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> surface);<br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>Firstly add a simple repository in memory, just for quick test. </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> System.Web;<br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//very simple implementation, no error checking, just for quick test</font></span><br /><font color="#000000">&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurfaceMemoryRepository</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">ITinSurfaceRepository</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">List</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000">&gt; surfacesStorage = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">List</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt;();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span></font><font face="新宋体"><font color="#000000"> TinSurfaceMemoryRepository()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//add some test data</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surfacesStorage.Add(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurface</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Id = 1,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Name = </font><span style="color: "><font color="#a31515">&quot;surface1&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Description = </font><span style="color: "><font color="#a31515">&quot;this is test surface 1&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; TriangleFaces = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">List</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TriangleFace</font></span></font><font face="新宋体"><font color="#000000">&gt;(){ <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TriangleFace</font></span></font><font face="新宋体"><font color="#000000">{ <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Id = 1, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P1 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Point</font></span></font><font face="新宋体"><font color="#000000">{X = 10, Y = 10, Z= 0}, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P2 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Point</font></span></font><font face="新宋体"><font color="#000000">{X = -10, Y = 0, Z= 0},<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; P3 = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Point</font></span></font><font face="新宋体"><font color="#000000">{X = 15, Y = 10, Z= 0},<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Color = </font><span style="color: "><font color="#a31515">&quot;0xffffff&quot;</font></span></font><font face="新宋体"><font color="#000000">}<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; });<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt; GetAll()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> surfacesStorage.AsEnumerable&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt;();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> Get(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> surfacesStorage.Find(p =&gt; p.Id == id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> Add(</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surfacesStorage.Add(surface);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> surface;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> Remove(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surf = Get(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surfacesStorage.Remove(surf);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> surf;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">bool</font></span><font color="#000000"> Update(</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surf = Get(surface.Id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (surf != </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surfacesStorage.Remove(surf);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surfacesStorage.Add(surface);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">true</font></span></font><font face="新宋体"><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">else</font></span><br /></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">false</font></span><font color="#000000">;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160; }<br />}</font></font></font></pre>

<p>&#160;</p>

<p>Now it is time to add a controller, controller is an object that handles HTTP request. In <strong>Solution Explorer</strong>, right-click the the Controllers folder. Select <strong>Add</strong> and then select <strong>Controller</strong>. In the <strong>Add Controller</strong> wizard, name the controller as &quot;TinSurfacesController&quot;. In the <strong>Template </strong>drop-down list, there are many templates to make your work easy. I select <strong>Empty API Controller</strong> here.&#160; Then click <strong>Add</strong>. Then add code as below: </p>

<pre style="line-height: normal; font-family: ; background: white; color: "><font face="新宋体"><span style="color: "><font color="#0000ff"><font style="font-size: 7.8pt">using</font></font></span><font style="font-size: 7.8pt"><font color="#000000"> System;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Collections.Generic;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Linq;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Net;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Net.Http;</font><br /><span style="color: "><font color="#0000ff">using</font></span><font color="#000000"> System.Web.Http;</font><br /><span style="color: "><font color="#0000ff">using</font></span></font></font><font style="font-size: 7.8pt"><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Models;<br /> <br /> </font><br /><span style="color: "><font color="#0000ff">namespace</font></span></font><font face="新宋体"><font color="#000000"> SurfaceStoreServiceWebRole.Controllers<br />{<br />&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">class</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurfacesController</font></span><font color="#000000"> : </font><span style="color: "><font color="#2b91af">ApiController</font></span><br /></font><font face="新宋体"><font color="#000000">&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//Calling new ProductRepository() in the controller is not the best design, because it ties the controller to a particular implementation of IProductRepository. For a better approach, see Using the Web API Dependency Resolver.</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//http://www.asp.net/web-api/overview/extensibility/using-the-web-api-dependency-resolver</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//static readonly ITinSurfaceRepository repository = </font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//&#160;&#160;&#160; new TinSurfaceRepository();</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">readonly</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">ITinSurfaceRepository</font></span></font><font face="新宋体"><font color="#000000"> repository = <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurfaceMemoryRepository</font></span></font><font face="新宋体"><font color="#000000">();<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//api/TinSurfaces</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt; GetAllTinSurfaces()<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> repository.GetAll();<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//api/TinSurfaces/id</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000"> GetTinSurface(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface = repository.Get(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (surface == </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="新宋体"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">throw</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseException</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.NotFound);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> surface;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//GET api/TinSurfaces?name=name</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">IEnumerable</font></span><font color="#000000">&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span><font color="#000000">&gt; GetTinSurfacesByName(</font><span style="color: "><font color="#0000ff">string</font></span></font><font face="新宋体"><font color="#000000"> name)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> repository.GetAll().Where(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; p =&gt; </font><span style="color: "><font color="#0000ff">string</font></span></font><font face="新宋体"><font color="#000000">.Equals(p.Name, name, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">StringComparison</font></span></font><font face="新宋体"><font color="#000000">.OrdinalIgnoreCase));<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//create,POST&#160; api/TinSurfaces</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseMessage</font></span><font color="#000000"> PostTinSurface(</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surface = repository.Add(surface);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> response = Request.CreateResponse&lt;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">&gt;(<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.Created, surface);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">string</font></span><font color="#000000"> uri = Url.Link(</font><span style="color: "><font color="#a31515">&quot;DefaultApi&quot;</font></span></font><font face="新宋体"><font color="#000000">,<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000">{Id = surface.Id});<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; response.Headers.Location = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">Uri</font></span></font><font face="新宋体"><font color="#000000">(uri);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">return</font></span></font><font face="新宋体"><font color="#000000"> response;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//update, PUT api/TinSurfaces/id</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> PutTinSurface(</font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> id,</font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; surface.Id = id;<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="新宋体"><font color="#000000"> (!repository.Update(surface))<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">throw</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseException</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span></font><font face="新宋体"><font color="#000000">.NotFound); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#008000">//delete, DELETE api/TinSurfaces/id</font></span><br /><font color="#000000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">public</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">void</font></span><font color="#000000"> DeleteTinSurface(</font><span style="color: "><font color="#0000ff">int</font></span></font><font face="新宋体"><font color="#000000"> id)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#2b91af">TinSurface</font></span></font><font face="新宋体"><font color="#000000"> surface = repository.Get(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (surface == </font><span style="color: "><font color="#0000ff">null</font></span></font></font><font face="新宋体"><font style="font-size: 7.8pt"><font color="#000000">)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font color="#0000ff">throw</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000">&#160;</font><span style="color: "><font color="#2b91af">HttpResponseException</font></span><font color="#000000">(</font><span style="color: "><font color="#2b91af">HttpStatusCode</font></span><font color="#000000">.NotFound);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; repository.Remove(id);<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }<br /> <br /> <br />&#160;&#160;&#160; }<br />}</font></font></font><br /></pre>

<pre style="line-height: normal; font-family: ; background: white; color: ">&#160;</pre>

<p>Here is the table to of example URLs:</p>

<table border="0" cellspacing="0" cellpadding="2" width="530"><tbody>
    <tr>
      <td valign="top" width="268">Action</td>

      <td valign="top" width="109">HTTP Method</td>

      <td valign="top" width="151">URL</td>
    </tr>

    <tr>
      <td valign="top" width="268">Get all surfaces</td>

      <td valign="top" width="109">GET</td>

      <td valign="top" width="151">api/TinSurfaces</td>
    </tr>

    <tr>
      <td valign="top" width="268">Get one surface by Id</td>

      <td valign="top" width="109">GET</td>

      <td valign="top" width="151">api/TinSurfaces/1</td>
    </tr>

    <tr>
      <td valign="top" width="268">Get one surface by name</td>

      <td valign="top" width="109">GET</td>

      <td valign="top" width="151">api/TinSurfaces?name=surface1</td>
    </tr>

    <tr>
      <td valign="top" width="268">Create a new surface</td>

      <td valign="top" width="109">POST</td>

      <td valign="top" width="151">api/TinSurfaces</td>
    </tr>

    <tr>
      <td valign="top" width="268">Update a surface with new object</td>

      <td valign="top" width="109">PUT</td>

      <td valign="top" width="151">api/TinSurfaces/1</td>
    </tr>

    <tr>
      <td valign="top" width="268">Delete a surface by Id</td>

      <td valign="top" width="109">DELETE</td>

      <td valign="top" width="151">api/TinSurfaces/1</td>
    </tr>
  </tbody></table>

<p>&#160;</p>

<p>Now it is time to run and test this service. I use Fiddler to test the REST service. Switch Composer tab ,input the url <a title="http://localhost:3297/api/tinsurfaces" href="http://localhost:3297/api/tinsurfaces">http://localhost:3297/api/tinsurfaces</a> and select “GET” method, then click “Execute” button:</p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017c36fd36e0970b-pi"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_d58105.jpg" width="529" height="230" /></a></p>

<p>The result HTTP code is 200, that means all work fine, double click the item to check the output in Inspector tab, I saw the result in JSON format. </p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017ee8a0674a970d-pi"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_bd4fb2.jpg" width="500" height="244" /></a></p>

<p><a href="http://adndevblog.typepad.com/.a/6a0167607c2431970b017c36fd372c970b-pi"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_c1d709.jpg" width="468" height="502" /></a></p>





<p>&#160;</p>

<p>It works pretty good! <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="/assets/image_41cb17.jpg" /> Okay, I would like to stop here and will continue work on this project in next post.</p>
